
-- Add availability slot with progress tracking
CREATE   PROCEDURE sp_AddVendorAvailability
    @VendorProfileID INT,
    @DayOfWeek TINYINT,
    @StartTime TIME,
    @EndTime TIME
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Use MERGE for upsert functionality
    MERGE VendorBusinessHours AS target
    USING (SELECT @VendorProfileID AS VendorProfileID, @DayOfWeek AS DayOfWeek, @StartTime AS OpenTime, @EndTime AS CloseTime) AS source
    ON target.VendorProfileID = source.VendorProfileID AND target.DayOfWeek = source.DayOfWeek
    WHEN MATCHED THEN
        UPDATE SET OpenTime = source.OpenTime, CloseTime = source.CloseTime, IsAvailable = 1
    WHEN NOT MATCHED THEN
        INSERT (VendorProfileID, DayOfWeek, OpenTime, CloseTime, IsAvailable)
        VALUES (source.VendorProfileID, source.DayOfWeek, source.OpenTime, source.CloseTime, 1);
    
    -- Update progress
    UPDATE VendorProfiles SET AvailabilityCompleted = 1, SetupStep = 4
    WHERE VendorProfileID = @VendorProfileID;
    
    SELECT 1 AS Success, 'Availability added successfully' AS Message;
END;

GO

