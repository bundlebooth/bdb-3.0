<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VenueVue - Event Booking Platform</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎪</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Maps API with Places API (New) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPhhp2rAt1VTrIzjgagJXZPZ_nc7K_BVo&libraries=places,geometry,marker&callback=initMap&v=weekly"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Add Stripe.js for payment processing -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Add FullCalendar for booking dates -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <!-- Add Socket.IO for chat functionality -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Add Chart.js for analytics graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Select2 for enhanced dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Google Places API will be loaded dynamically with API key from backend -->
    <style>
        :root {
            --primary: #5e72e4;
            --secondary: #f7fafc;
            --accent: #ff6b6b;
            --text: #2d3748;
            --text-light: #718096; 
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: var(--text);
        }

        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
            transition: grid-template-columns 0.25s ease;
        }

        /* Collapsible sidebar behavior */
        .app-container.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background-color: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 2rem;
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            cursor: pointer;
        }

        .user-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-icon {
            position: relative;
            color: var(--text);
            cursor: pointer;
        }

        .nav-icon .badge {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Categories Navigation */
        .categories-nav {
            grid-column: 1 / -1;
            background-color: white;
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            position: sticky;
            top: 60px; /* Adjust based on header height */
            z-index: 15;
        }

        .categories-list-wrapper {
            flex-grow: 1;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0.5rem 0;

            -webkit-overflow-scrolling: touch;
        }

        .categories-list-wrapper::-webkit-scrollbar {
            display: none;
        }

        .categories-list-wrapper {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .categories-list {
            display: inline-flex;
            gap: 2rem;
            align-items: center;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
            position: relative;
            color: var(--text-light);
            min-width: 60px;
        }

        .category-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            display: block;
            color: var(--text-light);
            transition: color 0.3s ease;
        }

        .category-item:hover,
        .category-item.active {
            color: var(--primary);
        }

        .category-item.active {
            transform: scale(1.1);
        }

        .category-item.active i {
            color: var(--primary);
        }

        .category-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            width: 80%;
            height: 2px;
            background-color: var(--primary);
            border-radius: 1px;
            transition: width 0.3s ease, left 0.3s ease;
        }

        .category-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background-color: var(--accent);
            border-radius: 1px;
            transition: width 0.3s ease, left 0.3s ease;
        }

        /* New styles for scroll buttons */
        .nav-scroll-btn {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            margin: 0 0.5rem;
            box-shadow: var(--shadow);
        }

        .nav-scroll-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Sidebar */
        .sidebar {
            background-color: white;
            padding: 1.5rem;
            border-right: 1px solid var(--border);
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            overflow-y: auto;
            transition: padding 0.25s ease, border-color 0.25s ease;
        }

        .sidebar.collapsed {
            padding: 0;
            border-color: transparent;
            overflow: hidden;
        }

        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
        }

        .filter-reset {
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
        }

        .filter-option input {
            margin-right: 0.75rem;
            accent-color: var(--primary);
        }

        .filter-option label {
            font-size: 0.9rem;
            color: var(--text);
        }

        .range-slider {
            width: 100%;
            height: 4px;
            margin: 1rem 0;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 2px;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--primary);
            cursor: pointer;
        }

        .price-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* New Advanced Filters Section */
        .advanced-filters {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.show {
            display: block;
        }

        .date-picker {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .date-picker input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .region-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .trending-section {
            margin-top: 2rem;
        }

        .trending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .trending-tag {
            padding: 0.5rem 0.75rem;
            background-color: var(--secondary);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trending-tag:hover {
            background-color: #e6e9ff;
            color: var(--primary);
        }

        .trending-tag.active {
            background-color: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
        }
        
        .profile-content {
            padding: 2rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 900px;
            margin: 0 auto;
        }


        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .results-count {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .view-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sort-select {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: white;
            font-size: 0.9rem;
            color: var(--text);
        }

        /* Removed legacy List/Map toggle and legacy map UI styles (replaced by new FA segmented toggle and #map-view) */

        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(clamp(260px, 28vw, 380px), 1fr));
            gap: 1.5rem;
            align-items: stretch;
        }
        @media (max-width: 640px) {
            .vendor-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .vendor-card {
            background-color: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform .35s cubic-bezier(0.22, 1, 0.36, 1), box-shadow .35s cubic-bezier(0.22, 1, 0.36, 1), border-color .35s ease;
            border: 1px solid rgba(0, 0, 0, 0.04);
            transform: translateY(0) scale(1);
            will-change: transform, box-shadow;
        }

        .vendor-card:hover {
            transform: translateY(-6px) scale(1.015);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
            border-color: rgba(94, 114, 228, 0.2);
        }

        .vendor-image {
            /* Maintain consistent visual proportions across grid sizes */
            aspect-ratio: 4 / 3;
            height: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }

        /* Smooth image zoom on hover */
        .vendor-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scale(1);
            transition: transform .6s cubic-bezier(0.22, 1, 0.36, 1);
            will-change: transform;
        }
        .vendor-card:hover .vendor-image img {
            transform: scale(1.06);
        }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .vendor-card,
            .vendor-card:hover,
            .vendor-image img,
            .vendor-card:hover .vendor-image img {
                transition: none !important;
                transform: none !important;
            }
        }

        .vendor-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vendor-card:hover .vendor-image img {
            transform: scale(1.05);
        }

        /* Map view container and toggle */
        #map-view {
            display: none;
            width: 100%;
            height: 420px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin: 0 0 1rem 0;
        }
        /* Removed legacy .map-toolbar and .btn-map-toggle styles */

        .vendor-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: #5e72e4;
            padding: 0.4rem 0.8rem;
            border-radius: 25px;
            font-size: 0.75rem;
            font-weight: 700;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .vendor-favorite {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .vendor-favorite:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }

        .vendor-favorite.active {
            color: var(--accent);
        }

        .vendor-details {
            padding: 1.5rem;
        }

        .vendor-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #1a202c;
            line-height: 1.3;
        }

        .vendor-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            color: #64748b;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .vendor-features {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #5e72e4;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #475569;
            font-weight: 500;
        }

        .feature-icon {
            color: #5e72e4;
            font-size: 1rem;
        }

        .price-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
        }

        .price-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-light);
        }

        .price-dot.filled {
            background-color: var(--primary);
        }

        .vendor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .vendor-price {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .vendor-price span {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text-light);
        }

        .vendor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(94, 114, 228, 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            border: 1px solid var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4a5acf;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 3rem;
            gap: 0.5rem;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text);
        }

        .page-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .page-btn.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Booking Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }

        .close-modal {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: var(--primary);
        }
        
        .vendor-profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
        }

        .vendor-profile-info {
            flex-grow: 1;
        }
        
        /* Vendor Profile Image Gallery Layout */
        .image-gallery {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 900px;
            height: 400px;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 2rem;
            background-color: transparent;
        }

        /* Left side: large image */
        .image-gallery > .gallery-item.large-image {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }

        /* Right side: 2x2 grid for thumbnails */
        .image-gallery > .thumbnails-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            width: 100%;
            height: 100%;
        }

        .thumbnails-container > .gallery-item {
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }

        .gallery-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background-color: transparent; /* Transparent background */
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            border-radius: var(--radius);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-radius: var(--radius);
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .see-all-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            border-radius: var(--radius);
        }

        .gallery-item:hover .see-all-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        
        
        /* Lightbox Modal Styles */
        .lightbox-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: var(--radius);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            font-size: 2rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: background-color 0.2s;
        }

        .lightbox-nav:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .lightbox-prev {
            left: -60px;
        }

        .lightbox-next {
            right: -60px;
        }

        /* Services Section */
        .services-section {
            margin-top: 2rem;
        }

        .services-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .service-category {
            margin-bottom: 2rem;
        }

        .category-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .service-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .service-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .service-name {
            font-weight: 600;
        }

        .service-description {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .service-price {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .service-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Predefined Service Cards */
        .predefined-service-card {
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .predefined-service-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .predefined-service-card.selected {
            border-color: var(--primary);
            background-color: #f8faff;
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.1);
        }

        .predefined-service-card.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--primary);
        }

        .service-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .service-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
            margin: 0;
            line-height: 1.3;
        }

        .service-card-check {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        .predefined-service-card.selected .service-card-check {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .service-card-description {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .service-card-details {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .service-card-duration {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .vendor-customization-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--secondary);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .predefined-service-card.selected .vendor-customization-form {
            display: block;
        }

        .form-row-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group-inline {
            margin: 0;
        }

        .form-group-inline label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .form-group-inline input,
        .form-group-inline textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            background-color: white;
        }

        .form-group-inline textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* New Booking Calendar Section */
        .booking-calendar-section {
            margin: 2rem 0;
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        #booking-calendar {
            background-color: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .time-slot {
            padding: 0.75rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot:hover {
            background-color: #e6e9ff;
            color: var(--primary);
        }

        .time-slot.selected {
            background-color: var(--primary);
            color: white;
        }

        .time-slot.unavailable {
            background-color: #f1f5f9;
            color: var(--text-light);
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* New Reviews Section */
        .reviews-section {
            margin: 2rem 0;
        }

        .reviews-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .review-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .reviewer {
            font-weight: 600;
        }

        .review-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .review-rating {
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .review-text {
            line-height: 1.6;
        }

        .add-review-btn {
            margin-top: 1rem;
        }

        /* New Review Form */
        .review-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }

        .rating-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .rating-star {
            font-size: 1.5rem;
            color: #e2e8f0;
            cursor: pointer;
        }

        .rating-star.selected {
            color: #fbbf24;
        }

        .review-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            min-height: 100px;
        }
        
        .chat-modal .modal-content {
            max-width: 600px;
        }
        
        .chat-modal .modal-body {
            padding: 0;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background-color: white;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
        }

        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-light);
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 0.75rem;
            border-radius: var(--radius);
            display: inline-block;
        }

        .sent .message-content {
            background-color: var(--primary);
            color: white;
        }

        .received .message-content {
            background-color: var(--secondary);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-right: 0.5rem;
        }

        /* New Payment Section */
        .payment-section {
            margin: 2rem 0;
        }

        .payment-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .payment-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            position: relative;
        }

        .form-group {
            position: relative;
        }

        /* Location suggestions dropdown */
        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .location-suggestion-item, .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            font-size: 14px;
            color: #333;
        }

        .location-suggestion-item:hover, .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .location-suggestion-item:last-child, .suggestion-item:last-child {
            border-bottom: none;
        }

        /* Fix predefined services styling */
        .service-dropdown-container {
            background: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
            border-radius: var(--radius) !important;
            padding: 1rem !important;
            margin-bottom: 1rem !important;
        }

        .service-dropdown-container select {
            border: 1px solid var(--border) !important;
            background: white !important;
        }

        .selected-service-item {
            background: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
            border-radius: var(--radius) !important;
            padding: 1rem !important;
            margin-bottom: 0.5rem !important;
        }

        .budget-range-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .budget-range-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .card-element {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        /* Booking confirmation */
        .booking-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
        }

        /* Location permission modal */
        .location-permission {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
            text-align: center;
        }

        .location-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(94, 114, 228, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }

        /* Profile Modal Styles */
        .profile-modal .modal-content {
            max-width: 400px;
        }

        .profile-modal .modal-body {
            padding: 20px;
        }

        .profile-modal input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background-color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2rem;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .dashboard-sidebar {
            background-color: white;
            border-right: 1px solid var(--border);
            padding: 1.5rem;
        }

        .dashboard-menu {
            list-style: none;
            margin-top: 2rem;
        }

        .dashboard-menu li {
            margin-bottom: 0.5rem;
        }

        .dashboard-menu a {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
        }

        .dashboard-menu a:hover {
            background-color: var(--secondary);
        }

        .dashboard-menu a.active {
            background-color: var(--primary);
            color: white;
        }

        .dashboard-content {
            padding: 2rem;
            background-color: var(--secondary);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .dashboard-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .dashboard-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .booking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        
        .booking-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .payment-status {
            color: var(--success);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-toast {
            animation: slideIn 0.3s ease;
        }

        .booking-info {
            flex: 1;
        }

        .booking-vendor {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .booking-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .booking-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-confirmed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Vendor Dashboard Styles */
        .vendor-dashboard-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        /* Vendor Map and Horizontal Cards Styles */
        .vendor-horizontal-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .vendor-horizontal-card {
            display: flex;
            background: white;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            width: 100%;
            min-height: 240px;
        }

        .vendor-horizontal-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            transform: translateY(-3px);
            border-color: #3b82f6;
        }

        .vendor-horizontal-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .vendor-card-image-container {
            width: 360px;
            height: 240px;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        .vendor-image-carousel {
            display: flex;
            transition: transform 0.3s ease;
            height: 100%;
        }

        .vendor-card-image {
            width: 360px;
            height: 240px;
            object-fit: cover;
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .vendor-no-image {
            width: 360px;
            height: 240px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .carousel-dots {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 2;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            z-index: 2;
        }

        .carousel-nav:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-50%) scale(1.1);
        }

        .vendor-card-image-container:hover .carousel-nav {
            opacity: 1;
        }

        .carousel-nav.prev {
            left: 8px;
        }

        .carousel-nav.next {
            right: 8px;
        }

        .vendor-card-content {
            flex: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .vendor-response-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vendor-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .vendor-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .vendor-stars {
            color: #f59e0b;
            font-size: 0.875rem;
        }

        .vendor-rating-text {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .vendor-location {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .vendor-description {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.4;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .vendor-service-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .vendor-service-tag {
            background: #e0f2fe;
            color: #0277bd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .vendor-card-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }

        .vendor-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .vendor-btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .vendor-btn-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .vendor-btn-primary {
            background: #10b981;
            color: white;
            border: 1px solid #10b981;
        }

        .vendor-btn-primary:hover {
            background: #059669;
            border-color: #059669;
        }

        .vendor-btn-primary.selected {
            background: #059669;
            border-color: #059669;
        }

        .vendor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .vendor-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .vendor-card-distance {
            font-size: 0.9rem;
            color: var(--text-light);
            background: var(--secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .vendor-card-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .vendor-card-services {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .vendor-service-tag {
            background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .vendor-card-pricing {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .vendor-price-range {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .vendor-select-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vendor-select-btn:hover {
            background: var(--primary);
            color: white;
        }

        .vendor-select-btn.selected {
            background: var(--primary);
            color: white;
        }

        /* Map marker styles */
        .vendor-map-marker {
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .vendor-map-marker.selected {
            background: #27ae60;
        }

        .event-location-marker {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        /* Responsive design for vendor cards */
        @media (max-width: 768px) {
            .vendor-horizontal-card {
                flex-direction: column;
                gap: 1rem;
            }
            
            .vendor-card-image {
                width: 100%;
                height: 200px;
            }
            
            .map-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start !important;
            }
            
            .map-controls {
                display: flex;
                gap: 0.5rem;
                width: 100%;
            }
            
            .map-controls button {
                flex: 1;
            }
        }

        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        /* Request Management Styles */
        .requests-filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .request-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--border);
            transition: all 0.2s;
        }

        .request-card.pending {
            border-left-color: #f59e0b;
        }

        .request-card.approved {
            border-left-color: #10b981;
        }

        .request-card.declined {
            border-left-color: var(--accent);
        }

        .request-card.expired {
            border-left-color: #6b7280;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .request-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .request-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .request-status.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .request-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }

        .request-status.expired {
            background: #f3f4f6;
            color: #374151;
        }

        .request-timer {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .request-timer.urgent {
            color: var(--accent);
            font-weight: 600;
        }

        .request-details {
            margin-bottom: 1rem;
        }

        .request-detail-row {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .request-detail-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--text);
        }

        .request-detail-value {
            color: var(--text-light);
        }

        .request-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .request-actions .btn {
            flex: 1;
        }

        .requests-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Vendor Registration Form */
        .vendor-registration-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
        }

        /* Price indicator styles */
        .price-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
        }

        /* Analytics Chart Styles */
        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        /* Vendor Setup Wizard Styles */
        .step-indicator {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            background-color: var(--secondary);
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            color: var(--primary);
            background-color: rgba(94, 114, 228, 0.1);
            font-weight: 600;
        }

        .step-indicator.completed {
            color: white;
            background-color: var(--primary);
        }

        .setup-step {
            animation: fadeIn 0.3s ease;
        }

        .gallery-item {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            background-color: var(--secondary);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .package-item, .service-item {
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        .package-item h6, .service-item h6 {
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }

        .package-item p, .service-item p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .package-item .price, .service-item .price {
            font-weight: 600;
            color: var(--primary);
            margin-top: 0.5rem;
        }

        .availability-day {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--secondary);
        }

        .availability-day input[type="checkbox"]:checked + strong {
            color: var(--primary);
        }

        .availability-day input[type="time"] {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                height: 90vh;
            }

            .modal-body {
                max-height: calc(90vh - 60px);
            }

            .vendor-detail-header {
                flex-direction: column;
            }

            .vendor-detail-image {
                width: 100%;
                height: 200px;
            }

            .view-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .categories-nav {
                padding: 0.5rem 1rem;
            }

            .category-item {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .dashboard-sidebar {
                display: none;
            }
            
            .profile-content {
                padding: 1rem;
            }
            
            .vendor-profile-header {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Multi-Step Booking Modal Styles */
        .booking-progress {
            margin-bottom: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .booking-step {
            display: none;
        }

        .booking-step.active {
            display: block;
        }

        .service-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .category-card {
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .category-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .category-card.selected {
            border-color: var(--primary);
            background-color: rgba(94, 114, 228, 0.05);
        }

        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .category-card.selected .category-icon {
            background-color: var(--primary);
            color: white;
        }

        .category-info {
            flex: 1;
        }

        .category-info h5 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .category-info p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .category-checkbox {
            position: relative;
            flex-shrink: 0;
        }

        .category-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .category-checkbox .checkmark {
            position: relative;
            height: 20px;
            width: 20px;
            background-color: white;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: block;
            transition: all 0.2s ease;
        }

        .category-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .category-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .service-category {
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .service-category:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .service-checkbox {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            cursor: pointer;
            width: 100%;
        }

        .service-checkbox input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            margin-right: 1rem;
            position: relative;
            transition: all 0.2s ease;
        }

        .service-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .service-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .service-info h5 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text);
        }

        .service-info p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .budget-slider-container {
            position: relative;
            margin: 1rem 0;
        }

        .budget-slider-container input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        .budget-slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .budget-slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .budget-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .vendor-card {
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .vendor-card:hover {
            border-color: rgba(94, 114, 228, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            transform: translateY(-8px);
        }

        .vendor-card.selected {
            border-color: #5e72e4;
            background-color: rgba(94, 114, 228, 0.02);
            box-shadow: 0 8px 32px rgba(94, 114, 228, 0.15);
        }

        .vendor-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .vendor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .vendor-info h5 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--text);
        }

        .vendor-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .vendor-services {
            margin-bottom: 1rem;
        }

        .vendor-services h6 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .vendor-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .vendor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-select-vendor {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary);
            background-color: transparent;
            color: var(--primary);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-select-vendor:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-select-vendor.selected {
            background-color: var(--primary);
            color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .request-item {
            background-color: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .request-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .request-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .request-status.approved {
            background-color: #d4edda;
            color: #155724;
        }

        .request-status.declined {
            background-color: #f8d7da;
            color: #721c24;
        }

        .request-status.expired {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .countdown-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .countdown-timer.urgent {
            color: var(--accent);
        }

        .booking-summary-card {
            background-color: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .payment-section {
            background-color: var(--secondary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .service-categories {
                grid-template-columns: 1fr;
            }
            
            .vendor-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .booking-progress .step-indicator {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
<style id="googleidentityservice_button_styles">.qJTHM{-moz-user-select:none;color:#202124;direction:ltr;font-family:"Roboto-Regular",arial,sans-serif;font-weight:400;margin:0;overflow:hidden}.ynRLnc{left:-9999px;position:absolute;top:-9999px}.L6cTce{display:none}.bltWBb{word-break:break-all}.hSRGPd{color:#1a73e8;cursor:pointer;font-weight:500;text-decoration:none}.Bz112c-W3lGp{height:16px;width:16px}.Bz112c-E3DyYd{height:20px;width:20px}.Bz112c-r9oPif{height:24px;width:24px}.Bz112c-u2z5K{height:36px;width:36px}.Bz112c-uaxL4e{-moz-border-radius:10px;border-radius:10px}.LgbsSe-Bz112c{display:block}.S9gUrf-YoZ4jf,.S9gUrf-YoZ4jf *{border:none;margin:0;padding:0}.fFW7wc-ibnC6b>.aZ2wEe>div{border-color:#4285f4}.P1ekSe-ZMv3u>div:nth-child(1){background-color:#1a73e8!important}.P1ekSe-ZMv3u>div:nth-child(2),.P1ekSe-ZMv3u>div:nth-child(3){background-image:linear-gradient(to right,rgba(255,255,255,.7),rgba(255,255,255,.7)),linear-gradient(to right,#1a73e8,#1a73e8)!important}.haAclf{display:inline-block}.nsm7Bb-HzV7m-LgbsSe{border-radius:4px;box-sizing:border-box;transition:background-color .218s,border-color .218s;-moz-user-select:none;background-color:#fff;background-image:none;border:1px solid #dadce0;color:#3c4043;cursor:pointer;font-family:"Google Sans",arial,sans-serif;font-size:14px;height:40px;letter-spacing:0.25px;outline:none;overflow:hidden;padding:0 12px;position:relative;text-align:center;vertical-align:middle;white-space:nowrap;width:auto}@media screen and (-ms-high-contrast:active){.nsm7Bb-HzV7m-LgbsSe{border:2px solid windowText;color:windowText}}@media screen and (preferes-contrast:more){.nsm7Bb-HzV7m-LgbsSe{color:#000}}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe{font-size:14px;height:32px;letter-spacing:0.25px;padding:0 10px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe{font-size:11px;height:20px;letter-spacing:0.3px;padding:0 8px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe{padding:0;width:40px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.pSzOP-SxQuSe{width:32px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.purZT-SxQuSe{width:20px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK{border-radius:20px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK.pSzOP-SxQuSe{border-radius:16px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK.purZT-SxQuSe{border-radius:10px}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc{border:none;color:#fff}.nsm7Bb-HzV7m-LgbsSe.MFS4be-v3pZbf-Ia7Qfc{background-color:#1a73e8}.nsm7Bb-HzV7m-LgbsSe.MFS4be-JaPV2b-Ia7Qfc{background-color:#202124;color:#e8eaed}@media screen and (prefers-contrast:more){.nsm7Bb-HzV7m-LgbsSe.MFS4be-JaPV2b-Ia7Qfc{color:#fff}}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:18px;margin-right:8px;min-width:18px;width:18px}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:14px;min-width:14px;width:14px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:10px;min-width:10px;width:10px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin-left:8px;margin-right:-4px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin:0;padding:10px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{padding:8px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{padding:4px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-top-left-radius:3px;border-bottom-left-radius:3px;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;justify-content:center;align-items:center;background-color:#fff;height:36px;margin-left:-10px;margin-right:12px;min-width:36px;width:36px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf .nsm7Bb-HzV7m-LgbsSe-Bz112c,.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin:0;padding:0}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{height:28px;margin-left:-8px;margin-right:10px;min-width:28px;width:28px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{height:16px;margin-left:-6px;margin-right:8px;min-width:16px;width:16px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:3px;margin-left:2px;margin-right:0;padding:0}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:18px}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:14px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:8px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-bN97Pc-sM5MNb{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;flex-direction:row;justify-content:space-between;flex-wrap:nowrap;height:100%;position:relative;width:100%}.nsm7Bb-HzV7m-LgbsSe .oXtfBe-l4eHX{justify-content:center}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-BPrWId{flex-grow:1;font-family:"Google Sans",arial,sans-serif;font-weight:500;overflow:hidden;text-overflow:ellipsis;vertical-align:top}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-BPrWId{font-weight:300}.nsm7Bb-HzV7m-LgbsSe .oXtfBe-l4eHX .nsm7Bb-HzV7m-LgbsSe-BPrWId{flex-grow:0}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-MJoBVe{transition:background-color .218s;bottom:0;left:0;position:absolute;right:0;top:0}.nsm7Bb-HzV7m-LgbsSe:hover,.nsm7Bb-HzV7m-LgbsSe:focus{box-shadow:none;border-color:rgb(210,227,252);outline:none}.nsm7Bb-HzV7m-LgbsSe:focus-within{outline:2px solid #00639b;border-color:transparent}.nsm7Bb-HzV7m-LgbsSe:hover .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(66,133,244,.08)}.nsm7Bb-HzV7m-LgbsSe:active .nsm7Bb-HzV7m-LgbsSe-MJoBVe,.nsm7Bb-HzV7m-LgbsSe:focus .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(66,133,244,.1)}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:hover .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(255,255,255,.24)}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:active .nsm7Bb-HzV7m-LgbsSe-MJoBVe,.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:focus .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(255,255,255,.32)}.nsm7Bb-HzV7m-LgbsSe .n1UuX-DkfjY{border-radius:50%;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;height:20px;margin-left:-4px;margin-right:8px;min-width:20px;width:20px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId{font-family:"Roboto";font-size:12px;text-align:left}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .ssJRIf,.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff .fmcmS{overflow:hidden;text-overflow:ellipsis}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;color:#5f6368;fill:#5f6368;font-size:11px;font-weight:400}.nsm7Bb-HzV7m-LgbsSe.jVeSEe.MFS4be-Ia7Qfc .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{color:#e8eaed;fill:#e8eaed}@media screen and (prefers-contrast:more){.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff,.nsm7Bb-HzV7m-LgbsSe.jVeSEe.MFS4be-Ia7Qfc .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{color:#000;fill:#000}}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff .Bz112c{height:18px;margin:-3px -3px -3px 2px;min-width:18px;width:18px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-top-left-radius:0;border-bottom-left-radius:0;border-top-right-radius:3px;border-bottom-right-radius:3px;margin-left:12px;margin-right:-10px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:18px}.L5Fo6c-sM5MNb{border:0;display:block;left:0;position:relative;top:0}.L5Fo6c-bF1uUb{-moz-border-radius:4px;border-radius:4px;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0}.L5Fo6c-bF1uUb:focus{border:none;outline:none}sentinel{}</style><script type="text/javascript" charset="UTF-8" src="https://maps.googleapis.com/maps-api-v3/api/js/61/14/common.js"></script><script type="text/javascript" charset="UTF-8" src="https://maps.googleapis.com/maps-api-v3/api/js/61/14/util.js"></script></head>
<body data-new-gr-c-s-check-loaded="8.932.0" data-gr-ext-installed="" style="overflow: auto;">
    <!-- Main App View -->
    <header class="header">
        <div class="logo" style="cursor: pointer;">
            <i class="fas fa-star" style="color: var(--primary); margin-right: 0.5rem;"></i>
            VenueVue
        </div>

        <div class="search-container">
        <div class="search-bar" style="position: relative; display: flex; align-items: center;">
            <input type="text" placeholder="Search for event vendors..." id="search-input" style="flex-grow: 1; padding-left: 1rem; padding-right: 2.5rem;">
            <button id="search-button" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.25rem;">
                <i class="fas fa-magnifying-glass"></i>
            </button>
        </div>
        </div>

        <div class="user-nav">
            <button class="btn btn-primary" id="book-now-btn" onclick="openBookingModal()" style="margin-right: 1rem; padding: 0.75rem 1.5rem; font-weight: 600;">
                <i class="fas fa-calendar" style="margin-right: 0.5rem;"></i>Book Now
            </button>
            <div class="nav-icon" id="wishlist-btn">
                <i class="fas fa-heart"></i>
                <span class="badge" id="favorites-badge">0</span>
            </div>
            <div class="nav-icon" id="notifications-btn">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notifications-badge">0</span>
            </div>
            <div class="nav-icon" id="profile-btn" style="background-color: var(--primary); color: white; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">S</div>
        </div>
    </header>

    <div class="app-container" id="app-container" style="display: none;">
        <!-- Categories Navigation -->
        <nav class="categories-nav">
            <button class="nav-scroll-btn left" id="scroll-left">◀</button>
            <div class="categories-list-wrapper">
                <div class="categories-list" id="categories-list"><div class="category-item active" data-category="all"><i class="fas fa-th-large"></i><span>All Categories</span></div><div class="category-item" data-category="venue"><i class="fas fa-building"></i><span>Venues</span></div><div class="category-item" data-category="photo"><i class="fas fa-camera"></i><span>Photo/Video</span></div><div class="category-item" data-category="music"><i class="fas fa-music"></i><span>Music/DJ</span></div><div class="category-item" data-category="catering"><i class="fas fa-utensils"></i><span>Catering</span></div><div class="category-item" data-category="entertainment"><i class="fas fa-theater-masks"></i><span>Entertainment</span></div><div class="category-item" data-category="experiences"><i class="fas fa-star"></i><span>Experiences</span></div><div class="category-item" data-category="decor"><i class="fas fa-ribbon"></i><span>Decorations</span></div><div class="category-item" data-category="beauty"><i class="fas fa-spa"></i><span>Beauty</span></div><div class="category-item" data-category="cake"><i class="fas fa-birthday-cake"></i><span>Cake</span></div><div class="category-item" data-category="transport"><i class="fas fa-shuttle-van"></i><span>Transportation</span></div><div class="category-item" data-category="planner"><i class="fas fa-clipboard-list"></i><span>Planners</span></div><div class="category-item" data-category="fashion"><i class="fas fa-tshirt"></i><span>Fashion</span></div><div class="category-item" data-category="stationery"><i class="fas fa-envelope"></i><span>Stationery</span></div></div>
            </div>
            <button class="nav-scroll-btn right" id="scroll-right">▶</button>
        </nav>

        <aside class="sidebar">
            <div class="filter-section">
                <h3 class="filter-title">
                    Location
                    <span class="filter-reset" id="location-reset">Reset</span>
                </h3>
                <input type="text" placeholder="City or ZIP code" class="search-input" id="location-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="current-location">
                        <label for="current-location">Use my location</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="within50">
                        <label for="within50">Within 50 miles</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">
                    Price Range
                    <span class="filter-reset" id="price-reset">Reset</span>
                </h3>
                <input type="range" class="range-slider" min="0" max="100" value="40" id="price-slider">
                <div class="price-labels">
                    <span>$</span>
                    <span>$$</span>
                    <span>$$$</span>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">
                    Vendor Type
                    <span class="filter-reset" id="type-reset">Reset</span>
                </h3>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="independent">
                        <label for="independent">Independent</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="company">
                        <label for="company">Company</label>
                    </div>
                </div>
            </div>

            <!-- New Advanced Filters Section -->
            <div class="advanced-filters">
                <div class="advanced-toggle" id="advanced-toggle">
                    <h3 class="filter-title">Advanced Filters</h3>
                    <span>+</span>
                </div>
                <div class="advanced-content" id="advanced-content">
                    <div class="filter-section">
                        <h3 class="filter-title">Availability</h3>
                        <div class="date-picker">
                            <input type="date" id="start-date" placeholder="Start date">
                            <input type="date" id="end-date" placeholder="End date">
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">Region</h3>
                        <select class="region-select" id="region-select">
                            <option value="">All Regions</option>
                            <option value="north">Northern Region</option>
                            <option value="south">Southern Region</option>
                            <option value="east">Eastern Region</option>
                            <option value="west">Western Region</option>
                            <option value="central">Central Region</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="trending-section">
                <h3 class="filter-title">Popular Filters</h3>
                <div class="trending-tags">
                    <div class="trending-tag" data-filter="premium">Premium</div>
                    <div class="trending-tag" data-filter="eco-friendly">Eco-Friendly</div>
                    <div class="trending-tag" data-filter="award-winning">Award Winning</div>
                    <div class="trending-tag" data-filter="last-minute">Last Minute</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="results-title">Vendors in Los Angeles</h1>
                    <p class="results-count">2 vendors available</p>
                </div>

                <div class="view-controls">
                    <button id="filters-toggle" class="btn btn-outline" style="display:flex;align-items:center;gap:.5rem;">
                        <i class="fas fa-sliders-h"></i>
                        <span>Filters</span>
                    </button>
                    <select class="sort-select" id="sort-select">
                        <option value="recommended">Sort: Recommended</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                        <option value="nearest">Nearest to Me</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                    <div class="view-toggle" id="legacy-view-toggle"></div>
                </div>
            </div>

            
            <div id="map-view"></div>

            <div class="vendor-grid" id="vendor-grid"></div>

            <div class="pagination" id="pagination" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin: 2rem 0;">
                <div class="page-btn" id="prev-page">«</div>
                <div class="page-btn active">1</div>
                <div class="page-btn">2</div>
                <div class="page-btn">3</div>
                <div class="page-btn">4</div>
                <div class="page-btn">5</div>
                <div class="page-btn">6</div>
                <div class="page-btn" id="next-page">»</div>
            </div>
        </main>
    </div>

    <!-- Vendor Public Profile Page -->
    <div id="vendor-profile-page" class="profile-content" style="display: none;">
                    <!-- Back Button -->
                    <div style="margin-bottom: 2rem;">
                        <button onclick="window.location.hash = ''" class="btn btn-outline" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>← Back to search results</span>
                        </button>
                    </div>
                    
                    <!-- Image Gallery - Dynamic -->
                    <div id="modal-image-gallery" class="image-gallery">
                        <div class="gallery-item large-image">
                            <img id="main-vendor-image" src="https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png" alt="Main Venue Image">
                        </div>
                        <div class="thumbnails-container" id="vendor-thumbnails">
                            <!-- Thumbnails will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Vendor Header -->
                    <div class="vendor-profile-header">
                        <div class="vendor-profile-info">
                            <h1 id="vendor-business-name" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">Loading...</h1>
                            <p id="vendor-tagline" style="font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem;">Loading tagline...</p>
                            <div style="display: flex; align-items: center; gap: 1rem; color: var(--text-light); margin-bottom: 1rem; flex-wrap: wrap;">
                                <span id="vendor-location"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Loading location...</span>
                                <span id="vendor-years-business" style="display: none;"></span>
                                <span class="review-rating" style="color: #fbbf24;">★★★★★</span>
                                <span>(5.0) | 1 Reviews</span>
                            </div>
                        </div>
                         <!-- Favorite Button -->
                        <div id="vendor-favorite-btn" class="vendor-favorite" data-id="1" style="flex-shrink: 0; align-self: flex-start; margin-top: 1rem;"><i class="fas fa-heart"></i></div>
                    </div>

                    <!-- Vendor Content Sections -->
                    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 2rem; margin-top: 2rem;">
                        <!-- Main Content Area -->
                        <div>
                            <h2 class="services-title">About Us</h2>
                            <p id="vendor-description" style="line-height: 1.6;">Loading business description...</p>
                            
                            <!-- Services & Packages Section -->
                            <div id="services-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Services & Packages</h2>
                                <div id="services-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                                    <!-- Services will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Business Hours Section -->
                            <div id="business-hours-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Business Hours</h2>
                                <div id="business-hours-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <!-- Business hours will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Social Media Section -->
                            <div class="services-section">
                                <h2 class="services-title">Connect With Us</h2>
                                <div id="social-media-links" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                    <!-- Social media links will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Category Services Section -->
                            <div id="category-services-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Our Specialties</h2>
                                <div id="category-answers-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <!-- Category answers will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- FAQ Section -->
                            <div id="faq-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Frequently Asked Questions</h2>
                                <div id="faq-list">
                                    <!-- FAQs will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Team Section -->
                            <div id="team-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Our Team</h2>
                                <div id="team-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <!-- Team members will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Reviews Section -->
                            <div class="reviews-section">
                                <h2 class="reviews-title">Reviews (1)</h2>
                                <div id="vendor-profile-reviews-list">
                                    
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer">Jane Doe</div>
                            <div class="review-date">August 8, 2025</div>
                        </div>
                        <div class="review-rating">★★★★★</div>
                        <div class="review-title">Absolutely fantastic!</div>
                        <div class="review-text">John and his team were amazing. They captured every special moment beautifully. Highly recommend!</div>
                    </div>
                
                                </div>
                                
                                    <button class="btn btn-outline add-review-btn" id="show-review-form" style="margin-top: 1rem;">Add Review</button>
                                    <div class="review-form" id="review-form" style="display: none;">
                                        <div class="rating-input">
                                            <span class="rating-star" data-rating="1">☆</span>
                                            <span class="rating-star" data-rating="2">☆</span>
                                            <span class="rating-star" data-rating="3">☆</span>
                                            <span class="rating-star" data-rating="4">☆</span>
                                            <span class="rating-star" data-rating="5">☆</span>
                                        </div>
                                        <textarea class="review-textarea" id="review-text" placeholder="Share your experience..."></textarea>
                                        <button class="btn btn-primary" id="submit-review">Submit Review</button>
                                    </div>
                                
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div style="display: flex; flex-direction: column; gap: 1rem; position: sticky; top: 2rem;">
                            <!-- Booking Summary -->
                            <div id="booking-summary" style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Your Booking</h3>
                                <div id="selected-services-list">
                                    <p style="font-size: 0.9rem; color: var(--text-light);">Select services from the list to get started.</p>
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 1rem 0; padding-top: 1rem; display: flex; justify-content: space-between; font-weight: 600;">
                                    <span>Total</span>
                                    <span id="booking-total-price">$0.00</span>
                                </div>
                                <button class="btn btn-primary" id="proceed-to-book-btn" style="width: 100%;" disabled="">Choose Services</button>
                            </div>

                            <!-- Contact -->
                            <div style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Contact Vendor</h3>
                                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-light);">Have questions? Get in touch!</p>
                                <button class="btn btn-outline" id="open-chat-btn" style="width: 100%;">Message Vendor</button>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Dashboard Modal -->
    <div id="dashboard-modal" class="modal" data-no-outside-close style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="dashboard-modal-title">Dashboard</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body" style="padding: 0; overflow: hidden; flex-grow: 1;">
                <!-- Client Dashboard -->
                <div class="dashboard-container" id="dashboard-container" style="display: none; height: 100%;">
                    <aside class="dashboard-sidebar">
                        <div class="logo" style="padding: 1rem 0; border-bottom: 1px solid var(--border);">
                            <span>🎉</span>
                            VenueVue
                        </div>
                        <ul class="dashboard-menu">
                            <li><a href="#" class="active" data-section="dashboard">Dashboard</a></li>
                            <li><a href="#" data-section="bookings">My Bookings</a></li>
                            <li><a href="#" data-section="requests">My Requests</a></li>
                            <li><a href="#" data-section="favorites">Favorites</a></li>
                            <li><a href="#" data-section="messages">Messages</a></li>
                            <li><a href="#" data-section="reviews">My Reviews</a></li>
                            <li><a href="#" data-section="settings">Settings</a></li>
                            <li><a href="#" id="switch-to-vendor">Switch to Vendor Mode</a></li>
                            <li><a href="#" id="logout-dashboard">Log Out</a></li>
                        </ul>
                    </aside>
                    <main class="dashboard-content" style="overflow-y: auto;">
                        <div class="dashboard-header">
                            <h1 class="dashboard-title" id="dashboard-title">Dashboard</h1>
                            <div class="user-nav">
                                <div class="nav-icon" id="dashboard-notifications-btn">
                                    <i class="fas fa-bell"></i>
                                    <span class="badge" id="dashboard-notifications-badge">0</span>
                                </div>
                            </div>
                        </div>
                        <div id="dashboard-section">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Upcoming Bookings</h2>
                                <div id="upcoming-bookings"><p>Loading upcoming bookings...</p></div>
                            </div>
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Recent Favorites</h2>
                                <div class="vendor-grid" id="dashboard-favorites"><p>Loading recent favorites...</p></div>
                            </div>
                        </div>
                        <div id="bookings-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">All Bookings</h2>
                                <div id="all-bookings"><p>Loading all bookings...</p></div>
                            </div>
                        </div>
                        <div id="favorites-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Saved Favorites</h2>
                                <div class="vendor-grid" id="saved-favorites"><p>Loading saved favorites...</p></div>
                            </div>
                        </div>
                        <div id="messages-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Messages</h2>
                                <div class="chat-container">
                                    <div class="chat-messages" id="dashboard-chat-messages"><p>Loading messages...</p></div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="dashboard-chat-input">
                                        <button class="btn btn-primary" id="dashboard-send-btn">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="requests-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">My Requests</h2>
                                <div class="requests-filter-tabs">
                                    <button class="tab-btn active" data-filter="all">All Requests</button>
                                    <button class="tab-btn" data-filter="pending">Pending</button>
                                    <button class="tab-btn" data-filter="approved">Approved</button>
                                    <button class="tab-btn" data-filter="declined">Declined</button>
                                    <button class="tab-btn" data-filter="expired">Expired</button>
                                </div>
                                <div id="user-requests"><p>Loading your requests...</p></div>
                            </div>
                        </div>
                        <div id="reviews-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">My Reviews</h2>
                                <div id="user-reviews"><p>Loading your reviews...</p></div>
                            </div>
                        </div>
                        <div id="settings-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Account Settings</h2>
                                <form id="profile-form">
                                    <div class="form-group"><label for="profile-name">Full Name</label><input type="text" id="profile-name"></div>
                                    <div class="form-group"><label for="profile-email">Email</label><input type="email" id="profile-email" disabled=""></div>
                                    <div class="form-group"><label for="profile-phone">Phone Number</label><input type="tel" id="profile-phone"></div>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </form>
                            </div>
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Change Password</h2>
                                <form id="password-form">
                                    <div class="form-group"><label for="current-password">Current Password</label><input type="password" id="current-password"></div>
                                    <div class="form-group"><label for="new-password">New Password</label><input type="password" id="new-password"></div>
                                    <div class="form-group"><label for="confirm-password">Confirm New Password</label><input type="password" id="confirm-password"></div>
                                    <button type="submit" class="btn btn-primary">Update Password</button>
                                </form>
                            </div>
                        </div>
                    </main>
                </div>
                <!-- Vendor Dashboard -->
                <div class="dashboard-container" id="vendor-dashboard-container" style="display: none; height: 100%;">
                    <aside class="dashboard-sidebar">
                        <div class="logo" style="padding: 1rem 0; border-bottom: 1px solid var(--border);">
                            <span>🎉</span>
                            VenueVue
                        </div>
                        <ul class="dashboard-menu">
                            <li><a href="#" class="active" data-section="vendor-dashboard">Dashboard</a></li>
                            <li><a href="#" data-section="vendor-bookings">Bookings</a></li>
                            <li><a href="#" data-section="vendor-requests">Pending Requests</a></li>
                            <li><a href="#" data-section="vendor-services">Services</a></li>
                            <li><a href="#" data-section="vendor-messages">Messages</a></li>
                            <li><a href="#" data-section="vendor-reviews">Reviews</a></li>
                            <li><a href="#" data-section="vendor-analytics">Analytics</a></li>
                            <li><a href="#" data-section="vendor-settings">Settings</a></li>
                            <li><a href="#" id="switch-to-client">Switch to Client Mode</a></li>
                            <li><a href="#" id="vendor-logout">Log Out</a></li>
                        </ul>
                    </aside>
                    <main class="dashboard-content" style="overflow-y: auto;">
                        <div class="dashboard-header">
                            <h1 class="dashboard-title" id="vendor-dashboard-title">Vendor Dashboard</h1>
                            <div class="user-nav">
                                <div class="nav-icon" id="vendor-notifications-btn">
                                    <i class="fas fa-bell"></i>
                                    <span class="badge" id="vendor-notifications-badge">0</span>
                                </div>
                            </div>
                        </div>
                        <div id="vendor-dashboard-section">
                            <div class="vendor-stats" id="vendor-stats"><p>Loading vendor stats...</p></div>
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Recent Bookings</h2>
                                <div id="vendor-recent-bookings"><p>Loading recent bookings...</p></div>
                            </div>
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Recent Messages</h2>
                                <div class="chat-container" style="height: 400px;">
                                    <div class="chat-messages" id="vendor-chat-messages"><p>Loading recent messages...</p></div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="vendor-chat-input">
                                        <button class="btn btn-primary" id="vendor-send-btn">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="vendor-bookings-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">All Bookings</h2>
                                <div id="vendor-all-bookings"><p>Loading all bookings...</p></div>
                            </div>
                        </div>
                        <div id="vendor-requests-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Pending Requests</h2>
                                <div class="requests-stats">
                                    <div class="stat-card">
                                        <div class="stat-value" id="pending-requests-count">0</div>
                                        <div class="stat-label">Pending Requests</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="expiring-soon-count">0</div>
                                        <div class="stat-label">Expiring Soon</div>
                                    </div>
                                </div>
                                <div id="vendor-pending-requests"><p>Loading pending requests...</p></div>
                            </div>
                        </div>
                        <div id="vendor-services-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Manage Services</h2>
                                <div class="services-section" id="vendor-services"><p>Loading services...</p></div>
                            </div>
                        </div>
                        <div id="vendor-messages-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Messages</h2>
                                <div class="chat-container" style="height: 500px;">
                                    <div class="chat-messages" id="vendor-all-chat-messages"><p>Loading all messages...</p></div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="vendor-all-chat-input">
                                        <button class="btn btn-primary" id="vendor-all-send-btn">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="vendor-reviews-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Customer Reviews</h2>
                                <div id="vendor-reviews"><p>Loading customer reviews...</p></div>
                            </div>
                        </div>
                        <div id="vendor-analytics-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Performance Analytics</h2>
                                <div id="analytics-charts" class="analytics-charts"><p>Loading analytics data...</p></div>
                            </div>
                        </div>
                        <div id="vendor-settings-section" style="display: none;">
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Business Profile</h2>
                                <form id="vendor-profile-form">
                                    <div class="form-group"><label for="vendor-name">Business Name</label><input type="text" id="vendor-name"></div>
                                    <div class="form-group"><label for="vendor-category">Category</label><select id="vendor-category"></select></div>
                                    <div class="form-group"><label for="vendor-description">Description</label><textarea id="vendor-description" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"></textarea></div>
                                    <div class="form-group"><label for="vendor-address">Address</label><input type="text" id="vendor-address"></div>
                                    <div class="form-group"><label for="vendor-city">City</label><input type="text" id="vendor-city"></div>
                                    <div class="form-group"><label for="vendor-state">State</label><input type="text" id="vendor-state"></div>
                                    <div class="form-group"><label for="vendor-country">Country</label><input type="text" id="vendor-country"></div>
                                    <div class="form-group"><label for="vendor-postalCode">Postal Code</label><input type="text" id="vendor-postalCode"></div>
                                    <div class="form-group"><label for="vendor-phone">Phone Number</label><input type="tel" id="vendor-phone"></div>
                                    <div class="form-group"><label for="vendor-email">Business Email</label><input type="email" id="vendor-email"></div>
                                    <div class="form-group"><label for="vendor-website">Website (optional)</label><input type="url" id="vendor-website"></div>
                                    <div class="form-group"><label for="vendor-years-in-business">Years in Business</label><input type="number" id="vendor-years-in-business" min="0"></div>
                                    <div class="form-group"><label for="vendor-is-premium">Premium Vendor</label><input type="checkbox" id="vendor-is-premium"></div>
                                    <div class="form-group"><label for="vendor-is-eco-friendly">Eco-Friendly</label><input type="checkbox" id="vendor-is-eco-friendly"></div>
                                    <div class="form-group"><label for="vendor-is-award-winning">Award Winning</label><input type="checkbox" id="vendor-is-award-winning"></div>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </form>
                            </div>
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Business Photos</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;" id="vendor-photos"><p>No photos uploaded.</p></div>
                                <button class="btn btn-outline" id="upload-photos-btn">Upload Photos</button>
                            </div>
                            <div class="dashboard-card">
                                <h2 class="dashboard-card-title">Availability Settings</h2>
                                <div id="vendor-availability-calendar" style="margin-bottom: 1.5rem;"></div>
                                <button class="btn btn-outline" id="set-business-hours-btn">Set Business Hours</button>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Registration Modal -->
    <div id="vendor-registration-modal" class="modal" data-no-outside-close style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="registration-title">Complete Your Vendor Setup</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                        <span class="step-indicator active" id="step-indicator-1">1: Business Basics</span>
                        <span class="step-indicator" id="step-indicator-2">2: Location Information</span>
                        <span class="step-indicator" id="step-indicator-3">3: Services & Packages</span>
                        <span class="step-indicator" id="step-indicator-4">4: Additional Details</span>
                        <span class="step-indicator" id="step-indicator-5">5: Availability & Scheduling</span>
                        <span class="step-indicator" id="step-indicator-6">6: Gallery & Media</span>
                        <span class="step-indicator" id="step-indicator-7">7: Social Media</span>
                        <span class="step-indicator" id="step-indicator-8">8: FAQ</span>
                        <span class="step-indicator" id="step-indicator-9">9: Summary & Completion</span>
                    </div>
                    <div style="background-color: var(--border); height: 4px; border-radius: 2px; overflow: hidden;">
                        <div id="setup-progress-bar" style="background-color: var(--primary); height: 100%; width: 11.11%; transition: width 0.3s ease;"></div>
                    </div>
                </div>

                <div id="reg-status-message" style="text-align: center; color: var(--primary); margin-bottom: 1rem;"></div>
                
                <!-- Step 1: Business Basics -->
                <div class="setup-step" id="setup-step-1" style="display: block;">
                    <h4 class="form-section-title">Step 1: Business Basics</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Tell us about your business and what services you provide.</p>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-name">Business Name *</label>
                                <input type="text" id="business-name" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="display-name">Display Name (for public listing)</label>
                                <input type="text" id="display-name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-email">Business Email *</label>
                                <input type="email" id="business-email" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-phone">Business Phone *</label>
                                <input type="tel" id="business-phone" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="website-url">Website URL</label>
                                <input type="url" id="website-url" placeholder="https://yourwebsite.com">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="years-in-business">Years in Business</label>
                                <input type="number" id="years-in-business" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="business-description">Business Description <span style="color: red;">*</span></label>
                        <textarea id="business-description" rows="4" required placeholder="Describe your business and what makes you unique..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 0.9rem; line-height: 1.4; resize: vertical; min-height: 120px; background-color: white;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="tagline">Tagline (short description)</label>
                        <input type="text" id="tagline" placeholder="Your catchy business tagline...">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="primary-category">Primary Category <span style="color: red;">*</span></label>
                                <select id="primary-category" required class="select2-category" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                    <option value="">Select primary category</option>
                                    <option value="beauty">Beauty</option>
                                    <option value="cake">Cake</option>
                                    <option value="catering">Catering</option>
                                    <option value="decor">Decor</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="experiences">Experiences</option>
                                    <option value="fashion">Fashion</option>
                                    <option value="music">Music</option>
                                    <option value="photo">Photo</option>
                                    <option value="planner">Planner</option>
                                    <option value="stationery">Stationery</option>
                                    <option value="transport">Transport</option>
                                    <option value="venue">Venue</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="additional-categories">Additional Categories</label>
                                <select id="additional-categories" multiple class="select2-category" style="width: 100%; min-height: 50px; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                    <option value="beauty">Beauty</option>
                                    <option value="cake">Cake</option>
                                    <option value="catering">Catering</option>
                                    <option value="decor">Decor</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="experiences">Experiences</option>
                                    <option value="fashion">Fashion</option>
                                    <option value="music">Music</option>
                                    <option value="photo">Photo</option>
                                    <option value="planner">Planner</option>
                                    <option value="stationery">Stationery</option>
                                    <option value="transport">Transport</option>
                                    <option value="venue">Venue</option>
                                </select>
                                <small style="color: var(--text-light);">Select multiple categories that apply to your business</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-primary" id="next-to-step-2">Next: Location Information</button>
                    </div>
                </div>

                <!-- Step 2: Location Information (ENHANCED) -->
                <div class="setup-step" id="setup-step-2" style="display: none;">
                    <h4 class="form-section-title">Step 2: Location Information</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Tell us where your business is located and which areas you serve.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Physical Office (Optional)</h5>
                    <div class="form-group">
                        <label for="business-address">Street Address</label>
                        <input type="text" id="business-address" placeholder="123 Main Street, Toronto, ON" class="google-autocomplete">
                        <small style="color: var(--text-light);">Start typing your Canadian address and select from suggestions</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-city">City</label>
                                <input type="text" id="business-city" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-state">Province</label>
                                <input type="text" id="business-state" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-country">Country</label>
                                <input type="text" id="business-country" value="Canada" readonly style="background-color: #f8f9fa; width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem;">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-postal">Postal Code</label>
                                <input type="text" id="business-postal" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for latitude and longitude -->
                    <input type="hidden" id="business-latitude">
                    <input type="hidden" id="business-longitude">

            <h5 style="margin: 2rem 0 1rem 0; color: var(--primary);">Service Areas <span style="color: red;">*</span></h5>
            <div class="form-group">
                <label for="additional-cities">Cities/Regions Served <span style="color: red;">*</span></label>
                <div id="additional-cities-container" style="min-height: 120px; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; background-color: white;">
                    <input type="text" id="additional-cities-input" placeholder="Start typing a city name..." class="google-places-input" style="width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem;" required>
                    <div id="selected-cities" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <!-- Selected cities will appear here as tags -->
                    </div>
                </div>
                <small style="color: var(--text-light); font-size: 0.8rem;">Type city names and select from Google's suggestions. You must specify at least one service area. Selected cities will appear as tags above.</small>
            </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-1">Back: Business Basics</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-3">Next: Services & Packages</button>
                    </div>
                </div>

                <!-- Step 3: Services & Packages -->
                <div class="setup-step" id="setup-step-3" style="display: none;">
                    <h4 class="form-section-title">Step 3: Services & Packages</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Select services from our curated list that match your business categories and customize them with your pricing.</p>
                    
                    <!-- Loading State -->
                    <div id="predefined-services-loading" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Loading available services...</p>
                    </div>
                    
                    <!-- Predefined Services Section -->
                    <div id="predefined-services-container" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                            <h5 style="margin: 0; color: var(--primary);">Available Services</h5>
                            <span id="selected-services-count" style="color: var(--text-light); font-size: 0.9rem;">0 services selected</span>
                        </div>
                        
                        <div id="predefined-services-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <!-- Predefined services will be loaded here -->
                        </div>
                        
                        <!-- Selected Services Summary -->
                        <div id="selected-services-summary" style="display: none; margin-top: 2rem; padding: 1.5rem; background-color: var(--secondary); border-radius: var(--radius); border: 1px solid var(--border);">
                            <h6 style="margin: 0 0 1rem 0; color: var(--primary);">Selected Services Summary</h6>
                            <div id="selected-services-list">
                                <!-- Selected services will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- No Services Available Message -->
                    <div id="no-services-message" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                        <h6 style="margin-bottom: 0.5rem;">No predefined services available</h6>
                        <p style="margin: 0;">No services match your selected categories. You can add custom services in the next step.</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-2">Back: Location Information</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-4">Next: Additional Details</button>
                    </div>
                </div>

                <!-- Step 4: Additional Details -->
                <div class="setup-step" id="setup-step-4" style="display: none;">
                    <h4 class="form-section-title">Step 4: Additional Details</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Please answer the following questions related to your primary category.</p>
                    
                    <div id="category-questions-container" style="margin-bottom: 1rem;">
                        <!-- Category-specific questions will be dynamically loaded here -->
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-3">Back: Services & Packages</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-5">Next: Availability & Scheduling</button>
                    </div>
                </div>

                <!-- Step 5: Availability & Scheduling -->
                <div class="setup-step" id="setup-step-5" style="display: none;">
                    <h4 class="form-section-title">Step 5: Availability & Scheduling</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Set your business hours and availability preferences.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Regular Business Hours</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-0">
                                <strong>Sunday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-0" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-0" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-1" checked>
                                <strong>Monday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-1" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-1" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-2" checked>
                                <strong>Tuesday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-2" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-2" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-3" checked>
                                <strong>Wednesday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-3" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-3" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-4" checked>
                                <strong>Thursday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-4" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-4" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-5" checked>
                                <strong>Friday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-5" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-5" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-6">
                                <strong>Saturday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-6" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-6" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="lead-time">Minimum booking lead time <span style="color: red;">*</span></label>
                                <select id="lead-time" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                    <option value="same-day">Same day</option>
                                    <option value="1-day" selected>1 day</option>
                                    <option value="3-days">3 days</option>
                                    <option value="1-week">1 week</option>
                                    <option value="2-weeks">2 weeks</option>
                                    <option value="1-month">1 month</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="availability-dates">Available Dates <span style="color: red;">*</span></label>
                                <input type="date" id="availability-dates" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                <small style="color: var(--text-light);">You must provide at least one available date</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-4">Back: Additional Details</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-6">Next: Gallery & Media</button>
                    </div>
                </div>

                <!-- Step 6: Gallery & Media -->
                <div class="setup-step" id="setup-step-6" style="display: none;">
                    <h4 class="form-section-title">Step 6: Gallery & Media</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Upload images to showcase your work and attract potential clients.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Featured Image</h5>
                    <div class="form-group">
                        <label for="featured-image">Main Profile Image <span style="color: red;">*</span></label>
                        <input type="file" id="featured-image" accept="image/*" required>
                        <small style="color: var(--text-light);">This will be the main image displayed on your profile. Recommended size: 800x600px</small>
                        <div id="featured-image-preview" style="margin-top: 1rem; display: none;">
                            <img id="featured-image-display" style="max-width: 300px; max-height: 200px; border-radius: var(--radius); border: 1px solid var(--border);">
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">Preview of your main profile image</p>
                        </div>
                    </div>
                    
                    <h5 style="margin: 2rem 0 1rem 0; color: var(--primary);">Gallery Images</h5>
                    <div class="form-group">
                        <label for="gallery-images">Additional Images</label>
                        <input type="file" id="gallery-images" accept="image/*" multiple>
                        <small style="color: var(--text-light);">Upload multiple images to showcase your work. You can select up to 20 images.</small>
                        <div id="selected-images-list" style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: #f8f9fa; display: none;">
                            <h6 style="margin-bottom: 0.5rem; color: var(--primary);">Selected Images:</h6>
                            <div id="image-names-list" style="font-size: 0.9rem; color: var(--text-light);"></div>
                        </div>
                    </div>
                    
                    <div id="image-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
                        <!-- Image previews will appear here -->
                    </div>
                    
                    <!-- Portfolio Links section removed as requested -->
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-5">Back: Availability & Scheduling</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-7">Next: Social Media</button>
                    </div>
</div>

                <!-- Step 7: Social Media -->
                <div class="setup-step" id="setup-step-7" style="display: none;">
                    <h4 class="form-section-title">Step 7: Social Media</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Add your social media profiles to help clients connect with you.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Social Media Profiles</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label for="social-facebook" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-facebook" style="color: #1877F2; font-size: 1.2rem;"></i>
                                Facebook
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">facebook.com/</span>
                                <input type="text" id="social-facebook" placeholder="yourpage" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://facebook.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-instagram" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-instagram" style="color: #E4405F; font-size: 1.2rem;"></i>
                                Instagram
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">instagram.com/</span>
                                <input type="text" id="social-instagram" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://instagram.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-twitter" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-twitter" style="color: #1DA1F2; font-size: 1.2rem;"></i>
                                Twitter
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">twitter.com/</span>
                                <input type="text" id="social-twitter" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://twitter.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-linkedin" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-linkedin" style="color: #0077B5; font-size: 1.2rem;"></i>
                                LinkedIn
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">linkedin.com/in/</span>
                                <input type="text" id="social-linkedin" placeholder="yourprofile" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://linkedin.com/in/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-youtube" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-youtube" style="color: #FF0000; font-size: 1.2rem;"></i>
                                YouTube
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">youtube.com/</span>
                                <input type="text" id="social-youtube" placeholder="yourchannel" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://youtube.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-tiktok" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-tiktok" style="color: #000000; font-size: 1.2rem;"></i>
                                TikTok
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">tiktok.com/@</span>
                                <input type="text" id="social-tiktok" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://tiktok.com/@">
                            </div>
                        </div>
                    </div>
                    

                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-6">Back: Gallery & Media</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-8">Next: FAQ</button>
                    </div>
                </div>

                <!-- Step 8: FAQ Section -->
                <div class="setup-step" id="setup-step-8" style="display: none;">
                    <h4 class="form-section-title">Step 8: FAQ Section</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Add frequently asked questions to help potential clients understand your services better.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Frequently Asked Questions</h5>
                    <div id="faqs-list" style="margin-bottom: 1rem;">
                        <!-- FAQs will be listed here -->
                    </div>
                    <button type="button" class="btn btn-outline" id="add-faq-btn">Add FAQ</button>
                    
                    <!-- FAQ Form -->
                    <div id="faq-form" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius);">
                        <div class="form-group">
                            <label>Question</label>
                            <input type="text" id="faq-question" required placeholder="What is your typical response time?">
                        </div>
                        <div class="form-group">
                            <label>Answer</label>
                            <textarea id="faq-answer" rows="3" required placeholder="I typically respond to inquiries within 24 hours..."></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-primary" id="add-faq-item-btn">Add FAQ</button>
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('faq-form').style.display='none'">Cancel</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-7">Back: Additional Details</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-9">Next: Summary</button>
                    </div>
                </div>

                <!-- Step 9: Summary -->
                <div class="setup-step" id="setup-step-9" style="display: none;">
                    <h4 class="form-section-title">Step 9: Setup Summary</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Review all the information you've entered before completing your vendor profile setup.</p>
                    
                    <div id="setup-summary-content" style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem;">
                        <!-- Summary content will be dynamically populated here -->
                        <div class="summary-loading">Loading your information...</div>
                        <div id="summary-error" style="display: none; color: var(--accent); padding: 1rem; background-color: #fee; border-radius: var(--radius);">Failed to load summary. Please check your information and try again.</div>
                    </div>
                    
                    <div style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem;">
                        <p style="margin-bottom: 1rem;"><i class="fas fa-star" style="color: var(--primary); margin-right: 0.5rem;"></i><strong>Congratulations!</strong> You're about to complete your vendor profile setup.</p>
                        <p><strong>Once completed, your profile will be live and visible to potential clients!</strong></p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-8">Back: FAQ</button>
                        <button type="button" class="btn btn-primary" id="complete-setup-btn" style="background-color: #28a745; border-color: #28a745;"><i class="fas fa-rocket" style="margin-right: 0.5rem;"></i>Complete Setup & Go Live!</button>
                    </div>
                </div>




            </div>
        </div>
    </div>


    <!-- Vendor Modal (working version) -->
    <div id="vendor-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-vendor-name">Vendor Name</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Image Gallery -->
                <div id="modal-image-gallery" class="image-gallery">
                    <!-- Images will be loaded dynamically here -->
                </div>

                <!-- Header Info -->
                <div class="vendor-detail-header">
                    <div class="vendor-detail-image">
                        <!-- Image or placeholder will be rendered here -->
                    </div>
                    <div class="vendor-detail-info">
                        <h2 id="modal-vendor-name-full" class="vendor-detail-name">Vendor Name</h2>
                        <div class="vendor-detail-location"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i><span id="modal-vendor-location">Location</span></div>
                        <div class="vendor-detail-ratings">
                            <div class="review-rating" id="modal-vendor-rating">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> <span>(0.0) | 0 Reviews</span>
                            </div>
                        </div>
                        <div class="vendor-detail-features">
                            <div class="feature">
                                <span class="feature-icon" id="modal-vendor-category-icon"></span>
                                <span id="modal-vendor-category-name"></span>
                            </div>
                            <div class="feature">
                                <span class="feature-icon"><i class="fas fa-star"></i></span>
                                <span id="modal-vendor-services-offered">Services</span>
                            </div>
                        </div>
                        <p class="vendor-detail-price" id="modal-vendor-price"></p>
                    </div>
                </div>

                <!-- About Us -->
                <h3 class="services-title">About Us</h3>
                <p id="modal-vendor-description" class="vendor-detail-description">
                    Vendor description will appear here...
                </p>

                <!-- Services -->
                <div id="services-section" class="services-section">
                    <h3 class="services-title">Available Services</h3>
                    <!-- Services will be rendered here -->
                </div>

                <!-- Booking Form -->
                <div class="booking-flow">
                    <h3 class="services-title">Book This Vendor</h3>
                    <div class="form-group">
                        <label for="booking-date-picker" class="form-label">Select a Date and Time</label>
                        <input type="text" id="booking-date-picker" class="form-control" placeholder="Choose a date and time">
                    </div>
                    <button class="btn btn-primary" id="open-booking-modal-btn">
                        Book Now
                    </button>
                    <button class="btn btn-outline" id="open-chat-btn">
                        Message Vendor
                    </button>
                </div>

                <!-- Booking Calendar Section (Moved inside modal-body) -->
                <div class="booking-calendar-section">
                    <h3 class="calendar-title">Select Date &amp; Time</h3>
                    <div id="booking-calendar"></div>
                    <div class="time-slots" id="time-slots"></div>
                </div>

                <!-- Reviews Section -->
                <div class="reviews-section">
                    <h3 class="reviews-title">Customer Reviews</h3>
                    <div id="modal-reviews-list">
                        <!-- Reviews will be rendered here -->
                    </div>

                    ${currentUser ? `
                        <button class="btn btn-outline add-review-btn" id="show-review-form">Add Review</button>
                        <div class="review-form" id="review-form" style="display: none;">
                            <div class="rating-input">
                                <span class="rating-star" data-rating="1">☆</span>
                                <span class="rating-star" data-rating="2">☆</span>
                                <span class="rating-star" data-rating="3">☆</span>
                                <span class="rating-star" data-rating="4">☆</span>
                                <span class="rating-star" data-rating="5">☆</span>
                            </div>
                            <textarea class="review-textarea" id="review-text" placeholder="Share your experience..."></textarea>
                            <button class="btn btn-primary" id="submit-review">Submit Review</button>
                        </div>
                    ` : '<p><a href="#" id="login-to-review" style="color: var(--primary);">Log in</a> to leave a review</p>'}
                </div>

                <!-- Chat Section -->
                <div class="chat-section">
                    <h3 class="chat-title">Message Vendor</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will load here -->
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." id="chat-input">
                            <button class="btn btn-primary" id="send-btn">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="payment-section" id="payment-section" style="display: none;">
                    <h3 class="payment-title">Payment Information</h3>
                    <div class="payment-form">
                        <div class="form-group">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardholder-name">
                        </div>
                        <div class="card-element" id="card-element"></div>
                        <button class="btn btn-primary" id="pay-now-btn">Pay Now</button>
                    </div>
                </div>

                <div class="vendor-actions" style="margin-top: 2rem; justify-content: center;">
                    <button class="btn btn-primary" id="book-now-btn">Book Now</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Chat Modal -->
    <div id="chat-modal" class="modal chat-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chat with <span id="chat-vendor-name">Vendor</span></h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <div class="chat-container">
                    <div class="chat-messages" id="profile-chat-messages">
                        <!-- Messages will load here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" placeholder="Type your message..." id="profile-chat-input">
                        <button class="btn btn-primary" id="profile-send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Booking Confirmation -->
    <div id="confirmation-modal" class="booking-confirmation" style="display: none;">
        <div class="confirmation-content">
            <h3><i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>Booking Confirmed!</h3>
            <p><strong>Vendor:</strong> <span id="conf-venue-name"></span></p>
            <p><strong>Services:</strong> <span id="conf-services"></span></p>
            <p><strong>Date:</strong> <span id="conf-date"></span></p>
            <p><strong>Time:</strong> <span id="conf-time"></span></p>
            <p><strong>Confirmation #:</strong> <span id="conf-id"></span></p>
            <p>A confirmation email has been sent to your registered email address.</p>
            <button class="btn btn-primary" id="conf-done-btn">Done</button>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="location-permission" class="location-permission" style="display: none;">
        <div class="location-content">
            <h3>Find Vendors Near You</h3>
            <p>VenueVue would like to access your location to show vendors near you.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button class="btn btn-outline" id="deny-location">Not Now</button>
                <button class="btn btn-primary" id="allow-location">
                    Allow
                    <span id="location-loading" class="location-loading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="profile-modal-title">My Account</h3>
                <span class="close-modal" id="close-profile-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Login Form (shown by default) -->
                <div id="login-form" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="login-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" id="login-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <button class="btn btn-primary" id="login-btn" style="width: 100%; margin-bottom: 1rem;">Log In</button>
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <a href="#" id="show-signup" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">Don't have an account? Sign up</a>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                        <div style="flex: 1; height: 1px; background-color: var(--border);"></div>
                        <div style="padding: 0 1rem; color: var(--text-light); font-size: 0.9rem;">OR</div>
                        <div style="flex: 1; height: 1px; background-color: var(--border);"></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-outline" id="google-login" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" width="20" height="20">
                            <span>Continue with Google</span>
                        </button>
                        <button class="btn btn-outline" id="facebook-login" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" width="20" height="20">
                            <span>Continue with Facebook</span>
                        </button>
                    </div>
                </div>

                <!-- Signup Form (hidden by default) -->
                <div id="signup-form" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name</label>
                        <input type="text" id="signup-name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="signup-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" id="signup-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Account Type</label>
                        <select id="account-type" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <option value="client">Client (I want to book vendors)</option>
                            <option value="vendor">Vendor (I provide services)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="signup-btn" style="width: 100%; margin-bottom: 1rem;">Create Account</button>
                    <div style="text-align: center;">
                        <a href="#" id="show-login" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">Already have an account? Log in</a>
                    </div>
                </div>

                <!-- Logged In View (hidden by default) -->
                <div id="logged-in-view" style="display: block; text-align: center;">
                    <div class="profile-avatar" id="profile-avatar">S</div>
                    <h3 style="margin-bottom: 0.5rem;" id="profile-name">User Name</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;" id="profile-email">user@example.com</p>
                    <button class="btn btn-primary" id="view-dashboard-btn" style="width: 100%; margin-bottom: 1rem;">View Dashboard</button>
                    <button class="btn btn-outline" id="logout-btn" style="width: 100%;">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="lightbox-modal">
        <span class="lightbox-close">×</span>
        <button class="lightbox-nav lightbox-prev">❮</button>
        <div class="lightbox-content">
            <img src="" alt="Lightbox image" id="lightbox-image">
        </div>
        <button class="lightbox-nav lightbox-next">❯</button>
    </div>

    <!-- Multi-Step Booking Modal -->
    <div id="booking-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 95vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="booking-modal-title">Book Your Event</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div class="booking-progress" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                        <span class="step-indicator active" id="booking-step-indicator-1">1: Services</span>
                        <span class="step-indicator" id="booking-step-indicator-2">2: Details</span>
                        <span class="step-indicator" id="booking-step-indicator-3">3: Vendors</span>
                        <span class="step-indicator" id="booking-step-indicator-4">4: Requests</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="booking-progress-fill" style="width: 25%;"></div>
                    </div>
                </div>

                <!-- Step 1: Service Selection -->
                <div class="booking-step" id="booking-step-1" style="display: block;">
                    <h4 class="form-section-title">Select Your Services</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Choose the service categories you need for your event.</p>
                    
                    <div class="service-categories" id="service-categories">
                        <!-- Service categories will be loaded dynamically from the database -->
                        <div class="loading-message" style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                            Loading service categories...
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-primary" id="next-to-booking-step-2" disabled>Next: Event Details</button>
                    </div>
                </div>

                <!-- Step 2: Service Details & Event Information -->
                <div class="booking-step" id="booking-step-2" style="display: none;">
                    <h4 class="form-section-title">Service Details & Event Information</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Provide your event details, then select specific services and budgets.</p>
                    
                    <!-- Event Details (moved to top) -->
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <h5 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-calendar" style="margin-right: 0.5rem;"></i>Event Details</h5>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-date">Event Date *</label>
                                    <input type="date" id="event-date" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-start-time">Event Start Time *</label>
                                    <input type="time" id="event-start-time" required step="900">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-end-time">Event End Time *</label>
                                    <input type="time" id="event-end-time" required step="900">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="attendee-count">Number of Attendees</label>
                                    <input type="number" id="attendee-count" min="1" value="50">
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="form-group">
                            <label for="event-location">Event Location *</label>
                            <input type="text" id="event-location" placeholder="Start typing to search for a location..." required autocomplete="off">
                            <div id="location-suggestions" class="location-suggestions" style="display: none;"></div>
                        </div>
                        
                    </div>
                    
                    
                    <!-- Predefined Services Selection (moved below) -->
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <h5 style="margin-bottom: 1rem; color: var(--primary-color);">📋 Select Specific Services</h5>
                        <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem;">Choose from available services in your selected categories and set individual budgets.</p>
                        
                        <div id="predefined-services-loading" style="text-align: center; padding: 2rem; display: none;">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem; color: var(--text-light);">Loading available services...</p>
                        </div>
                        
                        <div id="booking-predefined-services-container" style="display: none;">
                            <!-- Dropdown-based service selection -->
                            <div id="service-selection-dropdowns">
                                <!-- Service dropdowns will be loaded here -->
                            </div>
                            
                            <!-- Selected services list -->
                            <div id="selected-services-list-container" style="margin-top: 1.5rem;">
                                <!-- Selected services with budgets will appear here -->
                            </div>
                        </div>
                        
                        <div id="no-services-message" style="text-align: center; padding: 2rem; color: var(--text-light); display: none;">
                            <p>No services available for your selected categories. Please go back and select different categories.</p>
                        </div>
                    </div>
                    
                    <!-- Selected Services Summary (stays below services) -->
                    <div id="selected-services-summary" style="display: none; margin-bottom: 2rem; padding: 1rem; background: var(--card-bg); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <h6 style="margin-bottom: 0.5rem; color: var(--primary-color);">Selected Services Summary</h6>
                        <div id="selected-services-list"></div>
                        <div style="margin-top: 0.5rem; font-weight: 600;">Total Budget: $<span id="total-services-budget">0</span></div>
                    </div>

                    <!-- Timeline & Scheduling (moved below Selected Services Summary) -->
                    <div id="timeline-section" style="margin-bottom: 2rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;">
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.75rem;">
                            <h5 style="margin: 0; color: var(--primary-color);"><i class="fas fa-stream" style="margin-right:0.5rem;"></i>Timeline</h5>
                        </div>
                        <div style="font-size:0.85rem; color: var(--text-light); margin-bottom:0.5rem;">
                            Set event start/end, then assign start/end for each selected service. Duration is auto-calculated.
                        </div>
                        <div id="timeline-container" style="position: relative; height: 180px; background: #fafbff; border: 1px dashed #e2e8f0; border-radius: 8px; overflow: hidden;">
                            <div id="timeline-axis" style="position:absolute; left:0; right:0; top:8px; height:20px; font-size: 11px; color:#64748b;"></div>
                            <div id="timeline-layers" style="position:absolute; left:0; right:0; top:32px; bottom:8px;"></div>
                        </div>
                        <div id="timeline-warning" style="display:none; margin-top:0.5rem; padding:0.5rem; background:#fff7ed; border:1px solid #fdba74; color:#9a3412; border-radius:6px; font-size:0.85rem;"></div>
                        <div style="display:flex; gap:1rem; margin-top:0.5rem; font-size:0.85rem; color:#64748b;">
                            <span><span style="display:inline-block; width:10px; height:10px; background:#c7d2fe; border-radius:2px; margin-right:6px;"></span>Event Window</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#bbf7d0; border-radius:2px; margin-right:6px;"></span>Vendor Hours</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#fcd34d; border-radius:2px; margin-right:6px;"></span>Service</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#fecaca; border-radius:2px; margin-right:6px;"></span>Outside Event</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-1">Back: Categories</button>
                        <button type="button" class="btn btn-primary" id="find-vendors-btn" disabled>Find Matching Vendors</button>
                    </div>
                </div>

                <!-- Step 3: Vendor Matching -->
                <div class="booking-step" id="booking-step-3" style="display: none;">
                    <h4 class="form-section-title">Available Vendors</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Select vendors that match your requirements. View nearby vendors on the map and browse detailed options below.</p>
                    
                    <!-- Search Criteria Summary -->
                    <div id="search-criteria-summary" class="search-criteria-summary" style="background: #f8faff; border: 1px solid #e3f2fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <h6 style="margin: 0; color: var(--text); font-weight: 600;">Search Criteria</h6>
                            <button type="button" class="btn btn-sm btn-outline" id="adjust-filters-btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 6px;">
                                <i class="fas fa-edit" style="margin-right: 0.3rem;"></i>Adjust Filters
                            </button>
                        </div>
                        <div id="criteria-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                            <!-- Criteria details will be populated here -->
                        </div>
                    </div>
                    
                    <div id="vendor-loading" style="display: none; text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>Finding matching vendors for each service...</p>
                    </div>
                    
                    <!-- Main Layout: Vendor Cards LEFT, Map RIGHT -->
                    <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                        <!-- LEFT: Vendor Cards -->
                        <div style="flex: 1; min-width: 0;">
                            <div id="vendor-cards-container" style="overflow: visible;">
                                <div class="vendor-cards-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h5 style="margin: 0; color: var(--text);">Vendor Options</h5>
                                    <div class="vendor-filters">
                                        <select id="vendor-sort" class="form-control" style="width: auto; display: inline-block;">
                                            <option value="distance">Sort by Distance</option>
                                            <option value="price">Sort by Price</option>
                                            <option value="rating">Sort by Rating</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="vendor-horizontal-cards" class="vendor-horizontal-container" style="overflow-y: auto; box-sizing: border-box;">
                                    <!-- Horizontal vendor cards will be populated here -->
                                    <div style="padding: 1rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd; text-align: center;">
                                        <i class="fas fa-search" style="font-size: 2rem; color: #ccc; margin-bottom: 0.5rem;"></i>
                                        <p style="color: #666; margin: 0;">Search for vendors to see options here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT: Google Maps Container -->
                        <div style="flex: 1; min-width: 0;">
                            <div id="vendor-map-container" style="display: block;">
                                <div class="map-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h5 style="margin: 0; color: var(--text);">Vendors Near Your Event Location</h5>
                                </div>
                                <div style="position: relative;">
                                    <div id="vendor-map" style="height: 600px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                                    <!-- Floating map controls positioned on top of the map -->
                                    <div class="map-controls-overlay" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000;">
                                        <button type="button" class="btn btn-sm" id="focus-event-location" 
                                                style="background: white; border: 1px solid #ddd; color: #333; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-crosshairs"></i> Focus Event
                                        </button>
                                        <button type="button" class="btn btn-sm" id="show-all-vendors"
                                                style="background: white; border: 1px solid #ddd; color: #333; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-expand"></i> Show All
                                        </button>
                                    </div>
                                </div>
                                <div class="map-legend" style="display: flex; gap: 1rem; margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                    <div><i class="fas fa-map-marker-alt" style="color: #e74c3c;"></i> Event Location</div>
                                    <div><i class="fas fa-store" style="color: #3498db;"></i> Available Vendors</div>
                                    <div><i class="fas fa-check-circle" style="color: #27ae60;"></i> Selected Vendors</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="vendor-results" class="vendor-sections-container" style="display: none;">
                        <!-- Legacy vendor sections will be populated here -->
                    </div>
                    
                    <div id="no-vendors-found" style="display: none; text-align: center; padding: 2rem;">
                        <h5>No vendors found</h5>
                        <p style="color: var(--text-light);">Try adjusting your budget or service requirements.</p>
                        <button type="button" class="btn btn-outline" id="adjust-criteria-btn">Adjust Criteria</button>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-2">Back: Event Details</button>
                        <button type="button" class="btn btn-primary" id="send-requests-btn" disabled>Send Requests</button>
                    </div>
                </div>

                <!-- Step 4: Request Submission -->
                <div class="booking-step" id="booking-step-4" style="display: none;">
                    <h4 class="form-section-title">Booking Requests</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Review your selected vendors and their services before sending requests.</p>
                    
                    <div class="selected-vendors-summary" id="selected-vendors-summary">
                        <!-- Selected vendors summary will be populated here -->
                    </div>
                    
                    <div class="request-summary" id="request-summary" style="display: none;">
                        <!-- Request summary will be populated here -->
                    </div>
                    
                    <div style="display: flex; justify-content: flex-start; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-3">Back: Vendors</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Duplicate Google Maps API script removed - using the one in head -->

    <!-- Facebook SDK -->
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId: 'YOUR_FACEBOOK_APP_ID',
          cookie: true,
          xfbml: true,
          version: 'v18.0'
        });
      };
    </script>
    <script async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

    <!-- Main Application Script -->
    <script>
        // API base URL (global constant)
        const API_BASE_URL = 'https://bdb-3-0-venuevue-api.onrender.com/api';
        
        // Global variables
        let currentUser = null;
        
        // Ensure Step 3 vendor list matches the map height exactly
        function syncVendorPanelHeight() {
            const map = document.getElementById('vendor-map');
            const panel = document.getElementById('vendor-cards-container');
            const list = document.getElementById('vendor-horizontal-cards');
            if (!map || !panel || !list) return;
            const mapH = Math.round(map.getBoundingClientRect().height);
            if (mapH <= 0) return;
            const EXTRA_PX = 36; // make the list a tad bit longer than the map
            const header = panel.querySelector('.vendor-cards-header');
            let headerH = 0;
            if (header) {
                const cs = getComputedStyle(header);
                headerH = Math.round(header.getBoundingClientRect().height + parseFloat(cs.marginBottom || '0'));
            }
            // subtract panel vertical padding to ensure total matches map height
            const pcs = getComputedStyle(panel);
            const panelVPad = (parseFloat(pcs.paddingTop || '0') + parseFloat(pcs.paddingBottom || '0')) || 0;
            // include list borders when using border-box
            const lcs = getComputedStyle(list);
            const listBorders = (parseFloat(lcs.borderTopWidth || '0') + parseFloat(lcs.borderBottomWidth || '0')) || 0;
            const listH = Math.max(0, mapH - headerH - panelVPad - listBorders + EXTRA_PX);
            const hpx = listH + 'px';
            // lock panel to map height to avoid overflow rounding mismatches
            panel.style.height = (mapH + EXTRA_PX) + 'px';
            list.style.height = hpx;
            list.style.maxHeight = hpx;
            list.style.minHeight = hpx;
        }
        window.addEventListener('load', () => {
            syncVendorPanelHeight();
            // Retry a few times to catch late map initialization
            [100, 300, 800].forEach(t => setTimeout(syncVendorPanelHeight, t));
            // Observe map size changes if supported
            const mapEl = document.getElementById('vendor-map');
            if (window.ResizeObserver && mapEl) {
                const ro = new ResizeObserver(() => syncVendorPanelHeight());
                ro.observe(mapEl);
            }
        });
        window.addEventListener('resize', () => setTimeout(syncVendorPanelHeight, 50));
        // Recalculate when Step 3 visibility changes
        (function observeStep3Visibility(){
            const step3 = document.getElementById('booking-step-3');
            if (!step3) return;
            const isVisible = (el) => {
                const style = getComputedStyle(el);
                return style.display !== 'none' && style.visibility !== 'hidden';
            };
            const mo = new MutationObserver(() => {
                if (isVisible(step3)) setTimeout(syncVendorPanelHeight, 0);
            });
            mo.observe(step3, { attributes: true, attributeFilter: ['style','class'] });
        })();
        
        // Check for existing user session


        // Create a test user session for development
        function createTestUser() {
            // Don't set a test token to avoid auth errors
            // localStorage.setItem('token', 'test-token');
            
            // Create test user without token
            simulateLogin({
                id: 1,
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'T',
                isVendor: false
            });
            
            console.log('✅ Created test user for development (no token)');
        }
        
        // Global utility functions
        function showSuccess(message) {
            // Create or update success notification
            let notification = document.getElementById('global-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'global-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-weight: 500;
                `;
                document.body.appendChild(notification);
            }
            notification.textContent = message;
            notification.style.background = '#10b981';
            notification.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showGlobalError(message) {
            // Create or update error notification
            let notification = document.getElementById('global-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'global-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ef4444;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-weight: 500;
                `;
                document.body.appendChild(notification);
            }
            notification.textContent = message;
            notification.style.background = '#ef4444';
            notification.style.display = 'block';
            
            // Auto-hide after 5 seconds for errors
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Helper function to get vendor profile ID
        async function getVendorProfileId() {
            if (currentUser?.vendorProfileId) {
                return currentUser.vendorProfileId;
            }
            
            if (!currentUser?.id) {
                throw new Error('User not logged in');
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch vendor status');
                
                const data = await response.json();
                if (data.isVendor && data.vendorProfileId) {
                    // Cache it for future use
                    currentUser.vendorProfileId = data.vendorProfileId;
                    return data.vendorProfileId;
                } else {
                    throw new Error('Vendor profile not found');
                }
            } catch (error) {
                throw new Error(`Failed to get vendor profile: ${error.message}`);
            }
        }
        
        // Global functions for vendor request handling (accessible to onclick handlers)
        async function approveRequest(requestId) {
            try {
                const vendorProfileId = await getVendorProfileId();
                
                const response = await fetch(`${API_BASE_URL}/bookings/requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        vendorProfileId: vendorProfileId,
                        responseMessage: 'Request approved! Looking forward to working with you.',
                        proposedPrice: null
                    })
                });
                
                if (!response.ok) throw new Error('Failed to approve request');
                
                const approvalData = await response.json();
                
                // Get the actual userId from the approval data or request
                const actualUserId = approvalData.userId || approvalData.UserID;
                
                if (!actualUserId) {
                    console.warn('No userId found in approval response, using fallback methods');
                    // Use fallback methods immediately
                    createLocalNotification(currentUser.id, 'booking_approved', 'Booking Request Approved!', 'Your booking request has been approved by the vendor. You can now proceed with payment.');
                    createLocalConversation(requestId, currentUser.id, vendorProfileId);
                } else {
                    // Create notification for user about approval
                    await createNotification({
                        userId: actualUserId,
                        type: 'booking_approved',
                        title: 'Booking Request Approved!',
                        message: `Your booking request has been approved by the vendor. You can now proceed with payment.`,
                        relatedId: requestId
                    });
                    
                    // Create chat conversation between user and vendor
                    await initiateChatAfterApproval(requestId, actualUserId, vendorProfileId);
                    
                    // Create confirmed booking entry
                    await createConfirmedBooking(requestId, approvalData);
                }
                
                showSuccess('Request approved successfully! Chat initiated with customer.');
                
                // Refresh the vendor requests list without page reload
                if (typeof loadVendorRequests === 'function') {
                    await loadVendorRequests();
                }
                
                // Update notifications
                if (typeof loadNotifications === 'function') {
                    await loadNotifications();
                }
                
            } catch (error) {
                console.error('Error approving request:', error);
                showGlobalError(`Failed to approve request: ${error.message}`);
            }
        }
        
        // Helper function to create notifications
        async function createNotification(notificationData) {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(notificationData)
                });
                
                if (response.ok) {
                    console.log('Notification created successfully via API');
                    return;
                }
                
                // Fallback: Create notification locally
                console.log('API failed, creating local notification');
                createLocalNotification(notificationData.userId, notificationData.type, notificationData.title, notificationData.message);
                
            } catch (error) {
                console.warn('Error creating notification, using fallback:', error);
                createLocalNotification(notificationData.userId, notificationData.type, notificationData.title, notificationData.message);
            }
        }
        
        // Fallback function to create notifications locally
        function createLocalNotification(userId, type, title, message) {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            const newNotification = {
                id: `notif_${Date.now()}`,
                userId: userId,
                type: type,
                title: title,
                message: message,
                read: false,
                createdAt: new Date().toISOString()
            };
            
            notifications.push(newNotification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update notification badges
            updateNotificationBadges();
            
            // Show toast notification if it's for current user
            if (currentUser && (userId === currentUser.id || userId === currentUser.vendorProfileId)) {
                showNotificationToast(title, message);
            }
            
            console.log('Local notification created successfully');
        }
        
        // Update notification badges
        function updateNotificationBadges() {
            if (!currentUser) return;
            
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const unreadCount = notifications.filter(n => 
                (n.userId === currentUser.id || n.userId === currentUser.vendorProfileId) && !n.read
            ).length;
            
            document.querySelectorAll('[id$="-notifications-badge"]').forEach(badge => {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'block' : 'none';
            });
        }
        
        // Show toast notification
        function showNotificationToast(title, message) {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 1rem;
                box-shadow: var(--shadow);
                z-index: 10001;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;">${title}</div>
                <div style="font-size: 0.9rem; color: var(--text-light);">${message}</div>
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 5px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Helper function to initiate chat after approval
        async function initiateChatAfterApproval(requestId, userId, vendorProfileId) {
            try {
                // Use the correct API endpoint from messages.js
                const response = await fetch(`${API_BASE_URL}/messages/conversation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        vendorProfileId: vendorProfileId,
                        requestId: requestId,
                        initialMessage: 'Hello! Your booking request has been approved. Feel free to ask any questions about your upcoming event.'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Chat initiated successfully via API:', result);
                    
                    // Refresh conversations in UI
                    if (typeof loadConversations === 'function') {
                        setTimeout(() => {
                            loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                            loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                        }, 1000);
                    }
                    return;
                }
                
                // Fallback: Create conversation in localStorage
                console.log('API failed, creating local conversation');
                createLocalConversation(requestId, userId, vendorProfileId);
                
            } catch (error) {
                console.warn('Error initiating chat, using fallback:', error);
                createLocalConversation(requestId, userId, vendorProfileId);
            }
        }
        
        // Fallback function to create conversation locally
        function createLocalConversation(requestId, userId, vendorProfileId) {
            const conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            
            // Get vendor and user names for display
            const vendorName = currentUser?.isVendor ? 'Client' : 'Vendor';
            const userName = currentUser?.name || 'User';
            
            const newConversation = {
                id: `conv_${Date.now()}`,
                requestId: requestId,
                userId: userId,
                vendorProfileId: vendorProfileId,
                userName: userName,
                vendorName: vendorName,
                createdAt: new Date().toISOString(),
                messages: [{
                    id: `msg_${Date.now()}`,
                    senderId: 'system',
                    content: 'Your booking request has been approved! You can now chat with your vendor.',
                    timestamp: new Date().toISOString()
                }],
                lastMessage: 'Your booking request has been approved!',
                timestamp: new Date().toISOString(),
                unreadCount: 1
            };
            
            conversations.push(newConversation);
            localStorage.setItem('conversations', JSON.stringify(conversations));
            
            console.log('Local conversation created successfully:', newConversation);
            
            // Create notification for both parties
            createLocalNotification(userId, 'chat_initiated', 'New Chat Started', 'You can now chat with your vendor about your approved booking.');
            createLocalNotification(vendorProfileId, 'chat_initiated', 'New Chat Started', 'A new chat has been started with your client.');
            
            // Immediately refresh conversations in UI
            setTimeout(() => {
                if (typeof loadConversations === 'function') {
                    loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                    loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                }
            }, 500);
        }
        
        // Helper function to create confirmed booking
        async function createConfirmedBooking(requestId, approvalData) {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/confirmed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        requestId: requestId,
                        status: 'confirmed',
                        approvedAt: new Date().toISOString(),
                        userId: approvalData.userId,
                        vendorProfileId: approvalData.vendorProfileId,
                        ...approvalData
                    })
                });
                
                if (response.ok) {
                    console.log('Confirmed booking created successfully via API');
                    return;
                }
                
                console.warn('Failed to create confirmed booking:', await response.text());
            } catch (error) {
                console.warn('Error creating confirmed booking:', error);
            }
        }
        
        // Payment initiation function
        async function initiatePayment(bookingId, amount) {
            try {
                // Create payment intent
                const response = await fetch(`${API_BASE_URL}/payments/create-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        bookingId: bookingId,
                        amount: amount * 100, // Convert to cents
                        currency: 'usd'
                    })
                });
                
                if (!response.ok) throw new Error('Failed to create payment intent');
                
                const { clientSecret } = await response.json();
                
                // Open payment modal or redirect to payment page
                openPaymentModal(bookingId, clientSecret, amount);
                
            } catch (error) {
                console.error('Error initiating payment:', error);
                showGlobalError(`Failed to initiate payment: ${error.message}`);
            }
        }
        
        // Open payment modal
        function openPaymentModal(bookingId, clientSecret, amount) {
            // Create payment modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Complete Payment</h3>
                        <button class="modal-close" onclick="closePaymentModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="payment-summary">
                            <h4>Payment Summary</h4>
                            <div class="payment-amount">Total: $${amount.toFixed(2)}</div>
                        </div>
                        <div id="payment-element" style="margin: 20px 0;"></div>
                        <button id="submit-payment" class="btn btn-primary" style="width: 100%;">Pay Now</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize Stripe Elements if available
            if (window.Stripe) {
                const stripe = Stripe('pk_test_your_publishable_key'); // Replace with actual key
                const elements = stripe.elements({ clientSecret });
                const paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');
                
                document.getElementById('submit-payment').addEventListener('click', async () => {
                    const { error } = await stripe.confirmPayment({
                        elements,
                        confirmParams: {
                            return_url: window.location.href
                        }
                    });
                    
                    if (error) {
                        showGlobalError(`Payment failed: ${error.message}`);
                    } else {
                        // Payment successful
                        await updateBookingPaymentStatus(bookingId, 'paid');
                        showSuccess('Payment completed successfully!');
                        closePaymentModal();
                        
                        // Refresh bookings
                        if (typeof loadAllUserBookings === 'function') {
                            await loadAllUserBookings();
                        }
                    }
                });
            } else {
                // Fallback for demo purposes
                document.getElementById('submit-payment').addEventListener('click', async () => {
                    await updateBookingPaymentStatus(bookingId, 'paid');
                    showSuccess('Payment completed successfully!');
                    closePaymentModal();
                    
                    // Refresh bookings
                    if (typeof loadAllUserBookings === 'function') {
                        await loadAllUserBookings();
                    }
                });
            }
        }
        
        // Close payment modal
        function closePaymentModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        // Update booking payment status
        async function updateBookingPaymentStatus(bookingId, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/${bookingId}/payment-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ paymentStatus: status })
                });
                
                if (!response.ok) throw new Error('Failed to update payment status');
                
                // Create notification for vendor about payment
                const bookingData = await response.json();
                await createNotification({
                    userId: bookingData.vendorUserId,
                    type: 'payment_received',
                    title: 'Payment Received',
                    message: `Payment has been received for booking #${bookingId}`,
                    relatedId: bookingId
                });
                
            } catch (error) {
                console.error('Error updating payment status:', error);
                throw error;
            }
        }
        
        // Open booking chat
        async function openBookingChat(bookingId) {
            try {
                // Get or create chat for this booking
                const response = await fetch(`${API_BASE_URL}/chats/booking/${bookingId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to get booking chat');
                
                const chatData = await response.json();
                
                // Switch to messages section and load this specific chat
                if (isVendorMode) {
                    displayVendorDashboard('vendor-messages');
                } else {
                    displayUserDashboard('client', 'messages');
                }
                
                // Load the specific chat conversation
                setTimeout(() => {
                    loadSpecificChat(chatData.chatId);
                }, 500);
                
            } catch (error) {
                console.error('Error opening booking chat:', error);
                showGlobalError(`Failed to open chat: ${error.message}`);
            }
        }
        
        // Load specific chat conversation
        async function loadSpecificChat(chatId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chats/${chatId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load chat messages');
                
                const messages = await response.json();
                
                // Display messages in chat interface
                const chatContainer = document.querySelector('.chat-messages');
                if (chatContainer) {
                    chatContainer.innerHTML = '';
                    messages.forEach(message => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;
                        messageEl.innerHTML = `
                            <div class="message-content">${message.content}</div>
                            <div class="message-time">${new Date(message.createdAt).toLocaleTimeString()}</div>
                        `;
                        chatContainer.appendChild(messageEl);
                    });
                    
                    // Scroll to bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
            } catch (error) {
                console.error('Error loading specific chat:', error);
            }
        }
        
        async function declineRequest(requestId) {
            const reason = prompt('Please provide a reason for declining (optional):');
            
            try {
                const vendorProfileId = await getVendorProfileId();
                
                const response = await fetch(`${API_BASE_URL}/bookings/requests/${requestId}/decline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        vendorProfileId: vendorProfileId,
                        responseMessage: reason || 'Request declined.'
                    })
                });
                
                if (!response.ok) throw new Error('Failed to decline request');
                
                const declineData = await response.json();
                
                // Create notification for user about decline
                const actualUserId = declineData.userId || declineData.UserID;
                if (actualUserId) {
                    await createNotification({
                        userId: actualUserId,
                        type: 'booking_declined',
                        title: 'Booking Request Declined',
                        message: `Your booking request has been declined. ${reason ? 'Reason: ' + reason : ''}`,
                        relatedId: requestId
                    });
                } else {
                    // Fallback notification
                    createLocalNotification(currentUser.id, 'booking_declined', 'Booking Request Declined', `Your booking request has been declined. ${reason ? 'Reason: ' + reason : ''}`);
                }
                
                showSuccess('Request declined.');
                
                // Refresh the vendor requests list without page reload
                if (typeof loadVendorRequests === 'function') {
                    await loadVendorRequests();
                }
                
                // Update notifications
                if (typeof loadNotifications === 'function') {
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error declining request:', error);
                showGlobalError(`Failed to decline request: ${error.message}`);
            }
        }

document.addEventListener('DOMContentLoaded', async function() {
            // API base URL
            const API_BASE_URL = 'https://bdb-3-0-venuevue-api.onrender.com/api';
            
            // Chat state manager - moved here to ensure it's initialized before state object
            const chatState = {
                messages: [],
                currentConversation: null,
                currentChatVendorId: null,

                init: function() {
                    this.messages = [];
                    this.currentConversation = null;
                    this.currentChatVendorId = null;
                    console.log('Chat state initialized.');
                },

                addMessage: function(message) {
                    if (!this.messages) this.messages = [];
                    const formattedMsg = this.formatMessage(message);
                    this.messages.push(formattedMsg);
                    console.log('Message added to chat state:', formattedMsg);
                    return formattedMsg;
                },

                setMessages: function(messages) {
                    this.messages = Array.isArray(messages) ? messages.map(msg => this.formatMessage(msg)) : [];
                    console.log('Chat messages set:', this.messages);
                },

                getMessages: function() {
                    return this.messages || [];
                },

                formatMessage: function(message) {
                    console.log('Formatting message:', message);
                    const content = message.Content || message.content || message.text || message.messageContent;
                    if (content === undefined) {
                        console.warn('Message content is undefined after formatting attempts for message:', message);
                    }
                    return {
                        id: message.MessageID || message.id || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        conversationId: message.ConversationID || message.conversationId || this.currentConversation,
                        senderId: message.SenderID || message.senderId,
                        senderName: message.SenderName || message.senderName || (message.SenderID === currentUser?.id ? currentUser.name : 'Vendor'),
                        content: content,
                        timestamp: message.CreatedAt || message.timestamp || new Date().toISOString(),
                        isCurrentUser: message.SenderID === currentUser?.id || message.isCurrentUser,
                        isRead: message.IsRead || message.isRead || false
                    };
                }
            };
            
            // Global state - moved here to ensure it's initialized before checkAuthStatus
            const state = {
                vendors: [],
                filteredVendors: [],
                markers: [],
                map: null,
                userLocation: null,
                currentPage: 1,
                vendorsPerPage: 12,
                currentView: 'list',
                currentCategory: 'all',
                favorites: [], // Initialize favorites array to prevent undefined error
                filters: {
                    location: '',
                    types: ['independent', 'company'],
                    price: 40,
                    popular: [],
                    startDate: null,
                    endDate: null,
                    region: ''
                },
                // New properties for dynamic map functionality
                originalSearchResults: [],
                isLoadingVendors: false,
                mapMoveTimeout: null,
                initialMapBounds: null,
                lastMapBounds: null,
                currentVendor: null,
                selectedServices: [],
                selectedDate: null,
                selectedTime: null,
                stripe: null,
                elements: null,
                paymentIntent: null,
                socket: null,
                chat: chatState
            };
            
            // Check for existing user session on page load
            await checkAuthStatus();
            
            // If no user is logged in, stay logged out (don't auto-create test user)
            // This ensures logout state persists on page refresh

            // Initialize variables
            const mainAppView = document.getElementById('app-container');
            const vendorProfilePage = document.getElementById('vendor-profile-page');
            const confirmationModal = document.getElementById('confirmation-modal');
            const locationPermissionModal = document.getElementById('location-permission');
            const vendorGrid = document.getElementById('vendor-grid');
            const appContainer = document.getElementById('app-container');
            const sidebarEl = document.querySelector('.sidebar');
            const mapVenueList = document.getElementById('map-venue-list');
            const resultsTitle = document.querySelector('.results-title');
            const resultsCount = document.querySelector('.results-count');
            const mapViewContainer = document.getElementById('map-view-container');
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const filtersToggleBtn = document.getElementById('filters-toggle');
            const wishlistBtn = document.getElementById('wishlist-btn');
            const notificationsBtn = document.getElementById('notifications-btn');
            const profileBtn = document.getElementById('profile-btn');
            const filterResetBtns = document.querySelectorAll('.filter-reset');

            // Sidebar collapse helpers
            function applySidebarState(collapsed) {
                if (!appContainer || !sidebarEl) return;
                appContainer.classList.toggle('sidebar-collapsed', collapsed);
                sidebarEl.classList.toggle('collapsed', collapsed);
                try { localStorage.setItem('filtersCollapsed', collapsed ? '1' : '0'); } catch (e) {}
            }
            const trendingTags = document.querySelectorAll('.trending-tag');
            const pagination = document.getElementById('pagination');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const locateMeBtn = document.getElementById('locate-me');
            const allowLocationBtn = document.getElementById('allow-location');
            const denyLocationBtn = document.getElementById('deny-location');
            const currentLocationCheckbox = document.getElementById('current-location');
            const locationLoading = document.getElementById('location-loading');
            const locationInput = document.getElementById('location-input');
            const categoryItems = document.querySelectorAll('.category-item');
            const advancedToggle = document.getElementById('advanced-toggle');
            const advancedContent = document.getElementById('advanced-content');
            const categoriesListInner = document.getElementById('categories-list');
            const categoriesListWrapper = document.querySelector('.categories-list-wrapper');
            const scrollLeftBtn = document.getElementById('scroll-left');
            const scrollRightBtn = document.getElementById('scroll-right');

            // Profile modal elements
            const profileModal = document.getElementById('profile-modal');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loggedInView = document.getElementById('logged-in-view');
            const showSignup = document.getElementById('show-signup');
            const showLogin = document.getElementById('show-login');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const googleLoginBtn = document.getElementById('google-login');
            const facebookLoginBtn = document.getElementById('facebook-login');
            const viewDashboardBtn = document.getElementById('view-dashboard-btn');
            const accountTypeSelect = document.getElementById('account-type');

            // Dashboard elements
            const clientDashboardContainer = document.getElementById('dashboard-container');
            const vendorDashboardContainer = document.getElementById('vendor-dashboard-container');
            const clientDashboardMenuItems = clientDashboardContainer.querySelectorAll('.dashboard-menu a');
            const vendorDashboardMenuItems = vendorDashboardContainer.querySelectorAll('.dashboard-menu a');
            const switchToVendorBtn = document.getElementById('switch-to-vendor');
            const switchToClientBtn = document.getElementById('switch-to-client');
            const logoutDashboardBtn = document.getElementById('logout-dashboard');
            const vendorLogoutBtn = document.getElementById('vendor-logout');
            
            // Chat modal elements
            const chatModal = document.getElementById('chat-modal');
            const chatVendorName = document.getElementById('chat-vendor-name');
            const profileChatInput = document.getElementById('profile-chat-input');
            const profileSendBtn = document.getElementById('profile-send-btn');
            const profileChatMessages = document.getElementById('profile-chat-messages');

            // Vendor registration elements
            const vendorRegistrationModal = document.getElementById('vendor-registration-modal');
            const regStatusMessage = document.getElementById('reg-status-message');

            // Comprehensive Vendor Setup Wizard State (consolidated)
            if (typeof vendorSetupState === 'undefined') {
                var vendorSetupState = {
                    currentStep: 1,
                    vendorId: null,
                    vendorProfileId: null,
                    stepData: {
                        step1: {}, // Business Basics
                        step2: {}, // Location Information
                        step3: {}, // Gallery & Media
                        step4: {}, // Services & Packages
                        step5: {}, // Team Information
                        step6: {}, // Social Media & Links
                        step7: {}, // Additional Details (Category-specific questions)
                        step8: {}, // FAQ Section
                        step9: {}, // Summary
                        step10: {} // Policies & Preferences
                    },
                    gallery: [],
                    portfolio: [],
                    packages: [],
                    services: [],
                    teamMembers: [],
                    faqs: [],
                    additionalDetailsAnswers: {},
                    selectedPredefinedServices: [],
                    selectedCities: []
                };
            }

            // Initialize Vendor Setup
            function initializeVendorSetup(vendorId) {
                vendorSetupState.vendorId = vendorId;
                vendorSetupState.currentStep = 1;
                
                // Reset all data
                Object.keys(vendorSetupState.stepData).forEach(key => {
                    vendorSetupState.stepData[key] = {};
                });
                vendorSetupState.gallery = [];
                vendorSetupState.portfolio = [];
                vendorSetupState.packages = [];
                vendorSetupState.services = [];
                vendorSetupState.teamMembers = [];
                vendorSetupState.faqs = [];
                vendorSetupState.additionalDetailsAnswers = {};
                vendorSetupState.selectedPredefinedServices = [];
                vendorSetupState.selectedCities = [];
                
                // Show the setup modal
                vendorRegistrationModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Setup event listeners
                setupVendorSetupEventListeners();
                
                // Show first step
                showSetupStep(1);
            }

            // Setup Event Listeners for All Steps
            function setupVendorSetupEventListeners() {
                // Navigation buttons - Forward
                document.getElementById('next-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('next-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('next-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('next-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('next-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('next-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('next-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('next-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                document.getElementById('next-to-step-10')?.addEventListener('click', () => goToSetupStep(10));
                
                // Navigation buttons - Backward
                document.getElementById('back-to-step-1')?.addEventListener('click', () => goToSetupStep(1));
                document.getElementById('back-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('back-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('back-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('back-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('back-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('back-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('back-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('back-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                
                // Step 3: Gallery & Media functionality
                document.getElementById('featured-image')?.addEventListener('change', handleFeaturedImageUpload);
                document.getElementById('gallery-images')?.addEventListener('change', handleGalleryUpload);
                document.getElementById('add-portfolio-btn')?.addEventListener('click', showPortfolioForm);
                document.getElementById('add-portfolio-item-btn')?.addEventListener('click', addPortfolioItem);
                
                // Step 4: Services & Packages functionality
                document.getElementById('add-service-category-btn')?.addEventListener('click', showServiceCategoryForm);
                document.getElementById('add-category-item-btn')?.addEventListener('click', addServiceCategory);
                document.getElementById('add-service-btn')?.addEventListener('click', showServiceForm);
                document.getElementById('add-service-item-btn')?.addEventListener('click', addServiceItem);
                document.getElementById('add-package-btn')?.addEventListener('click', showPackageForm);
                document.getElementById('add-package-item-btn')?.addEventListener('click', addPackageItem);
                
                // Step 5: Team functionality
                document.getElementById('add-team-member-btn')?.addEventListener('click', showTeamMemberForm);
                document.getElementById('add-team-item-btn')?.addEventListener('click', addTeamMember);
                
                // Step 8: FAQ functionality
                document.getElementById('add-faq-btn')?.addEventListener('click', showFaqForm);
                document.getElementById('add-faq-item-btn')?.addEventListener('click', addFaqItem);
                
                // Complete setup
                document.getElementById('complete-setup-btn')?.addEventListener('click', completeVendorSetup);
            }

            // Navigation Functions
            async function goToSetupStep(step) {
                // Validate current step before proceeding
                if (!validateCurrentStep()) {
                    return;
                }
                
                // Save current step data
                saveCurrentStepData();
                
                // Submit current step data to backend
                try {
                    await submitCurrentStepToBackend();
                } catch (error) {
                    console.error('Failed to save step data:', error);
                    alert('Failed to save step data. Please try again.');
                    return;
                }
                
                // Load category-specific questions when entering step 4
                if (step === 4) {
                    await loadCategoryQuestions();
                }
                
                // Load summary when entering step 9
                if (step === 9) {
                    await loadVendorSummary();
                }
                
                // Update step
                vendorSetupState.currentStep = step;
                showSetupStep(step);
            }

            // Load category-specific questions based on primary category
            async function loadCategoryQuestions() {
                const primaryCategory = document.getElementById('primary-category')?.value;
                if (!primaryCategory) {
                    console.warn('No primary category selected');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/category-questions/${primaryCategory}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load category questions');
                    }

                    const data = await response.json();
                    renderCategoryQuestions(data.questions || []);

                } catch (error) {
                    console.error('Error loading category questions:', error);
                    document.getElementById('category-questions-container').innerHTML = 
                        '<p style="color: var(--accent);">Failed to load questions. Please try again.</p>';
                }
            }

            // Geolocation: try to detect user location and update filters
            async function tryInitGeolocation() {
                if (!('geolocation' in navigator)) return;
                if (state.userLocationInitialized) return;
                state.userLocationInitialized = true;
                // Respect stored permission: skip calling geolocation if denied
                const stored = getStoredGeoPermission();
                if (stored === 'denied') {
                    console.log('Geolocation previously denied; skipping auto request.');
                    return;
                }
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    setStoredGeoPermission('granted');
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    state.userCoords = { lat, lon };
                    try {
                        const label = await reverseGeocodeOSM(lat, lon);
                        state.userLocationLabel = label;
                        // If user hasn't manually set a location filter, use detected city/region
                        if (!state.filters || !state.filters.location) {
                            state.filters = state.filters || {};
                            state.filters.location = label;
                            filterVendors();
                            updateMetadata({});
                        }
                    } catch (e) {
                        console.warn('Reverse geocode failed:', e);
                    }
                }, (err) => {
                    console.warn('Geolocation blocked/unavailable:', err?.message || err);
                    if (err && err.code === err.PERMISSION_DENIED) setStoredGeoPermission('denied');
                }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 });
            }

            // Reverse geocode using OpenStreetMap Nominatim (no API key)
            async function reverseGeocodeOSM(lat, lon) {
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
                const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
                if (!res.ok) throw new Error(`OSM reverse geocode failed: ${res.status}`);
                const data = await res.json();
                const city = data.address?.city || data.address?.town || data.address?.village || data.address?.hamlet || '';
                const state = data.address?.state || data.address?.region || data.address?.county || '';
                const label = [city, state].filter(Boolean).join(', ');
                return label || (data.display_name?.split(',').slice(0,2).join(', ') || 'your area');
            }

            // Render category-specific questions
            function renderCategoryQuestions(questions) {
                const container = document.getElementById('category-questions-container');
                if (!container) return;

                if (questions.length === 0) {
                    container.innerHTML = '<p>No additional questions for this category.</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 1rem;">';
                
                questions.forEach((question, index) => {
                    html += `
                        <div class="form-group" style="padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                ${question.QuestionText}
                                ${question.IsRequired ? '<span style="color: var(--accent);">*</span>' : ''}
                            </label>
                    `;

                    if (question.QuestionType === 'YesNo') {
                        html += `
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="Yes" ${question.IsRequired ? 'required' : ''}>
                                    Yes
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="No" ${question.IsRequired ? 'required' : ''}>
                                    No
                                </label>
                            </div>
                        `;
                    } else if (question.QuestionType === 'Text') {
                        html += `
                            <textarea name="question_${question.QuestionID}" rows="3" 
                                     style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                     ${question.IsRequired ? 'required' : ''}></textarea>
                        `;
                    } else if (question.QuestionType === 'Number') {
                        html += `
                            <input type="number" name="question_${question.QuestionID}" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                   ${question.IsRequired ? 'required' : ''}>
                        `;
                    }

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            }

            // Load and display vendor summary
            async function loadVendorSummary() {
                const container = document.getElementById('setup-summary-content');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/summary/${vendorSetupState.vendorProfileId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load vendor summary');
                    }

                    const data = await response.json();
                    renderVendorSummary(data);

                } catch (error) {
                    console.error('Error loading vendor summary:', error);
                    container.innerHTML = '<p style="color: var(--accent);">Failed to load summary. Please try again.</p>';
                }
            }

            // Render comprehensive vendor summary
            function renderVendorSummary(summaryData) {
                const container = document.getElementById('setup-summary-content');
                if (!container || !summaryData.success) return;

                const data = summaryData.data;
                let html = '<div style="display: grid; gap: 1.5rem;">';

                // Business Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                📋 Business Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Business Name:</strong> ${info.BusinessName || 'Not provided'}</div>
                                <div><strong>Display Name:</strong> ${info.DisplayName || 'Not provided'}</div>
                                <div><strong>Email:</strong> ${info.BusinessEmail || 'Not provided'}</div>
                                <div><strong>Phone:</strong> ${info.BusinessPhone || 'Not provided'}</div>
                                <div><strong>Website:</strong> ${info.Website || 'Not provided'}</div>
                                <div><strong>Years in Business:</strong> ${info.YearsInBusiness || 'Not provided'}</div>
                            </div>
                            ${info.BusinessDescription ? `<div style="margin-top: 1rem;"><strong>Description:</strong><br>${info.BusinessDescription}</div>` : ''}
                            ${info.Tagline ? `<div style="margin-top: 0.5rem;"><strong>Tagline:</strong> ${info.Tagline}</div>` : ''}
                        </div>
                    `;
                }

                // Location Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Address:</strong> ${info.Address || 'Not provided'}</div>
                                <div><strong>City:</strong> ${info.City || 'Not provided'}</div>
                                <div><strong>State:</strong> ${info.State || 'Not provided'}</div>
                                <div><strong>Country:</strong> ${info.Country || 'Not provided'}</div>
                                <div><strong>Postal Code:</strong> ${info.PostalCode || 'Not provided'}</div>
                            </div>
                            ${info.AdditionalCitiesServed ? `<div style="margin-top: 1rem;"><strong>Additional Cities/Regions Served:</strong><br>${info.AdditionalCitiesServed}</div>` : ''}
                        </div>
                    `;
                }

                // Categories
                if (data.categories && data.categories.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-tags" style="margin-right: 0.5rem;"></i>Categories
                            </h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.categories.map(cat => `<span style="background-color: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">${cat.Category}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Gallery
                if (data.imageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-images" style="margin-right: 0.5rem;"></i>Gallery
                            </h5>
                            <div><strong>Images Uploaded:</strong> ${data.imageCount} images</div>
                            ${data.basicInfo?.FeaturedImageURL ? '<div style="margin-top: 0.5rem;"><strong>Featured Image:</strong> <i class="fas fa-check" style="color: #28a745;"></i> Set</div>' : ''}
                        </div>
                    `;
                }

                // Services & Packages
                if (data.serviceCount > 0 || data.packageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Services & Packages
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>Services:</strong> ${data.serviceCount || 0} services</div>
                                <div><strong>Packages:</strong> ${data.packageCount || 0} packages</div>
                            </div>
                        </div>
                    `;
                }

                // Social Media
                if (data.socialMedia && data.socialMedia.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🌐 Social Media
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.socialMedia.map(social => `<div><strong>${social.Platform}:</strong> ${social.URL}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Business Hours
                if (data.businessHours && data.businessHours.length > 0) {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🕒 Business Hours
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.businessHours.map(hours => `
                                    <div><strong>${days[hours.DayOfWeek]}:</strong> 
                                    ${hours.IsAvailable ? `${hours.OpenTime} - ${hours.CloseTime}` : 'Closed'}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Additional Details (Category-specific questions)
                if (data.additionalDetails && data.additionalDetails.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Additional Details
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.additionalDetails.map(detail => `<div><strong>${detail.QuestionText}:</strong> ${detail.Answer}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // FAQs
                if (data.faqs && data.faqs.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Frequently Asked Questions
                            </h5>
                            <div style="display: grid; gap: 1rem;">
                                ${data.faqs.map(faq => `
                                    <div style="padding: 1rem; background-color: white; border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Q: ${faq.Question}</div>
                                        <div>A: ${faq.Answer}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            }


            // Chat state manager moved to top of DOMContentLoaded to fix initialization order


            // Global state moved to top of DOMContentLoaded to fix initialization order

            // User state (now global)
            // let currentUser = null; // Moved to global scope

            // State variables for dashboard mode and active section, persisted in localStorage
            let isVendorMode = localStorage.getItem('isVendorMode') === 'true';
            let activeDashboardSection = localStorage.getItem('activeDashboardSection') || 'dashboard';

            // Lightbox state
            let lightboxImages = [];
            // openBookingModal function removed - duplicate function, keeping the complete version below

            // Multi-Step Booking Modal State (Global)
            window.bookingState = {
                currentStep: 1,
                selectedServices: [],
                selectedPredefinedServices: [], // New: stores selected predefined services with individual budgets
                availablePredefinedServices: {}, // New: stores predefined services by category
                eventDetails: {},
                budget: 2000,
                availableVendors: [],
                selectedVendors: [],
                sentRequests: [],
                approvedVendors: [],
                totalCost: 0,
                paymentIntent: null,
                countdownTimers: {},
                // Dynamic map properties
                originalVendorSections: [],
                isLoadingVendors: false,
                lastMapBounds: null,
                initialMapBounds: null,
                
                reset: function() {
                    this.currentStep = 1;
                    this.selectedServices = [];
                    this.selectedPredefinedServices = [];
                    this.availablePredefinedServices = {};
                    this.eventDetails = {};
                    this.budget = 2000;
                    this.availableVendors = [];
                    this.selectedVendors = [];
                    this.sentRequests = [];
                    this.approvedVendors = [];
                    this.totalCost = 0;
                    this.paymentIntent = null;
                    this.countdownTimers = {};
                    // Reset dynamic map properties
                    this.originalVendorSections = [];
                    this.isLoadingVendors = false;
                    this.lastMapBounds = null;
                    this.initialMapBounds = null;
                }
            };

            // Inject skeleton styles once for vendor cards
            (function ensureVendorSkeletonStyles() {
                if (document.getElementById('vendor-skeleton-styles')) return;
                const style = document.createElement('style');
                style.id = 'vendor-skeleton-styles';
                style.textContent = `
                    /* Vendor card skeletons */
                    .vendor-grid.skeleton-active {
                        /* mirror main vendor-grid columns and spacing */
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(clamp(260px, 28vw, 380px), 1fr));
                        gap: 1.5rem;
                        align-items: stretch;
                    }
                    @media (max-width: 640px) {
                        .vendor-grid.skeleton-active {
                            grid-template-columns: 1fr;
                            gap: 1rem;
                        }
                    }
                    .skeleton-card {
                        display: flex;
                        flex-direction: column;
                        background: #fff;
                        border: 1px solid rgba(0, 0, 0, 0.04);
                        border-radius: 16px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                        overflow: hidden;
                    }
                    .skeleton-thumb {
                        width: 100%;
                        aspect-ratio: 4 / 3; /* match .vendor-image */
                        background: var(--skeleton-base, #f0f2f5);
                        position: relative;
                        overflow: hidden;
                    }
                    .skeleton-content {
                        display: grid;
                        gap: 10px;
                        padding: 12px 14px 14px;
                        align-content: start;
                    }
                    .skeleton-line { height: 12px; border-radius: 6px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-line.sm { height: 10px; width: 55%; }
                    .skeleton-line.md { height: 12px; width: 75%; }
                    .skeleton-line.lg { height: 14px; width: 40%; }
                    .skeleton-pill { height: 40px; width: 160px; border-radius: 12px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-featurebar {
                        margin: 6px 0 6px;
                        height: 44px;
                        border-radius: 8px;
                        background: #f8f9fa;
                        position: relative;
                        overflow: hidden;
                    }
                    .skeleton-featurebar::before {
                        content: "";
                        position: absolute;
                        left: 0;
                        top: 0;
                        bottom: 0;
                        width: 3px;
                        background: #3498db;
                        opacity: .9;
                    }
                    .skeleton-button-row {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                        margin-top: 8px;
                    }
                    .skeleton-btn {
                        height: 40px;
                        border-radius: 12px;
                        background: var(--skeleton-base, #f0f2f5);
                        position: relative;
                        overflow: hidden;
                    }
                    /* Shimmer */
                    .skeleton-thumb::after, .skeleton-line::after, .skeleton-pill::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.6) 50%, rgba(255,255,255,0) 100%); transform: translateX(-100%); animation: vv-shimmer 1.2s infinite; }
                    @keyframes vv-shimmer { 100% { transform: translateX(100%); } }
                `;
                document.head.appendChild(style);
            })();

            // Show skeletons in the vendor grid while loading
            function showVendorSkeletons(count = 8) {
                const grid = document.getElementById('vendor-grid');
                if (!grid) return;
                grid.classList.add('skeleton-active');
                grid.setAttribute('data-skeleton', '1');
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="skeleton-card" aria-hidden="true">
                            <div class="skeleton-thumb"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-line md"></div>
                                <div class="skeleton-line sm"></div>
                                <div class="skeleton-line md"></div>
                                <div class="skeleton-featurebar"></div>
                                <div class="skeleton-line lg" style="margin-top:4px;"></div>
                                <div class="skeleton-button-row">
                                    <div class="skeleton-btn"></div>
                                    <div class="skeleton-btn"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                grid.innerHTML = html;
            }

            function hideVendorSkeletons() {
                const grid = document.getElementById('vendor-grid');
                if (!grid) return;
                if (grid.getAttribute('data-skeleton') === '1') {
                    // Do not clear innerHTML here, vendors may have been rendered already
                    grid.removeAttribute('data-skeleton');
                    grid.classList.remove('skeleton-active');
                }
            }

            // Initialize the app
            init();

            async function init() {
                // Check for direct URL access immediately
                const pathname = window.location.pathname;
                const pathParts = pathname.split('/');
                const listingIndex = pathParts.findIndex(part => part === 'listings');
                let vendorIdFromPath = null;
                if (listingIndex !== -1 && pathParts[listingIndex + 1]) {
                    vendorIdFromPath = pathParts[listingIndex + 1];
                }
                
                // If a vendor ID is found from a direct path, show the profile page and exit the rest of the init() function
                if (vendorIdFromPath) {
                    console.log('🚀 Direct URL vendor ID found on initial load:', vendorIdFromPath);
                    await showVendorProfilePage(vendorIdFromPath);
                    // Keep the original URL format - don't add hash
                    return; // Important: Exit here to prevent loading the main app view.
                }
                
                // If no vendor ID from path, proceed with normal initialization.
                console.log('🚀 No direct URL vendor ID found, proceeding with normal initialization.');
                
                // Load categories first
                await loadCategories();

                // Check for existing user session
                await checkAuthStatus();
                
                // Initialize geolocation permission observer (keeps localStorage in sync)
                initGeoPermissionObserver();
                
                // Handle initial page load based on URL or state
                setTimeout(() => {
                    handleUrlChange();
                }, 100);

                // Apply saved sidebar state and wire toggle
                try {
                    const savedCollapsed = localStorage.getItem('filtersCollapsed') === '1';
                    applySidebarState(savedCollapsed);
                } catch (e) {}
                if (filtersToggleBtn) {
                    filtersToggleBtn.addEventListener('click', () => {
                        const willCollapse = !appContainer.classList.contains('sidebar-collapsed');
                        applySidebarState(willCollapse);
                    });
                }

                // Show skeleton loader while vendors load
                showSidebarSkeletonLoader?.();
                showVendorSkeletons(8);

                try {
                    // Load vendors data from API
                    await loadVendors();

                    // Hide skeletons once loaded
                    hideSidebarSkeletonLoader?.();
                    hideVendorSkeletons();

                    // Initialize Stripe
                    initializeStripe();

                    // Connect to Socket.IO
                    connectToChat();

                    // Request location after everything is loaded
                    requestLocationWithFeedback();

                    // Setup event listeners
                    setupEventListeners();

                    // Show main app since we're not loading a direct vendor URL
                    mainAppView.style.display = 'grid';
                    clientDashboardContainer.style.display = 'none';
                    vendorDashboardContainer.style.display = 'none';

                    // Setup lightbox event listeners
                    setupLightboxEventListeners();

                    // Setup booking modal event listeners
                    setupBookingModalEventListeners();

                } catch (error) {
                    console.error('Initialization error:', error);
                    showError("Failed to load vendors. Please try again later.");
                }
            }

            // Multi-Step Booking Modal Functions
            async function openBookingModal() {
                const bookingModal = document.getElementById('booking-modal');
                window.bookingState.reset();
                updateBookingStep(1);
                bookingModal.style.display = 'flex';
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('event-date').min = today;
                
                // Load service categories
                await loadServiceCategories();
            }

            // Service Categories Loading Functions
            async function loadServiceCategories() {
                try {
                    console.log('Loading service categories...');
                    const response = await fetch(`${API_BASE_URL}/bookings/service-categories`);
                    const data = await response.json();
                    
                    console.log('Service categories response:', data);
                    
                    if (data.success && data.categories) {
                        window.bookingState.serviceCategories = data.categories;
                        renderServiceCategories();
                    } else {
                        console.warn('No categories found, using fallback');
                        renderDefaultServiceCategories();
                    }
                } catch (error) {
                    console.error('Error loading service categories:', error);
                    // Fallback to default categories if API fails
                    renderDefaultServiceCategories();
                }
            }

            function renderServiceCategories() {
                const categoriesContainer = document.getElementById('service-categories');
                if (!categoriesContainer) {
                    console.error('Service categories container not found');
                    return;
                }

                const categoriesHtml = bookingState.serviceCategories.map(category => `
                    <div class="category-card" data-category-id="${category.id}">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <div class="category-info">
                            <h5>${category.name}</h5>
                            <p>${category.serviceCount} services available</p>
                        </div>
                        <div class="category-checkbox">
                            <input type="checkbox" id="cat-${category.id}" />
                            <span class="checkmark"></span>
                        </div>
                    </div>
                `).join('');

                categoriesContainer.innerHTML = categoriesHtml;
                
                // Add click event listeners to category cards
                categoriesContainer.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const categoryId = card.getAttribute('data-category-id');
                        const category = bookingState.serviceCategories.find(c => c.id == categoryId);
                        if (category) {
                            toggleCategorySelection(categoryId, category.key);
                        }
                    });
                });
            }

            function renderDefaultServiceCategories() {
                const categoriesContainer = document.getElementById('service-categories');
                if (!categoriesContainer) {
                    console.error('Service categories container not found');
                    return;
                }

                const defaultCategories = [
                    { id: 1, key: 'venue', name: 'Venues', icon: 'fas fa-building' },
                    { id: 2, key: 'photo', name: 'Photo/Video', icon: 'fas fa-camera' },
                    { id: 3, key: 'music', name: 'Music/DJ', icon: 'fas fa-music' },
                    { id: 4, key: 'catering', name: 'Catering', icon: 'fas fa-utensils' },
                    { id: 5, key: 'entertainment', name: 'Entertainment', icon: 'fas fa-theater-masks' },
                    { id: 6, key: 'experiences', name: 'Experiences', icon: 'fas fa-star' },
                    { id: 7, key: 'decor', name: 'Decorations', icon: 'fas fa-ribbon' },
                    { id: 8, key: 'beauty', name: 'Beauty', icon: 'fas fa-spa' },
                    { id: 9, key: 'cake', name: 'Cake', icon: 'fas fa-birthday-cake' },
                    { id: 10, key: 'transport', name: 'Transportation', icon: 'fas fa-shuttle-van' },
                    { id: 11, key: 'planner', name: 'Planners', icon: 'fas fa-clipboard-list' },
                    { id: 12, key: 'fashion', name: 'Fashion', icon: 'fas fa-tshirt' },
                    { id: 13, key: 'stationery', name: 'Stationery', icon: 'fas fa-envelope' }
                ];

                const categoriesHtml = defaultCategories.map(category => `
                    <div class="category-card" data-category-id="${category.id}" data-category-key="${category.key}">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <div class="category-info">
                            <h5>${category.name}</h5>
                            <p>Multiple services available</p>
                        </div>
                        <div class="category-checkbox">
                            <input type="checkbox" id="cat-${category.id}" />
                            <span class="checkmark"></span>
                        </div>
                    </div>
                `).join('');

                categoriesContainer.innerHTML = categoriesHtml;
                
                // Add click event listeners to default category cards
                categoriesContainer.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const categoryId = card.getAttribute('data-category-id');
                        const categoryKey = card.getAttribute('data-category-key');
                        toggleCategorySelection(categoryId, categoryKey);
                    });
                });
            }

            async function toggleCategorySelection(categoryId, categoryKey) {
                const categoryCard = document.querySelector(`[data-category-id="${categoryId}"]`);
                const checkbox = categoryCard.querySelector('input[type="checkbox"]');
                
                if (checkbox.checked) {
                    // Unselect category
                    checkbox.checked = false;
                    categoryCard.classList.remove('selected');
                    
                    // Remove all services from this category
                    window.bookingState.selectedServices = bookingState.selectedServices.filter(s => s.categoryId !== parseInt(categoryId));
                } else {
                    // Select category and load its services
                    checkbox.checked = true;
                    categoryCard.classList.add('selected');
                    
                    await loadCategoryServices(categoryId, categoryKey);
                }
                
                updateBudgetRange();
                updateNextStepButton();
            }

            function updateBudgetRange() {
                // Update budget range based on selected services
                const totalServices = bookingState.selectedServices.length;
                if (totalServices > 0) {
                    // Adjust minimum budget based on number of services
                    const minBudget = Math.max(500, totalServices * 200);
                    const budgetSlider = document.getElementById('budget-slider');
                    const budgetInput = document.getElementById('budget-input');
                    
                    if (budgetSlider && budgetInput) {
                        budgetSlider.min = minBudget;
                        if (parseInt(budgetSlider.value) < minBudget) {
                            budgetSlider.value = minBudget;
                            window.bookingState.budget = minBudget;
                        }
                    }
                    
                    if (budgetInput) {
                        budgetInput.min = minBudget;
                        if (parseInt(budgetInput.value) < minBudget) {
                            budgetInput.value = minBudget;
                            window.bookingState.budget = minBudget;
                        }
                    }
                    
                    // Update budget display
                    const budgetDisplay = document.getElementById('budget-display');
                    if (budgetDisplay) {
                        budgetDisplay.textContent = bookingState.budget;
                    }
                }
            }
            
            function updateNextStepButton() {
                const nextButton = document.getElementById('next-to-booking-step-2');
                if (nextButton) {
                    nextButton.disabled = bookingState.selectedServices.length === 0;
                }
            }

            async function loadCategoryServices(categoryId, categoryKey) {
                try {
                    const response = await fetch(`${API_BASE_URL}/bookings/services/${categoryId}`);
                    const data = await response.json();
                    
                    if (data.success && data.services) {
                        // Add services from this category to selected services
                        data.services.forEach(service => {
                            const existingIndex = bookingState.selectedServices.findIndex(s => s.id === service.ServiceID);
                            if (existingIndex === -1) {
                                window.bookingState.selectedServices.push({
                                    id: service.ServiceID,
                                    categoryId: parseInt(categoryId),
                                    categoryKey: categoryKey,
                                    type: service.Name,
                                    description: service.Description,
                                    basePrice: service.BasePrice || 0,
                                    priceUnit: service.PriceUnit || 'fixed',
                                    priceRange: estimatePriceRange(service.BasePrice, categoryKey)
                                });
                            }
                        });
                    } else {
                        // Fallback to default service for category
                        addDefaultCategoryService(categoryId, categoryKey);
                    }
                } catch (error) {
                    console.error('Error loading category services:', error);
                    // Fallback to default service for category
                    addDefaultCategoryService(categoryId, categoryKey);
                }
            }

            function addDefaultCategoryService(categoryId, categoryKey) {
                const defaultServices = {
                    'photo': { name: 'Photography & Videography', priceRange: { min: 800, max: 3000 } },
                    'music': { name: 'DJ & Music Services', priceRange: { min: 400, max: 1500 } },
                    'catering': { name: 'Catering Services', priceRange: { min: 25, max: 150 } },
                    'venue': { name: 'Venue Rental', priceRange: { min: 500, max: 5000 } },
                    'decor': { name: 'Decorations & Flowers', priceRange: { min: 200, max: 1500 } },
                    'beauty': { name: 'Beauty & Styling', priceRange: { min: 100, max: 800 } }
                };

                const serviceInfo = defaultServices[categoryKey] || { name: 'Service', priceRange: { min: 100, max: 1000 } };
                
                window.bookingState.selectedServices.push({
                    id: `default-${categoryId}`,
                    categoryId: parseInt(categoryId),
                    categoryKey: categoryKey,
                    type: serviceInfo.name,
                    priceRange: serviceInfo.priceRange
                });
            }

            function estimatePriceRange(basePrice, categoryKey) {
                if (basePrice && basePrice > 0) {
                    return { min: basePrice, max: basePrice * 2 };
                }

                // Default price ranges by category
                const defaultRanges = {
                    'photo': { min: 800, max: 3000 },
                    'music': { min: 400, max: 1500 },
                    'catering': { min: 25, max: 150 },
                    'venue': { min: 500, max: 5000 },
                    'decor': { min: 200, max: 1500 },
                    'beauty': { min: 100, max: 800 }
                };

                return defaultRanges[categoryKey] || { min: 100, max: 1000 };
            }

            function closeBookingModal() {
                const bookingModal = document.getElementById('booking-modal');
                bookingModal.style.display = 'none';
                window.bookingState.reset();
                
                // Clear any countdown timers
                Object.values(bookingState.countdownTimers).forEach(timer => clearInterval(timer));
            }

            function updateBookingStep(step) {
                // Hide all steps
                for (let i = 1; i <= 4; i++) {
                    const stepElement = document.getElementById(`booking-step-${i}`);
                    const indicatorElement = document.getElementById(`booking-step-indicator-${i}`);
                    
                    if (stepElement) stepElement.style.display = 'none';
                    if (indicatorElement) indicatorElement.classList.remove('active');
                }
                
                // Show current step
                const currentStepElement = document.getElementById(`booking-step-${step}`);
                const currentIndicatorElement = document.getElementById(`booking-step-indicator-${step}`);
                
                if (currentStepElement) currentStepElement.style.display = 'block';
                if (currentIndicatorElement) currentIndicatorElement.classList.add('active');
                
                // Update progress bar
                const progressFill = document.getElementById('booking-progress-fill');
                if (progressFill) {
                    const progressPercentage = (step / 4) * 100;
                    progressFill.style.width = `${progressPercentage}%`;
                }
                
                window.bookingState.currentStep = step;
                
                // Update modal title based on step
                const modalTitle = document.getElementById('booking-modal-title');
                const stepTitles = {
                    1: 'Select Services',
                    2: 'Event Details & Budget',
                    3: 'Choose Vendors',
                    4: 'Review Requests',
                    5: 'Vendor Approvals',
                    6: 'Payment & Confirmation'
                };
                if (modalTitle) modalTitle.textContent = stepTitles[step] || 'Book Your Event';
                
                // Show search criteria summary when entering step 3
                if (step === 3) {
                    updateSearchCriteriaSummary();
                }
            }
            
            // Function to update search criteria summary
            function updateSearchCriteriaSummary() {
                const summaryContainer = document.getElementById('search-criteria-summary');
                const criteriaDetails = document.getElementById('criteria-details');
                if (!summaryContainer || !criteriaDetails) return;

                // Prefer Step 2 selected predefined services; fallback to Step 1 categories
                const selectedPredefined = window.bookingState?.selectedPredefinedServices || [];
                const selectedStep1 = window.bookingState?.selectedServices || [];
                let servicesText = 'Not specified';
                if (Array.isArray(selectedPredefined) && selectedPredefined.length > 0) {
                    servicesText = selectedPredefined.map(s => s.name).filter(Boolean).join(', ');
                } else if (Array.isArray(selectedStep1) && selectedStep1.length > 0) {
                    servicesText = selectedStep1.map(s => {
                        const t = (s && s.type) ? String(s.type) : '';
                        return t.charAt(0).toUpperCase() + t.slice(1);
                    }).filter(Boolean).join(', ');
                }

                // Event fields from Step 2 inputs
                const locationInput = document.getElementById('event-location');
                const eventLocation = (locationInput?.value && locationInput.value.trim()) ? locationInput.value.trim() : 'Not specified';
                const eventDate = document.getElementById('event-date')?.value || 'Not specified';
                const startTime = document.getElementById('event-start-time')?.value || '';
                const endTime = document.getElementById('event-end-time')?.value || '';
                const timeText = (startTime && endTime) ? `${startTime} - ${endTime}` : (startTime || endTime || 'Not specified');

                // Budget from global bookingState (total event budget)
                const totalBudgetVal = window.bookingState?.budget;
                const budgetText = (typeof totalBudgetVal === 'number' && !isNaN(totalBudgetVal) && totalBudgetVal > 0)
                    ? `$${Number(totalBudgetVal).toLocaleString()}`
                    : 'Not specified';

                // Build criteria HTML (Guests removed)
                const criteriaHtml = `
                    <div style="color: var(--text);">
                        <strong>Services:</strong> ${servicesText}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Location:</strong> ${eventLocation}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Date:</strong> ${eventDate}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Time:</strong> ${timeText}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Budget:</strong> ${budgetText}
                    </div>
                `;

                criteriaDetails.innerHTML = criteriaHtml;
                summaryContainer.style.display = 'block';
            }

            function setupBookingModalEventListeners() {
                // Service selection checkboxes
                const serviceCheckboxes = document.querySelectorAll('#service-categories input[type="checkbox"]');
                serviceCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', handleServiceSelection);
                });

                // Budget slider and input
                const budgetSlider = document.getElementById('budget-slider');
                const budgetInput = document.getElementById('budget-input');
                const budgetDisplay = document.getElementById('budget-display');

                if (budgetSlider && budgetInput && budgetDisplay) {
                    budgetSlider.addEventListener('input', (e) => {
                        const value = e.target.value;
                        budgetInput.value = value;
                        budgetDisplay.textContent = parseInt(value).toLocaleString();
                        window.bookingState.budget = parseInt(value);
                    });

                    budgetInput.addEventListener('input', (e) => {
                        const value = Math.max(500, Math.min(50000, parseInt(e.target.value) || 500));
                        budgetSlider.value = Math.min(20000, value);
                        budgetDisplay.textContent = value.toLocaleString();
                        window.bookingState.budget = value;
                    });
                }

                // Navigation buttons
                document.getElementById('next-to-booking-step-2')?.addEventListener('click', async () => {
                    if (validateStep1()) {
                        updateBookingStep(2);
                        await loadPredefinedServicesForStep2();
                    }
                });

                document.getElementById('back-to-booking-step-1')?.addEventListener('click', () => updateBookingStep(1));
                document.getElementById('find-vendors-btn')?.addEventListener('click', handleFindVendors);
                document.getElementById('back-to-booking-step-2')?.addEventListener('click', () => updateBookingStep(2));
                document.getElementById('send-requests-btn')?.addEventListener('click', () => {
                    updateSelectedVendorsSummary();
                    updateBookingStep(4);
                });
                document.getElementById('back-to-booking-step-3')?.addEventListener('click', () => updateBookingStep(3));

                // Adjust criteria button (existing)
                document.getElementById('adjust-criteria-btn')?.addEventListener('click', () => updateBookingStep(2));
                
                // New adjust filters button in search criteria summary
                document.getElementById('adjust-filters-btn')?.addEventListener('click', () => updateBookingStep(2));

                // Modal close functionality
                document.querySelector('#booking-modal .close-modal')?.addEventListener('click', closeBookingModal);
                document.getElementById('booking-modal')?.addEventListener('click', (e) => {
                    if (e.target.id === 'booking-modal') closeBookingModal();
                });
            }

            function handleServiceSelection() {
                const selectedCheckboxes = document.querySelectorAll('#service-categories input[type="checkbox"]:checked');
                window.bookingState.selectedServices = Array.from(selectedCheckboxes).map(cb => ({
                    type: cb.value,
                    minPrice: parseInt(cb.dataset.minPrice),
                    maxPrice: parseInt(cb.dataset.maxPrice)
                }));

                // Update budget range based on selected services
                if (bookingState.selectedServices.length > 0) {
                    const totalMinPrice = bookingState.selectedServices.reduce((sum, service) => sum + service.minPrice, 0);
                    const totalMaxPrice = bookingState.selectedServices.reduce((sum, service) => sum + service.maxPrice, 0);
                    
                    const budgetSlider = document.getElementById('budget-slider');
                    const budgetInput = document.getElementById('budget-input');
                    
                    if (budgetSlider && budgetInput) {
                        budgetSlider.min = totalMinPrice;
                        budgetSlider.max = Math.max(totalMaxPrice, 20000);
                        budgetInput.min = totalMinPrice;
                        
                        // Adjust current budget if it's below minimum
                        if (bookingState.budget < totalMinPrice) {
                            window.bookingState.budget = totalMinPrice;
                            budgetSlider.value = totalMinPrice;
                            budgetInput.value = totalMinPrice;
                            document.getElementById('budget-display').textContent = totalMinPrice.toLocaleString();
                        }
                    }
                    
                    // Update budget display
                    const budgetDisplay = document.getElementById('budget-display');
                    if (budgetDisplay) {
                        budgetDisplay.textContent = bookingState.budget;
                    }
                }

                // Enable/disable next button
                const nextButton = document.getElementById('next-to-booking-step-2');
                if (nextButton) {
                    nextButton.disabled = bookingState.selectedServices.length === 0;
                }
            }

            function validateStep1() {
                return bookingState.selectedServices.length > 0;
            }

            // Load predefined services for Step 2 based on selected categories from Step 1
            async function loadPredefinedServicesForStep2() {
                const loadingDiv = document.getElementById('predefined-services-loading');
                const containerDiv = document.getElementById('booking-predefined-services-container');
                const noServicesDiv = document.getElementById('no-services-message');
                
                // Show loading
                loadingDiv.style.display = 'block';
                containerDiv.style.display = 'none';
                noServicesDiv.style.display = 'none';
                
                try {
                    // Get selected categories from Step 1
                    const selectedCategories = bookingState.selectedServices.map(service => service.categoryKey);
                    
                    if (selectedCategories.length === 0) {
                        throw new Error('No categories selected');
                    }
                    
                    // Fetch predefined services for selected categories
                    console.log('Fetching from:', `${API_BASE_URL}/vendors/predefined-services`);
                    const response = await fetch(`${API_BASE_URL}/vendors/predefined-services`);
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    const data = await response.json();
                    
                    console.log('Predefined services API response:', data);
                    console.log('Selected categories:', selectedCategories);
                    console.log('API servicesByCategory keys:', data.servicesByCategory ? Object.keys(data.servicesByCategory) : 'No servicesByCategory');
                    console.log('Full API response structure:', JSON.stringify(data, null, 2));
                    
                    if (data.success && data.servicesByCategory) {
                        // Map frontend category keys to database categories
                        const categoryMapping = {
                            'photo': 'Photography',
                            'music': 'Music & Entertainment',
                            'catering': 'Catering',
                            'venue': 'Venue',
                            'planning': 'Event Planning',
                            'beauty': 'Beauty & Styling',
                            'transport': 'Transportation',
                            'floral': 'Floral & Decor',
                            'wedding': 'Wedding'
                        };
                        
                        // Filter services by selected categories using mapping
                        const filteredServices = {};
                        selectedCategories.forEach(categoryKey => {
                            const dbCategory = categoryMapping[categoryKey] || categoryKey;
                            console.log(`Looking for category: ${categoryKey} -> ${dbCategory}`);
                            
                            if (data.servicesByCategory[dbCategory]) {
                                filteredServices[categoryKey] = data.servicesByCategory[dbCategory];
                                console.log(`Found services for ${categoryKey}:`, data.servicesByCategory[dbCategory]);
                            } else {
                                console.log(`No services found for category: ${categoryKey} (${dbCategory})`);
                                console.log('Available categories:', Object.keys(data.servicesByCategory));
                            }
                        });
                        
                        console.log('Filtered services:', filteredServices);
                        
                        // If no services found, use mock data for testing
                        if (Object.keys(filteredServices).length === 0) {
                            console.log('No matching services found, using mock data for testing...');
                            const mockServices = {};
                            selectedCategories.forEach(categoryKey => {
                                mockServices[categoryKey] = [
                                    {
                                        id: Math.floor(Math.random() * 1000),
                                        name: `${categoryKey} Service 1`,
                                        description: `Professional ${categoryKey} service for your event`,
                                    },
                                    {
                                        id: Math.floor(Math.random() * 1000) + 1000,
                                        name: `${categoryKey} Service 2`,
                                        description: `Premium ${categoryKey} service with additional features`,
                                    }
                                ];
                            });
                            window.bookingState.availablePredefinedServices = mockServices;
                            renderPredefinedServices(mockServices);
                        } else {
                            window.bookingState.availablePredefinedServices = filteredServices;
                            renderPredefinedServices(filteredServices);
                        }
                    } else {
                        console.error('API response error:', data);
                        console.log('Using mock data due to API error...');
                        
                        // Use mock data when API fails
                        const mockServices = {};
                        selectedCategories.forEach(categoryKey => {
                            mockServices[categoryKey] = [
                                {
                                    id: Math.floor(Math.random() * 1000),
                                    name: `${categoryKey} Service 1`,
                                    description: `Professional ${categoryKey} service for your event`,
                                    defaultDuration: 60
                                },
                                {
                                    id: Math.floor(Math.random() * 1000) + 1000,
                                    name: `${categoryKey} Service 2`,
                                    description: `Premium ${categoryKey} service with additional features`,
                                    defaultDuration: 90
                                }
                            ];
                        });
                        window.bookingState.availablePredefinedServices = mockServices;
                        renderPredefinedServices(mockServices);
                    }
                } catch (error) {
                    console.error('Error loading predefined services:', error);
                    loadingDiv.style.display = 'none';
                    noServicesDiv.style.display = 'block';
                }
            }

            // Render predefined services with individual budget allocation
            function renderPredefinedServices(servicesByCategory) {
                console.log('renderPredefinedServices called with:', servicesByCategory);
                
                const loadingDiv = document.getElementById('predefined-services-loading');
                const containerDiv = document.getElementById('booking-predefined-services-container');
                const noServicesDiv = document.getElementById('no-services-message');
                
                console.log('DOM elements found:', {
                    loadingDiv: !!loadingDiv,
                    containerDiv: !!containerDiv,
                    noServicesDiv: !!noServicesDiv
                });
                
                loadingDiv.style.display = 'none';
                
                if (Object.keys(servicesByCategory).length === 0) {
                    console.log('No services to display, showing no services message');
                    noServicesDiv.style.display = 'block';
                    return;
                }
                
                console.log('Processing services for dropdown display...');
                
                const dropdownsContainer = document.getElementById('service-selection-dropdowns');
                const selectedServicesContainer = document.getElementById('selected-services-list-container');
                
                let dropdownsHtml = '';
                
                Object.entries(servicesByCategory).forEach(([category, services]) => {
                    dropdownsHtml += `
                        <div class="service-category-dropdown" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); text-transform: capitalize;">
                                ${category} Services
                            </label>
                            <select class="service-dropdown" data-category="${category}" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; background: var(--card-bg); color: var(--text); transition: border-color 0.3s ease;">
                                <option value="" data-placeholder="Select a ${category} service...">
                                    Select a ${category} service...
                                </option>
                    `;
                    
                    services.forEach(service => {
                        dropdownsHtml += `<option value="${service.id}" data-name="${service.name}" data-description="${service.description || ''}">
                            ${service.name}${service.description ? ' - ' + service.description.substring(0, 50) + '...' : ''}
                        </option>`;
                    });
                    
                    dropdownsHtml += `
                            </select>
                        </div>
                    `;
                });
                
                console.log('Generated dropdown HTML:', dropdownsHtml);
                dropdownsContainer.innerHTML = dropdownsHtml;
                
                // Initialize selected services container with a live count badge
                selectedServicesContainer.innerHTML = `
                    <div id="selected-services-display" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h6 style="color: var(--primary-color); margin: 0;">Selected Services & Budgets</h6>
                            <span id="selected-services-count" style="font-size: 0.85rem; color: var(--text-light); background: #eef2ff; padding: 0.25rem 0.5rem; border-radius: 999px;">
                                0 selected
                            </span>
                        </div>
                        <div id="selected-services-items"></div>
                    </div>
                `;
                
                containerDiv.style.display = 'block';
                containerDiv.style.visibility = 'visible';
                containerDiv.style.opacity = '1';
                
                console.log('Dropdown container display set to block');
                console.log('Container computed styles:', {
                    display: window.getComputedStyle(containerDiv).display,
                    visibility: window.getComputedStyle(containerDiv).visibility,
                    opacity: window.getComputedStyle(containerDiv).opacity,
                    height: window.getComputedStyle(containerDiv).height,
                    position: window.getComputedStyle(containerDiv).position,
                    zIndex: window.getComputedStyle(containerDiv).zIndex
                });
                
                // Force show the container with important styles
                containerDiv.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;');
                
                // Trace through all parent elements to find what's hiding the content
                let currentElement = containerDiv;
                let level = 0;
                while (currentElement && level < 10) {
                    const styles = window.getComputedStyle(currentElement);
                    console.log(`Element level ${level}:`, {
                        tagName: currentElement.tagName,
                        id: currentElement.id,
                        className: currentElement.className,
                        display: styles.display,
                        visibility: styles.visibility,
                        opacity: styles.opacity,
                        height: styles.height,
                        overflow: styles.overflow
                    });
                    
                    // Force visibility on any hidden parent
                    if (styles.display === 'none' || styles.visibility === 'hidden' || styles.opacity === '0') {
                        console.log(`Forcing visibility on level ${level} element:`, currentElement.tagName, currentElement.id);
                        currentElement.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important;');
                    }
                    
                    currentElement = currentElement.parentElement;
                    level++;
                }
                
                // Also force the Step 2 section to be visible
                const step2Section = document.getElementById('step-2');
                if (step2Section) {
                    console.log('Step 2 section styles:', {
                        display: window.getComputedStyle(step2Section).display,
                        visibility: window.getComputedStyle(step2Section).visibility,
                        opacity: window.getComputedStyle(step2Section).opacity
                    });
                    step2Section.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                }
                
                // Remove debugging styles and apply proper styling
                containerDiv.style.border = '';
                containerDiv.style.backgroundColor = '';
                containerDiv.style.padding = '';
                containerDiv.style.margin = '';
                
                console.log('Container styling cleaned up');
                
                // Add event listeners for dropdown selection
                addDropdownEventListeners();

                // Update dropdown placeholders with current selection counts
                updateDropdownCounts();
            }

            // Create individual predefined service card with budget input
            function createPredefinedServiceCard(service, category) {
                const isSelected = bookingState.selectedPredefinedServices.some(s => s.id === service.id);
                const selectedService = bookingState.selectedPredefinedServices.find(s => s.id === service.id);
                const budget = selectedService ? selectedService.budget : 100;
                
                return `
                    <div class="predefined-service-card ${isSelected ? 'selected' : ''}" data-service-id="${service.id}" data-category="${category}">
                        <div class="service-card-header">
                            <div class="service-card-title">${service.name}</div>
                            <div class="service-card-check">
                                ${isSelected ? '<i class="fas fa-check" style="color: #28a745;"></i>' : ''}
                            </div>
                        </div>
                        
                        <div class="service-card-description">
                            ${service.description || 'Professional service for your event'}
                        </div>
                        
                        <div class="service-card-details">
                            <div class="service-card-duration">
                                <i class="fas fa-clock"></i>
                                <span>Custom Duration</span>
                            </div>
                        </div>
                        
                        <div class="service-budget-form" style="display: ${isSelected ? 'block' : 'none'}; margin-top: 1rem; padding: 1rem; background: #f8faff; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">Your Budget for this Service</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-light);">$</span>
                                <input type="number" class="service-budget-input" min="1" max="10000" value="${budget}" 
                                       style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; background: var(--card-bg); color: var(--text);">
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-light);">
                                Set your budget for this specific service
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add event listeners for dropdown service selection
            function addDropdownEventListeners() {
                document.querySelectorAll('.service-dropdown').forEach(dropdown => {
                    dropdown.addEventListener('change', (e) => {
                        const serviceId = parseInt(e.target.value);
                        const category = e.target.dataset.category;
                        const selectedOption = e.target.selectedOptions[0];
                        
                        if (serviceId && selectedOption) {
                            const serviceName = selectedOption.dataset.name;
                            const serviceDescription = selectedOption.dataset.description;
                            const serviceDuration = parseInt(selectedOption.dataset.duration) || 60;
                            
                            addServiceFromDropdown(serviceId, serviceName, serviceDescription, category, serviceDuration);
                            
                            // Reset dropdown to default
                            e.target.value = '';
                        }
                    });
                });
            }

            // Add service from dropdown selection
            function addServiceFromDropdown(serviceId, serviceName, serviceDescription, category, duration) {
                // Check if service is already selected
                const existingService = bookingState.selectedPredefinedServices.find(s => s.id === serviceId);
                if (existingService) {
                    showError('This service is already selected.');
                    return;
                }
                
                // Add to selected services with default budget
                const newService = {
                    id: serviceId,
                    name: serviceName,
                    description: serviceDescription,
                    category: category,
                    budget: 100, // Default budget
                    duration: Math.max(15, Math.min(480, parseInt(duration) || 60)),
                    startTime: '',
                    endTime: ''
                };
                
                window.bookingState.selectedPredefinedServices.push(newService);
                renderSelectedServices();
                updateFindVendorsButton();
                updateDropdownCounts();
                drawTimeline();
            }

            // Render selected services with budget inputs
            function renderSelectedServices() {
                const selectedServicesDisplay = document.getElementById('selected-services-display');
                const selectedServicesItems = document.getElementById('selected-services-items');
                const selectedServicesCount = document.getElementById('selected-services-count');
                
                if (bookingState.selectedPredefinedServices.length === 0) {
                    selectedServicesDisplay.style.display = 'none';
                    if (selectedServicesCount) selectedServicesCount.textContent = '0 selected';
                    return;
                }
                
                selectedServicesDisplay.style.display = 'block';
                if (selectedServicesCount) selectedServicesCount.textContent = `${bookingState.selectedPredefinedServices.length} selected`;
                
                let servicesHtml = '';
                let totalBudget = 0;
                
                window.bookingState.selectedPredefinedServices.forEach((service, index) => {
                    totalBudget += service.budget;
                    servicesHtml += `
                        <div class="selected-service-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; margin-bottom: 0.5rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">${service.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-light); text-transform: capitalize;">${service.category}</div>
                                ${service.description ? `<div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem;">${service.description}</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.9rem; color: var(--text);">Budget:</label>
                                    <div style="display: flex; align-items: center;">
                                        <span style="color: var(--text-light);">$</span>
                                        <input type="number" class="service-budget-input" data-service-id="${service.id}" 
                                               min="1" max="10000" value="${service.budget}" 
                                               style="width: 80px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; margin-left: 0.25rem;">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.9rem; color: var(--text);">Start:</label>
                                    <input type="time" class="service-start-time" data-service-id="${service.id}" value="${service.startTime || ''}" step="900" style="width: 120px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.9rem; color: var(--text);">End:</label>
                                    <input type="time" class="service-end-time" data-service-id="${service.id}" value="${service.endTime || ''}" step="900" style="width: 120px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem; color: var(--text-light); font-size: 0.9rem;">
                                    <i class="fas fa-clock"></i>
                                    <span id="service-duration-display-${service.id}">${(service.duration || 0)} min</span>
                                </div>
                                <button type="button" class="remove-service-btn" data-service-id="${service.id}" 
                                        style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer;">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                servicesHtml += `
                    <div style="margin-top: 1rem; padding: 1rem; background: #f8faff; border-radius: 6px; border-left: 4px solid var(--primary-color);">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <span style="font-weight: 600; color: var(--text);">Total Budget:</span>
                            <span style="font-weight: 700; font-size: 1.1rem; color: var(--primary-color);">$${totalBudget.toLocaleString()}</span>
                        </div>
                    </div>
                `;
                
                selectedServicesItems.innerHTML = servicesHtml;
                
                // Add event listeners for budget inputs and remove buttons
                addSelectedServiceEventListeners();
                // Keep dropdown counts in sync on re-render
                updateDropdownCounts();
                // Keep timeline in sync after re-render
                drawTimeline();
            }

            // Global variable to store Google Maps initialization status
            window.googleMapsLoaded = false;
            
            // Legacy function - now redirects to consolidated implementation
            function initializeLocationAutocomplete() {
                console.log('Legacy initializeLocationAutocomplete called - redirecting to new implementation');
                initializeLocationAutocompleteNow();
            }
            
            // Search for locations using a geocoding service
            async function searchLocations(query) {
                const suggestionsDiv = document.getElementById('location-suggestions');
                
                try {
                    // Using OpenStreetMap Nominatim API as a free alternative to Google Maps
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`);
                    const locations = await response.json();
                    
                    if (locations.length === 0) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }
                    
                    let suggestionsHtml = '';
                    locations.forEach(location => {
                        const displayName = location.display_name;
                        suggestionsHtml += `
                            <div class="location-suggestion-item" data-location="${displayName}" data-lat="${location.lat}" data-lon="${location.lon}">
                                ${displayName}
                            </div>
                        `;
                    });
                    
                    suggestionsDiv.innerHTML = suggestionsHtml;
                    suggestionsDiv.style.display = 'block';
                    
                    // Add click event listeners to suggestions
                    suggestionsDiv.querySelectorAll('.location-suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const locationInput = document.getElementById('event-location');
                            locationInput.value = this.dataset.location;
                            suggestionsDiv.style.display = 'none';
                            
                            // Store coordinates for future use if needed
                            locationInput.dataset.lat = this.dataset.lat;
                            locationInput.dataset.lon = this.dataset.lon;
                        });
                    });
                    
                } catch (error) {
                    console.error('Error searching locations:', error);
                    suggestionsDiv.style.display = 'none';
                }
            }

            // Add event listeners for selected services (budget and duration inputs, remove buttons)
            function addSelectedServiceEventListeners() {
                // Budget input listeners
                document.querySelectorAll('.service-budget-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const serviceId = parseInt(e.target.dataset.serviceId);
                        const value = Math.max(Math.min(10000, parseInt(e.target.value) || 0));
                        
                        updateServiceBudget(serviceId, value);
                        renderSelectedServices(); // Re-render to update total
                    });
                });
                
                // Start/End time listeners
                document.querySelectorAll('.service-start-time').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const serviceId = parseInt(e.target.dataset.serviceId);
                        updateServiceTime(serviceId, 'startTime', e.target.value);
                    });
                });
                document.querySelectorAll('.service-end-time').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const serviceId = parseInt(e.target.dataset.serviceId);
                        updateServiceTime(serviceId, 'endTime', e.target.value);
                    });
                });
                
                // Remove button listeners
                document.querySelectorAll('.remove-service-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const serviceId = parseInt(e.target.dataset.serviceId);
                        removeSelectedService(serviceId);
                    });
                });
            }

            // Remove selected service
            function removeSelectedService(serviceId) {
                window.bookingState.selectedPredefinedServices = bookingState.selectedPredefinedServices.filter(s => s.id !== serviceId);
                renderSelectedServices();
                updateFindVendorsButton();
                updateDropdownCounts();
                drawTimeline();
            }

            // Legacy function - keep for compatibility
            function addPredefinedServiceEventListeners() {
                // This function is now replaced by addDropdownEventListeners
                console.log('Legacy addPredefinedServiceEventListeners called');
            }

            // Toggle predefined service selection
            function togglePredefinedServiceSelection(serviceId, category, cardElement) {
                const isSelected = cardElement.classList.contains('selected');
                const budgetForm = cardElement.querySelector('.service-budget-form');
                const checkIcon = cardElement.querySelector('.service-card-check');
                
                if (isSelected) {
                    // Deselect service
                    cardElement.classList.remove('selected');
                    budgetForm.style.display = 'none';
                    checkIcon.textContent = '';
                    
                    // Remove from selected services
                    window.bookingState.selectedPredefinedServices = bookingState.selectedPredefinedServices.filter(s => s.id !== serviceId);
                    renderSelectedServices();
                    updateDropdownCounts();
                } else {
                    // Select service
                    cardElement.classList.add('selected');
                    budgetForm.style.display = 'block';
                    checkIcon.innerHTML = '<i class="fas fa-check" style="color: #28a745;"></i>';
                    
                    // Find service details
                    const serviceDetails = bookingState.availablePredefinedServices[category]?.find(s => s.id === serviceId);
                    if (serviceDetails) {
                        // Add to selected services
                        window.bookingState.selectedPredefinedServices.push({
                            id: serviceId,
                            name: serviceDetails.name,
                            description: serviceDetails.description,
                            category: category,
                            budget: 100, // Default budget
                            duration: 60
                        });
                        renderSelectedServices();
                        updateDropdownCounts();
                    }
                }
                
                updateSelectedServicesSummary();
                updateFindVendorsButton();
            }

            // Update the placeholder of each dropdown with count of selected services in that category
            function updateDropdownCounts() {
                const selected = Array.isArray(window.bookingState?.selectedPredefinedServices)
                    ? window.bookingState.selectedPredefinedServices
                    : [];
                document.querySelectorAll('.service-dropdown').forEach(selectEl => {
                    const cat = selectEl.dataset.category;
                    const count = selected.filter(s => s.category === cat).length;
                    const firstOpt = selectEl.querySelector('option[value=""]');
                    if (firstOpt) {
                        const base = firstOpt.dataset.placeholder || `Select a ${cat} service...`;
                        firstOpt.textContent = count > 0
                            ? `${count} service${count > 1 ? 's' : ''} selected`
                            : base;
                    }
                });
            }

            // Update individual service budget
            function updateServiceBudget(serviceId, budget) {
                const service = bookingState.selectedPredefinedServices.find(s => s.id === serviceId);
                if (service) {
                    service.budget = Math.max(1, Math.min(10000, budget));
                    updateSelectedServicesSummary();
                }
            }

            // Update service duration
            function updateServiceDuration(serviceId, duration) {
                const service = bookingState.selectedPredefinedServices.find(s => s.id === serviceId);
                if (service) {
                    service.duration = Math.max(15, Math.min(480, duration));
                }
            }

            // Update service start/end time and recompute duration
            function updateServiceTime(serviceId, field, value) {
                const service = bookingState.selectedPredefinedServices.find(s => s.id === serviceId);
                if (!service) return;
                service[field] = value;
                // If both times present, compute duration
                const startMin = parseTimeToMinutes(service.startTime);
                const endMin = parseTimeToMinutes(service.endTime);
                if (Number.isFinite(startMin) && Number.isFinite(endMin) && endMin >= startMin) {
                    service.duration = endMin - startMin;
                    const disp = document.getElementById(`service-duration-display-${service.id}`);
                    if (disp) disp.textContent = `${service.duration} min`;
                }
                drawTimeline();
            }

            // Parse HH:MM to minutes from midnight
            function parseTimeToMinutes(t) {
                if (!t || typeof t !== 'string' || !t.includes(':')) return NaN;
                const [h, m] = t.split(':').map(v => parseInt(v, 10));
                if (Number.isNaN(h) || Number.isNaN(m)) return NaN;
                return h * 60 + m;
            }

            function formatMinutes(min) {
                const h = Math.floor(min / 60);
                const m = min % 60;
                return `${h}h ${m}m`;
            }
            // Format minutes from midnight to h:mm AM/PM
            function formatTimeLabel(mins) {
                const h24 = Math.floor(mins / 60);
                const m = mins % 60;
                const ampm = h24 < 12 ? 'AM' : 'PM';
                const h12 = ((h24 + 11) % 12) + 1;
                return `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
            }

            // Compute timeline range
            function getTimelineRange() {
                const eStart = parseTimeToMinutes(document.getElementById('event-start-time')?.value || '');
                const eEnd = parseTimeToMinutes(document.getElementById('event-end-time')?.value || '');
                const services = bookingState.selectedPredefinedServices || [];
                const sStarts = services.map(s => parseTimeToMinutes(s.startTime)).filter(Number.isFinite);
                const sEnds = services.map(s => parseTimeToMinutes(s.endTime)).filter(Number.isFinite);
                const mins = [eStart, ...sStarts].filter(Number.isFinite);
                const maxs = [eEnd, ...sEnds].filter(Number.isFinite);
                let minT = mins.length ? Math.min(...mins) : 8 * 60;
                let maxT = maxs.length ? Math.max(...maxs) : 20 * 60;
                if (Number.isFinite(eStart) && Number.isFinite(eEnd)) {
                    minT = Math.min(minT, eStart);
                    maxT = Math.max(maxT, eEnd);
                }
                if (maxT <= minT) maxT = minT + 60;
                return { minT, maxT };
            }

            // Detect conflicts and overlaps
            function computeConflicts() {
                const eStart = parseTimeToMinutes(document.getElementById('event-start-time')?.value || '');
                const eEnd = parseTimeToMinutes(document.getElementById('event-end-time')?.value || '');
                const services = bookingState.selectedPredefinedServices || [];
                const conflicts = new Map();
                services.forEach(s => {
                    const sStart = parseTimeToMinutes(s.startTime);
                    const sEnd = parseTimeToMinutes(s.endTime);
                    let has = false;
                    if (!(Number.isFinite(sStart) && Number.isFinite(sEnd) && sEnd >= sStart)) return; // incomplete
                    // outside event
                    if (Number.isFinite(eStart) && sStart < eStart) has = true;
                    if (Number.isFinite(eEnd) && sEnd > eEnd) has = true;
                    conflicts.set(s.id, has);
                });
                return conflicts;
            }

            // Draw timeline with axis and bars
            function drawTimeline() {
                const container = document.getElementById('timeline-container');
                if (!container) return;
                const axis = document.getElementById('timeline-axis');
                const layers = document.getElementById('timeline-layers');
                const { minT, maxT } = getTimelineRange();
                const range = maxT - minT;
                function pct(mins) { return (mins / range) * 100; }
                // Axis (hour ticks)
                axis.innerHTML = '';
                const startHour = Math.floor(minT / 60);
                const endHour = Math.ceil(maxT / 60);
                let axisHtml = '';
                for (let h = startHour; h <= endHour; h++) {
                    const x = pct((h * 60) - minT);
                    const label = `${((h + 11) % 12) + 1}${h < 12 ? ' AM' : ' PM'}`;
                    axisHtml += `<div style="position:absolute; left:${x}%; top:0; transform: translateX(-50%); white-space:nowrap;">${label}</div>`;
                }
                axis.innerHTML = axisHtml;
                // Layers
                layers.innerHTML = '';
                function addBar(start, end, color, top, height, opacity=1, border='', label='') {
                    const left = pct(start - minT);
                    const width = pct(end - start);
                    const div = document.createElement('div');
                    div.style.cssText = `position:absolute; left:${left}%; width:${width}%; top:${top}px; height:${height}px; background:${color}; opacity:${opacity}; border:${border}; border-radius:6px; display:flex; align-items:center; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;`;
                    // Tooltip
                    const dur = Math.max(0, end - start);
                    const base = `${formatTimeLabel(start)}–${formatTimeLabel(end)}${dur>0?` • ${formatMinutes(dur)}`:''}`;
                    div.title = label ? `${label} • ${base}` : base;
                    if (label) {
                        const span = document.createElement('span');
                        span.textContent = label;
                        span.style.cssText = 'font-size:11px; color:#111827; padding:0 6px; opacity:0.95;';
                        div.appendChild(span);
                    }
                    layers.appendChild(div);
                }
                // Event window
                const eStart = parseTimeToMinutes(document.getElementById('event-start-time')?.value || '');
                const eEnd = parseTimeToMinutes(document.getElementById('event-end-time')?.value || '');
                if (Number.isFinite(eStart) && Number.isFinite(eEnd) && eEnd > eStart) {
                    addBar(eStart, eEnd, '#c7d2fe', 10, 24, 0.8, '1px solid #a5b4fc', 'Event');
                }
                // Vendor engagement window derived from services
                const services = bookingState.selectedPredefinedServices || [];
                const sStarts = services.map(s => parseTimeToMinutes(s.startTime)).filter(Number.isFinite);
                const sEnds = services.map(s => parseTimeToMinutes(s.endTime)).filter(Number.isFinite);
                if (sStarts.length && sEnds.length) {
                    const vStart = Math.min(...sStarts);
                    const vEnd = Math.max(...sEnds);
                    if (vEnd > vStart) addBar(vStart, vEnd, '#bbf7d0', 44, 20, 0.9, '1px solid #86efac', 'Vendors');
                }
                // Services
                const conflicts = computeConflicts();
                const warn = document.getElementById('timeline-warning');
                if (warn) {
                    const count = Array.from(conflicts.values()).filter(Boolean).length;
                    if (count > 0) {
                        warn.textContent = `${count} service${count>1?'s':''} are outside the event window.`;
                        warn.style.display = 'block';
                    } else {
                        warn.style.display = 'none';
                        warn.textContent = '';
                    }
                }
                let row = 0;
                services.forEach(s => {
                    const sS = parseTimeToMinutes(s.startTime);
                    const sE = parseTimeToMinutes(s.endTime);
                    if (!(Number.isFinite(sS) && Number.isFinite(sE) && sE > sS)) return;
                    const top = 72 + (row * 28);
                    const color = conflicts.get(s.id) ? '#fecaca' : '#fcd34d';
                    addBar(sS, sE, color, top, 20, 1, '1px solid rgba(0,0,0,0.05)', s.name || 'Service');
                    row++;
                });
            }

            // (Auto-Pack and Clear Times removed by request)

            // Wire up timeline controls and inputs
            document.addEventListener('DOMContentLoaded', () => {
                const ids = ['event-start-time','event-end-time'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', () => drawTimeline());
                });
                // Initial draw
                setTimeout(drawTimeline, 0);
            });

            // Update selected services summary
            function updateSelectedServicesSummary() {
                const summaryDiv = document.getElementById('selected-services-summary');
                const listDiv = document.getElementById('selected-services-list');
                const totalBudgetSpan = document.getElementById('total-services-budget');
                
                if (bookingState.selectedPredefinedServices.length === 0) {
                    summaryDiv.style.display = 'none';
                    return;
                }
                
                summaryDiv.style.display = 'block';
                
                let listHtml = '';
                let totalBudget = 0;
                let totalMinutes = 0;
                
                window.bookingState.selectedPredefinedServices.forEach(service => {
                    const durMin = Math.max(0, parseInt(service.duration) || 0);
                    const durTxt = durMin > 0 ? formatMinutes(durMin) : '—';
                    const hourly = durMin > 0 ? (service.budget / (durMin/60)) : 0;
                    totalBudget += service.budget;
                    totalMinutes += durMin;
                    listHtml += `
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; padding: 0.25rem 0; align-items: center;">
                            <div>
                                <div style="color: var(--text); font-weight:600;">${service.name}</div>
                                <div style="color: var(--text-light); font-size:0.85rem;">Duration: ${durTxt}${durMin>0?` • ~$${Math.round(hourly).toLocaleString()}/hr`:''}</div>
                            </div>
                            <div style="font-weight: 700; color: var(--primary-color);">$${Number(service.budget||0).toLocaleString()}</div>
                        </div>
                    `;
                });
                
                const blendedHourly = totalMinutes>0 ? (totalBudget / (totalMinutes/60)) : 0;
                listHtml += `
                    <div style="margin-top: 0.5rem; padding-top:0.5rem; border-top:1px dashed var(--border); color: var(--text-light); font-size:0.9rem;">
                        <div>Total duration: ${formatMinutes(totalMinutes)}${totalMinutes>0?` • Blended ~$${Math.round(blendedHourly).toLocaleString()}/hr`:''}</div>
                    </div>
                `;
                
                listDiv.innerHTML = listHtml;
                totalBudgetSpan.textContent = totalBudget.toLocaleString();
            }

            // Update Find Vendors button state
            function updateFindVendorsButton() {
                const findVendorsBtn = document.getElementById('find-vendors-btn');
                if (findVendorsBtn) {
                    const hasSelectedServices = bookingState.selectedPredefinedServices.length > 0;
                    findVendorsBtn.disabled = !hasSelectedServices;
                }
            }

            function validateStep2() {
                const eventDate = document.getElementById('event-date');
                const eventStartTime = document.getElementById('event-start-time');
                const eventEndTime = document.getElementById('event-end-time');
                const eventLocation = document.getElementById('event-location');
                
                // Check if all required fields exist and have values
                return eventDate?.value && 
                       eventStartTime?.value && 
                       eventEndTime?.value && 
                       eventLocation?.value;
            }

            async function handleFindVendors() {
                // Validate that services are selected and event details are filled
                if (bookingState.selectedPredefinedServices.length === 0) {
                    showError('Please select at least one service.');
                    return;
                }
                
                if (!validateStep2()) {
                    showError('Please fill in all required event details.');
                    return;
                }

                // Collect event details - use stored location data if available
                const locationInput = document.getElementById('event-location');
                const eventLocationData = window.selectedEventLocation || {};
                
                window.bookingState.eventDetails = {
                    date: document.getElementById('event-date').value,
                    startTime: document.getElementById('event-start-time').value,
                    endTime: document.getElementById('event-end-time').value,
                    location: locationInput.value,
                    locationCoords: eventLocationData.lat && eventLocationData.lng ? {
                        lat: eventLocationData.lat,
                        lng: eventLocationData.lng
                    } : null,
                    attendeeCount: parseInt(document.getElementById('attendee-count').value) || 50
                };
                
                // Also update the global bookingState to ensure consistency
                if (window.bookingState) {
                    window.bookingState.eventDetails = bookingState.eventDetails;
                }
                
                console.log('Event details collected:', bookingState.eventDetails);

                // Show loading state
                document.getElementById('vendor-loading').style.display = 'block';
                document.getElementById('vendor-results').innerHTML = '';
                document.getElementById('no-vendors-found').style.display = 'none';

                updateBookingStep(3);

                try {
                    // Group selected services by category for sectioned display
                    const servicesByCategory = {};
                    window.bookingState.selectedPredefinedServices.forEach(service => {
                        const category = service.category || 'Other';
                        if (!servicesByCategory[category]) {
                            servicesByCategory[category] = [];
                        }
                        servicesByCategory[category].push(service);
                    });

                    console.log('Services grouped by category:', servicesByCategory);

                    // Make separate API calls for each category and service combination
                    const vendorSections = [];
                    let totalVendorsFound = 0;

                    for (const [category, services] of Object.entries(servicesByCategory)) {
                        for (const service of services) {
                            console.log(`Searching vendors for category: ${category}, service: ${service.name}`);
                            
                            const serviceRequirement = {
                                serviceId: service.id,
                                serviceName: service.name,
                                category: service.category,
                                budget: service.budget,
                                duration: service.duration // Use user-specified duration instead of default
                            };

                            const searchPayload = {
                                selectedServices: [serviceRequirement],
                                eventDetails: bookingState.eventDetails,
                                totalBudget: service.budget,
                                serviceIds: [service.id]
                            };

                            try {
                                const response = await fetch(`${API_BASE_URL}/vendors/search-by-services`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(searchPayload)
                                });

                                const data = await response.json();
                                
                                console.log(`API Response for ${category} - ${service.name}:`, data);
                                
                                if (data.success && data.vendors && data.vendors.length > 0) {
                                    // Add coordinates to vendors for map display
                                    const vendorsWithCoords = data.vendors.map(vendor => {
                                        const vendorWithCoords = {
                                            ...vendor,
                                            coordinates: {
                                                lat: vendor.Latitude || vendor.latitude || 43.6532, // Default to Toronto
                                                lng: vendor.Longitude || vendor.longitude || -79.3832
                                            }
                                        };
                                        console.log(`Vendor ${vendor.BusinessName || vendor.name} coordinates:`, vendorWithCoords.coordinates);
                                        return vendorWithCoords;
                                    });
                                    
                                    const vendorSection = {
                                        category: category,
                                        service: service,
                                        vendors: vendorsWithCoords
                                    };
                                    
                                    vendorSections.push(vendorSection);
                                    totalVendorsFound += vendorsWithCoords.length;
                                    console.log(`✅ Added section for ${category} - ${service.name} with ${vendorsWithCoords.length} vendors:`, vendorSection);
                                } else {
                                    console.log(`No vendors found for ${category} - ${service.name}`);
                                }
                            } catch (sectionError) {
                                console.error(`Error searching vendors for ${category} - ${service.name}:`, sectionError);
                            }
                        }
                    }

                    document.getElementById('vendor-loading').style.display = 'none';

                    console.log('🎯 Final vendor sections before rendering:', vendorSections);
                    console.log('🎯 vendorSections.length:', vendorSections.length);
                    console.log('🎯 totalVendorsFound:', totalVendorsFound);
                    
                    if (vendorSections.length > 0 && totalVendorsFound > 0) {
                        // Store all vendors for selection tracking
                        window.bookingState.availableVendors = vendorSections.flatMap(section => section.vendors);
                        console.log('📦 Stored available vendors:', window.bookingState.availableVendors.length);
                        
                        // Initialize Google Maps and render map-based vendor results
                        await initializeVendorMap(vendorSections);
                        
                        // Add a small delay to ensure DOM is ready
                        setTimeout(() => {
                            console.log('🎨 About to render vendor cards...');
                            console.log('Current booking step:', window.bookingState?.currentStep);
                            console.log('Vendor sections to render:', JSON.stringify(vendorSections, null, 2));
                            
                            // Force show container first
                            const container = document.getElementById('vendor-cards-container');
                            if (container) {
                                container.style.display = 'block';
                                console.log('✅ Forced container to be visible');
                            }
                            
                            // Add immediate test to bypass any issues
                            console.log('🧪 Testing direct card insertion...');
                            const cardsContainer = document.getElementById('vendor-horizontal-cards');
                            if (cardsContainer) {
                                cardsContainer.innerHTML = `
                                    <div style="padding: 1rem; background: #e8f5e8; border: 2px solid #4caf50; border-radius: 8px; margin: 1rem 0;">
                                        <h4 style="color: #2e7d32; margin: 0 0 0.5rem 0;">✅ Vendors Found!</h4>
                                        <p style="color: #2e7d32; margin: 0;">Found ${totalVendorsFound} vendors. Rendering cards now...</p>
                                    </div>
                                `;
                                console.log('✅ Test message inserted directly');
                                
                                // Wait a moment then try to render actual cards
                                setTimeout(() => {
                                    console.log('🎨 Now calling renderHorizontalVendorCards...');
                                    
                                    // Bypass the debouncing and call directly with retryCount = 1
                                    isRenderingVendorCards = false; // Reset the flag
                                    renderHorizontalVendorCards(vendorSections, 1);
                                }, 500);
                            } else {
                                console.error('❌ vendor-horizontal-cards container not found');
                            }
                        }, 100);
                        
                        // Update step 3 header with match info
                        const step3Title = document.querySelector('#booking-step-3 .form-section-title');
                        if (step3Title) {
                            step3Title.textContent = `Found ${totalVendorsFound} Matching Vendors across ${vendorSections.length} Services`;
                        }
                    } else {
                        // Even with no vendors found, show the map with event location
                        console.log('No vendors found initially, but showing map with event location for exploration');
                        
                        // Initialize empty vendor sections but still show the map
                        window.bookingState.availableVendors = [];
                        window.bookingState.originalVendorSections = [];
                        
                        // Initialize map with just the event location
                        await initializeVendorMap([]);
                        
                        // Show empty vendor cards container
                        const container = document.getElementById('vendor-cards-container');
                        if (container) {
                            container.style.display = 'block';
                        }
                        
                        // Update step 3 header
                        const step3Title = document.querySelector('#booking-step-3 .form-section-title');
                        if (step3Title) {
                            step3Title.textContent = 'Explore Map to Find Vendors';
                        }
                        
                        // Show message in vendor cards area
                        const cardsContainer = document.getElementById('vendor-horizontal-cards');
                        if (cardsContainer) {
                            cardsContainer.innerHTML = `
                                <div style="text-align: center; padding: 2rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd;">
                                    <h5 style="color: var(--text); margin-bottom: 1rem;">🗺️ Explore the Map</h5>
                                    <p style="color: var(--text-light); margin-bottom: 1rem;">
                                        No vendors found in your immediate area, but you can pan and zoom the map to discover vendors nearby.
                                    </p>
                                    <p style="font-size: 0.9rem; color: var(--text-light);">
                                        Move the map around your event location to find available vendors. They'll appear here as you explore!
                                    </p>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Error finding vendors:', error);
                    document.getElementById('vendor-loading').style.display = 'none';
                    document.getElementById('no-vendors-found').style.display = 'block';
                    showError('Failed to find vendors. Please try again.');
                }
            }

            function renderVendorResults(vendors) {
                const vendorResults = document.getElementById('vendor-results');
                
                const vendorCards = vendors.map(vendor => {
                    // Fix: vendor.categories is a string, not an array
                    const vendorCategories = vendor.categories ? vendor.categories.toLowerCase() : '';
                    const services = bookingState.selectedServices.filter(service => 
                        vendorCategories.includes(service.categoryKey.toLowerCase()) ||
                        vendorCategories.includes(service.type?.toLowerCase() || '')
                    );
                    
                    // Calculate estimated price based on selected services
                    const estimatedPrice = services.reduce((sum, service) => {
                        // Use service base price if available, otherwise estimate
                        const servicePrice = service.basePrice || service.minPrice || 500;
                        return sum + servicePrice;
                    }, 0);

                    return `
                        <div class="vendor-card" data-vendor-id="${vendor.VendorProfileID || vendor.id}">
                            <div class="vendor-image">
                                <div style="width:100%;height:100%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;">
                                    ${(vendor.BusinessName || vendor.name || 'V').charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name">${vendor.BusinessName || vendor.name || 'Vendor'}</h3>
                                <div class="vendor-location">
                                    <i class="fas fa-star" style="color: #fbbf24;"></i> ${vendor.rating || '4.5'} (${vendor.reviewCount || '12'} reviews)
                                </div>
                                <div class="vendor-features">
                                    <div class="feature">
                                        <span class="feature-icon"><i class="fas fa-briefcase"></i></span>
                                        <span>${services.map(s => s.type).join(', ') || 'Multiple services'}</span>
                                    </div>
                                    <div class="feature">
                                        <span class="feature-icon"><i class="fas fa-dollar-sign"></i></span>
                                        <span class="price-indicator">$${Math.round(estimatedPrice).toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="vendor-footer" style="margin-top: 1rem;">
                                    <button class="btn btn-primary" onclick="toggleVendorSelection(${vendor.VendorProfileID || vendor.id})" style="width: 100%; padding: 0.75rem; border-radius: 12px; font-weight: 600;">
                                        Select Vendor
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                vendorResults.innerHTML = vendorCards;
            }

            // New function to render vendors grouped by category and service
            function renderSectionedVendorResults(vendorSections) {
                const vendorResults = document.getElementById('vendor-results');
                
                const sectionedHTML = vendorSections.map(section => {
                    const { category, service, vendors } = section;
                    
                    const vendorCards = vendors.map(vendor => {
                        // Get actual vendor service details from the services array returned by API
                        const vendorService = vendor.services?.find(vs => vs.ServiceName === service.name);
                        
                        // Only use database values - no hardcoded fallbacks
                        const actualPrice = vendorService?.VendorPrice;
                        const vendorDescription = vendorService?.VendorDescription;
                        const vendorDuration = vendorService?.VendorDurationMinutes;
                        
                        // Debug the full structure
                        console.log('🔍 Full vendor structure:', JSON.stringify(vendor, null, 2));
                        
                        // Extract vendor ID from the nested vendor object
                        const vendorId = vendor.vendor?.VendorProfileID || 
                                        vendor.VendorProfileID || 
                                        vendor.vendor?.id || 
                                        vendor.id ||
                                        138; // Fallback for testing
                        
                        console.log('🆔 Extracted vendorId:', vendorId);
                        console.log('🆔 vendor.vendor?.VendorProfileID:', vendor.vendor?.VendorProfileID);
                        console.log('🆔 vendor.VendorProfileID:', vendor.VendorProfileID);
                        const businessName = vendor.vendor?.BusinessName || vendor.BusinessName;
                        const location = vendor.vendor?.Location || vendor.Location; // This comes from API as "City, State"
                        const featuredImage = vendor.vendor?.FeaturedImageURL || vendor.FeaturedImageURL;
                        
                        // Debug service data
                        console.log('🔍 Service data check:');
                        console.log('  - actualPrice:', actualPrice);
                        console.log('  - vendorDescription:', vendorDescription);
                        console.log('  - vendorDuration:', vendorDuration);
                        console.log('  - vendorService:', vendorService);
                        
                        // Skip vendor if essential service data is missing
                        if (!actualPrice || !vendorDescription || !vendorDuration) {
                            console.warn(`⚠️ Skipping vendor ${vendorId} - missing service data for ${service.name}`);
                            console.warn('Missing:', {
                                actualPrice: !actualPrice,
                                vendorDescription: !vendorDescription,
                                vendorDuration: !vendorDuration
                            });
                            return '';
                        }

                        return `
                            <div class="vendor-card" data-vendor-id="${vendorId}">
                                <div class="vendor-image">
                                    ${featuredImage ? 
                                        `<img src="${featuredImage}" alt="${businessName}" style="width:100%;height:100%;object-fit:cover;">` : 
                                        `<div style="width:100%;height:100%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">${businessName.charAt(0).toUpperCase()}</div>`
                                    }
                                    <div class="vendor-badges" style="position: absolute; bottom: 12px; left: 12px; display: flex; gap: 6px;">
                                        ${(vendor.vendor?.IsPremium || vendor.IsPremium) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #5e72e4; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Premium</span>' : ''}
                                        ${(vendor.vendor?.IsEcoFriendly || vendor.IsEcoFriendly) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #38a169; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Eco-Friendly</span>' : ''}
                                        ${(vendor.vendor?.IsAwardWinning || vendor.IsAwardWinning) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #d69e2e; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Award Winning</span>' : ''}
                                    </div>
                                </div>
                                <div class="vendor-details">
                                    <h3 class="vendor-name">${businessName}</h3>
                                    <div class="vendor-location" style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">
                                        <span style="color: #888; margin-right: 0.5rem;">Location:</span>${location}
                                    </div>
                                    <div class="vendor-business-type" style="margin: 0.5rem 0; font-size: 0.85rem; color: #666; font-style: italic;">
                                        ${vendor.vendor?.BusinessType || vendor.BusinessType}
                                    </div>
                                    <div class="vendor-features" style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #3498db;">
                                        <span style="color: #2c3e50; font-size: 0.9rem;">${service.name}</span>
                                        <span style="color: #2c3e50; font-size: 0.9rem;">${Math.round(vendorDuration / 60)} hour${Math.round(vendorDuration / 60) !== 1 ? 's' : ''}</span>
                                        <span style="font-weight: 600; color: #27ae60; font-size: 0.95rem;">$${Math.round(actualPrice).toLocaleString()}</span>
                                    </div>
                                    <div class="vendor-description" style="margin: 0.75rem 0; font-size: 0.9rem; color: var(--text-light); line-height: 1.4;">
                                        ${vendorDescription.length > 100 ? vendorDescription.substring(0, 100) + '...' : vendorDescription}
                                    </div>
                                    <div class="vendor-footer">
                                        <button class="btn btn-outline view-profile-btn" onclick="event.preventDefault(); event.stopPropagation(); const baseUrl = window.location.origin + window.location.pathname; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');" style="border-radius: 12px; font-weight: 600;">View Profile</button>
                                        <button class="btn btn-primary btn-select-vendor" onclick="toggleVendorSelection('${vendorId}', '${service.name}', ${actualPrice})" style="border-radius: 12px; font-weight: 600;">
                                            Select Vendor
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).filter(card => card !== '').join(''); // Filter out empty cards

                    return `
                        <div class="vendor-section" style="margin-bottom: 3rem; border: 2px solid #e1e8f0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div class="section-header" style="background: #2c3e50; color: #ffffff; padding: 1.2rem; border-radius: 10px 10px 0 0; margin-bottom: 0; border-bottom: 3px solid #34495e;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                                            <span style="color: #3498db; font-weight: 600;">${category}</span> - ${service.name}
                                        </h4>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: #ecf0f1; opacity: 0.95;">
                                            ${vendors.filter(v => v.services?.find(vs => vs.ServiceName === service.name)).length} vendor${vendors.filter(v => v.services?.find(vs => vs.ServiceName === service.name)).length !== 1 ? 's' : ''} available | Budget: $${service.budget?.toLocaleString() || 'Not specified'}
                                        </p>
                                    </div>
                                    <div>
                                        <select class="vendor-sort-select" data-service="${service.name}" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #34495e; background: #ffffff; color: #2c3e50; font-size: 0.9rem;">
                                            <option value="recommended">Recommended</option>
                                            <option value="price-low">Price: Low to High</option>
                                            <option value="price-high">Price: High to Low</option>
                                            <option value="rating">Highest Rated</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="vendor-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; padding: 2rem; background: #ffffff; border-radius: 0 0 10px 10px;">
                                ${vendorCards}
                            </div>
                        </div>
                    `;
                }).join('');

                vendorResults.innerHTML = sectionedHTML;
                
                // Add event listeners for sorting dropdowns
                document.querySelectorAll('.vendor-sort-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const serviceName = this.dataset.service;
                        const sortValue = this.value;
                        sortVendorSection(serviceName, sortValue);
                    });
                });
            }

            // Sort vendors within a specific service section
            function sortVendorSection(serviceName, sortValue) {
                // Find the section for this service
                const section = vendorSections.find(s => s.service.name === serviceName);
                if (!section) return;

                const vendors = section.vendors.filter(vendor => {
                    const vendorService = vendor.services?.find(vs => vs.ServiceName === serviceName);
                    return vendorService?.VendorPrice && vendorService?.VendorDescription && vendorService?.VendorDurationMinutes;
                });

                switch(sortValue) {
                    case 'price-low':
                        vendors.sort((a, b) => {
                            const priceA = a.services.find(vs => vs.ServiceName === serviceName)?.VendorPrice || 0;
                            const priceB = b.services.find(vs => vs.ServiceName === serviceName)?.VendorPrice || 0;
                            return priceA - priceB;
                        });
                        break;
                    case 'price-high':
                        vendors.sort((a, b) => {
                            const priceA = a.services.find(vs => vs.ServiceName === serviceName)?.VendorPrice || 0;
                            const priceB = b.services.find(vs => vs.ServiceName === serviceName)?.VendorPrice || 0;
                            return priceB - priceA;
                        });
                        break;
                    case 'rating':
                        vendors.sort((a, b) => {
                            // Sort by premium status first, then by matching services count
                            if (a.IsPremium !== b.IsPremium) {
                                return b.IsPremium - a.IsPremium;
                            }
                            return (b.MatchingServices || 0) - (a.MatchingServices || 0);
                        });
                        break;
                    case 'recommended':
                    default:
                        // Sort by premium status, then eco-friendly, then award winning, then matching services
                        vendors.sort((a, b) => {
                            if (a.IsPremium !== b.IsPremium) return b.IsPremium - a.IsPremium;
                            if (a.IsEcoFriendly !== b.IsEcoFriendly) return b.IsEcoFriendly - a.IsEcoFriendly;
                            if (a.IsAwardWinning !== b.IsAwardWinning) return b.IsAwardWinning - a.IsAwardWinning;
                            return (b.MatchingServices || 0) - (a.MatchingServices || 0);
                        });
                        break;
                }

                // Update the section with sorted vendors
                section.vendors = vendors;
                
                // Re-render just this section
                renderSingleVendorSection(section);
            }

            // Render a single vendor section (helper function)
            function renderSingleVendorSection(section) {
                const { category, service, vendors } = section;
                
                const vendorCards = vendors.map(vendor => {
                    const vendorService = vendor.services?.find(vs => vs.ServiceName === service.name);
                    
                    const actualPrice = vendorService?.VendorPrice;
                    const vendorDescription = vendorService?.VendorDescription;
                    const vendorDuration = vendorService?.VendorDurationMinutes;
                    
                    const vendorId = vendor.VendorProfileID;
                    const businessName = vendor.BusinessName;
                    const location = vendor.Location;
                    const featuredImage = vendor.FeaturedImageURL;
                    
                    if (!actualPrice || !vendorDescription || !vendorDuration) {
                        return '';
                    }

                    return `
                        <div class="vendor-card" data-vendor-id="${vendorId}">
                            <div class="vendor-image">
                                ${featuredImage ? 
                                    `<img src="${featuredImage}" alt="${businessName}" style="width:100%;height:100%;object-fit:cover;">` : 
                                    `<div style="width:100%;height:100%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">${businessName.charAt(0).toUpperCase()}</div>`
                                }
                                <div class="vendor-badges" style="position: absolute; bottom: 12px; left: 12px; display: flex; gap: 6px;">
                                    ${vendor.IsPremium ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #5e72e4; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Premium</span>' : ''}
                                    ${vendor.IsEcoFriendly ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #38a169; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Eco-Friendly</span>' : ''}
                                    ${vendor.IsAwardWinning ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #d69e2e; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Award Winning</span>' : ''}
                                </div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name">${businessName}</h3>
                                <div class="vendor-location" style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">
                                    <span style="color: #888; margin-right: 0.5rem;">Location:</span>${location}
                                </div>
                                <div class="vendor-business-type" style="margin: 0.5rem 0; font-size: 0.85rem; color: #666; font-style: italic;">
                                    ${vendor.BusinessType}
                                </div>
                                <div class="vendor-features" style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #3498db;">
                                    <span style="color: #2c3e50; font-size: 0.9rem;">${service.name}</span>
                                    <span style="color: #2c3e50; font-size: 0.9rem;">${Math.round(vendorDuration / 60)} hour${Math.round(vendorDuration / 60) !== 1 ? 's' : ''}</span>
                                    <span style="font-weight: 600; color: #27ae60; font-size: 0.95rem;">$${Math.round(actualPrice).toLocaleString()}</span>
                                </div>
                                <div class="vendor-description" style="margin: 0.75rem 0; font-size: 0.9rem; color: var(--text-light); line-height: 1.4;">
                                    ${vendorDescription.length > 100 ? vendorDescription.substring(0, 100) + '...' : vendorDescription}
                                </div>
                                <div class="vendor-footer">
                                    <button class="btn btn-outline view-profile-btn" onclick="event.preventDefault(); event.stopPropagation(); const baseUrl = window.location.origin + window.location.pathname; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');">View Profile</button>
                                    <button class="btn btn-primary btn-select-vendor" onclick="toggleVendorSelection('${vendorId}', '${service.name}', ${actualPrice})">
                                        Select Vendor
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(card => card !== '').join('');

                // Find and update the specific section in the DOM
                const sectionElement = document.querySelector(`[data-service="${service.name}"]`).closest('.vendor-section');
                if (sectionElement) {
                    const vendorGrid = sectionElement.querySelector('.vendor-grid');
                    vendorGrid.innerHTML = vendorCards;
                }
            }

            // Function to view vendor profile in new tab
            function openVendorProfile(vendorId) {
                const baseUrl = window.location.origin + window.location.pathname;
                const profileUrl = `${baseUrl}/listings/${vendorId}`;
                console.log('Opening vendor profile:', profileUrl);
                window.open(profileUrl, '_blank');
            }

            // Legacy function - redirect to new function
            function viewVendorProfile(vendorId) {
                openVendorProfile(vendorId);
            }
            
            function viewVendorListing(vendorId) {
                viewVendorProfile(vendorId);
            }

            function toggleVendorSelection(vendorId, serviceName, servicePrice) {
                const vendorCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
                const selectButton = vendorCard.querySelector('.btn-select-vendor');
                
                const isSelected = bookingState.selectedVendors.some(v => v.id === vendorId && v.serviceName === serviceName);
                
                if (isSelected) {
                    // Deselect vendor
                    window.bookingState.selectedVendors = bookingState.selectedVendors.filter(v => !(v.id === vendorId && v.serviceName === serviceName));
                    vendorCard.classList.remove('selected');
                    selectButton.classList.remove('selected');
                    selectButton.textContent = 'Select Vendor';
                } else {
                    // Select vendor
                    const vendor = bookingState.availableVendors.find(v => (v.VendorProfileID || v.id) === vendorId);
                    if (vendor) {
                        window.bookingState.selectedVendors.push({
                            id: vendorId,
                            name: vendor.BusinessName || vendor.name,
                            serviceName: serviceName,
                            servicePrice: servicePrice,
                            vendorData: vendor
                        });
                        vendorCard.classList.add('selected');
                        selectButton.classList.add('selected');
                        selectButton.textContent = 'Selected';
                    }
                }

                // Enable/disable send requests button
                const sendRequestsBtn = document.getElementById('send-requests-btn');
                if (sendRequestsBtn) {
                    sendRequestsBtn.disabled = bookingState.selectedVendors.length === 0;
                }
                
                // Update selected vendors summary if on step 4
                updateSelectedVendorsSummary();
            }
            
            // Function to render selected vendors summary on Step 4
            window.updateSelectedVendorsSummary = function updateSelectedVendorsSummary() {
                const summaryContainer = document.getElementById('selected-vendors-summary');
                if (!summaryContainer) return;
                
                // Always use the global bookingState
                const globalBookingState = window.bookingState || { selectedVendors: [] };
                
                console.log('🔄 Updating selected vendors summary, count:', globalBookingState.selectedVendors?.length || 0);
                console.log('🔄 globalBookingState:', globalBookingState);
                console.log('🔄 selectedVendors array:', globalBookingState.selectedVendors);
                
                if (!globalBookingState.selectedVendors || globalBookingState.selectedVendors.length === 0) {
                    summaryContainer.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No vendors selected yet.</p>';
                    return;
                }
                
                const totalCost = globalBookingState.selectedVendors.reduce((sum, v) => {
                    const price = v.selectedService?.VendorPrice || v.VendorPrice || v.servicePrice || 0;
                    return sum + price;
                }, 0);

                // Build Step 3-style horizontal cards for selected vendors
                const vendorCardsHTML = `
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin: 0 0 1.5rem 0; color: #2c3e50; font-weight: 600; font-size: 1.3rem;">Selected Vendors - Send Booking Requests</h5>

                        <!-- Per-vendor special requests are now in each card's right panel -->

                        <!-- Horizontal vendor cards (same style as Step 3) -->
                        <div id="selected-vendor-horizontal-cards" class="vendor-horizontal-container">
                            ${globalBookingState.selectedVendors.map((entry, index) => {
                                // Prefer full vendor object if stored; otherwise resolve from availableVendors
                                const av = (window.bookingState && Array.isArray(window.bookingState.availableVendors)) ? window.bookingState.availableVendors : [];
                                const entryId = entry.VendorProfileID || entry.vendorProfileId || entry.vendorId || entry.id;
                                const resolved = av.find(v => {
                                    const vId = v.VendorProfileID || v.vendorProfileId || v.id;
                                    return String(vId) === String(entryId);
                                });
                                // Merge precedence: resolved vendor data > entry.vendorData > entry (to keep selection fields too)
                                const base = { ...(entry || {}), ...(entry.vendorData || {}), ...(resolved || {}) };

                                // Resolve vendor id consistently and ensure not empty (needed for carousel ids)
                                let vendorId = base.VendorProfileID || base.vendorProfileId || base.id || entry.vendorId || entry.id;
                                if (!vendorId) {
                                    vendorId = `selected-${index}`;
                                }

                                // Normalize core fields for the card
                                const normalized = {
                                    ...base,
                                    // IDs for createHorizontalVendorCard and data-vendor-id
                                    // Use unique VendorProfileID for Step 4 to avoid ID collisions with Step 3 carousels
                                    id: base.id || entry.id || entry.vendorId || vendorId,
                                    vendorProfileId: (base.vendorProfileId || base.VendorProfileID || entry.vendorId || vendorId) + '-s4',
                                    VendorProfileID: (base.VendorProfileID || base.vendorProfileId || entry.vendorId || vendorId) + '-s4',
                                    __realVendorId: vendorId,
                                    // Core display fields
                                    BusinessName: base.BusinessName || base.businessName || base.name || entry.name || 'Unknown Business',
                                    Location: base.Location || base.location || entry.location || '',
                                    BusinessDescription: base.BusinessDescription || base.description || entry.description || '',
                                };

                                // Normalize images so carousel can render (gather from many possible fields)
                                const images = [];
                                const pushIf = (val) => { if (val && typeof val === 'string') images.push(val.trim()); };
                                const urlFrom = (obj) => {
                                    if (!obj) return null;
                                    if (typeof obj === 'string') return obj;
                                    const cand = obj.ImageURL || obj.ImageUrl || obj.URL || obj.Url || obj.url || obj.src || obj.image || obj.Path || obj.ImagePath || obj.path;
                                    return typeof cand === 'string' ? cand : null;
                                };
                                // Common fields
                                pushIf(base.FeaturedImageURL || base.featuredImageUrl || base.profileImageUrl || base.ProfileImageUrl || base.ProfileImageURL);
                                if (Array.isArray(base.images)) images.push(...base.images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
                                if (Array.isArray(base.Images)) images.push(...base.Images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
                                if (Array.isArray(base.VendorImages)) images.push(...base.VendorImages.map(img => urlFrom(img)).filter(Boolean));
                                if (Array.isArray(base.GalleryImages)) images.push(...base.GalleryImages.map(img => urlFrom(img)).filter(Boolean));
                                if (Array.isArray(base.Photos)) images.push(...base.Photos.map(img => urlFrom(img)).filter(Boolean));
                                if (Array.isArray(base.photoUrls)) images.push(...base.photoUrls);
                                // Comma-separated string of URLs
                                if (typeof base.ImageURLs === 'string') {
                                    images.push(...base.ImageURLs.split(',').map(s => s.trim()));
                                }
                                if (typeof base.imageUrls === 'string') {
                                    images.push(...base.imageUrls.split(',').map(s => s.trim()));
                                }
                                // Individual fields image1..image5
                                ['image1','image2','image3','image4','image5','Image1','Image2','Image3','Image4','Image5'].forEach(k => {
                                    if (base[k]) images.push(base[k]);
                                });
                                // De-duplicate
                                normalized.images = [...new Set(images.filter(Boolean))];
                                console.log('🖼️ Step 4 images collected for vendor', vendorId, normalized.images);
                                if (!normalized.FeaturedImageURL && normalized.images.length > 0) {
                                    normalized.FeaturedImageURL = normalized.images[0];
                                }

                                // Ensure services include the selected service and price (robust inference)
                                let inferredService = null;
                                // 1) Direct selectedService from selection flow
                                if (entry.selectedService && (entry.selectedService.ServiceName || entry.selectedService.ServiceID)) {
                                    inferredService = {
                                        ServiceName: entry.selectedService.ServiceName || entry.serviceName,
                                        VendorPrice: entry.selectedService.VendorPrice ?? entry.selectedService.Price ?? entry.servicePrice ?? entry.price ?? 0,
                                        VendorDurationMinutes: entry.selectedService.VendorDurationMinutes
                                    };
                                } else {
                                    // 2) From flat fields captured during selection
                                    const selName = entry.serviceName || (Array.isArray(entry.MatchingServiceNames) ? entry.MatchingServiceNames[0] : (typeof entry.MatchingServiceNames === 'string' ? entry.MatchingServiceNames.split(',')[0]?.trim() : undefined)) || (Array.isArray(base.MatchingServiceNames) ? base.MatchingServiceNames[0] : undefined);
                                    // Try to find matching service in base.services by name
                                    let matchFromBase = null;
                                    if (Array.isArray(base.services) && base.services.length > 0) {
                                        if (selName) {
                                            matchFromBase = base.services.find(s => (s.ServiceName || '').toLowerCase() === selName.toLowerCase());
                                        }
                                        // If not found, fallback to first service
                                        if (!matchFromBase) matchFromBase = base.services[0];
                                    }
                                    const selPrice = entry.servicePrice ?? entry.price ?? matchFromBase?.VendorPrice ?? base.totalEstimatedCost ?? 0;
                                    const selDuration = matchFromBase?.VendorDurationMinutes;
                                    const finalName = selName || matchFromBase?.ServiceName || 'Selected Service';
                                    inferredService = { ServiceName: finalName, VendorPrice: selPrice, VendorDurationMinutes: selDuration };
                                }

                                // Prepend inferred service to services array
                                if (inferredService) {
                                    const existing = Array.isArray(base.services) ? base.services : [];
                                    normalized.services = [inferredService, ...existing];
                                } else if (Array.isArray(base.services)) {
                                    normalized.services = base.services;
                                }

                                // Provide service names for tags if missing
                                if (!normalized.MatchingServiceNames) {
                                    const names = [];
                                    if (normalized.services && normalized.services.length > 0) {
                                        normalized.services.forEach(s => s?.ServiceName && names.push(s.ServiceName));
                                    } else if (entry.serviceName) {
                                        names.push(entry.serviceName);
                                    }
                                    if (names.length > 0) normalized.MatchingServiceNames = names;
                                }

                                const card = (typeof createHorizontalVendorCard === 'function') ? createHorizontalVendorCard(normalized) : '';
                                return `
                                    <div class="selected-vendor-card-wrapper" data-selected-index="${index}" style="display:flex; gap:1rem; align-items:stretch;">
                                        <div class="selected-vendor-card-left" style="flex:1; position:relative;">
                                            ${card}
                                        </div>
                                        <div class="selected-vendor-actions-right" style="width:320px; min-width:300px; background:#f8faff; border:1px solid #e1e8f0; border-radius:12px; padding:1rem; display:flex; flex-direction:column; gap:0.75rem;">
                                            <h6 style="margin:0; color:#2c3e50; font-weight:600;">Special Request</h6>
                                            <textarea id="special-requests-${index}" placeholder="Write a message to this vendor..." style="flex:1; min-height:120px; padding:0.75rem; border:1px solid #e1e8f0; border-radius:8px; font-family:inherit; font-size:0.9rem; resize:vertical;"></textarea>
                                            <button onclick="sendBookingRequest('${vendorId}', ${index})"
                                                class="btn-send-request"
                                                style="background:#3498db; color:white; border:none; padding:0.6rem 1rem; border-radius:8px; font-weight:600; cursor:pointer;">
                                                <i class="fas fa-paper-plane" style="margin-right:0.4rem;"></i>Send Request
                                            </button>
                                            <div class="request-status" id="request-status-${index}" style="display:none; padding:0.6rem; border-radius:8px;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Summary Footer -->
                        <div style="background: #f8faff; border: 1px solid #e1e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; margin-top:1rem;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem;">
                                Total Estimated Cost: <span style="color: #27ae60;">$${Math.round(totalCost).toLocaleString()}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-light);">
                                ${globalBookingState.selectedVendors.length} vendor${globalBookingState.selectedVendors.length !== 1 ? 's' : ''} selected
                            </div>
                        </div>
                    </div>
                `;

                summaryContainer.innerHTML = vendorCardsHTML;

                // Initialize carousels for the newly injected cards in Step 4
                setTimeout(() => {
                    try {
                        const vendorCards = document.querySelectorAll('#selected-vendor-horizontal-cards .vendor-horizontal-card');
                        vendorCards.forEach(card => {
                            const vendorId = card.getAttribute('data-vendor-id');
                            // Remove only the Select/Selected button that toggles vendor selection
                            const toggleBtn = card.querySelector('button[onclick*="toggleVendorSelection"]');
                            if (toggleBtn) {
                                toggleBtn.parentElement?.removeChild(toggleBtn);
                            }
                            // Initialize carousel
                            if (vendorId && typeof initializeVendorCarousel === 'function') {
                                initializeVendorCarousel(vendorId);
                            }
                        });
                    } catch (e) {
                        console.warn('Step 4 post-processing failed:', e);
                    }
                }, 100);
            };

            // Function to send booking request to vendor
            window.sendBookingRequest = function(vendorId, vendorIndex) {
                console.log('📤 Sending booking request to vendor:', vendorId, 'at index:', vendorIndex);
                
                // Check if user is authenticated
                console.log('🔐 Current user:', currentUser);
                
                if (!currentUser || !currentUser.userId) {
                    console.log('❌ User not authenticated, showing auth modal');
                    showAuthModal();
                    return;
                }
                
                console.log('✅ User authenticated, proceeding with request');
                
                // Read per-vendor special requests textarea, fallback to global if present (legacy)
                const perVendorTextarea = document.getElementById(`special-requests-${vendorIndex}`);
                const specialRequests = perVendorTextarea?.value || document.getElementById('special-requests')?.value || '';
                const bookingState = window.bookingState;
                const vendor = bookingState.selectedVendors[vendorIndex];
                
                if (!vendor) {
                    console.error('❌ Vendor not found at index:', vendorIndex);
                    return;
                }
                
                // Update button state to loading
                const button = document.querySelector(`button[onclick="sendBookingRequest('${vendorId}', ${vendorIndex})"]`);
                if (button) {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Sending...';
                    button.disabled = true;
                    button.style.background = '#95a5a6';
                }
                
                // Show status area
                const statusDiv = document.getElementById(`request-status-${vendorIndex}`);
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<div style="color: #3498db;"><i class="fas fa-clock" style="margin-right: 0.5rem;"></i>Sending request...</div>';
                    statusDiv.style.background = '#e8f4fd';
                    statusDiv.style.border = '1px solid #3498db';
                }
                
                // Collect current event details from form (mimicking handleSendRequests)
                const eventDetails = {
                    date: document.getElementById('event-date')?.value,
                    startTime: document.getElementById('event-start-time')?.value,
                    endTime: document.getElementById('event-end-time')?.value,
                    location: document.getElementById('event-location')?.value,
                    attendeeCount: parseInt(document.getElementById('attendee-count')?.value) || 50
                };

                // Format time for backend (mimicking handleSendRequests)
                const formattedTime = formatTimeForBackend(eventDetails.startTime);

                // Prepare booking request data
                const requestData = {
                    userId: currentUser.userId || currentUser.id,
                    vendorIds: [parseInt(vendorId)],
                    services: vendor.selectedService ? [{
                        vendorId: parseInt(vendorId),
                        serviceName: vendor.selectedService.ServiceName || 'General Service',
                        servicePrice: vendor.selectedService.VendorPrice || 0
                    }] : [],
                    eventDetails: {
                        ...eventDetails,
                        time: formattedTime,
                        specialRequests: specialRequests
                    },
                    budget: vendor.selectedService?.VendorPrice || 0
                };
                
                console.log('📋 Request data:', requestData);
                console.log('🌐 About to make API call to:', 'https://bdb-3-0-venuevue-api.onrender.com/api/bookings/requests');
                
                // Make actual API call
                fetch('https://bdb-3-0-venuevue-api.onrender.com/api/bookings/requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token || ''}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('📡 API Response received:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 API Response data:', data);
                    if (data.success) {
                        // Success
                        if (button) {
                            button.innerHTML = '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>Request Sent!';
                            button.style.background = '#27ae60';
                            button.disabled = true;
                        }
                        
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <div style="color: #27ae60;">
                                    <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                                    Booking request sent successfully! Request ID: ${data.requestId}. The vendor will respond within 24 hours.
                                </div>
                            `;
                            statusDiv.style.background = '#d5f4e6';
                            statusDiv.style.border = '1px solid #27ae60';
                        }
                        
                        // Mark vendor as requested in bookingState
                        vendor.requestSent = true;
                        vendor.requestTimestamp = new Date().toISOString();
                        vendor.requestId = data.requestId;
                        
                    } else {
                        throw new Error(data.message || 'Failed to send request');
                    }
                })
                .catch(error => {
                    console.error('❌ Error sending request:', error);
                    
                    // Error state
                    if (button) {
                        button.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>Try Again';
                        button.style.background = '#e74c3c';
                        button.disabled = false;
                    }
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div style="color: #e74c3c;">
                                <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
                                Failed to send request: ${error.message}
                            </div>
                        `;
                        statusDiv.style.background = '#fdf2f2';
                        statusDiv.style.border = '1px solid #e74c3c';
                    }
                });
            };

            // Authentication helper functions
            function getCurrentUser() {
                // Check for user session in localStorage or sessionStorage
                const userSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
                console.log('🔍 Raw userSession from localStorage:', userSession);
                console.log('🔍 localStorage.getItem("userSession"):', localStorage.getItem('userSession'));
                
                if (userSession) {
                    try {
                        const parsed = JSON.parse(userSession);
                        console.log('✅ Parsed user session:', parsed);
                        return parsed;
                    } catch (e) {
                        console.error('❌ Error parsing user session:', e);
                        return null;
                    }
                }
                console.log('❌ No user session found');
                return null;
            }

            function showAuthModal() {
                // Create authentication modal
                const authModal = document.createElement('div');
                authModal.id = 'auth-modal';
                authModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                authModal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;">
                        <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">Sign In Required</h3>
                        <p style="margin: 0 0 1.5rem 0; color: #6b7280;">You need to sign in to send booking requests to vendors.</p>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="showLoginForm()" style="background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Sign In
                            </button>
                            <button onclick="showSignupForm()" style="background: #27ae60; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Sign Up
                            </button>
                            <button onclick="closeAuthModal()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(authModal);
            }

            window.closeAuthModal = function() {
                const authModal = document.getElementById('auth-modal');
                if (authModal) {
                    authModal.remove();
                }
            };

            window.showLoginForm = function() {
                closeAuthModal();
                // Redirect to login page or show login form
                alert('Please implement login functionality. For now, you can manually set user session in localStorage.');
                console.log('To test booking requests, set user session in console:');
                console.log('localStorage.setItem("userSession", JSON.stringify({userId: 1, token: "test-token", name: "Test User"}))');
            };

            window.showSignupForm = function() {
                closeAuthModal();
                // Redirect to signup page or show signup form
                alert('Please implement signup functionality. For now, you can manually set user session in localStorage.');
                console.log('To test booking requests, set user session in console:');
                console.log('localStorage.setItem("userSession", JSON.stringify({userId: 1, token: "test-token", name: "Test User"}))');
            };

            // Helper function to format time to HH:MM:SS
            function formatTimeForBackend(timeStr) {
                if (!timeStr) return '12:00:00'; // Default to noon if no time provided
                
                // If time is already in HH:MM:SS format, return as is
                if (timeStr.match(/^\d{2}:\d{2}:\d{2}$/)) {
                    return timeStr;
                }
                
                // If time is in HH:MM format, add seconds
                if (timeStr.match(/^\d{1,2}:\d{2}$/)) {
                    const [hours, minutes] = timeStr.split(':');
                    return `${hours.padStart(2, '0')}:${minutes}:00`;
                }
                
                // Fallback to default time
                return '12:00:00';
            }

            // Booking-specific error handler
            function showBookingError(message) {
                const errorContainer = document.getElementById('booking-error-container') || createBookingErrorContainer();
                errorContainer.innerHTML = `
                    <div class="alert alert-error" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; color: var(--accent);">
                        <strong>Error:</strong> ${message}
                    </div>
                `;
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function createBookingErrorContainer() {
                const container = document.createElement('div');
                container.id = 'booking-error-container';
                const modalBody = document.querySelector('#booking-modal .modal-body');
                modalBody.insertBefore(container, modalBody.firstChild);
                return container;
            }

            function clearBookingError() {
                const errorContainer = document.getElementById('booking-error-container');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }

            async function handleSendRequests() {
                clearBookingError();
                
                // Collect current event details from form before validation
                const eventDetails = {
                    date: document.getElementById('event-date')?.value,
                    startTime: document.getElementById('event-start-time')?.value,
                    endTime: document.getElementById('event-end-time')?.value,
                    location: document.getElementById('event-location')?.value,
                    attendeeCount: parseInt(document.getElementById('attendee-count')?.value) || 50
                };
                
                // Use the global bookingState where vendors are actually stored
                const globalBookingState = window.bookingState || bookingState;
                
                // Update event details in global state
                if (!globalBookingState.eventDetails) {
                    globalBookingState.eventDetails = {};
                }
                Object.assign(globalBookingState.eventDetails, eventDetails);
                
                console.log('🔍 Debug - globalBookingState:', globalBookingState);
                console.log('🔍 Debug - selectedVendors:', globalBookingState.selectedVendors);
                console.log('🔍 Debug - selectedVendors length:', globalBookingState.selectedVendors?.length);
                console.log('🔍 Debug - eventDetails:', globalBookingState.eventDetails);
                console.log('🔍 Debug - startTime:', globalBookingState.eventDetails?.startTime);
                
                // Debug each selected vendor structure
                globalBookingState.selectedVendors?.forEach((vendor, index) => {
                    console.log(`🔍 Debug - vendor[${index}]:`, vendor);
                    console.log(`🔍 Debug - vendor[${index}].id:`, vendor.id);
                    console.log(`🔍 Debug - vendor[${index}].vendorData:`, vendor.vendorData);
                    console.log(`🔍 Debug - vendor[${index}].vendorData?.VendorProfileID:`, vendor.vendorData?.VendorProfileID);
                });
                
                if (!globalBookingState.selectedVendors || globalBookingState.selectedVendors.length === 0) {
                    showBookingError('Please select at least one vendor.');
                    return;
                }

                // Check if user is authenticated
                if (!currentUser?.userId && !currentUser?.id) {
                    showBookingError('Please log in to send booking requests. Run this in console: localStorage.setItem("token", "test-token")');
                    return;
                }

                // Validate and format time
                if (!globalBookingState.eventDetails?.startTime) {
                    console.log('🚨 Event time validation failed - eventDetails:', globalBookingState.eventDetails);
                    console.log('🚨 Start time value:', globalBookingState.eventDetails?.startTime);
                    showBookingError('Please select an event time.');
                    return;
                }

                const formattedTime = formatTimeForBackend(globalBookingState.eventDetails.startTime);

                try {
                    // Prepare vendor IDs and services data
                    const vendorIds = globalBookingState.selectedVendors
                        .map(v => v.VendorProfileID || v.vendorProfileId || v.VendorProfileId || v.id || v.vendorId)
                        .filter(id => id != null);
                    
                    const services = globalBookingState.selectedVendors.map(v => ({
                        vendorId: v.VendorProfileID || v.vendorProfileId || v.VendorProfileId || v.id || v.vendorId,
                        serviceName: v.selectedService?.ServiceName || v.serviceName || v.MatchingServiceNames || 'General Service',
                        servicePrice: v.selectedService?.VendorPrice || v.servicePrice || v.VendorPrice || 0
                    })).filter(s => s.vendorId != null);

                    console.log('🔍 Debug - vendorIds:', vendorIds);
                    console.log('🔍 Debug - services:', services);

                    if (vendorIds.length === 0) {
                        showBookingError('No valid vendor IDs found. Please reselect your vendors.');
                        return;
                    }

                    // Send booking requests to backend API
                    const requestData = {
                        userId: currentUser.userId || currentUser.id,
                        vendorIds: vendorIds,
                        services: services,
                        eventDetails: {
                            ...globalBookingState.eventDetails,
                            time: formattedTime
                        },
                        budget: globalBookingState.budget
                    };

                    console.log('📤 Sending bulk booking request:', requestData);
                    
                    const response = await fetch(`${API_BASE_URL}/bookings/requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    const data = await response.json();
                    console.log('📊 API Response:', data);

                    if (data.success && data.requests) {
                        // Map API response to booking state format
                        globalBookingState.sentRequests = data.requests.map(req => ({
                            id: req.requestId,
                            vendorId: req.vendorId,
                            vendorName: globalBookingState.selectedVendors.find(v => v.id === req.vendorId)?.name || 'Vendor',
                            status: req.status,
                            sentAt: new Date(req.createdAt),
                            expiresAt: new Date(req.expiresAt),
                            services: globalBookingState.selectedServices,
                            eventDetails: globalBookingState.eventDetails
                        }));

                        renderRequestSummary();
                        updateBookingStep(5);
                        
                        // Start polling for approval updates
                        startApprovalPolling();
                    } else {
                        throw new Error(data.message || 'Failed to send requests');
                    }

                } catch (error) {
                    console.error('Error sending requests:', error);
                    showBookingError('Failed to send booking requests. Please try again.');
                }
            }

            function renderRequestSummary() {
                const requestSummary = document.getElementById('request-summary');
                
                const summaryHtml = bookingState.sentRequests.map(request => `
                    <div class="request-item">
                        <div class="request-header">
                            <h5>${request.vendorName}</h5>
                            <span class="request-status ${request.status}">${request.status.toUpperCase()}</span>
                        </div>
                        <p><strong>Services:</strong> ${request.services.map(s => s.type).join(', ')}</p>
                        <p><strong>Event Date:</strong> ${request.eventDetails.date} at ${request.eventDetails.time}</p>
                        <div class="countdown-timer" id="timer-${request.id}">
                            <span><i class="fas fa-clock"></i></span>
                            <span>Expires in: <span class="time-remaining">24:00:00</span></span>
                        </div>
                    </div>
                `).join('');

                requestSummary.innerHTML = summaryHtml;

                // Start countdown timers
                window.bookingState.sentRequests.forEach(request => {
                    startCountdownTimer(request.id, request.expiresAt);
                });
            }

            function startCountdownTimer(requestId, expiresAt) {
                const timerElement = document.getElementById(`timer-${requestId}`);
                if (!timerElement) return;

                const timer = setInterval(() => {
                    const now = new Date().getTime();
                    const expiry = new Date(expiresAt).getTime();
                    const timeLeft = expiry - now;

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        const timeDisplay = timerElement.querySelector('.time-remaining');
                        if (timeDisplay) {
                            timeDisplay.textContent = 'EXPIRED';
                            timerElement.classList.add('urgent');
                        }
                        return;
                    }

                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                    const timeDisplay = timerElement.querySelector('.time-remaining');
                    if (timeDisplay) {
                        timeDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Add urgent class if less than 2 hours remaining
                        if (timeLeft < 2 * 60 * 60 * 1000) {
                            timerElement.classList.add('urgent');
                        }
                    }
                }, 1000);

                window.bookingState.countdownTimers[requestId] = timer;
            }

            // Approval polling and real-time updates
            function startApprovalPolling() {
                // Poll for approval updates every 30 seconds
                const pollInterval = setInterval(async () => {
                    if (bookingState.currentStep !== 5 && bookingState.currentStep !== 4) {
                        clearInterval(pollInterval);
                        return;
                    }

                    try {
                        await checkApprovalUpdates();
                    } catch (error) {
                        console.error('Error polling for approvals:', error);
                    }
                }, 30000);

                // Store interval for cleanup
                window.bookingState.approvalPollingInterval = pollInterval;
            }

            async function checkApprovalUpdates() {
                if (!currentUser?.id) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/bookings/requests/${currentUser.id}`);
                    const data = await response.json();
                    console.log('📊 API Response:', data);

                    if (data.success && data.requests) {
                        // Update request statuses
                        window.bookingState.sentRequests.forEach(sentRequest => {
                            const updatedRequest = data.requests.find(r => r.RequestID === sentRequest.id);
                            if (updatedRequest && updatedRequest.Status !== sentRequest.status) {
                                sentRequest.status = updatedRequest.Status;
                                sentRequest.responseMessage = updatedRequest.ResponseMessage;
                                sentRequest.proposedPrice = updatedRequest.ProposedPrice;
                            }
                        });

                        // Update approved vendors
                        window.bookingState.approvedVendors = bookingState.sentRequests
                            .filter(req => req.status === 'approved')
                            .map(req => ({
                                id: req.vendorId,
                                name: req.vendorName,
                                proposedPrice: req.proposedPrice || 0,
                                services: req.services
                            }));

                        // Calculate total cost
                        window.bookingState.totalCost = bookingState.approvedVendors.reduce((sum, vendor) => 
                            sum + (vendor.proposedPrice || 0), 0
                        );

                        // Update UI if on approval step
                        if (bookingState.currentStep === 5) {
                            renderApprovalStatus();
                        }

                        // Check if we can proceed to payment
                        const hasAllApprovals = bookingState.approvedVendors.length > 0;
                        const proceedButton = document.getElementById('proceed-to-payment');
                        if (proceedButton) {
                            proceedButton.disabled = !hasAllApprovals;
                        }
                    }
                } catch (error) {
                    console.error('Error checking approval updates:', error);
                }
            }

            function renderApprovalStatus() {
                const approvalStatus = document.getElementById('approval-status');
                if (!approvalStatus) return;

                const statusHtml = bookingState.sentRequests.map(request => {
                    const statusClass = request.status === 'approved' ? 'approved' : 
                                       request.status === 'declined' ? 'declined' : 'pending';
                    
                    const timeRemaining = request.status === 'pending' ? 
                        getTimeRemaining(request.expiresAt) : null;

                    return `
                        <div class="request-item">
                            <div class="request-header">
                                <h5>${request.vendorName}</h5>
                                <span class="request-status ${statusClass}">
                                    ${request.status === 'approved' ? '<i class="fas fa-check-circle" style="color: #28a745;"></i> APPROVED' : 
                                      request.status === 'declined' ? '<i class="fas fa-times-circle" style="color: #dc3545;"></i> DECLINED' : 
                                      '<i class="fas fa-clock" style="color: #ffc107;"></i> PENDING'}
                                </span>
                            </div>
                            <p><strong>Services:</strong> ${request.services.map(s => s.type).join(', ')}</p>
                            ${request.proposedPrice ? `<p><strong>Proposed Price:</strong> $${request.proposedPrice.toLocaleString()}</p>` : ''}
                            ${request.responseMessage ? `<p><strong>Message:</strong> ${request.responseMessage}</p>` : ''}
                            ${timeRemaining ? `
                                <div class="countdown-timer ${timeRemaining.urgent ? 'urgent' : ''}">
                                    <span><i class="fas fa-clock"></i></span>
                                    <span>Expires in: ${timeRemaining.display}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                approvalStatus.innerHTML = statusHtml;
            }

            function getTimeRemaining(expiresAt) {
                const now = new Date().getTime();
                const expiry = new Date(expiresAt).getTime();
                const timeLeft = expiry - now;

                if (timeLeft <= 0) {
                    return { display: 'EXPIRED', urgent: true };
                }

                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                return {
                    display: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
                    urgent: timeLeft < 2 * 60 * 60 * 1000 // Less than 2 hours
                };
            }

            async function handleCompleteBooking() {
                try {
                    if (bookingState.approvedVendors.length === 0) {
                        showError('No approved vendors to book.');
                        return;
                    }

                    // Create payment intent with Stripe
                    const response = await fetch(`${API_BASE_URL}/bookings/create-payment-intent`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: bookingState.totalCost,
                            currency: 'usd'
                        })
                    });

                    const data = await response.json();

                    if (data.clientSecret) {
                        // Initialize Stripe Elements for payment
                        if (state.stripe && state.elements) {
                            const cardElement = state.elements.create('card');
                            cardElement.mount('#card-element');

                            // Handle form submission
                            const { error, paymentIntent } = await state.stripe.confirmCardPayment(data.clientSecret, {
                                payment_method: {
                                    card: cardElement,
                                    billing_details: {
                                        name: currentUser?.name || 'Customer'
                                    }
                                }
                            });

                            if (error) {
                                showError(`Payment failed: ${error.message}`);
                            } else if (paymentIntent.status === 'succeeded') {
                                // Create final bookings
                                await createFinalBookings(paymentIntent.id);
                                showSuccess('Booking completed successfully! You will receive confirmation emails shortly.');
                                closeBookingModal();
                            }
                        } else {
                            // Fallback to default categories if API fails
                            console.log('Processing payment:', { amount: bookingState.totalCost });
                            showSuccess('Booking completed successfully! You will receive confirmation emails shortly.');
                            closeBookingModal();
                        }
                    } else {
                        throw new Error('Failed to create payment intent');
                    }

                } catch (error) {
                    console.error('Error completing booking:', error);
                    showBookingError('Failed to complete booking. Please try again.');
                }
            }

            async function createFinalBookings(paymentIntentId) {
                // Create final bookings for approved vendors
                const bookingPromises = bookingState.approvedVendors.map(vendor => {
                    return fetch(`${API_BASE_URL}/bookings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            vendorProfileId: vendor.id,
                            eventDate: bookingState.eventDetails.date,
                            endDate: bookingState.eventDetails.date, // Same day for now
                            attendeeCount: bookingState.eventDetails.attendeeCount,
                            specialRequests: bookingState.eventDetails.specialRequests,
                            services: vendor.services,
                            paymentIntentId: paymentIntentId
                        })
                    });
                });

                await Promise.all(bookingPromises);
            }

            function renderBookingSummary() {
                const bookingSummary = document.getElementById('booking-summary');
                if (!bookingSummary || bookingState.approvedVendors.length === 0) return;

                const summaryHtml = `
                    <div class="booking-summary-card">
                        <h5 style="margin-bottom: 1rem; color: var(--primary);">Booking Summary</h5>
                        
                        <div class="summary-row">
                            <span>Event Date:</span>
                            <span>${bookingState.eventDetails.date} at ${bookingState.eventDetails.time}</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Location:</span>
                            <span>${bookingState.eventDetails.location || 'TBD'}</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Attendees:</span>
                            <span>${bookingState.eventDetails.attendeeCount}</span>
                        </div>
                        
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">
                        
                        <h6 style="margin-bottom: 0.5rem; color: var(--primary);">Confirmed Vendors:</h6>
                        ${bookingState.approvedVendors.map(vendor => `
                            <div class="summary-row">
                                <span>${vendor.name}</span>
                                <span>$${vendor.proposedPrice?.toLocaleString() || '0'}</span>
                            </div>
                        `).join('')}
                        
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">
                        
                        <div class="summary-row">
                            <span><strong>Total Cost:</strong></span>
                            <span><strong>$${bookingState.totalCost.toLocaleString()}</strong></span>
                        </div>
                    </div>
                `;

                bookingSummary.innerHTML = summaryHtml;
            }

            // Override updateBookingStep to handle step-specific logic
            const originalUpdateBookingStep = updateBookingStep;
            updateBookingStep = function(step) {
                originalUpdateBookingStep(step);
                
                // Step-specific logic
                if (step === 5) {
                    renderApprovalStatus();
                } else if (step === 6) {
                    renderBookingSummary();
                }
                
                // Clean up polling when leaving approval steps
                if (step !== 4 && step !== 5 && bookingState.approvalPollingInterval) {
                    clearInterval(bookingState.approvalPollingInterval);
                    window.bookingState.approvalPollingInterval = null;
                }
            };

            // Override closeBookingModal to clean up polling
            const originalCloseBookingModal = closeBookingModal;
            closeBookingModal = function() {
                if (bookingState.approvalPollingInterval) {
                    clearInterval(bookingState.approvalPollingInterval);
                    window.bookingState.approvalPollingInterval = null;
                }
                originalCloseBookingModal();
                // Make socket globally available
                window.socket = state.socket;
                
                // Set up global Socket.IO event listeners for new chat system
                window.socket.on('new-message', (messageData) => {
                    console.log('Global: Received new message via Socket.IO:', messageData);
                    if (messageData.conversationId === currentConversation?.id) {
                        addMessageToUI(messageData);
                    }
                    // Update conversation list with new message
                    updateConversationInList(messageData);
                });
            };

            // Make functions globally available
        window.openBookingModal = openBookingModal;
        // toggleVendorSelection will be defined later in the file
            
            // New router-like functionality for SPA
            let isInitialLoad = true;
            function handleUrlChange() {
                console.log('🔄 handleUrlChange called');
                console.log('🔄 Current URL:', window.location.href);
                console.log('🔄 Current hash:', window.location.hash);
                console.log('🔄 Current pathname:', window.location.pathname);
                console.log('🔄 isInitialLoad:', isInitialLoad);
                
                // Check both hash-based and path-based routing
                const hashPath = window.location.hash.substring(1);
                const pathname = window.location.pathname;
                
                let vendorId = null;
                let shouldUpdateHash = false;
                
                // Check hash-based routing first (e.g., #/listings/144)
                if (hashPath.startsWith('/listings/')) {
                    vendorId = hashPath.split('/')[2];
                    console.log('🔄 Found vendor ID from hash:', vendorId);
                }
                // Check path-based routing (e.g., /listings/144)
                else if (pathname.includes('/listings/')) {
                    const pathParts = pathname.split('/');
                    const listingIndex = pathParts.findIndex(part => part === 'listings');
                    if (listingIndex !== -1 && pathParts[listingIndex + 1]) {
                        vendorId = pathParts[listingIndex + 1];
                        shouldUpdateHash = true;
                        console.log('🔄 Found vendor ID from path:', vendorId);
                    }
                }
                
                // Check DOM elements
                console.log('🔄 mainAppView exists:', !!mainAppView);
                console.log('🔄 vendorProfilePage exists:', !!vendorProfilePage);
                
                if (vendorId) {
                    console.log(`🔗 Loading vendor profile for ID: ${vendorId}`);
                    
                    // Update hash only after successful profile load to prevent redirect loops
                    if (shouldUpdateHash && !isInitialLoad) {
                        console.log('🔄 Updating hash for subsequent navigation');
                        window.history.replaceState(null, null, `${window.location.origin}${window.location.pathname}#/listings/${vendorId}`);
                    } else if (shouldUpdateHash && isInitialLoad) {
                        console.log('🔄 Setting hash for initial load');
                        // For initial load, set hash without triggering navigation
                        window.location.hash = `/listings/${vendorId}`;
                    }
                    
                    showVendorProfilePage(vendorId);
                } else {
                    console.log('🔄 No vendor ID found, showing main app');
                    showMainApp();
                }
                
                // Mark that initial load is complete
                isInitialLoad = false;
            }

            function showMainApp() {
                console.log('🏠 showMainApp called');
                if (mainAppView) {
                    mainAppView.style.display = 'grid';
                    console.log('🏠 mainAppView shown');
                } else {
                    console.error('❌ mainAppView not found');
                }
                
                if (vendorProfilePage) {
                    vendorProfilePage.style.display = 'none';
                    console.log('🏠 vendorProfilePage hidden');
                } else {
                    console.error('❌ vendorProfilePage not found');
                }
                
                // Dashboards are now in a modal, so we don't hide them here
                // The modal's own close button will handle hiding it.
                if (window.location.hash !== '') {
                    window.location.hash = '';
                }
                document.body.style.overflow = 'auto';
            }

            // Load categories from API
            async function loadCategories() {
                try {
                    // In a real app, you would fetch categories from your API
                    // For now, we'll use a predefined list that matches the backend
                    state.categories = [
                        { id: 'all', name: 'All Categories' },
                        { id: 'venue', name: 'Venues' },
                        { id: 'photo', name: 'Photo/Video' },
                        { id: 'music', name: 'Music/DJ' },
                        { id: 'catering', name: 'Catering' },
                        { id: 'entertainment', name: 'Entertainment' },
                        { id: 'experiences', name: 'Experiences' },
                        { id: 'decor', name: 'Decorations' },
                        { id: 'beauty', name: 'Beauty' },
                        { id: 'cake', name: 'Cake' },
                        { id: 'transport', name: 'Transportation' },
                        { id: 'planner', name: 'Planners' },
                        { id: 'fashion', name: 'Fashion' },
                        { id: 'stationery', name: 'Stationery' }
                    ];

            // Render categories
            renderCategories();

        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Render categories in the navigation with icons vertically stacked
    function renderCategories() {
        categoriesListInner.innerHTML = '';

        state.categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            if (category.id === 'all') categoryItem.classList.add('active');
            categoryItem.dataset.category = category.id;

            // Add icon element above label
            const iconHtml = getCategoryIconHtml(category.id);
            categoryItem.innerHTML = `${iconHtml}<span>${category.name}</span>`;

            categoryItem.addEventListener('click', () => {
                // Update active category
                document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
                categoryItem.classList.add('active');

                // Set current category
                state.currentCategory = category.id;

                // Filter vendors
                filterVendors();
            });

            categoriesListInner.appendChild(categoryItem);
        });
    }

    // Helper function to get category icon HTML using Font Awesome icons
    function getCategoryIconHtml(category) {
        const icons = {
            "all": "<i class='fas fa-th-large'></i>",
            "venue": "<i class='fas fa-building'></i>",
            "photo": "<i class='fas fa-camera'></i>",
            "music": "<i class='fas fa-music'></i>",
            "catering": "<i class='fas fa-utensils'></i>",
            "entertainment": "<i class='fas fa-theater-masks'></i>",
            "experiences": "<i class='fas fa-star'></i>",
            "decor": "<i class='fas fa-ribbon'></i>",
            "beauty": "<i class='fas fa-spa'></i>",
            "cake": "<i class='fas fa-birthday-cake'></i>",
            "transport": "<i class='fas fa-shuttle-van'></i>",
            "planner": "<i class='fas fa-clipboard-list'></i>",
            "fashion": "<i class='fas fa-tshirt'></i>",
            "stationery": "<i class='fas fa-envelope'></i>"
        };
        return icons[category] || "<i class='fas fa-gem'></i>";
    }

            // Helper function to generate sample reviews
            function generateSampleReviews() {
                const reviews = [];
                const reviewTexts = [
                    "Great service! Would definitely book again.",
                    "Very professional and easy to work with.",
                    "The venue was perfect for our event.",
                    "Everything went smoothly, highly recommend!",
                    "Good quality but communication could be better.",
                    "Delivered exactly what was promised."
                ];

                const names = ["John D.", "Sarah M.", "Michael T.", "Emily R.", "David K.", "Jessica L."];

                for (let i = 0; i < 5; i++) {
                    reviews.push({
                        id: `review-${i}`,
                        user: names[i],
                        rating: Math.floor(Math.random() * 2) + 4,
                        comment: reviewTexts[i],
                        date: new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000).toISOString()
                    });
                }

                return reviews;
            }

            // Helper function to map vendor types to categories
            function mapTypeToCategory(type) {
                const typeMap = {
                    "Photography": "photo",
                    "Photo": "photo",
                    "Videography": "photo",
                    "Entertainment": "entertainment",
                    "Music": "music",
                    "DJ": "music",
                    "Decor": "decor",
                    "Florist": "decor",
                    "Catering": "catering",
                    "Food": "catering",
                    "Venue": "venue",
                    "Hotel": "venue",
                    "Transportation": "transport",
                };
                return typeMap[type] || type.toLowerCase();
            }

            // Check for existing user session
            async function checkAuthStatus() {
                const token = localStorage.getItem('token');
                if (!token) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/users/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });

                        // Load user favorites
                        await loadUserFavorites();

                        // Load notifications
                        await loadNotifications();
                        
                        // Update notification badges from localStorage
                        updateNotificationBadges();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    localStorage.removeItem('token');
                }
            }

            // Load user favorites
            async function loadUserFavorites() {
                if (!currentUser) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (response.ok) {
                        const favorites = await response.json();
                        state.favorites = favorites.map(fav => fav.vendorProfileID);

                        // Update favorites badge
                        document.querySelectorAll('.badge').forEach(badge => {
                            if (badge.id === 'favorites-badge' || !badge.id) {
                                badge.textContent = state.favorites.length;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading favorites:', error);
                }
            }

            // Load notifications
            async function loadNotifications() {
                if (!currentUser) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/notifications/user/${currentUser.id}?unreadOnly=true`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (response.ok) {
                        const notifications = await response.json();
                        const unreadCount = notifications.length;

                        // Update notifications badge
                        document.querySelectorAll('.badge').forEach(badge => {
                            if (badge.id === 'notifications-badge' || badge.id === 'dashboard-notifications-badge' || badge.id === 'vendor-notifications-badge' || !badge.id) {
                                badge.textContent = unreadCount;
                            }
                        });
                    } else {
                        // Fallback: Load from localStorage
                        updateNotificationBadges();
                    }
                } catch (error) {
                    console.error('Error loading notifications, using local fallback:', error);
                    updateNotificationBadges();
                }
            }

            // Initialize Stripe
            function initializeStripe() {
                state.stripe = Stripe('pk_test_YOUR_STRIPE_PUBLIC_KEY');
                state.elements = state.stripe.elements();
            }


            // Connect to Socket.IO for chat
            function connectToChat() {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No token available for chat connection. Chat features may be limited.');
                    return;
                }

                if (state.socket && state.socket.connected) {
                    console.log('Socket already connected.');
                    return;
                }

                console.log('Attempting to connect to chat server...');
                state.socket = io(API_BASE_URL, {
                    auth: { token },
                    transports: ['websocket'],
                    reconnectionAttempts: 5
                });
                
                state.socket.on('connect', () => {
                    console.log('Connected to chat server.');
                    if (currentUser) {
                        state.socket.emit('authenticate', { userId: currentUser.id });
                    }
                });
                
                state.socket.on('new-message', (message) => {
                    console.log('Received new message via Socket.IO:', message);
                    
                    if (!message || !message.ConversationID) {
                        console.error('Invalid message format received:', message);
                        return;
                    }
                    
                    // Only process if it's for the current conversation
                    if (message.ConversationID === state.chat.currentConversation) {
                        const formattedMessage = state.chat.formatMessage(message);
                        state.chat.addMessage(formattedMessage);
                        renderChatMessages();
                    } else {
                        console.log(`Received message for conversation ${message.ConversationID}, but current is ${state.chat.currentConversation}. Not rendering.`);
                    }
                });
                
                state.socket.on('error', (error) => {
                    console.error('Socket error:', error);
                    showChatError('Connection error. Please refresh the page.');
                });
                
                state.socket.on('disconnect', () => {
                    console.log('Disconnected from chat server.');
                    showChatError('Disconnected. Trying to reconnect...');
                });
            }

async function loadInitialMessages() {
                if (!currentUser || !state.chat.currentConversation) {
                    console.warn('Cannot load messages: Missing user or conversation ID.', {
                        user: currentUser,
                        conversation: state.chat.currentConversation
                    });
                    return;
                }
                
                try {
                    console.log(`Loading messages for conversation: ${state.chat.currentConversation} and user: ${currentUser.id}`);
                    const response = await fetch(`${API_BASE_URL}/messages/conversation/${state.chat.currentConversation}?userId=${currentUser.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to load messages: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    
                    // The API returns messages directly as an array
                    if (!Array.isArray(data.messages)) {
                        throw new Error('Invalid message data format from API');
                    }
                    
                    state.chat.setMessages(data.messages);
                    renderChatMessages();
                } catch (error) {
                    console.error('Error loading messages:', error);
                    state.chat.setMessages([]); // Clear messages on error
                    renderChatMessages();
                    showChatError('Failed to load messages. Please try again.');
                }
            }


            function setupChatEventListeners(chatInputId, sendButtonId) {
                console.log(`Setting up chat listeners for: ${chatInputId}, ${sendButtonId}`);
                
                const chatInput = document.getElementById(chatInputId);
                const sendButton = document.getElementById(sendButtonId);

                console.log('Found elements:', { chatInput: !!chatInput, sendButton: !!sendButton });

                if (chatInput && sendButton) {
                    // Remove existing listeners
                    sendButton.removeEventListener('click', sendChatMessage);
                    chatInput.removeEventListener('keypress', handleChatInputKeypress);

                    // Add new listeners
                    sendButton.addEventListener('click', (e) => {
                        console.log('Send button clicked!');
                        e.preventDefault();
                        sendChatMessage();
                    });
                    
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Enter key pressed!');
                            e.preventDefault();
                            sendChatMessage();
                        }
                    });
                    
                    console.log(`Chat event listeners attached successfully for input: ${chatInputId}, button: ${sendButtonId}`);
                } else {
                    console.error(`Could not find chat elements: Input ID ${chatInputId} (${!!chatInput}), Button ID ${sendButtonId} (${!!sendButton})`);
                }
            }

            function handleChatInputKeypress(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            }

async function sendChatMessage() {
                console.log('sendChatMessage function called');
                
                const input = document.getElementById('chat-input') ||
                            document.getElementById('dashboard-chat-input') ||
                            document.getElementById('vendor-chat-input') ||
                            document.getElementById('vendor-all-chat-input') ||
                            document.getElementById('profile-chat-input');
                            
                console.log('Found input element:', !!input, input?.id);
                const message = input?.value.trim();

                console.log('Attempting to send message:', message, 'Current User:', currentUser, 'Current Conversation:', state.chat.currentConversation);

                if (!message) {
                    console.warn('Message is empty.');
                    return;
                }

                if (!currentUser) {
                    alert('Please login to send messages.');
                    profileModal.style.display = 'flex';
                    showLoginView();
                    return;
                }
                
                if (!state.chat.currentConversation && !state.chat.currentChatVendorId) {
                    alert('Please select a conversation first.');
                    return;
                }
                
                if (!state.chat.currentConversation && state.chat.currentChatVendorId) {
                    console.log('No existing conversation found, creating a new one...');
                    try {
                        const createResponse = await fetch(`${API_BASE_URL}/messages/conversation`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                vendorProfileId: state.chat.currentChatVendorId
                            })
                        });
                        
                        if (!createResponse.ok) {
                             const errorText = await createResponse.text();
                            throw new Error(`Failed to create conversation: ${createResponse.status} ${createResponse.statusText} - ${errorText}`);
                        }
                        
                        const createData = await createResponse.json();
                        state.chat.currentConversation = createData.conversation.ConversationID || createData.conversationId;
                        console.log('New conversation created:', state.chat.currentConversation);
                    } catch (err) {
                        console.error('Failed to create new conversation:', err);
                        showChatError('Failed to start chat. Please try again.');
                        return;
                    }
                }

                try {

                    const tempMessage = {
                        id: `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        conversationId: state.chat.currentConversation,
                        senderId: currentUser.id,
                        senderName: currentUser.name,
                        content: message,
                        timestamp: new Date().toISOString(),
                        isCurrentUser: true,
                        isPending: true
                    };


                    state.chat.addMessage(tempMessage);
                    input.value = '';
                    renderChatMessages();
                    
                    // Send message via Socket.IO if connected
                    if (state.socket && state.socket.connected) {
                        console.log('Sending message via Socket.IO...');
                        state.socket.emit('send-message', {
                            conversationId: state.chat.currentConversation,
                            senderId: currentUser.id,
                            content: message
                        });
                    } else {
                        console.log('Socket not connected, falling back to HTTP POST...');

                        const response = await fetch(`${API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                conversationId: currentConversation.id,
                                senderId: currentUser?.id,
                                content: message
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to send message via HTTP.');
                        }

                        const result = await response.json();
                        console.log('HTTP POST message response:', result);

                        const savedMessage = state.chat.formatMessage(result);


                        state.chat.setMessages(
                            state.chat.getMessages()
                                .filter(m => m.id !== tempMessage.id)
                                .concat([savedMessage])
                        );
                    }

                    renderChatMessages();

                } catch (err) {
                    console.error('Message send failed:', err);

                    state.chat.setMessages(
                        state.chat.getMessages().filter(m => m.id !== tempMessage.id)
                    );
                    renderChatMessages();
                    showChatError('Failed to send message: ' + err.message);
                }
            }

            function renderChatMessages() {
                const chatContainer = document.getElementById('chat-messages') ||
                                    document.getElementById('dashboard-chat-messages') ||
                                    document.getElementById('vendor-chat-messages') ||
                                    document.getElementById('vendor-all-chat-messages') ||
                                    document.getElementById('profile-chat-messages');
                
                if (!chatContainer) {
                    console.warn('Chat container not found for rendering messages.');
                    return;
                }

                chatContainer.innerHTML = '';


                const sortedMessages = [...state.chat.getMessages()].sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp));


                sortedMessages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === currentUser?.id ? 'sent' : 'received'}`;

                    const messageDate = new Date(message.timestamp);
                    const timeString = messageDate.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });


                    const senderInfo = (message.senderId !== currentUser?.id && message.senderName) ?
                        `<div class="message-sender">${message.senderName}</div>` : '';

                    messageDiv.innerHTML = `
                        ${senderInfo}
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${timeString}</div>
                    `;

                    chatContainer.appendChild(messageDiv);
                });


                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Add this function to load conversations for the dashboard
async function loadConversations(containerId, chatInputId, sendButtonId) {
                if (!currentUser) {
                    console.warn('Cannot load conversations: User not logged in.');
                    return;
                }
                
                try {
                    console.log(`Loading conversations for user: ${currentUser.id}`);
                    // Use the correct API endpoint from messages.js
                    const url = `${API_BASE_URL}/messages/conversations/user/${currentUser.id}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    let conversations = [];
                    
                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('API response:', responseData);
                        conversations = responseData.conversations || [];
                        
                        // Map API response to expected format
                        conversations = conversations.map(conv => ({
                            id: conv.id || conv.ConversationID,
                            userName: conv.OtherPartyName || conv.userName || 'Unknown User',
                            OtherPartyName: conv.OtherPartyName || conv.userName || 'Unknown User',
                            lastMessageContent: conv.lastMessageContent || conv.LastMessageContent || 'No messages yet',
                            lastMessageCreatedAt: conv.lastMessageCreatedAt || conv.LastMessageCreatedAt || conv.createdAt,
                            lastMessageSenderId: conv.lastMessageSenderId || conv.LastMessageSenderID,
                            unreadCount: conv.unreadCount || conv.UnreadCount || 0
                        }));
                    } else {
                        console.log('API failed, loading local conversations');
                        // Fallback: Load from localStorage
                        const localConversations = JSON.parse(localStorage.getItem('conversations') || '[]');
                        console.log('Local conversations found:', localConversations);
                        conversations = localConversations.filter(conv => 
                            conv.userId === currentUser.id || conv.vendorProfileId === currentUser.vendorProfileId
                        );
                        console.log('Filtered conversations for current user:', conversations);
                    }
                    
                    console.log('Final conversations:', conversations);
                    renderConversationsList(conversations, containerId, chatInputId, sendButtonId);
                } catch (error) {
                    console.error('Error loading conversations, using local fallback:', error);
                    // Load local conversations as fallback
                    const localConversations = JSON.parse(localStorage.getItem('conversations') || '[]');
                    console.log('Error fallback - Local conversations:', localConversations);
                    const conversations = localConversations.filter(conv => 
                        conv.userId === currentUser.id || conv.vendorProfileId === currentUser.vendorProfileId
                    );
                    console.log('Error fallback - Filtered conversations:', conversations);
                    renderConversationsList(conversations, containerId, chatInputId, sendButtonId);
                }
            }

            function renderConversationsList(conversations, containerId, chatInputId, sendButtonId) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn('Conversations container not found:', containerId);
                    return;
                }


                container.innerHTML = `
                    <div class="dashboard-card">
                        <h2 class="dashboard-card-title">Messages</h2>
                        <div id="chat-app" style="height: 500px; display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                            <!-- Conversations sidebar -->
                            <div id="conversations-sidebar" style="width: 300px; border-right: 1px solid var(--border); background: #f8f9fa;">
                                <div style="padding: 1rem; border-bottom: 1px solid var(--border); background: white;">
                                    <h3 style="margin: 0; font-size: 1rem;">Conversations</h3>
                                </div>
                                <div id="conversations-list" style="height: calc(100% - 60px); overflow-y: auto;">
                                    <div style="padding: 1rem; text-align: center; color: #666;">Loading conversations...</div>
                                </div>
                            </div>
                            
                            <!-- Chat area -->
                            <div id="chat-area" style="flex: 1; display: flex; flex-direction: column;">
                                <!-- Chat header -->
                                <div id="chat-header" style="padding: 1rem; border-bottom: 1px solid var(--border); background: white;">
                                    <div id="chat-partner-name" style="font-weight: 600; color: #666;">Select a conversation</div>
                                </div>
                                
                                <!-- Messages container -->
                                <div id="messages-container" style="flex: 1; padding: 1rem; overflow-y: auto; background: #f8f9fa;">
                                    <div id="welcome-message" style="text-align: center; color: #666; margin-top: 2rem;">
                                        Select a conversation to start messaging
                                    </div>
                                </div>
                                
                                <!-- Message input -->
                                <div id="message-input-area" style="padding: 1rem; border-top: 1px solid var(--border); background: white; display: none;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="message-input" placeholder="Type your message..." 
                                               style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; outline: none;">
                                        <button id="send-message-btn" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Store conversations globally and initialize the new chat system
                window.lastLoadedConversations = conversations;
                initializeChatSystem(conversations);
            }

            // New Clean Chat System
            let currentConversation = null;
            let chatPollingInterval = null;

            function initializeChatSystem(conversations) {
                console.log('Initializing new chat system with conversations:', conversations);
                
                // Populate conversations list
                populateConversationsList(conversations);
                
                // Set up event listeners
                setupNewChatEventListeners();
                
                // Auto-select first conversation if available
                if (conversations && conversations.length > 0) {
                    selectConversation(conversations[0]);
                }
            }

            function populateConversationsList(conversations) {
                const conversationsList = document.getElementById('conversations-list');
                if (!conversationsList) return;

                if (!conversations || conversations.length === 0) {
                    conversationsList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No conversations found</div>';
                    return;
                }

                conversationsList.innerHTML = conversations.map(conv => {
                    // Format last message with sender prefix
                    let lastMessageDisplay = 'No messages yet';
                    if (conv.lastMessageContent) {
                        const isOwnLastMessage = conv.lastMessageSenderId === currentUser?.id;
                        const senderPrefix = isOwnLastMessage ? 'You: ' : `${conv.userName || conv.OtherPartyName || 'Other'}: `;
                        lastMessageDisplay = senderPrefix + conv.lastMessageContent;
                    }
                    
                    return `
                        <div class="conversation-item" data-conversation-id="${conv.id}" 
                             style="padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${conv.userName || conv.OtherPartyName || 'Unknown User'}</div>
                            <div style="font-size: 0.85rem; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${lastMessageDisplay}
                            </div>
                            <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                                ${conv.lastMessageCreatedAt ? new Date(conv.lastMessageCreatedAt).toLocaleString() : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function setupNewChatEventListeners() {
                // Conversation selection
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.conversation-item')) {
                        const conversationItem = e.target.closest('.conversation-item');
                        const conversationId = parseInt(conversationItem.dataset.conversationId);
                        
                        // Find conversation data
                        const conversations = window.lastLoadedConversations || [];
                        const conversation = conversations.find(c => c.id === conversationId);
                        
                        if (conversation) {
                            selectConversation(conversation);
                        }
                    }
                });

                // Message sending
                const sendBtn = document.getElementById('send-message-btn');
                const messageInput = document.getElementById('message-input');
                
                if (sendBtn) {
                    sendBtn.addEventListener('click', sendNewMessage);
                }
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            sendNewMessage();
                        }
                    });
                }
            }

            function selectConversation(conversation) {
                console.log('Selecting conversation:', conversation);
                currentConversation = conversation;
                
                // Update UI
                updateConversationSelection(conversation.id);
                updateChatHeader(conversation.OtherPartyName || 'Unknown');
                showMessageInput();
                
                // Load messages
                loadConversationMessages(conversation.id);
                
                // Start polling for new messages
                startMessagePolling(conversation.id);
            }

            function updateConversationSelection(conversationId) {
                // Remove previous selection
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.style.backgroundColor = 'transparent';
                });
                
                // Highlight selected
                const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (selectedItem) {
                    selectedItem.style.backgroundColor = '#e3f2fd';
                }
            }

            function updateChatHeader(partnerName) {
                const chatPartnerName = document.getElementById('chat-partner-name');
                if (chatPartnerName) {
                    chatPartnerName.textContent = partnerName;
                }
            }

            function showMessageInput() {
                const messageInputArea = document.getElementById('message-input-area');
                const welcomeMessage = document.getElementById('welcome-message');
                
                if (messageInputArea) messageInputArea.style.display = 'block';
                if (welcomeMessage) welcomeMessage.style.display = 'none';
            }

            async function loadConversationMessages(conversationId) {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;

                messagesContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">Loading messages...</div>';

                try {
                    const response = await fetch(`${API_BASE_URL}/messages/conversation/${conversationId}?userId=${currentUser?.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }

                    const data = await response.json();
                    displayMessages(data.messages || []);
                    
                } catch (error) {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 2rem;">Failed to load messages</div>';
                }
            }

            function displayMessages(messages) {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;

                if (!messages || messages.length === 0) {
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No messages yet. Start the conversation!</div>';
                    return;
                }

                messagesContainer.innerHTML = messages.map(message => {
                    const isOwnMessage = message.SenderID === currentUser?.id;
                    const containerStyle = isOwnMessage ? 'display: flex; justify-content: flex-end;' : 'display: flex; justify-content: flex-start;';
                    const bubbleStyle = isOwnMessage 
                        ? 'background: #007bff; color: white; border-bottom-right-radius: 4px;' 
                        : 'background: #e9ecef; color: #333; border: 1px solid #dee2e6; border-bottom-left-radius: 4px;';
                    
                    // Get sender name
                    const senderName = isOwnMessage ? 'You' : (message.SenderName || 'Other User');
                    
                    return `
                        <div style="margin-bottom: 1rem; ${containerStyle}">
                            <div style="padding: 0.75rem 1rem; border-radius: 18px; ${bubbleStyle} box-shadow: 0 1px 2px rgba(0,0,0,0.1); max-width: 70%;">
                                <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem; opacity: 0.8;">${senderName}</div>
                                <div style="margin-bottom: 0.25rem;">${message.Content}</div>
                                <div style="font-size: 0.75rem; opacity: 0.7;">
                                    ${new Date(message.CreatedAt).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            async function sendNewMessage() {
                if (!currentConversation) return;

                const messageInput = document.getElementById('message-input');
                const message = messageInput?.value.trim();

                if (!message) return;

                console.log('Sending message via Socket.IO:', message);

                // Use Socket.IO for real-time message sending
                if (window.socket) {
                    window.socket.emit('send-message', {
                        conversationId: currentConversation.id,
                        senderId: currentUser?.id,
                        content: message
                    });

                    // Clear input immediately
                    messageInput.value = '';
                    
                    // Add message to UI immediately for instant feedback
                    addMessageToUI({
                        senderId: currentUser.id,
                        senderName: 'You',
                        content: message,
                        conversationId: currentConversation.id
                    });
                } else {
                    // Fallback to REST API if Socket.IO not available
                    try {
                        const response = await fetch(`${API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                conversationId: currentConversation.id,
                                senderId: currentUser?.id,
                                content: message
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to send message');
                        }

                        // Clear input immediately
                        messageInput.value = '';
                        
                        // Add message to UI immediately for instant feedback
                        addMessageToUI({
                            senderId: currentUser.id,
                            senderName: 'You',
                            content: message,
                            conversationId: currentConversation.id
                        });

                    } catch (error) {
                        console.error('Error sending message:', error);
                        alert('Failed to send message. Please try again.');
                    }
                }
            }

            function startMessagePolling(conversationId) {
                // Clear existing polling - we'll use Socket.IO instead
                if (chatPollingInterval) {
                    clearInterval(chatPollingInterval);
                    chatPollingInterval = null;
                }

                // Socket.IO listeners are now handled globally - no need for duplicate listeners here
            }

            // Add new message to UI without full reload
            function addMessageToUI(messageData) {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;

                const isOwnMessage = messageData.senderId === currentUser?.id;
                const containerStyle = isOwnMessage ? 'display: flex; justify-content: flex-end;' : 'display: flex; justify-content: flex-start;';
                const bubbleStyle = isOwnMessage 
                    ? 'background: #007bff; color: white; border-bottom-right-radius: 4px;' 
                    : 'background: #e9ecef; color: #333; border: 1px solid #dee2e6; border-bottom-left-radius: 4px;';
                
                const senderName = isOwnMessage ? 'You' : (messageData.senderName || 'Other User');
                
                const messageHTML = `
                    <div style="margin-bottom: 1rem; ${containerStyle}">
                        <div style="padding: 0.75rem 1rem; border-radius: 18px; ${bubbleStyle} box-shadow: 0 1px 2px rgba(0,0,0,0.1); max-width: 70%;">
                            <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem; opacity: 0.8;">${senderName}</div>
                            <div style="margin-bottom: 0.25rem;">${messageData.content}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">
                                ${new Date().toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
                
                messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Update conversation in list with new message
            function updateConversationInList(messageData) {
                const conversationItem = document.querySelector(`[data-conversation-id="${messageData.conversationId}"]`);
                if (!conversationItem) return;

                const isOwnMessage = messageData.senderId === currentUser?.id;
                const senderPrefix = isOwnMessage ? 'You: ' : `${messageData.senderName || 'Other'}: `;
                const lastMessageDisplay = senderPrefix + messageData.content;

                // Update last message content
                const lastMessageElement = conversationItem.querySelector('div:nth-child(2)');
                if (lastMessageElement) {
                    lastMessageElement.textContent = lastMessageDisplay;
                }

                // Update timestamp
                const timestampElement = conversationItem.querySelector('div:nth-child(3)');
                if (timestampElement) {
                    timestampElement.textContent = new Date().toLocaleString();
                }

                // Move conversation to top of list
                const conversationsList = document.getElementById('conversations-list');
                if (conversationsList && conversationItem.parentNode === conversationsList) {
                    conversationsList.insertBefore(conversationItem, conversationsList.firstChild);
                }
            }

            // Store conversations globally for event handlers
            window.lastLoadedConversations = null;

            function disableChatInput() {
                const chatInput = document.getElementById('chat-input');
                const sendBtn = document.getElementById('send-btn');
                if (chatInput) chatInput.disabled = true;
                if (sendBtn) sendBtn.disabled = true;
                console.log('Chat input and send button disabled.');
            }

            function showChatError(message) {
                const chatMessagesContainer = document.getElementById('chat-messages') ||
                                              document.getElementById('dashboard-chat-messages') ||
                                              document.getElementById('vendor-chat-messages') ||
                                              document.getElementById('vendor-all-chat-messages') ||
                                              document.getElementById('profile-chat-messages');
                if (chatMessagesContainer) {
                    const errorElement = document.createElement('p');
                    errorElement.style.color = 'var(--accent)';
                    errorElement.style.fontSize = '0.8rem';
                    errorElement.textContent = message;
                    chatMessagesContainer.appendChild(errorElement);
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                console.error('Chat error displayed:', message);
            }

            async function initializeChat(vendorProfileId, vendorName) {
                if (!currentUser) {
                    showChatError('Please log in to start a chat.');
                    return;
                }
                
                // Set the current chat vendor ID and name
                state.chat.currentChatVendorId = vendorProfileId;
                chatVendorName.textContent = vendorName;
                chatModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                console.log(`Initializing chat for vendor: ${vendorProfileId} and user: ${currentUser.id}`);
                state.chat.init();

                try {
                    // Check for an existing conversation
                    const checkResponse = await fetch(`${API_BASE_URL}/messages/conversation/check`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            vendorProfileId: vendorProfileId
                        })
                    });

                    if (!checkResponse.ok) {
                        const errorText = await checkResponse.text();
                        throw new Error(`Failed to check conversation: ${checkResponse.status} ${checkResponse.statusText} - ${errorText}`);
                    }

                    const checkData = await checkResponse.json();

                    if (checkData.conversationId) {
                        state.chat.currentConversation = checkData.conversationId;
                        console.log('Existing conversation found:', state.chat.currentConversation);
                        await loadInitialMessages();
                    } else {
                        console.log('No existing conversation found. A new one will be created on the first message.');
                        profileChatMessages.innerHTML = '<p style="text-align:center; color: var(--text-light); margin-top: 1rem;">Start a new conversation...</p>';
                    }
                    
                    setupChatEventListeners('profile-chat-input', 'profile-send-btn');
                    
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    showChatError('Failed to initialize chat: ' + error.message);
                }
            }
            
            // Geolocation permission persistence helpers
            const GEO_PERMISSION_KEY = 'geo_permission_state';
            const GEO_PERMISSION_TS_KEY = 'geo_permission_ts';
            function getStoredGeoPermission() {
                try { return localStorage.getItem(GEO_PERMISSION_KEY) || null; } catch (e) { return null; }
            }
            function setStoredGeoPermission(state) {
                try {
                    if (state) {
                        localStorage.setItem(GEO_PERMISSION_KEY, state);
                        localStorage.setItem(GEO_PERMISSION_TS_KEY, String(Date.now()));
                    } else {
                        localStorage.removeItem(GEO_PERMISSION_KEY);
                        localStorage.removeItem(GEO_PERMISSION_TS_KEY);
                    }
                } catch (e) {}
            }
            function initGeoPermissionObserver() {
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        navigator.permissions.query({ name: 'geolocation' }).then((p) => {
                            setStoredGeoPermission(p.state);
                            p.onchange = () => setStoredGeoPermission(p.state);
                        }).catch(() => {});
                    } catch (e) {}
                }
            }

            // New improved location request function
            function requestLocationWithFeedback() {
                console.log("Attempting to get location...");
                if (!navigator.geolocation) {
                    console.log("Geolocation not supported by this browser");
                    return;
                }

                // Respect stored permission decision
                const stored = getStoredGeoPermission();
                if (stored === 'denied') {
                    // Do not re-prompt; keep UI neutral
                    currentLocationCheckbox.checked = false;
                    locationInput.placeholder = "City or ZIP code";
                    return;
                }

                // Visual feedback
                locationInput.placeholder = "Detecting your location...";

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Location obtained:", position);
                        setStoredGeoPermission('granted');
                        handleLocationSuccess(position);
                    },
                    (error) => {
                        console.log("Location error:", error);
                        locationInput.placeholder = "City or ZIP code";

                        if (error.code === error.PERMISSION_DENIED) {
                            setStoredGeoPermission('denied');
                            // Only show modal if this is a fresh page load
                            if (!sessionStorage.getItem('locationRequested')) {
                                locationPermissionModal.style.display = 'flex';
                                sessionStorage.setItem('locationRequested', 'true');
                            }
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }

            // Modified location success handler
            function handleLocationSuccess(position) {
                state.userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Update UI
                currentLocationCheckbox.checked = true;
                document.getElementById('within50').checked = true;
                locationInput.value = "Near You";
                locationInput.placeholder = "Near You";

                filterVendors();

                if (state.map) {
                    centerMapOnUser();
                }
            }

            // Enhanced Google Maps initialization with dynamic features and event location prioritization
            function initLegacyMap() {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    console.error('Google Maps API not loaded.');
                    document.getElementById('map').innerHTML = '<p style="text-align:center; padding: 2rem; color: var(--accent);">Map could not be loaded. Please check your connection and API key.</p>';
                    return;
                }

                if (state.filteredVendors.length === 0) return;

                // Store original search results for reset functionality
                state.originalSearchResults = [...state.filteredVendors];

                // Sort vendors by distance from event location if available
                if (window.selectedEventLocation) {
                    console.log('📍 Prioritizing vendors by distance from event location');
                    state.filteredVendors.sort((a, b) => {
                        const distA = calculateDistance(
                            window.selectedEventLocation.lat, 
                            window.selectedEventLocation.lng,
                            a.coordinates.lat, 
                            a.coordinates.lng
                        );
                        const distB = calculateDistance(
                            window.selectedEventLocation.lat, 
                            window.selectedEventLocation.lng,
                            b.coordinates.lat, 
                            b.coordinates.lng
                        );
                        return distA - distB;
                    });
                    
                    // Update the original search results with sorted order
                    state.originalSearchResults = [...state.filteredVendors];
                }

                // Calculate center and bounds for initial search results (AC1)
                const bounds = new google.maps.LatLngBounds();
                
                // Include event location in bounds if available
                if (window.selectedEventLocation) {
                    bounds.extend(new google.maps.LatLng(
                        window.selectedEventLocation.lat, 
                        window.selectedEventLocation.lng
                    ));
                }
                
                state.filteredVendors.forEach(vendor => {
                    bounds.extend(new google.maps.LatLng(vendor.coordinates.lat, vendor.coordinates.lng));
                });

                // Create map
                state.map = new google.maps.Map(document.getElementById("map"), {
                    styles: [
                        {
                            "featureType": "poi",
                            "stylers": [
                                { "visibility": "off" }
                            ]
                        }
                    ]
                });

                // AC1: Center map prioritizing event location if available
                if (window.selectedEventLocation) {
                    // Center on event location with vendors in view
                    state.map.fitBounds(bounds);
                    google.maps.event.addListenerOnce(state.map, 'bounds_changed', () => {
                        if (state.map.getZoom() > 13) {
                            state.map.setZoom(13);
                        }
                    });
                } else if (state.filteredVendors.length === 1) {
                    state.map.setCenter({
                        lat: state.filteredVendors[0].coordinates.lat,
                        lng: state.filteredVendors[0].coordinates.lng
                    });
                    state.map.setZoom(14);
                } else {
                    state.map.fitBounds(bounds);
                    // Ensure minimum zoom level
                    google.maps.event.addListenerOnce(state.map, 'bounds_changed', () => {
                        if (state.map.getZoom() > 15) {
                            state.map.setZoom(15);
                        }
                    });
                }

                // Store initial bounds for reset functionality
                state.initialMapBounds = bounds;

                // Add event location marker if available
                if (window.selectedEventLocation) {
                    addEventLocationMarker();
                }

                // Add vendor markers - CREATE ONCE AND NEVER RECREATE
                createMarkersOnce();

                // AC2 & AC4: Add debounced map movement listeners - DISABLED
                // addMapMovementListeners(); // Causing marker bouncing issue

                // Add loading indicator to map
                addMapLoadingIndicator();

                // Add reset button to map
                addResetSearchButton();
            }

            // Helper function to calculate distance between two points (Haversine formula)
            function calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Radius of the Earth in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in kilometers
            }

            // Add event location marker to the map
            function addEventLocationMarker() {
                if (!state.map || !window.selectedEventLocation) return;

                // Remove existing event marker if it exists
                if (state.eventLocationMarker) {
                    state.eventLocationMarker.setMap(null);
                }

                // Create custom event location marker
                state.eventLocationMarker = new google.maps.Marker({
                    position: {
                        lat: window.selectedEventLocation.lat,
                        lng: window.selectedEventLocation.lng
                    },
                    map: state.map,
                    title: 'Event Location',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="12" fill="#FF6B6B" stroke="#fff" stroke-width="3"/>
                                <circle cx="16" cy="16" r="4" fill="#fff"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(32, 32),
                        anchor: new google.maps.Point(16, 16)
                    },
                    zIndex: 1000
                });

                // Add info window for event location
                const eventInfoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 8px; font-family: Arial, sans-serif;">
                            <h4 style="margin: 0 0 8px 0; color: #333;">🎉 Event Location</h4>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                ${window.selectedEventLocation.address || 'Your event location'}
                            </p>
                        </div>
                    `
                });

                state.eventLocationMarker.addListener('click', () => {
                    // Close any open vendor info windows
                    if (state.activeInfoWindow) {
                        state.activeInfoWindow.close();
                    }
                    eventInfoWindow.open(state.map, state.eventLocationMarker);
                    state.activeInfoWindow = eventInfoWindow;
                });
            }

            // AC2 & AC4: Add debounced map movement listeners
            function addMapMovementListeners() {
                if (!state.map) return;

                // DISABLED: Map movement listeners are causing markers to constantly bounce
                // The issue is that bounds_changed fires constantly and recreates markers
                // For now, we'll show all vendors from search results without dynamic filtering
                console.log('🚫 Map movement listeners disabled to prevent marker bouncing');
                
                // TODO: Implement proper marker management that doesn't recreate markers on every bounds change
            }

            // AC3: Add loading indicator to map
            function addMapLoadingIndicator() {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;

                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'map-loading-indicator';
                loadingDiv.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    display: none;
                    z-index: 1000;
                    align-items: center;
                    gap: 12px;
                `;
                loadingDiv.innerHTML = `
                    <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="color: #333; font-weight: 500;">Loading vendors...</span>
                `;

                // Add CSS animation for spinner
                if (!document.getElementById('map-loading-styles')) {
                    const style = document.createElement('style');
                    style.id = 'map-loading-styles';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                mapContainer.style.position = 'relative';
                mapContainer.appendChild(loadingDiv);
            }

            // AC6: Add reset search button
            function addResetSearchButton() {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;

                const resetButton = document.createElement('button');
                resetButton.id = 'reset-search-btn';
                resetButton.innerHTML = `
                    <i class="fas fa-undo"></i>
                    <span>Reset Search</span>
                `;
                resetButton.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 8px 12px;
                    cursor: pointer;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    font-size: 14px;
                    color: #333;
                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                    transition: all 0.2s ease;
                `;

                resetButton.addEventListener('mouseenter', () => {
                    resetButton.style.backgroundColor = '#f8f9fa';
                    resetButton.style.transform = 'translateY(-1px)';
                });

                resetButton.addEventListener('mouseleave', () => {
                    resetButton.style.backgroundColor = 'white';
                    resetButton.style.transform = 'translateY(0)';
                });

                resetButton.addEventListener('click', resetToOriginalSearch);
                mapContainer.appendChild(resetButton);
            }

            // AC2: Load vendors within map bounds - filter existing search results by bounds
            async function loadVendorsInMapBounds(bounds) {
                if (state.isLoadingVendors) return;

                state.isLoadingVendors = true;
                showMapLoadingIndicator();
                showSidebarSkeletonLoader();

                try {
                    // Get bounds coordinates
                    const ne = bounds.getNorthEast();
                    const sw = bounds.getSouthWest();

                    // Instead of calling /vendors/map API, filter existing search results by bounds
                    const allVendors = state.originalSearchResults || [];
                    
                    // Filter vendors that are within the current map bounds
                    const vendorsInBounds = allVendors.filter(vendor => {
                        if (!vendor.Latitude || !vendor.Longitude) return false;
                        
                        const lat = parseFloat(vendor.Latitude);
                        const lng = parseFloat(vendor.Longitude);
                        
                        return lat >= sw.lat() && lat <= ne.lat() && 
                               lng >= sw.lng() && lng <= ne.lng();
                    });

                    console.log(`🗺️ Filtered ${vendorsInBounds.length} vendors from ${allVendors.length} search results within map bounds`);

                    console.log(`🎯 Found ${vendorsInBounds.length} vendors in map bounds`);

                    // AC5: Update sidebar list with contextual results
                    state.filteredVendors = vendorsInBounds;
                    
                    // If we have event location, sort vendors by distance from event first
                    if (window.selectedEventLocation && vendorsInBounds.some(v => v.distanceFromEvent)) {
                        state.filteredVendors.sort((a, b) => {
                            const distA = parseFloat(a.distanceFromEvent) || 999;
                            const distB = parseFloat(b.distanceFromEvent) || 999;
                            return distA - distB;
                        });
                        console.log('📍 Sorted vendors by distance from event location');
                    }

                    updateVendorListForMapBounds();
                    updateMapMarkers();

                    // Update results count with distance info
                    const resultsCount = document.getElementById('results-count');
                    if (resultsCount) {
                        let countText = `${vendorsInBounds.length} vendors in this area`;
                        if (window.selectedEventLocation && vendorsInBounds.length > 0) {
                            countText += ' (sorted by distance from event)';
                        }
                        resultsCount.textContent = countText;
                    }

                } catch (error) {
                    console.error('Error loading vendors in bounds:', error);
                    
                    // Fallback to existing vendor filtering if API fails
                    console.log('🔄 Falling back to local vendor filtering');
                    const ne = bounds.getNorthEast();
                    const sw = bounds.getSouthWest();
                    
                    const vendorsInBounds = state.vendors.filter(vendor => {
                        if (!vendor.coordinates) return false;
                        const lat = vendor.coordinates.lat;
                        const lng = vendor.coordinates.lng;
                        return lat >= sw.lat() && lat <= ne.lat() && 
                               lng >= sw.lng() && lng <= ne.lng();
                    });

                    state.filteredVendors = vendorsInBounds;
                    updateVendorListForMapBounds();
                    // updateMapMarkers(); // DISABLED - causing marker bouncing

                    const resultsCount = document.getElementById('results-count');
                    if (resultsCount) {
                        resultsCount.textContent = `${vendorsInBounds.length} vendors in this area (cached)`;
                    }
                } finally {
                    state.isLoadingVendors = false;
                    hideMapLoadingIndicator();
                    hideSidebarSkeletonLoader();
                }
            }

            // AC6: Reset to original search results
            function resetToOriginalSearch() {
                if (!state.initialMapBounds || !state.originalSearchResults.length) return;

                // Restore original filtered vendors
                state.filteredVendors = [...state.originalSearchResults];
                
                // Reset map bounds
                state.map.fitBounds(state.initialMapBounds);
                
                // Update UI
                // updateMapMarkers(); // DISABLED - causing marker bouncing
                renderVendors();
                
                // Update results count
                const resultsCount = document.getElementById('results-count');
                if (resultsCount) {
                    resultsCount.textContent = `${state.filteredVendors.length} vendors available`;
                }
            }

            // AC5: Update vendor list for map bounds (contextual results)
            function updateVendorListForMapBounds() {
                // Reset to first page when map bounds change
                state.currentPage = 1;
                
                // Update metadata
                updateMetadata({ total: state.filteredVendors.length });
                
                // Re-render vendor cards
                renderVendors();
            }

            // Utility functions (Global)
            window.debounce = function(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            window.boundsEqual = function(bounds1, bounds2, tolerance = 0.001) {
                if (!bounds1 || !bounds2) return false;
                
                const ne1 = bounds1.getNorthEast();
                const sw1 = bounds1.getSouthWest();
                const ne2 = bounds2.getNorthEast();
                const sw2 = bounds2.getSouthWest();
                
                return Math.abs(ne1.lat() - ne2.lat()) < tolerance &&
                       Math.abs(ne1.lng() - ne2.lng()) < tolerance &&
                       Math.abs(sw1.lat() - sw2.lat()) < tolerance &&
                       Math.abs(sw1.lng() - sw2.lng()) < tolerance;
            }

            function showMapLoadingIndicator() {
                const indicator = document.getElementById('map-loading-indicator');
                if (indicator) {
                    indicator.style.display = 'flex';
                }
            }

            function hideMapLoadingIndicator() {
                const indicator = document.getElementById('map-loading-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // Skeleton loader for sidebar during map loading
            function showSidebarSkeletonLoader() {
                const vendorGrid = document.getElementById('vendor-grid');
                if (!vendorGrid) return;

                // Store original content
                if (!vendorGrid.dataset.originalContent) {
                    vendorGrid.dataset.originalContent = vendorGrid.innerHTML;
                }

                // Create skeleton cards
                const skeletonHTML = Array(6).fill(0).map(() => `
                    <div class="vendor-card skeleton-card" style="
                        background: #f8f9fa;
                        border: 1px solid #e9ecef;
                        border-radius: 12px;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
                    ">
                        <div style="
                            width: 100%;
                            height: 200px;
                            background: #dee2e6;
                            border-radius: 8px;
                            margin-bottom: 1rem;
                        "></div>
                        <div style="
                            width: 70%;
                            height: 20px;
                            background: #dee2e6;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                        "></div>
                        <div style="
                            width: 50%;
                            height: 16px;
                            background: #dee2e6;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                        "></div>
                        <div style="
                            width: 40%;
                            height: 16px;
                            background: #dee2e6;
                            border-radius: 4px;
                        "></div>
                    </div>
                `).join('');

                vendorGrid.innerHTML = skeletonHTML;

                // Add skeleton animation CSS if not already added
                if (!document.getElementById('skeleton-styles')) {
                    const style = document.createElement('style');
                    style.id = 'skeleton-styles';
                    style.textContent = `
                        @keyframes skeleton-pulse {
                            0% { opacity: 1; }
                            100% { opacity: 0.6; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            function hideSidebarSkeletonLoader() {
                const vendorGrid = document.getElementById('vendor-grid');
                if (!vendorGrid || !vendorGrid.dataset.originalContent) return;

                // Don't restore original content, let the normal render function handle it
                // The renderVendors() function will be called after this
            }

            // Helper function to generate random coordinates (for demo)
            function getRandomLat() { return 34.0522 + (Math.random() * 0.2 - 0.1); }
            function getRandomLng() { return -118.2437 + (Math.random() * 0.2 - 0.1); }

            // Helper function to generate random price level (for demo)
            function getRandomPriceLevel() {
                const levels = ['$', '$$', '$$$'];
                return levels[Math.floor(Math.random() * levels.length)];
            }

            // Setup all event listeners
            function setupEventListeners() {
                // View toggle buttons (new segmented control)
                const listBtnNew = document.getElementById('btn-view-list');
                const mapBtnNew = document.getElementById('btn-view-map');
                const mapEl = document.getElementById('map-view');
                const gridEl = document.getElementById('vendor-grid');
                const paginationEl = document.getElementById('pagination');

                if (listBtnNew && mapBtnNew && mapEl && gridEl) {
                    listBtnNew.addEventListener('click', () => {
                        state.currentView = 'list';
                        mapEl.style.display = 'none';
                        gridEl.style.display = 'grid';
                        if (paginationEl) paginationEl.style.display = '';
                        listBtnNew.classList.add('active');
                        mapBtnNew.classList.remove('active');
                    });

                    mapBtnNew.addEventListener('click', () => {
                        state.currentView = 'map';
                        mapEl.style.display = 'block';
                        gridEl.style.display = 'none';
                        if (paginationEl) paginationEl.style.display = 'none';
                        mapBtnNew.classList.add('active');
                        listBtnNew.classList.remove('active');
                        // Initialize Google Map if needed and refresh markers
                        initMapIfNeeded().then(() => updateMapMarkers());
                    });
                }

            // Search
            searchInput.addEventListener('input', filterVendors);

            // Make search icon clickable to focus input
            const searchButton = document.getElementById('search-button');
            if (searchButton) {
                searchButton.addEventListener('click', () => {
                    searchInput.focus();
                });
            }

            // Sorting
            sortSelect.addEventListener('change', sortVendors);

                // Filter resets
                filterResetBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const filterType = btn.id.replace('-reset', '');
                        resetFilter(filterType);
                    });
                });

                // Filter inputs
                document.querySelectorAll('.filter-section input').forEach(input => {
                    input.addEventListener('change', filterVendors);
                });

                // Current location checkbox
                currentLocationCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        requestLocationWithFeedback();
                    } else {
                        state.userLocation = null;
                        locationInput.value = '';
                        locationInput.placeholder = 'City or ZIP code';
                        filterVendors();
                    }
                });

                // Popular filters
                trendingTags.forEach(tag => {
                    tag.addEventListener('click', () => {
                        tag.classList.toggle('active');
                        const filter = tag.dataset.filter;

                        if (tag.classList.contains('active')) {
                            if (!state.filters.popular.includes(filter)) {
                                state.filters.popular.push(filter);
                            }
                        } else {
                            state.filters.popular = state.filters.popular.filter(f => f !== filter);
                        }

                        filterVendors();
                    });
                });

                // Advanced filters toggle
                advancedToggle.addEventListener('click', () => {
                    advancedContent.classList.toggle('show');
                    advancedToggle.querySelector('span').textContent =
                        advancedContent.classList.contains('show') ? '−' : '+';
                });

                // Date filters
                document.getElementById('start-date').addEventListener('change', function() {
                    state.filters.startDate = this.value;
                    filterVendors();
                });

                document.getElementById('end-date').addEventListener('change', function() {
                    state.filters.endDate = this.value;
                    filterVendors();
                });

                // Region filter
                document.getElementById('region-select').addEventListener('change', function() {
                    state.filters.region = this.value;
                    filterVendors();
                });

                // Pagination
                prevPageBtn.addEventListener('click', () => {
                    if (state.currentPage > 1) {
                        state.currentPage--;
                        renderVendors();
                    }
                });

                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                    if (state.currentPage < totalPages) {
                        state.currentPage++;
                        renderVendors();
                    }
                });

                // User nav buttons
                wishlistBtn.addEventListener('click', () => {
                    if (currentUser) {
                        displayUserDashboard('client', 'favorites');
                    } else {
                        profileModal.style.display = 'flex';
                    }
                });

                notificationsBtn.addEventListener('click', () => {
                    if (currentUser) {
                        displayUserDashboard('client', 'dashboard');
                    } else {
                        profileModal.style.display = 'flex';
                    }
                });

            // Profile button click handler
            profileBtn.addEventListener('click', () => {
                if (currentUser) {
                    showLoggedInView();
                } else {
                    showLoginView();
                }
                profileModal.style.display = 'flex';
            });

            // Logo click navigates to main page
            document.querySelectorAll('.logo').forEach(logo => {
                logo.addEventListener('click', () => {
                    console.log('🏠 Logo clicked - navigating to main page');
                    // Clear the URL path and navigate to main page
                    const baseUrl = window.location.origin + window.location.pathname.split('/listings/')[0];
                    window.history.pushState(null, null, baseUrl);
                    window.location.hash = '';
                    showMainApp();
                });
            });

                // Generic close modal buttons (for all modals)
                document.querySelectorAll('.close-modal').forEach(closeBtn => {
                    closeBtn.addEventListener('click', function() {
                        this.closest('.modal').style.display = 'none';
                        document.body.style.overflow = 'auto';
                    });
                });

                // Generic close modals when clicking outside the content (for modals that allow it)
                document.querySelectorAll('.modal').forEach(m => {
                    const oldListener = m.__overlayClickListener;
                    if (oldListener) {
                        m.removeEventListener('click', oldListener);
                    }

                    const newListener = (e) => {
                        // Only close modal if it doesn't have data-no-outside-close attribute
                        if (e.target === m && !m.hasAttribute('data-no-outside-close')) {
                            m.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }
                    };
                    m.addEventListener('click', newListener);
                    m.__overlayClickListener = newListener;
                });

                // Add an event listener for hash changes
                window.addEventListener('hashchange', handleUrlChange);
                
                // Add window load listener as backup
                window.addEventListener('load', () => {
                    console.log('🔄 Window load event - checking URL again');
                    setTimeout(handleUrlChange, 200);
                });
                
                // Add additional check for direct URL access
                if (window.location.pathname.includes('/listing') && !window.location.hash) {
                    console.log('🔄 Direct URL detected, forcing routing check');
                    setTimeout(handleUrlChange, 300);
                }

                // Toggle between login and signup forms
                showSignup.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSignupView();
                });

                showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showLoginView();
                });

                // Login with email/password
                loginBtn.addEventListener('click', async () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;

                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email, password }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Login failed');
                        }

                        const userData = await response.json();

                        // Store the token in localStorage
                        localStorage.setItem('token', userData.token);

                        // Update UI with user data
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });

                        // Connect to chat after login
                        connectToChat();
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Login failed. ' + error.message);
                    }
                });

                // Sign up with email/password
                signupBtn.addEventListener('click', async () => {
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const accountType = document.getElementById('account-type').value;

                    if (!name || !email || !password) {
                        alert('Please fill in all fields');
                        return;
                    }

                    if (password.length < 8) {
                        alert('Password should be at least 8 characters');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name,
                                email,
                                password,
                                isVendor: accountType === 'vendor'
                            }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Signup failed');
                        }

                        const userData = await response.json();

                        // Store the token
                        localStorage.setItem('token', userData.token);

                        // Update user object and UI
                        currentUser = {
                            id: userData.userId,
                            name: userData.name,
                            email: userData.email,
                            avatar: userData.name[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        };
                        showLoggedInView();
                        profileModal.style.display = 'none';
                        alert(`Welcome, ${currentUser.name}! You are now logged in.`);

                        // Connect to chat after signup
                        connectToChat();

                        // If signing up as vendor, show setup wizard
                        if (accountType === 'vendor') {
                            initializeVendorSetup(currentUser.id);
                        }
                    } catch (error) {
                        console.error('Signup error:', error);
                        alert('Signup failed. ' + error.message);
                    }
                });

                // Google Login Handler
                googleLoginBtn.addEventListener('click', () => {
                    google.accounts.id.initialize({
                        client_id: '900405597637-50g402qo0kbh2msi9bqii8e9od6oq0fk.apps.googleusercontent.com',
                        callback: handleGoogleSignIn
                    });
                    google.accounts.id.prompt();
                });

                // Facebook Login Handler
                facebookLoginBtn.addEventListener('click', () => {
                    FB.login(function(response) {
                        if (response.authResponse) {
                            fetch(`${API_BASE_URL}/users/social-login`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                  email: 'mock-facebook-email@example.com',
                                  name: 'Mock Facebook User',
                                  authProvider: 'facebook',
                                  avatar: 'M'
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.token) {
                                    localStorage.setItem('token', data.token);
                                    simulateLogin({
                                        id: data.userId,
                                        name: data.name,
                                        email: data.email,
                                        avatar: data.name[0].toUpperCase(),
                                        isVendor: data.isVendor || false
                                    });
                                    connectToChat();
                                    promptForAccountType(data.userId);
                                }
                            })
                            .catch(error => {
                                console.error('Facebook login error:', error);
                                alert('Facebook login failed. Please try again.');
                            });
                        }
                    }, {scope: 'public_profile,email'});
                });

                // Logout handler
                logoutBtn.addEventListener('click', () => {
                    // Clear ALL authentication-related data from storage
                    localStorage.removeItem('token');
                    localStorage.removeItem('userSession');
                    localStorage.removeItem('isVendorMode');
                    localStorage.removeItem('activeDashboardSection');
                    sessionStorage.clear();

                    // Disconnect from chat
                    if (state.socket) {
                        state.socket.disconnect();
                    }

                    currentUser = null;
                    showLoginView();
                    alert('You have been logged out');

                    // Reset profile button
                    profileBtn.textContent = '👤';
                    profileBtn.style.backgroundColor = '';
                    profileBtn.style.color = '';
                    profileBtn.style.borderRadius = '';
                    profileBtn.style.width = '';
                    profileBtn.style.height = '';
                    profileBtn.style.display = '';
                    profileBtn.style.alignItems = '';
                    profileBtn.style.justifyContent = '';

                    showMainApp();
                });

                // View dashboard button
                viewDashboardBtn.addEventListener('click', () => {
                    profileModal.style.display = 'none';
                    const initialSection = currentUser.isVendor ? 'vendor-dashboard' : 'dashboard';
                    displayUserDashboard(currentUser.isVendor ? 'vendor' : 'client', activeDashboardSection || initialSection);
                });

                // Dashboard menu items (both client and vendor)
                clientDashboardMenuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        displayUserDashboard('client', section);
                    });
                });

                vendorDashboardMenuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        displayUserDashboard('vendor', section);
                    });
                });

                // Switch to vendor mode
                switchToVendorBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (currentUser.isVendor) {
                        displayUserDashboard('vendor', 'vendor-dashboard');
                    } else {
                        // Check if user has a vendor profile
                        try {
                            const response = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });
                            const data = await response.json();
                            if (data.isVendor && data.isProfileComplete) {
                                // User is a vendor and profile is complete
                                currentUser.isVendor = true;
                                displayUserDashboard('vendor', 'vendor-dashboard');
                        } else {
                            // User is not a vendor or profile is incomplete, show setup wizard
                            initializeVendorSetup(currentUser.id);
                        }
                        } catch (error) {
                            console.error('Error checking vendor status:', error);
                            alert('Failed to check vendor status. Please try again.');
                        }
                    }
                });

                // Switch to client mode
                switchToClientBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    displayUserDashboard('client', 'dashboard');
                });

                // Logout from dashboard
                logoutDashboardBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutBtn.click();
                });

                // Logout from vendor dashboard
                vendorLogoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutBtn.click();
                });

                // Vendor registration form steps
                document.querySelectorAll('.next-step').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const currentStep = btn.closest('.form-section');
                        const nextStepId = `reg-step-${btn.dataset.step}`;
                        const nextStep = document.getElementById(nextStepId);

                        if (validateStep(currentStep.id)) {
                            currentStep.style.display = 'none';
                            nextStep.style.display = 'block';
                            updateRegistrationStatus(btn.dataset.step);
                        } else {
                            alert('Please fill out all required fields.');
                        }
                    });
                });

                document.querySelectorAll('.prev-step').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const currentStep = btn.closest('.form-section');
                        const prevStepId = `reg-step-${btn.dataset.step}`;
                        const prevStep = document.getElementById(prevStepId);

                        currentStep.style.display = 'none';
                        prevStep.style.display = 'block';
                        updateRegistrationStatus(btn.dataset.step);
                    });
                });


                // Map controls
                document.getElementById('zoom-in')?.addEventListener('click', () => {
                    if (state.map) {
                        state.map.setZoom(state.map.getZoom() + 1);
                    }
                });

                document.getElementById('zoom-out')?.addEventListener('click', () => {
                    if (state.map) {
                        state.map.setZoom(state.map.getZoom() - 1);
                    }
                });

                locateMeBtn?.addEventListener('click', () => {
                    if (state.userLocation) {
                        centerMapOnUser();
                    } else {
                        requestLocationWithFeedback();
                    }
                });

                // Location permission
                allowLocationBtn.addEventListener('click', () => {
                    locationLoading.style.display = 'inline-block';
                    allowLocationBtn.disabled = true;

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            locationPermissionModal.style.display = 'none';
                            handleLocationSuccess(position);
                            locationLoading.style.display = 'none';
                            allowLocationBtn.disabled = false;
                        },
                        (error) => {
                            console.log("Location error:", error);
                            locationPermissionModal.style.display = 'none';
                            locationLoading.style.display = 'none';
                            allowLocationBtn.disabled = false;
                            currentLocationCheckbox.checked = false;
                            alert("Could not get your location. Please try again or enter a location manually.");
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000
                        }
                    );
                });

                denyLocationBtn.addEventListener('click', () => {
                    locationPermissionModal.style.display = 'none';
                    currentLocationCheckbox.checked = false;
                });

                // Confirmation modal
                document.getElementById('conf-done-btn').addEventListener('click', () => {
                    confirmationModal.style.display = 'none';
                });

                // Category scroll buttons
                if (scrollLeftBtn && scrollRightBtn && categoriesListWrapper) {
                    scrollLeftBtn.addEventListener('click', () => {
                        categoriesListWrapper.scrollBy({
                            left: -200,
                            behavior: 'smooth'
                        });
                    });

                    scrollRightBtn.addEventListener('click', () => {
                        categoriesListWrapper.scrollBy({
                            left: 200,
                            behavior: 'smooth'
                        });
                    });
                }
            }

            // Comprehensive Vendor Setup Wizard State (updated with new steps)
            if (typeof vendorSetupState === 'undefined') {
                var vendorSetupState = {
                    currentStep: 1,
                    vendorId: null,
                    vendorProfileId: null,
                    stepData: {
                        step1: {}, // Business Basics
                        step2: {}, // Location Information
                        step3: {}, // Gallery & Media
                        step4: {}, // Services & Packages
                        step5: {}, // Social Media
                        step6: {}, // Availability & Scheduling
                        step7: {}, // Additional Details (Category-specific questions)
                        step8: {}, // FAQ Section
                        step9: {} // Summary & Completion
                    },
                    gallery: [],
                    portfolio: [],
                    packages: [],
                    services: [],
                    teamMembers: [],
                    faqs: [],
                    categoryQuestions: [],
                    additionalDetails: [],
                    selectedCities: [], // Fix for Step 2 cities/regions
                    serviceCategories: [] // Fix for service categories
                };
            }

            // Initialize Vendor Setup
            function initializeVendorSetup(vendorId) {
                vendorSetupState.vendorId = vendorId;
                vendorSetupState.currentStep = 1;
                
                // Reset all data
                Object.keys(vendorSetupState.stepData).forEach(key => {
                    vendorSetupState.stepData[key] = {};
                });
                vendorSetupState.gallery = [];
                vendorSetupState.portfolio = [];
                vendorSetupState.packages = [];
                vendorSetupState.services = [];
                vendorSetupState.teamMembers = [];
                vendorSetupState.faqs = [];
                
                // Show the setup modal
                vendorRegistrationModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Setup event listeners
                setupVendorSetupEventListeners();
                
                // Show first step
                showSetupStep(1);
            }

            // Setup Event Listeners for All 10 Steps
            function setupVendorSetupEventListeners() {
                // Navigation buttons - Forward
                document.getElementById('next-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('next-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('next-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('next-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('next-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('next-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('next-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('next-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                document.getElementById('next-to-step-10')?.addEventListener('click', () => goToSetupStep(10));
                
                // Navigation buttons - Backward
                document.getElementById('back-to-step-1')?.addEventListener('click', () => goToSetupStep(1));
                document.getElementById('back-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('back-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('back-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('back-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('back-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('back-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('back-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('back-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                
                // Step 3: Gallery & Media functionality
                document.getElementById('featured-image')?.addEventListener('change', handleFeaturedImageUpload);
                document.getElementById('gallery-images')?.addEventListener('change', handleGalleryUpload);
                document.getElementById('add-portfolio-btn')?.addEventListener('click', showPortfolioForm);
                document.getElementById('add-portfolio-item-btn')?.addEventListener('click', addPortfolioItem);
                
                // Step 4: Services & Packages functionality
                document.getElementById('add-service-category-btn')?.addEventListener('click', showServiceCategoryForm);
                document.getElementById('add-category-item-btn')?.addEventListener('click', addServiceCategory);
                document.getElementById('add-service-btn')?.addEventListener('click', showServiceForm);
                document.getElementById('add-service-item-btn')?.addEventListener('click', addServiceItem);
                document.getElementById('add-package-btn')?.addEventListener('click', showPackageForm);
                document.getElementById('add-package-item-btn')?.addEventListener('click', addPackageItem);
                
                // Step 5: Team functionality
                document.getElementById('add-team-member-btn')?.addEventListener('click', showTeamMemberForm);
                document.getElementById('add-team-item-btn')?.addEventListener('click', addTeamMember);
                
                // Step 10: FAQ functionality
                // Move FAQ event listeners to Step 7 for immediate FAQ step functionality
                document.getElementById('add-faq-btn')?.addEventListener('click', showFaqForm);
                document.getElementById('add-faq-item-btn')?.addEventListener('click', addFaqItem);
                
                // Complete setup
                document.getElementById('complete-setup-btn')?.addEventListener('click', completeVendorSetup);
            }

            // Navigation Functions
            async function goToSetupStep(step) {
                // Validate current step before proceeding
                if (!validateCurrentStep()) {
                    return;
                }
                
                // Save current step data
                saveCurrentStepData();
                
                // Submit current step data to backend
                try {
                    await submitCurrentStepToBackend();
                } catch (error) {
                    console.error('Failed to save step data:', error);
                    alert('Failed to save step data. Please try again.');
                    return;
                }
                
                // Load category-specific questions when entering step 4
                if (step === 4) {
                    await loadCategoryQuestions();
                }
                
                // Load summary when entering step 9
                if (step === 9) {
                    await loadVendorSummary();
                }
                
                // Update step
                vendorSetupState.currentStep = step;
                showSetupStep(step);
            }

            // Load category-specific questions based on primary category
            async function loadCategoryQuestions() {
                const primaryCategory = document.getElementById('primary-category')?.value;
                if (!primaryCategory) {
                    console.warn('No primary category selected');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/category-questions/${primaryCategory}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load category questions');
                    }

                    const data = await response.json();
                    renderCategoryQuestions(data.questions || []);

                } catch (error) {
                    console.error('Error loading category questions:', error);
                    document.getElementById('category-questions-container').innerHTML = 
                        '<p style="color: var(--accent);">Failed to load questions. Please try again.</p>';
                }
            }

            // Render category-specific questions
            function renderCategoryQuestions(questions) {
                const container = document.getElementById('category-questions-container');
                if (!container) return;

                if (questions.length === 0) {
                    container.innerHTML = '<p>No additional questions for this category.</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 1rem;">';
                
                questions.forEach((question, index) => {
                    html += `
                        <div class="form-group" style="padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                ${question.QuestionText}
                                ${question.IsRequired ? '<span style="color: var(--accent);">*</span>' : ''}
                            </label>
                    `;

                    if (question.QuestionType === 'YesNo') {
                        html += `
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="Yes" ${question.IsRequired ? 'required' : ''}>
                                    Yes
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="No" ${question.IsRequired ? 'required' : ''}>
                                    No
                                </label>
                            </div>
                        `;
                    } else if (question.QuestionType === 'Text') {
                        html += `
                            <textarea name="question_${question.QuestionID}" rows="3" 
                                     style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                     ${question.IsRequired ? 'required' : ''}></textarea>
                        `;
                    } else if (question.QuestionType === 'Number') {
                        html += `
                            <input type="number" name="question_${question.QuestionID}" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                   ${question.IsRequired ? 'required' : ''}>
                        `;
                    }

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            }

            // Load and display vendor summary
            async function loadVendorSummary() {
                const container = document.getElementById('setup-summary-content');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/summary/${vendorSetupState.vendorProfileId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load vendor summary');
                    }

                    const data = await response.json();
                    renderVendorSummary(data);

                } catch (error) {
                    console.error('Error loading vendor summary:', error);
                    container.innerHTML = '<p style="color: var(--accent);">Failed to load summary. Please try again.</p>';
                }
            }

            // Render comprehensive vendor summary
            function renderVendorSummary(summaryData) {
                const container = document.getElementById('setup-summary-content');
                if (!container || !summaryData.success) return;

                const data = summaryData.data;
                let html = '<div style="display: grid; gap: 1.5rem;">';

                // Business Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                📋 Business Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Business Name:</strong> ${info.BusinessName || 'Not provided'}</div>
                                <div><strong>Display Name:</strong> ${info.DisplayName || 'Not provided'}</div>
                                <div><strong>Email:</strong> ${info.BusinessEmail || 'Not provided'}</div>
                                <div><strong>Phone:</strong> ${info.BusinessPhone || 'Not provided'}</div>
                                <div><strong>Website:</strong> ${info.Website || 'Not provided'}</div>
                                <div><strong>Years in Business:</strong> ${info.YearsInBusiness || 'Not provided'}</div>
                            </div>
                            ${info.BusinessDescription ? `<div style="margin-top: 1rem;"><strong>Description:</strong><br>${info.BusinessDescription}</div>` : ''}
                            ${info.Tagline ? `<div style="margin-top: 0.5rem;"><strong>Tagline:</strong> ${info.Tagline}</div>` : ''}
                        </div>
                    `;
                }

                // Location Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Address:</strong> ${info.Address || 'Not provided'}</div>
                                <div><strong>City:</strong> ${info.City || 'Not provided'}</div>
                                <div><strong>State:</strong> ${info.State || 'Not provided'}</div>
                                <div><strong>Country:</strong> ${info.Country || 'Not provided'}</div>
                                <div><strong>Postal Code:</strong> ${info.PostalCode || 'Not provided'}</div>
                            </div>
                            ${info.AdditionalCitiesServed ? `<div style="margin-top: 1rem;"><strong>Additional Cities/Regions Served:</strong><br>${info.AdditionalCitiesServed}</div>` : ''}
                        </div>
                    `;
                }

                // Categories
                if (data.categories && data.categories.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-tags" style="margin-right: 0.5rem;"></i>Categories
                            </h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.categories.map(cat => `<span style="background-color: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">${cat.Category}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Gallery
                if (data.imageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-images" style="margin-right: 0.5rem;"></i>Gallery
                            </h5>
                            <div><strong>Images Uploaded:</strong> ${data.imageCount} images</div>
                            ${data.basicInfo?.FeaturedImageURL ? '<div style="margin-top: 0.5rem;"><strong>Featured Image:</strong> <i class="fas fa-check" style="color: #28a745;"></i> Set</div>' : ''}
                        </div>
                    `;
                }

                // Services & Packages
                if (data.serviceCount > 0 || data.packageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Services & Packages
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>Services:</strong> ${data.serviceCount || 0} services</div>
                                <div><strong>Packages:</strong> ${data.packageCount || 0} packages</div>
                            </div>
                        </div>
                    `;
                }

                // Social Media
                if (data.socialMedia && data.socialMedia.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🌐 Social Media
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.socialMedia.map(social => `<div><strong>${social.Platform}:</strong> ${social.URL}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Business Hours
                if (data.businessHours && data.businessHours.length > 0) {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🕒 Business Hours
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.businessHours.map(hours => `
                                    <div><strong>${days[hours.DayOfWeek]}:</strong> 
                                    ${hours.IsAvailable ? `${hours.OpenTime} - ${hours.CloseTime}` : 'Closed'}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Additional Details (Category-specific questions)
                if (data.additionalDetails && data.additionalDetails.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Additional Details
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.additionalDetails.map(detail => `<div><strong>${detail.QuestionText}:</strong> ${detail.Answer}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // FAQs
                if (data.faqs && data.faqs.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Frequently Asked Questions
                            </h5>
                            <div style="display: grid; gap: 1rem;">
                                ${data.faqs.map(faq => `
                                    <div style="padding: 1rem; background-color: white; border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Q: ${faq.Question}</div>
                                        <div>A: ${faq.Answer}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            }

            function showSetupStep(step) {
                // Hide all steps
                document.querySelectorAll('.setup-step').forEach(stepEl => {
                    stepEl.style.display = 'none';
                });
                
                // Show current step
                const currentStepEl = document.getElementById(`setup-step-${step}`);
                if (currentStepEl) {
                    currentStepEl.style.display = 'block';
                }
                
                // Update progress bar (10 steps total)
                const progressBar = document.getElementById('setup-progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${(step / 10) * 100}%`;
                }
                
                // Update step indicators
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    indicator.classList.remove('active', 'completed');
                    if (index + 1 === step) {
                        indicator.classList.add('active');
                    } else if (index + 1 < step) {
                        indicator.classList.add('completed');
                    }
                });

                // Load predefined services when Step 3 is shown
                if (step === 3) {
                    loadPredefinedServices();
                }
            }

            // Validation Functions
            function validateCurrentStep() {
                const step = vendorSetupState.currentStep;
                
                switch(step) {
                    case 1: // Business Basics
                        const businessName = document.getElementById('business-name')?.value;
                        const businessDescription = document.getElementById('business-description')?.value;
                        if (!businessName || !businessDescription) {
                            alert('Please fill in all required fields for Business Basics.');
                            return false;
                        }
                        break;
                    case 2: // Location Information
                        const address = document.getElementById('business-address')?.value;
                        if (!address) {
                            alert('Please provide your business address.');
                            return false;
                        }
                        break;
                    case 3: // Services & Packages
                        const selectedServices = vendorSetupState.selectedPredefinedServices || [];
                        if (selectedServices.length === 0) {
                            alert('Please select at least one service to offer to your clients.');
                            return false;
                        }
                        
                        // Validate that all selected services have pricing
                        const invalidServices = selectedServices.filter(service => (!service.vendorPrice || service.vendorPrice <= 0) && (!service.price || service.price <= 0));
                        if (invalidServices.length > 0) {
                            alert('Please provide pricing for all selected services.');
                            return false;
                        }
                        break;
                    // Add more validation as needed
                }
                return true;
            }

            // Data Collection Functions
            function saveCurrentStepData() {
                const step = vendorSetupState.currentStep;
                
                switch(step) {
                    case 1: // Business Basics
                        const primaryCategory = document.getElementById('primary-category')?.value || '';
                        const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || [])
                            .map(option => option.value);
                        
                        vendorSetupState.stepData.step1 = {
                            businessName: document.getElementById('business-name')?.value || '',
                            displayName: document.getElementById('display-name')?.value || '',
                            businessEmail: document.getElementById('business-email')?.value || '',
                            businessPhone: document.getElementById('business-phone')?.value || '',
                            websiteUrl: document.getElementById('website-url')?.value || '',
                            yearsInBusiness: document.getElementById('years-in-business')?.value || '',
                            businessDescription: document.getElementById('business-description')?.value || '',
                            tagline: document.getElementById('tagline')?.value || '',
                            primaryCategory: primaryCategory,
                            additionalCategories: additionalCategories,
                            allCategories: [primaryCategory, ...additionalCategories].filter(cat => cat)
                        };
                        break;
                    case 2: // Location Information
                        vendorSetupState.stepData.step2 = {
                            businessAddress: document.getElementById('business-address')?.value || '',
                            businessCity: document.getElementById('business-city')?.value || '',
                            businessState: document.getElementById('business-state')?.value || '',
                            businessCountry: document.getElementById('business-country')?.value || 'Canada',
                            businessPostal: document.getElementById('business-postal')?.value || '',
                            businessLatitude: document.getElementById('business-latitude')?.value || '',
                            businessLongitude: document.getElementById('business-longitude')?.value || '',
                            additionalCities: vendorSetupState.selectedCities.join(', ') // Save selected cities properly
                        };
                        console.log('Step 2 data saved:', vendorSetupState.stepData.step2);
                        break;
                    case 6: // Social Media & Links
                        vendorSetupState.stepData.step6 = {
                            website: document.getElementById('business-website')?.value || '',
                            facebook: document.getElementById('social-facebook')?.value || '',
                            instagram: document.getElementById('social-instagram')?.value || '',
                            twitter: document.getElementById('social-twitter')?.value || '',
                            linkedin: document.getElementById('social-linkedin')?.value || '',
                            youtube: document.getElementById('social-youtube')?.value || '',
                            tiktok: document.getElementById('social-tiktok')?.value || ''
                        };
                        break;
                    case 7: // Additional Details (Category-specific questions)
                        const categoryAnswers = [];
                        const questionInputs = document.querySelectorAll('#category-questions-container input, #category-questions-container textarea, #category-questions-container select');
                        
                        questionInputs.forEach(input => {
                            if (input.name && input.name.startsWith('question_')) {
                                const questionId = input.name.replace('question_', '');
                                let answer = input.value?.trim() || '';
                                
                                // Handle different input types
                                if (input.type === 'checkbox') {
                                    answer = input.checked ? 'Yes' : 'No';
                                } else if (input.type === 'radio') {
                                    if (input.checked) {
                                        answer = input.value;
                                    } else {
                                        return; // Skip unchecked radio buttons
                                    }
                                }
                                
                                if (answer) {
                                    categoryAnswers.push({
                                        questionId: parseInt(questionId),
                                        answer: answer
                                    });
                                }
                            }
                        });
                        
                        vendorSetupState.stepData.step4 = {
                            categoryAnswers: categoryAnswers,
                            primaryCategory: document.getElementById('primary-category')?.value || ''
                        };
                        break;
                    case 8: // FAQ Section - COMPLETELY OVERRIDE ANY LEGACY POLICIES DATA
                        // Collect FAQ data from the FAQ list
                        const faqs = [];
                        const faqItems = document.querySelectorAll('#faqs-list .faq-item-display');
                        
                        faqItems.forEach(item => {
                            const questionText = item.querySelector('.faq-question-text')?.textContent?.trim();
                            const answerText = item.querySelector('.faq-answer-text')?.textContent?.trim();
                            
                            // Clean up the question and answer text (remove "Q:" and "A:" prefixes)
                            const question = questionText ? questionText.replace(/^Q:\s*/, '').trim() : '';
                            const answer = answerText ? answerText.replace(/^A:\s*/, '').trim() : '';
                            
                            if (question && answer) {
                                faqs.push({
                                    question: question,
                                    answer: answer
                                });
                            }
                        });
                        
                        // Also collect from vendorSetupState.faqs if it exists
                        if (vendorSetupState.faqs && vendorSetupState.faqs.length > 0) {
                            vendorSetupState.faqs.forEach(faq => {
                                if (faq.question && faq.answer) {
                                    faqs.push({
                                        question: faq.question,
                                        answer: faq.answer
                                    });
                                }
                            });
                        }
                        
                        // FORCE FAQ data structure - completely override any legacy policies data
                        vendorSetupState.stepData.step8 = {
                            faqs: faqs
                        };
                        
                        // CRITICAL: Remove any legacy policies data that might exist
                        delete vendorSetupState.stepData.step8.depositRequirements;
                        delete vendorSetupState.stepData.step8.cancellationPolicy;
                        delete vendorSetupState.stepData.step8.reschedulingPolicy;
                        delete vendorSetupState.stepData.step8.paymentMethods;
                        delete vendorSetupState.stepData.step8.paymentTerms;
                        
                        console.log('Step 8 FAQ data collected:', vendorSetupState.stepData.step8);
                        break;
                    case 9: // Verification & Legal
                        vendorSetupState.stepData.step9 = {
                            licenseNumber: document.getElementById('license-number')?.value || '',
                            insuranceVerified: document.getElementById('insurance-verified')?.checked || false,
                            awardsCertifications: document.getElementById('awards-certifications')?.value || '',
                            ecoFriendly: document.getElementById('eco-friendly')?.checked || false,
                            premiumStatus: document.getElementById('premium-status')?.checked || false
                        };
                        break;

                }
            }

            // Predefined Services Functions
            async function loadPredefinedServices() {
                console.log('Loading predefined services...');
                
                // Show loading state
                document.getElementById('predefined-services-loading').style.display = 'block';
                document.getElementById('predefined-services-container').style.display = 'none';
                document.getElementById('no-services-message').style.display = 'none';
                
                try {
                    // Get selected categories from Step 1
                    const primaryCategory = document.getElementById('primary-category')?.value;
                    const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || [])
                        .map(option => option.value);
                    
                    const selectedCategories = [primaryCategory, ...additionalCategories].filter(cat => cat);
                    console.log('Selected categories from Step 1:', selectedCategories);
                    
                    if (selectedCategories.length === 0) {
                        console.warn('No categories selected in Step 1');
                        showNoServicesMessage();
                        return;
                    }
                    
                    // Fetch all predefined services
                    const response = await fetch(`${API_BASE_URL}/vendors/predefined-services`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Predefined services response:', data);
                    
                    if (!data.success || !data.servicesByCategory) {
                        throw new Error('Invalid response format');
                    }
                    
                    // Filter services by selected categories
                    const relevantServices = [];
                    selectedCategories.forEach(category => {
                        const categoryKey = findMatchingCategoryKey(category, data.servicesByCategory);
                        if (categoryKey && data.servicesByCategory[categoryKey]) {
                            data.servicesByCategory[categoryKey].forEach(service => {
                                relevantServices.push({
                                    ...service,
                                    category: categoryKey
                                });
                            });
                        }
                    });
                    
                    console.log('Relevant services found:', relevantServices);
                    
                    if (relevantServices.length === 0) {
                        showNoServicesMessage();
                        return;
                    }
                    
                    // Initialize selected services in vendor state
                    if (!vendorSetupState.selectedPredefinedServices) {
                        vendorSetupState.selectedPredefinedServices = [];
                    }
                    
                    // Display services
                    displayPredefinedServices(relevantServices);
                    
                } catch (error) {
                    console.error('Error loading predefined services:', error);
                    showNoServicesMessage();
                }
            }
            
            function findMatchingCategoryKey(selectedCategory, servicesByCategory) {
                // Direct match first
                if (servicesByCategory[selectedCategory]) {
                    return selectedCategory;
                }
                
                // Case-insensitive match
                const lowerSelected = selectedCategory.toLowerCase();
                for (const key of Object.keys(servicesByCategory)) {
                    if (key.toLowerCase() === lowerSelected) {
                        return key;
                    }
                }
                
                // Partial match for common mappings
                const categoryMappings = {
                    'photo': ['Photography', 'Photo'],
                    'music': ['Music & Entertainment', 'Music'],
                    'beauty': ['Beauty & Wellness', 'Beauty'],
                    'catering': ['Catering', 'Food & Catering'],
                    'venue': ['Venue', 'Venues'],
                    'transport': ['Transportation', 'Transport'],
                    'decor': ['Floral & Decor', 'Decor'],
                    'planner': ['Event Planning', 'Planning'],
                    'entertainment': ['Music & Entertainment', 'Entertainment']
                };
                
                if (categoryMappings[lowerSelected]) {
                    for (const mapping of categoryMappings[lowerSelected]) {
                        for (const key of Object.keys(servicesByCategory)) {
                            if (key.toLowerCase().includes(mapping.toLowerCase())) {
                                return key;
                            }
                        }
                    }
                }
                
                return null;
            }
            
            function displayPredefinedServices(services) {
                const container = document.getElementById('predefined-services-grid');
                const loadingEl = document.getElementById('predefined-services-loading');
                const containerEl = document.getElementById('predefined-services-container');
                
                // Hide loading, show container
                loadingEl.style.display = 'none';
                containerEl.style.display = 'block';
                
                // Clear existing content
                container.innerHTML = '';
                
                services.forEach(service => {
                    const serviceCard = createPredefinedServiceCard(service);
                    container.appendChild(serviceCard);
                });
                
                updateSelectedServicesCount();
            }
            
            function createPredefinedServiceCard(service) {
                const card = document.createElement('div');
                card.className = 'predefined-service-card';
                card.dataset.serviceId = service.id;
                card.dataset.serviceName = service.name;
                card.dataset.serviceCategory = service.category;
                
                card.innerHTML = `
                    <div class="service-card-header">
                        <h6 class="service-card-title">${service.name}</h6>
                        <div class="service-card-check">
                            <i class="fas fa-check" style="font-size: 0.8rem;"></i>
                        </div>
                    </div>
                    
                    <div class="service-card-description">
                        ${service.description || 'Professional service offering'}
                    </div>
                    
                    <div class="service-card-details">
                        <div class="service-card-duration">
                            <i class="fas fa-clock"></i>
                            <span>Custom Duration</span>
                        </div>
                        <div style="color: var(--primary); font-weight: 500;">
                            <i class="fas fa-tag"></i>
                            <span>${service.category}</span>
                        </div>
                    </div>
                    
                    <div class="vendor-customization-form">
                        <h6 style="margin: 0 0 1rem 0; color: var(--primary); font-size: 0.9rem;">Customize Your Service</h6>
                        
                        <div class="form-row-inline">
                            <div class="form-group-inline">
                                <label>Your Price ($) *</label>
                                <input type="number" 
                                       class="vendor-price-input" 
                                       min="0" 
                                       step="0.01" 
                                       placeholder="0.00" 
                                       required>
                            </div>
                            <div class="form-group-inline">
                                <label>Duration (minutes)</label>
                                <input type="number" 
                                       class="vendor-duration-input" 
                                       min="15" 
                                       step="15" 
                                       value="${service.defaultDuration || 60}"
                                       placeholder="60">
                            </div>
                        </div>
                        
                        <div class="form-group-inline">
                            <label>Your Description (optional)</label>
                            <textarea class="vendor-description-input" 
                                      placeholder="Add any specific details about how you provide this service..."
                                      rows="2"></textarea>
                        </div>
                    </div>
                `;
                
                // Add click handler for service selection
                card.addEventListener('click', (e) => {
                    // Don't toggle if clicking on form inputs
                    if (e.target.closest('.vendor-customization-form input, .vendor-customization-form textarea')) {
                        return;
                    }
                    toggleServiceSelection(card, service);
                });
                
                return card;
            }
            
            function toggleServiceSelection(card, service) {
                const isSelected = card.classList.contains('selected');
                
                if (isSelected) {
                    // Deselect service
                    card.classList.remove('selected');
                    removeSelectedService(service.id);
                } else {
                    // Select service
                    card.classList.add('selected');
                    addSelectedService(card, service);
                }
                
                updateSelectedServicesCount();
                updateSelectedServicesSummary();
            }
            
            function addSelectedService(card, service) {
                // Remove if already exists
                removeSelectedService(service.id);
                
                const selectedService = {
                    id: service.id,
                    predefinedServiceId: service.id,
                    name: service.name,
                    description: service.description,
                    category: service.category,
                    defaultDuration: service.defaultDuration,
                    price: 0,
                    durationMinutes: service.defaultDuration || 60,
                    vendorPrice: 0,
                    vendorDuration: service.defaultDuration || 60,
                    vendorDescription: ''
                };
                
                vendorSetupState.selectedPredefinedServices.push(selectedService);
                
                // Add event listeners to form inputs
                const priceInput = card.querySelector('.vendor-price-input');
                const durationInput = card.querySelector('.vendor-duration-input');
                const descriptionInput = card.querySelector('.vendor-description-input');
                
                const updateServiceData = () => {
                    const serviceIndex = vendorSetupState.selectedPredefinedServices.findIndex(s => s.id === service.id);
                    if (serviceIndex !== -1) {
                        const priceValue = parseFloat(priceInput.value) || 0;
                        const durationValue = parseInt(durationInput.value) || service.defaultDuration || 60;
                        const descriptionValue = descriptionInput.value.trim();
                        
                        vendorSetupState.selectedPredefinedServices[serviceIndex].vendorPrice = priceValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].vendorDuration = durationValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].vendorDescription = descriptionValue;
                        
                        // Update API-compatible fields
                        vendorSetupState.selectedPredefinedServices[serviceIndex].price = priceValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].durationMinutes = durationValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].description = descriptionValue;
                        
                        updateSelectedServicesSummary();
                    }
                };
                
                priceInput.addEventListener('input', updateServiceData);
                durationInput.addEventListener('input', updateServiceData);
                descriptionInput.addEventListener('input', updateServiceData);
            }
            
            function removeSelectedService(serviceId) {
                vendorSetupState.selectedPredefinedServices = vendorSetupState.selectedPredefinedServices.filter(s => s.id !== serviceId);
            }
            
            function updateSelectedServicesCount() {
                const count = vendorSetupState.selectedPredefinedServices?.length || 0;
                const countEl = document.getElementById('selected-services-count');
                if (countEl) {
                    countEl.textContent = `${count} service${count !== 1 ? 's' : ''} selected`;
                }
            }
            
            function updateSelectedServicesSummary() {
                const summaryContainer = document.getElementById('selected-services-summary');
                const summaryList = document.getElementById('selected-services-list');
                const selectedServices = vendorSetupState.selectedPredefinedServices || [];
                
                if (selectedServices.length === 0) {
                    summaryContainer.style.display = 'none';
                    return;
                }
                
                summaryContainer.style.display = 'block';
                
                const summaryHTML = selectedServices.map(service => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background-color: white; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${service.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">
                                $${service.vendorPrice || 0} • ${service.vendorDuration || service.defaultDuration || 60} min
                                ${service.vendorDescription ? ` • ${service.vendorDescription}` : ''}
                            </div>
                        </div>
                        <div style="color: var(--primary); font-size: 0.85rem; font-weight: 500;">
                            ${service.category}
                        </div>
                    </div>
                `).join('');
                
                summaryList.innerHTML = summaryHTML;
            }
            
            function showNoServicesMessage() {
                document.getElementById('predefined-services-loading').style.display = 'none';
                document.getElementById('predefined-services-container').style.display = 'none';
                document.getElementById('no-services-message').style.display = 'block';
            }

            // Cloudinary Upload Function
            async function uploadImageToCloudinary(file, imageType) {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('imageType', imageType);
                
                try {
                    console.log(`Uploading ${imageType} image to Cloudinary:`, file.name);
                    
                    const response = await fetch(`${API_BASE_URL}/upload/image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed');
                    }
                    
                    const result = await response.json();
                    console.log('Cloudinary upload successful:', result);
                    
                    // Return the secure URL from Cloudinary - handle backend response format
                    return result.data?.url || result.secure_url || result.url;
                    
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    throw new Error(`Failed to upload ${imageType} image: ${error.message}`);
                }
            }

            // Gallery & Media Functions
            async function handleFeaturedImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    try {
                        console.log('Uploading featured image to Cloudinary...');
                        const uploadedUrl = await uploadImageToCloudinary(file, 'featured');
                        vendorSetupState.stepData.step3 = {
                            ...vendorSetupState.stepData.step3,
                            featuredImage: uploadedUrl
                        };
                        console.log('Featured image uploaded:', uploadedUrl);
                        
                        // Auto-submit Step 3 to save the featured image to database
                        console.log('Auto-submitting Step 3 to save featured image...');
                        await submitCurrentStepToBackend();
                    } catch (error) {
                        console.error('Failed to upload featured image:', error);
                        alert('Failed to upload featured image. Please try again.');
                    }
                }
            }

            async function handleGalleryUpload(event) {
                const files = event.target.files;
                for (const file of files) {
                    try {
                        console.log('Uploading gallery image to Cloudinary:', file.name);
                        const uploadedUrl = await uploadImageToCloudinary(file, 'gallery');
                        vendorSetupState.gallery.push({
                            url: uploadedUrl,
                            type: 'upload',
                            caption: file.name
                        });
                        updateGalleryDisplay();
                        console.log('Gallery image uploaded:', uploadedUrl);
                        
                        // Auto-submit Step 3 to save gallery images to database
                        console.log('Auto-submitting Step 3 to save gallery images...');
                        await submitCurrentStepToBackend();
                    } catch (error) {
                        console.error('Failed to upload gallery image:', error);
                        alert(`Failed to upload ${file.name}. Please try again.`);
                    }
                }
            }

            function showPortfolioForm() {
                document.getElementById('portfolio-form').style.display = 'block';
            }

            async function addPortfolioItem() {
                const title = document.getElementById('portfolio-title')?.value;
                const description = document.getElementById('portfolio-description')?.value;
                const imageFile = document.getElementById('portfolio-image')?.files[0];
                
                if (title && description) {
                    const portfolioItem = { title, description };
                    
                    if (imageFile) {
                        try {
                            console.log('Uploading portfolio image to Cloudinary:', imageFile.name);
                            portfolioItem.imageUrl = await uploadImageToCloudinary(imageFile, 'portfolio');
                            console.log('Portfolio image uploaded:', portfolioItem.imageUrl);
                        } catch (error) {
                            console.error('Failed to upload portfolio image:', error);
                            alert('Failed to upload portfolio image. Please try again.');
                            return;
                        }
                    }
                    
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            portfolioItem.image = e.target.result;
                            vendorSetupState.portfolio.push(portfolioItem);
                            updatePortfolioDisplay();
                            clearPortfolioForm();
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        vendorSetupState.portfolio.push(portfolioItem);
                        updatePortfolioDisplay();
                        clearPortfolioForm();
                    }
                }
            }

            // Services & Packages Functions
            function showServiceCategoryForm() {
                document.getElementById('service-category-form').style.display = 'block';
            }

            function addServiceCategory() {
                const name = document.getElementById('category-name')?.value;
                const description = document.getElementById('category-description')?.value;
                
                if (name) {
                    if (!vendorSetupState.serviceCategories) {
                        vendorSetupState.serviceCategories = [];
                    }
                    vendorSetupState.serviceCategories.push({
                        name, 
                        description: description || ''
                    });
                    updateServiceCategoriesDisplay();
                    clearServiceCategoryForm();
                    document.getElementById('service-category-form').style.display = 'none';
                }
            }

            function showServiceForm() {
                document.getElementById('service-form').style.display = 'block';
                const addServiceBtn = document.getElementById('add-service-btn');
                if (addServiceBtn) {
                    addServiceBtn.style.display = 'block';
                    addServiceBtn.textContent = 'Add Another Service';
                }
            }

            function addServiceItem() {
                const name = document.getElementById('service-name')?.value?.trim();
                const description = document.getElementById('service-description')?.value?.trim();
                const price = document.getElementById('service-price')?.value;
                const duration = document.getElementById('service-duration')?.value;
                
                if (!name || !description || !price) {
                    alert('Please fill in all required fields: Service Name, Description, and Price.');
                    return;
                }
                
                if (parseFloat(price) <= 0) {
                    alert('Please enter a valid price greater than 0.');
                    return;
                }
                
                vendorSetupState.services.push({
                    name, 
                    description, 
                    price: parseFloat(price), 
                    duration: duration ? parseInt(duration) : null
                });
                
                updateServicesDisplay();
                clearServiceForm();
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'background-color: #d4edda; color: #155724; padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid #c3e6cb;';
                successMsg.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>Service "${name}" added successfully!`;
                
                const serviceForm = document.getElementById('service-form');
                serviceForm.parentNode.insertBefore(successMsg, serviceForm);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);
                
                console.log('Service added:', { name, description, price, duration });
                console.log('Current services:', vendorSetupState.services);
            }

            function showPackageForm() {
                document.getElementById('package-form').style.display = 'block';
            }

            function addPackageItem() {
                const name = document.getElementById('package-name')?.value;
                const description = document.getElementById('package-description')?.value;
                const price = document.getElementById('package-price')?.value;
                const includes = document.getElementById('package-includes')?.value;
                
                if (name && description && price) {
                    vendorSetupState.packages.push({
                        name, description, price: parseFloat(price), includes
                    });
                    updatePackagesDisplay();
                    clearPackageForm();
                }
            }

            // Team Functions
            function showTeamMemberForm() {
                document.getElementById('team-form').style.display = 'block';
            }

            function addTeamMember() {
                const name = document.getElementById('team-name')?.value;
                const role = document.getElementById('team-role')?.value;
                const bio = document.getElementById('team-bio')?.value;
                const photoFile = document.getElementById('team-photo')?.files[0];
                
                if (name && role) {
                    const teamMember = { name, role, bio };
                    
                    if (photoFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            teamMember.photo = e.target.result;
                            vendorSetupState.teamMembers.push(teamMember);
                            updateTeamDisplay();
                            clearTeamForm();
                        };
                        reader.readAsDataURL(photoFile);
                    } else {
                        vendorSetupState.teamMembers.push(teamMember);
                        updateTeamDisplay();
                        clearTeamForm();
                    }
                }
            }

            // FAQ Functions
            function showFaqForm() {
                document.getElementById('faq-form').style.display = 'block';
            }

            // Old addFaqItem function removed - using the new one that properly handles FAQ data

            // Display Update Functions
            function updateGalleryDisplay() {
                // Update gallery preview
                console.log('Gallery updated:', vendorSetupState.gallery);
            }

            function updatePortfolioDisplay() {
                const container = document.getElementById('portfolio-list');
                if (container) {
                    container.innerHTML = vendorSetupState.portfolio.map((item, index) => `
                        <div class="portfolio-item">
                            <strong>${item.title}</strong>
                            <p>${item.description}</p>
                            <button onclick="removePortfolioItem(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateServiceCategoriesDisplay() {
                const container = document.getElementById('service-categories-list');
                if (container && vendorSetupState.serviceCategories) {
                    container.innerHTML = vendorSetupState.serviceCategories.map((category, index) => `
                        <div class="service-category-item">
                            <strong>${category.name}</strong>
                            <p>${category.description}</p>
                            <button onclick="removeServiceCategory(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateServicesDisplay() {
                const container = document.getElementById('services-list');
                if (container) {
                    if (vendorSetupState.services.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No services added yet. Please add at least one service to continue.</p>';
                    } else {
                        container.innerHTML = vendorSetupState.services.map((service, index) => `
                            <div class="service-item" style="background-color: var(--secondary); padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <h6 style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--primary);">${service.name}</h6>
                                        <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-light);">${service.description}</p>
                                        <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
                                            <span style="font-weight: 600; color: var(--primary);">$${service.price}</span>
                                            ${service.duration ? `<span style="color: var(--text-light);">${service.duration} min</span>` : ''}
                                        </div>
                                    </div>
                                    <button onclick="removeService(${index})" style="background-color: var(--accent); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; margin-left: 1rem;">×</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }

            function updatePackagesDisplay() {
                const container = document.getElementById('packages-list');
                if (container) {
                    container.innerHTML = vendorSetupState.packages.map((pkg, index) => `
                        <div class="package-item">
                            <strong>${pkg.name}</strong> - $${pkg.price}
                            <p>${pkg.description}</p>
                            <button onclick="removePackage(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateTeamDisplay() {
                const container = document.getElementById('team-list');
                if (container) {
                    container.innerHTML = vendorSetupState.teamMembers.map((member, index) => `
                        <div class="team-item">
                            <strong>${member.name}</strong> - ${member.role}
                            <p>${member.bio}</p>
                            <button onclick="removeTeamMember(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateFaqDisplay() {
                const container = document.getElementById('faqs-list');
                if (container) {
                    container.innerHTML = vendorSetupState.faqs.map((faq, index) => `
                        <div class="faq-item">
                            <strong>Q: ${faq.question}</strong>
                            <p>A: ${faq.answer}</p>
                            <button onclick="removeFaq(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            // Clear Form Functions
            function clearPortfolioForm() {
                document.getElementById('portfolio-title').value = '';
                document.getElementById('portfolio-description').value = '';
                document.getElementById('portfolio-image').value = '';
                document.getElementById('portfolio-form').style.display = 'none';
            }

            function clearServiceCategoryForm() {
                document.getElementById('category-name').value = '';
                document.getElementById('category-description').value = '';
            }

            function clearServiceForm() {
                document.getElementById('service-name').value = '';
                document.getElementById('service-description').value = '';
                document.getElementById('service-price').value = '';
                document.getElementById('service-duration').value = '';
                // Don't hide the form automatically - let user decide
            }

            function clearPackageForm() {
                document.getElementById('package-name').value = '';
                document.getElementById('package-description').value = '';
                document.getElementById('package-price').value = '';
                document.getElementById('package-includes').value = '';
                document.getElementById('package-form').style.display = 'none';
            }

            function clearTeamForm() {
                document.getElementById('team-name').value = '';
                document.getElementById('team-role').value = '';
                document.getElementById('team-bio').value = '';
                document.getElementById('team-photo').value = '';
                document.getElementById('team-form').style.display = 'none';
            }

            function clearFaqForm() {
                document.getElementById('faq-question').value = '';
                document.getElementById('faq-answer').value = '';
                document.getElementById('faq-form').style.display = 'none';
            }

            // FAQ Management Functions
            function addFaqItem() {
                const question = document.getElementById('faq-question').value.trim();
                const answer = document.getElementById('faq-answer').value.trim();
                
                if (!question || !answer) {
                    alert('Please provide both question and answer.');
                    return;
                }
                
                // Initialize FAQ array if it doesn't exist
                if (!vendorSetupState.faqs) {
                    vendorSetupState.faqs = [];
                }
                
                // Add FAQ to state
                vendorSetupState.faqs.push({
                    question: question,
                    answer: answer
                });
                
                // Update display
                updateFaqsDisplay();
                
                // Clear form
                clearFaqForm();
            }

            function updateFaqsDisplay() {
                const faqsList = document.getElementById('faqs-list');
                if (!faqsList) return;
                
                faqsList.innerHTML = '';
                
                if (vendorSetupState.faqs && vendorSetupState.faqs.length > 0) {
                    vendorSetupState.faqs.forEach((faq, index) => {
                        const faqItem = document.createElement('div');
                        faqItem.className = 'faq-item-display';
                        faqItem.style.cssText = 'background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;';
                        faqItem.innerHTML = `
                            <div class="faq-question-text" style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">
                                Q: ${faq.question}
                            </div>
                            <div class="faq-answer-text" style="margin-bottom: 1rem; color: var(--text);">
                                A: ${faq.answer}
                            </div>
                            <button type="button" class="btn btn-outline" onclick="removeFaq(${index})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                Remove
                            </button>
                        `;
                        faqsList.appendChild(faqItem);
                    });
                }
            }

            function removeFaq(index) {
                if (vendorSetupState.faqs && vendorSetupState.faqs[index]) {
                    vendorSetupState.faqs.splice(index, 1);
                    updateFaqsDisplay();
                }
            }

            // Step 8 API Submission Function
            async function submitStep8FAQ() {
                try {
                    // Save current step data
                    saveCurrentStepData();
                    
                    const step8Data = vendorSetupState.stepData.step8;
                    
                    if (!vendorSetupState.vendorProfileId) {
                        throw new Error('Vendor profile ID not found');
                    }
                    
                    // Submit FAQ data to backend
                    const response = await fetch(`${API_BASE_URL}/vendors/setup/step8-faq`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            faqs: step8Data.faqs || []
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save FAQ data');
                    }
                    
                    const result = await response.json();
                    console.log('Step 8 FAQ data saved successfully:', result);
                    
                    // Move to next step
                    vendorSetupState.currentStep = 9;
                    showSetupStep(9);
                    
                } catch (error) {
                    console.error('Error submitting Step 8 FAQ data:', error);
                    alert('Failed to save FAQ data: ' + error.message);
                }
            }

            // Remove Functions
            function removeServiceCategory(index) {
                if (vendorSetupState.serviceCategories) {
                    vendorSetupState.serviceCategories.splice(index, 1);
                    updateServiceCategoriesDisplay();
                }
            }

            // Services Functions
            function addServiceItem() {
                const serviceName = document.getElementById('service-name')?.value?.trim();
                const serviceDescription = document.getElementById('service-description')?.value?.trim();
                const servicePrice = document.getElementById('service-price')?.value;
                const serviceDuration = document.getElementById('service-duration')?.value || '60';

                if (!serviceName || !serviceDescription || !servicePrice) {
                    alert('Please fill in all required service fields.');
                    return;
                }

                const service = {
                    id: Date.now(),
                    name: serviceName,
                    description: serviceDescription,
                    price: parseFloat(servicePrice),
                    duration: parseInt(serviceDuration)
                };

                // Add to vendor setup state (with safety check)
                if (typeof vendorSetupState !== 'undefined') {
                    if (!vendorSetupState.services) {
                        vendorSetupState.services = [];
                    }
                    vendorSetupState.services.push(service);
                } else {
                    // Fallback: create temporary storage if vendorSetupState doesn't exist
                    if (!window.tempServices) {
                        window.tempServices = [];
                    }
                    window.tempServices.push(service);
                }

                // Update display
                updateServicesDisplay();

                // Clear form
                clearServiceForm();

                console.log('✓ Service added:', service);
            }

            function updateServicesDisplay() {
                const servicesList = document.getElementById('services-list');
                if (!servicesList) return;

                // Get services from either vendorSetupState or temporary storage
                let services = [];
                if (typeof vendorSetupState !== 'undefined' && vendorSetupState.services) {
                    services = vendorSetupState.services;
                } else if (window.tempServices) {
                    services = window.tempServices;
                }

                if (services.length === 0) {
                    servicesList.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No services added yet.</p>';
                    return;
                }

                const servicesHtml = services.map((service, index) => `
                    <div class="service-item" style="
                        background-color: white;
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 1rem;
                        margin-bottom: 0.5rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                    ">
                        <div style="flex: 1;">
                            <h6 style="margin: 0 0 0.5rem 0; color: var(--primary); font-weight: 600;">${service.name}</h6>
                            <p style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">${service.description}</p>
                            <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-light);">
                                <span><strong>Price:</strong> $${service.price.toFixed(2)}</span>
                                <span><strong>Duration:</strong> ${service.duration} min</span>
                            </div>
                        </div>
                        <button onclick="removeService(${index})" style="
                            background: var(--accent);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-left: 0.5rem;
                        " title="Remove service">×</button>
                    </div>
                `).join('');

                servicesList.innerHTML = servicesHtml;
            }

            function removeService(index) {
                // Remove from either vendorSetupState or temporary storage
                if (typeof vendorSetupState !== 'undefined' && vendorSetupState.services && index >= 0 && index < vendorSetupState.services.length) {
                    vendorSetupState.services.splice(index, 1);
                    updateServicesDisplay();
                    console.log('✓ Service removed at index:', index);
                } else if (window.tempServices && index >= 0 && index < window.tempServices.length) {
                    window.tempServices.splice(index, 1);
                    updateServicesDisplay();
                    console.log('✓ Service removed at index:', index);
                }
            }

            function clearServiceForm() {
                document.getElementById('service-name').value = '';
                document.getElementById('service-description').value = '';
                document.getElementById('service-price').value = '';
                document.getElementById('service-duration').value = '';
            }

            // FAQ Functions (ensure they exist)
            function showFaqForm() {
                const faqForm = document.getElementById('faq-form');
                if (faqForm) {
                    faqForm.style.display = 'block';
                }
            }

            function addFaqItem() {
                const faqQuestion = document.getElementById('faq-question')?.value?.trim();
                const faqAnswer = document.getElementById('faq-answer')?.value?.trim();

                if (!faqQuestion || !faqAnswer) {
                    alert('Please fill in both question and answer fields.');
                    return;
                }

                const faq = {
                    id: Date.now(),
                    question: faqQuestion,
                    answer: faqAnswer
                };

                // Add to vendor setup state
                if (!vendorSetupState.faqs) {
                    vendorSetupState.faqs = [];
                }
                vendorSetupState.faqs.push(faq);

                // Update display
                updateFaqsDisplay();

                // Clear form and hide it
                document.getElementById('faq-question').value = '';
                document.getElementById('faq-answer').value = '';
                document.getElementById('faq-form').style.display = 'none';

                console.log('✓ FAQ added:', faq);
            }

            function updateFaqsDisplay() {
                const faqsList = document.getElementById('faqs-list');
                if (!faqsList || !vendorSetupState.faqs) return;

                if (vendorSetupState.faqs.length === 0) {
                    faqsList.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No FAQs added yet.</p>';
                    return;
                }

                const faqsHtml = vendorSetupState.faqs.map((faq, index) => `
                    <div class="faq-item" style="
                        background-color: white;
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 1rem;
                        margin-bottom: 0.5rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                    ">
                        <div style="flex: 1;">
                            <h6 style="margin: 0 0 0.5rem 0; color: var(--primary); font-weight: 600;">${faq.question}</h6>
                            <p style="margin: 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">${faq.answer}</p>
                        </div>
                        <button onclick="removeFaq(${index})" style="
                            background: var(--accent);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-left: 0.5rem;
                        " title="Remove FAQ">×</button>
                    </div>
                `).join('');

                faqsList.innerHTML = faqsHtml;
            }

            function removeFaq(index) {
                if (vendorSetupState.faqs && index >= 0 && index < vendorSetupState.faqs.length) {
                    vendorSetupState.faqs.splice(index, 1);
                    updateFaqsDisplay();
                    console.log('✓ FAQ removed at index:', index);
                }
            }

            // Complete Vendor Setup
            async function completeVendorSetup() {
                try {
                    // Save current step data (Step 10)
                    saveCurrentStepData();

                    // Show loading
                    const completeBtn = document.getElementById('complete-setup-btn');
                    completeBtn.textContent = 'Completing Setup...';
                    completeBtn.disabled = true;

                    // Get vendor profile ID
                    if (!vendorSetupState.vendorProfileId) {
                        const vendorProfileResponse = await fetch(`${API_BASE_URL}/vendors/profile?userId=${vendorSetupState.vendorId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (!vendorProfileResponse.ok) {
                            throw new Error('Failed to fetch vendor profile ID');
                        }

                        const vendorProfileData = await vendorProfileResponse.json();
                        vendorSetupState.vendorProfileId = vendorProfileData.vendorProfileId;
                    }

                    // Submit completion data to backend
                    const response = await fetch(`${API_BASE_URL}/vendors/setup/step9-completion`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            faqs: vendorSetupState.faqs || [],
                            testimonials: vendorSetupState.testimonials || []
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Setup completion failed');
                    }

                    const result = await response.json();
                    
                    alert('🎉 Congratulations! Your vendor profile setup is complete and now live!');
                    vendorRegistrationModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    
                    // Update current user to vendor mode
                    currentUser.isVendor = true;
                    
                    // Redirect to vendor dashboard
                    displayUserDashboard('vendor', 'vendor-dashboard');
                    
                } catch (error) {
                    console.error('Setup completion error:', error);
                    alert('Setup failed: ' + error.message);
                } finally {
                    const completeBtn = document.getElementById('complete-setup-btn');
                    if (completeBtn) {
                        completeBtn.textContent = '🚀 Complete Setup & Go Live!';
                        completeBtn.disabled = false;
                    }
                }
            }

            // Remove FAQ function
            function removeFaq(index) {
                vendorSetupState.faqs.splice(index, 1);
                updateFaqDisplay();
            }

            function renderGalleryPreview() {
                const container = document.getElementById('gallery-preview');
                container.innerHTML = vendorSetupState.gallery.map((item, index) => `
                    <div class="gallery-item">
                        <img src="${item.url}" alt="${item.caption}">
                        <button class="remove-btn" onclick="removeGalleryItem(${index})">×</button>
                    </div>
                `).join('');
            }

            function removeGalleryItem(index) {
                vendorSetupState.gallery.splice(index, 1);
                renderGalleryPreview();
            }

            function addPackage() {
                const form = document.getElementById('package-form');
                const packageData = {
                    name: form.querySelector('[name="package_name"]').value,
                    description: form.querySelector('[name="description"]').value,
                    price: parseFloat(form.querySelector('[name="price"]').value),
                    duration: form.querySelector('[name="duration"]').value,
                    maxGuests: parseInt(form.querySelector('[name="max_guests"]').value),
                    includes: form.querySelector('[name="includes"]').value
                };
                
                if (!packageData.name || !packageData.price) {
                    alert('Please fill in package name and price');
                    return;
                }
                
                vendorSetupState.packages.push(packageData);
                renderPackagesList();
                form.reset();
                form.style.display = 'none';
            }

            function addService() {
                const form = document.getElementById('service-form');
                const serviceData = {
                    name: form.querySelector('[name="service_name"]').value,
                    description: form.querySelector('[name="service_description"]').value,
                    price: parseFloat(form.querySelector('[name="service_price"]').value),
                    duration: form.querySelector('[name="service_duration"]').value
                };
                
                if (!serviceData.name || !serviceData.price) {
                    alert('Please fill in service name and price');
                    return;
                }
                
                vendorSetupState.services.push(serviceData);
                renderServicesList();
                form.reset();
                form.style.display = 'none';
            }

            function renderPackagesList() {
                const container = document.getElementById('packages-list');
                container.innerHTML = vendorSetupState.packages.map((pkg, index) => `
                    <div class="package-item">
                        <h6>${pkg.name}</h6>
                        <p>${pkg.description}</p>
                        <div class="price">$${pkg.price} - ${pkg.duration}</div>
                        <button onclick="removePackage(${index})" style="margin-top: 0.5rem; background: var(--accent); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            }

            function renderServicesList() {
                const container = document.getElementById('services-list');
                container.innerHTML = vendorSetupState.services.map((service, index) => `
                    <div class="service-item">
                        <h6>${service.name}</h6>
                        <p>${service.description}</p>
                        <div class="price">$${service.price} - ${service.duration}</div>
                        <button onclick="removeService(${index})" style="margin-top: 0.5rem; background: var(--accent); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            }

            function removePackage(index) {
                vendorSetupState.packages.splice(index, 1);
                renderPackagesList();
            }

            function removeService(index) {
                vendorSetupState.services.splice(index, 1);
                updateServicesDisplay();
                
                // If no services left, show the service form again
                if (vendorSetupState.services.length === 0) {
                    document.getElementById('service-form').style.display = 'block';
                    const addServiceBtn = document.getElementById('add-service-btn');
                    if (addServiceBtn) {
                        addServiceBtn.style.display = 'none';
                        addServiceBtn.textContent = 'Add Service';
                    }
                }
            }

            function saveCurrentStepData() {
                console.log('saveCurrentStepData called for step:', vendorSetupState.currentStep);
                switch (vendorSetupState.currentStep) {
                    case 3: // Social Media
                        const platforms = ['facebook', 'instagram', 'twitter', 'linkedin', 'youtube', 'tiktok'];
                        platforms.forEach(platform => {
                            const input = document.getElementById(`social-${platform}`);
                            if (input && input.value.trim()) {
                                vendorSetupState.socialMedia[platform] = input.value.trim();
                            }
                        });
                        break;
                    case 4: // Additional Details - Category Questions
                        // Collect category question responses
                        if (!vendorSetupState.categoryQuestions) {
                            vendorSetupState.categoryQuestions = [];
                        }
                        
                        // Find all question inputs in the category-questions-container
                        const container = document.getElementById('category-questions-container');
                        if (container) {
                            const questionInputs = container.querySelectorAll('input[name^="question_"], textarea[name^="question_"]');
                            questionInputs.forEach(input => {
                                const questionId = input.name.replace('question_', '');
                                let value = null;
                                
                                if (input.type === 'radio' && input.checked) {
                                    value = input.value;
                                } else if (input.type === 'number' || input.tagName === 'TEXTAREA') {
                                    value = input.value.trim();
                                }
                                
                                if (value) {
                                    // Update existing answer or add new one
                                    const existingIndex = vendorSetupState.categoryQuestions.findIndex(q => q.questionId === questionId);
                                    if (existingIndex >= 0) {
                                        vendorSetupState.categoryQuestions[existingIndex].answer = value;
                                    } else {
                                        vendorSetupState.categoryQuestions.push({
                                            questionId: questionId,
                                            answer: value
                                        });
                                    }
                                }
                            });
                        }
                        console.log('Step 4 - Category questions collected:', vendorSetupState.categoryQuestions);
                        break;
                    case 5: // Time & Availability
                        const businessHours = {};
                        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        dayNames.forEach((day, index) => {
                            const checkbox = document.getElementById(`available-${index}`);
                            const startTime = document.getElementById(`start-time-${index}`);
                            const endTime = document.getElementById(`end-time-${index}`);
                            businessHours[day] = {
                                enabled: checkbox?.checked || false,
                                start: startTime?.value || '',
                                end: endTime?.value || ''
                            };
                        });
                        
                        // Get available dates
                        const availableDates = document.getElementById('availability-dates')?.value || '';
                        
                        // Validate that at least one date is provided
                        if (!availableDates.trim()) {
                            alert('Please provide at least one available date to continue.');
                            return false;
                        }
                        
                        vendorSetupState.stepData.step5 = {
                            businessHours,
                            minimumBookingLeadTime: document.getElementById('lead-time')?.value || '',
                            maximumBookingAdvance: document.getElementById('maximum-booking-advance')?.value || '',
                            cancellationPolicy: document.getElementById('cancellation-policy')?.value || '',
                            availableDates: availableDates
                        };
                        
                        console.log('Step 5 data saved:', vendorSetupState.stepData.step5);
                        break;
                    case 10: // Setup Completion - Collect FAQ data
                        // Collect FAQ data from the UI
                        if (!vendorSetupState.faqs) {
                            vendorSetupState.faqs = [];
                        }
                        // FAQs are already collected via addFAQ function, so just ensure they exist
                        console.log('Step 10 - FAQ data collected:', vendorSetupState.faqs);
                        break;
                }
            }

            // Remove functions for various items
            function removePortfolioItem(index) {
                vendorSetupState.portfolio.splice(index, 1);
                updatePortfolioDisplay();
            }

            function removeTeamMember(index) {
                vendorSetupState.teamMembers.splice(index, 1);
                updateTeamDisplay();
            }

            // Submit current step data to backend
            async function submitCurrentStepToBackend() {
                const currentStep = vendorSetupState.currentStep;
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }

                // Get vendor profile ID if not already set
                if (!vendorSetupState.vendorProfileId) {
                    const vendorProfileResponse = await fetch(`${API_BASE_URL}/vendors/profile?userId=${vendorSetupState.vendorId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!vendorProfileResponse.ok) {
                        throw new Error('Failed to fetch vendor profile ID');
                    }

                    const vendorProfileData = await vendorProfileResponse.json();
                    vendorSetupState.vendorProfileId = vendorProfileData.vendorProfileId;
                }

                // Function to get city coordinates using Google Places API
                async function getCityCoordinates(cityName, state, country) {
                    return new Promise((resolve) => {
                        if (!window.google || !window.google.maps || !window.google.maps.places) {
                            console.warn('Google Places API not available, using fallback coordinates');
                            resolve({
                                lat: 0,
                                lng: 0,
                                placeId: '',
                                formattedAddress: `${cityName}, ${state || ''}, ${country || ''}`,
                                placeType: 'locality',
                                postalCode: null,
                                bounds: null
                            });
                            return;
                        }

                        const service = new google.maps.places.PlacesService(document.createElement('div'));
                        const request = {
                            query: `${cityName}, ${state || ''}, ${country || ''}`,
                            fields: ['place_id', 'geometry', 'formatted_address', 'types', 'address_components']
                        };

                        service.textSearch(request, (results, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                                const place = results[0];
                                const location = place.geometry.location;
                                
                                // Extract postal code from address components
                                let postalCode = null;
                                if (place.address_components) {
                                    const postalComponent = place.address_components.find(comp => 
                                        comp.types.includes('postal_code')
                                    );
                                    postalCode = postalComponent ? postalComponent.long_name : null;
                                }

                                resolve({
                                    lat: location.lat(),
                                    lng: location.lng(),
                                    placeId: place.place_id,
                                    formattedAddress: place.formatted_address,
                                    placeType: place.types[0] || 'locality',
                                    postalCode: postalCode,
                                    bounds: place.geometry.viewport ? {
                                        northeast: {
                                            lat: place.geometry.viewport.getNorthEast().lat(),
                                            lng: place.geometry.viewport.getNorthEast().lng()
                                        },
                                        southwest: {
                                            lat: place.geometry.viewport.getSouthWest().lat(),
                                            lng: place.geometry.viewport.getSouthWest().lng()
                                        }
                                    } : null
                                });
                            } else {
                                console.warn(`Could not find coordinates for ${cityName}, using fallback`);
                                resolve({
                                    lat: 0,
                                    lng: 0,
                                    placeId: '',
                                    formattedAddress: `${cityName}, ${state || ''}, ${country || ''}`,
                                    placeType: 'locality',
                                    postalCode: null,
                                    bounds: null
                                });
                            }
                        });
                    });
                }

                // Prepare step data based on current step
                let stepData = {};
                let endpoint = '';

                switch (currentStep) {
                    case 1: // Business Basics
                        const primaryCategory = document.getElementById('primary-category')?.value || '';
                        const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || []).map(option => option.value);
                        const allCategories = primaryCategory ? [primaryCategory, ...additionalCategories.filter(cat => cat !== primaryCategory)] : additionalCategories;
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            businessName: document.getElementById('business-name')?.value || '',
                            businessEmail: document.getElementById('business-email')?.value || '',
                            businessPhone: document.getElementById('business-phone')?.value || '',
                            businessDescription: document.getElementById('business-description')?.value || '',
                            primaryCategory: primaryCategory,
                            displayName: document.getElementById('display-name')?.value || '',
                            website: document.getElementById('website-url')?.value || '',
                            tagline: document.getElementById('tagline')?.value || '',
                            yearsInBusiness: parseInt(document.getElementById('years-in-business')?.value) || 0,
                            categories: allCategories
                        };
                        endpoint = '/vendors/setup/step1-business-basics';
                        break;

                    case 2: // Location Information
                        // Collect service areas from vendorSetupState.selectedCities or any available city containers
                        const serviceAreas = [];
                        
                        // Method 1: Use vendorSetupState.selectedCities if available
                        if (typeof vendorSetupState !== 'undefined' && vendorSetupState.selectedCities && vendorSetupState.selectedCities.length > 0) {
                            for (const cityName of vendorSetupState.selectedCities) {
                                try {
                                    // Try to get coordinates using Google Places API
                                    const coordinates = await getCityCoordinates(cityName, document.getElementById('business-state')?.value, document.getElementById('business-country')?.value);
                                    console.log(`🌍 Coordinates for ${cityName}:`, coordinates);
                                    
                                    // Ensure we always have valid coordinates (never null/undefined)
                                    const lat = (coordinates && typeof coordinates.lat === 'number') ? coordinates.lat : 0;
                                    const lng = (coordinates && typeof coordinates.lng === 'number') ? coordinates.lng : 0;
                                    
                                    serviceAreas.push({
                                        placeId: (coordinates && coordinates.placeId) || '',
                                        city: cityName,
                                        state: document.getElementById('business-state')?.value || '',
                                        country: document.getElementById('business-country')?.value || 'Canada',
                                        latitude: lat,
                                        longitude: lng,
                                        formattedAddress: (coordinates && coordinates.formattedAddress) || `${cityName}, ${document.getElementById('business-state')?.value || ''}`,
                                        placeType: (coordinates && coordinates.placeType) || 'locality',
                                        postalCode: (coordinates && coordinates.postalCode) || null,
                                        serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                        travelCost: null,
                                        minimumBookingAmount: null,
                                        bounds: (coordinates && coordinates.bounds) || null
                                    });
                                } catch (error) {
                                    console.error(`❌ Error getting coordinates for ${cityName}:`, error);
                                    // Fallback with guaranteed valid coordinates
                                    serviceAreas.push({
                                        placeId: '',
                                        city: cityName,
                                        state: document.getElementById('business-state')?.value || '',
                                        country: document.getElementById('business-country')?.value || 'Canada',
                                        latitude: 0,
                                        longitude: 0,
                                        formattedAddress: `${cityName}, ${document.getElementById('business-state')?.value || ''}`,
                                        placeType: 'locality',
                                        postalCode: null,
                                        serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                        travelCost: null,
                                        minimumBookingAmount: null,
                                        bounds: null
                                    });
                                }
                            }
                        }
                        
                        // Method 2: Try to find city tags in any container
                        if (serviceAreas.length === 0) {
                            const cityTags = document.querySelectorAll('.city-tag, .city-item, [data-city]');
                            cityTags.forEach(item => {
                                const cityName = item.textContent.replace('×', '').trim() || item.dataset.city;
                                if (cityName) {
                                    // Ensure coordinates are never null
                                    const lat = parseFloat(item.dataset.latitude) || 0;
                                    const lng = parseFloat(item.dataset.longitude) || 0;
                                    
                                    serviceAreas.push({
                                        placeId: item.dataset.placeId || '',
                                        city: cityName,
                                        state: document.getElementById('business-state')?.value || '',
                                        country: document.getElementById('business-country')?.value || 'Canada',
                                        latitude: lat,
                                        longitude: lng,
                                        formattedAddress: item.dataset.formattedAddress || `${cityName}, ${document.getElementById('business-state')?.value || ''}`,
                                        placeType: item.dataset.placeType || 'locality',
                                        postalCode: item.dataset.postalCode || null,
                                        serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                        travelCost: parseFloat(item.dataset.travelCost) || null,
                                        minimumBookingAmount: parseFloat(item.dataset.minimumBooking) || null,
                                        bounds: item.dataset.bounds ? JSON.parse(item.dataset.bounds) : null
                                    });
                                }
                            });
                        }
                        
                        // Method 3: Fallback - create a default service area based on main business location
                        if (serviceAreas.length === 0) {
                            const businessCity = document.getElementById('business-city')?.value;
                            if (businessCity) {
                                const businessLat = parseFloat(document.getElementById('business-latitude')?.value) || 0;
                                const businessLng = parseFloat(document.getElementById('business-longitude')?.value) || 0;
                                
                                serviceAreas.push({
                                    placeId: '',
                                    city: businessCity,
                                    state: document.getElementById('business-state')?.value || '',
                                    country: document.getElementById('business-country')?.value || 'Canada',
                                    latitude: businessLat,
                                    longitude: businessLng,
                                    formattedAddress: document.getElementById('business-address')?.value || `${businessCity}, ${document.getElementById('business-state')?.value || ''}`,
                                    placeType: 'locality',
                                    postalCode: document.getElementById('business-postal')?.value || null,
                                    serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                    travelCost: null,
                                    minimumBookingAmount: null,
                                    bounds: null
                                });
                            }
                        }
                        
                        console.log('🔍 Service areas collected:', serviceAreas);
                        
                        // Validate that no service area has null coordinates
                        serviceAreas.forEach((area, index) => {
                            if (area.latitude === null || area.longitude === null || area.latitude === undefined || area.longitude === undefined) {
                                console.error(`❌ Service area ${index} has null coordinates:`, area);
                                // Force to 0 if somehow null got through
                                area.latitude = area.latitude || 0;
                                area.longitude = area.longitude || 0;
                            }
                            console.log(`✓ Service area ${index}: ${area.city} (${area.latitude}, ${area.longitude})`);
                        });
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            address: document.getElementById('business-address')?.value || '',
                            city: document.getElementById('business-city')?.value || '',
                            state: document.getElementById('business-state')?.value || '',
                            postalCode: document.getElementById('business-postal')?.value || '',
                            country: document.getElementById('business-country')?.value || 'USA',
                            latitude: parseFloat(document.getElementById('business-latitude')?.value) || null,
                            longitude: parseFloat(document.getElementById('business-longitude')?.value) || null,
                            serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                            serviceAreas: serviceAreas
                        };
                        endpoint = '/vendors/setup/step2-location';
                        break;

                    case 3: // Services & Packages
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            serviceCategories: vendorSetupState.serviceCategories || [],
                            services: vendorSetupState.services || [],
                            packages: vendorSetupState.packages || [],
                            selectedPredefinedServices: vendorSetupState.selectedPredefinedServices || []
                        };
                        endpoint = '/vendors/setup/step3-services';
                        break;

                    case 4: // Additional Details - Category Questions
                        // Convert categoryQuestions to the format expected by backend
                        const categoryAnswers = (vendorSetupState.categoryQuestions || []).map(q => ({
                            questionId: parseInt(q.questionId), // Convert to integer
                            answer: q.answer
                        }));
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            categoryAnswers: categoryAnswers,
                            primaryCategory: document.getElementById('primary-category')?.value || ''
                        };
                        endpoint = '/vendors/setup/step4-additional-details';
                        break;

                    case 5: // Time & Availability
                        // Collect business hours data directly from DOM if step5 data doesn't exist
                        let businessHoursData = vendorSetupState.stepData.step5?.businessHours;
                        
                        if (!businessHoursData) {
                            // Collect directly from DOM
                            businessHoursData = {};
                            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            dayNames.forEach((day, index) => {
                                const checkbox = document.getElementById(`available-${index}`);
                                const startTime = document.getElementById(`start-time-${index}`);
                                const endTime = document.getElementById(`end-time-${index}`);
                                if (checkbox?.checked) {
                                    businessHoursData[index] = {
                                        isOpen: true,
                                        openTime: startTime?.value || '',
                                        closeTime: endTime?.value || ''
                                    };
                                }
                            });
                        } else {
                            // Convert from saved format to backend format
                            const convertedHours = {};
                            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            dayNames.forEach((day, index) => {
                                if (businessHoursData[day] && businessHoursData[day].enabled) {
                                    convertedHours[index] = {
                                        isOpen: true,
                                        openTime: businessHoursData[day].start,
                                        closeTime: businessHoursData[day].end
                                    };
                                }
                            });
                            businessHoursData = convertedHours;
                        }
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            businessHours: businessHoursData,
                            bookingSettings: {
                                minimumBookingLeadTime: document.getElementById('lead-time')?.value || '',
                                maximumBookingAdvance: document.getElementById('maximum-booking-advance')?.value || '',
                                cancellationPolicy: document.getElementById('cancellation-policy')?.value || ''
                            }
                        };
                        endpoint = '/vendors/setup/step5-availability';
                        break;

                    case 6: // Gallery & Media
                        // Use the Cloudinary URLs that were uploaded via handleFeaturedImageUpload
                        const featuredImage = vendorSetupState.stepData.step3?.featuredImage || 
                                            document.getElementById('featured-image-url')?.value || 
                                            'https://via.placeholder.com/400x300.jpg';
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            featuredImage: featuredImage,
                            galleryImages: vendorSetupState.gallery || [],
                            portfolioItems: vendorSetupState.portfolio || []
                        };
                        endpoint = '/vendors/setup/step6-gallery';
                        break;

                    case 7: // Social Media
                        const socialMediaProfiles = [];
                        
                        // Collect ALL social media profiles including YouTube and TikTok
                        const socialPlatforms = [
                            { platform: 'facebook', id: 'social-facebook', prefix: 'https://facebook.com/' },
                            { platform: 'instagram', id: 'social-instagram', prefix: 'https://instagram.com/' },
                            { platform: 'twitter', id: 'social-twitter', prefix: 'https://twitter.com/' },
                            { platform: 'linkedin', id: 'social-linkedin', prefix: 'https://linkedin.com/in/' },
                            { platform: 'youtube', id: 'social-youtube', prefix: 'https://youtube.com/' },
                            { platform: 'tiktok', id: 'social-tiktok', prefix: 'https://tiktok.com/@' }
                        ];
                        
                        socialPlatforms.forEach(item => {
                            const input = document.getElementById(item.id);
                            const userInput = input?.value?.trim() || '';
                            if (userInput) {
                                // Create full URL by combining prefix + user input
                                const fullUrl = item.prefix + userInput;
                                socialMediaProfiles.push({
                                    platform: item.platform,
                                    url: fullUrl
                                });
                            }
                        });
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            socialMediaProfiles,
                            bookingLink: document.getElementById('booking-link')?.value || ''
                        };
                        endpoint = '/vendors/setup/step7-social';
                        break;

                    case 8: // FAQ
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            faqs: vendorSetupState.faqs || []
                        };
                        endpoint = '/vendors/setup/step8-faq';
                        break;

                    case 9: // Verification & Legal
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            licenseNumber: document.getElementById('license-number')?.value || '',
                            insuranceVerified: document.getElementById('insurance-verified')?.checked || false,
                            awardsCertifications: document.getElementById('awards-certifications')?.value || '',
                            businessType: document.getElementById('business-type')?.value || '',
                            taxId: document.getElementById('tax-id')?.value || '',
                            isEcoFriendly: document.getElementById('eco-friendly')?.checked || false,
                            isPremium: document.getElementById('premium-status')?.checked || false
                        };
                        endpoint = '/vendors/setup/step9-verification';
                        break;

                    default:
                        // No submission needed for steps that don't have backend endpoints
                        return;
                }

                // Submit to backend
                console.log(`Submitting step ${currentStep} data:`, stepData);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(stepData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Step ${currentStep} submission failed`);
                }

                const result = await response.json();
                console.log(`Step ${currentStep} submitted successfully:`, result);
                return result;
            }

            // Make functions global for onclick handlers
            window.addPackage = addPackage;
            window.addService = addService;
            window.removePackage = removePackage;
            window.removeService = removeService;
            window.removeGalleryItem = removeGalleryItem;
            window.addServiceItem = addServiceItem;
            window.addFaqItem = addFaqItem;
            window.removeFaq = removeFaq;
            window.removeServiceCategory = removeServiceCategory;
            window.removeTeamMember = removeTeamMember;
            window.navigateToStep = navigateToStep;
            window.showStep = showStep;
            
            // Step navigation function with data saving
            async function navigateToStep(targetStep) {
                try {
                    // Save current step data before navigating
                    if (vendorSetupState.currentStep) {
                        saveCurrentStepData();
                        await submitCurrentStepToBackend();
                    }
                    
                    // Navigate to target step
                    vendorSetupState.currentStep = targetStep;
                    showStep(targetStep);
                    
                    // Load summary if navigating to step 9
                    if (targetStep === 9) {
                        setTimeout(() => {
                            loadVendorSummary();
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error navigating to step:', error);
                    alert('Error saving data: ' + error.message);
                }
            }
            
            // Show step function
            function showStep(stepNumber) {
                // Hide all steps
                document.querySelectorAll('.setup-step').forEach(step => {
                    step.style.display = 'none';
                });
                
                // Show target step
                const targetStep = document.getElementById(`setup-step-${stepNumber}`);
                if (targetStep) {
                    targetStep.style.display = 'block';
                }
                
                // Update step indicators
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    if (index + 1 <= stepNumber) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                });
                
                vendorSetupState.currentStep = stepNumber;
            }
            
            // Initialize event listeners when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Add Service button event listener
                const addServiceBtn = document.getElementById('add-service-item-btn');
                if (addServiceBtn) {
                    addServiceBtn.addEventListener('click', addServiceItem);
                }
                
                // Add FAQ button event listener
                const addFaqBtn = document.getElementById('add-faq-item-btn');
                if (addFaqBtn) {
                    addFaqBtn.addEventListener('click', addFaqItem);
                }
                
                // Complete setup button event listener
                const completeSetupBtn = document.getElementById('complete-setup-btn');
                if (completeSetupBtn) {
                    completeSetupBtn.addEventListener('click', completeVendorSetup);
                }
                
                // Step navigation buttons - Add event listeners for ALL step navigation buttons
                const stepButtons = [
                    { id: 'next-to-step-2', targetStep: 2 },
                    { id: 'next-to-step-3', targetStep: 3 },
                    { id: 'next-to-step-4', targetStep: 4 },
                    { id: 'next-to-step-5', targetStep: 5 },
                    { id: 'next-to-step-6', targetStep: 6 },
                    { id: 'next-to-step-7', targetStep: 7 },
                    { id: 'next-to-step-8', targetStep: 8 },
                    { id: 'next-to-step-9', targetStep: 9 },
                    { id: 'back-to-step-1', targetStep: 1 },
                    { id: 'back-to-step-2', targetStep: 2 },
                    { id: 'back-to-step-3', targetStep: 3 },
                    { id: 'back-to-step-4', targetStep: 4 },
                    { id: 'back-to-step-5', targetStep: 5 },
                    { id: 'back-to-step-6', targetStep: 6 },
                    { id: 'back-to-step-7', targetStep: 7 },
                    { id: 'back-to-step-8', targetStep: 8 }
                ];
                
                stepButtons.forEach(button => {
                    const btn = document.getElementById(button.id);
                    if (btn) {
                        btn.addEventListener('click', function() {
                            navigateToStep(button.targetStep);
                        });
                    }
                });
                
                // Social media inputs - ensure proper URL concatenation
                const socialInputs = ['social-facebook', 'social-instagram', 'social-twitter', 'social-linkedin', 'social-youtube', 'social-tiktok'];
                socialInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('blur', function() {
                            const prefix = this.getAttribute('data-prefix');
                            if (this.value && prefix) {
                                // Store the full URL in a data attribute for later use
                                this.setAttribute('data-full-url', prefix + this.value);
                            }
                        });
                    }
                });
            });
            
            // Handle Google Sign-in response
            async function handleGoogleSignIn(response) {
                const credential = response.credential;
                const decodedToken = parseJwt(credential);

                if (!decodedToken.email || !decodedToken.name) {
                    alert('Google sign-in failed. Email or name is missing.');
                    return;
                }

                try {
                    const apiResponse = await fetch(`${API_BASE_URL}/users/social-login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: decodedToken.email,
                            name: decodedToken.name,
                            authProvider: 'google',
                            avatar: decodedToken.picture
                        })
                    });

                    if (!apiResponse.ok) {
                        const errorData = await apiResponse.json();
                        throw new Error(errorData.message || 'Social login failed.');
                    }

                    const userData = await apiResponse.json();
                    localStorage.setItem('token', userData.token);
                    
                    simulateLogin({
                        id: userData.userId,
                        name: userData.name,
                        email: userData.email,
                        avatar: userData.avatar || userData.name[0].toUpperCase(),
                        isVendor: userData.isVendor || false
                    });
                    connectToChat();
                    promptForAccountType(userData.userId);

                } catch (error) {
                    console.error('Google sign-in API error:', error);
                    alert('Google sign-in failed: ' + error.message);
                }
            }

            function parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    return null;
                }
            }

            // Prompt user for account type after social login
            function promptForAccountType(userId) {
                const accountType = prompt("Welcome! Are you a Client or a Vendor? (Type 'client' or 'vendor')");
                if (accountType && accountType.toLowerCase() === 'vendor') {
                    if (currentUser) currentUser.isVendor = true;
                    // Automatically show the vendor setup wizard
                    initializeVendorSetup(userId);
                } else {
                    alert("You have been registered as a client. You can switch to a vendor account later.");
                }
            }


            // Filter vendors based on current filters
            function filterVendors() {
                // Get search term
                const searchTerm = searchInput.value.toLowerCase();

                // Get filter values
                const selectedTypes = [];
                document.querySelectorAll('.filter-section input[type="checkbox"]:checked').forEach(checkbox => {
                    if (checkbox.id !== 'current-location' && checkbox.id !== 'within50') {
                        selectedTypes.push(checkbox.id);
                    }
                });

                const priceRange = document.getElementById('price-slider').value;
                const useCurrentLocation = document.getElementById('current-location').checked;
                const within50Miles = document.getElementById('within50').checked;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const region = document.getElementById('region-select').value;

                // First apply all filters EXCEPT location
                let filtered = state.vendors.filter(vendor => {
                    // Category filter
                    if (state.currentCategory !== 'all' && vendor.category !== state.currentCategory) {
                        return false;
                    }

                    // Search term (vendor name, location, or services)
                    if (searchTerm) {
                        const nameMatch = vendor.name.toLowerCase().includes(searchTerm);
                        const locationMatch = vendor.location.toLowerCase().includes(searchTerm);
                        let serviceMatch = false;

                        if (vendor.services) {
                            serviceMatch = vendor.services.some(category =>
                                category.services.some(service =>
                                    service.name.toLowerCase().includes(searchTerm) ||
                                    service.description.toLowerCase().includes(searchTerm))
                            );
                        }

                        if (!nameMatch && !locationMatch && !serviceMatch) {
                            return false;
                        }
                    }


                    // Vendor type
                    const vendorType = vendor.type?.toLowerCase() || 'independent';
                    if (selectedTypes.length > 0 && !selectedTypes.includes(vendorType)) {
                        return false;
                    }

                    // Price range
                    if (priceRange < 33 && vendor.priceLevel === '$$$') return false;
                    if (priceRange > 66 && vendor.priceLevel === '$') return false;

                    // Popular filters
                    if (state.filters.popular.length > 0) {
                        if (state.filters.popular.includes('premium') && !vendor.isPremium) return false;
                        if (state.filters.popular.includes('eco-friendly') && !vendor.isEcoFriendly) return false;
                        if (state.filters.popular.includes('award-winning') && !vendor.isAwardWinning) return false;
                    }

                    // Date and time availability filter
                    const eventDateInput = document.getElementById('event-date');
                    const eventStartTimeInput = document.getElementById('event-start-time');
                    const eventEndTimeInput = document.getElementById('event-end-time');
                    
                    if (eventDateInput && eventDateInput.value && eventStartTimeInput && eventEndTimeInput) {
                        const eventDate = new Date(eventDateInput.value);
                        const eventDayOfWeek = eventDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                        const eventStartTime = eventStartTimeInput.value;
                        const eventEndTime = eventEndTimeInput.value;
                        
                        console.log('Filtering vendor:', vendor.name, 'for date:', eventDateInput.value, 'day:', eventDayOfWeek, 'time:', eventStartTime, '-', eventEndTime);
                        
                        // Check if vendor has business hours data
                        if (vendor.businessHours && Array.isArray(vendor.businessHours)) {
                            console.log('Vendor business hours:', vendor.businessHours);
                            
                            // Find schedule for the event day
                            const daySchedule = vendor.businessHours.find(h => h.DayOfWeek === eventDayOfWeek);
                            console.log('Day schedule for day', eventDayOfWeek, ':', daySchedule);
                            
                            if (!daySchedule || !daySchedule.IsAvailable) {
                                console.log('Vendor', vendor.name, 'is closed on day', eventDayOfWeek);
                                return false; // Vendor is closed on this day
                            }
                            
                            // Check if event time falls within business hours
                            if (eventStartTime && eventEndTime) {
                                const businessStart = daySchedule.OpenTime;
                                const businessEnd = daySchedule.CloseTime;
                                
                                console.log('Business hours:', businessStart, '-', businessEnd, 'vs Event time:', eventStartTime, '-', eventEndTime);
                                
                                if (eventStartTime < businessStart || eventEndTime > businessEnd) {
                                    console.log('Vendor', vendor.name, 'event time is outside business hours');
                                    return false; // Event time is outside business hours
                                }
                            }
                        } else {
                            console.log('Vendor', vendor.name, 'has no business hours data');
                        }
                    }

                    // Region filter
                    if (region && vendor.region !== region) {
                        return false;
                    }

                    return true;
                });

                // Handle location filter
                let locationMessage = '';
                if (useCurrentLocation && state.userLocation && within50Miles) {
                    // For demo purposes, we'll simulate nearby vendors by filtering the first few
                    const nearbyVendors = filtered.slice(0, 3);
                    if (nearbyVendors.length > 0) {
                        filtered = nearbyVendors;
                        locationMessage = `${filtered.length} vendors available near you`;
                    } else {
                        // If no nearby vendors, show ALL vendors that match other filters
                        locationMessage = "No vendors near you. Showing all available vendors.";
                    }
                } else {
                    locationMessage = `${filtered.length} vendors available`;
                }

                state.filteredVendors = filtered;
                resultsCount.textContent = locationMessage;

                // Apply sorting
                sortVendors(false);

                // Reset to first page
                state.currentPage = 1;

                // Update UI
                updateMetadata({ total: state.filteredVendors.length });
                renderVendors();

                // Update map if in map view
                if (state.map) {
                    // updateMapMarkers(); // DISABLED - causing marker bouncing
                }
            }

            // Sort vendors
            function sortVendors(shouldRender = true) {
                const sortValue = sortSelect.value;

                switch(sortValue) {
                    case 'price-low':
                        state.filteredVendors.sort((a, b) => {
                            const priceA = a.priceLevel === '$' ? 1 : a.priceLevel === '$$' ? 2 : 3;
                            const priceB = b.priceLevel === '$' ? 1 : b.priceLevel === '$$' ? 2 : 3;
                            return priceA - priceB;
                        });
                        break;
                    case 'price-high':
                        state.filteredVendors.sort((a, b) => {
                            const priceA = a.priceLevel === '$' ? 1 : a.priceLevel === '$$' ? 2 : 3;
                            const priceB = b.priceLevel === '$' ? 1 : b.priceLevel === '$$' ? 2 : 3;
                            return priceB - priceA;
                        });
                        break;
                    case 'popular':
                        state.filteredVendors.sort((a, b) => {
                            const ratingA = parseFloat(a.rating?.split(' ')[0] || 0);
                            const ratingB = parseFloat(b.rating?.split(' ')[0] || 0);
                            return ratingB - ratingA;
                        });
                        break;
                    case 'nearest':
                        if (state.userLocation) {
                            // In a real app, we would calculate distance properly
                            // For demo, we'll just shuffle the array
                            state.filteredVendors.sort(() => Math.random() - 0.5);
                        }
                        break;
                    case 'rating':
                        state.filteredVendors.sort((a, b) => {
                            const ratingA = a.rating || 0;
                            const ratingB = b.rating || 0;
                            return ratingB - ratingA;
                        });
                        break;
                    default:
                        break;
                }

                if (shouldRender) {
                    renderVendors();
                    if (state.map) {
                        // updateMapMarkers(); // DISABLED - causing marker bouncing
                    }
                }
            }

            // Reset specific filter
            function resetFilter(filterType) {
                switch(filterType) {
                    case 'location':
                        document.getElementById('location-input').value = '';
                        document.getElementById('current-location').checked = false;
                        break;
                    case 'type':
                        const ind = document.getElementById('independent');
                        const comp = document.getElementById('company');
                        if (ind) ind.checked = false;
                        if (comp) comp.checked = false;
                        if (state.filters) {
                            // Clear any stored type fields if present
                            if (state.filters.type) delete state.filters.type;
                            if (state.filters.vendorType) delete state.filters.vendorType;
                        }
                        break;
                }

                filterVendors();
            }


            // Helper function to get category icon
            function getCategoryIcon(category) {
                const icons = {
                    "all": "<i class='fas fa-sparkles'></i>",
                    "venue": "<i class='fas fa-building'></i>",
                    "photo": "<i class='fas fa-camera'></i>",
                    "music": "<i class='fas fa-music'></i>",
                    "catering": "<i class='fas fa-utensils'></i>",
                    "entertainment": "<i class='fas fa-theater-masks'></i>",
                    "experiences": "<i class='fas fa-star'></i>",
                    "decor": "<i class='fas fa-palette'></i>",
                    "beauty": "<i class='fas fa-spa'></i>",
                    "cake": "<i class='fas fa-birthday-cake'></i>",
                    "transport": "<i class='fas fa-car'></i>",
                    "planner": "<i class='fas fa-clipboard-list'></i>",
                    "fashion": "<i class='fas fa-tshirt'></i>",
                    "stationery": "<i class='fas fa-envelope'></i>"
                };
                return icons[category] || "<i class='fas fa-calendar-alt'></i>";
            }

            // Helper function to get category name
            function getCategoryName(category) {
                const names = {
                    "all": "All Categories",
                    "venue": "Venue",
                    "photo": "Photo/Video",
                    "music": "Music/DJ",
                    "catering": "Catering",
                    "entertainment": "Entertainment",
                    "experiences": "Experiences",
                    "decor": "Decorations",
                    "beauty": "Beauty",
                    "cake": "Cake",
                    "transport": "Transportation",
                    "planner": "Planner",
                    "fashion": "Fashion",
                    "stationery": "Stationery"
                };
                return names[category] || "Vendor";
            }

            // Render price indicator
            function renderPriceIndicator(priceLevel) {
                const levels = priceLevel || '$';
                let html = '';

                for (let i = 0; i < 3; i++) {
                    const isFilled = i < levels.length;
                    html += `<span class="price-dot ${isFilled ? 'filled' : ''}"></span>`;
                }

                return html;
            }

            // Update pagination controls
            function updatePagination() {
                const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);

                if (totalPages <= 1) {
                    pagination.style.display = 'none';
                    return;
                }

                pagination.style.display = 'flex';

                // Clear existing page buttons (except prev/next)
                const pageBtns = pagination.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)');
                pageBtns.forEach(btn => btn.remove());

                // Add page buttons
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('div');
                    pageBtn.className = `page-btn ${i === state.currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        state.currentPage = i;
                        renderVendors();
                    });

                    pagination.insertBefore(pageBtn, nextPageBtn);
                }

                // Update prev/next button states
                prevPageBtn.classList.toggle('disabled', state.currentPage === 1);
                nextPageBtn.classList.toggle('disabled', state.currentPage === totalPages);
            }

            // Update metadata in header
            function updateMetadata(metadata) {
                const usingLocation = state.userLocation && document.getElementById('current-location').checked;
                const locationText = usingLocation ? "Near You" : (metadata?.location || 'Los Angeles');
                const categoryText = state.currentCategory === 'all' ? '' : getCategoryName(state.currentCategory) + ' ';

                resultsTitle.textContent = `${categoryText}Vendors in ${locationText}`;
                resultsCount.textContent = `${state.filteredVendors.length} vendors available${usingLocation ? ' near you' : ''}`;
            }

            // Show error message
            function showError(message) {
                vendorGrid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--accent)">${message}</div>`;
                resultsTitle.textContent = "Error";
                resultsCount.textContent = message;
            }

            // Show dedicated vendor profile page
            async function showVendorProfilePage(vendorId) {
                console.log(`🔍 showVendorProfilePage called with vendorId: ${vendorId}`);
                console.log(`🔍 API_BASE_URL: ${API_BASE_URL}`);
                
                // Validate vendor ID
                if (!vendorId || vendorId === 'undefined' || vendorId === 'null') {
                    console.error('❌ Invalid vendor ID:', vendorId);
                    vendorProfilePage.innerHTML = `
                        <div style="text-align: center; margin-top: 5rem;">
                            <p style="color: var(--accent); margin-bottom: 1rem;">Invalid vendor ID</p>
                            <button onclick="window.location.hash = ''" class="btn btn-outline">← Back to search results</button>
                        </div>
                    `;
                    return;
                }

                mainAppView.style.display = 'none';
                clientDashboardContainer.style.display = 'none';
                vendorDashboardContainer.style.display = 'none';
                vendorProfilePage.style.display = 'block';
                document.body.style.overflow = 'auto';

                vendorProfilePage.innerHTML = '<p style="text-align: center; margin-top: 5rem;">Loading vendor profile...</p>';

                try {
                    const apiUrl = `${API_BASE_URL}/vendors/${vendorId}?userId=${currentUser ? currentUser.id : ''}`;
                    console.log(`🔍 Fetching vendor data from: ${apiUrl}`);
                    
                    const response = await fetch(apiUrl);
                    console.log(`🔍 API Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch vendor details: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    const fullVendorDetails = data.data;

                    // Debug logging for services
                    console.log('🔍 Full API Response:', data);
                    console.log('🔍 Vendor Details:', fullVendorDetails);
                    console.log('🔍 Services Data:', fullVendorDetails.services);
                    console.log('🔍 Services Length:', fullVendorDetails.services ? fullVendorDetails.services.length : 'undefined');

                    renderVendorProfile(fullVendorDetails);
                    
                    // Add logic for the new review form
                    const reviewForm = document.getElementById('review-form');
                    const showReviewFormBtn = document.getElementById('show-review-form');
                    const ratingStars = document.querySelectorAll('#review-form .rating-star');
                    let currentRating = 0;
                    
                    if(showReviewFormBtn) {
                        showReviewFormBtn.addEventListener('click', () => {
                            reviewForm.style.display = 'block';
                            showReviewFormBtn.style.display = 'none';
                        });
                    }

                    ratingStars.forEach(star => {
                        star.addEventListener('click', () => {
                            currentRating = parseInt(star.dataset.rating);
                            ratingStars.forEach(s => {
                                s.classList.toggle('selected', parseInt(s.dataset.rating) <= currentRating);
                            });
                        });
                    });
                    
                    const submitReviewBtn = document.getElementById('submit-review');
                    if (submitReviewBtn) {
                        submitReviewBtn.addEventListener('click', async () => {
                            if (!currentUser) {
                                alert('You must be logged in to leave a review.');
                                return;
                            }
                            const reviewText = document.getElementById('review-text').value;
                            if (reviewText.trim() === '' || currentRating === 0) {
                                alert('Please provide a rating and a comment.');
                                return;
                            }
                            
                            try {
                                const reviewResponse = await fetch(`${API_BASE_URL}/reviews/submit`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                                    },
                                    body: JSON.stringify({
                                        userId: currentUser.id,
                                        vendorProfileId: vendorId,
                                        rating: currentRating,
                                        comment: reviewText
                                    })
                                });
                                
                                if (!reviewResponse.ok) {
                                    const errorData = await reviewResponse.json();
                                    throw new Error(errorData.message || 'Failed to submit review');
                                }
                                
                                alert('Review submitted successfully!');
                                // Simulate adding the new review to the list
                                const newReview = {
                                    ReviewerName: currentUser.name,
                                    Rating: currentRating,
                                    Comment: reviewText,
                                    CreatedAt: new Date().toISOString()
                                };
                                const reviewsList = document.getElementById('vendor-profile-reviews-list');
                                const existingReviews = reviewsList.innerHTML;
                                reviewsList.innerHTML = renderReviews([newReview]) + existingReviews;
                                
                                // Reset the form
                                reviewForm.style.display = 'none';
                                showReviewFormBtn.style.display = 'block';
                                document.getElementById('review-text').value = '';
                                ratingStars.forEach(s => s.classList.remove('selected'));
                                currentRating = 0;
                                
                            } catch (error) {
                                console.error('Review submission failed:', error);
                                alert('Failed to submit review: ' + error.message);
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('Error fetching vendor profile:', error);
                    vendorProfilePage.innerHTML = `
                        <div style="text-align: center; margin-top: 5rem;">
                            <p style="color: var(--accent); margin-bottom: 1rem;">Error loading profile: ${error.message}</p>
                            <button onclick="window.location.hash = ''" class="btn btn-outline">← Back to search results</button>
                        </div>
                    `;
                    // Don't redirect to main page on error - stay on vendor profile page
                }
            }

            // Helper function to render services with booking functionality
            function renderServices(services) {
                console.log('🔍 renderServices called with:', services);
                console.log('🔍 Services type:', typeof services);
                console.log('🔍 Services is array:', Array.isArray(services));
                
                if (!services || services.length === 0) {
                    console.log('🔍 No services found or empty array');
                    return '';
                }
                
                console.log('🔍 Rendering', services.length, 'services');
                let servicesHtml = '';
                services.forEach((service, index) => {
                    console.log(`🔍 Service ${index}:`, service);
                    console.log(`🔍 Service properties:`, Object.keys(service));
                    
                    // Try different possible property names from database
                    const serviceName = service.ServiceName || service.Name || service.service_name || service.name || 'Unnamed Service';
                    const servicePrice = service.Price || service.price || service.BasePrice || service.base_price || 0;
                    const serviceDescription = service.Description || service.description || service.ServiceDescription || service.service_description || '';
                    const serviceDuration = service.Duration || service.duration || service.EstimatedDuration || service.estimated_duration || '';
                    const serviceCapacity = service.Capacity || service.capacity || service.MaxCapacity || service.max_capacity || '';
                    const serviceId = service.ServiceID || service.ID || service.id || service.service_id || index;
                    
                    console.log(`🔍 Mapped values - Name: ${serviceName}, Price: ${servicePrice}, Description: ${serviceDescription}`);
                    
                    const price = servicePrice ? `$${parseFloat(servicePrice).toFixed(2)}` : 'Contact for pricing';
                    const duration = serviceDuration ? ` • ${serviceDuration}` : '';
                    const capacity = serviceCapacity ? ` • Up to ${serviceCapacity} people` : '';
                    
                    servicesHtml += `
                        <div class="service-card" style="background-color: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); transition: all 0.2s; cursor: pointer;" 
                             onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='var(--shadow)'" 
                             onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <h3 class="service-name" style="font-weight: 600; margin: 0; color: var(--text);">${serviceName}</h3>
                                <div class="service-price" style="font-weight: 600; color: var(--primary); white-space: nowrap;">${price}</div>
                            </div>
                            
                            ${serviceDescription ? `
                            <p class="service-description" style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem; line-height: 1.5;">
                                ${serviceDescription}
                            </p>
                            ` : ''}
                            
                            ${(duration || capacity) ? `
                            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">
                                ${duration}${capacity}
                            </div>
                            ` : ''}
                            
                            <div class="service-actions" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                <button class="btn btn-outline btn-sm add-to-booking-btn" 
                                        data-service-id="${serviceId}" 
                                        data-service-name="${serviceName}" 
                                        data-service-price="${servicePrice || 0}"
                                        style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    Add to Booking
                                </button>
                            </div>
                        </div>
                    `;
                });
                return servicesHtml;
            }

            function renderVendorProfile(details) {
                const profile = details.profile;
                const isFavorite = details.isFavorite;
                const socialMedia = details.socialMedia || [];
                const businessHours = details.businessHours || [];
                const categoryAnswers = details.categoryAnswers || [];
                const faqs = details.faqs || [];
                const team = details.team || [];

                // Helper function to format business hours
                function formatBusinessHours(hours) {
                    if (!hours || hours.length === 0) return '';
                    
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    let hoursHtml = '';
                    
                    hours.forEach(hour => {
                        if (hour.IsAvailable) {
                            const openTime = new Date(hour.OpenTime).toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true 
                            });
                            const closeTime = new Date(hour.CloseTime).toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true 
                            });
                            hoursHtml += `
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="font-weight: 500;">${dayNames[hour.DayOfWeek]}</span>
                                    <span>${openTime} - ${closeTime}</span>
                                </div>
                            `;
                        } else {
                            hoursHtml += `
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; opacity: 0.6;">
                                    <span style="font-weight: 500;">${dayNames[hour.DayOfWeek]}</span>
                                    <span>Closed</span>
                                </div>
                            `;
                        }
                    });
                    return hoursHtml;
                }

                // Helper function to render social media links (compact version for header)
                function renderSocialMediaIcons(socialMedia) {
                    if (!socialMedia || socialMedia.length === 0) return '';
                    
                    let socialHtml = '';
                    socialMedia.forEach(social => {
                        const platformIcons = {
                            'facebook': 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg',
                            'instagram': 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png',
                            'twitter': 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Logo_of_Twitter.svg',
                            'linkedin': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png',
                            'youtube': 'https://upload.wikimedia.org/wikipedia/commons/4/42/YouTube_icon_%282013-2017%29.png'
                        };
                        
                        const iconUrl = platformIcons[social.Platform.toLowerCase()] || 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
                        socialHtml += `
                            <a href="${social.URL.startsWith('http') ? social.URL : 'https://' + social.URL}" target="_blank" 
                               style="text-decoration: none; opacity: 0.8; transition: opacity 0.2s;" 
                               onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                                <img src="${iconUrl}" width="28" height="28" alt="${social.Platform}" style="border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </a>
                        `;
                    });
                    
                    // Add website if available
                    if (profile.Website) {
                        socialHtml += `
                            <a href="${profile.Website.startsWith('http') ? profile.Website : 'https://' + profile.Website}" target="_blank" 
                               style="text-decoration: none; opacity: 0.8; transition: opacity 0.2s;" 
                               onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg" width="28" height="28" alt="Website" style="border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </a>
                        `;
                    }
                    
                    return socialHtml;
                }

                // Helper function to render social media links (detailed version for content section)
                function renderSocialMedia(socialMedia) {
                    if (!socialMedia || socialMedia.length === 0) return '<p style="color: var(--text-light); font-style: italic;">No social media links available.</p>';
                    
                    let socialHtml = '';
                    socialMedia.forEach(social => {
                        const platformIcons = {
                            'facebook': 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg',
                            'instagram': 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png',
                            'twitter': 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Logo_of_Twitter.svg',
                            'linkedin': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png',
                            'youtube': 'https://upload.wikimedia.org/wikipedia/commons/4/42/YouTube_icon_%282013-2017%29.png'
                        };
                        
                        const iconUrl = platformIcons[social.Platform.toLowerCase()] || 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
                        socialHtml += `
                            <a href="${social.URL.startsWith('http') ? social.URL : 'https://' + social.URL}" target="_blank" 
                               style="text-decoration: none; color: var(--text); display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s;" 
                               onmouseover="this.style.backgroundColor='var(--secondary)'" onmouseout="this.style.backgroundColor='transparent'">
                                <img src="${iconUrl}" width="32" height="32" alt="${social.Platform}" style="border-radius: 6px;">
                                <span style="text-transform: capitalize; font-weight: 500;">${social.Platform}</span>
                            </a>
                        `;
                    });
                    
                    // Add website if available
                    if (profile.Website) {
                        socialHtml += `
                            <a href="${profile.Website.startsWith('http') ? profile.Website : 'https://' + profile.Website}" target="_blank" 
                               style="text-decoration: none; color: var(--text); display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s;" 
                               onmouseover="this.style.backgroundColor='var(--secondary)'" onmouseout="this.style.backgroundColor='transparent'">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg" width="32" height="32" alt="Website" style="border-radius: 6px;">
                                <span style="font-weight: 500;">Website</span>
                            </a>
                        `;
                    }
                    
                    return socialHtml;
                }

                // Helper function to render category answers
                function renderCategoryAnswers(answers) {
                    if (!answers || answers.length === 0) return '';
                    
                    let answersHtml = '';
                    answers.forEach(answer => {
                        const isYes = answer.Answer.toLowerCase() === 'yes';
                        answersHtml += `
                            <div style="background-color: white; padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="color: ${isYes ? '#38a169' : '#e53e3e'}; font-size: 1.2rem;">
                                        ${isYes ? '✓' : '✗'}
                                    </span>
                                    <span style="font-weight: 500;">${answer.QuestionText}</span>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">
                                    ${answer.Answer}
                                </div>
                            </div>
                        `;
                    });
                    return answersHtml;
                }

                // Helper function to render FAQs
                function renderFAQs(faqs) {
                    if (!faqs || faqs.length === 0) return '';
                    
                    let faqHtml = '';
                    faqs.forEach((faq, index) => {
                        faqHtml += `
                            <div style="background-color: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 1rem;">
                                <h4 style="margin-bottom: 0.75rem; color: var(--primary); font-weight: 600;">
                                    ${faq.Question}
                                </h4>
                                <p style="line-height: 1.6; color: var(--text);">
                                    ${faq.Answer}
                                </p>
                            </div>
                        `;
                    });
                    return faqHtml;
                }

                // Helper function to render team members
                function renderTeam(team) {
                    if (!team || team.length === 0) return '';
                    
                    let teamHtml = '';
                    team.forEach(member => {
                        teamHtml += `
                            <div style="background-color: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); text-align: center;">
                                ${member.PhotoURL ? `<img src="${member.PhotoURL}" alt="${member.Name}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem;">` : ''}
                                <h4 style="margin-bottom: 0.5rem; font-weight: 600;">${member.Name}</h4>
                                <p style="color: var(--primary); font-size: 0.9rem; margin-bottom: 0.75rem;">${member.Role}</p>
                                ${member.Bio ? `<p style="color: var(--text-light); font-size: 0.85rem; line-height: 1.4;">${member.Bio}</p>` : ''}
                            </div>
                        `;
                    });
                    return teamHtml;
                }

                // Build HTML for the entire page
                let html = `
                    <!-- Back Button -->
                    <div style="margin-bottom: 2rem;">
                        <button onclick="window.location.hash = ''" class="btn btn-outline" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>← Back to search results</span>
                        </button>
                    </div>
                    
                    <!-- Image Gallery -->
                    <div id="modal-image-gallery" class="image-gallery">
                        <!-- Images will be loaded dynamically here -->
                    </div>

                    <!-- Vendor Header -->
                    <div class="vendor-profile-header" style="padding: 1.5rem 0; margin-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem;">
                            <div class="vendor-profile-info" style="flex: 1;">
                                <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text);">${profile.BusinessName || profile.DisplayName}</h1>
                                <p style="font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem;">${profile.Tagline || 'Professional Event Services'}</p>
                                
                                <!-- Main Info Row -->
                                <div style="display: flex; align-items: center; gap: 1.25rem; color: var(--text-light); margin-bottom: 0.75rem; flex-wrap: wrap; font-size: 0.9rem;">
                                    <span><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location</span>
                                    ${profile.YearsInBusiness ? `<span><i class="fas fa-trophy" style="color: #fbbf24; margin-right: 0.5rem;"></i>${profile.YearsInBusiness} years in business</span>` : ''}
                                    <span style="color: #fbbf24;">★★★★★ (5.0) • 1 Reviews</span>
                                </div>
                                
                                <!-- Social Media Icons Row -->
                                ${socialMedia.length > 0 || profile.Website ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                                    ${renderSocialMediaIcons(socialMedia)}
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Favorite Button -->
                            <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${profile.VendorProfileID}" style="flex-shrink: 0; font-size: 1.25rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"><i class="fas fa-heart"></i></div>
                        </div>
                    </div>

                    <!-- Vendor Content Sections -->
                    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 2rem; margin-top: 1rem;">
                        <!-- Main Content Area -->
                        <div>
                            <!-- About Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">About Us</h2>
                                <p style="line-height: 1.6; color: var(--text);">${profile.BusinessDescription || 'Welcome to our business! We provide exceptional event services tailored to your needs.'}</p>
                            </div>
                            
                            ${(() => {
                                console.log('🔍 Checking services condition:', details.services);
                                console.log('🔍 Services exists:', !!details.services);
                                console.log('🔍 Services length:', details.services ? details.services.length : 'N/A');
                                const hasServices = details.services && details.services.length > 0;
                                console.log('🔍 Will render services section:', hasServices);
                                return hasServices;
                            })() ? `
                            <!-- Services & Packages Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Services & Packages</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                    ${renderServices(details.services)}
                                </div>
                            </div>
                            ` : (() => {
                                console.log('🔍 Services section NOT rendered - no services found');
                                return '';
                            })()}
                            
                            ${categoryAnswers.length > 0 ? `
                            <!-- Category Services Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Our Specialties</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    ${renderCategoryAnswers(categoryAnswers)}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${faqs.length > 0 ? `
                            <!-- FAQ Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Frequently Asked Questions</h2>
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    ${renderFAQs(faqs)}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${team.length > 0 ? `
                            <!-- Team Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Our Team</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    ${renderTeam(team)}
                                </div>
                            </div>
                            ` : ''}
{{ ... }}

                            <!-- Reviews Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Reviews (1)</h2>
                                <div id="vendor-profile-reviews-list" style="margin-bottom: 1rem;">
                                    ${renderReviews(details.reviews || [])}
                                </div>
                                ${currentUser ? `
                                    <button class="btn btn-outline add-review-btn" id="show-review-form" style="margin-top: 1rem;">Add Review</button>
                                    <div class="review-form" id="review-form" style="display: none; margin-top: 1rem; padding: 1.25rem; background: var(--secondary); border-radius: 8px;">
                                        <div class="rating-input" style="margin-bottom: 1rem;">
                                            <span class="rating-star" data-rating="1" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="2" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="3" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="4" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="5" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                        </div>
                                        <textarea class="review-textarea" id="review-text" placeholder="Share your experience..." style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; resize: vertical; margin-bottom: 1rem;"></textarea>
                                        <button class="btn btn-primary" id="submit-review">Submit Review</button>
                                    </div>
                                ` : '<p style="padding: 0.75rem; background: var(--secondary); border-radius: 6px; margin-top: 1rem; text-align: center;"><a href="#" id="login-to-review" style="color: var(--primary); text-decoration: none;">Log in</a> to leave a review</p>'}
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div style="display: flex; flex-direction: column; gap: 1.5rem; position: sticky; top: 5.5rem; align-self: flex-start; height: fit-content; max-height: calc(100vh - 11rem); overflow-y: auto;">
                            <!-- Booking Summary -->
                            <div id="booking-summary" style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Your Booking</h3>
                                <div id="selected-services-list" style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.9rem; color: var(--text-light); text-align: center; font-style: italic;">Select services from the list to get started.</p>
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 1rem 0; padding-top: 1rem; display: flex; justify-content: space-between; font-weight: 600;">
                                    <span>Total</span>
                                    <span id="booking-total-price">$0.00</span>
                                </div>
                                <button class="btn btn-primary" id="proceed-to-book-btn" style="width: 100%;" disabled>Choose Services</button>
                            </div>

                            ${businessHours.length > 0 ? `
                            <!-- Business Hours -->
                            <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Business Hours</h3>
                                <div style="font-size: 0.9rem;">
                                    ${formatBusinessHours(businessHours)}
                                </div>
                            </div>
                            ` : ''}

                            <!-- Contact -->
                            <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Contact Vendor</h3>
                                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-light);">Have questions? Get in touch!</p>
                                <button class="btn btn-outline" id="open-chat-btn" style="width: 100%;">Message Vendor</button>
                            </div>
                        </div>
                    </div>
                `;

                vendorProfilePage.innerHTML = html;

                // Set current vendor object for gallery population
                window.currentVendor = {
                    ...profile,
                    images: details.images || [],
                    featuredImageURL: profile.FeaturedImageURL,
                    featuredImage: details.images && details.images.length > 0 ? details.images.find(img => img.IsPrimary) || details.images[0] : null
                };
                
                console.log('<i class="fas fa-check" style="color: #28a745;"></i> Set window.currentVendor with images:', window.currentVendor.images);

                // Add event listeners for the new elements on the profile page
                vendorProfilePage.querySelector('.vendor-favorite').addEventListener('click', () => {
                    toggleFavorite(profile.VendorProfileID);
                });
                
                // FIXED: Populate gallery immediately with images from API response
                console.log('🖼️ Populating gallery with images from API response:', details.images);
                populateVendorGallery(details.images || []);

                vendorProfilePage.querySelector('#open-chat-btn').addEventListener('click', () => {
                    // Simple chat functionality - you can replace this with your actual chat system
                    if (!currentUser) {
                        alert('Please log in to message this vendor.');
                        profileModal.style.display = 'flex';
                        showLoginView();
                        return;
                    }
                    
                    // For now, show a simple contact modal or redirect to contact form
                    const vendorName = profile.BusinessName || profile.DisplayName;
                    const confirmed = confirm(`Would you like to start a conversation with ${vendorName}? This will open a new chat window.`);
                    
                    if (confirmed) {
                        // You can replace this with your actual chat initialization
                        // For now, we'll show a placeholder message
                        alert(`Chat feature coming soon! For now, you can contact ${vendorName} through their website or social media links.`);
                        
                        // Optional: Scroll to social media section
                        const socialSection = document.querySelector('.services-section');
                        if (socialSection) {
                            socialSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                });
                
                 if(document.getElementById('login-to-review')) {
                    document.getElementById('login-to-review').addEventListener('click', (e) => {
                         e.preventDefault();
                         profileModal.style.display = 'flex';
                         showLoginView();
                    });
                }

                // Add event listeners for service booking buttons
                const addToBookingBtns = vendorProfilePage.querySelectorAll('.add-to-booking-btn');
                addToBookingBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const serviceId = btn.dataset.serviceId;
                        const serviceName = btn.dataset.serviceName;
                        const servicePrice = parseFloat(btn.dataset.servicePrice) || 0;
                        
                        addServiceToBooking({
                            id: serviceId,
                            name: serviceName,
                            price: servicePrice
                        });
                        
                        // Update button state
                        btn.textContent = 'Added ✓';
                        btn.style.backgroundColor = 'var(--primary)';
                        btn.style.color = 'white';
                        btn.disabled = true;
                    });
                });
            }

            // Booking management functionality
            let selectedServices = [];
            
            function addServiceToBooking(service) {
                // Check if service is already added
                const existingService = selectedServices.find(s => s.id === service.id);
                if (existingService) {
                    return; // Service already added
                }
                
                selectedServices.push(service);
                updateBookingSummary();
            }
            
            function removeServiceFromBooking(serviceId) {
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
                updateBookingSummary();
                
                // Reset the button state
                const btn = document.querySelector(`[data-service-id="${serviceId}"]`);
                if (btn) {
                    btn.textContent = 'Add to Booking';
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                    btn.disabled = false;
                }
            }
            
            function updateBookingSummary() {
                const selectedServicesList = document.getElementById('selected-services-list');
                const bookingTotalPrice = document.getElementById('booking-total-price');
                const proceedToBookBtn = document.getElementById('proceed-to-book-btn');
                
                if (!selectedServicesList || !bookingTotalPrice || !proceedToBookBtn) {
                    return; // Elements not found
                }
                
                if (selectedServices.length === 0) {
                    selectedServicesList.innerHTML = '<p style="font-size: 0.9rem; color: var(--text-light); text-align: center; font-style: italic;">Select services from the list to get started.</p>';
                    bookingTotalPrice.textContent = '$0.00';
                    proceedToBookBtn.textContent = 'Choose Services';
                    proceedToBookBtn.disabled = true;
                } else {
                    let servicesHtml = '';
                    let total = 0;
                    
                    selectedServices.forEach(service => {
                        const price = service.price || 0;
                        total += price;
                        
                        servicesHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; font-size: 0.9rem;">${service.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">$${price.toFixed(2)}</div>
                                </div>
                                <button onclick="removeServiceFromBooking('${service.id}')" 
                                        style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.25rem; font-size: 0.8rem;"
                                        title="Remove service">
                                    ✕
                                </button>
                            </div>
                        `;
                    });
                    
                    selectedServicesList.innerHTML = servicesHtml;
                    bookingTotalPrice.textContent = `$${total.toFixed(2)}`;
                    proceedToBookBtn.textContent = `Book ${selectedServices.length} Service${selectedServices.length > 1 ? 's' : ''}`;
                    proceedToBookBtn.disabled = false;
                    
                    // Add click handler for proceed to book button
                    proceedToBookBtn.onclick = () => {
                        if (!currentUser) {
                            alert('Please log in to book services.');
                            profileModal.style.display = 'flex';
                            showLoginView();
                            return;
                        }
                        
                        // For now, show a confirmation dialog
                        const serviceNames = selectedServices.map(s => s.name).join(', ');
                        const confirmed = confirm(`Ready to book these services?\n\n${serviceNames}\n\nTotal: $${total.toFixed(2)}\n\nThis will redirect you to the booking process.`);
                        
                        if (confirmed) {
                            alert('Booking feature coming soon! Your selected services have been saved.');
                            // Here you would typically redirect to a booking/checkout page
                            // or open a booking modal with calendar and payment options
                        }
                    };
                }
            }

            // Make removeServiceFromBooking available globally
            window.removeServiceFromBooking = removeServiceFromBooking;

            // Render reviews for a vendor
            function renderReviews(reviews) {
                if (!reviews || reviews.length === 0) {
                    return '<p>No reviews yet.</p>';
                }
                return reviews.map(review => `
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer">${review.ReviewerName || review.UserName || 'Anonymous'}</div>
                            <div class="review-date">${new Date(review.CreatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <div class="review-rating">${'★'.repeat(review.Rating)}${'☆'.repeat(5 - review.Rating)}</div>
                        ${review.Title ? `<div class="review-title">${review.Title}</div>` : ''}
                        <div class="review-text">${review.Comment}</div>
                    </div>
                `).join('');
            }

            // Close modal (specifically for vendor-modal and its state)
            function closeBookingModal() {
                document.getElementById('vendor-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
                resetBookingModalState();
            }

            // New function to reset the state related to the booking modal
            function resetBookingModalState() {
                state.currentVendor = null;
                state.selectedServices = [];
                state.selectedDate = null;
                state.selectedTime = null;
                // Potentially clear calendar selection or time slots if FullCalendar allows
                const calendarEl = document.getElementById('booking-calendar');
                if (calendarEl && calendarEl._fullCalendar) {
                    calendarEl._fullCalendar.unselect();
                    document.getElementById('time-slots').innerHTML = '';
                }
                document.getElementById('payment-section').style.display = 'none';
                document.getElementById('book-now-btn').style.display = 'block';
            }

            // Show login view in profile modal
            function showLoginView() {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                loggedInView.style.display = 'none';
                document.getElementById('profile-modal-title').textContent = 'Welcome to VenueVue';
                // Clear form fields
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            }

            // Show signup view in profile modal
            function showSignupView() {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                loggedInView.style.display = 'none';
                document.getElementById('profile-modal-title').textContent = 'Create an Account';
                // Clear form fields
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
            }

            // Show logged in view in profile modal
            function showLoggedInView() {
                const loginFormEl = document.getElementById('login-form');
                const signupFormEl = document.getElementById('signup-form');
                const loggedInViewEl = document.getElementById('logged-in-view');
                
                if (loginFormEl) loginFormEl.style.display = 'none';
                if (signupFormEl) signupFormEl.style.display = 'none';
                if (loggedInViewEl) loggedInViewEl.style.display = 'block';
                
                const titleEl = document.getElementById('profile-modal-title');
                if (titleEl) titleEl.textContent = 'My Account';

                // Update user info
                const nameEl = document.getElementById('profile-name');
                const emailEl = document.getElementById('profile-email');
                const avatarEl = document.getElementById('profile-avatar');
                
                if (nameEl && currentUser) nameEl.textContent = currentUser.name;
                if (emailEl && currentUser) emailEl.textContent = currentUser.email;
                if (avatarEl && currentUser) avatarEl.textContent = currentUser.avatar;
            }

            // Request management functions
            async function loadUserRequests(filter = 'all') {
                const container = document.getElementById('user-requests');
                container.innerHTML = '<p>Loading your requests...</p>';
                
                try {
                    if (!currentUser || !currentUser.id) {
                        throw new Error('User not logged in');
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/bookings/requests/${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch requests');
                    const data = await response.json();
                    const requests = data.requests || [];
                    
                    renderUserRequests(requests, filter);
                } catch (error) {
                    console.error('Error loading user requests:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load requests: ${error.message}</p>`;
                }
            }
            
            function renderUserRequests(requests, filter) {
                const container = document.getElementById('user-requests');
                
                let filteredRequests = requests;
                if (filter !== 'all') {
                    filteredRequests = requests.filter(req => req.CurrentStatus === filter);
                }
                
                if (filteredRequests.length === 0) {
                    container.innerHTML = `<p>No ${filter === 'all' ? '' : filter} requests found.</p>`;
                    return;
                }
                
                container.innerHTML = filteredRequests.map(request => `
                    <div class="request-card ${request.CurrentStatus}">
                        <div class="request-header">
                            <div>
                                <h4>${request.VendorName}</h4>
                                <div class="request-timer ${request.HoursRemaining && request.HoursRemaining < 6 ? 'urgent' : ''}">
                                    ${request.HoursRemaining ? `${request.HoursRemaining} hours remaining` : 'Timer expired'}
                                </div>
                            </div>
                            <span class="request-status ${request.CurrentStatus}">${request.CurrentStatus}</span>
                        </div>
                        <div class="request-details">
                            <div class="request-detail-row">
                                <span class="request-detail-label">Event Date:</span>
                                <span class="request-detail-value">${new Date(request.EventDate).toLocaleDateString()}</span>
                            </div>
                            <div class="request-detail-row">
                                <span class="request-detail-label">Location:</span>
                                <span class="request-detail-value">${request.EventLocation}</span>
                            </div>
                            <div class="request-detail-row">
                                <span class="request-detail-label">Budget:</span>
                                <span class="request-detail-value">$${request.Budget?.toLocaleString()}</span>
                            </div>
                            ${request.SpecialRequests ? `
                                <div class="request-detail-row">
                                    <span class="request-detail-label">Special Requests:</span>
                                    <span class="request-detail-value">${request.SpecialRequests}</span>
                                </div>
                            ` : ''}
                            ${request.ResponseMessage ? `
                                <div class="request-detail-row">
                                    <span class="request-detail-label">Vendor Response:</span>
                                    <span class="request-detail-value">${request.ResponseMessage}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="request-actions">
                            ${request.ConversationID ? `
                                <button class="btn btn-primary" onclick="openChatForRequest(${request.ConversationID})">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                            ` : ''}
                            ${request.CurrentStatus === 'pending' ? `
                                <button class="btn btn-danger" onclick="cancelRequest(${request.RequestID})">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            async function loadVendorRequests() {
                const container = document.getElementById('vendor-pending-requests');
                const pendingCountEl = document.getElementById('pending-requests-count');
                const expiringSoonCountEl = document.getElementById('expiring-soon-count');
                
                container.innerHTML = '<p>Loading pending requests...</p>';
                
                try {
                    // Get vendor profile ID using current user's ID
                    if (!currentUser || !currentUser.id) {
                        throw new Error('User not logged in');
                    }
                    
                    console.log('🔍 Debug - Loading vendor requests for user:', currentUser);
                    
                    const vendorProfileResponse = await fetch(`${API_BASE_URL}/vendors/profile?userId=${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    
                    console.log('🔍 Debug - Vendor profile response status:', vendorProfileResponse.status);
                    
                    if (!vendorProfileResponse.ok) {
                        throw new Error('Failed to fetch vendor profile');
                    }
                    
                    const vendorProfileData = await vendorProfileResponse.json();
                    console.log('🔍 Debug - Vendor profile data:', vendorProfileData);
                    
                    const vendorProfileId = vendorProfileData.vendorProfileId;
                    console.log('🔍 Debug - Extracted vendor profile ID:', vendorProfileId);
                    
                    if (!vendorProfileId) {
                        throw new Error('Vendor profile not found');
                    }
                    
                    console.log('🔍 Debug - Fetching requests for vendor ID:', vendorProfileId);
                    const response = await fetch(`${API_BASE_URL}/bookings/vendor/${vendorProfileId}/requests`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    
                    console.log('🔍 Debug - Vendor requests response status:', response.status);
                    
                    if (!response.ok) throw new Error('Failed to fetch vendor requests');
                    const data = await response.json();
                    console.log('🔍 Debug - Vendor requests data:', data);
                    
                    const requests = data.requests || [];
                    console.log('🔍 Debug - Parsed requests:', requests);
                    console.log('🔍 Debug - Number of requests found:', requests.length);
                    
                    if (requests.length === 0) {
                        console.log('🔍 Debug - No requests found. Checking if booking requests exist in database for vendor ID:', vendorProfileId);
                        console.log('🔍 Debug - API URL called:', `${API_BASE_URL}/bookings/vendor/${vendorProfileId}/requests`);
                    }
                    
                    // Update stats
                    const expiringSoon = requests.filter(req => req.HoursRemaining <= 6).length;
                    pendingCountEl.textContent = requests.length;
                    expiringSoonCountEl.textContent = expiringSoon;
                    
                    renderVendorRequests(requests);
                } catch (error) {
                    console.error('Error loading vendor requests:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load requests: ${error.message}</p>`;
                }
            }
            
            function renderVendorRequests(requests) {
                const container = document.getElementById('vendor-pending-requests');
                
                if (requests.length === 0) {
                    container.innerHTML = '<p>No pending requests at this time.</p>';
                    return;
                }
                
                container.innerHTML = requests.map(request => `
                    <div class="request-card pending">
                        <div class="request-header">
                            <div>
                                <h4>${request.ClientName}</h4>
                                <div class="request-timer ${request.HoursRemaining < 6 ? 'urgent' : ''}">
                                    ${request.HoursRemaining} hours remaining
                                </div>
                            </div>
                            <span class="request-status pending">pending</span>
                        </div>
                        <div class="request-details">
                            <div class="request-detail-row">
                                <span class="request-detail-label">Event Date:</span>
                                <span class="request-detail-value">${new Date(request.EventDate).toLocaleDateString()}</span>
                            </div>
                            <div class="request-detail-row">
                                <span class="request-detail-label">Location:</span>
                                <span class="request-detail-value">${request.EventLocation}</span>
                            </div>
                            <div class="request-detail-row">
                                <span class="request-detail-label">Attendees:</span>
                                <span class="request-detail-value">${request.AttendeeCount}</span>
                            </div>
                            <div class="request-detail-row">
                                <span class="request-detail-label">Budget:</span>
                                <span class="request-detail-value">$${request.Budget?.toLocaleString()}</span>
                            </div>
                            ${request.SpecialRequests ? `
                                <div class="request-detail-row">
                                    <span class="request-detail-label">Special Requests:</span>
                                    <span class="request-detail-value">${request.SpecialRequests}</span>
                                </div>
                            ` : ''}
                            <div class="request-detail-row">
                                <span class="request-detail-label">Contact:</span>
                                <span class="request-detail-value">${request.ClientEmail} | ${request.ClientPhone || 'No phone'}</span>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn btn-success" onclick="approveRequest(${request.RequestID})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger" onclick="declineRequest(${request.RequestID})">
                                <i class="fas fa-times"></i> Decline
                            </button>
                            ${request.ConversationID ? `
                                <button class="btn btn-primary" onclick="openChatForRequest(${request.ConversationID})">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            async function cancelRequest(requestId) {
                if (!confirm('Are you sure you want to cancel this request?')) return;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/bookings/requests/${requestId}/cancel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to cancel request');
                    
                    showSuccess('Request cancelled successfully.');
                    loadUserRequests(); // Refresh the list
                } catch (error) {
                    console.error('Error cancelling request:', error);
                    showError(`Failed to cancel request: ${error.message}`);
                }
            }
            
            function openChatForRequest(conversationId) {
                // Switch to messages section and load the specific conversation
                document.querySelector('[data-section="messages"]').click();
                // TODO: Load specific conversation
            }
            
            function setupRequestFilterTabs() {
                const tabButtons = document.querySelectorAll('.requests-filter-tabs .tab-btn');
                
                tabButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Remove active class from all tabs
                        tabButtons.forEach(tab => tab.classList.remove('active'));
                        // Add active class to clicked tab
                        e.target.classList.add('active');
                        
                        // Load requests with the selected filter
                        const filter = e.target.dataset.filter;
                        loadUserRequests(filter);
                    });
                });
            }

            // Unified function to display either client or vendor dashboard
            async function displayUserDashboard(mode, section) {
                // Update global state and localStorage
                isVendorMode = (mode === 'vendor');
                activeDashboardSection = section;
                localStorage.setItem('isVendorMode', isVendorMode);
                localStorage.setItem('activeDashboardSection', activeDashboardSection);

                // Show the dashboard modal
                const dashboardModal = document.getElementById('dashboard-modal');
                dashboardModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Determine which dashboard to show
                if (isVendorMode) {
                    clientDashboardContainer.style.display = 'none';
                    vendorDashboardContainer.style.display = 'grid';
                } else {
                    clientDashboardContainer.style.display = 'grid';
                    vendorDashboardContainer.style.display = 'none';
                }

                // Get the correct menu and content sections based on the mode
                const currentDashboardMenu = isVendorMode ? vendorDashboardContainer.querySelector('.dashboard-menu') : clientDashboardContainer.querySelector('.dashboard-menu');
                const currentDashboardContentSections = document.querySelectorAll(
                    isVendorMode ? '#vendor-dashboard-container main > div[id]' : '#dashboard-container main > div[id]'
                );

                // Hide all sections in the active dashboard first
                currentDashboardContentSections.forEach(sec => {
                    sec.style.display = 'none';
                });

                // Show the selected section
                const targetSectionElement = document.getElementById(section + '-section');
                if (targetSectionElement) {
                    targetSectionElement.style.display = 'block';
                    // Update dashboard title
                    const dashboardTitleElement = document.getElementById('dashboard-modal-title');
                    if (dashboardTitleElement) {
                        const titleText = section.charAt(0).toUpperCase() + section.slice(1).replace('vendor-', '').replace('-', ' ');
                        dashboardTitleElement.textContent = isVendorMode ? `Vendor Dashboard - ${titleText}` : `Dashboard - ${titleText}`;
                    }
                } else {
                    // Fallback for the main dashboard view
                    const mainDashboardSection = document.getElementById(isVendorMode ? 'vendor-dashboard-section' : 'dashboard-section');
                    if(mainDashboardSection) mainDashboardSection.style.display = 'block';
                    document.getElementById('dashboard-modal-title').textContent = isVendorMode ? 'Vendor Dashboard' : 'Dashboard';
                }

                // Update active class on menu items
                currentDashboardMenu.querySelectorAll('a').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.section === section) {
                        link.classList.add('active');
                    }
                });

                // Load specific data for sections
                if (currentUser) {
                    if (mode === 'client') {
                        await loadClientDashboardData(section);
                    } else {
                        await loadVendorDashboardData(section);
                    }
                } else {
                    // Handle not logged in scenario for dashboard views
                    alert('Please log in to view the dashboard.');
                    dashboardModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    showLoginView();
                    profileModal.style.display = 'flex';
                }
            }

            // Client Dashboard Data Loading
            async function loadClientDashboardData(section) {
                if (!currentUser || !currentUser.id) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/dashboard`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch client dashboard data');
                    const dashboardData = await response.json();

                    // Update notifications badge
                    document.getElementById('dashboard-notifications-badge').textContent = dashboardData.unreadNotifications || 0;

                    if (section === 'dashboard') {
                        renderUpcomingBookings(dashboardData.upcomingBookings);
                        renderRecentFavorites(dashboardData.recentFavorites);
                    } else if (section === 'bookings') {
                        await loadAllUserBookings();
                    } else if (section === 'requests') {
                        await loadUserRequests();
                        setupRequestFilterTabs();
                    } else if (section === 'favorites') {
                        await loadUserFavoritesDashboard();
                    } else if (section === 'messages') {
                        await loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                    } else if (section === 'reviews') {
                        await loadUserReviews();
                    } else if (section === 'settings') {
                        await loadUserProfileDetails();
                    }
                } catch (error) {
                    console.error('Error loading client dashboard:', error);
                    alert('Failed to load dashboard data: ' + error.message);
                }
            }

            function renderUpcomingBookings(bookings) {
                const container = document.getElementById('upcoming-bookings');
                container.innerHTML = '';
                if (bookings && bookings.length > 0) {
                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.className = 'booking-item';
                        
                        // Add payment button for confirmed bookings that haven't been paid
                        const paymentButton = (booking.Status === 'confirmed' && !booking.PaymentStatus) ? 
                            `<button class="btn btn-primary btn-sm" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount})" style="margin-left: 10px;">Pay Now</button>` : '';
                        
                        bookingItem.innerHTML = `
                            <div class="booking-info">
                                <div class="booking-vendor">${booking.VendorName}</div>
                                <div class="booking-date">${new Date(booking.EventDate).toLocaleDateString()} - ${booking.ServiceName}</div>
                                ${booking.PaymentStatus ? `<div class="payment-status">Payment: ${booking.PaymentStatus}</div>` : ''}
                            </div>
                            <div class="booking-actions">
                                <span class="booking-status status-${booking.Status}">${booking.Status}</span>
                                ${paymentButton}
                            </div>
                        `;
                        container.appendChild(bookingItem);
                    });
                } else {
                    container.innerHTML = '<p>No upcoming bookings.</p>';
                }
            }

            function renderRecentFavorites(favorites) {
                const container = document.getElementById('dashboard-favorites');
                container.innerHTML = '';
                if (favorites && favorites.length > 0) {
                    favorites.forEach(vendor => {
                        const vendorCard = document.createElement('div');
                        vendorCard.className = 'vendor-card';
                        vendorCard.innerHTML = `
                            <div class="vendor-image">
                                ${vendor.PortfolioImage ? `<img src="${vendor.PortfolioImage}" alt="${vendor.VendorName}" style="width:100%;height:100%;object-fit:cover;">` : getCategoryIcon(vendor.Categories?.split(',')[0] || 'all')}
                                <div class="vendor-favorite active" data-id="${vendor.VendorProfileID}"><i class="fas fa-heart"></i></div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name">${vendor.VendorName}</h3>
                                <div class="vendor-location">
                                    <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${vendor.City}, ${vendor.State}
                                </div>
                                <div class="vendor-features">
                                    <div class="feature">
                                        <span class="feature-icon">${getCategoryIcon(vendor.Categories?.split(',')[0] || 'all')}</span>
                                        <span>${vendor.Categories?.split(',')[0] || 'Service'}</span>
                                    </div>
                                </div>
                                <div class="vendor-footer" style="margin-top: 1rem;">
                                    <button class="btn btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 12px; font-weight: 600;" data-id="${vendor.VendorProfileID}">View Profile</button>
                                </div>
                            </div>
                        `;
                        container.appendChild(vendorCard);
                        vendorCard.querySelector('button').addEventListener('click', () => {
                            window.location.hash = `/listings/${vendor.VendorProfileID}`;
                        });
                        vendorCard.querySelector('.vendor-favorite').addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleFavorite(vendor.VendorProfileID);
                        });
                    });
                } else {
                    container.innerHTML = '<p>No recent favorites.</p>';
                }
            }

            async function loadAllUserBookings() {
                const container = document.getElementById('all-bookings');
                container.innerHTML = '<p>Loading all bookings...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch all bookings');
                    const bookings = await response.json();
                    renderBookingsList(bookings, container);
                } catch (error) {
                    console.error('Error loading all user bookings:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load all bookings: ${error.message}</p>`;
                }
            }

            async function loadUserFavoritesDashboard() {
                const container = document.getElementById('saved-favorites');
                container.innerHTML = '<p>Loading saved favorites...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user favorites');
                    const favorites = await response.json();
                    renderFavoritesList(favorites, container);
                } catch (error) {
                    console.error('Error loading user favorites:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load favorites: ${error.message}</p>`;
                }
            }

            function renderFavoritesList(favorites, container) {
                container.innerHTML = '';
                if (favorites && favorites.length > 0) {
                    favorites.forEach(vendor => {
                        const vendorCard = document.createElement('div');
                        vendorCard.className = 'vendor-card';
                        vendorCard.innerHTML = `
                            <div class="vendor-image">
                                ${vendor.PortfolioImage ? `<img src="${vendor.PortfolioImage}" alt="${vendor.VendorName}" style="width:100%;height:100%;object-fit:cover;">` : getCategoryIcon(vendor.Categories?.split(',')[0] || 'all')}
                                <div class="vendor-favorite active" data-id="${vendor.VendorProfileID}"><i class="fas fa-heart"></i></div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name">${vendor.VendorName}</h3>
                                <div class="vendor-location">
                                    <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${vendor.City}, ${vendor.State}
                                </div>
                                <div class="vendor-features">
                                    <div class="feature">
                                        <span class="feature-icon">${getCategoryIcon(vendor.Categories?.split(',')[0] || 'all')}</span>
                                        <span>${vendor.Categories?.split(',')[0] || 'Service'}</span>
                                    </div>
                                </div>
                                <div class="vendor-footer" style="margin-top: 1rem;">
                                    <button class="btn btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 12px; font-weight: 600;" data-id="${vendor.VendorProfileID}">View Profile</button>
                                </div>
                            </div>
                        `;
                        container.appendChild(vendorCard);
                        vendorCard.querySelector('button').addEventListener('click', () => {
                            window.location.hash = `/listings/${vendor.VendorProfileID}`;
                        });
                        vendorCard.querySelector('.vendor-favorite').addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleFavorite(vendor.VendorProfileID);
                        });
                    });
                } else {
                    container.innerHTML = '<p>No saved favorites.</p>';
                }
            }

            async function loadUserReviews() {
                const container = document.getElementById('user-reviews');
                container.innerHTML = '<p>Loading your reviews...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/reviews`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user reviews');
                    const reviews = await response.json();
                    renderReviewsList(reviews, container);
                } catch (error) {
                    console.error('Error loading user reviews:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load reviews: ${error.message}</p>`;
                }
            }

            function renderReviewsList(reviews, container) {
                container.innerHTML = '';
                if (reviews && reviews.length > 0) {
                    reviews.forEach(review => {
                        const reviewCard = document.createElement('div');
                        reviewCard.className = 'review-card';
                        reviewCard.innerHTML = `
                            <div class="review-header">
                                <div class="reviewer">${review.VendorName}</div>
                                <div class="review-date">${new Date(review.CreatedAt).toLocaleDateString()}</div>
                            </div>
                            <div class="review-rating">${'★'.repeat(review.Rating)}${'☆'.repeat(5 - review.Rating)}</div>
                            ${review.Title ? `<div class="review-title">${review.Title}</div>` : ''}
                            <div class="review-text">${review.Comment}</div>
                        `;
                        container.appendChild(reviewCard);
                    });
                } else {
                    container.innerHTML = '<p>No reviews submitted yet.</p>';
                }
            }

            async function loadUserProfileDetails() {
                const nameInput = document.getElementById('profile-name');
                const emailInput = document.getElementById('profile-email');
                const phoneInput = document.getElementById('profile-phone');
                const profileForm = document.getElementById('profile-form');
                const passwordForm = document.getElementById('password-form');

                nameInput.value = 'Loading...';
                emailInput.value = 'Loading...';
                phoneInput.value = 'Loading...';

                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/profile-details`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user profile details');
                    const profile = await response.json();

                    nameInput.value = profile.Name || '';
                    emailInput.value = profile.Email || '';
                    phoneInput.value = profile.Phone || '';
                } catch (error) {
                    console.error('Error loading user profile details:', error);
                    nameInput.value = 'Error';
                    emailInput.value = 'Error';
                    phoneInput.value = 'Error';
                    alert('Failed to load profile details: ' + error.message);
                }

                profileForm.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/profile-update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                name: nameInput.value,
                                phone: phoneInput.value,
                                bio: currentUser.bio,
                                avatar: currentUser.avatar
                            })
                        });
                        if (!response.ok) throw new Error('Failed to update profile');
                        alert('Profile updated successfully!');
                        await checkAuthStatus();
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        alert('Failed to update profile: ' + error.message);
                    }
                };

                passwordForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    if (newPassword !== confirmPassword) {
                        alert('New password and confirm password do not match.');
                        return;
                    }
                    if (newPassword.length < 8) {
                        alert('New password must be at least 8 characters long.');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/password-update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({ newPassword })
                        });
                        if (!response.ok) throw new Error('Failed to update password');
                        alert('Password updated successfully!');
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                    } catch (error) {
                        console.error('Error updating password:', error);
                        alert('Failed to update password: ' + error.message);
                    }
                };
            }

            // Vendor Dashboard Data Loading
            async function loadVendorDashboardData(section) {
                if (!currentUser || !currentUser.id) return;

                // First, get the VendorProfileID for the current user
                let vendorProfileId = null;
                try {
                    const statusResponse = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!statusResponse.ok) throw new Error('Failed to fetch vendor status');
                    const statusData = await statusResponse.json();
                    if (statusData.isVendor && statusData.vendorProfileId) {
                        vendorProfileId = statusData.vendorProfileId;
                    } else {
                        document.getElementById('vendor-dashboard-section').innerHTML = '<p>You are not registered as a vendor or your profile is incomplete. Please register or complete your profile to access the vendor dashboard.</p>';
                        return;
                    }
                } catch (error) {
                    console.error('Error getting vendor profile ID:', error);
                    document.getElementById('vendor-dashboard-section').innerHTML = `<p style="color:var(--accent);">Error: ${error.message}. Could not load vendor dashboard.</p>`;
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.id}/dashboard`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor dashboard data');
                    const dashboardData = await response.json();

                    // Update notifications badge
                    document.getElementById('vendor-notifications-badge').textContent = dashboardData.unreadNotifications || 0;

                    if (section === 'vendor-dashboard') {
                        renderVendorStats(dashboardData.stats);
                        renderVendorRecentBookings(dashboardData.recentBookings);
                        // Load recent messages for the vendor dashboard overview
                        loadConversations('vendor-dashboard-section', 'vendor-chat-input', 'vendor-send-btn');
                    } else if (section === 'vendor-bookings') {
                        await loadAllVendorBookings(vendorProfileId);
                    } else if (section === 'vendor-requests') {
                        await loadVendorRequests();
                    } else if (section === 'vendor-services') {
                        await loadVendorServices(vendorProfileId);
                    } else if (section === 'vendor-messages') {
                        await loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                    } else if (section === 'vendor-reviews') {
                        await loadAllVendorReviews(vendorProfileId);
                    } else if (section === 'vendor-analytics') {
                        await loadVendorAnalytics(vendorProfileId);
                    } else if (section === 'vendor-settings') {
                        await loadVendorProfileDetails(vendorProfileId);
                    }
                } catch (error) {
                    console.error('Error loading vendor dashboard:', error);
                    alert('Failed to load vendor dashboard data: ' + error.message);
                }
            }

            function renderVendorStats(stats) {
                const container = document.getElementById('vendor-stats');
                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.TotalBookings || 0}</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.TotalReviews || 0}</div>
                        <div class="stat-label">Total Reviews</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(stats.AvgRating || 0).toFixed(1)}</div>
                        <div class="stat-label">Average Rating</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.TotalFavorites || 0}</div>
                        <div class="stat-label">Total Favorites</div>
                    </div>
                `;
            }

            function renderVendorRecentBookings(bookings) {
                const container = document.getElementById('vendor-recent-bookings');
                container.innerHTML = '';
                if (bookings && bookings.length > 0) {
                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.className = 'booking-item';
                        bookingItem.innerHTML = `
                            <div class="booking-info">
                                <div class="booking-vendor">${booking.ClientName}</div>
                                <div class="booking-date">${new Date(booking.EventDate).toLocaleDateString()} - ${booking.ServiceName}</div>
                            </div>
                            <span class="booking-status status-${booking.Status}">${booking.Status}</span>
                        `;
                        container.appendChild(bookingItem);
                    });
                } else {
                    container.innerHTML = '<p>No recent bookings.</p>';
                }
            }

            function renderBookingsList(bookings, container) {
                container.innerHTML = '';
                if (bookings && bookings.length > 0) {
                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.className = 'booking-item';
                        const vendorOrClientName = isVendorMode ? booking.ClientName : booking.VendorName;
                        
                        // Add payment button for confirmed bookings that haven't been paid
                        const paymentButton = (booking.Status === 'confirmed' && !booking.PaymentStatus) ? 
                            `<button class="btn btn-primary" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount})" style="margin-left: 10px;">Pay Now</button>` : '';
                        
                        // Add chat button for confirmed/paid bookings
                        const chatButton = (booking.Status === 'confirmed' || booking.Status === 'paid') ? 
                            `<button class="btn btn-outline" onclick="openBookingChat('${booking.BookingID}')" style="margin-left: 10px;">Chat</button>` : '';
                        
                        bookingItem.innerHTML = `
                            <div class="booking-info">
                                <div class="booking-vendor">${vendorOrClientName}</div>
                                <div class="booking-date">${new Date(booking.EventDate).toLocaleDateString()} - ${booking.ServiceName}</div>
                                <div>Total: $${booking.TotalAmount ? booking.TotalAmount.toFixed(2) : '0.00'}</div>
                                ${booking.PaymentStatus ? `<div class="payment-status">Payment: ${booking.PaymentStatus}</div>` : ''}
                            </div>
                            <div class="booking-actions">
                                <span class="booking-status status-${booking.Status}">${booking.Status}</span>
                                ${paymentButton}
                                ${chatButton}
                            </div>
                        `;
                        container.appendChild(bookingItem);
                    });
                } else {
                    container.innerHTML = '<p>No bookings found.</p>';
                }
            }

            async function loadAllVendorBookings(vendorProfileId) {
                const container = document.getElementById('vendor-all-bookings');
                container.innerHTML = '<p>Loading all bookings...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch all vendor bookings');
                    const bookings = await response.json();
                    renderBookingsList(bookings, container);
                } catch (error) {
                    console.error('Error loading all vendor bookings:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load all bookings: ${error.message}</p>`;
                }
            }

            async function loadVendorServices(vendorProfileId) {
                const container = document.getElementById('vendor-services');
                container.innerHTML = '<p>Loading services...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/services`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor services');
                    const services = await response.json();
                    renderManageServices(services, container);
                } catch (error) {
                    console.error('Error loading vendor services:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load services: ${error.message}</p>`;
                }
            }

            function renderManageServices(services, container) {
                container.innerHTML = '';
                if (services && services.length > 0) {
                    // Group services by category for rendering
                    const servicesByCategory = services.reduce((acc, service) => {
                        const categoryName = service.CategoryName || 'Uncategorized';
                        if (!acc[categoryName]) {
                            acc[categoryName] = [];
                        }
                        acc[categoryName].push(service);
                        return acc;
                    }, {});

                    for (const categoryName in servicesByCategory) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'service-category';
                        categoryDiv.innerHTML = `
                            <h4 class="category-title">${categoryName}</h4>
                            <div class="service-grid">
                                ${(servicesByCategory[categoryName].map(service => `
                                    <div class="service-card">
                                        <div class="service-name">${service.ServiceName}</div>
                                        <div class="service-description">${service.ServiceDescription || 'No description.'}</div>
                                        <div class="service-price">$${service.Price.toFixed(2)}</div>
                                        <div class="service-actions">
                                            <button class="btn btn-outline btn-sm edit-service-btn" data-service-id="${service.ServiceID}">Edit</button>
                                            <button class="btn btn-primary btn-sm delete-service-btn" data-service-id="${service.ServiceID}">Delete</button>
                                        </div>
                                    </div>
                                `)).join('')}
                            </div>
                        `;
                        container.appendChild(categoryDiv);
                    }
                } else {
                    container.innerHTML = '<p>No services added yet. Add your first service!</p>';
                }
                // Add a button to add new services
                const addServiceBtn = document.createElement('button');
                addServiceBtn.className = 'btn btn-primary';
                addServiceBtn.textContent = 'Add New Service';
                addServiceBtn.addEventListener('click', () => {
                    // Implement logic to open a form for adding/editing a service
                    // For now, a simple alert
                    alert('Add New Service form would open here!');
                });
                container.appendChild(addServiceBtn);
            }

            async function loadAllVendorReviews(vendorProfileId) {
                const container = document.getElementById('vendor-reviews');
                container.innerHTML = '<p>Loading customer reviews...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/reviews/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch all vendor reviews');
                    const reviews = await response.json();
                    renderReviewsList(reviews, container);
                } catch (error) {
                    console.error('Error loading all vendor reviews:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load reviews: ${error.message}</p>`;
                }
            }

            // Chart instances to prevent re-initialization
            let bookingStatsChart = null;
            let revenueByServiceChart = null;
            let revenueByMonthChart = null;
            let reviewStatsChart = null;

            async function loadVendorAnalytics(vendorProfileId) {
                const container = document.getElementById('analytics-charts');
                container.innerHTML = '<p>Loading analytics data...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/analytics`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor analytics');
                    const analyticsData = await response.json();

                    container.innerHTML = '';

                    // Render Booking Stats Chart (Pie Chart)
                    const bookingStatsCanvas = document.createElement('canvas');
                    bookingStatsCanvas.id = 'bookingStatsChart';
                    const bookingStatsChartContainer = document.createElement('div');
                    bookingStatsChartContainer.className = 'chart-container';
                    bookingStatsChartContainer.innerHTML = '<h3>Booking Status Overview</h3>';
                    bookingStatsChartContainer.appendChild(bookingStatsCanvas);
                    container.appendChild(bookingStatsChartContainer);

                    if (bookingStatsChart) bookingStatsChart.destroy();
                    bookingStatsChart = new Chart(bookingStatsCanvas, {
                        type: 'pie',
                        data: {
                            labels: ['Completed', 'Confirmed', 'Pending', 'Cancelled'],
                            datasets: [{
                                data: [
                                    analyticsData.bookingStats.CompletedBookings,
                                    analyticsData.bookingStats.ConfirmedBookings,
                                    analyticsData.bookingStats.PendingBookings,
                                    analyticsData.bookingStats.CancelledBookings
                                ],
                                backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F4436']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Booking Status Distribution'
                                }
                            }
                        }
                    });

                    // Render Revenue by Service Chart (Bar Chart)
                    const revenueByServiceCanvas = document.createElement('canvas');
                    revenueByServiceCanvas.id = 'revenueByServiceChart';
                    const revenueByServiceChartContainer = document.createElement('div');
                    revenueByServiceChartContainer.className = 'chart-container';
                    revenueByServiceChartContainer.innerHTML = '<h3>Revenue by Service</h3>';
                    revenueByServiceChartContainer.appendChild(revenueByServiceCanvas);
                    container.appendChild(revenueByServiceChartContainer);

                    if (revenueByServiceChart) revenueByServiceChart.destroy();
                    revenueByServiceChart = new Chart(revenueByServiceCanvas, {
                        type: 'bar',
                        data: {
                            labels: analyticsData.revenueByService.map(s => s.ServiceName),
                            datasets: [{
                                label: 'Total Revenue ($)',
                                data: analyticsData.revenueByService.map(s => s.TotalRevenue),
                                backgroundColor: 'rgba(94, 114, 228, 0.6)'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Revenue Generated by Each Service'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Render Revenue by Month Chart (Line Chart)
                    const revenueByMonthCanvas = document.createElement('canvas');
                    revenueByMonthCanvas.id = 'revenueByMonthChart';
                    const revenueByMonthChartContainer = document.createElement('div');
                    revenueByMonthChartContainer.className = 'chart-container';
                    revenueByMonthChartContainer.innerHTML = '<h3>Monthly Revenue Trends</h3>';
                    revenueByMonthChartContainer.appendChild(revenueByMonthCanvas);
                    container.appendChild(revenueByMonthChartContainer);

                    const monthlyLabels = analyticsData.revenueByMonth.map(m => `${m.Year}-${String(m.Month).padStart(2, '0')}`);
                    const monthlyRevenue = analyticsData.revenueByMonth.map(m => m.TotalRevenue);

                    if (revenueByMonthChart) revenueByMonthChart.destroy();
                    revenueByMonthChart = new Chart(revenueByMonthCanvas, {
                        type: 'line',
                        data: {
                            labels: monthlyLabels,
                            datasets: [{
                                label: 'Total Revenue ($)',
                                data: monthlyRevenue,
                                borderColor: 'var(--primary)',
                                tension: 0.1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Revenue Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Render Review Stats Chart (Doughnut Chart)
                    const reviewStatsCanvas = document.createElement('canvas');
                    reviewStatsCanvas.id = 'reviewStatsChart';
                    const reviewStatsChartContainer = document.createElement('div');
                    reviewStatsChartContainer.className = 'chart-container';
                    reviewStatsChartContainer.innerHTML = '<h3>Review Rating Distribution</h3>';
                    reviewStatsChartContainer.appendChild(reviewStatsCanvas);
                    container.appendChild(reviewStatsChartContainer);

                    if (reviewStatsChart) reviewStatsChart.destroy();
                    reviewStatsChart = new Chart(reviewStatsCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                            datasets: [{
                                data: [
                                    analyticsData.reviewStats.FiveStarReviews,
                                    analyticsData.reviewStats.FourStarReviews,
                                    analyticsData.reviewStats.ThreeStarReviews,
                                    analyticsData.reviewStats.TwoStarReviews,
                                    analyticsData.reviewStats.OneStarReviews
                                ],
                                backgroundColor: ['#4CAF50', '#8BC34A', '#FFEB3B', '#FF9800', '#F4436']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Customer Review Ratings'
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error('Error loading vendor analytics:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load analytics: ${error.message}</p>`;
                }
            }

            async function loadVendorProfileDetails(vendorProfileId) {
                const form = document.getElementById('vendor-profile-form');
                const inputs = {
                    businessName: document.getElementById('vendor-name'),
                    category: document.getElementById('vendor-category'),
                    description: document.getElementById('vendor-description'),
                    address: document.getElementById('vendor-address'),
                    city: document.getElementById('vendor-city'),
                    state: document.getElementById('vendor-state'),
                    country: document.getElementById('vendor-country'),
                    postalCode: document.getElementById('vendor-postalCode'),
                    phone: document.getElementById('vendor-phone'),
                    email: document.getElementById('vendor-email'),
                    website: document.getElementById('vendor-website'),
                    yearsInBusiness: document.getElementById('vendor-years-in-business'),
                    isPremium: document.getElementById('vendor-is-premium'),
                    isEcoFriendly: document.getElementById('vendor-is-eco-friendly'),
                    isAwardWinning: document.getElementById('vendor-is-award-winning')
                };

                // Populate category dropdown
                inputs.category.innerHTML = '<option value="">Select category</option>' +
                    state.categories.filter(c => c.id !== 'all').map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                for (const key in inputs) {
                    if (inputs[key] instanceof HTMLInputElement || inputs[key] instanceof HTMLTextAreaElement || inputs[key] instanceof HTMLSelectElement) {
                        inputs[key].value = 'Loading...';
                        if (inputs[key].type === 'checkbox') inputs[key].checked = false;
                    }
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/profile-details`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor profile details');
                    const profile = await response.json();

                    inputs.businessName.value = profile.BusinessName || '';
                    inputs.description.value = profile.BusinessDescription || '';
                    inputs.address.value = profile.Address || '';
                    inputs.city.value = profile.City || '';
                    inputs.state.value = profile.State || '';
                    inputs.country.value = profile.Country || '';
                    inputs.postalCode.value = profile.PostalCode || '';
                    inputs.phone.value = profile.BusinessPhone || '';
                    inputs.email.value = profile.BusinessEmail || '';
                    inputs.website.value = profile.Website || '';
                    inputs.yearsInBusiness.value = profile.YearsInBusiness || 0;
                    inputs.isPremium.checked = profile.IsPremium;
                    inputs.isEcoFriendly.checked = profile.IsEcoFriendly;
                    inputs.isAwardWinning.checked = profile.IsAwardWinning;

                    // Set selected category
                    if (profile.Categories) {
                        const primaryCategory = profile.Categories.split(',')[0].trim().toLowerCase();
                        const option = Array.from(inputs.category.options).find(opt => opt.value === primaryCategory);
                        if (option) {
                            option.selected = true;
                        }
                    }

                    await loadVendorImages(vendorProfileId);
                    await loadVendorAvailability(vendorProfileId);

                } catch (error) {
                    console.error('Error loading vendor profile details:', error);
                    for (const key in inputs) {
                        if (inputs[key] instanceof HTMLInputElement || inputs[key] instanceof HTMLTextAreaElement || inputs[key] instanceof HTMLSelectElement) {
                            inputs[key].value = 'Error';
                        }
                    }
                    alert('Failed to load vendor profile details: ' + error.message);
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const updateData = {
                            businessName: inputs.businessName.value,
                            description: inputs.description.value,
                            phone: inputs.phone.value,
                            email: inputs.email.value,
                            website: inputs.website.value,
                            yearsInBusiness: parseInt(inputs.yearsInBusiness.value),
                            address: inputs.address.value,
                            city: inputs.city.value,
                            state: inputs.state.value,
                            country: inputs.country.value,
                            postalCode: inputs.postalCode.value,
                            isPremium: inputs.isPremium.checked,
                            isEcoFriendly: inputs.isEcoFriendly.checked,
                            isAwardWinning: inputs.isAwardWinning.checked,
                        };

                        const response = await fetch(`${API_BASE_URL}/vendors/${vendorProfileId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(updateData)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to update vendor profile');
                        }
                        alert('Vendor profile updated successfully!');
                    } catch (error) {
                        console.error('Error updating vendor profile:', error);
                        alert('Failed to update vendor profile: ' + error.message);
                    }
                };
            }

            async function loadVendorImages(vendorProfileId) {
                const container = document.getElementById('vendor-photos');
                container.innerHTML = '<p>Loading photos...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/images`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor images');
                    const images = await response.json();
                    renderVendorImages(images, container);
                } catch (error) {
                    console.error('Error loading vendor images:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load photos: ${error.message}</p>`;
                }
            }

            function renderVendorImages(images, container) {
                container.innerHTML = '';
                if (images && images.length > 0) {
                    images.forEach(img => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.width = '100%';
                        imgDiv.style.height = '100px';
                        imgDiv.style.borderRadius = 'var(--radius)';
                        imgDiv.style.overflow = 'hidden';
                        imgDiv.style.position = 'relative';
                        imgDiv.innerHTML = `
                            <img src="${img.ImageURL}" alt="${img.Caption || 'Vendor Image'}" style="width:100%;height:100%;object-fit:cover;">
                            ${img.IsPrimary ? '<span style="position:absolute;top:5px;left:5px;background-color:var(--primary);color:white;padding:3px 8px;border-radius:10px;font-size:0.7rem;">Primary</span>' : ''}
                            <button class="btn btn-sm" style="position:absolute;bottom:5px;right:5px;background-color:rgba(255,255,255,0.8);border:none;color:var(--accent);" data-image-id="${img.ImageID}">Delete</button>
                        `;
                        container.appendChild(imgDiv);
                        imgDiv.querySelector('button').addEventListener('click', async () => {
                            if (confirm('Are you sure you want to delete this image?')) {
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.vendorProfileId}/images/${img.ImageID}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to delete image');
                                    alert('Image deleted successfully!');
                                    loadVendorImages(currentUser.vendorProfileId);
                                } catch (error) {
                                    console.error('Error deleting image:', error);
                                    alert('Failed to delete image: ' + error.message);
                                }
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<p>No photos uploaded.</p>';
                }

                // Handle upload photos button
                document.getElementById('upload-photos-btn').onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.multiple = true;
                    input.onchange = async (e) => {
                        const files = e.target.files;
                        if (files.length === 0) return;

                        alert('Simulating upload of ' + files.length + ' images. In a real app, these would be uploaded and saved.');
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const newImgDiv = document.createElement('div');
                                newImgDiv.style.width = '100%';
                                newImgDiv.style.height = '100px';
                                newImgDiv.style.borderRadius = 'var(--radius)';
                                newImgDiv.style.overflow = 'hidden';
                                newImgDiv.style.position = 'relative';
                                newImgDiv.innerHTML = `
                                    <img src="${e.target.result}" alt="New Image" style="width:100%;height:100%;object-fit:cover;">
                                    <button class="btn btn-sm" style="position:absolute;bottom:5px;right:5px;background-color:rgba(255,255,255,0.8);border:none;color:var(--accent);">Remove</button>
                                `;
                                container.appendChild(newImgDiv);
                                newImgDiv.querySelector('button').addEventListener('click', () => newImgDiv.remove());
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                };
            }

            async function loadVendorAvailability(vendorProfileId) {
                const calendarEl = document.getElementById('vendor-availability-calendar');
                if (!calendarEl) return;

                // Destroy existing calendar instance if it exists
                if (calendarEl._fullCalendar) {
                    calendarEl._fullCalendar.destroy();
                    calendarEl._fullCalendar = null;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/availability`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor availability');
                    const data = await response.json();
                    const businessHours = data.businessHours || [];
                    const exceptions = data.availabilityExceptions || [];

                    const events = [];

                    // Add business hours as recurring events
                    businessHours.forEach(bh => {
                        if (bh.IsAvailable) {
                            events.push({
                                daysOfWeek: [bh.DayOfWeek],
                                startTime: bh.OpenTime,
                                endTime: bh.CloseTime,
                                display: 'background',
                                color: '#d1fae5'
                            });
                        } else {
                            events.push({
                                daysOfWeek: [bh.DayOfWeek],
                                display: 'background',
                                color: '#fee2e2'
                            });
                        }
                    });

                    // Add exceptions
                    exceptions.forEach(ex => {
                        events.push({
                            start: ex.StartDate + (ex.StartTime ? 'T' + ex.StartTime : ''),
                            end: ex.EndDate + (ex.EndTime ? 'T' + ex.EndTime : ''),
                            title: ex.Reason || (ex.IsAvailable ? 'Available' : 'Unavailable'),
                            color: ex.IsAvailable ? '#2196F3' : '#F4436',
                            allDay: !ex.StartTime && !ex.EndTime,
                            extendedProps: {
                                exceptionId: ex.ExceptionID,
                                isAvailable: ex.IsAvailable,
                                reason: ex.Reason
                            }
                        });
                    });

                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        events: events,
                        selectable: true,
                        editable: true,
                        eventClick: function(info) {
                            const ex = info.event.extendedProps;
                            alert(`Exception: ${ex.reason || 'N/A'}\nAvailable: ${ex.isAvailable ? 'Yes' : 'No'}\nID: ${ex.exceptionId}`);
                        },
                        select: function(info) {
                            const reason = prompt('Reason for availability exception (e.g., "Holiday", "Closed for Maintenance")');
                            if (reason) {
                                const isAvailable = confirm('Is the vendor available during this exception? (OK for Yes, Cancel for No)');
                                upsertVendorAvailabilityException(
                                    null,
                                    info.startStr.split('T')[0],
                                    info.endStr.split('T')[0],
                                    null,
                                    null,
                                    isAvailable,
                                    reason
                                );
                            }
                        }
                    });
                    calendar.render();
                    calendarEl._fullCalendar = calendar;

                } catch (error) {
                    console.error('Error loading vendor availability:', error);
                    calendarEl.innerHTML = `<p style="color:var(--accent);">Failed to load availability: ${error.message}</p>`;
                }

                // Set Business Hours button handler
                document.getElementById('set-business-hours-btn').onclick = () => {
                    alert('Business Hours settings would open here. You can configure daily open/close times.');
                };
            }

            async function upsertVendorAvailabilityException(exceptionId, startDate, endDate, startTime, endTime, isAvailable, reason) {
                try {
                    const payload = {
                        exceptionId: exceptionId,
                        startDate: startDate,
                        endDate: endDate,
                        startTime: startTime,
                        endTime: endTime,
                        isAvailable: isAvailable,
                        reason: reason
                    };
                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.vendorProfileId}/availability-exceptions/upsert`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to upsert availability exception');
                    }
                    alert('Availability exception saved successfully!');
                    loadVendorAvailability(currentUser.vendorProfileId);
                } catch (error) {
                    console.error('Error upserting availability exception:', error);
                    alert('Failed to save availability exception: ' + error.message);
                }
            }

            // Simulate user login (for demo purposes)
            function simulateLogin(user) {
                currentUser = {
                    ...user,
                    userId: user.id, // Add userId for compatibility
                    isVendor: user.isVendor || false
                };
                
                // Also store in localStorage for consistency with getCurrentUser function
                localStorage.setItem('userSession', JSON.stringify(currentUser));

                showLoggedInView();
                
                // Close profile modal safely
                const profileModalEl = document.getElementById('profile-modal');
                if (profileModalEl) {
                    profileModalEl.style.display = 'none';
                }
                
                alert(`Welcome, ${user.name}! You are now logged in.`);

                // Update profile button to show user is logged in
                const profileBtnEl = document.getElementById('profile-btn');
                if (profileBtnEl) {
                    profileBtnEl.textContent = user.avatar;
                    profileBtnEl.style.backgroundColor = 'var(--primary)';
                    profileBtnEl.style.color = 'white';
                    profileBtnEl.style.borderRadius = '50%';
                    profileBtnEl.style.width = '36px';
                    profileBtnEl.style.height = '36px';
                    profileBtnEl.style.display = 'flex';
                    profileBtnEl.style.alignItems = 'center';
                    profileBtnEl.style.justifyContent = 'center';
                }

                // Update favorites badge safely
                const badge = document.querySelector('.badge');
                if (badge) {
                    // Check if state exists and has favorites, otherwise default to 0
                    const favoritesCount = (typeof state !== 'undefined' && state.favorites) ? state.favorites.length : 0;
                    badge.textContent = favoritesCount;
                }
                
                console.log('✅ User logged in:', currentUser);
            }

            // Toggle vendor favorite status
            async function toggleFavorite(vendorId) {
                if (!currentUser) {
                    profileModal.style.display = 'flex';
                    showLoginView();
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/favorites/toggle`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            vendorProfileId: vendorId
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to toggle favorite');
                    }

                    const result = await response.json();

                    const index = state.favorites.indexOf(vendorId);
                    if (result.isFavorite && index === -1) {
                        state.favorites.push(vendorId);
                    } else if (!result.isFavorite && index !== -1) {
                        state.favorites.splice(index, 1);
                    }

                    // Update UI
                    document.querySelectorAll(`.vendor-favorite[data-id="${vendorId}"]`).forEach(icon => {
                        icon.classList.toggle('active', result.isFavorite);
                    });

                    // Update badge
                    document.querySelector('.badge').textContent = state.favorites.length;

                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    alert('Failed to toggle favorite: ' + error.message);
                }
            }

            // Center map on user location
            function centerMapOnUser() {
                if (state.map && state.userLocation) {
                    state.map.setCenter(new google.maps.LatLng(state.userLocation.lat, state.userLocation.lng));
                    state.map.setZoom(12);
                }
            }

            // Create markers ONCE from search-by-services API response - NEVER recreate them
            function createMarkersOnce() {
                console.log('🎯 Creating markers from search-by-services API response');
                
                // Clear any existing markers first
                if (state.markers && state.markers.length > 0) {
                    state.markers.forEach(marker => marker.setMap(null));
                }
                state.markers = [];

                // Get vendors from the booking state where they are actually stored
                const vendorsToShow = window.bookingState?.availableVendors || 
                                   state.originalSearchResults || 
                                   state.filteredVendors || [];
                
                console.log('📊 Available vendors from bookingState:', window.bookingState?.availableVendors);
                console.log('📊 Vendors to show on map:', vendorsToShow);
                
                if (vendorsToShow.length === 0) {
                    console.warn('⚠️ No vendors found to display on map');
                    console.log('🔍 Checking all possible vendor sources:');
                    console.log('  - window.bookingState.availableVendors:', window.bookingState?.availableVendors);
                    console.log('  - state.originalSearchResults:', state.originalSearchResults);
                    console.log('  - state.filteredVendors:', state.filteredVendors);
                    return;
                }
                
                vendorsToShow.forEach(vendor => {
                    // Get coordinates directly from search-by-services API response
                    const lat = parseFloat(vendor.Latitude);
                    const lng = parseFloat(vendor.Longitude);

                    console.log(`🔍 Processing vendor: ${vendor.BusinessName}, Lat: ${lat}, Lng: ${lng}`);

                    // Skip vendors without valid coordinates
                    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                        console.warn('❌ Skipping vendor with invalid coordinates:', vendor.BusinessName, { lat, lng });
                        return;
                    }

                    console.log(`📍 Creating marker for ${vendor.BusinessName} at ${lat}, ${lng}`);

                    const marker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: state.map,
                        title: vendor.BusinessName,
                        animation: google.maps.Animation.DROP,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#3498db',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });

                    state.markers.push(marker);

                    // Add click event to show vendor info
                    marker.addListener('click', () => {
                        console.log(`🖱️ Clicked on vendor: ${vendor.BusinessName} (ID: ${vendor.VendorProfileID})`);
                        window.location.hash = `/listings/${vendor.VendorProfileID}`;
                    });
                });

                console.log(`✅ Created ${state.markers.length} markers from search-by-services API`);
                
                // Center map on markers if they exist
                if (state.markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    state.markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    state.map.fitBounds(bounds);
                    
                    // Set reasonable zoom level
                    google.maps.event.addListenerOnce(state.map, 'bounds_changed', () => {
                        if (state.map.getZoom() > 15) {
                            state.map.setZoom(15);
                        }
                    });
                }
            }

            // DISABLED: Old updateMapMarkers function that was causing bouncing
            function updateMapMarkers() {
                console.log('🚫 updateMapMarkers() disabled - use createMarkersOnce() instead');
                return;
            }

            // --- IMAGE GALLERY AND LIGHTBOX FUNCTIONS ---

            // FIXED: New function to properly populate vendor gallery using images[] array
            function populateVendorGallery(images) {
                console.log('🎯 populateVendorGallery called with:', images);
                
                const galleryContainer = document.getElementById('modal-image-gallery');
                if (!galleryContainer) {
                    console.warn('Gallery container not found');
                    return;
                }

                // Clear existing content
                galleryContainer.innerHTML = '';

                // Extract image URLs from the images array (handles Cloudinary format)
                const imageUrls = [];
                if (images && Array.isArray(images)) {
                    images.forEach(img => {
                        if (img.url) {
                            imageUrls.push(img.url);
                        } else if (img.ImageURL) {
                            imageUrls.push(img.ImageURL);
                        }
                    });
                }

                console.log('📸 Extracted image URLs:', imageUrls);

                // Set lightbox images for navigation
                lightboxImages = imageUrls;

                const totalImages = imageUrls.length;
                const placeholderImage = "https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png";

                // Create main image (large)
                const largeImageDiv = document.createElement('div');
                largeImageDiv.className = 'gallery-item large-image';
                const mainImageUrl = totalImages > 0 ? imageUrls[0] : placeholderImage;
                largeImageDiv.innerHTML = `<img src="${mainImageUrl}" alt="Main Venue Image">`;
                
                // Add click event for lightbox if we have real images
                if (totalImages > 0) {
                    largeImageDiv.addEventListener('click', () => openLightbox(0));
                    largeImageDiv.style.cursor = 'pointer';
                }
                
                galleryContainer.appendChild(largeImageDiv);

                // Create thumbnails container
                const thumbnailsContainer = document.createElement('div');
                thumbnailsContainer.className = 'thumbnails-container';

                // Add 4 thumbnail slots with fixed positions
                for (let i = 1; i <= 4; i++) {
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'gallery-item';
                    
                    const thumbImageUrl = i < totalImages ? imageUrls[i] : placeholderImage;
                    thumbDiv.innerHTML = `<img src="${thumbImageUrl}" alt="Thumbnail ${i}">`;

                    // Add click event to update main image but keep thumbnails fixed
                    if (i < totalImages) {
                        thumbDiv.addEventListener('click', () => {
                            const mainImg = galleryContainer.querySelector('.large-image img');
                            if (mainImg) {
                                mainImg.src = imageUrls[i];
                            }
                            // Open lightbox
                            openLightbox(i);
                        });
                        thumbDiv.style.cursor = 'pointer';
                    }

                    // Add "+X See All" overlay on the last thumbnail if there are more images
                    if (i === 4 && totalImages > 5) {
                        const hiddenCount = totalImages - 5;
                        const overlay = document.createElement('div');
                        overlay.className = 'see-all-overlay';
                        overlay.textContent = `+${hiddenCount} See All`;
                        thumbDiv.appendChild(overlay);
                        
                        // Make the overlay clickable to open lightbox
                        thumbDiv.onclick = () => openLightbox(0);
                    }

                    thumbnailsContainer.appendChild(thumbDiv);
                }

                galleryContainer.appendChild(thumbnailsContainer);
                
                console.log(`✅ Gallery populated with ${totalImages} images`);
            }

            // NEW: Simplified and reliable gallery population function
    function populateVendorGallery(images) {
        console.log('🖼️ populateVendorGallery called with:', images);
        
        const galleryContainer = document.getElementById('modal-image-gallery');
        if (!galleryContainer) {
            console.warn('Gallery container not found');
            return;
        }

        // Extract image URLs from the images array
        const imageUrls = [];
        if (images && Array.isArray(images)) {
            images.forEach(img => {
                if (img.url) {
                    imageUrls.push(img.url);
                } else if (img.ImageURL) {
                    imageUrls.push(img.ImageURL);
                } else if (typeof img === 'string') {
                    imageUrls.push(img);
                }
            });
        }

        console.log('📸 Extracted image URLs:', imageUrls);

        // Set lightbox images for navigation
        lightboxImages = imageUrls;

        // Clear and rebuild gallery
        galleryContainer.innerHTML = '';

        // Create main image (left side)
        const mainImageDiv = document.createElement('div');
        mainImageDiv.className = 'gallery-item large-image';
        
        const mainImg = document.createElement('img');
        mainImg.src = imageUrls.length > 0 ? imageUrls[0] : 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
        mainImg.alt = 'Main Venue Image';
        mainImg.style.width = '100%';
        mainImg.style.height = '100%';
        mainImg.style.objectFit = 'cover';
        
        // Add subtle border for placeholder images
        if (imageUrls.length === 0) {
            mainImg.style.border = '1px solid var(--border)';
            mainImg.style.borderRadius = 'var(--radius)';
        }
        
        if (imageUrls.length > 0) {
            mainImg.style.cursor = 'pointer';
            mainImg.addEventListener('click', () => openLightbox(0));
        }
        
        mainImageDiv.appendChild(mainImg);
        galleryContainer.appendChild(mainImageDiv);

        // Create thumbnails container (right side)
        const thumbnailsContainer = document.createElement('div');
        thumbnailsContainer.className = 'thumbnails-container';

        // Create 4 thumbnail slots
        for (let i = 1; i <= 4; i++) {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'gallery-item';
            
            const thumbImg = document.createElement('img');
            thumbImg.src = i < imageUrls.length ? imageUrls[i] : 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
            thumbImg.alt = `Thumbnail ${i}`;
            thumbImg.style.width = '100%';
            thumbImg.style.height = '100%';
            thumbImg.style.objectFit = 'cover';
            
            // Add subtle border for placeholder thumbnails
            if (i >= imageUrls.length) {
                thumbImg.style.border = '1px solid var(--border)';
                thumbImg.style.borderRadius = 'var(--radius)';
            }
            
            // FIXED: Add click functionality for real images - ONLY open lightbox, don't change main image
            if (i < imageUrls.length) {
                thumbImg.style.cursor = 'pointer';
                thumbImg.addEventListener('click', () => {
                    // Only open lightbox at the thumbnail's image index
                    openLightbox(i);
                });
            }
            
            thumbDiv.appendChild(thumbImg);

            // Add "See All" overlay on last thumbnail if there are more images
            if (i === 4 && imageUrls.length > 5) {
                const overlay = document.createElement('div');
                overlay.className = 'see-all-overlay';
                overlay.textContent = `+${imageUrls.length - 5} See All`;
                overlay.style.cursor = 'pointer';
                overlay.addEventListener('click', () => openLightbox(0));
                thumbDiv.appendChild(overlay);
            }

            thumbnailsContainer.appendChild(thumbDiv);
        }

        galleryContainer.appendChild(thumbnailsContainer);
        
        console.log(`✅ Gallery populated with ${imageUrls.length} images`);
    }

    // Keep the old function for backward compatibility but make it call the new one
    function populateImageGallery(images) {
        console.log('⚠️ populateImageGallery (legacy) called, redirecting to populateVendorGallery');
        populateVendorGallery(images);
    }

            function setupLightboxEventListeners() {
                const lightbox = document.getElementById('lightbox-modal');
                const closeBtn = lightbox.querySelector('.lightbox-close');
                const prevBtn = lightbox.querySelector('.lightbox-prev');
                const nextBtn = lightbox.querySelector('.lightbox-nav.lightbox-next');
                
                // Ensure only one listener is active
                if (closeBtn) closeBtn.removeEventListener('click', closeLightbox);
                if (prevBtn) prevBtn.removeEventListener('click', showPrevImage);
                if (nextBtn) nextBtn.removeEventListener('click', showNextImage);
                
                if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
                if (prevBtn) prevBtn.addEventListener('click', showPrevImage);
                if (nextBtn) nextBtn.addEventListener('click', showNextImage);

                if (lightbox) {
                    if (lightbox.__overlayClickListener) {
                        lightbox.removeEventListener('click', lightbox.__overlayClickListener);
                    }
                    
                    const newListener = (e) => {
                        if (e.target === lightbox) {
                            closeLightbox();
                        }
                    };
                    lightbox.addEventListener('click', newListener);
                    lightbox.__overlayClickListener = newListener;
                }

                document.addEventListener('keydown', (e) => {
                    if (lightbox.style.display === 'flex') {
                        if (e.key === 'Escape') closeLightbox();
                        if (e.key === 'ArrowLeft') showPrevImage();
                        if (e.key === 'ArrowRight') showNextImage();
                    }
                });
            }

            function openLightbox(index) {
                currentLightboxIndex = index;
                updateLightboxImage();
                document.getElementById('lightbox-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeLightbox() {
                document.getElementById('lightbox-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            function updateLightboxImage() {
                const lightboxImage = document.getElementById('lightbox-image');
                if (lightboxImages.length > 0) {
                    lightboxImage.src = lightboxImages[currentLightboxIndex];
                } else {
                     lightboxImage.src = 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
                }
            }

            function showPrevImage() {
                if (lightboxImages.length > 0) {
                    currentLightboxIndex = (currentLightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
                    updateLightboxImage();
                }
            }

            function showNextImage() {
                if (lightboxImages.length > 0) {
                    currentLightboxIndex = (currentLightboxIndex + 1) % lightboxImages.length;
                    updateLightboxImage();
                }
            }

            // Render vendors with Cloudinary images
            function renderVendors() {
                if (!vendorGrid) return;
                
                const vendorsToShow = state.filteredVendors.slice(
                    (state.currentPage - 1) * state.vendorsPerPage,
                    state.currentPage * state.vendorsPerPage
                );

                if (vendorsToShow.length === 0) {
                    vendorGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-light);">No vendors found matching your criteria.</div>';
                    return;
                }

                vendorGrid.innerHTML = vendorsToShow.map(vendor => {
                    // Try all possible field name variations for featured image
                    const imageUrl = vendor.FeaturedImageURL || 
                                   vendor.featuredImageURL ||
                                   vendor.featuredImageUrl ||  // lowercase 'u'
                                   vendor.FeaturedImageUrl ||   // mixed case
                                   vendor.image || 
                                   vendor.ImageURL ||
                                   vendor.imageURL ||
                                   vendor.imageUrl ||
                                   vendor.featuredImage?.url || 
                                   vendor.featuredImage?.thumbnailUrl || 
                                   (vendor.images && vendor.images.length > 0 ? vendor.images[0].url : null) ||
                                   'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
                    
                    console.log('Rendering vendor:', vendor.name || vendor.BusinessName, 'with image:', imageUrl, 'Available fields:', Object.keys(vendor));
                    console.log('Full vendor object:', vendor);
                    console.log('Image field value:', vendor.image);
                    console.log('FeaturedImage object:', vendor.featuredImage);
                    console.log('Images array:', vendor.images);
                    
                    const isFavorite = state.favorites.includes(vendor.VendorProfileID || vendor.id);
                    const badges = [];
                    
                    if (vendor.isPremium) badges.push('<span class="vendor-badge premium">Premium</span>');
                    if (vendor.isEcoFriendly) badges.push('<span class="vendor-badge eco">Eco-Friendly</span>');
                    if (vendor.isAwardWinning) badges.push('<span class="vendor-badge award">Award Winner</span>');

                    const priceLevel = vendor.priceLevel || 2;
                    const priceDots = Array.from({length: 3}, (_, i) => 
                        `<span class="price-dot ${i < priceLevel ? 'filled' : ''}"></span>`
                    ).join('');

                    // Robust price resolution and formatting (prefer backend startingPrice)
                    const rawPrice = vendor.startingPrice ?? vendor.MinPriceNumeric ?? vendor.MinPrice ?? vendor.price ?? vendor.Price ?? vendor.minPrice ?? vendor.starting_price;
                    let priceDisplay = '';
                    if (rawPrice !== undefined && rawPrice !== null && rawPrice !== '') {
                        if (typeof rawPrice === 'number') {
                            priceDisplay = `$${Math.round(rawPrice)}`;
                        } else if (typeof rawPrice === 'string') {
                            const trimmed = rawPrice.trim();
                            priceDisplay = trimmed.startsWith('$') ? trimmed : `$${trimmed}`;
                        }
                    }

                    // Vendor description/bio resolution with truncation
                    const fullDesc = vendor.Bio || vendor.bio || vendor.Description || vendor.description || vendor.About || vendor.about || '';
                    const descText = (fullDesc || '').toString();
                    const shortDesc = descText.length > 140 ? `${descText.slice(0, 140)}…` : descText;

                    // Rating and location meta
                    const ratingValue = (() => { const r = parseFloat(vendor.averageRating ?? vendor.rating ?? 4.5); return isNaN(r) ? 4.5 : r; })();
                    const reviewCount = vendor.totalReviews ?? vendor.reviewCount ?? 0;
                    const locCity = vendor.City || vendor.city || '';
                    const locState = vendor.State || vendor.state || '';
                    const locationText = (vendor.location && vendor.location.trim()) || [locCity, locState].filter(Boolean).join(', ');

                    return `
                        <div class="vendor-card">
                            <div class="vendor-image">
                                <img src="${imageUrl}" alt="${vendor.BusinessName || vendor.name}" 
                                     style="width:100%;height:100%;object-fit:cover;"
                                     onerror="this.src='https://placehold.co/800x600/e2e8f0/718096?text=No+Image'">
                                <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${vendor.VendorProfileID || vendor.id}"><i class="fas fa-heart"></i></div>
                                <div class="vendor-badges" style="position: absolute; bottom: 8px; left: 8px; display: flex; gap: 6px;">
                                    ${badges.join('')}
                                </div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name" style="font-size:1.1rem;">${vendor.BusinessName || vendor.name}</h3>
                                <div class="vendor-location" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
                                    <span><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${locationText || 'Location unavailable'}</span>
                                    <span style="color:#6b7280;">•</span>
                                    <span style="display:flex;align-items:center;gap:.5rem;">
                                        <span style="color:#f59e0b;font-size:.9rem;">${'★'.repeat(Math.floor(ratingValue))}${'☆'.repeat(5-Math.floor(ratingValue))}</span>
                                        <span style="font-size:.85rem;color:#6b7280;">${ratingValue.toFixed(1)} (${reviewCount})</span>
                                    </span>
                                </div>
                                ${shortDesc ? `<div class="vendor-description" style="margin:.5rem 0 0.25rem;color:var(--text-light);font-size:.95rem;line-height:1.4;">${shortDesc}</div>` : ''}
                                <div class="vendor-footer">
                                    <div class="vendor-price" style="font-weight:600;">${priceDisplay ? `<span>Starting from</span> ${priceDisplay}` : ''}</div>
                                    <div class="vendor-actions">
                                        <button class="btn btn-outline save-btn" data-id="${vendor.VendorProfileID || vendor.id}">Save</button>
                                        <button class="btn btn-primary view-btn" data-id="${vendor.VendorProfileID || vendor.id}">View</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add event listeners for the new vendor cards
                setupVendorCardEventListeners();
                updatePagination();
                // If map is visible, refresh markers for current page
                const mapEl = document.getElementById('map-view');
                if (mapEl && mapEl.style.display === 'block') {
                    updateMapMarkers();
                }
            }

            // Setup event listeners for vendor cards
            function setupVendorCardEventListeners() {
                // Favorite buttons
                document.querySelectorAll('.vendor-favorite').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const vendorId = btn.dataset.id;
                        toggleFavorite(vendorId);
                    });
                });

                // View buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const vendorId = btn.dataset.id;
                        // Open in new tab with listings path format
                        const baseUrl = window.location.origin + window.location.pathname;
                        const profileUrl = `${baseUrl}/listings/${vendorId}`;
                        window.open(profileUrl, '_blank');
                    });
                });

                // Save buttons
                document.querySelectorAll('.save-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const vendorId = btn.dataset.id;
                        toggleFavorite(vendorId);
                    });
                });
            }

            // Update metadata display
            function updateMetadata(data) {
                if (resultsTitle) {
                    const label = (state.filters && state.filters.location) || state.userLocationLabel || 'Near you';
                    resultsTitle.textContent = `Vendors in ${label}`;
                }
                if (resultsCount) {
                    resultsCount.textContent = `${data.total || state.filteredVendors.length} vendors available`;
                }
            }

            // =============== Map (Google Maps) Integration ===============
            // Attempt to retrieve the Google Maps API key similar to booking process
            function getGoogleMapsApiKey() {
                // Try common globals used elsewhere in the app
                const fromBookingState = (window.bookingState && window.bookingState.googleMapsApiKey) || null;
                const fromBookingConfig = (window.bookingConfig && window.bookingConfig.googleMapsApiKey) || null;
                const fromAppConfig = (window.APP_CONFIG && window.APP_CONFIG.googleMapsApiKey) || null;
                const fromMeta = (() => {
                    const tag = document.querySelector('meta[name="google-maps-api-key"]');
                    return tag ? tag.getAttribute('content') : null;
                })();
                const fromStorage = localStorage.getItem('googleMapsApiKey');
                return fromBookingState || fromBookingConfig || fromAppConfig || fromMeta || fromStorage || null;
            }

            let googleMapsLoadingPromise = null;
            function loadGoogleMaps() {
                if (window.google && window.google.maps) return Promise.resolve();
                if (googleMapsLoadingPromise) return googleMapsLoadingPromise;
                const apiKey = getGoogleMapsApiKey();
                googleMapsLoadingPromise = new Promise((resolve, reject) => {
                    if (!apiKey) {
                        return reject(new Error('Google Maps API key not found. Provide it via booking config or a meta tag.'));
                    }
                    const cbName = 'initGMap_' + Math.random().toString(36).slice(2);
                    window[cbName] = () => { resolve(); delete window[cbName]; };
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&callback=${cbName}`;
                    script.async = true;
                    script.onerror = () => reject(new Error('Failed to load Google Maps JS API'));
                    document.body.appendChild(script);
                });
                return googleMapsLoadingPromise;
            }

            // Initialize map state
            function ensureMapState() {
                state.map = state.map || {
                    initialized: false,
                    map: null,
                    markers: [],
                    geoCache: {},
                    geocoder: null,
                };
                // Load cached geocodes
                try {
                    const cached = localStorage.getItem('geoCacheV1');
                    if (cached) state.map.geoCache = JSON.parse(cached);
                } catch (e) { console.warn('Geo cache load failed', e); }
            }

            function saveGeoCache() {
                try { localStorage.setItem('geoCacheV1', JSON.stringify(state.map.geoCache || {})); } catch {}
            }

            async function initMapIfNeeded() {
                ensureMapState();
                if (state.map.initialized) return;
                await loadGoogleMaps();
                const mapEl = document.getElementById('map-view');
                if (!mapEl) return;
                state.map.map = new google.maps.Map(mapEl, {
                    center: { lat: 34.0522, lng: -118.2437 }, // Default LA center
                    zoom: 10,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                });
                state.map.geocoder = new google.maps.Geocoder();
                state.map.initialized = true;
                // Center on user if we have coords
                if (state.userCoords) {
                    state.map.map.setCenter({ lat: state.userCoords.lat, lng: state.userCoords.lon });
                    state.map.map.setZoom(11);
                }
            }

            // Geocode a location string via Google Geocoder, with cache
            async function geocodeLocation(query) {
                ensureMapState();
                if (!query) return null;
                const key = query.trim().toLowerCase();
                if (state.map.geoCache[key]) return state.map.geoCache[key];
                await initMapIfNeeded();
                if (!state.map.geocoder) return null;
                return new Promise((resolve) => {
                    state.map.geocoder.geocode({ address: query }, (results, status) => {
                        if (status === 'OK' && results && results[0]) {
                            const loc = results[0].geometry.location;
                            const result = { lat: loc.lat(), lon: loc.lng(), label: results[0].formatted_address };
                            state.map.geoCache[key] = result;
                            saveGeoCache();
                            resolve(result);
                        } else {
                            resolve(null);
                        }
                    });
                });
            }

            function clearMapMarkers() {
                if (!state.map || !state.map.markers) return;
                state.map.markers.forEach(m => { try { m.setMap(null); } catch {} });
                state.map.markers = [];
            }

            async function updateMapMarkers() {
                const mapEl = document.getElementById('map-view');
                if (!mapEl || mapEl.style.display === 'none') return; // Map hidden
                await initMapIfNeeded();
                if (!(window.google && state.map.map)) return;

                clearMapMarkers();
                const vendors = state.filteredVendors.slice(0, 25); // Limit to avoid quota issues
                const bounds = new google.maps.LatLngBounds();
                let added = 0;
                for (const vendor of vendors) {
                    const q = (vendor.location && vendor.location.trim()) || [vendor.City, vendor.State].filter(Boolean).join(', ');
                    if (!q) continue;
                    try {
                        const geo = await geocodeLocation(q);
                        if (!geo) continue;
                        const position = { lat: geo.lat, lng: geo.lon };
                        const marker = new google.maps.Marker({ position, map: state.map.map, title: (vendor.BusinessName || vendor.name || 'Vendor') });
                        const name = vendor.BusinessName || vendor.name || 'Vendor';
                        const price = vendor.startingPrice ?? vendor.MinPriceNumeric ?? vendor.MinPrice ?? vendor.price ?? '';
                        const priceDisplay = (typeof price === 'number') ? `$${Math.round(price)}` : (typeof price === 'string' ? price : '');
                        const info = new google.maps.InfoWindow({ content: `<strong>${name}</strong><br>${q}${priceDisplay ? `<br>Starting from ${priceDisplay}` : ''}` });
                        marker.addListener('click', () => info.open({ map: state.map.map, anchor: marker }));
                        state.map.markers.push(marker);
                        bounds.extend(position);
                        added++;
                    } catch (e) { console.warn('Geocode failed for', q, e); }
                }
                if (added > 0) {
                    try { state.map.map.fitBounds(bounds, { padding: 30 }); } catch {}
                } else if (state.userCoords) {
                    state.map.map.setCenter({ lat: state.userCoords.lat, lng: state.userCoords.lon });
                    state.map.map.setZoom(11);
                }
            }

            // View toggle (List | Map) — insert segmented control in header location
            (function setupViewToggle() {
                const targetSlot = document.getElementById('legacy-view-toggle');
                if (!targetSlot) return;

                // Inject minimal CSS once
                if (!document.getElementById('view-toggle-styles')) {
                    const style = document.createElement('style');
                    style.id = 'view-toggle-styles';
                    style.textContent = `
                        .view-toggle { display:inline-flex; align-items:center; height:36px; margin-left:8px; background:#fff; border:1px solid var(--border); box-shadow:none !important; border-radius: var(--radius); overflow:hidden; }
                        /* Full-bleed fill without seams using container gradient depending on which button is active */
                        .view-toggle:has(.toggle-btn:first-child.active) { background: linear-gradient(90deg, #f6f8ff 0%, #f6f8ff 50%, #ffffff 50%, #ffffff 100%); }
                        .view-toggle:has(.toggle-btn:last-child.active) { background: linear-gradient(90deg, #ffffff 0%, #ffffff 50%, #f6f8ff 50%, #f6f8ff 100%); }
                        .view-toggle .toggle-btn { display:flex; align-items:center; gap:6px; height:100%; padding:0 12px; font-weight:400; font-size:13px; color:#475569; background:transparent; border:0 !important; cursor:pointer; outline:none !important; box-shadow:none !important; }
                        /* Remove inner border to avoid visible seam; container gradient provides the split */
                        .view-toggle .toggle-btn + .toggle-btn { border-left:0; }
                        /* Prevent seam/gap next to the active segment */
                        .view-toggle .toggle-btn.active + .toggle-btn { border-left-color: transparent; }
                        .view-toggle .toggle-btn:last-child.active { box-shadow: none; }
                        .view-toggle .toggle-btn + .toggle-btn::before { display:none; content:""; }
                        .view-toggle .toggle-btn .icon i { font-size:13px; opacity:0.7; }
                        /* Active relies on container background for fill; keep button background transparent */
                        .view-toggle .toggle-btn.active { color:#2563eb; background:transparent; }
                        .view-toggle .toggle-btn:first-child.active { border-top-left-radius: var(--radius); border-bottom-left-radius: var(--radius); }
                        .view-toggle .toggle-btn:last-child.active { border-top-right-radius: var(--radius); border-bottom-right-radius: var(--radius); }
                        .view-toggle .toggle-btn.active::after { content:none; }
                        .view-toggle .toggle-btn.active + .toggle-btn::before { background:var(--border); }
                        .view-toggle .toggle-btn:not(.active):hover { color:#1f2937; background:#f8fafc; }
                        .view-toggle .toggle-btn:focus, .view-toggle .toggle-btn:focus-visible { outline: none !important; box-shadow: none !important; }
                        .view-toggle .icon { display:inline-flex; width:14px; height:14px; justify-content:center; align-items:center; }
                        .view-toggle .icon i { font-size:13px; line-height:1; }
                    `;
                    document.head.appendChild(style);
                }

                // Ensure Font Awesome is available (load if missing)
                const hasFA = !!document.querySelector('link[href*="fontawesome"], link[href*="font-awesome"], link[href*="cdnjs.cloudflare.com/ajax/libs/font-awesome"]');
                if (!hasFA) {
                    const fa = document.createElement('link');
                    fa.rel = 'stylesheet';
                    fa.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css';
                    fa.crossOrigin = 'anonymous';
                    fa.referrerPolicy = 'no-referrer';
                    document.head.appendChild(fa);
                }

                const wrapper = document.createElement('div');
                wrapper.id = 'view-toggle';
                wrapper.className = 'view-toggle';
                wrapper.innerHTML = `
                    <button type="button" id="btn-view-list" class="toggle-btn active"><span class="icon"><i class="fa-solid fa-list-ul"></i></span><span>List</span></button>
                    <button type="button" id="btn-view-map" class="toggle-btn"><span class="icon"><i class="fa-solid fa-map"></i></span><span>Map</span></button>
                `;
                targetSlot.innerHTML = '';
                targetSlot.appendChild(wrapper);

                const listBtn = document.getElementById('btn-view-list');
                const mapBtn = document.getElementById('btn-view-map');

                function setActive(view) {
                    const mapEl = document.getElementById('map-view');
                    const gridEl = document.getElementById('vendor-grid');
                    const paginationEl = document.getElementById('pagination');
                    if (!mapEl) return;
                    if (view === 'map') {
                        mapEl.style.display = 'block';
                        if (gridEl) gridEl.style.display = 'none';
                        if (paginationEl) paginationEl.style.display = 'none';
                        listBtn.classList.remove('active');
                        mapBtn.classList.add('active');
                        try { localStorage.setItem('vv_view', 'map'); } catch {}
                        initMapIfNeeded().then(updateMapMarkers).catch(() => {});
                    } else {
                        mapEl.style.display = 'none';
                        if (gridEl) gridEl.style.display = '';
                        if (paginationEl) paginationEl.style.display = '';
                        mapBtn.classList.remove('active');
                        listBtn.classList.add('active');
                        try { localStorage.setItem('vv_view', 'list'); } catch {}
                    }
                }

                listBtn.addEventListener('click', () => setActive('list'));
                mapBtn.addEventListener('click', () => setActive('map'));

                // Initialize based on current visibility
                const mapEl = document.getElementById('map-view');
                let initial = 'list';
                try {
                    const saved = localStorage.getItem('vv_view');
                    if (saved === 'map' || saved === 'list') initial = saved;
                } catch {}
                setActive(initial);
            })();

            // Update pagination
            function updatePagination() {
                const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                
                // Debug logging
                console.log('Pagination Debug:', {
                    filteredVendorsCount: state.filteredVendors.length,
                    vendorsPerPage: state.vendorsPerPage,
                    totalPages: totalPages,
                    currentPage: state.currentPage
                });
                
                if (prevPageBtn) {
                    prevPageBtn.disabled = state.currentPage <= 1;
                }
                if (nextPageBtn) {
                    nextPageBtn.disabled = state.currentPage >= totalPages;
                }
                
                // Update page info if exists
                const pageInfo = document.querySelector('.page-info');
                if (pageInfo) {
                    pageInfo.textContent = `Page ${state.currentPage} of ${totalPages}`;
                }
                
                // Update numbered page buttons visibility and state
                document.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)').forEach((btn, index) => {
                    const pageNum = index + 1;
                    if (pageNum <= totalPages) {
                        btn.style.display = 'block';
                        btn.classList.toggle('active', pageNum === state.currentPage);
                    } else {
                        btn.style.display = 'none';
                    }
                });
            }

            // Filter vendors based on current filters
            function filterVendors() {
                state.filteredVendors = state.vendors.filter(vendor => {
                    // Category filter
                    if (state.currentCategory !== 'all' && vendor.category !== state.currentCategory) {
                        return false;
                    }
                    
                    // Location filter
                    if (state.filters.location) {
                        const location = state.filters.location.toLowerCase();
                        const vendorLocation = `${vendor.City || ''} ${vendor.State || ''}`.toLowerCase();
                        if (!vendorLocation.includes(location)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                state.currentPage = 1; // Reset to first page
                renderVendors();
                updateMetadata({ total: state.filteredVendors.length });
            }

            // Load vendors from API
            async function loadVendors() {
                try {
                    console.log('Loading vendors from API...');
                    const response = await fetch(`${API_BASE_URL}/vendors`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Response Error:', response.status, errorText);
                        throw new Error(`Failed to fetch vendors: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Raw API response:', data);
                    
                    // Handle backend response format: { vendors: [...], totalCount: number }
                    const vendors = data.vendors || [];
                    const totalCount = data.totalCount || vendors.length;
                    
                    console.log(`API returned ${vendors.length} vendors, totalCount: ${totalCount}`);
                    
                    // Store vendors in state
                    state.vendors = vendors;
                    state.filteredVendors = vendors;
                    
                    // Clear the static HTML and render dynamic vendors
                    if (vendorGrid) {
                        vendorGrid.innerHTML = ''; // Clear static content
                        renderVendors();
                    }
                    
                    updatePagination();
                    updateMetadata({ total: totalCount });
                    // Attempt geolocation after initial render to personalize results
                    tryInitGeolocation();
                    
                    console.log(`Successfully loaded and rendered ${vendors.length} vendors`);
                    
                } catch (error) {
                    console.error('Error loading vendors:', error);
                    
                    // Show error message in vendor grid
                    if (vendorGrid) {
                        vendorGrid.innerHTML = `
                            <div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--accent);">
                                <p>Failed to load vendors: ${error.message}</p>
                                <button class="btn btn-primary" onclick="loadVendors()" style="margin-top:1rem;">Retry</button>
                            </div>
                        `;
                    }
                }
            }

            // Get category icon
            function getCategoryIcon(category) {
                const icons = {
                    "venue": "🏢",
                    "photo": "📷",
                    "music": "🎵",
                    "catering": "🍽️",
                    "entertainment": "🎭",
                    "experiences": "⭐",
                    "decor": "🎀",
                    "beauty": "💄",
                    "cake": "🎂",
                    "transport": "🚐",
                    "planner": "📋",
                    "fashion": "👗",
                    "stationery": "✉️"
                };
                return icons[category?.toLowerCase()] || "💎";
            }

            // Add pagination event listeners
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (state.currentPage > 1) {
                        state.currentPage--;
                        renderVendors();
                        updatePagination();
                        const mapEl = document.getElementById('map-view');
                        if (mapEl && mapEl.style.display === 'block') updateMapMarkers();
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                    if (state.currentPage < totalPages) {
                        state.currentPage++;
                        renderVendors();
                        updatePagination();
                        const mapEl = document.getElementById('map-view');
                        if (mapEl && mapEl.style.display === 'block') updateMapMarkers();
                    }
                });
            }

            // Add event listeners for numbered page buttons
            document.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)').forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    const pageNum = index + 1;
                    const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                    if (pageNum <= totalPages) {
                        state.currentPage = pageNum;
                        renderVendors();
                        updatePagination();
                        const mapEl = document.getElementById('map-view');
                        if (mapEl && mapEl.style.display === 'block') updateMapMarkers();
                        
                        // Update active page button
                        document.querySelectorAll('.page-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });
            });

            // Initialize pagination on page load
            updatePagination();

            // DEPRECATED: Old gallery population function - replaced by populateVendorGallery()
            // Keeping for backward compatibility but not used in main flow
            function populateVendorProfileGallery(vendorData) {
                console.log('⚠️ DEPRECATED: populateVendorProfileGallery called - use populateVendorGallery instead');
                if (vendorData && vendorData.images) {
                    populateVendorGallery(vendorData.images);
                }
            }

            // Keep for backward compatibility
            window.populateVendorProfileGallery = populateVendorProfileGallery;

            // MANUAL TEST FUNCTION - Call this directly in browser console to test gallery population
            window.testGalleryWithKnownImages = function() {
                console.log('=== MANUAL GALLERY TEST ===');
                
                // Use the images we KNOW exist from Bundle Booths vendor (VendorProfileID 62)
                const testVendorData = {
                    images: [
                        {
                            url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                            isPrimary: false,
                            displayOrder: 0,
                            caption: 'Gallery Image 1'
                        },
                        {
                            url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                            isPrimary: true,
                            displayOrder: 1,
                            caption: 'Gallery Image 2'
                        },
                        {
                            url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png',
                            isPrimary: false,
                            displayOrder: 2,
                            caption: 'Gallery Image 3'
                        }
                    ],
                    profile: {
                        FeaturedImageURL: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png'
                    }
                };
                
                console.log('Testing with known images:', testVendorData);
                populateVendorProfileGallery(testVendorData);
                console.log('=== MANUAL TEST COMPLETE ===');
            };

            // SIMPLE DIRECT GALLERY POPULATION - No API calls, just use known images
            window.populateGalleryNow = function() {
                console.log('=== DIRECT GALLERY POPULATION ===');
                
                const mainImage = document.getElementById('main-vendor-image');
                const thumbnailsContainer = document.getElementById('vendor-thumbnails');
                
                if (!mainImage || !thumbnailsContainer) {
                    console.log('Gallery elements not found - make sure you are on vendor profile page');
                    return;
                }
                
                // Known working Cloudinary URLs from Bundle Booths vendor
                const knownImages = [
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png'
                ];
                
                // Set main image
                mainImage.src = knownImages[0];
                console.log('Set main image to:', knownImages[0]);
                
                // Clear and populate thumbnails
                thumbnailsContainer.innerHTML = '';
                
                knownImages.forEach((imageUrl, index) => {
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'gallery-item';
                    thumbnailDiv.style.cursor = 'pointer';
                    
                    const thumbnailImg = document.createElement('img');
                    thumbnailImg.src = imageUrl;
                    thumbnailImg.alt = `Gallery Image ${index + 1}`;
                    thumbnailImg.onclick = () => {
                        mainImage.src = imageUrl;
                        console.log('Switched main image to:', imageUrl);
                    };
                    
                    thumbnailDiv.appendChild(thumbnailImg);
                    thumbnailsContainer.appendChild(thumbnailDiv);
                });
                
                console.log('Added 3 thumbnail images to gallery');
                console.log('=== DIRECT POPULATION COMPLETE ===');
            };

            // DIAGNOSTIC FUNCTION - Check if gallery elements exist and what page we're on
            window.checkGalleryElements = function() {
                console.log('=== GALLERY DIAGNOSTIC ===');
                
                // Check if vendor profile page is visible
                const vendorProfilePage = document.getElementById('vendor-profile-page');
                console.log('Vendor profile page element:', vendorProfilePage);
                console.log('Vendor profile page display style:', vendorProfilePage ? vendorProfilePage.style.display : 'NOT FOUND');
                
                // Check for gallery elements
                const mainImage = document.getElementById('main-vendor-image');
                const thumbnailsContainer = document.getElementById('vendor-thumbnails');
                const imageGallery = document.getElementById('modal-image-gallery');
                
                console.log('Main image element:', mainImage);
                console.log('Thumbnails container:', thumbnailsContainer);
                console.log('Image gallery container:', imageGallery);
                
                if (mainImage) {
                    console.log('Current main image src:', mainImage.src);
                } else {
                    console.log('❌ Main image element NOT FOUND - you may not be on vendor profile page');
                }
                
                if (thumbnailsContainer) {
                    console.log('Thumbnails container found, current content:', thumbnailsContainer.innerHTML);
                } else {
                    console.log('❌ Thumbnails container NOT FOUND - you may not be on vendor profile page');
                }
                
                // Check what page we're actually on
                const currentUrl = window.location.href;
                const currentHash = window.location.hash;
                console.log('Current URL:', currentUrl);
                console.log('Current hash:', currentHash);
                
                // Check all possible gallery-related elements
                const allGalleryElements = document.querySelectorAll('[id*="gallery"], [id*="image"], [class*="gallery"], [class*="image"]');
                console.log('All gallery-related elements found:', allGalleryElements);
                
                console.log('=== DIAGNOSTIC COMPLETE ===');
                
                // Return status
                return {
                    vendorProfilePageExists: !!vendorProfilePage,
                    vendorProfilePageVisible: vendorProfilePage && vendorProfilePage.style.display !== 'none',
                    mainImageExists: !!mainImage,
                    thumbnailsContainerExists: !!thumbnailsContainer,
                    currentUrl: currentUrl,
                    currentHash: currentHash
                };
            };

            // DIRECT ELEMENT FINDER - Find and populate ANY gallery elements on the page
            window.findAndPopulateGallery = function() {
                console.log('=== DIRECT ELEMENT FINDER ===');
                
                // Find all possible image elements
                const allImages = document.querySelectorAll('img');
                const allDivs = document.querySelectorAll('div');
                
                console.log('Found', allImages.length, 'image elements');
                console.log('Found', allDivs.length, 'div elements');
                
                // Look for any image that might be a main vendor image (placeholder or otherwise)
                let mainImageElement = null;
                let thumbnailContainer = null;
                
                // Find main image by looking for placeholder or vendor-related images (VISIBLE ONES ONLY)
                allImages.forEach((img, index) => {
                    console.log(`Image ${index}:`, img.src, 'ID:', img.id, 'Class:', img.className);
                    
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        console.log('⏭️ Skipping hidden/modal image:', img.id);
                        return;
                    }
                    
                    if (img.src.includes('placehold.co') && 
                        (img.alt.includes('Main Venue Image') || 
                         img.alt.includes('samyy') ||
                         img.alt.includes('vendor'))) {
                        console.log('🎯 VISIBLE main image found:', img);
                        mainImageElement = img;
                    }
                });
                
                // Find container by looking for gallery-related divs
                allDivs.forEach((div, index) => {
                    if (div.id.includes('gallery') || 
                        div.id.includes('thumbnail') ||
                        div.className.includes('gallery') ||
                        div.className.includes('thumbnail')) {
                        console.log('🎯 Potential thumbnail container found:', div);
                        thumbnailContainer = div;
                    }
                });
                
                // If we found elements, populate them
                if (mainImageElement) {
                    console.log('✅ Using main image element:', mainImageElement);
                    
                    // Known working Cloudinary URLs
                    const knownImages = [
                        'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                        'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                        'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png'
                    ];
                    
                    // Set main image
                    mainImageElement.src = knownImages[0];
                    console.log('<i class="fas fa-check" style="color: #28a745;"></i> Set main image to:', knownImages[0]);
                    
                    // If we found a thumbnail container, add thumbnails
                    if (thumbnailContainer) {
                        console.log('✅ Using thumbnail container:', thumbnailContainer);
                        thumbnailContainer.innerHTML = '';
                        
                        knownImages.forEach((imageUrl, index) => {
                            const thumbnailImg = document.createElement('img');
                            thumbnailImg.src = imageUrl;
                            thumbnailImg.alt = `Gallery ${index + 1}`;
                            thumbnailImg.style.width = '100px';
                            thumbnailImg.style.height = '100px';
                            thumbnailImg.style.objectFit = 'cover';
                            thumbnailImg.style.margin = '5px';
                            thumbnailImg.style.cursor = 'pointer';
                            thumbnailImg.onclick = () => {
                                mainImageElement.src = imageUrl;
                                console.log('🔄 Switched to:', imageUrl);
                            };
                            
                            thumbnailContainer.appendChild(thumbnailImg);
                        });
                        
                        console.log('✅ Added 3 thumbnails to container');
                    } else {
                        console.log('⚠️ No thumbnail container found, only main image updated');
                    }
                    
                    console.log('🎉 GALLERY POPULATION COMPLETE!');
                    return true;
                } else {
                    console.log('❌ No suitable main image element found');
                    return false;
                }
            };

            // POPULATE ALL THUMBNAILS - Replace all thumbnail placeholder images
            window.populateAllThumbnails = function() {
                console.log('=== POPULATE ALL THUMBNAILS ===');
                
                // Known working Cloudinary URLs
                const knownImages = [
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png'
                ];
                
                // Set lightbox images for navigation
                lightboxImages = knownImages;
                
                // Find ALL thumbnail placeholder images
                const allImages = document.querySelectorAll('img');
                let thumbnailCount = 0;
                let mainImageUpdated = false;
                
                allImages.forEach((img, index) => {
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        return;
                    }
                    
                    // Update main venue image
                    if (img.src.includes('placehold.co') && img.alt.includes('Main Venue Image') && !mainImageUpdated) {
                        img.src = knownImages[0];
                        // Make main image clickable to open lightbox
                        img.style.cursor = 'pointer';
                        img.onclick = () => openLightbox(0);
                        console.log('✅ Updated main venue image:', img.alt);
                        mainImageUpdated = true;
                    }
                    
                    // Update thumbnail images
                    else if (img.src.includes('placehold.co') && img.alt.includes('Thumbnail')) {
                        const thumbnailNumber = thumbnailCount % knownImages.length;
                        img.src = knownImages[thumbnailNumber];
                        
                        // FIXED: Make thumbnail clickable to ONLY open lightbox (don't change main image)
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            openLightbox(thumbnailNumber);
                            console.log('🔄 Opened lightbox at image:', thumbnailNumber);
                        };
                        
                        console.log(`✅ Updated ${img.alt} with image ${thumbnailNumber + 1}`);
                        thumbnailCount++;
                    }
                });
                
                console.log(`🎉 Updated ${mainImageUpdated ? 1 : 0} main image and ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnailCount };
            };

            // COMPLETE GALLERY SETUP - Do everything at once
            window.setupCompleteGallery = function() {
                console.log('=== COMPLETE GALLERY SETUP ===');
                
                const result = populateAllThumbnails();
                
                if (result.mainImage && result.thumbnails > 0) {
                    console.log('🎉 COMPLETE GALLERY SETUP SUCCESSFUL!');
                    console.log(`✅ Main image updated: ${result.mainImage}`);
                    console.log(`✅ Thumbnails updated: ${result.thumbnails}`);
                    console.log('🖱️ Click any thumbnail to change the main image');
                    return true;
                } else {
                    console.log('⚠️ Gallery setup incomplete');
                    console.log(`Main image: ${result.mainImage}, Thumbnails: ${result.thumbnails}`);
                    return false;
                }
            };

            // DIAGNOSTIC: Check what API is actually returning
            window.checkAPIResponse = function() {
                console.log('=== API DIAGNOSTIC ===');
                
                const urlParams = new URLSearchParams(window.location.search);
                const vendorId = urlParams.get('vendorId') || urlParams.get('id');
                const userId = urlParams.get('userId');
                
                if (!vendorId && !userId) {
                    console.log('❌ No vendor ID or user ID found in URL');
                    console.log('Current URL:', window.location.href);
                    return;
                }
                
                const apiUrl = userId ? 
                    `${API_BASE_URL}/vendors/profile?userId=${userId}` :
                    `${API_BASE_URL}/vendors/${vendorId}`;
                
                console.log('🔍 Checking API endpoint:', apiUrl);
                
                fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('📡 API Response Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📋 FULL API Response:', data);
                    
                    if (data.success) {
                        console.log('✅ API Success: true');
                        console.log('📦 Data object:', data.data);
                        
                        if (data.data && data.data.images) {
                            console.log('🖼️ Images array:', data.data.images);
                            console.log('📊 Images count:', data.data.images.length);
                            
                            if (data.data.images.length > 0) {
                                console.log('🎯 First image URL:', data.data.images[0].url);
                                console.log('🎯 All image URLs:', data.data.images.map(img => img.url));
                            } else {
                                console.log('❌ Images array is empty');
                            }
                        } else {
                            console.log('❌ No images property found in data');
                        }
                    } else {
                        console.log('❌ API Success: false');
                        console.log('Error:', data.error || data.message);
                    }
                })
                .catch(error => {
                    console.error('❌ API Call Failed:', error);
                });
            };

            // UNIVERSAL GALLERY POPULATION - Use vendor listing data that we KNOW works
            window.populateGalleryFromListingData = function() {
                console.log('=== UNIVERSAL GALLERY POPULATION ===');
                
                // Use the vendor data we KNOW exists from the vendor listing
                // From your console output, we know "Bundle Booths" has 3 images
                const knownVendorWithImages = {
                    name: 'Bundle Booths',
                    images: [
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png' },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp' },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png' }
                    ]
                };
                
                console.log('Using known vendor data:', knownVendorWithImages);
                
                // Use the working population logic
                const allImages = document.querySelectorAll('img');
                let mainImageUpdated = false;
                let thumbnailCount = 0;
                
                const imagesToUse = knownVendorWithImages.images.map(img => img.url);
                console.log('✅ Using images:', imagesToUse);
                
                // Set lightbox images for navigation
                lightboxImages = imagesToUse;
                
                allImages.forEach((img, index) => {
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        return;
                    }
                    
                    // Update main venue image
                    if (img.src.includes('placehold.co') && img.alt.includes('Main Venue Image') && !mainImageUpdated) {
                        img.src = imagesToUse[0];
                        // Make main image clickable to open lightbox
                        img.style.cursor = 'pointer';
                        img.onclick = () => openLightbox(0);
                        console.log('✅ Updated main venue image:', imagesToUse[0]);
                        mainImageUpdated = true;
                    }
                    
                    // Update thumbnail images
                    else if (img.src.includes('placehold.co') && img.alt.includes('Thumbnail')) {
                        const thumbnailNumber = thumbnailCount % imagesToUse.length;
                        img.src = imagesToUse[thumbnailNumber];
                        
                        // FIXED: Make thumbnail clickable to ONLY open lightbox (don't change main image)
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            openLightbox(thumbnailNumber);
                            console.log('🔄 Opened lightbox at image:', thumbnailNumber);
                        };
                        
                        console.log(`✅ Updated ${img.alt}:`, imagesToUse[thumbnailNumber]);
                        thumbnailCount++;
                    }
                });
                
                console.log(`🎉 Universal population complete: ${mainImageUpdated ? 1 : 0} main, ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnailCount };
            };

            // VENDOR PROFILE GALLERY POPULATION - Use vendor images array directly
            window.populateVendorProfileGallery = function(vendorData) {
                console.log('=== VENDOR PROFILE GALLERY POPULATION ===');
                console.log('Vendor data received:', vendorData);
                
                // Extract images from vendor data - now comes directly from sp_SearchVendors
                let imagesToUse = [];
                if (vendorData.images && vendorData.images.length > 0) {
                    imagesToUse = vendorData.images.map(img => img.url);
                } else if (vendorData.profile && vendorData.profile.images && vendorData.profile.images.length > 0) {
                    imagesToUse = vendorData.profile.images.map(img => img.url);
                } else {
                    console.log('❌ No images found in vendor data');
                    return { mainImage: false, thumbnails: 0 };
                }
                
                console.log('✅ Using vendor images from stored procedure:', imagesToUse);
                
                // Use the same population logic as the universal function
                const allImages = document.querySelectorAll('img');
                let mainImageUpdated = false;
                let thumbnailCount = 0;
                
                allImages.forEach((img, index) => {
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        return;
                    }
                    
                    // Update main venue image
                    if (img.src.includes('placehold.co') && img.alt.includes('Main Venue Image') && !mainImageUpdated) {
                        img.src = imagesToUse[0];
                        console.log('✅ Updated main venue image:', imagesToUse[0]);
                        mainImageUpdated = true;
                    }
                    
                    // Update thumbnail images
                    else if (img.src.includes('placehold.co') && img.alt.includes('Thumbnail')) {
                        const thumbnailNumber = thumbnailCount % imagesToUse.length;
                        img.src = imagesToUse[thumbnailNumber];
                        
                        // Make thumbnail clickable
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            const mainImg = document.querySelector('img[alt="Main Venue Image"]');
                            if (mainImg) {
                                mainImg.src = imagesToUse[thumbnailNumber];
                                console.log('🔄 Switched main image to:', imagesToUse[thumbnailNumber]);
                            }
                        };
                        
                        console.log(`✅ Updated ${img.alt}:`, imagesToUse[thumbnailNumber]);
                        thumbnailCount++;
                    }
                });
                
                console.log(`🎉 Vendor profile gallery population complete: ${mainImageUpdated ? 1 : 0} main, ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnails };
            };

            // POPULATE GALLERY FROM VENDOR OBJECT - Use images array directly from vendor listing
            window.populateGalleryFromVendorObject = function(vendor) {
                console.log('=== POPULATING GALLERY FROM VENDOR OBJECT ===');
                console.log('Vendor object:', vendor);
                
                // Extract images from vendor object (comes from sp_SearchVendors)
                let imagesToUse = [];
                if (vendor.images && vendor.images.length > 0) {
                    imagesToUse = vendor.images.map(img => img.url);
                } else if (vendor.featuredImageURL) {
                    // Fallback to featured image if available
                    imagesToUse = [vendor.featuredImageURL];
                } else {
                    console.log('❌ No images found in vendor object');
                    return { mainImage: false, thumbnails: 0 };
                }
                
                console.log('✅ Using images from vendor object:', imagesToUse);
                
                // Populate gallery images
                const allImages = document.querySelectorAll('img');
                let mainImageUpdated = false;
                let thumbnailCount = 0;
                
                // Find main image element and thumbnail container
                const mainImageElement = document.querySelector('img[alt="Main Venue Image"]');
                const thumbnailsContainer = document.getElementById('vendor-thumbnails');
                
                if (!mainImageElement || !thumbnailsContainer) {
                    console.warn('Gallery elements not found for population');
                    return { mainImage: false, thumbnails: 0 };
                }
                
                // Set main image src to first image (primary)
                mainImageElement.src = imagesToUse[0];
                console.log('<i class="fas fa-check" style="color: #28a745;"></i> Set main venue image:', imagesToUse[0]);
                mainImageUpdated = true;
                
                // Add click event to main image to open lightbox
                mainImageElement.style.cursor = 'pointer';
                mainImageElement.addEventListener('click', () => openLightbox(0));
                
                // Clear existing thumbnails
                thumbnailsContainer.innerHTML = '';
                
                // FIXED: Add thumbnails for remaining images - ONLY open lightbox, don't change main image
                for (let i = 1; i < imagesToUse.length; i++) {
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'gallery-item';
                    
                    const thumbImg = document.createElement('img');
                    thumbImg.src = imagesToUse[i];
                    thumbImg.alt = `Thumbnail ${i}`;
                    
                    // FIXED: Add click handler to ONLY open lightbox (don't change main image)
                    thumbDiv.style.cursor = 'pointer';
                    thumbDiv.addEventListener('click', () => openLightbox(i));
                    
                    thumbDiv.appendChild(thumbImg);
                    thumbnailsContainer.appendChild(thumbDiv);
                    
                    thumbnailCount++;
                    console.log(`✅ Added thumbnail ${i}:`, imagesToUse[i]);
                }
                
                console.log(`🎉 Gallery population complete: 1 main image, ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnailCount };
            };

            // GALLERY TEST FUNCTIONS - Updated for new sp_SearchVendors approach
            window.testGalleryFunctionality = function() {
                console.log('=== TESTING GALLERY FUNCTIONALITY (NEW APPROACH) ===');
                
                // Test 1: Check if functions exist
                console.log('Test 1a: populateVendorProfileGallery exists?', typeof window.populateVendorProfileGallery === 'function' ? '✅ YES' : '❌ NO');
                console.log('Test 1b: populateGalleryFromVendorObject exists?', typeof window.populateGalleryFromVendorObject === 'function' ? '✅ YES' : '❌ NO');
                
                // Test 2: Create mock vendor object (as it would come from sp_SearchVendors)
                const mockVendorObject = {
                    id: 1,
                    name: 'Test Vendor',
                    images: [
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png', isPrimary: true, displayOrder: 1 },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp', isPrimary: false, displayOrder: 2 },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png', isPrimary: false, displayOrder: 3 }
                    ],
                    featuredImageURL: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png'
                };
                
                console.log('Test 2: Testing with mock vendor object from sp_SearchVendors...');
                const result = window.populateGalleryFromVendorObject(mockVendorObject);
                console.log('Test 2 Result:', result);
                
                // Test 3: Check if images were actually updated
                const mainImages = document.querySelectorAll('img[alt*="Main Venue Image"]');
                const thumbnails = document.querySelectorAll('img[alt*="Thumbnail"]');
                
                console.log('Test 3: Found main images:', mainImages.length);
                console.log('Test 3: Found thumbnails:', thumbnails.length);
                
                let realImagesCount = 0;
                mainImages.forEach(img => {
                    if (!img.src.includes('placehold.co')) {
                        realImagesCount++;
                        console.log('✅ Main image updated:', img.src);
                    }
                });
                
                thumbnails.forEach(img => {
                    if (!img.src.includes('placehold.co')) {
                        realImagesCount++;
                        console.log('✅ Thumbnail updated:', img.src);
                    }
                });
                
                console.log(`Test 3: ${realImagesCount} images successfully updated with real URLs`);
                
                // Test 4: Test current vendor object
                console.log('Test 4: Current vendor object exists?', window.currentVendor ? '✅ YES' : '❌ NO');
                if (window.currentVendor) {
                    console.log('Test 4: Current vendor has images?', window.currentVendor.images && window.currentVendor.images.length > 0 ? '✅ YES' : '❌ NO');
                    console.log('Test 4: Current vendor image count:', window.currentVendor.images ? window.currentVendor.images.length : 0);
                }
                
                console.log('=== GALLERY TEST COMPLETE (NEW APPROACH) ===');
                return {
                    functionsExist: {
                        populateVendorProfileGallery: typeof window.populateVendorProfileGallery === 'function',
                        populateGalleryFromVendorObject: typeof window.populateGalleryFromVendorObject === 'function'
                    },
                    mockTestResult: result,
                    imagesFound: { main: mainImages.length, thumbnails: thumbnails.length },
                    realImagesCount: realImagesCount,
                    currentVendorExists: !!window.currentVendor,
                    currentVendorHasImages: window.currentVendor && window.currentVendor.images && window.currentVendor.images.length > 0
                };
            };

            // MANUAL GALLERY POPULATION TEST
            window.testGalleryWithRealData = function() {
                console.log('=== TESTING GALLERY WITH REAL API DATA ===');
                
                const API_BASE_URL = 'http://localhost:3000/api';
                const urlParams = new URLSearchParams(window.location.search);
                const vendorId = urlParams.get('vendorId') || urlParams.get('id');
                const userId = urlParams.get('userId');
                
                if (!vendorId && !userId) {
                    console.log('❌ No vendor ID or user ID in URL. Add ?userId=1 or ?vendorId=1 to test');
                    return;
                }
                
                const apiUrl = userId ? 
                    `${API_BASE_URL}/vendors/profile?userId=${userId}` :
                    `${API_BASE_URL}/vendors/${vendorId}`;
                
                console.log('🔍 Testing API call to:', apiUrl);
                
                fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('📡 API Response Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📋 API Response Data:', data);
                    
                    if (data.success && data.data) {
                        console.log('✅ API call successful');
                        console.log('🖼️ Images in response:', data.data.images);
                        
                        if (data.data.images && data.data.images.length > 0) {
                            console.log('🎯 Calling populateVendorProfileGallery...');
                            const result = populateVendorProfileGallery(data.data);
                            console.log('🎉 Gallery population result:', result);
                        } else {
                            console.log('❌ No images found in API response');
                        }
                    } else {
                        console.log('❌ API call failed or returned error');
                    }
                })
                .catch(error => {
                    console.error('❌ API call error:', error);
                    console.log('💡 Make sure your backend server is running on localhost:3000');
                });
            };

            // Initialize booking modal when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Add event listener for Book Now button
                const bookNowBtn = document.getElementById('book-now-btn');
                if (bookNowBtn) {
                    bookNowBtn.addEventListener('click', openBookingModal);
                }
                
                // Add event listener for closing booking modal
                const bookingModal = document.getElementById('booking-modal');
                if (bookingModal) {
                    bookingModal.addEventListener('click', function(e) {
                        if (e.target === bookingModal) {
                            closeBookingModal();
                        }
                    });
                }
                
                // Add event listeners for booking step navigation
                setupBookingStepNavigation();
            });
            
            function setupBookingStepNavigation() {
                // Step 1 to Step 2
                const nextToStep2Btn = document.getElementById('next-to-booking-step-2');
                if (nextToStep2Btn) {
                    nextToStep2Btn.addEventListener('click', function() {
                        if (bookingState.selectedServices.length === 0) {
                            showError('Please select at least one service category.');
                            return;
                        }
                        updateBookingStep(2);
                        // Initialize location autocomplete when entering Step 2
                        setTimeout(() => {
                            console.log('Entering Step 2 - initializing location autocomplete');
                            if (window.googleMapsLoaded || (typeof google !== 'undefined' && google.maps && google.maps.places)) {
                                initializeLocationAutocompleteNow();
                            } else {
                                console.log('Waiting for Google Maps to load...');
                                // Wait for Google Maps to load
                                const checkGoogleMaps = setInterval(() => {
                                    if (window.googleMapsLoaded || (typeof google !== 'undefined' && google.maps && google.maps.places)) {
                                        clearInterval(checkGoogleMaps);
                                        initializeLocationAutocompleteNow();
                                    }
                                }, 200);
                                
                                // Stop checking after 10 seconds
                                setTimeout(() => {
                                    clearInterval(checkGoogleMaps);
                                    console.warn('Google Maps loading timeout - autocomplete may not work');
                                }, 10000);
                            }
                        }, 100);
                    });
                }
                
                // Step 2 navigation
                const backToStep1Btn = document.getElementById('back-to-booking-step-1');
                const findVendorsBtn = document.getElementById('find-vendors-btn');
                
                if (backToStep1Btn) {
                    backToStep1Btn.addEventListener('click', () => updateBookingStep(1));
                }
                
                if (findVendorsBtn) {
                    findVendorsBtn.addEventListener('click', handleFindVendors);
                }
                
                // Step 3 navigation
                const backToStep2Btn = document.getElementById('back-to-booking-step-2');
                const sendRequestsBtn = document.getElementById('send-requests-btn');
                
                if (backToStep2Btn) {
                    backToStep2Btn.addEventListener('click', () => updateBookingStep(2));
                }
                
                if (sendRequestsBtn) {
                    sendRequestsBtn.addEventListener('click', handleSendRequests);
                }
                
                // Step 4 navigation
                const backToStep3Btn = document.getElementById('back-to-booking-step-3');
                
                if (backToStep3Btn) {
                    backToStep3Btn.addEventListener('click', () => updateBookingStep(3));
                }
                
                
                
            }

            // Step Navigation Event Handlers
            function setupStepNavigationHandlers() {
                // Step 8 Navigation Handlers
                const nextToStep9Btn = document.getElementById('next-to-step-9');
                if (nextToStep9Btn) {
                    nextToStep9Btn.addEventListener('click', async () => {
                        await handleStep8Transition();
                    });
                }

                // FAQ Form Handlers
                const addFaqBtn = document.getElementById('add-faq-btn');
                if (addFaqBtn) {
                    addFaqBtn.addEventListener('click', showFaqForm);
                }

                const addFaqItemBtn = document.getElementById('add-faq-item-btn');
                if (addFaqItemBtn) {
                    addFaqItemBtn.addEventListener('click', addFaqItem);
                }

                // Other step navigation handlers can be added here
                console.log('✅ Step navigation handlers set up');
            }

            // Handle Step 8 to Step 9 Transition
            async function handleStep8Transition() {
                try {
                    // Force save current step data (FAQ data) - override any legacy logic
                    saveCurrentStepData();
                    
                    // Ensure we're using FAQ data, not policies data
                    const step8Data = vendorSetupState.stepData.step8;
                    
                    if (!vendorSetupState.vendorProfileId) {
                        throw new Error('Vendor profile ID not found');
                    }
                    
                    // Force FAQ data structure - override any legacy policies data
                    const faqData = {
                        vendorProfileId: vendorSetupState.vendorProfileId,
                        faqs: step8Data.faqs || vendorSetupState.faqs || []
                    };
                    
                    console.log('Sending FAQ data to backend:', faqData);
                    
                    // Submit FAQ data to backend
                    const response = await fetch(`${API_BASE_URL}/vendors/setup/step8-policies`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(faqData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save FAQ data');
                    }
                    
                    const result = await response.json();
                    console.log('Step 8 FAQ data saved successfully:', result);
                    
                    // Move to next step
                    vendorSetupState.currentStep = 9;
                    showSetupStep(9);
                    
                } catch (error) {
                    console.error('Error in Step 8 transition:', error);
                    alert('Failed to save FAQ data: ' + error.message);
                }
            }

            // GLOBAL OVERRIDE: Intercept any fetch calls to step8-policies and replace policies data with FAQ data
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                // Check if this is a call to the step8-faq endpoint
                if (url && url.includes('/setup/step8-faq')) {
                    console.log('🚨 INTERCEPTED step8-faq API call');
                    console.log('Original request body:', options?.body);
                    
                    // Parse the request body
                    let requestData;
                    try {
                        requestData = JSON.parse(options?.body || '{}');
                    } catch (e) {
                        requestData = {};
                    }
                    
                    // Check if this contains policies data (legacy)
                    if (requestData.depositRequirements !== undefined || 
                        requestData.cancellationPolicy !== undefined ||
                        requestData.reschedulingPolicy !== undefined ||
                        requestData.paymentMethods !== undefined ||
                        requestData.paymentTerms !== undefined) {
                        
                        console.log('🚨 DETECTED LEGACY POLICIES DATA - REPLACING WITH FAQ DATA');
                        
                        // Get FAQ data from current state
                        const faqData = [];
                        if (vendorSetupState.faqs && vendorSetupState.faqs.length > 0) {
                            faqData.push(...vendorSetupState.faqs);
                        }
                        if (vendorSetupState.stepData.step8 && vendorSetupState.stepData.step8.faqs) {
                            faqData.push(...vendorSetupState.stepData.step8.faqs);
                        }
                        
                        // Replace with FAQ data structure
                        const newRequestData = {
                            vendorProfileId: requestData.vendorProfileId,
                            faqs: faqData
                        };
                        
                        console.log('✅ REPLACED WITH FAQ DATA:', newRequestData);
                        
                        // Update the request options
                        options = {
                            ...options,
                            body: JSON.stringify(newRequestData)
                        };
                    }
                }
                
                // Call the original fetch with potentially modified options
                return originalFetch.call(this, url, options);
            };

            // Initialize event handlers when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupStepNavigationHandlers);
            } else {
                setupStepNavigationHandlers();
            }

        });

        // ===== VENDOR SETUP IMPROVEMENTS JAVASCRIPT =====
        
        // Global variable to store configuration
        let appConfig = null;
        
        // Initialize all vendor setup improvements when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeVendorSetupImprovements();
        });

        async function initializeVendorSetupImprovements() {
            console.log('🚀 Initializing Vendor Setup Improvements...');
            
            try {
                // Set fallback configuration directly
                appConfig = {
                    googleMapsApiKey: 'AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg',
                    apiBaseUrl: 'http://localhost:3000/api'
                };
                console.log('✅ App configuration set:', appConfig);
                
                // Initialize Select2 for category dropdowns
                initializeSelect2();
                
                // Load Google Places API dynamically and then initialize
                await loadGooglePlacesAPI();
                
                // Initialize image upload handlers
                initializeImageUpload();
                
                // Initialize social media handlers
                initializeSocialMediaHandlers();
                
                // Initialize summary page functionality
                initializeSummaryPage();
                
                // Add red asterisks to all required fields
                addRequiredFieldAsterisks();
                
                console.log('✅ Vendor Setup Improvements Initialized');
            } catch (error) {
                console.error('❌ Error initializing vendor setup improvements:', error);
                // Continue with basic functionality even if some features fail
                initializeSelect2();
                initializeImageUpload();
                initializeSocialMediaHandlers();
                initializeSummaryPage();
                addRequiredFieldAsterisks();
            }
        }

        // Removed loadAppConfiguration function - no longer needed

        // Dynamically load Google Places API
        async function loadGooglePlacesAPI() {
            return new Promise((resolve, reject) => {
                if (!appConfig || !appConfig.googleMapsApiKey) {
                    console.warn('⚠️ Google Maps API key not available, skipping Google Places initialization');
                    resolve();
                    return;
                }

                // Check if Google Maps is already loaded
                if (window.google && window.google.maps) {
                    console.log('✅ Google Maps API already loaded');
                    initializeGooglePlaces();
                    resolve();
                    return;
                }

                // Google Maps API already loaded in head - just initialize
                console.log('✅ Google Maps API loaded successfully');
                setTimeout(() => {
                    initializeGooglePlaces();
                    resolve();
                }, 100);
                
                // No need to append script since it's already in head
            });
        }

        // Initialize Select2 for enhanced dropdowns
        function initializeSelect2() {
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('.select2-category').select2({
                    placeholder: 'Select categories...',
                    allowClear: true,
                    width: '100%'
                });
                console.log('✅ Select2 initialized for category dropdowns');
            } else {
                console.warn('⚠️ Select2 not available, using standard dropdowns');
            }
        }

        // Initialize Google Places Autocomplete
        function initializeGooglePlaces() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                console.log('✅ Initializing Google Places autocomplete services...');
                
                // Initialize business address autocomplete using Places API (New)
                const businessAddressField = document.getElementById('business-address');
                if (businessAddressField) {
                    console.log('Setting up business address autocomplete...');
                    const businessAutocompleteService = new google.maps.places.AutocompleteService();
                    const businessPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
                    
                    let currentBusinessRequest;
                    businessAddressField.addEventListener('input', function() {
                        const query = this.value;
                        console.log('Business address input changed:', query);
                        
                        // Clear suggestions if query is too short
                        if (query.length < 3) {
                            clearSuggestions(businessAddressField);
                            return;
                        }
                        
                        if (currentBusinessRequest) {
                            currentBusinessRequest.abort();
                        }
                        
                        console.log('Making business address autocomplete request for:', query);
                        businessAutocompleteService.getPlacePredictions({
                            input: query,
                            componentRestrictions: { country: 'ca' },
                            types: ['address']
                        }, (predictions, status) => {
                            console.log('Business address autocomplete response:', status, predictions);
                            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                                showBusinessAddressSuggestions(predictions, businessAddressField, businessPlacesService);
                            } else {
                                console.error('Business address autocomplete failed:', status);
                            }
                        });
                    });
                    
                    // Clear suggestions when clicking outside
                    document.addEventListener('click', function(e) {
                        const suggestionsContainer = businessAddressField.parentNode.querySelector('.suggestions-container');
                        const isClickInsideInput = businessAddressField.contains(e.target);
                        const isClickInsideSuggestions = suggestionsContainer && suggestionsContainer.contains(e.target);
                        
                        if (!isClickInsideInput && !isClickInsideSuggestions) {
                            clearSuggestions(businessAddressField);
                        }
                    });
                } else {
                    console.warn('Business address field not found');
                }

                // Initialize vendor address autocomplete using Places API (New)
                const vendorAddressField = document.getElementById('vendor-address');
                if (vendorAddressField) {
                    console.log('Setting up vendor address autocomplete...');
                    const vendorAutocompleteService = new google.maps.places.AutocompleteService();
                    const vendorPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
                    
                    let currentVendorRequest;
                    vendorAddressField.addEventListener('input', function() {
                        const query = this.value;
                        console.log('Vendor address input changed:', query);
                        
                        // Clear suggestions if query is too short
                        if (query.length < 3) {
                            clearSuggestions(vendorAddressField);
                            return;
                        }
                        
                        if (currentVendorRequest) {
                            currentVendorRequest.abort();
                        }
                        
                        console.log('Making vendor address autocomplete request for:', query);
                        vendorAutocompleteService.getPlacePredictions({
                            input: query,
                            componentRestrictions: { country: 'ca' },
                            types: ['address']
                        }, (predictions, status) => {
                            console.log('Vendor address autocomplete response:', status, predictions);
                            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                                showVendorAddressSuggestions(predictions, vendorAddressField, vendorPlacesService);
                            } else {
                                console.error('Vendor address autocomplete failed:', status);
                            }
                        });
                    });
                    
                    // Clear suggestions when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!vendorAddressField.contains(e.target)) {
                            clearSuggestions(vendorAddressField);
                        }
                    });
                }

                // Additional cities autocomplete using Places API (New)
                const citiesInput = document.getElementById('additional-cities-input');
                if (citiesInput && google.maps.places) {
                    const citiesAutocompleteService = new google.maps.places.AutocompleteService();
                    const citiesPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
                    
                    let currentCityRequest;
                    citiesInput.addEventListener('input', function() {
                        const query = this.value;
                        if (query.length < 2) return;
                        
                        if (currentCityRequest) {
                            currentCityRequest.abort();
                        }
                        
                        citiesAutocompleteService.getPlacePredictions({
                            input: query,
                            componentRestrictions: { country: 'ca' },
                            types: ['(cities)']
                        }, (predictions, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                                showCitySuggestions(predictions, citiesInput, citiesPlacesService);
                            }
                        });
                    });
                }
                console.log('✅ Google Places Autocomplete initialized');
            } else {
                console.warn('⚠️ Google Places API not available');
            }
        }

        // Helper functions for Places API (New) suggestions
        function showAddressSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['address_components', 'formatted_address', 'geometry']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            fillAddressFields(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showCitySuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    addCityTag(prediction.structured_formatting.main_text);
                    inputElement.value = '';
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showVendorAddressSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['address_components', 'formatted_address', 'geometry']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            fillVendorAddressFields(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showBusinessAddressSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['address_components', 'formatted_address', 'geometry']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            fillCanadianAddressFields(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showLocationSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['place_id', 'geometry', 'name', 'formatted_address']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            handleLocationSelection(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function createSuggestionsContainer(inputElement) {
            let container = inputElement.parentNode.querySelector('.suggestions-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'suggestions-container';
                container.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ccc;
                    border-top: none;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                inputElement.parentNode.style.position = 'relative';
                inputElement.parentNode.appendChild(container);
            }
            return container;
        }

        function clearSuggestions(inputElement) {
            const container = inputElement.parentNode.querySelector('.suggestions-container');
            if (container) {
                container.innerHTML = '';
            }
        }

        function handleLocationSelection(place) {
            if (place.geometry && place.geometry.location) {
                window.selectedEventLocation = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    name: place.name || place.formatted_address,
                    formatted_address: place.formatted_address
                };
                console.log('Event location selected:', window.selectedEventLocation);
            }
        }

        // Fill address fields from Google Places result
        function fillAddressFields(place) {
            const components = place.address_components;
            const cityInput = document.getElementById('business-city');
            const stateInput = document.getElementById('business-state');
            const postalInput = document.getElementById('business-postal');
            const latInput = document.getElementById('business-latitude');
            const lngInput = document.getElementById('business-longitude');

            // Clear existing values
            if (cityInput) cityInput.value = '';
            if (stateInput) stateInput.value = '';
            if (postalInput) postalInput.value = '';

            // Fill fields based on address components
            components.forEach(component => {
                const types = component.types;
                if (types.includes('locality') && cityInput) {
                    cityInput.value = component.long_name;
                } else if (types.includes('administrative_area_level_1') && stateInput) {
                    stateInput.value = component.long_name;
                } else if (types.includes('postal_code') && postalInput) {
                    postalInput.value = component.long_name;
                }
            });

            // Fill latitude and longitude
            if (place.geometry && place.geometry.location) {
                if (latInput) latInput.value = place.geometry.location.lat();
                if (lngInput) lngInput.value = place.geometry.location.lng();
            }

            console.log('✅ Address fields filled from Google Places');
        }

        // Add city tag to additional cities
        function addCityTag(cityName) {
            const selectedCitiesContainer = document.getElementById('selected-cities');
            if (!selectedCitiesContainer || !cityName) return;

            // Check if city already exists
            const existingTags = selectedCitiesContainer.querySelectorAll('.city-tag');
            for (let tag of existingTags) {
                if (tag.textContent.includes(cityName)) {
                    return; // City already added
                }
            }

            // Create city tag
            const cityTag = document.createElement('div');
            cityTag.className = 'city-tag';
            cityTag.style.cssText = `
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background-color: var(--primary);
                color: white;
                padding: 0.5rem 0.75rem;
                border-radius: 20px;
                font-size: 0.9rem;
                margin: 0.25rem;
            `;
            
            cityTag.innerHTML = `
                ${cityName}
                <button type="button" onclick="removeCityTag(this, '${cityName}')" style="
                    background: none;
                    border: none;
                    color: white;
                    cursor: pointer;
                    font-size: 1rem;
                    padding: 0;
                    margin-left: 0.25rem;
                ">×</button>
            `;

            selectedCitiesContainer.appendChild(cityTag);
            
            // Update vendor setup state
            if (typeof vendorSetupState !== 'undefined') {
                if (!vendorSetupState.selectedCities) {
                    vendorSetupState.selectedCities = [];
                }
                if (!vendorSetupState.selectedCities.includes(cityName)) {
                    vendorSetupState.selectedCities.push(cityName);
                }
            } else {
                // Fallback: create temporary storage for cities
                if (!window.tempSelectedCities) {
                    window.tempSelectedCities = [];
                }
                if (!window.tempSelectedCities.includes(cityName)) {
                    window.tempSelectedCities.push(cityName);
                }
            }
            
            console.log('✅ Added city tag:', cityName);
            if (typeof vendorSetupState !== 'undefined' && vendorSetupState.selectedCities) {
                console.log('Selected cities:', vendorSetupState.selectedCities);
            }
        }
        
        // Remove city tag function
        function removeCityTag(button, cityName) {
            // Remove from DOM
            button.parentElement.remove();
            
            // Remove from vendor setup state
            if (typeof vendorSetupState !== 'undefined' && vendorSetupState.selectedCities) {
                const index = vendorSetupState.selectedCities.indexOf(cityName);
                if (index > -1) {
                    vendorSetupState.selectedCities.splice(index, 1);
                }
                console.log('Selected cities:', vendorSetupState.selectedCities);
            }
            
            console.log('Removed city tag:', cityName);
        }

        // Initialize image upload handlers
        function initializeImageUpload() {
            // Main profile image upload
            const featuredImageInput = document.getElementById('featured-image');
            if (featuredImageInput) {
                featuredImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        displayFeaturedImagePreview(file);
                    }
                });
            }

            // Gallery images upload
            const galleryImagesInput = document.getElementById('gallery-images');
            if (galleryImagesInput) {
                galleryImagesInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        displayGalleryImagePreviews(files);
                        showSelectedImagesList(files);
                    }
                });
            }

            console.log('✅ Image upload handlers initialized');
        }

        // Display featured image preview
        function displayFeaturedImagePreview(file) {
            const previewContainer = document.getElementById('featured-image-preview');
            const previewImage = document.getElementById('featured-image-display');
            
            if (previewContainer && previewImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
                console.log('✅ Featured image preview displayed');
            }
        }

        // Display gallery image previews
        function displayGalleryImagePreviews(files) {
            const previewContainer = document.getElementById('image-preview');
            if (!previewContainer) return;

            previewContainer.innerHTML = ''; // Clear existing previews

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.style.cssText = `
                        position: relative;
                        border-radius: var(--radius);
                        overflow: hidden;
                        border: 1px solid var(--border);
                    `;

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = `
                        width: 100%;
                        height: 100px;
                        object-fit: cover;
                        display: block;
                    `;

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.style.cssText = `
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 25px;
                        height: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    removeBtn.onclick = () => imageDiv.remove();

                    imageDiv.appendChild(img);
                    imageDiv.appendChild(removeBtn);
                    previewContainer.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });

            console.log('✅ Gallery image previews displayed');
        }

        // Show selected images list
        function showSelectedImagesList(files) {
            const listContainer = document.getElementById('selected-images-list');
            const namesContainer = document.getElementById('image-names-list');
            
            if (listContainer && namesContainer) {
                const fileNames = files.map(file => file.name).join(', ');
                namesContainer.textContent = `${files.length} images selected: ${fileNames}`;
                listContainer.style.display = 'block';
                console.log('✅ Selected images list displayed');
            }
        }

        // Initialize social media handlers
        function initializeSocialMediaHandlers() {
            const socialInputs = document.querySelectorAll('[data-prefix]');
            
            socialInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    const prefix = this.getAttribute('data-prefix');
                    const value = this.value.trim();
                    
                    if (value && !value.startsWith('http')) {
                        // Store the full URL in a hidden field or data attribute
                        this.setAttribute('data-full-url', prefix + value);
                        console.log('✅ Social media URL processed:', prefix + value);
                    }
                });
            });

            console.log('✅ Social media handlers initialized');
        }

        // Initialize summary page functionality
        function initializeSummaryPage() {
            // This will be called when user reaches the summary step
            window.generateVendorSetupSummary = function() {
                const summaryContainer = document.getElementById('setup-summary-content');
                if (!summaryContainer) return;

                const summaryHTML = generateComprehensiveSummary();
                summaryContainer.innerHTML = summaryHTML;
                console.log('✅ Vendor setup summary generated');
            };
        }

        // Generate comprehensive summary of all vendor information
        function generateComprehensiveSummary() {
            const summary = [];

            // Business Basics
            summary.push('<div class="summary-section">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">📋 Business Information</h5>');
            
            const businessName = document.getElementById('business-name')?.value || 'Not provided';
            const displayName = document.getElementById('display-name')?.value || 'Not provided';
            const businessEmail = document.getElementById('business-email')?.value || 'Not provided';
            const businessPhone = document.getElementById('business-phone')?.value || 'Not provided';
            const businessDescription = document.getElementById('business-description')?.value || 'Not provided';
            const tagline = document.getElementById('tagline')?.value || 'Not provided';
            const websiteUrl = document.getElementById('website-url')?.value || 'Not provided';
            const yearsInBusiness = document.getElementById('years-in-business')?.value || 'Not provided';
            
            summary.push(`<p><strong>Business Name:</strong> ${businessName}</p>`);
            summary.push(`<p><strong>Display Name:</strong> ${displayName}</p>`);
            summary.push(`<p><strong>Business Email:</strong> ${businessEmail}</p>`);
            summary.push(`<p><strong>Business Phone:</strong> ${businessPhone}</p>`);
            summary.push(`<p><strong>Description:</strong> ${businessDescription}</p>`);
            summary.push(`<p><strong>Tagline:</strong> ${tagline}</p>`);
            summary.push(`<p><strong>Website:</strong> ${websiteUrl}</p>`);
            summary.push(`<p><strong>Years in Business:</strong> ${yearsInBusiness}</p>`);
            summary.push('</div>');

            // Categories
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-tags" style="margin-right: 0.5rem;"></i>Categories</h5>');
            
            const primaryCategory = document.getElementById('primary-category')?.value || 'Not selected';
            const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || [])
                .map(option => option.text).join(', ') || 'None selected';
            
            summary.push(`<p><strong>Primary Category:</strong> ${primaryCategory}</p>`);
            summary.push(`<p><strong>Additional Categories:</strong> ${additionalCategories}</p>`);
            summary.push('</div>');

            // Location Information
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location Information</h5>');
            
            const address = document.getElementById('business-address')?.value?.trim();
            const city = document.getElementById('business-city')?.value?.trim();
            const state = document.getElementById('business-state')?.value?.trim();
            const postal = document.getElementById('business-postal')?.value?.trim();
            const country = document.getElementById('business-country')?.value || 'Canada';
            
            if (address || city || state || postal) {
                summary.push(`<p><strong>Physical Office:</strong> Yes</p>`);
                summary.push(`<p><strong>Address:</strong> ${address || 'Not provided'}</p>`);
                summary.push(`<p><strong>City:</strong> ${city || 'Not provided'}</p>`);
                summary.push(`<p><strong>Province:</strong> ${state || 'Not provided'}</p>`);
                summary.push(`<p><strong>Postal Code:</strong> ${postal || 'Not provided'}</p>`);
                summary.push(`<p><strong>Country:</strong> ${country}</p>`);
            } else {
                summary.push(`<p><strong>Physical Office:</strong> No physical office location provided</p>`);
            }
            
            // Service Areas
            const additionalCities = Array.from(document.querySelectorAll('#selected-cities .city-tag'))
                .map(tag => tag.textContent.replace('×', '').trim()).join(', ') || 'None specified';
            summary.push(`<p><strong>Service Areas:</strong> ${additionalCities}</p>`);
            summary.push('</div>');

            // Services & Packages
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Services & Packages</h5>');
            
            // Get services from the services list
            const servicesList = document.querySelectorAll('#services-list .service-item');
            if (servicesList.length > 0) {
                summary.push('<p><strong>Services Offered:</strong></p>');
                summary.push('<ul style="margin-left: 1rem;">');
                servicesList.forEach(serviceItem => {
                    const serviceName = serviceItem.querySelector('.service-name')?.textContent || 'Unnamed Service';
                    const servicePrice = serviceItem.querySelector('.service-price')?.textContent || 'Price not set';
                    summary.push(`<li>${serviceName} - ${servicePrice}</li>`);
                });
                summary.push('</ul>');
            } else {
                summary.push('<p><strong>Services:</strong> No services added yet</p>');
            }
            summary.push('</div>');

            // Business Hours
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">🕒 Business Hours</h5>');
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            days.forEach((day, index) => {
                const availableCheckbox = document.getElementById(`available-${index}`);
                const startTime = document.getElementById(`start-time-${index}`)?.value;
                const endTime = document.getElementById(`end-time-${index}`)?.value;
                
                if (availableCheckbox?.checked && startTime && endTime) {
                    summary.push(`<p><strong>${day}:</strong> ${formatTime(startTime)} - ${formatTime(endTime)}</p>`);
                } else {
                    summary.push(`<p><strong>${day}:</strong> Closed</p>`);
                }
            });
            
            // Booking preferences
            const acceptingBookings = document.getElementById('accepting-bookings')?.checked;
            const leadTime = document.getElementById('lead-time')?.value || 'Not specified';
            summary.push(`<p><strong>Accepting New Bookings:</strong> ${acceptingBookings ? 'Yes' : 'No'}</p>`);
            summary.push(`<p><strong>Minimum Lead Time:</strong> ${leadTime}</p>`);
            summary.push('</div>');

            // Gallery & Media
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">📸 Gallery & Media</h5>');
            
            const featuredImage = document.getElementById('featured-image')?.files?.length > 0 ? 'Featured image uploaded' : 'No featured image';
            const galleryImages = document.getElementById('gallery-images')?.files?.length || 0;
            
            summary.push(`<p><strong>Featured Image:</strong> ${featuredImage}</p>`);
            summary.push(`<p><strong>Gallery Images:</strong> ${galleryImages} image(s) uploaded</p>`);
            summary.push('</div>');

            // Social Media
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">🌐 Social Media & Links</h5>');
            
            const socialPlatforms = [
                { id: 'social-facebook', name: 'Facebook', prefix: 'https://facebook.com/' },
                { id: 'social-instagram', name: 'Instagram', prefix: 'https://instagram.com/' },
                { id: 'social-twitter', name: 'Twitter', prefix: 'https://twitter.com/' },
                { id: 'social-linkedin', name: 'LinkedIn', prefix: 'https://linkedin.com/company/' },
                { id: 'social-youtube', name: 'YouTube', prefix: 'https://youtube.com/' },
                { id: 'social-tiktok', name: 'TikTok', prefix: 'https://tiktok.com/@' }
            ];
            
            let hasSocialMedia = false;
            socialPlatforms.forEach(platform => {
                const input = document.getElementById(platform.id);
                const value = input?.value?.trim();
                if (value) {
                    const fullUrl = value.startsWith('http') ? value : platform.prefix + value;
                    summary.push(`<p><strong>${platform.name}:</strong> <a href="${fullUrl}" target="_blank">${fullUrl}</a></p>`);
                    hasSocialMedia = true;
                }
            });
            
            const bookingLink = document.getElementById('booking-link')?.value?.trim();
            if (bookingLink) {
                summary.push(`<p><strong>Online Booking Link:</strong> <a href="${bookingLink}" target="_blank">${bookingLink}</a></p>`);
            }
            
            if (!hasSocialMedia && !bookingLink) {
                summary.push('<p>No social media or professional links provided</p>');
            }
            summary.push('</div>');

            // FAQ Section
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">❓ FAQ Section</h5>');
            
            const faqsList = document.querySelectorAll('#faqs-list .faq-item');
            if (faqsList.length > 0) {
                summary.push('<div style="margin-left: 1rem;">');
                faqsList.forEach((faqItem, index) => {
                    const question = faqItem.querySelector('.faq-question')?.textContent || 'Question not found';
                    const answer = faqItem.querySelector('.faq-answer')?.textContent || 'Answer not found';
                    summary.push(`<p><strong>Q${index + 1}:</strong> ${question}</p>`);
                    summary.push(`<p><strong>A:</strong> ${answer}</p>`);
                    if (index < faqsList.length - 1) summary.push('<hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">');
                });
                summary.push('</div>');
            } else {
                summary.push('<p>No FAQs added yet</p>');
            }
            summary.push('</div>');

            return summary.join('');
        }

        // Format time for display (improved)
        function formatTime(timeString) {
            if (!timeString) return '';
            try {
                const [hours, minutes] = timeString.split(':');
                const hour = parseInt(hours, 10);
                const min = parseInt(minutes, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12;
                const displayMinutes = min.toString().padStart(2, '0');
                return `${displayHour}:${displayMinutes} ${ampm}`;
            } catch (error) {
                console.error('Error formatting time:', error);
                return timeString;
            }
        }

        // Add red asterisks to required fields
        function addRequiredFieldAsterisks() {
            const requiredFields = document.querySelectorAll('input[required], textarea[required], select[required]');
            
            requiredFields.forEach(field => {
                const label = document.querySelector(`label[for="${field.id}"]`);
                if (label && !label.innerHTML.includes('*')) {
                    // Check if asterisk is already added
                    if (!label.innerHTML.includes('<span style="color: red;">*</span>')) {
                        label.innerHTML += ' <span style="color: red;">*</span>';
                    }
                }
            });
            
            console.log('✅ Required field asterisks added');
        }

        // Override the existing step navigation to include summary generation
        const originalShowSetupStep = window.showSetupStep;
        if (originalShowSetupStep) {
            window.showSetupStep = function(stepNumber) {
                originalShowSetupStep(stepNumber);
                
                // If moving to summary step, generate the summary
                if (stepNumber === 9) {
                    setTimeout(() => {
                        if (window.generateVendorSetupSummary) {
                            window.generateVendorSetupSummary();
                        }
                    }, 100);
                }
            };
        }

        // Initialize country selection for Canadian addresses only
        document.addEventListener('DOMContentLoaded', function() {
            const businessCountrySelect = document.getElementById('business-country');
            
            // Ensure country is always set to Canada
            if (businessCountrySelect) {
                businessCountrySelect.value = 'Canada';
                businessCountrySelect.readOnly = true; // Prevent changing
            }
        });
        
        // Fill address fields from Google Places result (Canadian format)
        function fillCanadianAddressFields(place) {
            const addressComponents = place.address_components;
            let streetNumber = '';
            let route = '';
            let city = '';
            let province = '';
            let postalCode = '';
            
            addressComponents.forEach(component => {
                const types = component.types;
                
                if (types.includes('street_number')) {
                    streetNumber = component.long_name;
                } else if (types.includes('route')) {
                    route = component.long_name;
                } else if (types.includes('locality')) {
                    city = component.long_name;
                } else if (types.includes('administrative_area_level_1')) {
                    province = component.short_name; // Use short name for provinces (ON, BC, etc.)
                } else if (types.includes('postal_code')) {
                    postalCode = component.long_name;
                } else if (types.includes('country')) {
                    // Auto-populate country from Google Places (should always be Canada)
                    const countryInput = document.getElementById('business-country');
                    if (countryInput && component.long_name === 'Canada') {
                        countryInput.value = 'Canada';
                    }
                }
            });
            
            // Fill the form fields
            const fullAddress = `${streetNumber} ${route}`.trim();
            if (fullAddress) {
                document.getElementById('business-address').value = fullAddress;
            }
            
            if (city) {
                document.getElementById('business-city').value = city;
            }
            
            if (province) {
                document.getElementById('business-state').value = province;
            }
            
            if (postalCode) {
                document.getElementById('business-postal').value = postalCode;
            }
            
            console.log('✅ Canadian address fields filled:', {
                address: fullAddress,
                city: city,
                province: province,
                postalCode: postalCode
            });
        }

        // Fill vendor address fields from Google Places result (Canadian format)
        function fillVendorAddressFields(place) {
            const addressComponents = place.address_components;
            let streetNumber = '';
            let route = '';
            let city = '';
            let province = '';
            let postalCode = '';
            
            addressComponents.forEach(component => {
                const types = component.types;
                
                if (types.includes('street_number')) {
                    streetNumber = component.long_name;
                } else if (types.includes('route')) {
                    route = component.long_name;
                } else if (types.includes('locality')) {
                    city = component.long_name;
                } else if (types.includes('administrative_area_level_1')) {
                    province = component.short_name; // Use short name for provinces (ON, BC, etc.)
                } else if (types.includes('postal_code')) {
                    postalCode = component.long_name;
                } else if (types.includes('country')) {
                    // Auto-populate country from Google Places (should always be Canada)
                    const countryInput = document.getElementById('vendor-country');
                    if (countryInput && component.long_name === 'Canada') {
                        countryInput.value = 'Canada';
                    }
                }
            });
            
            // Fill the vendor form fields
            const fullAddress = `${streetNumber} ${route}`.trim();
            if (fullAddress) {
                document.getElementById('vendor-address').value = fullAddress;
            }
            
            if (city) {
                document.getElementById('vendor-city').value = city;
            }
            
            if (province) {
                document.getElementById('vendor-state').value = province;
            }
            
            if (postalCode) {
                const postalInput = document.getElementById('vendor-postalCode');
                if (postalInput) {
                    postalInput.value = postalCode;
                }
            }
            
            console.log('✅ Vendor address fields filled:', {
                address: fullAddress,
                city: city,
                province: province,
                postalCode: postalCode
            });
        }

        // SIMPLE SERVICE PREVIEW FUNCTION - GUARANTEED TO WORK
        function addServiceNow() {
            const serviceName = document.getElementById('service-name')?.value?.trim() || '';
            const serviceDescription = document.getElementById('service-description')?.value?.trim() || '';
            const servicePrice = document.getElementById('service-price')?.value || '';
            const serviceDuration = document.getElementById('service-duration')?.value || '60';

            if (!serviceName || !serviceDescription || !servicePrice) {
                alert('Please fill in all required service fields.');
                return;
            }

            // Create service preview HTML directly
            const servicePreview = `
                <div class="service-item" style="
                    background-color: white;
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    padding: 1rem;
                    margin-bottom: 0.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                ">
                    <div style="flex: 1;">
                        <h6 style="margin: 0 0 0.5rem 0; color: var(--primary); font-weight: 600;">${serviceName}</h6>
                        <p style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">${serviceDescription}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-light);">
                            <span><strong>Price:</strong> $${parseFloat(servicePrice).toFixed(2)}</span>
                            <span><strong>Duration:</strong> ${serviceDuration} min</span>
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" style="
                        background: var(--accent);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                        font-size: 0.8rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-left: 0.5rem;
                    " title="Remove service">×</button>
                </div>
            `;

            // Add to services list - create container if it doesn't exist
            let servicesList = document.getElementById('services-list');
            if (!servicesList) {
                // Create the services list container if it doesn't exist
                servicesList = document.createElement('div');
                servicesList.id = 'services-list';
                servicesList.style.cssText = `
                    margin-top: 1rem;
                    padding: 1rem;
                    background-color: #f8fafc;
                    border-radius: var(--radius);
                    border: 1px solid var(--border);
                `;
                
                // Try to find a good place to insert it
                const serviceForm = document.querySelector('[data-service-form]') || 
                                  document.querySelector('.service-form') ||
                                  document.querySelector('#service-name')?.closest('form') ||
                                  document.querySelector('#service-name')?.parentElement?.parentElement;
                
                if (serviceForm) {
                    serviceForm.appendChild(servicesList);
                } else {
                    // Fallback: append to body with a header
                    const header = document.createElement('h4');
                    header.textContent = 'Added Services:';
                    header.style.cssText = 'margin: 1rem 0 0.5rem 0; color: var(--primary);';
                    document.body.appendChild(header);
                    document.body.appendChild(servicesList);
                }
            }
            
            if (servicesList) {
                servicesList.innerHTML += servicePreview;
            }

            // Clear form
            const nameField = document.getElementById('service-name');
            const descField = document.getElementById('service-description');
            const priceField = document.getElementById('service-price');
            const durationField = document.getElementById('service-duration');
            
            if (nameField) nameField.value = '';
            if (descField) descField.value = '';
            if (priceField) priceField.value = '';
            if (durationField) durationField.value = '';

            console.log('✅ Service added successfully!');
        }

        console.log('🎉 All Vendor Setup Improvements JavaScript Loaded Successfully!');

        // Google Maps and Vendor Location Functionality
        let vendorMap = null;
        let eventLocationMarker = null;
        let vendorMarkers = [];
        let geocoder = null;
        let currentVendorSections = [];

        // Global flag to track Google Maps availability
        let googleMapsLoaded = false;
        let locationAutocomplete = null;

        // Initialize Google Maps callback - matching the test file
        window.initMap = function() {
            console.log('🚀 Google Maps API callback triggered');
            
            try {
                if (typeof google === 'undefined' || !google.maps) {
                    console.error('❌ Google object not available in initMap callback');
                    return;
                }
                
                console.log('✅ Google Maps API loaded successfully');
                googleMapsLoaded = true;
                window.googleMapsLoaded = true;
                geocoder = new google.maps.Geocoder();
                
                // Initialize location autocomplete if input exists
                initializeLocationAutocompleteNow();
                
                console.log('✅ Google Maps API fully initialized');
            } catch (error) {
                console.error('❌ Error in initMap callback:', error);
            }
        };
        
        // Consolidated location autocomplete initialization
        function initializeLocationAutocompleteNow() {
            const locationInput = document.getElementById('event-location');
            if (!locationInput) {
                console.log('Event location input not found');
                return;
            }
            
            if (!window.google || !window.google.maps || !window.google.maps.places) {
                console.log('Google Places API not available yet');
                return;
            }
            
            // Clear any existing autocomplete
            if (locationAutocomplete) {
                google.maps.event.clearInstanceListeners(locationAutocomplete);
            }
            
            console.log('Initializing location autocomplete...');
            
            // Use Places API (New) for location autocomplete
            const locationAutocompleteService = new google.maps.places.AutocompleteService();
            const locationPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
            
            let currentLocationRequest;
            locationInput.addEventListener('input', function() {
                const query = this.value;
                if (query.length < 3) return;
                
                if (currentLocationRequest) {
                    currentLocationRequest.abort();
                }
                
                locationAutocompleteService.getPlacePredictions({
                    input: query,
                    componentRestrictions: { country: 'ca' },
                    types: ['address']
                }, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                        showLocationSuggestions(predictions, locationInput, locationPlacesService);
                    }
                });
            });
            
            locationAutocomplete.addListener('place_changed', function() {
                const place = locationAutocomplete.getPlace();
                
                if (!place.geometry) {
                    console.log('No geometry found for place');
                    return;
                }
                
                console.log('Place selected:', place.formatted_address);
                
                // Update the input field with the selected address
                locationInput.value = place.formatted_address;
                
                // Store the selected location globally
                window.selectedEventLocation = {
                    address: place.formatted_address,
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    place: place
                };
                
                console.log('✅ Event location stored:', window.selectedEventLocation);
                
                // Update the input field display value if needed
                if (place.formatted_address && locationInput.value !== place.formatted_address) {
                    locationInput.value = place.formatted_address;
                }
            });
            
            console.log('✅ Location autocomplete initialized successfully');
        }

        // Show map fallback when Maps API fails
        function showMapFallback() {
            console.log('🔍 Showing map fallback - checking Google Maps status');
            console.log('Google object available:', typeof google !== 'undefined');
            console.log('Google Maps available:', typeof google !== 'undefined' && google.maps);
            console.log('GoogleMapsLoaded flag:', googleMapsLoaded);
            
            const mapContainer = document.getElementById('vendor-map-container');
            const mapElement = document.getElementById('vendor-map');
            
            if (mapContainer && mapElement) {
                mapContainer.style.display = 'block';
                mapElement.innerHTML = `
                    <div style="
                        height: 400px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
                        border-radius: 12px;
                        border: 2px dashed #3498db;
                        flex-direction: column;
                        gap: 1rem;
                        text-align: center;
                        padding: 2rem;
                    ">
                        <div style="font-size: 3rem; color: #3498db;">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div>
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--text);">Map View Unavailable</h5>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                                Debugging Google Maps API loading...<br>
                                Check browser console for detailed error messages.
                            </p>
                        </div>
                        <div style="background: #fff3cd; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.8rem; color: #856404;">
                            Google: ${typeof google !== 'undefined' ? '✅' : '❌'} | 
                            Maps: ${typeof google !== 'undefined' && google.maps ? '✅' : '❌'} | 
                            Loaded: ${googleMapsLoaded ? '✅' : '❌'}
                        </div>
                    </div>
                `;
                
                // Hide map controls since map is not functional
                const mapControls = mapContainer.querySelector('.map-controls');
                if (mapControls) {
                    mapControls.style.display = 'none';
                }
            }
        }

        // Initialize vendor map with event location and vendors
        async function initializeVendorMap(vendorSections) {
            console.log('🗺️ Initializing vendor map...');
            console.log('Google available:', typeof google !== 'undefined');
            console.log('Google Maps available:', typeof google !== 'undefined' && google.maps);
            console.log('GoogleMapsLoaded flag:', googleMapsLoaded);
            
            try {
                currentVendorSections = vendorSections;
                const mapContainer = document.getElementById('vendor-map-container');
                const mapElement = document.getElementById('vendor-map');
                
                if (!mapElement) {
                    console.warn('❌ Map element not found');
                    showMapFallback();
                    return;
                }

                // Check if Google Maps is available - but don't fail immediately
                if (typeof google === 'undefined' || !google.maps) {
                    console.log('⚠️ Google Maps not immediately available, checking if initMap was called...');
                    console.log('GoogleMapsLoaded flag:', googleMapsLoaded);
                    
                    // If Google Maps hasn't loaded yet, show the map anyway and let it load
                    if (!googleMapsLoaded) {
                        console.log('📍 Showing map container and waiting for Google Maps to load...');
                        mapContainer.style.display = 'block';
                        mapElement.innerHTML = `
                            <div style="
                                height: 400px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                background: #f8f9fa;
                                border-radius: 12px;
                                flex-direction: column;
                                gap: 1rem;
                            ">
                                <div style="font-size: 2rem;">🗺️</div>
                                <div style="color: #666;">Loading map...</div>
                            </div>
                        `;
                        
                        // Try again in 2 seconds
                        setTimeout(() => {
                            if (typeof google !== 'undefined' && google.maps) {
                                console.log('✅ Google Maps loaded, reinitializing...');
                                initializeVendorMap(vendorSections);
                            } else {
                                console.warn('❌ Google Maps still not available after timeout');
                                showMapFallback();
                            }
                        }, 2000);
                        return;
                    } else {
                        showMapFallback();
                        return;
                    }
                }

                // Show map container
                mapContainer.style.display = 'block';
                console.log('📍 Map container shown, initializing map...');

                // Get event location coordinates - prioritize stored coordinates from autocomplete
                let eventCoords = null;
                
                if (window.selectedEventLocation && window.selectedEventLocation.lat && window.selectedEventLocation.lng) {
                    // Use coordinates from autocomplete selection
                    eventCoords = {
                        lat: window.selectedEventLocation.lat,
                        lng: window.selectedEventLocation.lng
                    };
                    console.log('Using stored event location coordinates:', eventCoords);
                } else if (window.selectedEventLocation?.address && geocoder) {
                    // Fallback to geocoding if no stored coordinates
                    try {
                        console.log('Geocoding event location:', window.selectedEventLocation.address);
                        const geocodeResult = await geocodeAddress(window.selectedEventLocation.address);
                        eventCoords = geocodeResult;
                    } catch (error) {
                        console.warn('Could not geocode event location:', error);
                        // Default to Toronto if geocoding fails
                        eventCoords = { lat: 43.6532, lng: -79.3832 };
                    }
                } else {
                    // Default to Toronto
                    console.log('Using default Toronto coordinates');
                    eventCoords = { lat: 43.6532, lng: -79.3832 };
                }

                // Initialize map centered on event location
                console.log('🗺️ Creating Google Map with center:', eventCoords);
                vendorMap = new google.maps.Map(mapElement, {
                    center: eventCoords,
                    zoom: 12,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ],
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true
                });
                console.log('✅ Google Map created successfully');

                // Store original vendor data for reset functionality
                window.bookingState.originalVendorSections = [...vendorSections];
                
                // Calculate initial bounds for all vendors (AC1)
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(eventCoords); // Include event location
                
                // Add vendor coordinates to bounds calculation
                const allVendors = vendorSections.flatMap(section => section.vendors);
                allVendors.forEach(vendor => {
                    if (vendor.coordinates) {
                        bounds.extend(new google.maps.LatLng(vendor.coordinates.lat, vendor.coordinates.lng));
                    }
                });
                
                // Store initial bounds for reset functionality
                window.bookingState.initialMapBounds = bounds;

                // Add event location marker with custom icon
                eventLocationMarker = new google.maps.Marker({
                    position: eventCoords,
                    map: vendorMap,
                    title: `Event Location: ${window.selectedEventLocation?.address || 'Your Event'}`,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#e74c3c">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40),
                        anchor: new google.maps.Point(20, 40)
                    }
                });

                // Add event location info window
                const eventInfoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 0.5rem;">
                            <h6 style="margin: 0 0 0.5rem 0; color: #e74c3c;">
                                <i class="fas fa-map-marker-alt"></i> Event Location
                            </h6>
                            <p style="margin: 0; font-size: 0.9rem;">${window.selectedEventLocation?.address || 'Event Location'}</p>
                        </div>
                    `
                });

                eventLocationMarker.addListener('click', () => {
                    eventInfoWindow.open(vendorMap, eventLocationMarker);
                });

                // DISABLED: Add vendor markers with distance calculation - CAUSING MARKER BOUNCING
                // await addVendorMarkers(vendorSections, eventCoords);
                
                // ADD VENDOR MARKERS FROM SEARCH-BY-SERVICES API
                console.log('🎯 Adding vendor markers after map initialization');
                if (allVendors.length > 0) {
                    // Create vendor markers directly here since state is not available in this context
                    vendorMarkers = []; // Clear existing markers
                    
                    allVendors.forEach(vendor => {
                        // Get coordinates directly from vendor data
                        const lat = parseFloat(vendor.Latitude);
                        const lng = parseFloat(vendor.Longitude);

                        console.log(`🔍 Processing vendor: ${vendor.BusinessName}, Lat: ${lat}, Lng: ${lng}`);

                        // Skip vendors without valid coordinates
                        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                            console.warn('❌ Skipping vendor with invalid coordinates:', vendor.BusinessName, { lat, lng });
                            return;
                        }

                        console.log(`📍 Creating marker for ${vendor.BusinessName} at ${lat}, ${lng}`);

                        const marker = new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: vendorMap,
                            title: vendor.BusinessName,
                            animation: google.maps.Animation.DROP,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#3498db',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });

                        // Store vendor data with marker for selection tracking
                        marker.vendorData = vendor;
                        vendorMarkers.push(marker);

                        // Add click event to show vendor info
                        marker.addListener('click', () => {
                            console.log(`🖱️ Clicked on vendor: ${vendor.BusinessName} (ID: ${vendor.VendorProfileID})`);
                            // You can add vendor selection logic here
                        });
                    });

                    console.log(`✅ Created ${vendorMarkers.length} vendor markers from search-by-services API`);
                }

                // AC1: Fit map to show all vendors and event location
                if (allVendors.length > 0) {
                    vendorMap.fitBounds(bounds);
                    // Ensure minimum zoom level
                    google.maps.event.addListenerOnce(vendorMap, 'bounds_changed', () => {
                        if (vendorMap.getZoom() > 15) {
                            vendorMap.setZoom(15);
                        }
                    });
                }

                // Set up map controls
                setupMapControls(eventCoords);

                // DISABLED: AC2 & AC4: Add dynamic map functionality - CAUSING MARKER BOUNCING
                // addBookingMapMovementListeners();

                // DISABLED: AC3: Add loading indicator - NOT NEEDED
                // addBookingMapLoadingIndicator();

                // DISABLED: AC6: Add reset button - NOT NEEDED
                // addBookingResetSearchButton();

            } catch (error) {
                console.error('❌ Error initializing vendor map:', error);
                console.error('Error details:', error.message, error.stack);
                showMapFallback();
            }
        }

        // Geocode address to coordinates
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                if (!geocoder) {
                    reject(new Error('Geocoder not available'));
                    return;
                }

                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else {
                        reject(new Error(`Geocoding failed: ${status}`));
                    }
                });
            });
        }

        // Add vendor markers to map
        async function addVendorMarkers(vendorSections, eventCoords) {
            // Clear existing markers
            vendorMarkers.forEach(marker => marker.setMap(null));
            vendorMarkers = [];

            const allVendors = vendorSections.flatMap(section => 
                section.vendors.map(vendor => ({
                    ...vendor,
                    serviceCategory: section.category,
                    serviceName: section.service.name
                }))
            );

            for (const vendor of allVendors) {
                try {
                    // Generate random coordinates near the event location for demo
                    // In production, you'd use actual vendor addresses
                    const vendorCoords = generateNearbyCoordinates(eventCoords, Math.random() * 10 + 1);
                    
                    // Calculate distance
                    const distance = calculateDistance(eventCoords, vendorCoords);
                    vendor.distance = distance;
                    vendor.coordinates = vendorCoords;

                    // Get category-specific icon
                    const categoryIcon = getCategoryIcon(vendor.serviceCategory || vendor.category);
                    
                    // Create vendor marker with category-specific icon
                    const marker = new google.maps.Marker({
                        position: vendorCoords,
                        map: vendorMap,
                        title: `${vendor.businessName || vendor.BusinessName} - ${distance.toFixed(1)}km away`,
                        icon: {
                            path: categoryIcon.path,
                            scale: categoryIcon.scale,
                            fillColor: categoryIcon.fillColor,
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                    
                    // Store vendor data on marker for later reference
                    marker.vendorData = vendor;

                    // Create info window for hover
                    const hoverInfoWindow = new google.maps.InfoWindow({
                        content: createVendorHoverContent(vendor, distance)
                    });

                    // Create detailed info window for click
                    const clickInfoWindow = new google.maps.InfoWindow({
                        content: createVendorInfoWindowContent(vendor)
                    });

                    // Add marker hover events
                    marker.addListener('mouseover', function() {
                        hoverInfoWindow.open(vendorMap, marker);
                        const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
                        highlightVendorCard(vendorId, true);
                    });
                    
                    marker.addListener('mouseout', function() {
                        hoverInfoWindow.close();
                        const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
                        highlightVendorCard(vendorId, false);
                    });
                    
                    marker.addListener('click', function() {
                        // Close hover info window
                        hoverInfoWindow.close();
                        
                        // Close other click info windows
                        vendorMarkers.forEach(m => {
                            if (m.clickInfoWindow) m.clickInfoWindow.close();
                        });
                        
                        // Open click info window
                        clickInfoWindow.open(vendorMap, marker);
                        
                        // Scroll to and highlight corresponding card
                        scrollToVendorCard(vendor.VendorProfileID || vendor.vendorProfileId || vendor.id);
                    });

                    marker.hoverInfoWindow = hoverInfoWindow;
                    marker.clickInfoWindow = clickInfoWindow;
                    marker.vendorData = vendor;
                    vendorMarkers.push(marker);

                } catch (error) {
                    console.warn(`Could not add marker for vendor ${vendor.businessName}:`, error);
                }
            }

            // Sort vendors by distance for the cards
            allVendors.sort((a, b) => (a.distance || 999) - (b.distance || 999));
        }

        // Function to highlight vendor card on marker hover
        function highlightVendorCard(vendorId, highlight) {
            const vendorCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
            if (vendorCard) {
                if (highlight) {
                    vendorCard.style.transform = 'scale(1.02)';
                    vendorCard.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                    vendorCard.style.border = '2px solid #10b981';
                    vendorCard.style.transition = 'all 0.2s ease';
                    
                    // Scroll card into view if not visible
                    vendorCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    vendorCard.style.transform = '';
                    vendorCard.style.boxShadow = '';
                    vendorCard.style.border = '';
                }
            }
        }
        
        // Function to highlight map marker on vendor card hover
        function highlightMapMarker(vendorId, highlight) {
            if (!vendorMarkers || vendorMarkers.length === 0) return;
            
            const marker = vendorMarkers.find(m => {
                const markerId = m.vendorData?.VendorProfileID || m.vendorData?.vendorProfileId || m.vendorData?.id;
                return markerId === vendorId || String(markerId) === String(vendorId);
            });
            
            if (marker) {
                const categoryIcon = getCategoryIcon(marker.vendorData?.serviceCategory || marker.vendorData?.category);
                const isSelected = window.bookingState?.selectedVendors?.some(v => v.vendorId === vendorId) || false;
                
                if (highlight) {
                    // Highlight marker with pulsing effect
                    marker.setIcon({
                        path: categoryIcon.path,
                        scale: categoryIcon.scale * 1.3, // Make it bigger
                        fillColor: '#10b981', // Green highlight
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    });
                    
                    // Add animation by changing the marker slightly
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                        if (marker.getAnimation() !== null) {
                            marker.setAnimation(null);
                        }
                    }, 1000);
                } else {
                    // Reset to original state
                    marker.setIcon({
                        path: categoryIcon.path,
                        scale: categoryIcon.scale,
                        fillColor: isSelected ? '#10b981' : categoryIcon.fillColor,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: isSelected ? 3 : 2
                    });
                    marker.setAnimation(null);
                }
            }
        }
        
        // Function to get category-specific icon
        function getCategoryIcon(category) {
            const categoryIcons = {
                'Photography': {
                    path: 'M12 2C13.1 2 14 2.9 14 4V6H17C18.1 6 19 6.9 19 8V18C19 19.1 18.1 20 17 20H7C5.9 20 5 19.1 5 18V8C5 6.9 5.9 6 7 6H10V4C10 2.9 10.9 2 12 2M12 7C9.24 7 7 9.24 7 12S9.24 17 12 17 17 14.76 17 12 14.76 7 12 7M12 9C13.66 9 15 10.34 15 12S13.66 15 12 15 9 13.66 9 12 10.34 9 12 9Z',
                    fillColor: '#e74c3c',
                    scale: 0.8
                },
                'Catering': {
                    path: 'M12,2A2,2 0 0,1 14,4V8H22V10H14.82L14,22H10L9.18,10H2V8H10V4A2,2 0 0,1 12,2M11,4V8H13V4H11Z',
                    fillColor: '#f39c12',
                    scale: 0.8
                },
                'Music': {
                    path: 'M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z',
                    fillColor: '#9b59b6',
                    scale: 0.8
                },
                'Decoration': {
                    path: 'M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V19A2,2 0 0,0 5,21H11V19H5V3H13V9H21Z',
                    fillColor: '#e91e63',
                    scale: 0.8
                },
                'Venue': {
                    path: 'M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z',
                    fillColor: '#3498db',
                    scale: 0.8
                },
                'default': {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#3498db',
                    scale: 10
                }
            };
            
            return categoryIcons[category] || categoryIcons['default'];
        }
        
        // Generate nearby coordinates for demo purposes
        function generateNearbyCoordinates(center, radiusKm) {
            const earthRadius = 6371; // Earth's radius in km
            const lat1 = center.lat * Math.PI / 180;
            const lng1 = center.lng * Math.PI / 180;
            
            const bearing = Math.random() * 2 * Math.PI;
            const distance = Math.random() * radiusKm;
            
            const lat2 = Math.asin(
                Math.sin(lat1) * Math.cos(distance / earthRadius) +
                Math.cos(lat1) * Math.sin(distance / earthRadius) * Math.cos(bearing)
            );
            
            const lng2 = lng1 + Math.atan2(
                Math.sin(bearing) * Math.sin(distance / earthRadius) * Math.cos(lat1),
                Math.cos(distance / earthRadius) - Math.sin(lat1) * Math.sin(lat2)
            );
            
            return {
                lat: lat2 * 180 / Math.PI,
                lng: lng2 * 180 / Math.PI
            };
        }

        // Calculate distance between two coordinates
        function calculateDistance(coord1, coord2) {
            const R = 6371; // Earth's radius in km
            const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
            const dLng = (coord2.lng - coord1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Create hover tooltip content for vendor markers
        function createVendorHoverContent(vendor, distance) {
            const businessName = vendor.BusinessName || vendor.businessName || 'Unknown Business';
            
            // Get service name from multiple possible sources
            let serviceName = 'Service Available';
            if (vendor.services && vendor.services[0]?.ServiceName) {
                serviceName = vendor.services[0].ServiceName;
            } else if (vendor.MatchingServiceNames && Array.isArray(vendor.MatchingServiceNames)) {
                serviceName = vendor.MatchingServiceNames[0];
            } else if (vendor.MatchingServiceNames && typeof vendor.MatchingServiceNames === 'string') {
                serviceName = vendor.MatchingServiceNames.split(',')[0].trim();
            } else if (vendor.serviceName) {
                serviceName = vendor.serviceName;
            }
            
            const price = vendor.services && vendor.services[0]?.VendorPrice ? `$${vendor.services[0].VendorPrice}` : 'Price on request';
            
            return `
                <div style="padding: 0.5rem; max-width: 200px; font-size: 0.85rem;">
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                        ${businessName}
                    </div>
                    <div style="color: #10b981; font-weight: 500; margin-bottom: 0.25rem;">
                        ${serviceName} • ${price}
                    </div>
                    <div style="color: #6b7280; font-size: 0.8rem;">
                        <i class="fas fa-map-marker-alt"></i> ${distance.toFixed(1)} km from event
                    </div>
                </div>
            `;
        }

        // Create detailed info window content for vendor
        function createVendorInfoWindowContent(vendor) {
            const rating = vendor.averageRating || 4.5;
            const reviewCount = vendor.totalReviews || 0;
            const businessName = vendor.BusinessName || vendor.businessName || 'Unknown Business';
            
            // Get service name from multiple possible sources
            let serviceName = 'Service Available';
            if (vendor.services && vendor.services[0]?.ServiceName) {
                serviceName = vendor.services[0].ServiceName;
            } else if (vendor.MatchingServiceNames && Array.isArray(vendor.MatchingServiceNames)) {
                serviceName = vendor.MatchingServiceNames[0];
            } else if (vendor.MatchingServiceNames && typeof vendor.MatchingServiceNames === 'string') {
                serviceName = vendor.MatchingServiceNames.split(',')[0].trim();
            } else if (vendor.serviceName) {
                serviceName = vendor.serviceName;
            }
            
            const price = vendor.services && vendor.services[0]?.VendorPrice ? `$${vendor.services[0].VendorPrice}` : 'Price on request';
            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
            
            return `
                <div style="padding: 1rem; max-width: 280px;">
                    <h6 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1rem;">
                        <i class="fas fa-store"></i> ${businessName}
                    </h6>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="color: #f59e0b; font-size: 0.85rem;">
                            ${'★'.repeat(Math.floor(rating))}${'☆'.repeat(5-Math.floor(rating))}
                        </div>
                        <span style="font-size: 0.8rem; color: #6b7280;">
                            ${rating.toFixed(1)} (${reviewCount} reviews)
                        </span>
                    </div>
                    <div style="background: #f8faff; border: 1px solid #e1e8f0; border-radius: 6px; padding: 0.5rem; margin: 0.5rem 0;">
                        <div style="color: #10b981; font-weight: 600; font-size: 0.9rem;">${serviceName}</div>
                        <div style="color: #059669; font-weight: 700; font-size: 1rem;">${price}</div>
                    </div>
                    <p style="margin: 0.5rem 0; font-size: 0.8rem; color: #6b7280;">
                        <i class="fas fa-map-marker-alt"></i> ${vendor.distance ? vendor.distance.toFixed(1) + ' km from event location' : 'Distance unknown'}
                    </p>
                    <button onclick="selectVendorFromMap('${vendorId}')" 
                            style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Select Vendor
                    </button>
                </div>
            `;
        }

        // Scroll to and highlight vendor card when marker is clicked
        function scrollToVendorCard(vendorId) {
            const card = document.querySelector(`[data-vendor-id="${vendorId}"]`);
            if (card) {
                // Scroll to the card
                card.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Add highlight animation
                card.style.transform = 'scale(1.02)';
                card.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                card.style.transition = 'all 0.3s ease';
                
                // Remove highlight after animation
                setTimeout(() => {
                    card.style.transform = '';
                    card.style.boxShadow = '';
                }, 2000);
            }
        }

        // Setup map controls
        function setupMapControls(eventCoords) {
            // Focus event location button
            const focusBtn = document.getElementById('focus-event-location');
            if (focusBtn) {
                focusBtn.addEventListener('click', () => {
                    if (vendorMap && eventLocationMarker) {
                        vendorMap.setCenter(eventLocationMarker.getPosition());
                        vendorMap.setZoom(15);
                        
                        // Bounce the marker to highlight it
                        eventLocationMarker.setAnimation(google.maps.Animation.BOUNCE);
                        setTimeout(() => {
                            eventLocationMarker.setAnimation(null);
                        }, 2000);
                    }
                });
            }
            
            // Show all vendors button
            const showAllBtn = document.getElementById('show-all-vendors');
            if (showAllBtn) {
                showAllBtn.addEventListener('click', () => {
                    if (vendorMap && vendorMarkers.length > 0) {
                        const bounds = new google.maps.LatLngBounds();
                        
                        // Include event location in bounds
                        if (eventLocationMarker) {
                            bounds.extend(eventLocationMarker.getPosition());
                        }
                        
                        // Include all vendor markers
                        vendorMarkers.forEach(marker => {
                            bounds.extend(marker.getPosition());
                        });
                        
                        vendorMap.fitBounds(bounds);
                        
                        // Ensure minimum zoom level
                        google.maps.event.addListenerOnce(vendorMap, 'bounds_changed', () => {
                            if (vendorMap.getZoom() > 15) {
                                vendorMap.setZoom(15);
                            }
                        });
                    }
                });
            }
        }

        // Debounce mechanism for renderHorizontalVendorCards
        let renderVendorCardsTimeout = null;
        let isRenderingVendorCards = false;

        // Render horizontal vendor cards with retry limit and debouncing
        function renderHorizontalVendorCards(vendorSections, retryCount = 0) {
            const maxRetries = 10; // Limit retries to prevent infinite loops
            
            // Debounce multiple calls
            if (retryCount === 0) {
                if (renderVendorCardsTimeout) {
                    clearTimeout(renderVendorCardsTimeout);
                }
                
                if (isRenderingVendorCards) {
                    console.log('🔄 Already rendering vendor cards, skipping...');
                    return;
                }
                
                renderVendorCardsTimeout = setTimeout(() => {
                    renderHorizontalVendorCards(vendorSections, 0);
                }, 100);
                return;
            }
            
            isRenderingVendorCards = true;
            
            // Enhanced debugging
            console.log('🎯 renderHorizontalVendorCards called with:', {
                sectionsCount: vendorSections?.length || 0,
                sections: vendorSections,
                currentStep: window.bookingState?.currentStep,
                retryCount: retryCount
            });
            
            // Wait for DOM to be ready - removed step restriction to allow cards to display
            // The step check was preventing vendor cards from showing when vendors are found
            console.log('🎯 Current booking step:', window.bookingState?.currentStep, '- proceeding with render');
            
            // Use a more robust approach to find elements
            let container = document.getElementById('vendor-cards-container');
            let cardsContainer = document.getElementById('vendor-horizontal-cards');
            
            // If elements not found, wait a bit and try again (with retry limit)
            if (!container || !cardsContainer) {
                if (retryCount < maxRetries) {
                    if (retryCount === 1) console.log('🔄 Elements not ready, waiting for DOM...');
                    setTimeout(() => renderHorizontalVendorCards(vendorSections, retryCount + 1), 300);
                } else {
                    console.error('❌ Max retries reached waiting for DOM elements');
                    isRenderingVendorCards = false;
                }
                return;
            }

            // Show cards container
            container.style.display = 'block';

            // Check if vendorSections is valid and has data
            if (!vendorSections || !Array.isArray(vendorSections) || vendorSections.length === 0) {
                console.warn('⚠️ No vendor sections provided or empty array');
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h4 style="color: #666; margin-bottom: 0.5rem;">No vendors found</h4>
                        <p style="color: #999; margin: 0;">Try adjusting your search criteria or explore the map to find vendors in different areas.</p>
                    </div>
                `;
                isRenderingVendorCards = false;
                return;
            }

            // Flatten and sort vendors by distance
            const allVendors = [];
            vendorSections.forEach(section => {
                console.log('Processing section:', section);
                if (section.vendors && Array.isArray(section.vendors)) {
                    section.vendors.forEach(vendor => {
                        allVendors.push({
                            ...vendor,
                            serviceCategory: section.category,
                            serviceName: section.service?.name || 'Unknown Service',
                            serviceBudget: section.service?.budget || 0
                        });
                    });
                } else {
                    console.warn('Section has no vendors or vendors is not an array:', section);
                }
            });

            console.log(`📋 Flattened ${allVendors.length} vendors from ${vendorSections.length} sections`);

            if (allVendors.length === 0) {
                console.warn('⚠️ No vendors found after flattening sections');
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h4 style="color: #666; margin-bottom: 0.5rem;">No vendors available</h4>
                        <p style="color: #999; margin: 0;">No vendors match your selected services. Try selecting different services or explore the map.</p>
                    </div>
                `;
                isRenderingVendorCards = false;
                return;
            }

            // Sort by distance (closest first)
            allVendors.sort((a, b) => (a.distance || 999) - (b.distance || 999));

            // Render cards
            try {
                const cardsHtml = allVendors.map(vendor => {
                    try {
                        return createHorizontalVendorCard(vendor);
                    } catch (cardError) {
                        console.error('Error creating card for vendor:', vendor, cardError);
                        return ''; // Return empty string for failed cards
                    }
                }).filter(html => html.length > 0).join('');
                
                console.log('🏗️ Generated cards HTML length:', cardsHtml.length);
                
                if (cardsHtml.length === 0) {
                    console.error('❌ No valid HTML generated for vendor cards');
                    cardsContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; background: #fff3cd; border-radius: 12px; border: 2px dashed #ffc107;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #856404; margin-bottom: 1rem;"></i>
                            <h4 style="color: #856404; margin-bottom: 0.5rem;">Error displaying vendors</h4>
                            <p style="color: #856404; margin: 0;">There was an issue displaying the vendor cards. Please try refreshing or contact support.</p>
                        </div>
                    `;
                } else {
                    cardsContainer.innerHTML = cardsHtml;
                    console.log('✅ Cards rendered to container successfully');
                    
                    // Initialize carousels for all vendor cards
                    setTimeout(() => {
                        allVendors.forEach(vendor => {
                            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id || 'unknown-' + Math.random();
                            initializeVendorCarousel(vendorId);
                        });
                    }, 100);
                }

                // Setup sorting
                setupVendorSorting(allVendors);
                
            } catch (renderError) {
                console.error('❌ Error rendering vendor cards:', renderError);
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8d7da; border-radius: 12px; border: 2px dashed #dc3545;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #721c24; margin-bottom: 1rem;"></i>
                        <h4 style="color: #721c24; margin-bottom: 0.5rem;">Rendering Error</h4>
                        <p style="color: #721c24; margin: 0;">Failed to render vendor cards. Please try again.</p>
                    </div>
                `;
            }
            
            // Reset rendering flag
            isRenderingVendorCards = false;
        }

        // Create horizontal vendor card HTML
        function createHorizontalVendorCard(vendor) {
            console.log('Creating vendor card for:', vendor);
            
            // Validate vendor object
            if (!vendor || typeof vendor !== 'object') {
                console.error('Invalid vendor object:', vendor);
                return '';
            }
            
            // Use the correct property names from API response
            const businessName = vendor.BusinessName || vendor.businessName || vendor.name || 'Unknown Business';
            const location = vendor.Location || vendor.location || vendor.address || 'Location not specified';
            const description = vendor.BusinessDescription || vendor.description || vendor.businessDescription || '';
            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id || 'unknown-' + Math.random();
            
            // Get vendor images - support multiple images for carousel (robust like Step 4)
            const vendorImages = [];
            const urlFrom = (obj) => {
                if (!obj) return null;
                if (typeof obj === 'string') return obj;
                const cand = obj.ImageURL || obj.ImageUrl || obj.URL || obj.Url || obj.url || obj.src || obj.image || obj.Path || obj.ImagePath || obj.path;
                return typeof cand === 'string' ? cand : null;
            };
            if (vendor.FeaturedImageURL || vendor.profileImageUrl || vendor.featuredImageUrl) {
                vendorImages.push(vendor.FeaturedImageURL || vendor.profileImageUrl || vendor.featuredImageUrl);
            }
            if (Array.isArray(vendor.images)) vendorImages.push(...vendor.images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
            if (Array.isArray(vendor.Images)) vendorImages.push(...vendor.Images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
            if (Array.isArray(vendor.VendorImages)) vendorImages.push(...vendor.VendorImages.map(img => urlFrom(img)).filter(Boolean));
            if (Array.isArray(vendor.GalleryImages)) vendorImages.push(...vendor.GalleryImages.map(img => urlFrom(img)).filter(Boolean));
            if (Array.isArray(vendor.Photos)) vendorImages.push(...vendor.Photos.map(img => urlFrom(img)).filter(Boolean));
            if (Array.isArray(vendor.photoUrls)) vendorImages.push(...vendor.photoUrls);
            if (typeof vendor.ImageURLs === 'string') vendorImages.push(...vendor.ImageURLs.split(',').map(s => s.trim()));
            if (typeof vendor.imageUrls === 'string') vendorImages.push(...vendor.imageUrls.split(',').map(s => s.trim()));
            ['image1','image2','image3','image4','image5','Image1','Image2','Image3','Image4','Image5'].forEach(k => {
                if (vendor[k]) vendorImages.push(vendor[k]);
            });
            
            // Remove duplicates and filter out empty values
            const uniqueImages = [...new Set(vendorImages.filter(img => img && typeof img === 'string' && img.trim()))];
            
            // Get service details from the services array
            let serviceTags = [];
            
            if (vendor.services && vendor.services.length > 0) {
                vendor.services.forEach(service => {
                    serviceTags.push({
                        name: service.ServiceName,
                        price: service.VendorPrice || 0
                    });
                });
            }
            
            // Get service names for tags - ensure it's always an array
            let serviceNames = [];
            
            // Debug: Log vendor data to see structure
            console.log('🔍 Vendor data structure:', {
                vendor: vendor,
                MatchingServiceNames: vendor.MatchingServiceNames,
                services: vendor.services,
                serviceName: vendor.serviceName,
                serviceCategory: vendor.serviceCategory
            });
            
            if (vendor.MatchingServiceNames && Array.isArray(vendor.MatchingServiceNames) && vendor.MatchingServiceNames.length > 0) {
                serviceNames = vendor.MatchingServiceNames;
            } else if (vendor.MatchingServiceNames && typeof vendor.MatchingServiceNames === 'string' && vendor.MatchingServiceNames.trim()) {
                serviceNames = vendor.MatchingServiceNames.split(',').map(s => s.trim());
            } else if (vendor.serviceName) {
                serviceNames = [vendor.serviceName];
            } else if (vendor.services && Array.isArray(vendor.services) && vendor.services.length > 0) {
                serviceNames = vendor.services.map(s => s.ServiceName).filter(name => name);
            } else if (vendor.serviceCategory) {
                serviceNames = [vendor.serviceCategory];
            } else {
                serviceNames = ['Service'];
            }
            
            console.log('🎯 Extracted service names:', serviceNames);
            
            const rating = vendor.averageRating || 4.5;
            const reviewCount = vendor.totalReviews || 0;
            const distance = vendor.distance ? `${vendor.distance.toFixed(1)} km away` : 'Distance unknown';
            const isSelected = (typeof bookingState !== 'undefined' && bookingState.selectedVendors) ? 
                window.bookingState.selectedVendors.some(v => v.vendorProfileId === vendorId) : false;
            
            // Starting price from backend; coerce strings like "$1,234.00" to number
            let startingPriceRaw = vendor.startingPrice ?? vendor.MinPriceNumeric ?? null;
            if ((startingPriceRaw === null || typeof startingPriceRaw !== 'number') && typeof vendor.startingPrice === 'string') {
                const parsed = parseFloat(vendor.startingPrice.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) startingPriceRaw = parsed;
            }
            if ((startingPriceRaw === null || typeof startingPriceRaw !== 'number') && typeof vendor.MinPrice === 'string') {
                const parsed = parseFloat(vendor.MinPrice.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) startingPriceRaw = parsed;
            }
            if ((startingPriceRaw === null || typeof startingPriceRaw !== 'number') && typeof vendor.price === 'string') {
                const parsed = parseFloat(vendor.price.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) startingPriceRaw = parsed;
            }
            const startingServiceName = vendor.startingServiceName || vendor.StartingServiceName || vendor.MinServiceName || '';
            const startingPriceDisplay = (typeof startingPriceRaw === 'number' && !isNaN(startingPriceRaw))
                ? `$${Math.round(startingPriceRaw).toLocaleString()}`
                : '';

            // Create image carousel HTML
            const imageCarouselHtml = uniqueImages.length > 0 ? `
                <div class="vendor-card-image-container">
                    <div class="vendor-image-carousel" id="carousel-${vendorId}">
                        ${uniqueImages.map(img => `
                            <img src="${img}" alt="${businessName}" class="vendor-card-image" 
                                 onerror="this.style.display='none';">
                        `).join('')}
                    </div>
                    ${uniqueImages.length > 1 ? `
                        <button class="carousel-nav prev" onclick="event.stopPropagation(); navigateCarousel('${vendorId}', -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="carousel-nav next" onclick="event.stopPropagation(); navigateCarousel('${vendorId}', 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="carousel-dots">
                            ${uniqueImages.map((_, index) => `
                                <div class="carousel-dot ${index === 0 ? 'active' : ''}" 
                                     onclick="event.stopPropagation(); goToCarouselSlide('${vendorId}', ${index})"></div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            ` : `
                <div class="vendor-no-image">
                    <i class="fas fa-user-tie" style="font-size: 2rem; color: var(--primary);"></i>
                </div>
            `;

            // Build service details chip row from available service names
            let serviceDetails = '';
            let totalCost = 0;
            let priceRange = '$$$';
            const displayServiceName = Array.isArray(serviceNames) && serviceNames.length > 0 ? serviceNames[0] : '';
            const secondaryServices = Array.isArray(serviceNames) && serviceNames.length > 1 ? serviceNames.slice(1, 3).join(' • ') : '';
            if (displayServiceName) {
                serviceDetails = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin: 0.3rem 0; font-size: 0.85rem;">
                        <span style="color: #10b981; font-weight: 600;">${displayServiceName}</span>
                        ${secondaryServices ? `<span style=\"color: #6b7280;\">•</span><span style=\"color: #6b7280;\">${secondaryServices}</span>` : ''}
                    </div>
                `;
            }
            

            return `
                <div class="vendor-horizontal-card ${isSelected ? 'selected' : ''}" 
                     data-vendor-id="${vendorId}" 
                     onmouseover="highlightMapMarker('${vendorId}', true)" 
                     onmouseout="highlightMapMarker('${vendorId}', false)" 
                     onclick="console.log('Card clicked!'); console.log('About to call toggleVendorSelection with:', '${vendorId}'); window.toggleVendorSelection('${vendorId}'); console.log('toggleVendorSelection call completed');">
                    ${imageCarouselHtml}
                    
                    <div class="vendor-card-content">
                        <div style="margin-bottom: 0.5rem;">
                            <h4 style="font-size: 1rem; margin: 0 0 0.25rem 0; font-weight: 600; color: #1f2937;">${businessName}</h4>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <div style="color: #f59e0b; font-size: 0.85rem;">
                                    ${'★'.repeat(Math.floor(rating))}${'☆'.repeat(5-Math.floor(rating))}
                                </div>
                                <span style="font-size: 0.8rem; color: #6b7280;">
                                    ${rating.toFixed(1)} (${reviewCount})
                                </span>
                                <span style="font-size: 0.8rem; color: #6b7280;">• ${location || distance}</span>
                            </div>
                        </div>
                        
                        ${description ? `<div style="font-size: 0.85rem; color: #4b5563; line-height: 1.3; margin-bottom: 0.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${description}</div>` : ''}
                        ${startingPriceDisplay ? `
                        <div style="font-size: 0.9rem; color: #065f46; font-weight: 700; margin-bottom: 0.5rem;">
                            Starting from ${startingPriceDisplay}${startingServiceName ? ` • <span style="font-weight:600; color:#047857;">${startingServiceName}</span>` : ''}
                        </div>` : ''}
                        
                        <div style="margin-bottom: 0.5rem;">
                            ${serviceDetails}
                        </div>
                        
                        <div style="position: absolute; bottom: 0.75rem; right: 0.75rem; display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); const baseUrl = window.location.origin + window.location.pathname; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');" 
                                    style="padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                View
                            </button>
                            <button onclick="event.stopPropagation(); console.log('Button clicked!'); console.log('About to call toggleVendorSelection with:', '${vendorId}'); window.toggleVendorSelection('${vendorId}'); console.log('Button toggleVendorSelection call completed');" 
                                    style="padding: 0.4rem 0.8rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; ${isSelected ? 'background: #059669;' : ''}">
                                ${isSelected ? 'Selected' : 'Select'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Setup vendor sorting functionality
        function setupVendorSorting(vendors) {
            const sortSelect = document.getElementById('vendor-sort');
            if (!sortSelect) return;

            sortSelect.addEventListener('change', (e) => {
                const sortBy = e.target.value;
                let sortedVendors = [...vendors];

                switch (sortBy) {
                    case 'distance':
                        sortedVendors.sort((a, b) => (a.distance || 999) - (b.distance || 999));
                        break;
                    case 'price':
                        sortedVendors.sort((a, b) => {
                            const priceA = getPriceValue(a.priceRange || '$$$');
                            const priceB = getPriceValue(b.priceRange || '$$$');
                            return priceA - priceB;
                        });
                        break;
                    case 'rating':
                        sortedVendors.sort((a, b) => (b.averageRating || 4.5) - (a.averageRating || 4.5));
                        break;
                }

                // Re-render cards
                const cardsContainer = document.getElementById('vendor-horizontal-cards');
                cardsContainer.innerHTML = sortedVendors.map(vendor => createHorizontalVendorCard(vendor)).join('');
                
                // Reinitialize carousel functionality for new cards
                setTimeout(() => {
                    sortedVendors.forEach(vendor => {
                        const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
                        if (vendorId) initializeVendorCarousel(vendorId);
                    });
                }, 100);
            });
        }

        // Image carousel functionality
        const carouselStates = {};

        function initializeVendorCarousel(vendorId) {
            const carousel = document.getElementById(`carousel-${vendorId}`);
            if (!carousel) return;

            const images = carousel.querySelectorAll('.vendor-card-image');
            if (images.length <= 1) return; // No need for carousel with single image

            // Initialize state
            carouselStates[vendorId] = {
                currentIndex: 0,
                totalImages: images.length
            };

            console.log(`🎠 Initialized carousel for vendor ${vendorId} with ${images.length} images`);
        }

        function navigateCarousel(vendorId, direction) {
            const state = carouselStates[vendorId];
            if (!state) return;

            const carousel = document.getElementById(`carousel-${vendorId}`);
            if (!carousel) return;

            // Update current index
            state.currentIndex += direction;
            
            // Handle wrapping
            if (state.currentIndex >= state.totalImages) {
                state.currentIndex = 0;
            } else if (state.currentIndex < 0) {
                state.currentIndex = state.totalImages - 1;
            }

            // Apply transform
            const translateX = -state.currentIndex * 360; // 360px is the image width
            carousel.style.transform = `translateX(${translateX}px)`;

            // Update dots
            updateCarouselDots(vendorId);
        }

        function goToCarouselSlide(vendorId, index) {
            const state = carouselStates[vendorId];
            if (!state || index < 0 || index >= state.totalImages) return;

            const carousel = document.getElementById(`carousel-${vendorId}`);
            if (!carousel) return;

            // Update current index
            state.currentIndex = index;

            // Apply transform
            const translateX = -state.currentIndex * 360;
            carousel.style.transform = `translateX(${translateX}px)`;

            // Update dots
            updateCarouselDots(vendorId);
        }

        function updateCarouselDots(vendorId) {
            const state = carouselStates[vendorId];
            if (!state) return;

            const card = document.querySelector(`[data-vendor-id="${vendorId}"]`);
            if (!card) return;

            const dots = card.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                if (index === state.currentIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Initialize carousels when cards are rendered
        document.addEventListener('DOMContentLoaded', () => {
            // Use MutationObserver to detect when vendor cards are added
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Check if vendor cards were added
                        const hasVendorCards = Array.from(mutation.addedNodes).some(node => 
                            node.nodeType === Node.ELEMENT_NODE && 
                            (node.classList?.contains('vendor-horizontal-card') || 
                             node.querySelector?.('.vendor-horizontal-card'))
                        );
                        
                        if (hasVendorCards) {
                            setTimeout(() => {
                                // Initialize carousels for all vendor cards
                                const vendorCards = document.querySelectorAll('.vendor-horizontal-card');
                                vendorCards.forEach(card => {
                                    const vendorId = card.getAttribute('data-vendor-id');
                                    if (vendorId) {
                                        initializeVendorCarousel(vendorId);
                                    }
                                });
                            }, 100);
                        }
                    }
                });
            });

            const cardsContainer = document.getElementById('vendor-horizontal-cards');
            if (cardsContainer) {
                observer.observe(cardsContainer, { 
                    childList: true, 
                    subtree: true 
                });
            }
        });

        // Helper function to get numeric price value
        function getPriceValue(priceRange) {
            const priceMap = { '$': 1, '$$': 2, '$$$': 3, '$$$$': 4 };
            return priceMap[priceRange] || 3;
        }

        // Toggle vendor selection
        function toggleVendorSelection(vendorProfileId) {
            console.log('🔘 toggleVendorSelection called with:', vendorProfileId);
            console.log('🔘 Function is running!');
            
            // Use existing bookingState or initialize selectedVendors array
            if (!window.bookingState) {
                window.bookingState = {};
            }
            if (!window.bookingState.selectedVendors) {
                window.bookingState.selectedVendors = [];
            }
            
            const selectedVendors = window.bookingState.selectedVendors;
            const existingIndex = selectedVendors.findIndex(v => v.vendorId === vendorProfileId);
            
            if (existingIndex > -1) {
                // Remove vendor from selection
                selectedVendors.splice(existingIndex, 1);
                console.log('🔘 Vendor removed from selection');
            } else {
                // Add vendor to selection with inferred service details
                const vendor = (window.bookingState?.availableVendors || []).find(v => {
                    const vId = v.VendorProfileID || v.vendorProfileId || v.id;
                    return String(vId) === String(vendorProfileId);
                }) || {};

                // Infer selected service from vendor.services or fallbacks
                let selService = null;
                if (Array.isArray(vendor.services) && vendor.services.length > 0) {
                    selService = vendor.services[0];
                } else if (vendor.serviceName) {
                    selService = {
                        ServiceName: vendor.serviceName,
                        VendorPrice: vendor.servicePrice || vendor.totalEstimatedCost || 0
                    };
                }

                const serviceName = selService?.ServiceName || 'Selected Service';
                const servicePrice = selService?.VendorPrice ?? vendor.totalEstimatedCost ?? 0;

                selectedVendors.push({
                    vendorId: vendorProfileId,
                    id: vendorProfileId,
                    serviceName: serviceName,
                    servicePrice: servicePrice,
                    selectedService: selService || undefined,
                    vendorData: vendor
                });
                console.log('🔘 Vendor added to selection');
            }
            
            console.log('🔘 Current selected vendors:', selectedVendors);

            // Update UI and markers
            updateVendorSelectionUI();
            updateMarkerColors();
            
            // Enable/disable send requests button
            const sendRequestsBtn = document.getElementById('send-requests-btn');
            if (sendRequestsBtn) {
                sendRequestsBtn.disabled = selectedVendors.length === 0;
                console.log('🔘 Send requests button disabled:', sendRequestsBtn.disabled);
            }
        }
        
        // Function to update marker colors based on selection state
        function updateMarkerColors() {
            if (!vendorMarkers || vendorMarkers.length === 0) return;
            
            const selectedVendorIds = window.bookingState?.selectedVendors?.map(v => v.vendorId) || [];
            
            vendorMarkers.forEach(marker => {
                const vendorId = marker.vendorData?.VendorProfileID || marker.vendorData?.vendorProfileId || marker.vendorData?.id;
                const isSelected = selectedVendorIds.includes(vendorId);
                
                // Get the original category icon
                const categoryIcon = getCategoryIcon(marker.vendorData?.serviceCategory || marker.vendorData?.category);
                
                // Update marker icon based on selection state
                marker.setIcon({
                    path: categoryIcon.path,
                    scale: categoryIcon.scale,
                    fillColor: isSelected ? '#10b981' : categoryIcon.fillColor, // Green if selected, original color if not
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: isSelected ? 3 : 2 // Thicker stroke if selected
                });
            });
        }

        // Select vendor from map info window
        window.selectVendorFromMap = function(vendorProfileId) {
            toggleVendorSelection(vendorProfileId);
        };

        // Update vendor selection UI
        function updateVendorSelectionUI(vendorProfileId) {
            console.log('🎨 Updating vendor selection UI for:', vendorProfileId);
            
            // Update all vendor cards to reflect current selection state
            const allCards = document.querySelectorAll('.vendor-horizontal-card');
            allCards.forEach(card => {
                const cardVendorId = card.getAttribute('data-vendor-id');
                
                // Check if this specific card's vendor is selected
                const isNowSelected = bookingState.selectedVendors.some(v => {
                    const vId = v.vendorProfileId || v.VendorProfileID || v.VendorProfileId || v.id;
                    return String(vId) === String(cardVendorId);
                });
                
                console.log(`Card ${cardVendorId}: selected = ${isNowSelected}`);
                
                // Update card visual state
                if (isNowSelected) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
                
                // Update the select button (last button in the card)
                const buttons = card.querySelectorAll('button');
                const selectButton = buttons[buttons.length - 1]; // Get the last button (Select/Selected)
                if (selectButton) {
                    selectButton.textContent = isNowSelected ? 'Selected' : 'Select';
                    selectButton.style.background = isNowSelected ? '#059669' : '#10b981';
                }
            });
        }

        // Update map markers based on selection
        function updateMapMarkers() {
            vendorMarkers.forEach(marker => {
                const isSelected = bookingState.selectedVendors?.some(v => 
                    v.vendorProfileId === marker.vendorData.vendorProfileId
                );
                
                // Update marker appearance based on selection
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: isSelected ? 12 : 10,
                    fillColor: isSelected ? '#27ae60' : '#3498db',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: isSelected ? 3 : 2
                });
            });
        }

        // AC2 & AC4: Add debounced map movement listeners for booking process
        function addBookingMapMovementListeners() {
            if (!vendorMap) return;

            // AC4: Debounced function for map movement (300ms)
            const debouncedBookingMapMove = debounce(() => {
                if (window.bookingState.isLoadingVendors) return;
                
                const currentBounds = vendorMap.getBounds();
                if (!currentBounds) return;

                // Check if bounds have significantly changed
                if (window.bookingState.lastMapBounds && boundsEqual(currentBounds, window.bookingState.lastMapBounds)) {
                    return;
                }

                window.bookingState.lastMapBounds = currentBounds;
                loadVendorsInBookingMapBounds(currentBounds);
            }, 300);

            // Add listeners for map movement
            vendorMap.addListener('bounds_changed', debouncedBookingMapMove);
            vendorMap.addListener('zoom_changed', debouncedBookingMapMove);
        }

        // AC3: Add loading indicator to booking map
        function addBookingMapLoadingIndicator() {
            const mapContainer = document.getElementById('vendor-map');
            if (!mapContainer) return;

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'booking-map-loading-indicator';
            loadingDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: none;
                z-index: 1000;
                align-items: center;
                gap: 12px;
            `;
            loadingDiv.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: #333; font-weight: 500;">Loading vendors...</span>
            `;

            mapContainer.style.position = 'relative';
            mapContainer.appendChild(loadingDiv);
        }

        // AC6: Add reset search button for booking map
        function addBookingResetSearchButton() {
            const mapContainer = document.getElementById('vendor-map');
            if (!mapContainer) return;

            const resetButton = document.createElement('button');
            resetButton.id = 'booking-reset-search-btn';
            resetButton.innerHTML = `
                <i class="fas fa-undo"></i>
                <span>Reset View</span>
            `;
            resetButton.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 8px 12px;
                cursor: pointer;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 14px;
                color: #333;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                transition: all 0.2s ease;
            `;

            resetButton.addEventListener('mouseenter', () => {
                resetButton.style.backgroundColor = '#f8f9fa';
                resetButton.style.transform = 'translateY(-1px)';
            });

            resetButton.addEventListener('mouseleave', () => {
                resetButton.style.backgroundColor = 'white';
                resetButton.style.transform = 'translateY(0)';
            });

            resetButton.addEventListener('click', resetBookingToOriginalSearch);
            mapContainer.appendChild(resetButton);
        }

        // AC2: Load vendors within booking map bounds - Enhanced for dynamic discovery
        async function loadVendorsInBookingMapBounds(bounds) {
            if (window.bookingState.isLoadingVendors) return;

            window.bookingState.isLoadingVendors = true;
            showBookingMapLoadingIndicator();
            showBookingSidebarSkeletonLoader();

            try {
                // Get bounds coordinates
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();

                // First, filter vendors within bounds from existing data
                const vendorsInBounds = [];
                
                if (bookingState.originalVendorSections) {
                    window.bookingState.originalVendorSections.forEach(section => {
                        const filteredVendors = section.vendors.filter(vendor => {
                            if (!vendor.coordinates) return false;
                            const lat = vendor.coordinates.lat;
                            const lng = vendor.coordinates.lng;
                            return lat >= sw.lat() && lat <= ne.lat() && 
                                   lng >= sw.lng() && lng <= ne.lng();
                        });
                        
                        if (filteredVendors.length > 0) {
                            vendorsInBounds.push({
                                ...section,
                                vendors: filteredVendors
                            });
                        }
                    });
                }

                // If no vendors in current bounds, search for new vendors in this area
                if (vendorsInBounds.length === 0) {
                    console.log('🔍 No existing vendors in bounds, searching for new vendors...');
                    
                    // Calculate center point for search
                    const centerLat = (ne.lat() + sw.lat()) / 2;
                    const centerLng = (ne.lng() + sw.lng()) / 2;
                    
                    // Search for vendors in this geographic area
                    const newVendorSections = await searchVendorsInArea(centerLat, centerLng, bounds);
                    
                    if (newVendorSections.length > 0) {
                        // Add newly found vendors to our original sections
                        newVendorSections.forEach(newSection => {
                            const existingSection = window.bookingState.originalVendorSections.find(
                                section => section.category === newSection.category && 
                                          section.service.name === newSection.service.name
                            );
                            
                            if (existingSection) {
                                // Merge vendors, avoiding duplicates
                                newSection.vendors.forEach(newVendor => {
                                    if (!existingSection.vendors.find(v => v.id === newVendor.id)) {
                                        existingSection.vendors.push(newVendor);
                                    }
                                });
                            } else {
                                // Add new section
                                window.bookingState.originalVendorSections.push(newSection);
                            }
                        });
                        
                        // Update vendors in bounds with newly discovered ones
                        vendorsInBounds.push(...newVendorSections);
                        console.log(`✅ Found ${newVendorSections.reduce((sum, s) => sum + s.vendors.length, 0)} new vendors in area`);
                    }
                }

                console.log(`Found ${vendorsInBounds.reduce((sum, section) => sum + section.vendors.length, 0)} vendors in current map area`);

                // Update sidebar list with contextual results
                currentVendorSections = vendorsInBounds;
                renderHorizontalVendorCards(vendorsInBounds);

                // Update vendor markers on map
                vendorMarkers.forEach(marker => marker.setMap(null));
                vendorMarkers = [];
                await addVendorMarkers(vendorsInBounds, {
                    lat: window.selectedEventLocation?.lat || 43.6532,
                    lng: window.selectedEventLocation?.lng || -79.3832
                });

                // Update results count display
                const totalVendors = vendorsInBounds.reduce((sum, section) => sum + section.vendors.length, 0);
                console.log(`Updated sidebar with ${totalVendors} vendors in current map area`);

            } catch (error) {
                console.error('Error loading vendors in booking map bounds:', error);
            } finally {
                window.bookingState.isLoadingVendors = false;
                hideBookingMapLoadingIndicator();
                hideBookingSidebarSkeletonLoader();
            }
        }

        // Function to search for vendors in a specific geographic area
        async function searchVendorsInArea(centerLat, centerLng, bounds) {
            try {
                console.log(`🔍 Searching for vendors in area: ${centerLat}, ${centerLng}`);
                
                // Get the selected services from booking state
                const selectedServices = window.bookingState?.selectedPredefinedServices || [];
                if (selectedServices.length === 0) {
                    console.log('No services selected for vendor search');
                    return [];
                }

                // Prepare the search request
                const searchRequest = {
                    selectedServices: selectedServices.map(service => ({
                        category: service.category,
                        name: service.name,
                        budget: service.budget,
                        serviceId: service.serviceId || service.id // Include serviceId for backend processing
                    })),
                    location: {
                        lat: centerLat,
                        lng: centerLng,
                        radius: 25 // 25km radius from center point
                    },
                    eventDetails: window.bookingState?.eventDetails || {}
                };

                console.log('🌐 Sending vendor search request:', searchRequest);

                // Make API call to search for vendors
                const response = await fetch(`${API_BASE_URL}/vendors/search-by-services`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchRequest)
                });

                if (!response.ok) {
                    throw new Error(`Vendor search failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('📦 Vendor search response:', data);

                const vendorSections = [];

                // Process each service category
                for (const [category, services] of Object.entries(data)) {
                    if (category === 'message') continue; // Skip message field
                    
                    for (const [serviceName, vendors] of Object.entries(services)) {
                        if (!Array.isArray(vendors) || vendors.length === 0) continue;

                        // Find the corresponding service from our selected services
                        const service = selectedServices.find(s => 
                            s.category === category && s.name === serviceName
                        );
                        
                        if (!service) continue;

                        // Process vendors and add coordinates
                        const vendorsWithCoords = vendors.map(vendor => {
                            // Extract coordinates with fallback
                            let coordinates = null;
                            if (vendor.latitude && vendor.longitude) {
                                coordinates = {
                                    lat: parseFloat(vendor.latitude),
                                    lng: parseFloat(vendor.longitude)
                                };
                            } else if (vendor.lat && vendor.lng) {
                                coordinates = {
                                    lat: parseFloat(vendor.lat),
                                    lng: parseFloat(vendor.lng)
                                };
                            } else {
                                // Use search center as fallback
                                coordinates = {
                                    lat: centerLat,
                                    lng: centerLng
                                };
                            }

                            return {
                                ...vendor,
                                coordinates: coordinates
                            };
                        }).filter(vendor => {
                            // Only include vendors within the map bounds
                            if (!vendor.coordinates) return false;
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            const lat = vendor.coordinates.lat;
                            const lng = vendor.coordinates.lng;
                            return lat >= sw.lat() && lat <= ne.lat() && 
                                   lng >= sw.lng() && lng <= ne.lng();
                        });

                        if (vendorsWithCoords.length > 0) {
                            vendorSections.push({
                                category: category,
                                service: service,
                                vendors: vendorsWithCoords
                            });
                            console.log(`✅ Found ${vendorsWithCoords.length} vendors for ${category} - ${serviceName} in area`);
                        }
                    }
                }

                return vendorSections;

            } catch (error) {
                console.error('❌ Error searching vendors in area:', error);
                return [];
            }
        }

        // AC6: Reset booking map to original search results
        function resetBookingToOriginalSearch() {
            if (!bookingState.initialMapBounds || !bookingState.originalVendorSections) return;

            // Restore original vendor sections
            currentVendorSections = [...bookingState.originalVendorSections];
            
            // Reset map bounds
            vendorMap.fitBounds(bookingState.initialMapBounds);
            
            // Update UI
            renderHorizontalVendorCards(currentVendorSections);
            
            // Clear and re-add all vendor markers
            vendorMarkers.forEach(marker => marker.setMap(null));
            vendorMarkers = [];
            addVendorMarkers(currentVendorSections, {
                lat: window.selectedEventLocation?.lat || 43.6532,
                lng: window.selectedEventLocation?.lng || -79.3832
            });
        }

        // Utility functions for booking map
        function showBookingMapLoadingIndicator() {
            const indicator = document.getElementById('booking-map-loading-indicator');
            if (indicator) {
                indicator.style.display = 'flex';
            }
        }

        function hideBookingMapLoadingIndicator() {
            const indicator = document.getElementById('booking-map-loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function showBookingSidebarSkeletonLoader() {
            const vendorCardsContainer = document.getElementById('vendor-cards-container');
            if (!vendorCardsContainer) return;

            // Store original content
            if (!vendorCardsContainer.dataset.originalContent) {
                vendorCardsContainer.dataset.originalContent = vendorCardsContainer.innerHTML;
            }

            // Create skeleton cards
            const skeletonHTML = Array(4).fill(0).map(() => `
                <div class="vendor-horizontal-card" style="
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 12px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                    animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
                    display: flex;
                    gap: 1rem;
                ">
                    <div style="
                        width: 120px;
                        height: 80px;
                        background: #dee2e6;
                        border-radius: 8px;
                        flex-shrink: 0;
                    "></div>
                    <div style="flex: 1;">
                        <div style="
                            width: 60%;
                            height: 20px;
                            background: #dee2e6;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                        "></div>
                        <div style="
                            width: 40%;
                            height: 16px;
                            background: #dee2e6;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                        "></div>
                        <div style="
                            width: 30%;
                            height: 16px;
                            background: #dee2e6;
                            border-radius: 4px;
                        "></div>
                    </div>
                </div>
            `).join('');

            vendorCardsContainer.innerHTML = skeletonHTML;
        }

        function hideBookingSidebarSkeletonLoader() {
            const vendorCardsContainer = document.getElementById('vendor-cards-container');
            if (!vendorCardsContainer || !vendorCardsContainer.dataset.originalContent) return;

            // Don't restore original content, let the normal render function handle it
            // The renderHorizontalVendorCards() function will be called after this
        }

        // TEST FUNCTION: Force display sample vendor cards for debugging
        function testVendorCardsDisplay() {
            console.log('🧪 Testing vendor cards display with sample data...');
            
            const sampleVendorSections = [{
                category: "Photography",
                service: { name: "Wedding Photography", budget: 2000 },
                vendors: [{
                    VendorProfileID: "test-1",
                    BusinessName: "Test Photography Studio",
                    BusinessDescription: "Professional wedding photography services",
                    Location: "Toronto, ON",
                    Latitude: 43.6532,
                    Longitude: -79.3832,
                    averageRating: 4.8,
                    totalReviews: 25,
                    services: [{
                        ServiceName: "Wedding Photography",
                        VendorPrice: 1800,
                        VendorDurationMinutes: 480
                    }]
                }]
            }];
            
            console.log('🧪 Sample data created:', sampleVendorSections);
            
            // Force render with sample data
            renderHorizontalVendorCards(sampleVendorSections);
        }
        
        // Add test function to window for console access
        window.testVendorCardsDisplay = testVendorCardsDisplay;
        
        // Force show vendor cards container for debugging
        function forceShowVendorCards() {
            console.log('🔧 Force showing vendor cards container...');
            const container = document.getElementById('vendor-cards-container');
            const cardsContainer = document.getElementById('vendor-horizontal-cards');
            
            if (container) {
                container.style.display = 'block';
                console.log('✅ Container display set to block');
            } else {
                console.error('❌ vendor-cards-container not found');
            }
            
            if (cardsContainer) {
                cardsContainer.innerHTML = `
                    <div style="padding: 1rem; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #1976d2; margin: 0 0 0.5rem 0;">🔧 Debug Message</h4>
                        <p style="color: #1976d2; margin: 0;">Vendor cards container is now visible. If you can see this message, the DOM elements are working correctly.</p>
                    </div>
                `;
                console.log('✅ Debug message added to cards container');
            } else {
                console.error('❌ vendor-horizontal-cards not found');
            }
        }
        
        window.forceShowVendorCards = forceShowVendorCards;

        // Highlight vendor card when marker is clicked
        function highlightVendorCard(vendorProfileId) {
            // Remove previous highlights
            document.querySelectorAll('.vendor-horizontal-card').forEach(card => {
                card.style.boxShadow = '';
            });

            // Highlight the corresponding card
            const card = document.querySelector(`[data-vendor-id="${vendorProfileId}"]`);
            if (card) {
                card.style.boxShadow = '0 0 0 3px var(--primary)';
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    card.style.boxShadow = '';
                }, 3000);
            }
        }

        // Update send requests button
        function updateSendRequestsButton() {
            const button = document.getElementById('send-requests-btn');
            if (button) {
                const hasSelections = bookingState.selectedVendors && bookingState.selectedVendors.length > 0;
                button.disabled = !hasSelections;
                button.textContent = hasSelections ? 
                    `Send Requests (${bookingState.selectedVendors.length})` : 
                    'Send Requests';
            }
        }

        // Make the new toggleVendorSelection function globally available
        window.toggleVendorSelection = toggleVendorSelection;
        
        // Test if function is accessible
        console.log('🔧 toggleVendorSelection function:', typeof window.toggleVendorSelection);
        console.log('🔧 Function reference:', window.toggleVendorSelection);
        console.log('🔧 Testing function call...');
        
        // Test the function directly
        try {
            console.log('🔧 Testing direct call...');
            // Don't actually call it, just test if it exists
            if (typeof window.toggleVendorSelection === 'function') {
                console.log('🔧 Function exists and is callable');
            } else {
                console.log('🔧 Function does not exist or is not callable');
            }
        } catch (e) {
            console.log('🔧 Error testing function:', e);
        }
        
        // Add click event listeners to all vendor cards after they're created
        setTimeout(() => {
            const vendorCards = document.querySelectorAll('.vendor-horizontal-card');
            console.log('🔧 Found vendor cards:', vendorCards.length);
            
            vendorCards.forEach((card, index) => {
                console.log(`🔧 Card ${index}:`, card.dataset.vendorId);
                card.addEventListener('click', function() {
                    console.log('🔧 Card clicked via event listener!', this.dataset.vendorId);
                    window.toggleVendorSelection(this.dataset.vendorId);
                });
            });
        }, 1000);
        
        console.log('🎉 All Vendor Setup Improvements JavaScript Loaded Successfully!');
    </script>
</html>
