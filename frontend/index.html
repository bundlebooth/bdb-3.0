<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PlanHive - Event Booking Platform</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎪</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Maps API with Places API (New) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPhhp2rAt1VTrIzjgagJXZPZ_nc7K_BVo&libraries=places,geometry,marker&callback=initMap&v=weekly"></script>
    <!-- MarkerClusterer for Google Maps markers clustering -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Add Stripe.js for payment processing -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Add FullCalendar for booking dates -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <!-- Flatpickr for modern date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <!-- Add Socket.IO for chat functionality -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Add Chart.js for analytics graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Invoice PDF libs -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Select2 for enhanced dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Google Places API will be loaded dynamically with API key from backend -->
    <style>
        :root {
            --primary: #5e72e4;
            --primary-dark: #4c60d3;
            --secondary: #f7fafc;
            --surface-bg: white;
            --accent: #ff6b6b;
            --text: #2d3748;
            --text-light: #718096; 
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        /* Make asterisks red in labels */
        label {
            color: var(--text);
        }
        
        /* Style asterisks to be red */
        .required-asterisk {
            color: red !important;
            font-weight: bold;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: var(--text);
        }

        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
            transition: grid-template-columns 0.25s ease;
        }

        /* Collapsible sidebar behavior */
        .app-container.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background-color: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 2rem;
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            cursor: pointer;
        }

        .user-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-icon {
            position: relative;
            color: var(--text);
            cursor: pointer;
        }

        .nav-icon .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: var(--accent);
            color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            padding: 0;
            display: none; /* hidden by default; JS will show when count > 0 */
            place-items: center; /* grid centering (when shown) */
            font-size: 10px;
            font-weight: 700;
            line-height: 1; /* rely on grid centering */
            box-sizing: border-box;
            border: 1px solid #fff; /* thinner ring */
            box-shadow: 0 1px 2px rgba(0,0,0,0.12);
            transform: translate(0, 0.5px); /* slight optical nudge */
            text-align: center;
            font-variant-numeric: tabular-nums; /* more even digit centering */
        }

        /* Categories Navigation */
        .categories-nav {
            grid-column: 1 / -1;
            background-color: var(--surface-bg);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            position: sticky;
            top: 60px; /* Adjust based on header height */
            z-index: 15;
        }

        .categories-list-wrapper {
            flex-grow: 1;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0.5rem 0;

            -webkit-overflow-scrolling: touch;
        }

        .categories-list-wrapper::-webkit-scrollbar {
            display: none;
        }

        .categories-list-wrapper {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .categories-list {
            display: inline-flex;
            gap: 2rem;
            align-items: center;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
            position: relative;
            color: var(--text-light);
            min-width: 60px;
        }

        .category-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            display: block;
            color: var(--text-light);
            transition: color 0.3s ease;
        }

        .category-item:hover,
        .category-item.active {
            color: var(--primary);
        }

        .category-item.active {
            transform: scale(1.1);
        }

        .category-item.active i {
            color: var(--primary);
        }

        .category-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            width: 80%;
            height: 2px;
            background-color: var(--primary);
            border-radius: 1px;
            transition: width 0.3s ease, left 0.3s ease;
        }

        .category-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background-color: var(--accent);
            border-radius: 1px;
            transition: width 0.3s ease, left 0.3s ease;
        }

        /* New styles for scroll buttons */
        .nav-scroll-btn {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            margin: 0 0.5rem;
            box-shadow: var(--shadow);
        }

        .nav-scroll-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Sidebar */
        .sidebar {
            background-color: white;
            padding: 1.5rem;
            border-right: 1px solid var(--border);
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            overflow-y: auto;
            transition: padding 0.25s ease, border-color 0.25s ease;
        }

        .sidebar.collapsed {
            padding: 0;
            border-color: transparent;
            overflow: hidden;
        }

        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
        }

        .filter-reset {
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
        }

        .filter-option input {
            margin-right: 0.75rem;
            accent-color: var(--primary);
        }

        .filter-option label {
            font-size: 0.9rem;
            color: var(--text);
        }

        .range-slider {
            width: 100%;
            height: 4px;
            margin: 1rem 0;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 2px;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--primary);
            cursor: pointer;
        }

        .price-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* New Advanced Filters Section */
        .advanced-filters {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.show {
            display: block;
        }

        .date-picker {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .date-picker input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .region-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .trending-section {
            margin-top: 2rem;
        }

        .trending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .trending-tag {
            padding: 0.5rem 0.75rem;
            background-color: var(--secondary);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trending-tag:hover {
            background-color: #e6e9ff;
            color: var(--primary);
        }

        .trending-tag.active {
            background-color: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
        }
        
        .profile-content {
            padding: 2rem;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 900px;
            margin: 0 auto;
        }


        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .results-count {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .view-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sort-select {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: white;
            font-size: 0.9rem;
            color: var(--text);
        }

        /* Removed legacy List/Map toggle and legacy map UI styles (replaced by new FA segmented toggle and #map-view) */

        .vendor-grid {
            display: grid;
            gap: 1.5rem;
            align-items: stretch;
            width: 100%;
        }
        
        /* Mobile: 1 column below 600px */
        @media (max-width: 599px) {
            .vendor-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        /* Small Tablet: 2 columns from 600px to 899px */
        @media (min-width: 600px) and (max-width: 899px) {
            .vendor-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.25rem;
            }
        }
        
        /* Medium Tablet/Small Desktop: 3 columns from 900px to 1199px */
        @media (min-width: 900px) and (max-width: 1199px) {
            .vendor-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
        }
        
        /* Large Desktop: 4 columns at 1200px and above */
        @media (min-width: 1200px) {
            .vendor-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
        }

        .vendor-card {
            background-color: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: none;
            transition: transform .35s cubic-bezier(0.22, 1, 0.36, 1), box-shadow .35s cubic-bezier(0.22, 1, 0.36, 1), border-color .35s ease;
            border: none;
            transform: translateY(0) scale(1);
            will-change: transform, box-shadow;
            outline: none;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .vendor-card:hover {
            transform: translateY(-6px) scale(1.015);
            box-shadow: none;
            border-color: transparent;
            outline: none;
        }

        .vendor-image {
            /* Maintain consistent visual proportions across grid sizes */
            aspect-ratio: 4 / 3;
            height: auto;
            background: transparent;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            line-height: 0; /* remove inline image baseline gap */
            overflow: hidden;
            flex: 0 0 auto;
        }

        /* Smooth image zoom on hover */
        .vendor-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block; /* ensure no gap under image */
            position: absolute;
            inset: 0;
            transform: scale(1);
            transition: transform .6s cubic-bezier(0.22, 1, 0.36, 1);
            will-change: transform;
        }
        .vendor-card:hover .vendor-image img {
            transform: scale(1.06);
        }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .vendor-card,
            .vendor-card:hover,
            .vendor-image img,
            .vendor-card:hover .vendor-image img {
                transition: none !important;
                transform: none !important;
            }
        }

        .vendor-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block; /* ensure no gap under image (duplicate rule section) */
        }

        .vendor-card:hover .vendor-image img {
            transform: scale(1.05);
        }

        /* Map view container and toggle */
        /* Map + list two-column layout (mirrors booking vendors step) */
        .results-two-col {
            display: flex;
            gap: 2rem;
            align-items: stretch;
            flex-direction: column; /* default: list view keeps one column */
        }
        .results-two-col .results-left { flex: 1; min-width: 0; }
        .results-two-col .results-right { flex: 1; min-width: 0; position: relative; }
        /* When map is active, switch to two columns */
        body.map-active .results-two-col { flex-direction: row; }
        /* Make map larger than cards in map view */
        body.map-active .results-two-col .results-left { flex: 0 0 30%; }
        body.map-active .results-two-col .results-right { flex: 1 0 70%; }
        @media (max-width: 900px) {
            body.map-active .results-two-col { flex-direction: column; }
            body.map-active .results-two-col .results-left,
            body.map-active .results-two-col .results-right { flex: 1 0 auto; }
        }

        /* Map view container */
        #map-view {
            display: none; /* hidden by default in list view */
            width: 100%;
            height: 720px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        /* Show map only in map view */
        body.map-active #map-view { display: block; }
        /* Removed legacy .map-toolbar and .btn-map-toggle styles */

        /* Map-active: make left panel scrollable to align with map height */
        body.map-active .results-left {
            max-height: 720px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* Fix vendor list positioning to align with map bottom */
        body.map-active #vendor-horizontal-cards {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }
        
        /* Ensure service tabs don't push content down */
        body.map-active #service-tabs-container {
            flex-shrink: 0;
            margin-bottom: 0.5rem;
        }

        /* Compact horizontal cards specifically in Map view */
        body.map-active .vendor-horizontal-container { gap: 0.75rem; }
        body.map-active .vendor-horizontal-card { min-height: 200px; border-radius: 12px; }
        body.map-active .vendor-card-image-container { width: 45%; height: 260px; flex: 0 0 45%; }
        body.map-active .vendor-card-image { width: 100%; height: 100%; }
        body.map-active .vendor-no-image { width: 100%; height: 100%; }
        body.map-active .vendor-card-content { padding: 1rem; }
        body.map-active .vendor-card-name { font-size: 1rem; }
        body.map-active .vendor-card-distance { font-size: 0.8rem; }
        body.map-active .vendor-card-services .service-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
        body.map-active .vendor-card-pricing .price { font-size: 0.95rem; }
        /* Card highlight states for map/list sync */
        .vendor-card.map-hover,
        .vendor-card.map-active {
            outline: none;
            background: #f6f8ff;
        }

        .vendor-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: #5e72e4;
            padding: 0.4rem 0.8rem;
            border-radius: 25px;
            font-size: 0.75rem;
            font-weight: 700;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .vendor-favorite {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .vendor-favorite:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }

        .vendor-favorite.active {
            color: var(--accent);
        }

        .vendor-details {
            padding: 1.5rem;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .vendor-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #1a202c;
            line-height: 1.3;
        }

        .vendor-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            color: #64748b;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .vendor-features {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #5e72e4;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #475569;
            font-weight: 500;
        }

        .feature-icon {
            color: #5e72e4;
            font-size: 1rem;
        }

        .price-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
        }

        .price-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-light);
        }

        .price-dot.filled {
            background-color: var(--primary);
        }

        .vendor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: none;
            margin-top: auto;
        }

        .vendor-price {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .vendor-price span {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text-light);
        }

        .vendor-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* New actions column styles */
        .vendor-actions-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            gap: 1rem;
            border-left: none;
            background: #f9fafb;
            min-width: 80px;
        }

        .vendor-eye-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5e72e4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .vendor-eye-icon:hover {
            background: #4c63d2;
            transform: scale(1.1);
        }

        .vendor-checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vendor-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .vendor-checkbox.checked {
            background: #5e72e4;
            border-color: #5e72e4;
            color: white;
        }

        .vendor-checkbox:hover {
            border-color: #9ca3af;
        }

        .vendor-checkbox.checked:hover {
            background: #4c63d2;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(94, 114, 228, 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            border: 1px solid var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4a5acf;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 3rem;
            gap: 0.5rem;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text);
        }

        .page-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .page-btn.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Booking Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideUp 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            will-change: transform, opacity;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }
        /* Booking modal uses dashboard background/theme without affecting other modals */
        #booking-modal .modal-body {
            background-color: var(--secondary);
            padding: 2rem; /* match dashboard spacing */
        }
        #booking-modal .modal-header {
            background-color: #ffffff;
            border-bottom: 1px solid var(--border);
        }
        #booking-modal .modal-header h3 {
            color: var(--text-light);
            font-weight: 600;
        }
        /* Card look for progress and step sections to mirror dashboard cards */
        #booking-modal .booking-progress,
        #booking-modal .booking-step {
            background-color: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        #booking-modal .booking-progress { padding: 1rem; }
        #booking-modal .booking-step { padding: 1.5rem; }

        .close-modal {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Vendor registration modal uses the same dashboard theme */
        #vendor-registration-modal .modal-content {
            background-color: var(--secondary) !important;
            max-width: 1400px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto; /* match booking modal container scroll */
        }
        #vendor-registration-modal .modal-body {
            background-color: var(--secondary) !important;
            padding: 2.5rem 3rem; /* generous padding for questionnaire */
            min-height: 0; /* match dashboard/booking overrides */
            max-height: none; /* remove global cap */
            height: auto;
            overflow-y: visible; /* let container handle scrolling */
        }
        #vendor-registration-modal .modal-header {
            background-color: #ffffff;
            border-bottom: 1px solid var(--border);
        }
        /* Progress area card */
        #vendor-registration-modal .modal-body > div:first-child {
            background-color: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            margin-bottom: 2rem; /* preserve spacing */
        }
        /* Each setup step as a dashboard-style card */
        #vendor-registration-modal .setup-step {
            background-color: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem; /* create separation from background */
        }

        .close-modal:hover {
            color: var(--primary);
        }
        
        .vendor-profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding-bottom: 2rem;
        }

        .vendor-profile-info {
            flex-grow: 1;
        }
        
        /* Vendor Profile Image Gallery Layout */
        .image-gallery {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 900px;
            height: 400px;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 2rem;
            background-color: transparent;
        }

        /* Left side: large image */
        .image-gallery > .gallery-item.large-image {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }

        /* Right side: 2x2 grid for thumbnails */
        .image-gallery > .thumbnails-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            width: 100%;
            height: 100%;
        }

        .thumbnails-container > .gallery-item {
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }

        .gallery-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background-color: transparent; /* Transparent background */
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            border-radius: var(--radius);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-radius: var(--radius);
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .see-all-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            border-radius: var(--radius);
        }

        .gallery-item:hover .see-all-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        
        
        /* Lightbox Modal Styles */
        .lightbox-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: var(--radius);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            font-size: 2rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: var(--radius);
            transition: background-color 0.2s;
        }

        .lightbox-nav:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .lightbox-prev {
            left: -60px;
        }

        .lightbox-next {
            right: -60px;
        }

        /* Services Section */
        .services-section {
            margin-top: 2rem;
        }

        .services-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .service-category {
            margin-bottom: 2rem;
        }

        .category-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .service-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .service-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .service-name {
            font-weight: 600;
        }

        .service-description {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .service-price {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .service-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Predefined Service Cards */
        .predefined-service-card {
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            /* Default flexible sizing */
            box-sizing: border-box;
            align-self: flex-start;
        }

        /* Ensure 2-per-row grid layout for vendor selected services */
        #vendor-services-grid {
            display: grid;
            /* Wider, comfortable cards in two columns */
            grid-template-columns: repeat(2, minmax(380px, 1fr));
            gap: 1rem;
            align-items: start;
            /* Make sure this child of #predefined-services-grid spans full width */
            grid-column: 1 / -1;
            justify-self: stretch;
            width: 100%;
        }
        #vendor-services-grid .predefined-service-card,
        #vendor-services-grid .add-service-card {
            width: 100%;
            max-width: 100%;
            min-width: 0;
        }

        /* Responsive: fall back to single column on narrow viewports */
        @media (max-width: 840px) {
            #vendor-services-grid {
                grid-template-columns: 1fr;
            }
        }

        .predefined-service-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .predefined-service-card.selected {
            border-color: var(--primary);
            background-color: #f8faff;
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.1);
        }


        .service-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .service-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text);
            margin: 0;
            line-height: 1.3;
        }

        .service-card-check {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 1rem;
            background-color: #f1f5f9;
            color: #64748b;
            font-size: 0.85rem;
        }

        .predefined-service-card.selected .service-card-check {
            background-color: #22c55e;
            color: white;
        }
        
        .remove-service-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
        
        .remove-service-btn:hover {
            background-color: #fee2e2;
            color: #ef4444;
        }

        .service-card-description {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .service-card-details {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .service-card-duration {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .vendor-customization-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--secondary);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .predefined-service-card.selected .vendor-customization-form {
            display: block;
        }

        .form-row-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group-inline {
            margin: 0;
        }

        .form-group-inline label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .form-group-inline input,
        .form-group-inline textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            background-color: white;
        }

        .form-group-inline textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* New Booking Calendar Section */
        .booking-calendar-section {
            margin: 2rem 0;
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        #booking-calendar {
            background-color: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .time-slot {
            padding: 0.75rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot:hover {
            background-color: #e6e9ff;
            color: var(--primary);
        }

        .time-slot.selected {
            background-color: var(--primary);
            color: white;
        }

        .time-slot.unavailable {
            background-color: #f1f5f9;
            color: var(--text-light);
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* New Reviews Section */
        .reviews-section {
            margin: 2rem 0;
        }

        .reviews-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .review-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .reviewer {
            font-weight: 600;
        }

        .review-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .review-rating {
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .review-text {
            line-height: 1.6;
        }

        .add-review-btn {
            margin-top: 1rem;
        }

        /* New Review Form */
        .review-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }

        .rating-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .rating-star {
            font-size: 1.5rem;
            color: #e2e8f0;
            cursor: pointer;
        }

        .rating-star.selected {
            color: #fbbf24;
        }

        .review-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            min-height: 100px;
        }
        
        .chat-modal .modal-content {
            max-width: 600px;
        }
        
        .chat-modal .modal-body {
            padding: 0;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background-color: white;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            max-width: 80%;
        }

        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-light);
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 0.75rem;
            border-radius: var(--radius);
            display: inline-block;
        }

        .sent .message-content {
            background-color: var(--primary);
            color: white;
        }

        .received .message-content {
            background-color: var(--secondary);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-right: 0.5rem;
        }

        /* New Payment Section */
        .payment-section {
            margin: 2rem 0;
        }

        .payment-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .payment-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            position: relative;
        }

        /* Make selects look consistent with inputs */
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: white;
            font-size: 0.9rem;
            /* Remove native styling for consistency */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Custom dropdown arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364738b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 16px;
            padding-right: 2.25rem; /* space for arrow */
        }

        /* Consistent focus ring for inputs and selects */
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.12);
        }

        .form-group {
            position: relative;
        }


        /* Location suggestions dropdown */
        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .location-suggestion-item, .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            font-size: 14px;
            color: #333;
        }

        .location-suggestion-item:hover, .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .location-suggestion-item:last-child, .suggestion-item:last-child {
            border-bottom: none;
        }

        /* Fix predefined services styling */
        .service-dropdown-container {
            background: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
            border-radius: var(--radius) !important;
            padding: 1rem !important;
            margin-bottom: 1rem !important;
        }

        .service-dropdown-container select {
            border: 1px solid var(--border) !important;
            background: white !important;
        }

        .selected-service-item {
            background: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
            border-radius: var(--radius) !important;
            padding: 1rem !important;
            margin-bottom: 0.5rem !important;
        }

        .budget-range-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .budget-range-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .card-element {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        /* Booking confirmation */
        .booking-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
        }

        /* Location permission modal */
        .location-permission {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
            text-align: center;
        }

        .location-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(94, 114, 228, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }

        /* Profile Modal Styles */
        .profile-modal .modal-content {
            max-width: 400px;
        }

        .profile-modal .modal-body {
            padding: 20px;
        }

        .profile-modal input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background-color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2rem;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        /* Ensure proper scrolling when dashboard is inside the modal */
        #dashboard-modal .dashboard-container {
            height: 100%;
            min-height: 0;
        }
        #dashboard-modal .modal-content { overflow: hidden; }
        #dashboard-modal .dashboard-content {
            height: 100%;
            min-height: 0; /* allow child to compute height within modal */
            overflow-y: auto;
            overflow-x: hidden; /* prevent horizontal scroll within modal content */
            padding-bottom: 2.5rem; /* ensure bottom fields are not clipped */
        }
        #dashboard-modal .dashboard-sidebar {
            overflow-y: auto;
            max-height: 100%;
        }
        #dashboard-modal .modal-body {
            min-height: 0; /* critical for flex children to allow inner scroll */
            max-height: none; /* remove global modal-body max-height cap */
            height: auto;
        }

        .dashboard-sidebar {
            background-color: white;
            border-right: 1px solid var(--border);
            padding: 1.5rem;
        }

        .dashboard-menu {
            list-style: none;
            margin-top: 2rem;
        }

        /* Group headings for unified Client/Vendor menu */
        .dashboard-menu .menu-heading {
            margin: 1rem 0 0.5rem;
            padding: 0 0.5rem;
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: default;
        }

        .dashboard-menu li {
            margin-bottom: 0.5rem;
        }

        .dashboard-menu a {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.2s;
        }
        .dashboard-menu a:link,
        .dashboard-menu a:visited {
            color: var(--text-light) !important;
        }
        .dashboard-menu a i {
            width: 1.1rem;
            text-align: center;
            font-size: 0.95rem;
            color: inherit;
        }
        .dashboard-menu a.active i { color: #fff !important; }

        .dashboard-menu a,
        .dashboard-menu a:link,
        .dashboard-menu a:visited { color: var(--text-light) !important; }
        .dashboard-menu a .fa,
        .dashboard-menu a .fas,
        .dashboard-menu a .far,
        .dashboard-menu a .fal,
        .dashboard-menu a .fab,
        .dashboard-menu a i,
        .dashboard-menu a svg { color: var(--text-light) !important; fill: var(--text-light) !important; }

        .dashboard-menu a:not(.active):hover {
            background-color: var(--secondary);
            color: var(--text) !important;
        }
        .dashboard-menu a:not(.active):hover .fa,
        .dashboard-menu a:not(.active):hover .fas,
        .dashboard-menu a:not(.active):hover .far,
        .dashboard-menu a:not(.active):hover .fal,
        .dashboard-menu a:not(.active):hover .fab,
        .dashboard-menu a:not(.active):hover i,
        .dashboard-menu a:not(.active):hover svg { color: var(--text) !important; fill: var(--text) !important; }

        .dashboard-menu a.active,
        .dashboard-menu a.active:link,
        .dashboard-menu a.active:visited {
            background-color: var(--primary);
            color: #fff !important;
            opacity: 1 !important;
        }
        .dashboard-menu a.active .fa,
        .dashboard-menu a.active .fas,
        .dashboard-menu a.active .far,
        .dashboard-menu a.active .fal,
        .dashboard-menu a.active .fab,
        .dashboard-menu a.active i,
        .dashboard-menu a.active svg { color: #fff !important; fill: #fff !important; }
        .dashboard-menu a.active * { color: #fff !important; fill: #fff !important; }

        .dashboard-content {
            padding: 2rem;
            background-color: var(--secondary);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .dashboard-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            overflow: hidden; /* clip inner content to rounded corners */
        }

        .dashboard-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Dashboard text color normalization to dark grey within modal */
        #dashboard-modal { --text: #475569; color: var(--text) !important; }
        #dashboard-modal .dashboard-container,
        #dashboard-modal .dashboard-container h1,
        #dashboard-modal .dashboard-container h2,
        #dashboard-modal .dashboard-container h3,
        #dashboard-modal .dashboard-container h4,
        #dashboard-modal .dashboard-container h5,
        #dashboard-modal .dashboard-container h6,
        #dashboard-modal .dashboard-container p,
        #dashboard-modal .dashboard-container .booking-day,
        #dashboard-modal .dashboard-container .booking-client-name,
        #dashboard-modal .dashboard-container .notification-title,
        #dashboard-modal .dashboard-container .vendor-title,
        #dashboard-modal .dashboard-container .preview-name,
        #dashboard-modal .dashboard-container .btn-danger,
        #dashboard-modal .dashboard-container .dropdown-header h5,
        #dashboard-modal .dashboard-container .profile-dropdown .header .info .name,
        #dashboard-modal .dashboard-container .profile-dropdown .menu a { color: var(--text) !important; }
        #dashboard-modal .dashboard-container .profile-dropdown .menu a:hover { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:#111827"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:#1f2937"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: #111827"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: #1f2937"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:#374151"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: #374151"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:#000"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:#000000"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: #000"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: #000000"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:black"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: black"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: rgb(0, 0, 0)"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:rgb(0,0,0)"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: rgb(17, 24, 39)"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:rgb(17,24,39)"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: rgb(31, 41, 55)"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:rgb(31,41,55)"] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: rgb(17 24 39 / "] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:rgb(17 24 39 / "] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color: rgb(31 41 55 / "] { color: var(--text) !important; }
        #dashboard-modal .dashboard-container [style*="color:rgb(31 41 55 / "] { color: var(--text) !important; }
        #dashboard-modal #dashboard-title,
        #dashboard-modal .dashboard-card-title,
        #dashboard-modal .dashboard-sidebar .logo,
        #dashboard-modal .dashboard-sidebar .logo * { color: var(--text) !important; }
        #dashboard-modal .modal-header h3 { color: var(--text) !important; }

        /* New Booking Interface Styles */
        .booking-header {
            margin-bottom: 1.5rem;
        }

        .booking-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .booking-tab {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .booking-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .booking-tab:hover {
            color: #3b82f6;
        }

        .booking-tab-content {
            display: none;
        }

        .booking-tab-content.active {
            display: block;
        }

        .booking-count {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .booking-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px; /* reduced from 12px */
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start; /* top align to reduce perceived whitespace */
            gap: 10px; /* reduced from 12px */
            transition: all 0.2s ease;
        }

        .booking-item:hover {
            border-color: #d1d5db;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .booking-date-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            align-self: stretch;
            text-align: center;
            min-width: 60px; /* reduced from 72px */
            padding-right: 12px; /* space from divider */
            margin-right: 12px;  /* space before content */
            border-right: 1px solid #e5e7eb; /* subtle divider */
        }

        .booking-month {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .booking-day {
            font-size: 30px; /* reduced from 36px */
            font-weight: 800;
            color: #111827;
            line-height: 1;
            margin-bottom: 2px; /* reduced from 4px */
        }

        .booking-weekday {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: capitalize;
        }

        .booking-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px; /* reduced from 4px */
        }

        .booking-time-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .booking-time {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .booking-client {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .booking-client-name {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .booking-service-row {
            margin-bottom: 2px;
        }

        .booking-service {
            font-size: 14px;
            color: #6b7280;
        }

        .booking-price-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .booking-price {
            font-size: 14px;
            color: #059669;
            font-weight: 600;
        }

        .booking-location-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .booking-location {
            font-size: 14px;
            color: #6b7280;
        }

        /* Vendor request details inside booking-item (more specific to avoid conflicts) */
        .booking-item.has-details { align-items: flex-start; flex-wrap: wrap; }
        .booking-item .request-details {
            display: grid;
            grid-template-columns: repeat(2, minmax(240px, 1fr)); /* slightly tighter */
            gap: 6px 20px; /* reduced gaps */
            margin: 8px 0 0 0; /* reduced from 10px */
            border-top: 1px solid var(--border);
            padding-top: 8px; /* reduced from 12px */
            width: 100%;
            flex-basis: 100%;
        }
        .booking-item .request-details.collapsed { display: none; }
        .booking-item .booking-info {
            align-self: center; /* center middle column vertically */
        }
        .booking-item .booking-actions {
            margin-left: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px; /* reduced from 8px */
            align-self: stretch; /* make actions column match row height */
        }
        .booking-item .actions-row { margin-top: auto; }
        .request-status-badge .dot-new {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #3b82f6;
            border-radius: 9999px;
            margin-left: 8px;
        }
        .booking-item .request-detail-row {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 6px 12px;
            align-items: baseline;
            margin: 0;
        }
        .booking-item .request-detail-label {
            color: #6b7280;
            font-weight: 500;
            font-size: .875rem;
        }
        .booking-item .request-detail-value {
            color: #6b7280;
            font-weight: 600;
            font-size: .875rem;
        }
        @media (max-width: 920px) {
            .booking-item .request-details { grid-template-columns: 1fr; }
            .booking-item .request-detail-row { grid-template-columns: 140px 1fr; }
        }

        .link-btn {
            background: none;
            border: none;
            padding: 0;
            color: #3b82f6;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .link-btn:hover { text-decoration: underline; }

        .request-status {
            text-transform: capitalize;
            font-weight: 500;
        }

        .request-status.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .request-status.approved {
            background: #d1fae5;
            color: #059669;
        }

        .request-status.declined {
            background: #fee2e2;
            color: #dc2626;
        }

        .request-status.expired {
            background: #f3f4f6;
            color: #6b7280;
        }

        .booking-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .link-btn {
            background: transparent;
            border: none;
            color: #3b82f6;
            padding: 4px 8px; /* reduced from 8x12 */
            border-radius: 6px; /* reduced from 8px */
            font-size: 13px; /* reduced from 14px */
            font-weight: 500;
            cursor: pointer;
        }
        .link-btn:hover { text-decoration: underline; }

        .btn-accept {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px; /* reduced from 8x16 */
            border-radius: 8px;
            font-size: 13px; /* reduced from 14px */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-accept:hover {
            background: #059669;
        }

        .btn-decline {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px; /* reduced from 8x16 */
            border-radius: 8px;
            font-size: 13px; /* reduced from 14px */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-decline:hover {
            background: #dc2626;
        }

        .btn-pay-now {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-pay-now:hover {
            background: #2563eb;
        }

        .btn-paid {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: default;
        }

        .booking-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-declined {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-paid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .payment-status {
            color: var(--success);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-toast {
            animation: slideIn 0.3s ease;
        }

        @keyframes bannerSlideDown {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .app-banner {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 900px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            background: #ffffff;
            color: var(--text);
            z-index: 10002;
            animation: bannerSlideDown .2s ease;
        }
        .app-banner--success { border-color: #10b98133; background: #ecfdf5; color: #065f46; }
        .app-banner--error { border-color: #ef444433; background: #fef2f2; color: #991b1b; }
        .app-banner--info, .app-banner--notice { border-color: #3b82f633; background: #eff6ff; color: #1e40af; }
        .app-banner__title { font-weight: 600; }
        .app-banner__icon { display: inline-flex; width: 20px; height: 20px; align-items: center; justify-content: center; }
        .app-banner__close {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            color: inherit;
        }

        /* Notifications Modal Styles */
        .notification-tab {
            transition: all 0.2s ease;
        }

        .notification-tab:hover {
            background-color: #f3f4f6;
        }

        .notification-tab.active {
            background-color: var(--primary);
            color: white;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background-color: #f9fafb;
        }

        .notification-item.unread {
            background-color: #eff6ff;
            border-left: 4px solid var(--primary);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #1f2937;
        }

        .notification-message {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .notification-type {
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .notification-type.booking {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .notification-type.message {
            background-color: #d1fae5;
            color: #065f46;
        }

        .notification-type.general {
            background-color: #f3f4f6;
            color: #374151;
        }

        .empty-notifications {
            padding: 3rem 2rem;
            text-align: center;
            color: #6b7280;
        }

        .empty-notifications i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }

        /* Notifications Dropdown Styles */
        .notifications-dropdown {
            position: absolute;
            width: 380px;
            max-height: 500px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            overflow: hidden;
            animation: dropdownFadeIn 0.2s ease-out;
            display: none;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }

        .dropdown-header h3 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
        }

        .dropdown-header .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-header .btn:hover {
            background: var(--primary-dark);
        }

        .notification-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }

        .notification-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .notification-tab:hover {
            background: #f9fafb;
            color: #374151;
        }

        .notification-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .notifications-dropdown .notifications-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .notifications-dropdown .notification-item {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .notifications-dropdown .notification-item:last-child {
            border-bottom: none;
        }

        .notifications-dropdown .notification-item:hover {
            background-color: #f9fafb;
        }

        .notifications-dropdown .notification-item.unread {
            background-color: #eff6ff;
            border-left: 3px solid var(--primary);
        }

        .dropdown-footer {
            padding: 0.75rem 1.25rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            text-align: center;
        }

        .view-all-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .view-all-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        .loading-notifications {
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }

        /* Position dropdown relative to notification buttons */
        .nav-icon {
            position: relative;
        }

        /* Profile Dropdown Styles */
        .profile-dropdown {
            position: absolute;
            width: 280px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: none;
            z-index: 10000;
            overflow: hidden;
            animation: dropdownFadeIn 0.2s ease-out;
            display: none;
        }
        .profile-dropdown::before,
        .profile-dropdown::after {
            content: '';
            position: absolute;
            top: -8px;
            left: var(--arrow-left, calc(100% - 28px));
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
        }
        .profile-dropdown::before {
            border-bottom: 8px solid #e5e7eb; /* border color */
            top: -9px;
        }
        .profile-dropdown::after {
            border-bottom: 8px solid #ffffff; /* fill color */
        }
        .profile-dropdown .header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1rem;
            border-bottom: none;
            background: #ffffff;
            justify-content: flex-start;
        }

        /* Ensure no shadows appear anywhere inside the profile dropdown */
        .profile-dropdown,
        .profile-dropdown *,
        .profile-dropdown::before,
        .profile-dropdown::after {
            box-shadow: none !important;
            filter: none !important;
            text-shadow: none !important;
        }
        .profile-dropdown .header .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-weight: 700;
        }
        .profile-dropdown .header .info {
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .profile-dropdown .header .info .name {
            font-weight: 600;
            color: #111827;
        }
        .profile-dropdown .header .info .email {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .profile-dropdown .menu {
            list-style: none;
            margin: 0;
            padding: 0.25rem 0;
        }
        .profile-dropdown .menu li.divider {
            border-top: 1px solid #f3f4f6;
            margin: 0.25rem 0;
        }
        .profile-dropdown .menu a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            color: #111827;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.05s ease;
        }
        .profile-dropdown .menu a i {
            width: 18px;
            text-align: center;
            color: #6b7280;
        }
        .profile-dropdown .menu a:hover {
            background: #f9fafb;
            color: #111827;
            transform: translateY(-1px);
        }
        .profile-dropdown .menu a.logout {
            color: #dc2626;
        }
        .profile-dropdown .menu a.logout i {
            color: #dc2626;
        }
        .profile-dropdown .menu a.logout:hover {
            background: #fee2e2;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .notifications-dropdown {
                width: 320px;
                max-height: 400px;
            }
        }

        .booking-info {
            flex: 1;
        }

        .booking-vendor {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .booking-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .booking-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-confirmed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Vendor Dashboard Styles */
        .vendor-dashboard-card {
          background-color: white;
          border-radius: var(--radius);
          padding: 1.5rem;
          margin-bottom: 1.5rem;
          box-shadow: var(--shadow);
        }

        /* Pending Request Card - Theme Aligned */
        .request-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1rem .75rem 1rem;
            margin: .75rem 0 1rem 0;
            box-shadow: var(--shadow);
        }
        .request-card .request-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: .5rem;
        }
        .request-card .request-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .request-status-text { color: var(--text-light); font-size: .85rem; }
        .request-subheader { color: var(--text-light); font-size: .85rem; margin-top: .25rem; }
        .request-meta { display:flex; gap:.85rem; flex-wrap:wrap; margin-top:.35rem; color:var(--text-light); font-size:.85rem; }
        .request-meta span + span { position: relative; padding-left:.9rem; }
        .request-meta span + span::before { content:"\2022"; position:absolute; left:.2rem; color:#94a3b8; }
        .request-details {
            display: grid;
            grid-template-columns: repeat(2, minmax(320px, 1fr));
            gap: .5rem 2rem;
            margin: .75rem 0 .9rem 0;
        }
        .request-detail-row { display:grid; grid-template-columns: 160px 1fr; gap:.5rem; align-items: baseline; }
        .request-detail-label { color: var(--text-light); font-size:.85rem; }
        .request-detail-value { color: var(--text); font-weight: 600; font-size:.95rem; }
        .request-actions { display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid var(--border); padding-top:.7rem; }
        .btn {
            border-radius: 8px;
            padding: .45rem .8rem;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all .2s ease;
        }
        .request-actions .btn { width:auto; }
        .btn-success { background: var(--primary); color:#fff; box-shadow: 0 3px 8px rgba(59,130,246,.15); }
        .btn-success:hover { filter: brightness(0.97); }
        .btn-danger { background:#ffffff; color:#111827; border-color:#d1d5db; }
        .btn-danger:hover { background:#f9fafb; }
        
        @media (max-width: 920px) {
          .request-details { grid-template-columns: 1fr; }
          .request-detail-row { grid-template-columns: 140px 1fr; }
          .request-actions { justify-content: flex-start; }
        }

        /* Service Tabs Styles */
        .service-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: none;
            margin-bottom: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .service-tabs::-webkit-scrollbar {
            display: none;
        }
        
        /* Tab Navigation Buttons */
        .tab-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .tab-nav-btn:hover {
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .tab-nav-left {
            left: -16px;
        }
        
        .tab-nav-right {
            right: -16px;
        }
        
        .service-tab {
            padding: 0.75rem 1.5rem;
            background: #f8faff;
            border: 1px solid #e3f2fd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .service-tab:hover {
            background: #e3f2fd;
            color: var(--text);
        }
        
        .service-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .service-tab .vendor-count {
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        .service-tab.active .vendor-count {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Service Tags Styles */
        .vendor-services-offered {
            margin-top: 0.75rem;
        }

        .service-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .service-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Vendor Map and Horizontal Cards Styles */
        .vendor-horizontal-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .vendor-horizontal-card {
            display: grid;
            grid-template-columns: 45% 1fr auto; /* image, content, actions column */
            background: white;
            border-radius: 16px;
            border: none;
            overflow: hidden;
            transition: none;
            box-shadow: none;
            outline: none;
            position: relative;
            width: 100%;
            min-height: 240px;
            align-items: stretch;
            column-gap: 0; /* flush image against content like screenshot */
        }

        .vendor-horizontal-card:hover {
            box-shadow: none;
            transform: none;
            border-color: transparent;
            outline: none;
        }

        .vendor-horizontal-card.selected {
            border: none;
            box-shadow: none;
        }

        .vendor-horizontal-card:focus,
        .vendor-horizontal-card:active,
        .vendor-horizontal-card:focus-visible {
            outline: none;
            box-shadow: none;
            border: none;
        }

        .vendor-card-image-container {
            /* In grid, take full width and maintain aspect ratio */
            width: 100%;
            aspect-ratio: 4 / 3;
            position: relative;
            overflow: hidden;
            border: none;
            background: transparent;
        }

        .vendor-image-carousel {
            display: flex;
            transition: transform 0.3s ease;
            height: 100%;
            width: 100%;
        }

        .vendor-card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block; /* remove inline-gap */
            flex: 0 0 100%; /* each slide equals container width */
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border: none;
            outline: none;
        }

        .vendor-no-image {
            width: 100%;
            height: 100%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .carousel-dots {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 2;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            z-index: 2;
        }

        .carousel-nav:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-50%) scale(1.1);
        }

        .vendor-card-image-container:hover .carousel-nav {
            opacity: 1;
        }

        .carousel-nav.prev {
            left: 8px;
        }

        .carousel-nav.next {
            right: 8px;
        }

        .vendor-card-content {
            flex: 1 1 auto;
            padding: 1rem 1rem 1rem 1rem; /* even padding, relies on no column gap */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* consistent vertical rhythm to avoid visual overlap */
            justify-content: flex-start; /* avoid stretching sections apart unexpectedly */
            position: relative;
            /* Allow content to shrink properly in flex layout to avoid squishing */
            min-width: 0;
        }

        /* Prevent header squish: allow up to 2 lines for title, keep distance pill fixed */
        .vendor-card-content h4 {
            margin: 0;
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
            display: -webkit-box;
            line-clamp: 2; /* lint: add standard property for compatibility */
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.25;
            max-height: calc(1.25em * 2);
        }

        /* Target the header row inside content (title + distance chip) */
        .vendor-card-content > div:first-child > div {
            /* Override inline flex styles from renderer */
            display: grid !important;
            grid-template-columns: 1fr auto !important; /* title grows, chip fixed */
            justify-content: initial !important;
            align-items: start !important;
            column-gap: 0.5rem;
            row-gap: 0.25rem;
        }

        /* Ensure title grid cell can shrink properly */
        .vendor-card-content > div:first-child > div > h4 {
            min-width: 0;
        }

        /* Keep the distance chip from shrinking */
        .vendor-card-content > div:first-child > div > span {
            flex: 0 0 auto;
        }

        /* Keep action buttons anchored to the bottom of the content column */
        .vendor-card-actions {
            margin-top: auto;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Service pill rows (name left, price right, meta below) */
        .service-pill {
            border: 1px solid #e5e7eb;
            background: #ffffff;
            border-radius: 12px;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-height: 50px;
            box-shadow: 0 1px 0 rgba(17,24,39,0.02);
        }
        .service-pill-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .service-pill-name {
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .service-pill-price {
            color: #6b7280;
            font-weight: 700;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .service-pill-meta {
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .vendor-response-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vendor-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0 0 8px 0;
            line-height: 1.3;
            /* Prevent long unbroken names (e.g., FiveFeetAbove) from squishing layout */
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .vendor-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .vendor-stars {
            color: #f59e0b;
            font-size: 0.875rem;
        }

        .vendor-rating-text {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .vendor-location {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .vendor-description {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.4;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .vendor-service-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .vendor-service-tag {
            background: #e0f2fe;
            color: #0277bd;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .vendor-card-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            justify-content: flex-end;
        }

        .vendor-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .vendor-btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .vendor-btn-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .vendor-btn-primary {
            background: #10b981;
            color: white;
            border: 1px solid #10b981;
        }

        .vendor-btn-primary:hover {
            background: #059669;
            border-color: #059669;
        }

        .vendor-btn-primary {
            background: #10b981;
            color: white;
            border: 1px solid #10b981;
        }

        .vendor-btn-primary:hover {
            background: #059669;
            border-color: #059669;
        }

        .vendor-btn-primary.selected {
            background: #059669;
            border-color: #059669;
        }

        .vendor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .vendor-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .vendor-card-distance {
            font-size: 0.9rem;
            color: var(--text-light);
            background: var(--secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .vendor-card-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .vendor-card-services {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .vendor-service-tag {
            background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .vendor-card-pricing {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .vendor-price-range {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .vendor-select-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vendor-select-btn:hover {
            background: var(--primary);
            color: white;
        }

        .vendor-select-btn.selected {
            background: var(--primary);
            color: white;
        }

        /* Map marker styles */
        .vendor-map-marker {
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .vendor-map-marker.selected {
            background: #27ae60;
        }

        .event-location-marker {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        /* Responsive design for vendor cards */
        @media (max-width: 768px) {
            .vendor-horizontal-card {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .vendor-actions-column {
                flex-direction: row;
                justify-content: center;
                border-left: none;
                border-top: none;
                padding: 0.75rem;
                gap: 2rem;
            }
            
            .vendor-card-image-container {
                width: 100%;
                aspect-ratio: 4 / 3;
                flex: 0 0 auto;
            }
            
            .vendor-card-image {
                width: 100%;
                height: 100%;
            }
            
            .map-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start !important;
            }
            
            .map-controls {
                display: flex;
                gap: 0.5rem;
                width: 100%;
            }
            
            .map-controls button {
                flex: 1;
            }
        }

        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        /* KPI cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        /* Force 2x2 KPI layout when used in dashboard top grid */
        .kpi-grid.two-col { grid-template-columns: repeat(2, 1fr); margin-bottom: 0; }
        .kpi-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(180deg, #ffffff, #f8fafc);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .kpi-icon.bookings { background:#eef2ff; color:#4f46e5; }
        .kpi-icon.reviews { background:#fff7ed; color:#b45309; }
        .kpi-icon.rating { background:#ecfeff; color:#0891b2; }
        .kpi-icon.favorites { background:#f0fdf4; color:#16a34a; }
        .kpi-icon.requests { background:#fef3c7; color:#d97706; }
        .kpi-icon.messages { background:#e0f2fe; color:#0284c7; }
        .kpi-content { display:flex; flex-direction: column; }
        .kpi-value { font-size: 1.6rem; font-weight: 700; line-height: 1; }
        .kpi-label { color: var(--text-light); font-size: 0.9rem; }
        .kpi-card.kpi-click { cursor: pointer; }

        /* Calendar tile inside KPI row */
        .kpi-card.calendar-tile {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0;
            overflow: hidden;
        }
        .kpi-card.calendar-tile.full-height { height: 100%; }
        .calendar-tile .cal-header {
            background: var(--primary);
            color: #fff;
            text-align: center;
            font-weight: 700;
            letter-spacing: .06em;
            text-transform: uppercase;
            padding: 8px 10px;
            font-size: 12px;
        }
        .calendar-tile .cal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 12px 16px;
            gap: 6px;
        }
        .calendar-tile .cal-day {
            font-size: 12px;
            color: var(--text-light);
            letter-spacing: .04em;
        }
        .calendar-tile .cal-date {
            font-size: 40px;
            font-weight: 800;
            line-height: 1;
            color: var(--text);
        }

        /* Dashboard overview layout */
        /* Top stats grid: left 2x2 KPIs, right calendar */
        .vendor-stats.stats-top-grid {
            display: grid;
            grid-template-columns: 2fr 1.2fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: stretch;
        }
        .vendor-stats.stats-top-grid > .calendar-tile { align-self: stretch; }
        @media (max-width: 900px) {
            .vendor-stats.stats-top-grid { grid-template-columns: 1fr; }
        }
        .overview-grid {
            display: grid;
            grid-template-columns: 1fr minmax(320px, 420px);
            gap: 1.25rem;
            align-items: start;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }
        .overview-grid > * { min-width: 0; }
        @media (max-width: 1200px) {
            .overview-grid { grid-template-columns: 1fr; }
        }

        /* Message preview styles */
        .message-preview-list { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 100%; }
        .message-preview-item { display:flex; align-items: center; gap: 12px; padding: 10px 12px; border:1px solid var(--border); border-radius: 10px; background:#fff; transition: background .2s; cursor: pointer; overflow: hidden; width: 100%; max-width: 100%; }
        .message-preview-item:hover { background:#f8fafc; }
        .preview-avatar { width:36px; height:36px; border-radius: 8px; background:#eef2ff; color:#4f46e5; display:flex; align-items:center; justify-content:center; font-weight:700; }
        .preview-content { flex: 1 1 auto; min-width: 0; }
        .preview-name { font-weight:600; color:#111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .preview-snippet { color:#6b7280; font-size: .9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .preview-time { color:#9ca3af; font-size:.8rem; margin-left:8px; white-space: nowrap; flex: 0 0 auto; max-width: 84px; overflow: hidden; text-overflow: ellipsis; }
        #client-recent-messages,
        #vendor-recent-messages { max-width: 100%; overflow-x: hidden; }

        .dashboard-fixed-list { max-height: 360px; overflow-y: auto; }
        .dashboard-fixed-list .empty-state { height: 100%; display:flex; align-items:center; justify-content:center; color: var(--text-light); }

        #upcoming-bookings.dashboard-fixed-list,
        #vendor-recent-bookings.dashboard-fixed-list {
            max-height: 360px;
            overflow-y: auto;
        }

        .dashboard-card-title-row { display:flex; align-items:center; justify-content: space-between; margin-bottom: 1rem; }

        /* Request Management Styles */
        .requests-filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .settings-panels .settings-panel { display: none; }
        .settings-panels .settings-panel.active { display: block; }

        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        /* Categorized Settings Layout */
        .settings-category {
            margin-bottom: 2.5rem;
        }

        .settings-category-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .settings-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .settings-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .settings-card-icon {
            width: 40px;
            height: 40px;
            background: #f7f7f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .settings-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .settings-card-description {
            font-size: 0.875rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Vendor Questionnaire Feature Tiles */
        .questionnaire-category {
            margin-bottom: 2.5rem;
        }

        .questionnaire-category:last-child {
            margin-bottom: 0;
        }

        .questionnaire-category-header {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.625rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .questionnaire-category-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--text);
            flex-shrink: 0;
        }

        .questionnaire-category-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .questionnaire-features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.875rem 2rem;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .questionnaire-features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .questionnaire-features-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }

        .feature-tile {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.5rem 0.875rem;
            border-radius: 6px;
            background: transparent;
            border: 1px solid transparent;
            min-height: 36px;
        }

        .feature-tile:hover {
            background: #f8f9fa;
        }

        .feature-tile.selected {
            background: #f0f4ff;
        }

        .feature-tile-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: var(--text);
            flex-shrink: 0;
        }

        .feature-tile.selected .feature-tile-icon {
            color: var(--primary);
        }

        .feature-tile-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-tile-name {
            font-size: 0.9375rem;
            font-weight: 400;
            color: var(--text);
            margin: 0;
            line-height: 1.4;
            flex: 1;
        }

        .feature-tile.selected .feature-tile-name {
            font-weight: 500;
        }

        .feature-tile-description {
            display: none;
        }

        .feature-tile-checkmark {
            width: 16px;
            height: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .feature-tile.selected .feature-tile-checkmark {
            display: flex;
        }

        @keyframes checkmarkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .questionnaire-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .questionnaire-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Settings Modal */
        .settings-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            animation: fadeIn 0.2s;
        }

        .settings-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-modal {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s;
        }

        .settings-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .settings-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }

        .settings-modal-close:hover {
            color: var(--text);
        }

        .settings-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .settings-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .request-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--border);
            transition: all 0.2s;
        }

        .request-card.pending {
            border-left-color: #f59e0b;
        }

        .request-card.approved {
            border-left-color: #10b981;
        }

        .request-card.declined {
            border-left-color: var(--accent);
        }

        .request-card.expired {
            border-left-color: #6b7280;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .request-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .request-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .request-status.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .request-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }

        .request-status.expired {
            background: #f3f4f6;
            color: #374151;
        }

        .request-timer {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .request-timer.urgent {
            color: var(--accent);
            font-weight: 600;
        }

        .request-details {
            margin-bottom: 1rem;
        }

        .request-detail-row {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .request-detail-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--text);
        }

        .request-detail-value {
            color: var(--text-light);
        }

        .request-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .request-actions .btn {
            flex: 1;
        }

        .requests-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Vendor Registration Form */
        .vendor-registration-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-col {
            flex: 1;
        }

        /* Price indicator styles */
        .price-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
        }

        /* Analytics Chart Styles */
        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        /* Vendor Setup Wizard Styles */
        .step-indicator {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            background-color: var(--secondary);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-indicator.active {
            color: var(--primary);
            background-color: rgba(94, 114, 228, 0.1);
            font-weight: 600;
        }

        .step-indicator.completed {
            color: white;
            background-color: var(--primary);
        }

        .step-indicator .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--text-light);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            line-height: 1;
        }
        .step-indicator .step-label {
            font-weight: 500;
        }

        .setup-step {
            animation: fadeIn 0.3s ease;
        }

        .gallery-item {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            background-color: var(--secondary);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .package-item, .service-item {
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        .package-item h6, .service-item h6 {
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }

        .package-item p, .service-item p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .package-item .price, .service-item .price {
            font-weight: 600;
            color: var(--primary);
            margin-top: 0.5rem;
        }

        .availability-day {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--secondary);
        }

        .availability-day input[type="checkbox"]:checked + strong {
            color: var(--primary);
        }

        .availability-day input[type="time"] {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(100vh);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                height: 90vh;
            }

            .modal-body {
                max-height: calc(90vh - 60px);
            }

            .vendor-detail-header {
                flex-direction: column;
            }

            .vendor-detail-image {
                width: 100%;
                height: 200px;
            }

            .view-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .categories-nav {
                padding: 0.5rem 1rem;
            }

            .category-item {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .dashboard-sidebar {
                display: none;
            }
            
            .profile-content {
                padding: 1rem;
            }
            
            .vendor-profile-header {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Multi-Step Booking Modal Styles */
        .booking-progress {
            margin-bottom: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        .booking-step {
            display: none;
        }

        .booking-step.active {
            display: block;
        }

        .service-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .category-card {
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .category-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .category-card.selected {
            border-color: var(--primary);
            background-color: rgba(94, 114, 228, 0.05);
        }

        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .category-card.selected .category-icon {
            background-color: var(--primary);
            color: white;
        }

        .category-info {
            flex: 1;
        }

        .category-info h5 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .category-info p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .category-checkbox {
            position: relative;
            flex-shrink: 0;
        }

        .category-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .category-checkbox .checkmark {
            position: relative;
            height: 20px;
            width: 20px;
            background-color: white;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: block;
            transition: all 0.2s ease;
        }

        .category-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .category-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .service-category {
            background-color: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .service-category:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .service-checkbox {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            cursor: pointer;
            width: 100%;
        }

        .service-checkbox input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            margin-right: 1rem;
            position: relative;
            transition: all 0.2s ease;
        }

        .service-checkbox input[type="checkbox"]:checked + .checkmark {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .service-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .service-info h5 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text);
        }

        .service-info p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .budget-slider-container {
            position: relative;
            margin: 1rem 0;
        }

        .budget-slider-container input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        .budget-slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .budget-slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        .budget-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Vendor grid responsive styles defined earlier in the file (around line 503) */

        .vendor-card {
            background-color: white;
            border: none;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: none;
            outline: none;
        }

        .vendor-card:hover {
            border-color: transparent;
            box-shadow: none;
            transform: translateY(-8px);
            outline: none;
        }

        .vendor-card:focus,
        .vendor-card:active,
        .vendor-card:focus-visible {
            outline: none;
            box-shadow: none;
            border: none;
            transform: none;
        }

        .vendor-card.selected {
            border: none;
            background-color: rgba(94, 114, 228, 0.02);
            box-shadow: none;
        }

        .vendor-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .vendor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .vendor-info h5 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--text);
        }

        .vendor-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .vendor-services {
            margin-bottom: 1rem;
        }

        .vendor-services h6 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .vendor-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .vendor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-select-vendor {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary);
            background-color: transparent;
            color: var(--primary);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-select-vendor:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-select-vendor.selected {
            background-color: var(--primary);
            color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .request-item {
            background-color: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .request-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .request-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .request-status.approved {
            background-color: #d4edda;
            color: #155724;
        }

        .request-status.declined {
            background-color: #f8d7da;
            color: #721c24;
        }

        .request-status.expired {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .countdown-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .countdown-timer.urgent {
            color: var(--accent);
        }

        .booking-summary-card {
            background-color: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .payment-section {
            background-color: var(--secondary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin: 2rem 0;
            user-select: none;
        }
        .page-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 0 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            color: var(--text);
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, color 0.2s, transform 0.05s;
        }
        .page-btn:hover {
            background: var(--secondary);
        }
        .page-btn:active {
            transform: translateY(1px);
        }
        .page-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
            font-weight: 600;
        }
        .page-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .service-categories {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .booking-progress .step-indicator {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        .booking-progress .step-indicator {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            background-color: var(--secondary);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .booking-progress .step-indicator .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--text-light);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .step-number-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--text-light);
            color: #fff;
            font-weight: 700;
            font-size: 0.95rem;
            line-height: 1;
            margin-right: 0.5rem;
        }
        #booking-modal .step-number-badge { background: var(--text-light); color: #fff; }
        .booking-progress .step-indicator .step-label {
            font-weight: 500;
        }
        .booking-progress .step-indicator.active {
            color: var(--primary);
            background-color: rgba(94, 114, 228, 0.1);
            font-weight: 600;
        }
        .booking-progress .step-indicator.completed {
            color: #fff;
            background-color: var(--primary);
        }
        @media (max-width: 768px) {
            .booking-progress .step-indicator { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
            .booking-progress .step-indicator .step-number { width: 22px; height: 22px; font-size: 0.8rem; }
        }

        /* Messaging Widget Styles */
        .messaging-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 20; /* Above sticky footer */
        }

        .chat-button {
            width: 60px;
            height: 60px;
            background: var(--primary, #007bff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .chat-button i {
            color: white;
            font-size: 24px;
        }

        .widget-message-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid white;
        }

        .widget-container {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid #e1e5e9;
            overflow: hidden;
            display: flex;               /* ensure header + content stack within fixed height */
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .widget-header {
            background: var(--primary, #007bff);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .widget-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .widget-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .widget-view {
            /* fill the space below widget header */
            flex: 1 1 auto;
            min-height: 0;              /* allow inner scroller to shrink */
            display: flex;
            flex-direction: column;
        }

        /* Make sure individual views also allow shrinking */
        #conversations-view {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        #chat-view {
            display: grid;
            grid-template-rows: auto 1fr auto; /* header | messages | input */
            min-height: 0; /* allow middle row to shrink */
        }

        .conversations-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .conversation-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e5e9;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .conversation-search:focus {
            border-color: var(--primary, #007bff);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
        }

        .conversation-item.active {
            background-color: #e3f2fd;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary, #007bff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            color: #1c1e21;
        }

        .conversation-preview {
            font-size: 13px;
            color: #65676b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .conversation-time {
            font-size: 12px;
            color: #65676b;
        }

        .conversation-unread {
            background: var(--primary, #007bff);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;              /* keep header fixed height */
        }

        .back-button {
            background: none;
            border: none;
            color: var(--primary, #007bff);
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: #f0f2f5;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary, #007bff);
        }

        .chat-user-name {
            font-weight: 600;
            font-size: 14px;
            color: #1c1e21;
        }

        .chat-messages-container {
            flex: 1 1 auto;              /* take remaining space between chat header and input */
            min-height: 0;               /* allow to shrink within flex column */
            overflow-y: scroll;          /* always show scroll area */
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .widget-message {
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .widget-message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .widget-message.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .widget-message-content {
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .widget-message.sent .widget-message-content {
            background: var(--primary, #007bff);
            color: white;
        }

        .widget-message.received .widget-message-content {
            background: #f0f2f5;
            color: #1c1e21;
        }

        .widget-message-sender {
            font-size: 12px;
            color: #65676b;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .widget-message-time {
            font-size: 11px;
            color: #65676b;
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;              /* keep input fixed at bottom */
        }

        .widget-chat-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .widget-chat-input:focus {
            border-color: var(--primary, #007bff);
        }

        .widget-send-button {
            width: 36px;
            height: 36px;
            background: var(--primary, #007bff);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .widget-send-button:hover {
            background: var(--primary-dark, #0056b3);
        }

        .widget-send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading-state {
            text-align: center;
            color: #65676b;
            padding: 40px 20px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            color: #65676b;
            padding: 40px 20px;
            font-size: 14px;
        }

        /* Settings Cards Layout */
        .settings-category {
            margin-bottom: 3rem;
        }

        .settings-category-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .settings-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .settings-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* Business Profile Panel Styles */
        .panels-container {
            margin-top: 2rem;
            width: 100%;
        }
        
        .panels-container > [id$="-panel"] {
            width: 100%;
        }

        .settings-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .settings-card-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0;
            color: var(--text);
        }

        .settings-card-description {
            font-size: 0.8rem;
            color: var(--text-light);
            margin: 0;
            line-height: 1.5;
        }

        /* Settings Modal */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        }

        .settings-modal-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: white;
            border-radius: var(--radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .settings-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .settings-modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: color 0.2s;
        }

        .settings-modal-close:hover {
            color: var(--text);
        }

        .settings-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .settings-modal-body .form-group {
            margin-bottom: 1rem;
        }

        .settings-modal-body .form-group:last-child {
            margin-bottom: 0;
        }

        .settings-modal-body label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .settings-modal-body input[type="text"],
        .settings-modal-body input[type="email"],
        .settings-modal-body input[type="tel"],
        .settings-modal-body input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .settings-modal-body input:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .messaging-widget {
                bottom: 10px;
                right: 10px;
            }

            .widget-container {
                width: calc(100vw - 20px);
                height: calc(100vh - 100px);
                bottom: 70px;
                right: -10px;
            }

            .chat-button {
                width: 50px;
                height: 50px;
            }

            .chat-button i {
                font-size: 20px;
            }
        }
    </style>
<style id="googleidentityservice_button_styles">.qJTHM{-moz-user-select:none;color:#202124;direction:ltr;font-family:"Roboto-Regular",arial,sans-serif;font-weight:400;margin:0;overflow:hidden}.ynRLnc{left:-9999px;position:absolute;top:-9999px}.L6cTce{display:none}.bltWBb{word-break:break-all}.hSRGPd{color:#1a73e8;cursor:pointer;font-weight:500;text-decoration:none}.Bz112c-W3lGp{height:16px;width:16px}.Bz112c-E3DyYd{height:20px;width:20px}.Bz112c-r9oPif{height:24px;width:24px}.Bz112c-u2z5K{height:36px;width:36px}.Bz112c-uaxL4e{-moz-border-radius:10px;border-radius:10px}.LgbsSe-Bz112c{display:block}.S9gUrf-YoZ4jf,.S9gUrf-YoZ4jf *{border:none;margin:0;padding:0}.fFW7wc-ibnC6b>.aZ2wEe>div{border-color:#4285f4}.P1ekSe-ZMv3u>div:nth-child(1){background-color:#1a73e8!important}.P1ekSe-ZMv3u>div:nth-child(2),.P1ekSe-ZMv3u>div:nth-child(3){background-image:linear-gradient(to right,rgba(255,255,255,.7),rgba(255,255,255,.7)),linear-gradient(to right,#1a73e8,#1a73e8)!important}.haAclf{display:inline-block}.nsm7Bb-HzV7m-LgbsSe{border-radius:4px;box-sizing:border-box;transition:background-color .218s,border-color .218s;-moz-user-select:none;background-color:#fff;background-image:none;border:1px solid #dadce0;color:#3c4043;cursor:pointer;font-family:"Google Sans",arial,sans-serif;font-size:14px;height:40px;letter-spacing:0.25px;outline:none;overflow:hidden;padding:0 12px;position:relative;text-align:center;vertical-align:middle;white-space:nowrap;width:auto}@media screen and (-ms-high-contrast:active){.nsm7Bb-HzV7m-LgbsSe{border:2px solid windowText;color:windowText}}@media screen and (preferes-contrast:more){.nsm7Bb-HzV7m-LgbsSe{color:#000}}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe{font-size:14px;height:32px;letter-spacing:0.25px;padding:0 10px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe{font-size:11px;height:20px;letter-spacing:0.3px;padding:0 8px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe{padding:0;width:40px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.pSzOP-SxQuSe{width:32px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.purZT-SxQuSe{width:20px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK{border-radius:20px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK.pSzOP-SxQuSe{border-radius:16px}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK.purZT-SxQuSe{border-radius:10px}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc{border:none;color:#fff}.nsm7Bb-HzV7m-LgbsSe.MFS4be-v3pZbf-Ia7Qfc{background-color:#1a73e8}.nsm7Bb-HzV7m-LgbsSe.MFS4be-JaPV2b-Ia7Qfc{background-color:#202124;color:#e8eaed}@media screen and (prefers-contrast:more){.nsm7Bb-HzV7m-LgbsSe.MFS4be-JaPV2b-Ia7Qfc{color:#fff}}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:18px;margin-right:8px;min-width:18px;width:18px}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:14px;min-width:14px;width:14px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{height:10px;min-width:10px;width:10px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin-left:8px;margin-right:-4px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin:0;padding:10px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{padding:8px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c{padding:4px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-top-left-radius:3px;border-bottom-left-radius:3px;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;justify-content:center;align-items:center;background-color:#fff;height:36px;margin-left:-10px;margin-right:12px;min-width:36px;width:36px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf .nsm7Bb-HzV7m-LgbsSe-Bz112c,.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf .nsm7Bb-HzV7m-LgbsSe-Bz112c{margin:0;padding:0}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{height:28px;margin-left:-8px;margin-right:10px;min-width:28px;width:28px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{height:16px;margin-left:-6px;margin-right:8px;min-width:16px;width:16px}.nsm7Bb-HzV7m-LgbsSe.Bz112c-LgbsSe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:3px;margin-left:2px;margin-right:0;padding:0}.nsm7Bb-HzV7m-LgbsSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:18px}.nsm7Bb-HzV7m-LgbsSe.pSzOP-SxQuSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:14px}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:8px}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-bN97Pc-sM5MNb{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;flex-direction:row;justify-content:space-between;flex-wrap:nowrap;height:100%;position:relative;width:100%}.nsm7Bb-HzV7m-LgbsSe .oXtfBe-l4eHX{justify-content:center}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-BPrWId{flex-grow:1;font-family:"Google Sans",arial,sans-serif;font-weight:500;overflow:hidden;text-overflow:ellipsis;vertical-align:top}.nsm7Bb-HzV7m-LgbsSe.purZT-SxQuSe .nsm7Bb-HzV7m-LgbsSe-BPrWId{font-weight:300}.nsm7Bb-HzV7m-LgbsSe .oXtfBe-l4eHX .nsm7Bb-HzV7m-LgbsSe-BPrWId{flex-grow:0}.nsm7Bb-HzV7m-LgbsSe .nsm7Bb-HzV7m-LgbsSe-MJoBVe{transition:background-color .218s;bottom:0;left:0;position:absolute;right:0;top:0}.nsm7Bb-HzV7m-LgbsSe:hover,.nsm7Bb-HzV7m-LgbsSe:focus{box-shadow:none;border-color:rgb(210,227,252);outline:none}.nsm7Bb-HzV7m-LgbsSe:focus-within{outline:2px solid #00639b;border-color:transparent}.nsm7Bb-HzV7m-LgbsSe:hover .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(66,133,244,.08)}.nsm7Bb-HzV7m-LgbsSe:active .nsm7Bb-HzV7m-LgbsSe-MJoBVe,.nsm7Bb-HzV7m-LgbsSe:focus .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(66,133,244,.1)}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:hover .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(255,255,255,.24)}.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:active .nsm7Bb-HzV7m-LgbsSe-MJoBVe,.nsm7Bb-HzV7m-LgbsSe.MFS4be-Ia7Qfc:focus .nsm7Bb-HzV7m-LgbsSe-MJoBVe{background:rgba(255,255,255,.32)}.nsm7Bb-HzV7m-LgbsSe .n1UuX-DkfjY{border-radius:50%;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;height:20px;margin-left:-4px;margin-right:8px;min-width:20px;width:20px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId{font-family:"Roboto";font-size:12px;text-align:left}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .ssJRIf,.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff .fmcmS{overflow:hidden;text-overflow:ellipsis}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;color:#5f6368;fill:#5f6368;font-size:11px;font-weight:400}.nsm7Bb-HzV7m-LgbsSe.jVeSEe.MFS4be-Ia7Qfc .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{color:#e8eaed;fill:#e8eaed}@media screen and (prefers-contrast:more){.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff,.nsm7Bb-HzV7m-LgbsSe.jVeSEe.MFS4be-Ia7Qfc .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff{color:#000;fill:#000}}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-BPrWId .K4efff .Bz112c{height:18px;margin:-3px -3px -3px 2px;min-width:18px;width:18px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-top-left-radius:0;border-bottom-left-radius:0;border-top-right-radius:3px;border-bottom-right-radius:3px;margin-left:12px;margin-right:-10px}.nsm7Bb-HzV7m-LgbsSe.jVeSEe.JGcpL-RbRzK .nsm7Bb-HzV7m-LgbsSe-Bz112c-haAclf{border-radius:18px}.L5Fo6c-sM5MNb{border:0;display:block;left:0;position:relative;top:0}.L5Fo6c-bF1uUb{-moz-border-radius:4px;border-radius:4px;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0}.L5Fo6c-bF1uUb:focus{border:none;outline:none}sentinel{}</style><script type="text/javascript" charset="UTF-8" src="https://maps.googleapis.com/maps-api-v3/api/js/61/14/common.js"></script><script type="text/javascript" charset="UTF-8" src="https://maps.googleapis.com/maps-api-v3/api/js/61/14/util.js"></script></head>
<body data-new-gr-c-s-check-loaded="8.932.0" data-gr-ext-installed="" style="overflow: auto;">
    <!-- Main App View -->
    <header class="header">
        <div class="logo" style="cursor: pointer;">
            <img src="planhive_logo.svg" alt="PlanHive" style="height: 50px; width: auto;">
        </div>

        <div class="search-container">
        <div class="search-bar" style="position: relative; display: flex; align-items: center;">
            <input type="text" placeholder="Search for event vendors..." id="search-input" style="flex-grow: 1; padding-left: 1rem; padding-right: 2.5rem;">
            <button id="search-button" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.25rem;">
                <i class="fas fa-magnifying-glass"></i>
            </button>
        </div>
        </div>

        <div class="user-nav">
            <button class="btn btn-primary" id="book-now-btn" onclick="openBookingModal()" style="margin-right: 1rem; padding: 0.75rem 1.5rem; font-weight: 600;">
                <i class="fas fa-calendar" style="margin-right: 0.5rem;"></i>Book Now
            </button>
            <div class="nav-icon" id="wishlist-btn">
                <i class="fas fa-heart"></i>
                <span class="badge" id="favorites-badge">0</span>
            </div>
            <div class="nav-icon" id="chat-btn" title="Chat">
                <i class="fas fa-comments"></i>
                <span class="badge" id="messages-badge">0</span>
            </div>
            <div class="nav-icon" id="notifications-btn">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notifications-badge">0</span>
            </div>
            <div class="nav-icon" id="profile-btn" style="background-color: var(--primary); color: white; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">S</div>
        </div>
    </header>

    <div class="app-container" id="app-container" style="display: none;">
        <!-- Categories Navigation -->
        <nav class="categories-nav">
            <button class="nav-scroll-btn left" id="scroll-left">◀</button>
            <div class="categories-list-wrapper">
                <div class="categories-list" id="categories-list"><div class="category-item active" data-category="all"><i class="fas fa-th-large"></i><span>All Categories</span></div><div class="category-item" data-category="venue"><i class="fas fa-building"></i><span>Venues</span></div><div class="category-item" data-category="photo"><i class="fas fa-camera"></i><span>Photo/Video</span></div><div class="category-item" data-category="music"><i class="fas fa-music"></i><span>Music/DJ</span></div><div class="category-item" data-category="catering"><i class="fas fa-utensils"></i><span>Catering</span></div><div class="category-item" data-category="entertainment"><i class="fas fa-theater-masks"></i><span>Entertainment</span></div><div class="category-item" data-category="experiences"><i class="fas fa-star"></i><span>Experiences</span></div><div class="category-item" data-category="decor"><i class="fas fa-ribbon"></i><span>Decorations</span></div><div class="category-item" data-category="beauty"><i class="fas fa-spa"></i><span>Beauty</span></div><div class="category-item" data-category="cake"><i class="fas fa-birthday-cake"></i><span>Cake</span></div><div class="category-item" data-category="transport"><i class="fas fa-shuttle-van"></i><span>Transportation</span></div><div class="category-item" data-category="planner"><i class="fas fa-clipboard-list"></i><span>Planners</span></div><div class="category-item" data-category="fashion"><i class="fas fa-tshirt"></i><span>Fashion</span></div><div class="category-item" data-category="stationery"><i class="fas fa-envelope"></i><span>Stationery</span></div></div>
            </div>
            <button class="nav-scroll-btn right" id="scroll-right">▶</button>
        </nav>

        <aside class="sidebar">
            <div class="filter-section">
                <h3 class="filter-title">
                    Location
                    <span class="filter-reset" id="location-reset">Reset</span>
                </h3>
                <input type="text" placeholder="City or ZIP code" class="search-input" id="location-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="current-location">
                        <label for="current-location">Use my location</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="within50">
                        <label for="within50">Within 50 miles</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">
                    Price Range
                    <span class="filter-reset" id="price-reset">Reset</span>
                </h3>
                <input type="range" class="range-slider" min="0" max="100" value="40" id="price-slider">
                <div class="price-labels">
                    <span>$</span>
                    <span>$$</span>
                    <span>$$$</span>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">
                    Vendor Type
                    <span class="filter-reset" id="type-reset">Reset</span>
                </h3>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="independent">
                        <label for="independent">Independent</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="company">
                        <label for="company">Company</label>
                    </div>
                </div>
            </div>

            <!-- New Advanced Filters Section -->
            <div class="advanced-filters">
                <div class="advanced-toggle" id="advanced-toggle">
                    <h3 class="filter-title">Advanced Filters</h3>
                    <span>+</span>
                </div>
                <div class="advanced-content" id="advanced-content">
                    <div class="filter-section">
                        <h3 class="filter-title">Availability</h3>
                        <div class="date-picker">
                            <input type="date" id="start-date" placeholder="Start date">
                            <input type="date" id="end-date" placeholder="End date">
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">Region</h3>
                        <select class="region-select" id="region-select">
                            <option value="">All Regions</option>
                            <option value="north">Northern Region</option>
                            <option value="south">Southern Region</option>
                            <option value="east">Eastern Region</option>
                            <option value="west">Western Region</option>
                            <option value="central">Central Region</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="trending-section">
                <h3 class="filter-title">Popular Filters</h3>
                <div class="trending-tags">
                    <div class="trending-tag" data-filter="premium">Premium</div>
                    <div class="trending-tag" data-filter="eco-friendly">Eco-Friendly</div>
                    <div class="trending-tag" data-filter="award-winning">Award Winning</div>
                    <div class="trending-tag" data-filter="last-minute">Last Minute</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="results-title">Vendors in Los Angeles</h1>
                    <p class="results-count">2 vendors available</p>
                </div>

                <div class="view-controls">
                    <button id="filters-toggle" class="btn btn-outline" style="display:flex;align-items:center;gap:.5rem;">
                        <i class="fas fa-sliders-h"></i>
                        <span>Filters</span>
                    </button>
                    <select class="sort-select" id="sort-select">
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                        <option value="nearest">Nearest to Me</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                    <div class="view-toggle" id="legacy-view-toggle"></div>
                </div>
            </div>

            
            <div class="results-two-col">
                <div class="results-left">
                    <div class="vendor-grid" id="vendor-grid"></div>
                    <!-- Horizontal cards container (used only in Map view) -->
                    <div id="main-horizontal-cards" class="vendor-horizontal-container" style="display:none;"></div>
                </div>
                <div class="results-right">
                    <div id="map-view"></div>
                </div>
            </div>
            <div id="load-more-wrapper" style="display:flex; justify-content:center; align-items:center; margin: 2rem 0;">
                <button class="btn btn-outline" id="load-more-btn">Load more</button>
                <span id="load-more-spinner" style="display:none; margin-left:8px; color: var(--text-light);"><i class="fas fa-spinner fa-spin"></i></span>
            </div>
        </main>
    </div>

    <!-- Vendor Public Profile Page -->
    <div id="vendor-profile-page" class="profile-content" style="display: none;">
                    <!-- Back Button -->
                    <div style="margin-bottom: 2rem;">
                        <button onclick="window.location.hash = ''" class="btn btn-outline" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>← Back to search results</span>
                        </button>
                    </div>
                    
                    <!-- Image Gallery - Dynamic -->
                    <div id="modal-image-gallery" class="image-gallery">
                        <div class="gallery-item large-image">
                            <img id="main-vendor-image" src="https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png" alt="Main Venue Image">
                        </div>
                        <div class="thumbnails-container" id="vendor-thumbnails">
                            <!-- Thumbnails will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Vendor Header -->
                    <div class="vendor-profile-header">
                        <div class="vendor-profile-info">
                            <h1 id="vendor-business-name" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">Loading...</h1>
                            <p id="vendor-tagline" style="font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem;">Loading tagline...</p>
                            <div style="display: flex; align-items: center; gap: 1rem; color: var(--text-light); margin-bottom: 1rem; flex-wrap: wrap;">
                                <span id="vendor-location"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Loading location...</span>
                                <span id="vendor-years-business" style="display: none;"></span>
                                <span class="review-rating" style="color: #fbbf24;">★★★★★</span>
                                <span>(5.0) | 1 Reviews</span>
                            </div>
                        </div>
                         <!-- Favorite Button -->
                        <div id="vendor-favorite-btn" class="vendor-favorite" data-id="1" style="flex-shrink: 0; align-self: flex-start; margin-top: 1rem;"><i class="fas fa-heart"></i></div>
                    </div>

                    <!-- Vendor Content Sections -->
                    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 2rem; margin-top: 2rem;">
                        <!-- Main Content Area -->
                        <div>
                            <h2 class="services-title">About Us</h2>
                            <p id="vendor-description" style="line-height: 1.6;">Loading business description...</p>
                            
                            <!-- Services & Packages Section -->
                            <div id="services-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Services & Packages</h2>
                                <div id="services-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                                    <!-- Services will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Business Hours Section -->
                            <div id="business-hours-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Business Hours</h2>
                                <div id="business-hours-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <!-- Business hours will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Social Media Section -->
                            <div class="services-section">
                                <h2 class="services-title">Connect With Us</h2>
                                <div id="social-media-links" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                    <!-- Social media links will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Category Services Section -->
                            <div id="category-services-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Our Specialties</h2>
                                <div id="category-answers-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <!-- Category answers will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- FAQ Section -->
                            <div id="faq-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Frequently Asked Questions</h2>
                                <div id="faq-list">
                                    <!-- FAQs will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Team Section -->
                            <div id="team-section" class="services-section" style="display: none;">
                                <h2 class="services-title">Our Team</h2>
                                <div id="team-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    <!-- Team members will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Reviews Section -->
                            <div class="reviews-section">
                                <h2 class="reviews-title">Reviews (1)</h2>
                                <div id="vendor-profile-reviews-list">
                                    
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer">Jane Doe</div>
                            <div class="review-date">August 8, 2025</div>
                        </div>
                        <div class="review-rating">★★★★★</div>
                        <div class="review-title">Absolutely fantastic!</div>
                        <div class="review-text">John and his team were amazing. They captured every special moment beautifully. Highly recommend!</div>
                    </div>
                
                                </div>
                                
                                    <button class="btn btn-outline add-review-btn" id="show-review-form" style="margin-top: 1rem;">Add Review</button>
                                    <div class="review-form" id="review-form" style="display: none;">
                                        <div class="rating-input">
                                            <span class="rating-star" data-rating="1">☆</span>
                                            <span class="rating-star" data-rating="2">☆</span>
                                            <span class="rating-star" data-rating="3">☆</span>
                                            <span class="rating-star" data-rating="4">☆</span>
                                            <span class="rating-star" data-rating="5">☆</span>
                                        </div>
                                        <textarea class="review-textarea" id="review-text" placeholder="Share your experience..."></textarea>
                                        <button class="btn btn-primary" id="submit-review">Submit Review</button>
                                    </div>
                                
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div style="display: flex; flex-direction: column; gap: 1rem; position: sticky; top: 2rem;">
                            <!-- Booking Summary -->
                            <div id="booking-summary" style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Your Booking</h3>
                                <div id="selected-services-list">
                                    <p style="font-size: 0.9rem; color: var(--text-light);">Select services from the list to get started.</p>
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 1rem 0; padding-top: 1rem; display: flex; justify-content: space-between; font-weight: 600;">
                                    <span>Total</span>
                                    <span id="booking-total-price">$0.00</span>
                                </div>
                                <button class="btn btn-primary" id="proceed-to-book-btn" style="width: 100%;" disabled="">Choose Services</button>
                            </div>

                            <!-- Contact -->
                            <div style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Contact Vendor</h3>
                                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-light);">Have questions? Get in touch!</p>
                                <button class="btn btn-outline" id="open-chat-btn" style="width: 100%;">Message Vendor</button>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Dashboard Modal -->
    <div id="dashboard-modal" class="modal" data-no-outside-close style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="dashboard-modal-title">Dashboard</h3>
                <!-- Mode toggle removed per request -->
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body" style="padding: 0; overflow: hidden; flex-grow: 1;">
                <!-- Client Dashboard -->
                <div class="dashboard-container" id="dashboard-container" style="display: none; height: 100%;">
                    <aside class="dashboard-sidebar">
                        <div class="logo" style="padding: 1rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center;">
                            <img src="planhive_logo.svg" alt="PlanHive" style="height: 40px; width: auto;">
                        </div>
                        <ul class="dashboard-menu">
                            <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                            <li><a href="#" data-section="bookings"><i class="fas fa-calendar-check"></i>Bookings</a></li>
                            <li><a href="#" data-section="invoices"><i class="fas fa-file-invoice"></i>Invoices</a></li>
                            <!-- Requests merged into Bookings; hide legacy link -->
                            <li style="display:none;"><a href="#" data-section="requests">My Requests</a></li>
                            <li><a href="#" data-section="favorites"><i class="fas fa-heart"></i>Favorites</a></li>
                            <li><a href="#" data-section="messages"><i class="fas fa-comments"></i>Messages</a></li>
                            <li><a href="#" data-section="reviews"><i class="fas fa-star"></i>My Reviews</a></li>
                            <li><a href="#" data-section="settings"><i class="fas fa-cog"></i>Settings</a></li>
                            <li><a href="#" id="logout-dashboard"><i class="fas fa-sign-out-alt"></i>Log Out</a></li>
                        </ul>
                    </aside>
                    <main class="dashboard-content" style="overflow-y: auto;">
                        <div class="dashboard-header">
                            <h1 class="dashboard-title" id="dashboard-title">Dashboard</h1>
                            <div class="user-nav">
                                <div class="nav-icon" id="dashboard-notifications-btn" style="display: none;">
                                    <i class="fas fa-bell"></i>
                                    <span class="badge" id="dashboard-notifications-badge">0</span>
                                </div>
                            </div>
                        </div>
                        <div id="dashboard-section">
                            <div class="vendor-stats" id="client-stats"><p>Loading your stats...</p></div>
                            <div class="overview-grid">
                                <div class="dashboard-card">
                                    <h2 class="dashboard-card-title">Recent Bookings</h2>
                                    <div id="upcoming-bookings" class="dashboard-fixed-list"><p class="empty-state">Loading recent bookings...</p></div>
                                </div>
                                <div class="dashboard-card">
                                    <div class="dashboard-card-title-row">
                                        <h2 class="dashboard-card-title">Recent Messages</h2>
                                        <button class="btn btn-outline" id="open-all-messages-btn-client" style="padding:.5rem .9rem;">Open Messages</button>
                                    </div>
                                    <div id="client-recent-messages" class="message-preview-list dashboard-fixed-list"><p class="empty-state">Loading recent messages...</p></div>
                                </div>
                            </div>
                        </div>
                        <div id="bookings-section" style="display: none;">
                            <div class="dashboard-card">
                                <div class="booking-tabs">
                                    <button class="booking-tab active" data-tab="all">All</button>
                                    <button class="booking-tab" data-tab="pending">Pending</button>
                                    <button class="booking-tab" data-tab="accepted">Accepted</button>
                                    <button class="booking-tab" data-tab="declined">Declined</button>
                                    <button class="booking-tab" data-tab="expired">Expired</button>
                                </div>
                                <div class="booking-content">
                                    <div id="all-bookings" class="booking-tab-content active">
                                        <div class="booking-count">0 items</div>
                                        <div id="all-bookings-list"><p>Loading...</p></div>
                                    </div>
                                    <div id="pending-bookings" class="booking-tab-content">
                                        <div class="booking-count">0 requests</div>
                                        <div id="pending-bookings-list"><p>No pending items.</p></div>
                                    </div>
                                    <div id="accepted-bookings" class="booking-tab-content">
                                        <div class="booking-count">0 items</div>
                                        <div id="completed-bookings"><p>No accepted items.</p></div>
                                    </div>
                                    <div id="declined-bookings" class="booking-tab-content">
                                        <div class="booking-count">0 items</div>
                                        <div id="declined-bookings-list"><p>No declined items.</p></div>
                                    </div>
                                    <div id="expired-bookings" class="booking-tab-content">
                                        <div class="booking-count">0 items</div>
                                        <div id="expired-bookings-list"><p>No expired items.</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="invoices-section" style="display: none;">
                            <div class="dashboard-card">
                                <div id="client-invoices-list"><p>Loading invoices...</p></div>
                            </div>
                        </div>
                        <div id="favorites-section" style="display: none;">
                            <div class="dashboard-card">
                                <div class="vendor-grid" id="saved-favorites"><p>Loading saved favorites...</p></div>
                            </div>
                        </div>
                        <div id="messages-section" style="display: none;">
                            <div class="dashboard-card">
                                <div class="chat-container">
                                    <div class="chat-messages" id="dashboard-chat-messages"><p>Loading messages...</p></div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="dashboard-chat-input">
                                        <button class="btn btn-primary" id="dashboard-send-btn">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="requests-section" style="display: none;">
                            <div class="dashboard-card">
                                <div class="requests-filter-tabs">
                                    <button class="tab-btn active" data-filter="all">All Requests</button>
                                    <button class="tab-btn" data-filter="pending">Pending</button>
                                    <button class="tab-btn" data-filter="approved">Approved</button>
                                    <button class="tab-btn" data-filter="declined">Declined</button>
                                    <button class="tab-btn" data-filter="expired">Expired</button>
                                </div>
                                <div id="user-requests"><p>Loading your requests...</p></div>
                            </div>
                        </div>
                        <div id="reviews-section" style="display: none;">
                            <div class="dashboard-card">
                                <div id="user-reviews"><p>Loading your reviews...</p></div>
                            </div>
                        </div>
                        <div id="settings-section" style="display: none;">
                            <!-- Personal Settings Category -->
                            <div class="settings-category">
                                <h2 class="settings-category-title">Personal settings</h2>
                                <div class="settings-grid">
                                    <div class="settings-card" data-settings-modal="personal-details">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <h3 class="settings-card-title">Personal details</h3>
                                        <p class="settings-card-description">Contact information, password, authentication methods and your active sessions.</p>
                                    </div>
                                    <div class="settings-card" data-settings-modal="communication-preferences">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <h3 class="settings-card-title">Communication preferences</h3>
                                        <p class="settings-card-description">Customise the emails, SMS, and push notifications you receive.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Settings Category -->
                            <div class="settings-category">
                                <h2 class="settings-category-title">Account settings</h2>
                                <div class="settings-grid">
                                    <div class="settings-card" data-settings-modal="security">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <h3 class="settings-card-title">Security</h3>
                                        <p class="settings-card-description">Manage your account security, authorised apps, and shared resources.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
                <!-- Vendor Dashboard -->
                <div class="dashboard-container" id="vendor-dashboard-container" style="display: none; height: 100%;">
                    <aside class="dashboard-sidebar">
                        <div class="logo" style="padding: 1rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center;">
                            <img src="planhive_logo.svg" alt="PlanHive" style="height: 40px; width: auto;">
                        </div>
                        <ul class="dashboard-menu">
                            <li><a href="#" class="active" data-section="vendor-dashboard"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                            <li><a href="#" data-section="vendor-requests"><i class="fas fa-calendar-check"></i>Bookings</a></li>
                            <li><a href="#" data-section="vendor-invoices"><i class="fas fa-file-invoice"></i>Invoices</a></li>
                            <li><a href="#" data-section="vendor-business-profile"><i class="fas fa-building"></i>Business Profile</a></li>
                            <li><a href="#" data-section="vendor-messages"><i class="fas fa-comments"></i>Messages</a></li>
                            <li><a href="#" data-section="vendor-reviews"><i class="fas fa-star"></i>Reviews</a></li>
                            <li><a href="#" data-section="vendor-analytics"><i class="fas fa-chart-line"></i>Analytics</a></li>
                            <li><a href="#" data-section="vendor-settings"><i class="fas fa-cog"></i>Settings</a></li>
                            <li><a href="#" id="vendor-logout"><i class="fas fa-sign-out-alt"></i>Log Out</a></li>
                        </ul>
                    </aside>
                    <main class="dashboard-content" style="overflow-y: auto;">
                        <div class="dashboard-header">
                            <h1 class="dashboard-title" id="vendor-dashboard-title">Vendor Dashboard</h1>
                            <div class="user-nav">
                                <div class="nav-icon" id="vendor-notifications-btn" style="display: none;">
                                    <i class="fas fa-bell"></i>
                                    <span class="badge" id="vendor-notifications-badge">0</span>
                                </div>
                            </div>
                        </div>
                        <div id="vendor-dashboard-section">
                            <div class="vendor-stats" id="vendor-stats"><p>Loading vendor stats...</p></div>
                            <div class="overview-grid">
                                <div class="dashboard-card">
                                    <h2 class="dashboard-card-title">Recent Bookings</h2>
                                    <div id="vendor-recent-bookings" class="dashboard-fixed-list"><p class="empty-state">Loading recent bookings...</p></div>
                                </div>
                                <div class="dashboard-card">
                                    <div class="dashboard-card-title-row">
                                        <h2 class="dashboard-card-title">Recent Messages</h2>
                                        <button class="btn btn-outline" id="open-all-messages-btn" style="padding:.5rem .9rem;">Open Messages</button>
                                    </div>
                                    <div id="vendor-recent-messages" class="message-preview-list dashboard-fixed-list"><p class="empty-state">Loading recent messages...</p></div>
                                </div>
                            </div>
                        </div>
                        <div id="vendor-requests-section" style="display: none;">
                            <div class="dashboard-card">
                                <!-- Direction tabs removed per UI preference -->
                                <!-- Status filter tabs -->
                                <div class="requests-filter-tabs" id="vendor-requests-tabs" style="margin-bottom:.8rem;">
                                    <button class="tab-btn active" data-status="all">All</button>
                                    <button class="tab-btn" data-status="pending">Pending</button>
                                    <button class="tab-btn" data-status="approved">Accepted</button>
                                    <button class="tab-btn" data-status="declined">Declined</button>
                                    <button class="tab-btn" data-status="expired">Expired</button>
                                </div>
                                <div id="vendor-pending-requests"><p>Loading pending requests...</p></div>
                            </div>
                        </div>
                        <div id="vendor-invoices-section" style="display: none;">
                            <div class="dashboard-card">
                                <div id="vendor-invoices-list"><p>Loading invoices...</p></div>
                            </div>
                        </div>
                        <div id="vendor-messages-section" style="display: none;">
                            <div class="dashboard-card">
                                <div class="chat-container" style="height: 500px;">
                                    <div class="chat-messages" id="vendor-all-chat-messages"><p>Loading all messages...</p></div>
                                    <div class="chat-input">
                                        <input type="text" placeholder="Type your message..." id="vendor-all-chat-input">
                                        <button class="btn btn-primary" id="vendor-all-send-btn">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="vendor-reviews-section" style="display: none;">
                            <div class="dashboard-card">
                                <div id="vendor-reviews"><p>Loading customer reviews...</p></div>
                            </div>
                        </div>
                        <div id="vendor-analytics-section" style="display: none;">
                            <div class="dashboard-card">
                                <div id="analytics-charts" class="analytics-charts"><p>Loading analytics data...</p></div>
                            </div>
                        </div>
                        <div id="vendor-business-profile-section" style="display: none;">
                            <!-- Business Profile Categories -->
                            <div class="settings-category">
                                <h2 class="settings-category-title">Business Profile Management</h2>
                                <div class="settings-grid">
                                    <div class="settings-card" data-panel="vendor-profile-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <h3 class="settings-card-title">Business Information</h3>
                                        <p class="settings-card-description">Update your business details, categories, and description</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-location-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </div>
                                        <h3 class="settings-card-title">Location & Service Areas</h3>
                                        <p class="settings-card-description">Set your business address and areas you serve</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-additional-details-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-clipboard-check"></i>
                                        </div>
                                        <h3 class="settings-card-title">Vendor Setup Questionnaire</h3>
                                        <p class="settings-card-description">Select features that describe your services</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-services-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-briefcase"></i>
                                        </div>
                                        <h3 class="settings-card-title">Services & Packages</h3>
                                        <p class="settings-card-description">Manage your offerings and service packages</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-photos-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-images"></i>
                                        </div>
                                        <h3 class="settings-card-title">Gallery & Media</h3>
                                        <p class="settings-card-description">Upload and manage your business photos</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-social-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-share-alt"></i>
                                        </div>
                                        <h3 class="settings-card-title">Social Media & Booking</h3>
                                        <p class="settings-card-description">Connect your social profiles and booking link</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-faqs-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-question-circle"></i>
                                        </div>
                                        <h3 class="settings-card-title">FAQs</h3>
                                        <p class="settings-card-description">Create frequently asked questions</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-availability-panel">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <h3 class="settings-card-title">Availability & Hours</h3>
                                        <p class="settings-card-description">Set your business hours and availability</p>
                                    </div>
                                    <div class="settings-card" data-panel="vendor-stripe-panel">
                                        <div class="settings-card-icon">
                                            <i class="fab fa-stripe"></i>
                                        </div>
                                        <h3 class="settings-card-title">Stripe Setup</h3>
                                        <p class="settings-card-description">Connect your Stripe account to receive payments</p>
                                    </div>
                                </div>
                                
                                <!-- Panels Container -->
                                <div class="panels-container">
                                    <!-- Business Information Panel -->
                                    <div id="vendor-profile-panel" style="display: none;">
                                        <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                            <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                        </button>
                                <div class="dashboard-card">
                                    <h2 class="dashboard-card-title">Business Information</h2>
                                    <form id="vendor-profile-form">
                                        <div class="form-group"><label for="vendor-name">Business Name <span style="color:red;">*</span></label><input type="text" id="vendor-name" required></div>
                                        <div class="form-group"><label for="vendor-display-name">Display Name (for public listing)</label><input type="text" id="vendor-display-name" placeholder="Public listing name"></div>
                                        <div class="form-group"><label for="vendor-email">Business Email <span style="color:red;">*</span></label><input type="email" id="vendor-email" required></div>
                                        <div class="form-group"><label for="vendor-phone">Business Phone <span style="color:red;">*</span></label><input type="tel" id="vendor-phone" required></div>
                                        <div class="form-group"><label for="vendor-website">Website URL</label><input type="url" id="vendor-website"></div>
                                        <div class="form-group"><label for="vendor-years-in-business">Years in Business</label><input type="number" id="vendor-years-in-business" min="0"></div>
                                        <div class="form-group"><label for="vendor-description">Business Description <span style="color:red;">*</span></label><textarea id="vendor-description" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);" required></textarea></div>
                                        <div class="form-group"><label for="vendor-tagline">Tagline (short description)</label><input type="text" id="vendor-tagline" placeholder="Short description"></div>
                                        <div class="form-group"><label for="vendor-category">Primary Category <span style="color:red;">*</span></label><select id="vendor-category" required></select></div>
                                        <div class="form-group"><label for="vendor-additional-categories">Additional Categories</label><select id="vendor-additional-categories" multiple></select></div>
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Location & Service Areas Panel -->
                            <div id="vendor-location-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                        <h2 class="dashboard-card-title">Location & Service Areas</h2>
                                        <form id="vendor-location-form">
                                            <div class="form-group"><label for="loc-address">Street Address</label><input type="text" id="loc-address"></div>
                                            <div class="form-group"><label for="loc-city">City</label><input type="text" id="loc-city"></div>
                                            <div class="form-group"><label for="loc-state">Province</label><input type="text" id="loc-state"></div>
                                            <div class="form-group"><label for="loc-country">Country</label><input type="text" id="loc-country" placeholder="Canada"></div>
                                            <div class="form-group"><label for="loc-postal">Postal Code</label><input type="text" id="loc-postal"></div>
                                            <div class="form-row">
                                                <div class="form-col"><div class="form-group"><label for="loc-lat">Latitude</label><input type="text" id="loc-lat" readonly></div></div>
                                                <div class="form-col"><div class="form-group"><label for="loc-lng">Longitude</label><input type="text" id="loc-lng" readonly></div></div>
                                            </div>
                                            <div class="dashboard-subcard" style="margin-top:1rem;">
                                                <h3 class="dashboard-card-title" style="font-size:1rem;">Service Areas (Cities/Regions Served) <span style="color:red;">*</span></h3>
                                                <div class="form-row">
                                                    <div class="form-col"><div class="form-group"><label for="service-area-input">Add City/Region</label><input type="text" id="service-area-input" placeholder="e.g., Toronto, ON"></div></div>
                                                    <div class="form-col" style="align-self:end;"><button type="button" class="btn btn-outline" id="add-service-area-btn">Add</button></div>
                                                </div>
                                                <div id="service-areas-list" style="display:flex;gap:.5rem;flex-wrap:wrap;"></div>
                                                <p style="color:var(--text-light);margin-top:.5rem;">Add at least one city or region you serve.</p>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save Location</button>
                                        </form>
                                </div>
                            </div>
                            
                            <!-- Additional Details Panel (Vendor Questionnaire) -->
                            <div id="vendor-additional-details-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                    <h2 class="dashboard-card-title">Vendor Setup Questionnaire</h2>
                                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                                        Select the features and services that apply to your business. This helps clients understand what you offer.
                                    </p>
                                    <div id="vendor-questionnaire-container" style="margin-bottom: 2rem;">
                                        <div class="questionnaire-loading">
                                            <i class="fas fa-circle-notch"></i>
                                            <p>Loading questionnaire...</p>
                                        </div>
                                    </div>
                                    <div style="margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                                        <div id="selection-summary" style="color: var(--text-light); font-size: 0.95rem;">
                                            <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                                            <span id="selection-count">0 features selected</span>
                                        </div>
                                        <button type="button" id="save-vendor-questionnaire" class="btn btn-primary" style="display: none; padding: 0.75rem 2rem; font-size: 1rem;">
                                            <i class="fas fa-check"></i> Save Selections
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Social Media & Booking Panel -->
                            <div id="vendor-social-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                        <h2 class="dashboard-card-title">Social Media & Booking</h2>
                                        <form id="vendor-social-form">
                                            <div class="form-group"><label for="booking-link">Booking Link</label><input type="url" id="booking-link" placeholder="https://..."></div>

                                            <h3 class="dashboard-card-subtitle" style="margin: 1rem 0; color: var(--primary);">Social Media Profiles</h3>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                                <div class="form-group">
                                                    <label for="social-facebook-settings" style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <i class="fab fa-facebook" style="color: #1877F2; font-size: 1.2rem;"></i>
                                                        Facebook
                                                    </label>
                                                    <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                                        <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">facebook.com/</span>
                                                        <input type="text" id="social-facebook-settings" placeholder="yourpage" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://facebook.com/">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="social-instagram-settings" style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <i class="fab fa-instagram" style="color: #E4405F; font-size: 1.2rem;"></i>
                                                        Instagram
                                                    </label>
                                                    <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                                        <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">instagram.com/</span>
                                                        <input type="text" id="social-instagram-settings" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://instagram.com/">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="social-twitter-settings" style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <i class="fab fa-twitter" style="color: #1DA1F2; font-size: 1.2rem;"></i>
                                                        Twitter
                                                    </label>
                                                    <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                                        <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">twitter.com/</span>
                                                        <input type="text" id="social-twitter-settings" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://twitter.com/">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="social-linkedin-settings" style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <i class="fab fa-linkedin" style="color: #0077B5; font-size: 1.2rem;"></i>
                                                        LinkedIn
                                                    </label>
                                                    <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                                        <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">linkedin.com/in/</span>
                                                        <input type="text" id="social-linkedin-settings" placeholder="yourprofile" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://linkedin.com/in/">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="social-youtube-settings" style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <i class="fab fa-youtube" style="color: #FF0000; font-size: 1.2rem;"></i>
                                                        YouTube
                                                    </label>
                                                    <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                                        <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">youtube.com/</span>
                                                        <input type="text" id="social-youtube-settings" placeholder="yourchannel" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://youtube.com/">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="social-tiktok-settings" style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <i class="fab fa-tiktok" style="color: #6b7280; font-size: 1.2rem;"></i>
                                                        TikTok
                                                    </label>
                                                    <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                                        <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">tiktok.com/@</span>
                                                        <input type="text" id="social-tiktok-settings" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://tiktok.com/@">
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="submit" class="btn btn-primary">Save Social</button>
                                        </form>
                                </div>
                            </div>
                            
                            <!-- Services & Packages Panel -->
                            <div id="vendor-services-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                        <h2 class="dashboard-card-title">Services</h2>
                                        <div id="vendor-settings-services-loading" style="text-align: center; padding: 2rem; color: var(--text-light);">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                            <p>Loading available services...</p>
                                        </div>

                                        <div id="vendor-settings-services-container" style="display: none;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                                                <h5 style="margin: 0; color: var(--primary);">Available Services</h5>
                                                <span id="vendor-settings-selected-count" style="color: var(--text-light); font-size: 0.9rem;">0 added</span>
                                            </div>

                                            <div id="vendor-settings-services-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 2rem;"></div>

                                            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                                                <button class="btn btn-primary" id="vendor-settings-save-services">Save Services</button>
                                            </div>
                                        </div>

                                        <div id="vendor-settings-no-services" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                                            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                                            <h6 style="margin-bottom: 0.5rem;">No predefined services available</h6>
                                            <p style="margin: 0;">No services match your business categories. Update your categories in Business Profile.</p>
                                        </div>
                                </div>
                            </div>
                            
                            <!-- FAQs Panel -->
                            <div id="vendor-faqs-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                        <h2 class="dashboard-card-title">FAQs</h2>
                                        <div id="faqs-list"></div>
                                        <div style="margin-top: 1rem;">
                                            <button id="add-faq-btn" class="btn btn-outline">Add FAQ</button>
                                            <button id="save-faqs-btn" class="btn btn-primary" style="margin-left: 0.5rem;">Save FAQs</button>
                                        </div>
                                </div>
                            </div>
                            
                            <!-- Gallery & Media Panel -->
                            <div id="vendor-photos-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                        <h2 class="dashboard-card-title">Business Photos</h2>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;" id="vendor-photos"><p>No photos uploaded.</p></div>
                                        <button class="btn btn-outline" id="upload-photos-btn">Upload Photos</button>
                                        <div style="margin-top:1rem;display:grid;grid-template-columns:1fr 1fr auto;gap:.5rem;align-items:end;">
                                            <div class="form-group" style="margin:0;"><label for="image-url-input">Add Image by URL</label><input type="url" id="image-url-input" placeholder="https://..."></div>
                                            <div class="form-group" style="margin:0;"><label for="image-caption-input">Caption (optional)</label><input type="text" id="image-caption-input"></div>
                                            <div class="form-group" style="margin:0;display:flex;gap:.5rem;align-items:center;"><label><input type="checkbox" id="image-primary-checkbox"> Primary</label><button class="btn btn-primary" type="button" id="add-photo-url-btn">Add</button></div>
                                        </div>
                                </div>
                            </div>
                            
                            <!-- Availability & Hours Panel -->
                            <div id="vendor-availability-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                        <h2 class="dashboard-card-title">Availability Settings</h2>
                                        <div id="business-hours-container" style="margin-top:1rem;"></div>
                                        <button class="btn btn-primary" id="save-business-hours-btn" style="margin-top:.5rem;">Save Business Hours</button>
                                </div>
                            </div>
                            
                            <!-- Stripe Setup Panel -->
                            <div id="vendor-stripe-panel" style="display: none;">
                                <button class="btn btn-outline back-to-menu-btn" style="margin-bottom: 1rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Business Profile Menu
                                </button>
                                <div class="dashboard-card">
                                    <h2 class="dashboard-card-title">Stripe Connect</h2>
                                    <p style="color: var(--text-light); margin-bottom: 2rem;">
                                        Connect your Stripe account to accept payments from customers.
                                    </p>
                                    
                                    <!-- Stripe Status Display -->
                                    <div id="stripe-status-display">
                                        <div style="text-align: center; padding: 40px 20px;">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary); margin-bottom: 16px;"></i>
                                            <p style="margin: 0; color: var(--text-light);">Checking connection status...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Verification & Legal panel removed -->
                                </div><!-- Close panels-container -->
                            </div><!-- Close settings-category -->
                        </div><!-- Close vendor-business-profile-section -->
                        <div id="vendor-settings-section" style="display: none;">
                            <!-- Personal Settings Category -->
                            <div class="settings-category">
                                <h2 class="settings-category-title">Personal settings</h2>
                                <div class="settings-grid">
                                    <div class="settings-card" data-settings-modal="vendor-personal-details">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <h3 class="settings-card-title">Personal details</h3>
                                        <p class="settings-card-description">Contact information, password, authentication methods and your active sessions.</p>
                                    </div>
                                    <div class="settings-card" data-settings-modal="vendor-communication-preferences">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <h3 class="settings-card-title">Communication preferences</h3>
                                        <p class="settings-card-description">Customise the emails, SMS, and push notifications you receive.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Settings Category -->
                            <div class="settings-category">
                                <h2 class="settings-category-title">Account settings</h2>
                                <div class="settings-grid">
                                    <div class="settings-card" data-settings-modal="vendor-security">
                                        <div class="settings-card-icon">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <h3 class="settings-card-title">Security</h3>
                                        <p class="settings-card-description">Manage your account security, authorised apps, and shared resources.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modals -->
    <div id="settings-modal-overlay" class="settings-modal-overlay">
        <div class="settings-modal">
            <div class="settings-modal-header">
                <h2 id="settings-modal-title">Settings</h2>
                <button class="settings-modal-close">&times;</button>
            </div>
            <div class="settings-modal-body" id="settings-modal-content">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Vendor Registration Modal -->
    <div id="vendor-registration-modal" class="modal" data-no-outside-close style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 1200px; height: 90vh; display: flex; flex-direction: column; background: var(--secondary);">
            <div class="modal-header">
                <h3 id="registration-title"><span class="step-number-badge">1</span>Step 1 of 9: Business Basics</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                        <span class="step-indicator active" id="step-indicator-1"><span class="step-number">1</span><span class="step-label">Business Basics</span></span>
                        <span class="step-indicator" id="step-indicator-2"><span class="step-number">2</span><span class="step-label">Location Information</span></span>
                        <span class="step-indicator" id="step-indicator-3"><span class="step-number">3</span><span class="step-label">Services & Packages</span></span>
                        <span class="step-indicator" id="step-indicator-4"><span class="step-number">4</span><span class="step-label">Additional Details</span></span>
                        <span class="step-indicator" id="step-indicator-5"><span class="step-number">5</span><span class="step-label">Availability & Scheduling</span></span>
                        <span class="step-indicator" id="step-indicator-6"><span class="step-number">6</span><span class="step-label">Gallery & Media</span></span>
                        <span class="step-indicator" id="step-indicator-7"><span class="step-number">7</span><span class="step-label">Social Media</span></span>
                        <span class="step-indicator" id="step-indicator-8"><span class="step-number">8</span><span class="step-label">FAQ</span></span>
                        <span class="step-indicator" id="step-indicator-9"><span class="step-number">9</span><span class="step-label">Summary & Completion</span></span>
                    </div>
                    <div style="background-color: var(--border); height: 4px; border-radius: 2px; overflow: hidden;">
                        <div id="setup-progress-bar" style="background-color: var(--primary); height: 100%; width: 11.11%; transition: width 0.3s ease;"></div>
                    </div>
                </div>

                <div id="reg-status-message" style="text-align: center; color: var(--primary); margin-bottom: 1rem;"></div>
                
                <!-- Step 1: Business Basics -->
                <div class="setup-step" id="setup-step-1" style="display: block;">
                    <h4 class="form-section-title"><span class="step-number-badge">1</span>Business Basics</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Tell us about your business and what services you provide.</p>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-name">Business Name *</label>
                                <input type="text" id="business-name" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="display-name">Display Name (for public listing)</label>
                                <input type="text" id="display-name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-email">Business Email *</label>
                                <input type="email" id="business-email" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-phone">Business Phone *</label>
                                <input type="tel" id="business-phone" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="website-url">Website URL</label>
                                <input type="url" id="website-url" placeholder="https://yourwebsite.com">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="years-in-business">Years in Business</label>
                                <input type="number" id="years-in-business" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="business-description">Business Description <span style="color: red;">*</span></label>
                        <textarea id="business-description" rows="4" required placeholder="Describe your business and what makes you unique..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 0.9rem; line-height: 1.4; resize: vertical; min-height: 120px; background-color: white;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="tagline">Tagline (short description)</label>
                        <input type="text" id="tagline" placeholder="Your catchy business tagline...">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="primary-category">Primary Category <span style="color: red;">*</span></label>
                                <select id="primary-category" required class="select2-category" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                    <option value="">Select primary category</option>
                                    <option value="beauty">Beauty</option>
                                    <option value="cake">Cake</option>
                                    <option value="catering">Catering</option>
                                    <option value="decor">Decor</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="experiences">Experiences</option>
                                    <option value="fashion">Fashion</option>
                                    <option value="music">Music</option>
                                    <option value="photo">Photo</option>
                                    <option value="planner">Planner</option>
                                    <option value="stationery">Stationery</option>
                                    <option value="transport">Transport</option>
                                    <option value="venue">Venue</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="additional-categories">Additional Categories</label>
                                <select id="additional-categories" multiple class="select2-category" style="width: 100%; min-height: 50px; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                    <option value="beauty">Beauty</option>
                                    <option value="cake">Cake</option>
                                    <option value="catering">Catering</option>
                                    <option value="decor">Decor</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="experiences">Experiences</option>
                                    <option value="fashion">Fashion</option>
                                    <option value="music">Music</option>
                                    <option value="photo">Photo</option>
                                    <option value="planner">Planner</option>
                                    <option value="stationery">Stationery</option>
                                    <option value="transport">Transport</option>
                                    <option value="venue">Venue</option>
                                </select>
                                <small style="color: var(--text-light);">Select multiple categories that apply to your business</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-primary" id="next-to-step-2">Next: Location Information</button>
                    </div>
                </div>

                <!-- Step 2: Location Information (ENHANCED) -->
                <div class="setup-step" id="setup-step-2" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">2</span>Location Information</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Tell us where your business is located and which areas you serve.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Physical Office (Optional)</h5>
                    <div class="form-group">
                        <label for="business-address">Street Address</label>
                        <input type="text" id="business-address" placeholder="123 Main Street, Toronto, ON" class="google-autocomplete">
                        <small style="color: var(--text-light);">Start typing your Canadian address and select from suggestions</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-city">City</label>
                                <input type="text" id="business-city" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-state">Province</label>
                                <input type="text" id="business-state" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-country">Country</label>
                                <input type="text" id="business-country" value="Canada" readonly style="background-color: #f8f9fa; width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem;">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="business-postal">Postal Code</label>
                                <input type="text" id="business-postal" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for latitude and longitude -->
                    <input type="hidden" id="business-latitude">
                    <input type="hidden" id="business-longitude">

            <h5 style="margin: 2rem 0 1rem 0; color: var(--primary);">Service Areas <span style="color: red;">*</span></h5>
            <div class="form-group">
                <label for="additional-cities">Cities/Regions Served <span style="color: red;">*</span></label>
                <div id="additional-cities-container" style="min-height: 120px; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; background-color: white;">
                    <input type="text" id="additional-cities-input" placeholder="Start typing a city name..." class="google-places-input" style="width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem;" required>
                    <div id="selected-cities" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <!-- Selected cities will appear here as tags -->
                    </div>
                </div>
                <small style="color: var(--text-light); font-size: 0.8rem;">Type city names and select from Google's suggestions. You must specify at least one service area. Selected cities will appear as tags above.</small>
            </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-1">Back: Business Basics</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-3">Next: Services & Packages</button>
                    </div>
                </div>

                <!-- Step 3: Services & Packages -->
                <div class="setup-step" id="setup-step-3" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">3</span>Services & Packages</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Select services from our curated list that match your business categories and customize them with your pricing.</p>
                    
                    <!-- Loading State -->
                    <div id="predefined-services-loading" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Loading available services...</p>
                    </div>
                    
                    <!-- Predefined Services Section -->
                    <div id="predefined-services-container" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                            <h5 style="margin: 0; color: var(--primary);">Available Services</h5>
                            <span id="selected-services-count" style="color: var(--text-light); font-size: 0.9rem;">0 services selected</span>
                        </div>
                        
                        <div id="predefined-services-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <!-- Predefined services will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- No Services Available Message -->
                    <div id="no-services-message" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                        <h6 style="margin-bottom: 0.5rem;">No predefined services available</h6>
                        <p style="margin: 0;">No services match your selected categories. You can add custom services in the next step.</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-2">Back: Location Information</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-4">Next: Additional Details</button>
                    </div>
                </div>

                <!-- Step 4: Additional Details -->
                <div class="setup-step" id="setup-step-4" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">4</span>Additional Details</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Please answer the following questions related to your primary category.</p>
                    
                    <div id="category-questions-container" style="margin-bottom: 1rem;">
                        <!-- Category-specific questions will be dynamically loaded here -->
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-3">Back: Services & Packages</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-5">Next: Availability & Scheduling</button>
                    </div>
                </div>

                <!-- Step 5: Availability & Scheduling -->
                <div class="setup-step" id="setup-step-5" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">5</span>Availability & Scheduling</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Set your business hours and availability preferences.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Regular Business Hours</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-0">
                                <strong>Sunday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-0" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-0" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-1" checked>
                                <strong>Monday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-1" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-1" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-2" checked>
                                <strong>Tuesday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-2" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-2" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-3" checked>
                                <strong>Wednesday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-3" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-3" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-4" checked>
                                <strong>Thursday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-4" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-4" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-5" checked>
                                <strong>Friday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-5" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-5" style="flex: 1;">
                            </div>
                        </div>
                        <div class="availability-day">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="available-6">
                                <strong>Saturday</strong>
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="time" id="start-time-6" style="flex: 1;">
                                <span style="align-self: center;">to</span>
                                <input type="time" id="end-time-6" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="lead-time">Minimum booking lead time <span style="color: red;">*</span></label>
                                <select id="lead-time" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                    <option value="same-day">Same day</option>
                                    <option value="1-day" selected>1 day</option>
                                    <option value="3-days">3 days</option>
                                    <option value="1-week">1 week</option>
                                    <option value="2-weeks">2 weeks</option>
                                    <option value="1-month">1 month</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="availability-dates">Available Dates <span style="color: red;">*</span></label>
                                <input type="date" id="availability-dates" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: white; font-size: 0.9rem;">
                                <small style="color: var(--text-light);">You must provide at least one available date</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-4">Back: Additional Details</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-6">Next: Gallery & Media</button>
                    </div>
                </div>

                <!-- Step 6: Gallery & Media -->
                <div class="setup-step" id="setup-step-6" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">6</span>Gallery & Media</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Upload images to showcase your work and attract potential clients.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Featured Image</h5>
                    <div class="form-group">
                        <label for="featured-image">Main Profile Image <span style="color: red;">*</span></label>
                        <input type="file" id="featured-image" accept="image/*" required>
                        <small style="color: var(--text-light);">This will be the main image displayed on your profile. Recommended size: 800x600px</small>
                        <div id="featured-image-preview" style="margin-top: 1rem; display: none;">
                            <img id="featured-image-display" style="max-width: 300px; max-height: 200px; border-radius: var(--radius); border: 1px solid var(--border);">
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">Preview of your main profile image</p>
                        </div>
                    </div>
                    
                    <h5 style="margin: 2rem 0 1rem 0; color: var(--primary);">Gallery Images</h5>
                    <div class="form-group">
                        <label for="gallery-images">Additional Images</label>
                        <input type="file" id="gallery-images" accept="image/*" multiple>
                        <small style="color: var(--text-light);">Upload multiple images to showcase your work. You can select up to 20 images.</small>
                        <div id="selected-images-list" style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: #f8f9fa; display: none;">
                            <h6 style="margin-bottom: 0.5rem; color: var(--primary);">Selected Images:</h6>
                            <div id="image-names-list" style="font-size: 0.9rem; color: var(--text-light);"></div>
                        </div>
                    </div>
                    
                    <div id="image-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
                        <!-- Image previews will appear here -->
                    </div>
                    
                    <!-- Portfolio Links section removed as requested -->
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-5">Back: Availability & Scheduling</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-7">Next: Social Media</button>
                    </div>
</div>

                <!-- Step 7: Social Media -->
                <div class="setup-step" id="setup-step-7" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">7</span>Social Media</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Add your social media profiles to help clients connect with you.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Social Media Profiles</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label for="social-facebook" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-facebook" style="color: #1877F2; font-size: 1.2rem;"></i>
                                Facebook
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">facebook.com/</span>
                                <input type="text" id="social-facebook" placeholder="yourpage" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://facebook.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-instagram" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-instagram" style="color: #E4405F; font-size: 1.2rem;"></i>
                                Instagram
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">instagram.com/</span>
                                <input type="text" id="social-instagram" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://instagram.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-twitter" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-twitter" style="color: #1DA1F2; font-size: 1.2rem;"></i>
                                Twitter
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">twitter.com/</span>
                                <input type="text" id="social-twitter" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://twitter.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-linkedin" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-linkedin" style="color: #0077B5; font-size: 1.2rem;"></i>
                                LinkedIn
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">linkedin.com/in/</span>
                                <input type="text" id="social-linkedin" placeholder="yourprofile" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://linkedin.com/in/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-youtube" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-youtube" style="color: #FF0000; font-size: 1.2rem;"></i>
                                YouTube
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">youtube.com/</span>
                                <input type="text" id="social-youtube" placeholder="yourchannel" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://youtube.com/">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="social-tiktok" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fab fa-tiktok" style="color: #6b7280; font-size: 1.2rem;"></i>
                                TikTok
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: var(--radius); background-color: white;">
                                <span style="padding: 0.75rem 0.5rem 0.75rem 0.75rem; color: var(--text-light); font-size: 0.9rem; background-color: var(--secondary); border-right: 1px solid var(--border);">tiktok.com/@</span>
                                <input type="text" id="social-tiktok" placeholder="youraccount" style="border: none; outline: none; padding: 0.75rem; flex: 1; font-size: 0.9rem; background: transparent;" data-prefix="https://tiktok.com/@">
                            </div>
                        </div>
                    </div>
                    

                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-6">Back: Gallery & Media</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-8">Next: FAQ</button>
                    </div>
                </div>

                <!-- Step 8: FAQ Section -->
                <div class="setup-step" id="setup-step-8" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">8</span>FAQ Section</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Add frequently asked questions to help potential clients understand your services better.</p>
                    
                    <h5 style="margin-bottom: 1rem; color: var(--primary);">Frequently Asked Questions</h5>
                    <div id="faqs-list" style="margin-bottom: 1rem;">
                        <!-- FAQs will be listed here -->
                    </div>
                    <button type="button" class="btn btn-outline" id="add-faq-btn">Add FAQ</button>
                    
                    <!-- FAQ Form -->
                    <div id="faq-form" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius);">
                        <div class="form-group">
                            <label>Question</label>
                            <input type="text" id="faq-question" required placeholder="What is your typical response time?">
                        </div>
                        <div class="form-group">
                            <label>Answer</label>
                            <textarea id="faq-answer" rows="3" required placeholder="I typically respond to inquiries within 24 hours..."></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-primary" id="add-faq-item-btn">Add FAQ</button>
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('faq-form').style.display='none'">Cancel</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-7">Back: Additional Details</button>
                        <button type="button" class="btn btn-primary" id="next-to-step-9">Next: Summary</button>
                    </div>
                </div>

                <!-- Step 9: Summary -->
                <div class="setup-step" id="setup-step-9" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">9</span>Setup Summary</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Review all the information you've entered before completing your vendor profile setup.</p>
                    
                    <div id="setup-summary-content" style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem;">
                        <!-- Summary content will be dynamically populated here -->
                        <div class="summary-loading">Loading your information...</div>
                        <div id="summary-error" style="display: none; color: var(--accent); padding: 1rem; background-color: #fee; border-radius: var(--radius);">Failed to load summary. Please check your information and try again.</div>
                    </div>
                    
                    <div style="background-color: var(--secondary); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem;">
                        <p style="margin-bottom: 1rem;"><i class="fas fa-star" style="color: var(--primary); margin-right: 0.5rem;"></i><strong>Congratulations!</strong> You're about to complete your vendor profile setup.</p>
                        <p><strong>Once completed, your profile will be live and visible to potential clients!</strong></p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-step-8">Back: FAQ</button>
                        <button type="button" class="btn btn-primary" id="complete-setup-btn" style="background-color: #28a745; border-color: #28a745;"><i class="fas fa-rocket" style="margin-right: 0.5rem;"></i>Complete Setup & Go Live!</button>
                    </div>
                </div>




            </div>
        </div>
    </div>


    <!-- Vendor Modal (working version) -->
    <div id="vendor-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-vendor-name">Vendor Name</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Image Gallery -->
                <div id="modal-image-gallery" class="image-gallery">
                    <!-- Images will be loaded dynamically here -->
                </div>

                <!-- Header Info -->
                <div class="vendor-detail-header">
                    <div class="vendor-detail-image">
                        <!-- Image or placeholder will be rendered here -->
                    </div>
                    <div class="vendor-detail-info">
                        <h2 id="modal-vendor-name-full" class="vendor-detail-name">Vendor Name</h2>
                        <div class="vendor-detail-location"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i><span id="modal-vendor-location">Location</span></div>
                        <div class="vendor-detail-ratings">
                            <div class="review-rating" id="modal-vendor-rating">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> <span>(0.0) | 0 Reviews</span>
                            </div>
                        </div>
                        <div class="vendor-detail-features">
                            <div class="feature">
                                <span class="feature-icon" id="modal-vendor-category-icon"></span>
                                <span id="modal-vendor-category-name"></span>
                            </div>
                            <div class="feature">
                                <span class="feature-icon"><i class="fas fa-star"></i></span>
                                <span id="modal-vendor-services-offered">Services</span>
                            </div>
                        </div>
                        <p class="vendor-detail-price" id="modal-vendor-price"></p>
                    </div>
                </div>

                <!-- About Us -->
                <h3 class="services-title">About Us</h3>
                <p id="modal-vendor-description" class="vendor-detail-description">
                    Vendor description will appear here...
                </p>

                <!-- Services -->
                <div id="services-section" class="services-section">
                    <h3 class="services-title">Available Services</h3>
                    <!-- Services will be rendered here -->
                </div>

                <!-- Booking Form -->
                <div class="booking-flow">
                    <h3 class="services-title">Book This Vendor</h3>
                    <div class="form-group">
                        <label for="booking-date-picker" class="form-label">Select a Date and Time</label>
                        <input type="text" id="booking-date-picker" class="form-control" placeholder="Choose a date and time">
                    </div>
                    <button class="btn btn-primary" id="open-booking-modal-btn">
                        Book Now
                    </button>
                    <button class="btn btn-outline" id="open-chat-btn">
                        Message Vendor
                    </button>
                </div>

                <!-- Booking Calendar Section (Moved inside modal-body) -->
                <div class="booking-calendar-section">
                    <h3 class="calendar-title">Select Date &amp; Time</h3>
                    <div id="booking-calendar"></div>
                    <div class="time-slots" id="time-slots"></div>
                </div>

                <!-- Reviews Section -->
                <div class="reviews-section">
                    <h3 class="reviews-title">Customer Reviews</h3>
                    <div id="modal-reviews-list">
                        <!-- Reviews will be rendered here -->
                    </div>

                    ${currentUser ? `
                        <button class="btn btn-outline add-review-btn" id="show-review-form">Add Review</button>
                        <div class="review-form" id="review-form" style="display: none;">
                            <div class="rating-input">
                                <span class="rating-star" data-rating="1">☆</span>
                                <span class="rating-star" data-rating="2">☆</span>
                                <span class="rating-star" data-rating="3">☆</span>
                                <span class="rating-star" data-rating="4">☆</span>
                                <span class="rating-star" data-rating="5">☆</span>
                            </div>
                            <textarea class="review-textarea" id="review-text" placeholder="Share your experience..."></textarea>
                            <button class="btn btn-primary" id="submit-review">Submit Review</button>
                        </div>
                    ` : '<p><a href="#" id="login-to-review" style="color: var(--primary);">Log in</a> to leave a review</p>'}
                </div>

                <!-- Chat Section -->
                <div class="chat-section">
                    <h3 class="chat-title">Message Vendor</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will load here -->
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." id="chat-input">
                            <button class="btn btn-primary" id="send-btn">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="payment-section" id="payment-section" style="display: none;">
                    <h3 class="payment-title">Payment Information</h3>
                    <div class="payment-form">
                        <div class="form-group">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardholder-name">
                        </div>
                        <div class="card-element" id="card-element"></div>
                        <button class="btn btn-primary" id="pay-now-btn">Pay Now</button>
                    </div>
                </div>

                <div class="vendor-actions" style="margin-top: 2rem; justify-content: center;">
                    <button class="btn btn-primary" id="book-now-btn">Book Now</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Chat Modal -->
    <div id="chat-modal" class="modal chat-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chat with <span id="chat-vendor-name">Vendor</span></h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <div class="chat-container">
                    <div class="chat-messages" id="profile-chat-messages">
                        <!-- Messages will load here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" placeholder="Type your message..." id="profile-chat-input">
                        <button class="btn btn-primary" id="profile-send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Booking Confirmation -->
    <div id="confirmation-modal" class="booking-confirmation" style="display: none;">
        <div class="confirmation-content">
            <h3><i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>Booking Confirmed!</h3>
            <p><strong>Vendor:</strong> <span id="conf-venue-name"></span></p>
            <p><strong>Services:</strong> <span id="conf-services"></span></p>
            <p><strong>Date:</strong> <span id="conf-date"></span></p>
            <p><strong>Time:</strong> <span id="conf-time"></span></p>
            <p><strong>Confirmation #:</strong> <span id="conf-id"></span></p>
            <p>A confirmation email has been sent to your registered email address.</p>
            <button class="btn btn-primary" id="conf-done-btn">Done</button>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="location-permission" class="location-permission" style="display: none;">
        <div class="location-content">
            <h3>Find Vendors Near You</h3>
            <p>PlanHive would like to access your location to show vendors near you.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button class="btn btn-outline" id="deny-location">Not Now</button>
                <button class="btn btn-primary" id="allow-location">
                    Allow
                    <span id="location-loading" class="location-loading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="profile-modal-title">My Account</h3>
                <span class="close-modal" id="close-profile-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Login Form (shown by default) -->
                <div id="login-form" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="login-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" id="login-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <button class="btn btn-primary" id="login-btn" style="width: 100%; margin-bottom: 1rem;">Log In</button>
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <a href="#" id="show-signup" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">Don't have an account? Sign up</a>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                        <div style="flex: 1; height: 1px; background-color: var(--border);"></div>
                        <div style="padding: 0 1rem; color: var(--text-light); font-size: 0.9rem;">OR</div>
                        <div style="flex: 1; height: 1px; background-color: var(--border);"></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-outline" id="google-login" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" width="20" height="20">
                            <span>Continue with Google</span>
                        </button>
                        <button class="btn btn-outline" id="facebook-login" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" width="20" height="20">
                            <span>Continue with Facebook</span>
                        </button>
                    </div>
                </div>

                <!-- Two-Factor Verification (hidden by default) -->
                <div id="twofa-form" style="display: none; flex-direction: column;">
                    <div style="margin-bottom: 1rem; color: var(--text-light); font-size: 0.95rem;">
                        Enter the 6-digit code we sent to your email: <strong id="twofa-email"></strong>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Verification Code</label>
                        <div id="twofa-code-inputs" style="display: flex; justify-content: space-between; gap: 0.5rem;">
                            <input class="otp-digit" type="text" inputmode="numeric" maxlength="1" placeholder="_" aria-label="Digit 1" style="width: 44px; height: 48px; text-align: center; font-size: 1.25rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <input class="otp-digit" type="text" inputmode="numeric" maxlength="1" placeholder="_" aria-label="Digit 2" style="width: 44px; height: 48px; text-align: center; font-size: 1.25rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <input class="otp-digit" type="text" inputmode="numeric" maxlength="1" placeholder="_" aria-label="Digit 3" style="width: 44px; height: 48px; text-align: center; font-size: 1.25rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <input class="otp-digit" type="text" inputmode="numeric" maxlength="1" placeholder="_" aria-label="Digit 4" style="width: 44px; height: 48px; text-align: center; font-size: 1.25rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <input class="otp-digit" type="text" inputmode="numeric" maxlength="1" placeholder="_" aria-label="Digit 5" style="width: 44px; height: 48px; text-align: center; font-size: 1.25rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <input class="otp-digit" type="text" inputmode="numeric" maxlength="1" placeholder="_" aria-label="Digit 6" style="width: 44px; height: 48px; text-align: center; font-size: 1.25rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <input type="hidden" id="twofa-code" value="">
                        </div>
                    </div>
                    <button class="btn btn-primary" id="verify-2fa-btn" style="width: 100%; margin-bottom: 0.75rem;">Verify</button>
                    <div style="display: flex; justify-content: space-between; gap: 0.75rem; margin-top: auto;">
                        <button class="btn btn-outline" id="resend-2fa-btn" style="flex: 1;">Resend Code</button>
                        <button class="btn btn-outline" id="back-to-login-btn" style="flex: 1;">Back</button>
                    </div>
                </div>

                <!-- Signup Form (hidden by default) -->
                <div id="signup-form" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name</label>
                        <input type="text" id="signup-name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="signup-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" id="signup-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Account Type</label>
                        <select id="account-type" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <option value="client">Client (I want to book vendors)</option>
                            <option value="vendor">Vendor (I provide services)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="signup-btn" style="width: 100%; margin-bottom: 1rem;">Create Account</button>
                    <div style="text-align: center;">
                        <a href="#" id="show-login" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">Already have an account? Log in</a>
                    </div>
                </div>

                <!-- Logged In View (hidden by default) -->
                <div id="logged-in-view" style="display: block; text-align: center;">
                    <div class="profile-avatar" id="profile-avatar">S</div>
                    <h3 style="margin-bottom: 0.5rem;" id="profile-name">User Name</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;" id="profile-email">user@example.com</p>
                    <button class="btn btn-primary" id="view-dashboard-btn" style="width: 100%; margin-bottom: 1rem;">View Dashboard</button>
                    <button class="btn btn-outline" id="logout-btn" style="width: 100%;">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Dropdown -->
    <div id="notifications-dropdown" class="notifications-dropdown" style="display: none;">
        <div class="dropdown-header">
            <h3>Notifications</h3>
            <button id="mark-all-read" class="btn btn-sm">Mark All Read</button>
        </div>
        <div class="notification-tabs">
            <button class="notification-tab active" data-tab="all">All</button>
            <button class="notification-tab" data-tab="unread">Unread</button>
        </div>
        <div id="notifications-list" class="notifications-list">
            <div class="loading-notifications">
                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
            </div>
        </div>
        <div class="dropdown-footer">
            <a href="#" onclick="displayUserDashboard('client', 'dashboard')" class="view-all-link">View All Notifications</a>
        </div>
    </div>

    <!-- Profile Dropdown -->
    <div id="profile-dropdown" class="profile-dropdown" style="display: none;">
        <div class="header">
            <div class="avatar" id="profile-dd-avatar">S</div>
            <div class="info">
                <div class="name" id="profile-dd-name">User Name</div>
                <div class="email" id="profile-dd-email">user@example.com</div>
            </div>
        </div>
        <ul class="menu">
            <li><a href="#" id="profile-view-dashboard"><i class="fas fa-th-large"></i><span>View Dashboard</span></a></li>
            <li class="divider"></li>
            <li><a href="#" id="profile-logout" class="logout"><i class="fas fa-sign-out-alt"></i><span>Log Out</span></a></li>
        </ul>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="lightbox-modal">
        <span class="lightbox-close">×</span>
        <button class="lightbox-nav lightbox-prev">❮</button>
        <div class="lightbox-content">
            <img src="" alt="Lightbox image" id="lightbox-image">
        </div>
        <button class="lightbox-nav lightbox-next">❯</button>
    </div>

    <!-- Multi-Step Booking Modal -->
    <div id="booking-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 95vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="booking-modal-title"><span class="step-number-badge">1</span>Step 1 of 5: Select Categories</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div class="booking-progress" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                        <span class="step-indicator active" id="booking-step-indicator-1"><span class="step-number">1</span><span class="step-label">Categories</span></span>
                        <span class="step-indicator" id="booking-step-indicator-2"><span class="step-number">2</span><span class="step-label">Details</span></span>
                        <span class="step-indicator" id="booking-step-indicator-3"><span class="step-number">3</span><span class="step-label">Services</span></span>
                        <span class="step-indicator" id="booking-step-indicator-4"><span class="step-number">4</span><span class="step-label">Vendors</span></span>
                        <span class="step-indicator" id="booking-step-indicator-5"><span class="step-number">5</span><span class="step-label">Requests</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="booking-progress-fill" style="width: 20%;"></div>
                    </div>
                </div>

                <!-- Step 1: Service Selection -->
                <div class="booking-step" id="booking-step-1" style="display: block;">
                    <h4 class="form-section-title"><span class="step-number-badge">1</span>Select Categories</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Choose the service categories you need for your event.</p>
                    
                    <div class="service-categories" id="service-categories">
                        <!-- Service categories will be loaded dynamically from the database -->
                        <div class="loading-message" style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                            Loading service categories...
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-primary" id="next-to-booking-step-2" disabled>Next: Event Details</button>
                    </div>
                </div>

                <!-- Step 2: Event Details -->
                <div class="booking-step" id="booking-step-2" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">2</span>Event Details</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Enter your event information. You will select services in the next step.</p>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-name">Event Name <span class="required-asterisk">*</span></label>
                                    <input type="text" id="event-name" placeholder="e.g., Sarah & Alex Wedding" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-type">Event Type <span class="required-asterisk">*</span></label>
                                    <select id="event-type" required>
                                        <option value="" selected disabled>Select type</option>
                                        <option>Wedding</option>
                                        <option>Engagement</option>
                                        <option>Birthday</option>
                                        <option>Corporate</option>
                                        <option>Conference</option>
                                        <option>Concert</option>
                                        <option>Festival</option>
                                        <option>Baby Shower</option>
                                        <option>Bridal Shower</option>
                                        <option>Anniversary</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-date">Event Date <span class="required-asterisk">*</span></label>
                                    <input type="text" id="event-date" placeholder="Select date" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-start-time">Event Start Time <span class="required-asterisk">*</span></label>
                                    <input type="time" id="event-start-time" required step="900">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-end-time">Event End Time <span class="required-asterisk">*</span></label>
                                    <input type="time" id="event-end-time" required step="900">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="event-timezone">Timezone <span class="required-asterisk">*</span></label>
                                    <select id="event-timezone" required>
                                        <option value="">Select timezone...</option>
                                        <option value="America/St_Johns">America/St_Johns (NST) GMT -3:30</option>
                                        <option value="America/Halifax">America/Halifax (AST) GMT -4:00</option>
                                        <option value="America/Toronto">America/Toronto (EST) GMT -5:00</option>
                                        <option value="America/Winnipeg">America/Winnipeg (CST) GMT -6:00</option>
                                        <option value="America/Edmonton">America/Edmonton (MST) GMT -7:00</option>
                                        <option value="America/Vancouver">America/Vancouver (PST) GMT -8:00</option>
                                        <option value="America/Anchorage">America/Anchorage (AKST) GMT -9:00</option>
                                        <option value="America/Honolulu">America/Honolulu (HST) GMT -10:00</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="attendee-count">Number of Attendees</label>
                                    <input type="number" id="attendee-count" min="1" value="50">
                                </div>
                            </div>
                            <div class="form-col">
                                <!-- Empty column for layout balance -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="event-location">Event Location <span class="required-asterisk">*</span></label>
                            <input type="text" id="event-location" placeholder="Start typing to search for a location..." required autocomplete="off">
                            <div id="location-suggestions" class="location-suggestions" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Timeline (visible in Step 2) -->
                    <div class="timeline-section" data-timeline="section" style="margin-bottom: 2rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;">
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.75rem;">
                            <h5 style="margin: 0; color: var(--primary-color);"><i class="fas fa-stream" style="margin-right:0.5rem;"></i>Timeline</h5>
                        </div>
                        <div style="font-size:0.85rem; color: var(--text-light); margin-bottom:0.5rem;">
                            Set event start/end. Timeline auto-updates as you add services in the next step.
                        </div>
                        <div class="timeline-container" data-timeline="container" style="position: relative; height: 180px; background: #fafbff; border: 1px dashed #e2e8f0; border-radius: 8px; overflow: hidden;">
                            <div class="timeline-axis" data-timeline="axis" style="position:absolute; left:0; right:0; top:8px; height:20px; font-size: 11px; color:#64748b;"></div>
                            <div class="timeline-layers" data-timeline="layers" style="position:absolute; left:0; right:0; top:32px; bottom:8px;"></div>
                        </div>
                        <div class="timeline-warning" data-timeline="warning" style="display:none; margin-top:0.5rem; padding:0.5rem; background:#fff7ed; border:1px solid #fdba74; color:#9a3412; border-radius:6px; font-size:0.85rem;"></div>
                        <div style="display:flex; gap:1rem; margin-top:0.5rem; font-size:0.85rem; color:#64748b;">
                            <span><span style="display:inline-block; width:10px; height:10px; background:#c7d2fe; border-radius:2px; margin-right:6px;"></span>Event Window</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#bbf7d0; border-radius:2px; margin-right:6px;"></span>Vendor Hours</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#fcd34d; border-radius:2px; margin-right:6px;"></span>Service</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#fecaca; border-radius:2px; margin-right:6px;"></span>Outside Event</span>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-1">Back: Categories</button>
                        <button type="button" class="btn btn-primary" id="next-to-booking-step-3">Next: Select Services</button>
                    </div>
                </div>

                <!-- Step 3: Selecting Service -->
                <div class="booking-step" id="booking-step-3" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">3</span>Select Services</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Choose from available services and set individual budgets.</p>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        

                        <div id="predefined-services-loading" style="text-align: center; padding: 2rem; display: none;">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem; color: var(--text-light);">Loading available services...</p>
                        </div>

                        <div id="booking-predefined-services-container" style="display: none;">
                            <div id="service-selection-dropdowns"></div>
                            <div id="selected-services-list-container" style="margin-top: 1.5rem;"></div>
                        </div>

                        <div id="no-services-message" style="text-align: center; padding: 2rem; color: var(--text-light); display: none;">
                            <p>No services available for your selected categories. Please go back and select different categories.</p>
                        </div>
                    </div>

                    <!-- Timeline (visible in Step 3) -->
                    <div class="timeline-section" data-timeline="section" style="margin-bottom: 2rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px;">
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 0.75rem;">
                            <h5 style="margin: 0; color: var(--primary-color);"><i class="fas fa-stream" style="margin-right:0.5rem;"></i>Timeline</h5>
                        </div>
                        <div style="font-size:0.85rem; color: var(--text-light); margin-bottom:0.5rem;">
                            Adjust service durations and times as needed. Conflicts will be highlighted.
                        </div>
                        <div class="timeline-container" data-timeline="container" style="position: relative; height: 180px; background: #fafbff; border: 1px dashed #e2e8f0; border-radius: 8px; overflow: hidden;">
                            <div class="timeline-axis" data-timeline="axis" style="position:absolute; left:0; right:0; top:8px; height:20px; font-size: 11px; color:#64748b;"></div>
                            <div class="timeline-layers" data-timeline="layers" style="position:absolute; left:0; right:0; top:32px; bottom:8px;"></div>
                        </div>
                        <div class="timeline-warning" data-timeline="warning" style="display:none; margin-top:0.5rem; padding:0.5rem; background:#fff7ed; border:1px solid #fdba74; color:#9a3412; border-radius:6px; font-size:0.85rem;"></div>
                        <div style="display:flex; gap:1rem; margin-top:0.5rem; font-size:0.85rem; color:#64748b;">
                            <span><span style="display:inline-block; width:10px; height:10px; background:#c7d2fe; border-radius:2px; margin-right:6px;"></span>Event Window</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#bbf7d0; border-radius:2px; margin-right:6px;"></span>Vendor Hours</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#fcd34d; border-radius:2px; margin-right:6px;"></span>Service</span>
                            <span><span style="display:inline-block; width:10px; height:10px; background:#fecaca; border-radius:2px; margin-right:6px;"></span>Outside Event</span>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-2">Back: Event Details</button>
                        <button type="button" class="btn btn-primary" id="find-vendors-btn" disabled>Find Matching Vendors</button>
                    </div>
                </div>

                <!-- Step 4: Vendor Matching -->
                <div class="booking-step" id="booking-step-4" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">4</span>Available Vendors</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Select vendors that match your requirements. View nearby vendors on the map and browse detailed options below.</p>
                    
                    <!-- Search Criteria Summary -->
                    <div id="search-criteria-summary" class="search-criteria-summary" style="background: #f8faff; border: 1px solid #e3f2fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <h6 style="margin: 0; color: var(--text); font-weight: 600;">Search Criteria</h6>
                            <button type="button" class="btn btn-sm btn-outline" id="adjust-filters-btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 6px;">
                                <i class="fas fa-edit" style="margin-right: 0.3rem;"></i>Adjust Filters
                            </button>
                        </div>
                        <div id="criteria-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                            <!-- Criteria details will be populated here -->
                        </div>
                    </div>
                    
                    <div id="vendor-loading" style="display: none; text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>Finding matching vendors for each service...</p>
                    </div>
                    
                    <!-- Main Layout: Vendor Cards LEFT, Map RIGHT -->
                    <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                        <!-- LEFT: Vendor Cards -->
                        <div style="flex: 1; min-width: 0;">
                            <div id="vendor-cards-container" style="display: flex; flex-direction: column; height: 720px;">
                                <div class="vendor-filters" style="flex-shrink: 0; margin-bottom: 1rem;">
                                    <select id="vendor-sort" class="form-control" style="width: auto; display: inline-block;">
                                        <option value="distance">Sort by Distance</option>
                                        <option value="price">Sort by Price</option>
                                        <option value="rating">Sort by Rating</option>
                                    </select>
                                </div>
                                
                                <!-- Service Tabs -->
                                <div id="service-tabs-container" style="display: none; flex-shrink: 0; margin-bottom: 1rem; position: relative;">
                                    <button id="tabs-scroll-left" class="tab-nav-btn tab-nav-left" style="display: none;" onclick="scrollTabs('left')">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div id="service-tabs" class="service-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none;">
                                        <!-- Service tabs will be populated here -->
                                    </div>
                                    <button id="tabs-scroll-right" class="tab-nav-btn tab-nav-right" style="display: none;" onclick="scrollTabs('right')">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                
                                <div id="vendor-horizontal-cards" class="vendor-horizontal-container" style="overflow-y: auto; box-sizing: border-box; flex: 1; min-height: 0;">
                                    <!-- Horizontal vendor cards will be populated here -->
                                    <div style="padding: 1rem; background: #f8faff; border-radius: 12px; text-align: center;">
                                        <i class="fas fa-search" style="font-size: 2rem; color: #ccc; margin-bottom: 0.5rem;"></i>
                                        <p style="color: #666; margin: 0;">Search for vendors to see options here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT: Google Maps Container -->
                        <div style="flex: 1; min-width: 0;">
                            <div id="vendor-map-container" style="display: block;">
                                <div class="map-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h5 style="margin: 0; color: var(--text);">Vendors Near Your Event Location</h5>
                                </div>
                                <div style="position: relative;">
                                    <div id="vendor-map" style="height: 600px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                                    <!-- Floating map controls positioned on top of the map -->
                                    <div class="map-controls-overlay" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000;">
                                        <button type="button" class="btn btn-sm" id="focus-event-location" 
                                                style="background: white; border: 1px solid #ddd; color: #333; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-crosshairs"></i> Focus Event
                                        </button>
                                        <button type="button" class="btn btn-sm" id="show-all-vendors"
                                                style="background: white; border: 1px solid #ddd; color: #333; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-expand"></i> Show All
                                        </button>
                                    </div>
                                </div>
                                <div class="map-legend" style="display: flex; gap: 1rem; margin-top: 1rem; font-size: 0.9rem; color: var(--text-light);">
                                    <div><i class="fas fa-map-marker-alt" style="color: #e74c3c;"></i> Event Location</div>
                                    <div><i class="fas fa-store" style="color: #3498db;"></i> Available Vendors</div>
                                    <div><i class="fas fa-check-circle" style="color: #27ae60;"></i> Selected Vendors</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    <div id="vendor-results" class="vendor-sections-container" style="display: none;">
                        <!-- Legacy vendor sections will be populated here -->
                    </div>
                    
                    <div id="no-vendors-found" style="display: none; text-align: center; padding: 2rem;">
                        <h5>No vendors found</h5>
                        <p style="color: var(--text-light);">Try adjusting your budget or service requirements.</p>
                        <button type="button" class="btn btn-outline" id="adjust-criteria-btn">Adjust Criteria</button>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-3">Back: Select Services</button>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span id="selected-vendor-count" style="color: #6b7280; font-size: 0.9rem;">0 vendors selected</span>
                            <button type="button" class="btn btn-primary" id="send-requests-btn" disabled>Send Requests</button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Request Submission -->
                <div class="booking-step" id="booking-step-5" style="display: none;">
                    <h4 class="form-section-title"><span class="step-number-badge">5</span>Booking Requests</h4>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Review your selected vendors and their services before sending requests.</p>
                    
                    <div class="selected-vendors-summary" id="selected-vendors-summary">
                        <!-- Selected vendors summary will be populated here -->
                    </div>
                    
                    <div class="request-summary" id="request-summary" style="display: none;">
                        <!-- Request summary will be populated here -->
                    </div>
                    
                    <div style="display: flex; justify-content: flex-start; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-outline" id="back-to-booking-step-4">Back: Vendors</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Duplicate Google Maps API script removed - using the one in head -->

    <!-- Facebook SDK -->
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId: 'YOUR_FACEBOOK_APP_ID',
          cookie: true,
          xfbml: true,
          version: 'v18.0'
        });
      };
    </script>
    <script async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 920px; width: 95%; display:flex; flex-direction:column; max-height: 90vh;">
        <div class="modal-header">
          <h3 id="invoice-modal-title">Invoice</h3>
          <span class="close-modal" id="invoice-close-btn">×</span>
        </div>
        <div class="modal-body" style="overflow:auto;">
          <div id="invoice-print-area" style="background:white; padding: 24px; border-radius: 8px;">
            <div id="invoice-loading" style="text-align:center; color:#6b7280; padding: 24px;">
              <i class="fas fa-spinner fa-spin" style="font-size:22px;"></i>
              <div style="margin-top:8px;">Loading invoice...</div>
            </div>
            <div id="invoice-content" style="display:none;"></div>
          </div>
        </div>
        <div class="modal-footer" style="display:flex; gap:.5rem; justify-content:flex-end; padding: 12px 16px; border-top:1px solid var(--border);">
          <button class="btn btn-outline" id="invoice-refresh-btn">Refresh</button>
          <button class="btn btn-primary" id="invoice-download-btn"><i class="fas fa-file-download" style="margin-right:8px;"></i>Download PDF</button>
        </div>
      </div>
    </div>

    <!-- Booking Details Modal -->
    <div id="booking-details-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 760px; width: 95%; display:flex; flex-direction:column; max-height: 90vh;">
        <div class="modal-header">
          <h3 id="booking-details-title">Event Details</h3>
          <div id="booking-details-status-slot" style="margin-left:auto; display:flex; align-items:center; gap:8px; position:relative;"></div>
          <span class="close-modal" id="booking-details-close">×</span>
        </div>
        <div class="modal-body" style="overflow:auto;">
          <div id="booking-details-content"></div>
        </div>
        <div class="modal-footer" style="display:flex; gap:.5rem; justify-content:flex-end; padding: 12px 16px; border-top:1px solid var(--border);">
          <button class="btn-accept" id="booking-details-accept-btn" style="display:none;">Accept</button>
          <button class="btn-decline" id="booking-details-decline-btn" style="display:none;">Decline</button>
          <button class="btn btn-primary" id="booking-details-reply-btn">Reply</button>
          <button class="btn btn-outline" id="booking-details-close-btn">Close</button>
        </div>
      </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // API base URL (global constant)
        const API_BASE_URL = 'https://bdb-3-0-venuevue-api.onrender.com/api';
        // Derive Socket base URL from API origin to avoid file:// resolution issues
        let SOCKET_BASE_URL = '';
        try {
            const apiUrl = new URL(API_BASE_URL);
            SOCKET_BASE_URL = apiUrl.origin; // e.g., https://bdb-3-0-venuevue-api.onrender.com
        } catch (_) {
            SOCKET_BASE_URL = 'https://bdb-3-0-venuevue-api.onrender.com';
        }
        
        // Global variables
        let currentUser = null;
        // Invoice state and helpers
        let lastInvoiceBookingId = null;
        let lastInvoiceData = null;
        async function openInvoiceModal(bookingId) {
            try {
                lastInvoiceBookingId = bookingId;
                const modal = document.getElementById('invoice-modal');
                if (modal) modal.style.display = 'flex';
                const content = document.getElementById('invoice-content');
                const loading = document.getElementById('invoice-loading');
                if (content) { content.style.display = 'none'; content.innerHTML = ''; }
                if (loading) loading.style.display = 'block';
                const closeBtn = document.getElementById('invoice-close-btn');
                if (closeBtn && !closeBtn._wired) { closeBtn._wired = true; closeBtn.addEventListener('click', () => { modal.style.display = 'none'; }); }
                window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
                const refreshBtn = document.getElementById('invoice-refresh-btn');
                if (refreshBtn && !refreshBtn._wired) { refreshBtn._wired = true; refreshBtn.addEventListener('click', () => openInvoiceModal(lastInvoiceBookingId)); }
                const dlBtn = document.getElementById('invoice-download-btn');
                if (dlBtn && !dlBtn._wired) { dlBtn._wired = true; dlBtn.addEventListener('click', downloadInvoicePDF); }
                if (!currentUser || !currentUser.id) { throw new Error('Please log in to view invoices.'); }
                // Prefer persisted invoices API, fallback to legacy bookings invoice builder
                const primaryUrl = `${API_BASE_URL}/invoices/booking/${bookingId}?regenerate=1&userId=${currentUser.id}`;
                let resp = await fetch(primaryUrl, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` } });
                let data = null;
                const ct = resp.headers.get('content-type') || '';
                if (resp.ok && ct.includes('application/json')) {
                    data = await resp.json();
                } else {
                    const fallbackUrl = `${API_BASE_URL}/bookings/${bookingId}/invoice?userId=${currentUser.id}`;
                    resp = await fetch(fallbackUrl, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` } });
                    const fct = resp.headers.get('content-type') || '';
                    if (!resp.ok || !fct.includes('application/json')) {
                        const txt = await resp.text().catch(() => '');
                        throw new Error('Invoice endpoint not available on server. ' + (txt ? `Server says: ${txt}` : ''));
                    }
                    data = await resp.json();
                }
                if (!data || !data.success) throw new Error((data && data.message) || 'Failed to load invoice');
                let inv = data.invoice;
                // If using persisted invoices shape, adapt to UI contract expected by renderInvoice
                if (inv && !inv.lineItems && inv.items) {
                    inv = (function adaptPersistedInvoiceToUI(p) {
                        const items = Array.isArray(p.items) ? p.items : [];
                        const sum = (filter) => items.filter(filter).reduce((s, it) => s + Number(it.Amount || it.lineTotal || 0), 0);
                        const servicesSubtotal = +(sum(it => (it.ItemType || '').toLowerCase() === 'service' && (it.IsPayable === true || it.IsPayable === 1))).toFixed(2);
                        const expensesTotal = +(sum(it => (it.ItemType || '').toLowerCase() === 'expense' && (it.IsPayable === true || it.IsPayable === 1))).toFixed(2);
                        const subtotal = Number(p.Subtotal || (servicesSubtotal + expensesTotal));
                        const platformFee = Number(p.PlatformFee || 0);
                        const processingFees = Number(p.StripeFee || 0);
                        const tax = Number(p.TaxAmount || 0);
                        const platformFeePercent = subtotal > 0 ? +((platformFee / subtotal) * 100).toFixed(1) : 0;
                        const feesIncluded = true;
                        const paymentsTotal = +((Array.isArray(p.payments) ? p.payments : []).reduce((s, r) => s + Number(r.Amount || r.amount || 0), 0)).toFixed(2);
                        const grandTotal = +(subtotal + (platformFee + processingFees) + tax).toFixed(2);
                        const lineItems = items.map(it => ({
                            type: it.ItemType,
                            name: it.Title,
                            quantity: Number(it.Quantity || 1),
                            unitPrice: Number(it.UnitPrice || 0),
                            lineTotal: Number(it.Amount || 0)
                        }));
                        let statusText = (p.Status || '').toString().toLowerCase();
                        if (!statusText && p.booking) statusText = (p.booking.Status || '').toString().toLowerCase();
                        if (statusText !== 'paid' && (paymentsTotal + 0.01 >= grandTotal)) statusText = 'paid';
                        return {
                            invoiceNumber: p.InvoiceNumber,
                            issuedAt: p.IssueDate || p.IssueDateTime || p.CreatedAt || new Date().toISOString(),
                            bookingId: p.BookingID,
                            eventDate: (p.booking && p.booking.EventDate) || null,
                            status: statusText || '',
                            currency: p.Currency || 'USD',
                            viewerRole: '',
                            billFrom: { name: (p.booking && p.booking.VendorName) || 'Vendor', email: '', phone: '' },
                            billTo:   { name: (p.booking && p.booking.ClientName) || 'Client', email: '', phone: '' },
                            client: { id: p.UserID, name: (p.booking && p.booking.ClientName) || '' },
                            vendor: { vendorProfileId: p.VendorProfileID, name: (p.booking && p.booking.VendorName) || '' },
                            lineItems,
                            totals: {
                                servicesSubtotal,
                                expensesTotal,
                                subtotal,
                                platformFeePercent,
                                platformFee,
                                processingFees,
                                processingFeesSource: 'recorded',
                                grandTotal,
                                totalPaid: paymentsTotal,
                                balanceDue: Math.max(0, +(grandTotal - paymentsTotal).toFixed(2))
                            },
                            payments: Array.isArray(p.payments) ? p.payments : []
                        };
                    })(inv);
                }
                lastInvoiceData = inv;
                renderInvoice(inv);
                if (loading) loading.style.display = 'none';
                if (content) content.style.display = 'block';
            } catch (e) {
                console.error('openInvoiceModal error:', e);
                const loading = document.getElementById('invoice-loading');
                if (loading) loading.innerHTML = `<div style="color:#b91c1c;">${(e && e.message) || 'Failed to load invoice'}</div>`;
            }
        }
        function renderInvoice(inv) {
            const el = document.getElementById('invoice-content');
            if (!el || !inv) return;
            const issued = new Date(inv.issuedAt);
            const eventD = inv.eventDate ? new Date(inv.eventDate) : null;
            const money = (n) => `$${Number(n || 0).toFixed(2)}`;
            const paymentsHtml = (Array.isArray(inv.payments) && inv.payments.length)
                ? `<div style="margin-top:8px;">${inv.payments.map(p => `
                        <div style="display:flex;justify-content:space-between;font-size:.92rem;padding:6px 0;border-bottom:1px dashed var(--border);">
                          <span>${new Date(p.CreatedAt).toLocaleString()} • ${p.Currency || 'USD'}</span>
                          <span>Paid ${money(p.Amount)} ${Number(p.FeeAmount||0)>0?`<span style='color:#6b7280'>(Fees: ${money(p.FeeAmount)})</span>`:''}</span>
                        </div>`).join('')}</div>`
                : `<div style="color:#6b7280;">No payments recorded yet.</div>`;
            const rows = (inv.lineItems || []).map((li, idx) => `
                <tr>
                  <td style="padding:8px 10px;">${idx+1}</td>
                  <td style="padding:8px 10px;">${(li.name || '').replace(/</g,'&lt;')}</td>
                  <td style="padding:8px 10px; text-align:center;">${li.quantity || 1}</td>
                  <td style="padding:8px 10px; text-align:right;">${money(li.unitPrice)}</td>
                  <td style="padding:8px 10px; text-align:right; font-weight:600;">${money(li.lineTotal)}</td>
                </tr>`).join('');
            const pfLabel = `Platform fee (${Number(inv.totals.platformFeePercent || 0)}%)`;
            const procSource = inv.totals.processingFeesSource === 'recorded' ? 'from Stripe' : 'estimated';
            el.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
                <div>
                  <div style="font-size:1.25rem;font-weight:700;">${inv.billFrom?.name || 'Vendor'}</div>
                  <div style="font-size:.95rem;color:#6b7280;">${inv.billFrom?.email || ''}${inv.billFrom?.phone?` • ${inv.billFrom.phone}`:''}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:1.4rem;font-weight:800;">INVOICE</div>
                  <div style="color:#6b7280;">${inv.invoiceNumber}</div>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
                <div style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:12px;">
                  <div style="font-weight:700;margin-bottom:6px;">Bill To</div>
                  <div>${inv.billTo?.name || ''}</div>
                  <div style="color:#6b7280;">${inv.billTo?.email || ''}${inv.billTo?.phone?` • ${inv.billTo.phone}`:''}</div>
                </div>
                <div style="background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:12px;">
                  <div style="display:flex;justify-content:space-between;">
                    <div>
                      <div style="color:#6b7280;">Issued</div>
                      <div>${issued.toLocaleDateString()}</div>
                    </div>
                    <div>
                      <div style="color:#6b7280;">Event Date</div>
                      <div>${eventD ? eventD.toLocaleDateString() : '-'}</div>
                    </div>
                    <div>
                      <div style="color:#6b7280;">Status</div>
                      <div style="text-transform:capitalize;">${inv.status || '-'}</div>
                    </div>
                  </div>
                </div>
              </div>
              <div style="margin-top:16px;">
                <table style="width:100%; border-collapse:collapse; border:1px solid var(--border);">
                  <thead>
                    <tr style="background:#f3f4f6; text-align:left;">
                      <th style="padding:10px; width:48px;">#</th>
                      <th style="padding:10px;">Item</th>
                      <th style="padding:10px; text-align:center; width:90px;">Qty</th>
                      <th style="padding:10px; text-align:right; width:120px;">Unit</th>
                      <th style="padding:10px; text-align:right; width:140px;">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows || '<tr><td colspan="5" style="padding:12px; text-align:center; color:#6b7280;">No items</td></tr>'}
                  </tbody>
                </table>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 360px; gap: 16px; margin-top:16px;">
                <div>
                  <div style="font-weight:700; margin-bottom:6px;">Payments</div>
                  ${paymentsHtml}
                </div>
                <div style="border:1px solid var(--border); border-radius:8px; padding:12px; background:#f9fafb;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span>Services Subtotal</span><strong>${money(inv.totals.servicesSubtotal)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span>Expenses</span><strong>${money(inv.totals.expensesTotal)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-top:1px dashed var(--border); margin-top:6px;">
                    <span>Subtotal</span><strong>${money(inv.totals.subtotal)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span>${pfLabel}</span><strong>${money(inv.totals.platformFee)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span>Processing fees <span style="color:#6b7280; font-weight:400;">(${procSource})</span></span><strong>${money(inv.totals.processingFees)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:8px 0; border-top:2px solid #e5e7eb; margin-top:6px; font-size:1.05rem;">
                    <span>Grand Total</span><strong>${money(inv.totals.grandTotal)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span>Total Paid</span><strong>${money(inv.totals.totalPaid)}</strong>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:8px 0;">
                    <span>Balance Due</span><strong style="color: var(--primary);">${money(inv.totals.balanceDue)}</strong>
                  </div>
                </div>
              </div>
            `;
        }
        async function downloadInvoicePDF() {
            try {
                const area = document.getElementById('invoice-print-area');
                if (!area) return;
                const { jsPDF } = window.jspdf || {};
                if (!window.html2canvas || !jsPDF) { alert('PDF libraries not loaded.'); return; }
                const canvas = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth - 40;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                if (imgHeight <= pageHeight - 40) {
                    pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
                } else {
                    let remainingHeight = imgHeight;
                    let imgPosition = 0;
                    const pageCanvas = document.createElement('canvas');
                    const pageCtx = pageCanvas.getContext('2d');
                    const ratio = imgWidth / canvas.width;
                    const sliceHeight = (pageHeight - 40) / ratio;
                    pageCanvas.width = canvas.width;
                    pageCanvas.height = sliceHeight;
                    while (remainingHeight > 0) {
                        pageCtx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
                        pageCtx.drawImage(canvas, 0, imgPosition, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
                        const pageImgData = pageCanvas.toDataURL('image/png');
                        pdf.addImage(pageImgData, 'PNG', 20, 20, imgWidth, pageHeight - 40);
                        remainingHeight -= (pageHeight - 40);
                        imgPosition += sliceHeight;
                        if (remainingHeight > 0) pdf.addPage();
                    }
                }
                const fileName = (lastInvoiceData?.invoiceNumber || `invoice-${lastInvoiceBookingId}`) + '.pdf';
                pdf.save(fileName);
            } catch (e) {
                console.error('downloadInvoicePDF error:', e);
                alert('Failed to generate PDF');
            }
        }
        
        // Ensure Step 3 vendor list matches the map height exactly
        function syncVendorPanelHeight() {
            const map = document.getElementById('vendor-map');
            const panel = document.getElementById('vendor-cards-container');
            const list = document.getElementById('vendor-horizontal-cards');
            if (!map || !panel || !list) return;
            const mapH = Math.round(map.getBoundingClientRect().height);
            if (mapH <= 0) return;
            const EXTRA_PX = 36; // make the list a tad bit longer than the map
            const header = panel.querySelector('.vendor-cards-header');
            let headerH = 0;
            if (header) {
                const cs = getComputedStyle(header);
                headerH = Math.round(header.getBoundingClientRect().height + parseFloat(cs.marginBottom || '0'));
            }
            // subtract panel vertical padding to ensure total matches map height
            const pcs = getComputedStyle(panel);
            const panelVPad = (parseFloat(pcs.paddingTop || '0') + parseFloat(pcs.paddingBottom || '0')) || 0;
            // include list borders when using border-box
            const lcs = getComputedStyle(list);
            const listBorders = (parseFloat(lcs.borderTopWidth || '0') + parseFloat(lcs.borderBottomWidth || '0')) || 0;
            const listH = Math.max(0, mapH - headerH - panelVPad - listBorders + EXTRA_PX);
            const hpx = listH + 'px';
            // lock panel to map height to avoid overflow rounding mismatches
            panel.style.height = (mapH + EXTRA_PX) + 'px';
            list.style.height = hpx;
            list.style.maxHeight = hpx;
            list.style.minHeight = hpx;
        }
        window.addEventListener('load', () => {
            syncVendorPanelHeight();
            // Retry a few times to catch late map initialization
            [100, 300, 800].forEach(t => setTimeout(syncVendorPanelHeight, t));
            // Observe map size changes if supported
            const mapEl = document.getElementById('vendor-map');
            if (window.ResizeObserver && mapEl) {
                const ro = new ResizeObserver(() => syncVendorPanelHeight());
                ro.observe(mapEl);
            }
        });
        window.addEventListener('resize', () => setTimeout(syncVendorPanelHeight, 50));
        // Recalculate when Step 3 visibility changes
        (function observeStep3Visibility(){
            const step3 = document.getElementById('booking-step-3');
            if (!step3) return;
            const isVisible = (el) => {
                const style = getComputedStyle(el);
                return style.display !== 'none' && style.visibility !== 'hidden';
            };
            const mo = new MutationObserver(() => {
                if (isVisible(step3)) setTimeout(syncVendorPanelHeight, 0);
            });
            mo.observe(step3, { attributes: true, attributeFilter: ['style','class'] });
        })();
        
        // Check for existing user session


        // Create a test user session for development
        function createTestUser() {
            // Don't set a test token to avoid auth errors
            // localStorage.setItem('token', 'test-token');
            
            // Create test user without token
            simulateLogin({
                id: 1,
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'T',
                isVendor: false
            });
            
            console.log('✅ Created test user for development (no token)');
        }
        
        // Global utility functions
        function showSuccess(message) {
            showBanner(message, 'success');
        }
        
        function showGlobalError(message) {
            try {
                // If any modal is visible, render the error inside that modal instead of the main page
                const modal = getVisibleModal();
                if (modal) {
                    renderModalError(modal, message);
                } else {
                    showBanner(message, 'error');
                }
            } catch (_) {
                // Fallback to global banner on any unexpected error
                showBanner(message, 'error');
            }
        }

        // Resolve the first visible modal (booking, vendor setup, dashboard, invoice, etc.)
        function getVisibleModal() {
            try {
                const ids = ['booking-modal', 'vendor-registration-modal', 'dashboard-modal', 'invoice-modal', 'profile-modal', 'chat-modal'];
                for (const id of ids) {
                    const el = document.getElementById(id);
                    if (!el) continue;
                    const display = (el.style && el.style.display) ? el.style.display : (window.getComputedStyle ? getComputedStyle(el).display : '');
                    if (display && display !== 'none') return el;
                }
                // Fallback: any .modal currently displayed
                const any = Array.from(document.querySelectorAll('.modal')).find(m => getComputedStyle(m).display !== 'none');
                return any || null;
            } catch { return null; }
        }

        // Render a styled error block inside the provided modal's body
        function renderModalError(modalEl, message) {
            if (!modalEl) return;
            const containerId = `${modalEl.id || 'modal'}-error-container`;
            let container = document.getElementById(containerId);
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                const modalBody = modalEl.querySelector('.modal-body') || modalEl;
                modalBody.insertBefore(container, modalBody.firstChild);
            }
            const safeMsg = (typeof message === 'string') ? message : (message && message.message) || String(message);
            container.innerHTML = `
                <div class="alert alert-error" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; color: var(--accent);">
                    <strong>Error:</strong> ${safeMsg}
                </div>
            `;
        }

        // Clear any modal-scoped error container content
        function clearModalError(modalEl) {
            try {
                if (!modalEl) return;
                const cid = `${modalEl.id || 'modal'}-error-container`;
                const container = document.getElementById(cid);
                if (container) container.innerHTML = '';
            } catch {}
        }
        
        // Helper function to get vendor profile ID
        async function getVendorProfileId() {
            if (currentUser?.vendorProfileId) {
                return currentUser.vendorProfileId;
            }
            
            if (!currentUser?.id) {
                throw new Error('User not logged in');
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch vendor status');
                
                const data = await response.json();
                if (data.isVendor && data.vendorProfileId) {
                    // Cache it for future use
                    currentUser.vendorProfileId = data.vendorProfileId;
                    return data.vendorProfileId;
                } else {
                    throw new Error('Vendor profile not found');
                }
            } catch (error) {
                console.error('Error fetching vendor status:', error);
                throw error;
            }
        }

        // Vendor Setup Reminder Banner
        function ensureSetupReminderContainer() {
            let container = document.getElementById('vendor-setup-reminder');
            if (!container) {
                container = document.createElement('div');
                container.id = 'vendor-setup-reminder';
                container.style.cssText = 'display:none; margin:16px 0; border:1px solid var(--border, #e5e7eb); background:#fff7ed; color:#7c2d12; border-radius:12px; padding:14px 16px; box-shadow:0 1px 2px rgba(0,0,0,0.04)';
                const main = document.querySelector('.main-content');
                if (main) {
                    main.insertBefore(container, main.firstChild);
                } else {
                    document.body.prepend(container);
                }
            }

            // Load client invoices (all accepted/approved/paid bookings)
            async function loadClientInvoices() {
                const container = document.getElementById('client-invoices-list');
                if (container) container.innerHTML = '<p>Loading invoices...</p>';
                if (!currentUser || !currentUser.id) {
                    if (container) container.innerHTML = '<p>Please log in to view invoices.</p>';
                    return;
                }
                try {
                    const resp = await fetch(`${API_BASE_URL}/users/${currentUser.id}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error('Failed to fetch bookings');
                    const bookings = await resp.json();
                    const accepted = (Array.isArray(bookings) ? bookings : []).filter(b => {
                        const s = (b.Status || '').toString().toLowerCase();
                        return s === 'confirmed' || s === 'paid' || s === 'approved';
                    }).sort((a,b) => new Date(b.EventDate) - new Date(a.EventDate));
                    renderInvoicesList(accepted, container, 'client');
                } catch (e) {
                    console.error('loadClientInvoices error:', e);
                    if (container) container.innerHTML = `<p style="color:var(--accent);">${e.message || 'Failed to load invoices'}</p>`;
                }
            }

            // Load vendor invoices (bookings for vendor profile)
            async function loadVendorInvoices(vendorProfileId) {
                const container = document.getElementById('vendor-invoices-list');
                if (container) container.innerHTML = '<p>Loading invoices...</p>';
                if (!vendorProfileId) {
                    if (container) container.innerHTML = '<p>Vendor profile not found.</p>';
                    return;
                }
                try {
                    const resp = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error('Failed to fetch vendor bookings');
                    const bookings = await resp.json();
                    const accepted = (Array.isArray(bookings) ? bookings : []).filter(b => {
                        const s = (b.Status || '').toString().toLowerCase();
                        return s === 'confirmed' || s === 'paid' || s === 'approved';
                    }).sort((a,b) => new Date(b.EventDate) - new Date(a.EventDate));
                    renderInvoicesList(accepted, container, 'vendor');
                } catch (e) {
                    console.error('loadVendorInvoices error:', e);
                    if (container) container.innerHTML = `<p style="color:var(--accent);">${e.message || 'Failed to load invoices'}</p>`;
                }
            }

            // Render invoice list cards
            function renderInvoicesList(bookings, container, viewerRole) {
                if (!container) return;
                container.innerHTML = '';
                if (!Array.isArray(bookings) || bookings.length === 0) {
                    container.innerHTML = '<p>No invoices available.</p>';
                    return;
                }
                const html = bookings.map(b => {
                    const eventDate = new Date(b.EventDate);
                    const month = eventDate.toLocaleDateString('en-US', { month: 'short' });
                    const day = eventDate.getDate();
                    const weekday = eventDate.toLocaleDateString('en-US', { weekday: 'short' });
                    const name = viewerRole === 'vendor' ? (b.ClientName || 'Client') : (b.VendorName || 'Vendor');
                    const total = (b.TotalAmount != null) ? `$${Number(b.TotalAmount).toFixed(2)}` : '';
                    const status = (b.Status || '').toString().toLowerCase();
                    const paid = (b.FullAmountPaid === true || b.FullAmountPaid === 1);
                    return `
                        <div class="booking-item">
                            <div class="booking-date-section">
                                <div class="booking-month">${month}</div>
                                <div class="booking-day">${day}</div>
                                <div class="booking-weekday">${weekday}</div>
                            </div>
                            <div class="booking-info">
                                <div class="booking-client"><i class="fas fa-store" style="color:#6b7280;font-size:12px;"></i><span class="booking-client-name">${name}</span></div>
                                <div class="booking-service-row"><span class="booking-service">Confirmed Booking</span></div>
                                ${total ? `<div class=\"booking-price-row\"><i class=\"fas fa-dollar-sign\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-price\">${total}</span></div>` : ''}
                            </div>
                            <div class="booking-actions">
                                <span class="request-status ${paid ? 'paid' : status}" style="margin-right:12px;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;text-transform:capitalize;">${paid ? 'Paid' : (status === 'confirmed' ? 'Accepted' : status)}</span>
                                <button class="btn btn-outline btn-sm" onclick="openInvoiceModal('${b.BookingID}')">View</button>
                                <button class="btn btn-primary btn-sm" style="margin-left:8px;" onclick="downloadInvoiceForBooking('${b.BookingID}')">Download</button>
                            </div>
                        </div>
                    `;
                }).join('');
                container.innerHTML = html;
            }

            // Convenience: open invoice then download as PDF
            async function downloadInvoiceForBooking(bookingId) {
                try {
                    await openInvoiceModal(bookingId);
                    // Give the UI a moment to render then download
                    setTimeout(() => { try { downloadInvoicePDF(); } catch(_) {} }, 350);
                } catch (e) {
                    alert(e?.message || 'Failed to download invoice');
                }
            }
            return container;
        }

        // Invoices: global functions moved to top-level scope (not nested inside other functions)
        // Load client invoices (all accepted/approved/paid bookings)
        async function loadClientInvoices() {
            const container = document.getElementById('client-invoices-list');
            if (container) container.innerHTML = '<p>Loading invoices...</p>';
            if (!currentUser || !currentUser.id) {
                if (container) container.innerHTML = '<p>Please log in to view invoices.</p>';
                return;
            }
            try {
                // Primary: fetch invoices directly
                const resp1 = await fetch(`${API_BASE_URL}/invoices/user/${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!resp1.ok) throw new Error('Failed to fetch invoices');
                const data = await resp1.json();
                const invoices = Array.isArray(data?.invoices) ? data.invoices : [];
                renderInvoicesList(invoices, container, 'client');
            } catch (e) {
                // Fallback: legacy bookings-based list
                try {
                    const resp = await fetch(`${API_BASE_URL}/users/${currentUser.id}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error('Failed to fetch bookings');
                    const bookings = await resp.json();
                    const accepted = (Array.isArray(bookings) ? bookings : []).filter(b => {
                        const s = (b.Status || '').toString().toLowerCase();
                        return s === 'confirmed' || s === 'paid' || s === 'approved';
                    }).sort((a,b) => new Date(b.EventDate) - new Date(a.EventDate));
                    renderInvoicesList(accepted, container, 'client');
                } catch (e2) {
                    console.error('loadClientInvoices error:', e2);
                    if (container) container.innerHTML = `<p style="color:var(--accent);">${(e2 && e2.message) || 'Failed to load invoices'}</p>`;
                }
            }
        }

        // Load vendor invoices (bookings for vendor profile)
        async function loadVendorInvoices(vendorProfileId) {
            const container = document.getElementById('vendor-invoices-list');
            if (container) container.innerHTML = '<p>Loading invoices...</p>';
            if (!vendorProfileId) {
                if (container) container.innerHTML = '<p>Vendor profile not found.</p>';
                return;
            }
            try {
                // Primary: fetch invoices directly
                const resp1 = await fetch(`${API_BASE_URL}/invoices/vendor/${vendorProfileId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!resp1.ok) throw new Error('Failed to fetch vendor invoices');
                const data = await resp1.json();
                const invoices = Array.isArray(data?.invoices) ? data.invoices : [];
                renderInvoicesList(invoices, container, 'vendor');
            } catch (e) {
                // Fallback: legacy bookings-based list
                try {
                    const resp = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error('Failed to fetch vendor bookings');
                    const bookings = await resp.json();
                    const accepted = (Array.isArray(bookings) ? bookings : []).filter(b => {
                        const s = (b.Status || '').toString().toLowerCase();
                        return s === 'confirmed' || s === 'paid' || s === 'approved';
                    }).sort((a,b) => new Date(b.EventDate) - new Date(a.EventDate));
                    renderInvoicesList(accepted, container, 'vendor');
                } catch (e2) {
                    console.error('loadVendorInvoices error:', e2);
                    if (container) container.innerHTML = `<p style="color:var(--accent);">${(e2 && e2.message) || 'Failed to load invoices'}</p>`;
                }
            }
        }

        // Render invoice list as a table (client and vendor) with search + sortable headers
        function renderInvoicesList(bookings, container, viewerRole) {
            if (!container) return;
            const listId = container.id || 'invoices-list';
            // State per list container
            window._invoiceListState = window._invoiceListState || {};
            const state = window._invoiceListState[listId] || {
                sortKey: 'date', // date | name | status | amount | invoice | due
                sortDir: 'desc',
                search: '',
                meta: {} // bookingId -> { invoiceNumber, dueDate }
            };
            state.viewerRole = viewerRole;
            state.bookings = Array.isArray(bookings) ? bookings.slice() : [];
            window._invoiceListState[listId] = state;

            // Inject CSS once for tabular look
            if (!window._invoicesTableCSSApplied) {
                const style = document.createElement('style');
                style.id = 'invoices-table-css';
                style.textContent = `
                    .invoices-table{border-collapse:collapse;width:100%;}
                    .invoices-table th,.invoices-table td{padding:6px 8px;border:1px solid var(--border, #e5e7eb); background: var(--secondary, #fff);} 
                    .invoices-table thead th{background:#f9fafb;color:#374151;font-weight:600;position:sticky;top:0;z-index:1;}
                    .invoices-table tbody tr:nth-child(even) td{background:#fbfdff;}
                    .invoices-table tbody tr:hover td{background:#f3f4f6;}
                    .invoices-table th.sortable{cursor:pointer;user-select:none;}
                    .invoices-table th.sortable.sorted-asc::after{content:' ▲';}
                    .invoices-table th.sortable.sorted-desc::after{content:' ▼';}
                    .ta-right{text-align:right;}
                    .ta-center{text-align:center;}
                    .nowrap{white-space:nowrap;}
                    .inv-actions{display:inline-flex;align-items:center;gap:4px;}
                    .inv-actions .btn{margin:0;}
                    /* Freeze first column (Actions) */
                    .invoices-table th:first-child, .invoices-table td:first-child { position: sticky; left: 0; }
                    .invoices-table thead th:first-child { z-index: 3; }
                    .invoices-table tbody td:first-child { z-index: 2; box-shadow: 2px 0 0 var(--border, #e5e7eb); }
                    .invoices-table tbody tr:nth-child(odd) td:first-child { background: var(--secondary, #fff); }
                    .invoices-table tbody tr:nth-child(even) td:first-child { background: #fbfdff; }
                    .invoices-table tbody tr:hover td:first-child { background: #f3f4f6; }
                `;
                document.head.appendChild(style);
                window._invoicesTableCSSApplied = true;
            }

            if (!Array.isArray(bookings) || bookings.length === 0) {
                container.innerHTML = '<p>No invoices available.</p>';
                return;
            }

            // Toolbar + table shell
            container.innerHTML = `
                <div class="invoices-toolbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input id="${listId}-search" type="text" placeholder="Search by name, status, invoice #, service" style="padding:8px 10px;border:1px solid var(--border, #e5e7eb);border-radius:6px;min-width:260px;">
                        <button id="${listId}-clear" class="btn btn-outline btn-sm">Clear</button>
                    </div>
                    <div id="${listId}-count" style="color:#6b7280;font-size:.9rem;"></div>
                </div>
                <div class="invoices-table-wrap"></div>
            `;

            const tableWrap = container.querySelector('.invoices-table-wrap');
            const searchEl = container.querySelector(`#${listId}-search`);
            const clearEl = container.querySelector(`#${listId}-clear`);
            const countEl = container.querySelector(`#${listId}-count`);
            if (searchEl) {
                searchEl.value = state.search || '';
                searchEl.addEventListener('input', debounce(() => {
                    state.search = searchEl.value.trim();
                    renderBody();
                }, 200));
            }
            clearEl?.addEventListener('click', () => {
                state.search = '';
                if (searchEl) searchEl.value = '';
                renderBody();
            });

            function normalize(v){ return (v||'').toString().toLowerCase(); }
            function formatDate(d){ try{ const dt = new Date(d); return dt.toLocaleDateString([], { month:'short', day:'2-digit', year:'numeric' }); } catch{ return ''; } }

            function filteredAndSorted(){
                let arr = state.bookings.slice();
                if (state.search) {
                    const q = normalize(state.search);
                    arr = arr.filter(b => {
                        const name = state.viewerRole === 'vendor' ? (b.ClientName || '') : (b.VendorName || '');
                        const status = b.InvoiceStatus || b.Status || '';
                        const invNum = state.meta[b.BookingID]?.invoiceNumber || b.InvoiceNumber || '';
                        const svc = state.meta[b.BookingID]?.servicesSummary || b.ServicesSummary || '';
                        const evn = state.meta[b.BookingID]?.eventName || b.EventName || '';
                        const typ = state.meta[b.BookingID]?.eventType || b.EventType || '';
                        const loc = state.meta[b.BookingID]?.eventLocation || b.EventLocation || '';
                        const tz = state.meta[b.BookingID]?.timeZone || b.TimeZone || '';
                        const guests = (state.meta[b.BookingID]?.attendeeCount != null) ? String(state.meta[b.BookingID]?.attendeeCount) : ((b.AttendeeCount!=null)? String(b.AttendeeCount) : '');
                        return normalize(name).includes(q) || normalize(status).includes(q) || normalize(invNum).includes(q) || normalize(svc).includes(q) || normalize(evn).includes(q) || normalize(typ).includes(q) || normalize(loc).includes(q) || normalize(tz).includes(q) || normalize(guests).includes(q);
                    });
                }
                const dir = state.sortDir === 'asc' ? 1 : -1;
                const key = state.sortKey;
                arr.sort((a,b) => {
                    const av = key === 'date' ? new Date(a.EventDate || 0) :
                               key === 'amount' ? Number(a.TotalAmount || 0) :
                               key === 'name' ? normalize(state.viewerRole === 'vendor' ? (a.ClientName||'') : (a.VendorName||'')) :
                               key === 'status' ? normalize(a.InvoiceStatus || a.Status || '') :
                               key === 'service' ? normalize(state.meta[a.BookingID]?.servicesSummary || a.ServicesSummary || '') :
                               key === 'time' ? new Date(a.EventDate || 0) :
                               key === 'type' ? normalize(state.meta[a.BookingID]?.eventType || a.EventType || '') :
                               key === 'tz' ? normalize(state.meta[a.BookingID]?.timeZone || a.TimeZone || '') :
                               key === 'location' ? normalize(state.meta[a.BookingID]?.eventLocation || a.EventLocation || '') :
                               key === 'guests' ? Number((state.meta[a.BookingID]?.attendeeCount != null) ? state.meta[a.BookingID]?.attendeeCount : (a.AttendeeCount != null ? a.AttendeeCount : -1)) :
                               key === 'invoice' ? (state.meta[a.BookingID]?.invoiceNumber || a.InvoiceNumber || '') :
                               key === 'due' ? new Date(state.meta[a.BookingID]?.dueDate || a.DueDate || 0) : new Date(a.EventDate || 0);
                    const bv = key === 'date' ? new Date(b.EventDate || 0) :
                               key === 'amount' ? Number(b.TotalAmount || 0) :
                               key === 'name' ? normalize(state.viewerRole === 'vendor' ? (b.ClientName||'') : (b.VendorName||'')) :
                               key === 'status' ? normalize(b.InvoiceStatus || b.Status || '') :
                               key === 'service' ? normalize(state.meta[b.BookingID]?.servicesSummary || b.ServicesSummary || '') :
                               key === 'time' ? new Date(b.EventDate || 0) :
                               key === 'type' ? normalize(state.meta[b.BookingID]?.eventType || b.EventType || '') :
                               key === 'tz' ? normalize(state.meta[b.BookingID]?.timeZone || b.TimeZone || '') :
                               key === 'location' ? normalize(state.meta[b.BookingID]?.eventLocation || b.EventLocation || '') :
                               key === 'guests' ? Number((state.meta[b.BookingID]?.attendeeCount != null) ? state.meta[b.BookingID]?.attendeeCount : (b.AttendeeCount != null ? b.AttendeeCount : -1)) :
                               key === 'invoice' ? (state.meta[b.BookingID]?.invoiceNumber || b.InvoiceNumber || '') :
                               key === 'due' ? new Date(state.meta[b.BookingID]?.dueDate || b.DueDate || 0) : new Date(b.EventDate || 0);
                    if (av < bv) return -1*dir;
                    if (av > bv) return 1*dir;
                    return 0;
                });
                return arr;
            }

            function applyHeaderSortClasses(){
                tableWrap.querySelectorAll('th[data-sort]')?.forEach(th => {
                    th.classList.remove('sorted-asc','sorted-desc','sortable');
                    th.classList.add('sortable');
                    const k = th.getAttribute('data-sort');
                    if (k === state.sortKey) th.classList.add(state.sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                });
            }

            function renderBody(){
                const list = filteredAndSorted();
                if (countEl) countEl.textContent = `${list.length} item${list.length!==1?'s':''}`;
                const rows = list.map(b => {
                    const eventDate = b.EventDate ? new Date(b.EventDate) : null;
                    const dateStr = eventDate ? formatDate(eventDate) : '';
                    const name = state.viewerRole === 'vendor' ? (b.ClientName || 'Client') : (b.VendorName || 'Vendor');
                    const total = (b.TotalAmount != null) ? `$${Number(b.TotalAmount).toFixed(2)}` : '';
                    const statusRaw = (b.InvoiceStatus || b.Status || '').toString().toLowerCase();
                    const statusLabel = statusRaw === 'confirmed' ? 'Accepted' : (statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1));
                    const meta = state.meta[b.BookingID] || {};
                    const invNum = meta.invoiceNumber || b.InvoiceNumber || '—';
                    const due = meta.dueDate ? formatDate(meta.dueDate) : (b.DueDate ? formatDate(b.DueDate) : '—');
                    const svc = meta.servicesSummary || b.ServicesSummary || '—';
                    const typ = meta.eventType || b.EventType || '';
                    const loc = meta.eventLocation || b.EventLocation || '';
                    const tz = meta.timeZone || b.TimeZone || '';
                    const guests = (meta.attendeeCount != null) ? `${meta.attendeeCount} guests` : ((b.AttendeeCount!=null)? `${b.AttendeeCount} guests` : '');
                    const timeTxt = meta.eventTimeText || (() => {
                        if (b.EventDate) {
                            try {
                                const bd = new Date(b.EventDate);
                                const ed = b.EndDate ? new Date(b.EndDate) : null;
                                const t1 = bd.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                                const t2 = ed ? ed.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : null;
                                return t2 ? `${t1} – ${t2}` : `${t1}`;
                            } catch { return ''; }
                        }
                        return '';
                    })();
                    return `
                        <tr>
                            <td class="nowrap ta-center" style="white-space:nowrap;">
                                <div class="inv-actions">
                                    <button class="btn btn-outline btn-sm" title="View invoice" aria-label="View invoice" onclick="openInvoiceModal('${b.BookingID}')">
                                        <i class="fa-solid fa-eye" aria-hidden="true"></i>
                                    </button>
                                    <button class="btn btn-outline btn-sm" title="Download PDF" aria-label="Download PDF" onclick="downloadInvoiceForBooking('${b.BookingID}')">
                                        <i class="fa-solid fa-cloud-arrow-down" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </td>
                            <td data-invnum="${b.BookingID}" class="nowrap" style="white-space:nowrap;color:#111827;">${invNum}</td>
                            <td class="nowrap" style="white-space:nowrap;color:#374151;">${dateStr}</td>
                            <td class="nowrap" style="white-space:nowrap;color:#111827;">${name}</td>
                            <td data-invsvc="${b.BookingID}" class="nowrap" style="white-space:nowrap;color:#111827;">${svc}</td>
                            <td data-invtime="${b.BookingID}" class="nowrap" style="white-space:nowrap;color:#6b7280;">${timeTxt}</td>
                            <td data-invtype="${b.BookingID}" class="nowrap" style="white-space:nowrap;color:#6b7280;">${typ}</td>
                            <td data-invtz="${b.BookingID}" class="nowrap" style="white-space:nowrap;color:#6b7280;">${tz}</td>
                            <td data-invloc="${b.BookingID}" class="nowrap" style="white-space:nowrap;color:#6b7280;">${loc}</td>
                            <td data-invguests="${b.BookingID}" class="ta-right nowrap" style="white-space:nowrap;color:#6b7280;">${(meta.attendeeCount!=null)? meta.attendeeCount : (b.AttendeeCount!=null? b.AttendeeCount : '')}</td>
                            <td class="nowrap" style="white-space:nowrap;text-transform:capitalize;color:#374151;">${statusLabel || ''}</td>
                            <td class="ta-right nowrap" style="white-space:nowrap;color:#111827;">${total}</td>
                            <td data-invdue="${b.BookingID}" class="ta-right nowrap" style="white-space:nowrap;color:#374151;">${due}</td>
                        </tr>
                    `;
                }).join('');

                tableWrap.innerHTML = `
                    <div style="overflow:auto;">
                        <table role="table" aria-label="Invoices" class="invoices-table">
                            <thead>
                                <tr>
                                    <th class="ta-center">Actions</th>
                                    <th data-sort="invoice" class="sortable">Invoice #</th>
                                    <th data-sort="date" class="sortable">Date</th>
                                    <th data-sort="name" class="sortable">Client</th>
                                    <th data-sort="service" class="sortable">Service</th>
                                    <th data-sort="time" class="sortable">Time</th>
                                    <th data-sort="type" class="sortable">Type</th>
                                    <th data-sort="tz" class="sortable">Timezone</th>
                                    <th data-sort="location" class="sortable">Location</th>
                                    <th data-sort="guests" class="sortable ta-right">Guests</th>
                                    <th data-sort="status" class="sortable">Status</th>
                                    <th data-sort="amount" class="sortable ta-right">Amount</th>
                                    <th data-sort="due" class="sortable ta-right">Due Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;

                // Sorting handlers
                tableWrap.querySelectorAll('th[data-sort]')?.forEach(th => {
                    th.addEventListener('click', () => {
                        const k = th.getAttribute('data-sort');
                        if (state.sortKey === k) {
                            state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
                        } else {
                            state.sortKey = k; state.sortDir = 'asc';
                        }
                        renderBody();
                    });
                });

                prefetchMeta(list);

                // Update header sort indicators
                applyHeaderSortClasses();
            }

            async function prefetchMeta(list){
                // Seed meta from list rows if available; then fetch remaining minimal set
                list.forEach(b => {
                    const existing = state.meta[b.BookingID];
                    if (!existing) {
                        const seeded = {
                            invoiceNumber: b.InvoiceNumber,
                            dueDate: b.DueDate ? new Date(b.DueDate) : null,
                            servicesSummary: b.ServicesSummary,
                            eventName: b.EventName,
                            eventType: b.EventType,
                            eventLocation: b.EventLocation,
                            timeZone: b.TimeZone,
                            attendeeCount: b.AttendeeCount,
                            eventTimeText: (function(){
                                try{
                                    const bd = b.EventDate ? new Date(b.EventDate) : null;
                                    const ed = b.EndDate ? new Date(b.EndDate) : null;
                                    if (!bd) return '';
                                    const t1 = bd.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                                    const t2 = ed ? ed.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : null;
                                    return t2 ? `${t1} – ${t2}` : `${t1}`;
                                } catch { return ''; }
                            })()
                        };
                        state.meta[b.BookingID] = seeded;
                    }
                });
                const toFetch = list.filter(b => {
                    const m = state.meta[b.BookingID];
                    if (!m) return true;
                    const missingInvoice = !m.invoiceNumber;
                    const missingEvent = !m.eventName && !m.eventLocation && !m.eventType;
                    const missingServices = !m.servicesSummary;
                    return missingInvoice || missingEvent || missingServices;
                }).slice(0, 20);
                for (const b of toFetch) {
                    try {
                        const meta = await tryFetchInvoiceMeta(b.BookingID);
                        if (meta) {
                            state.meta[b.BookingID] = { ...state.meta[b.BookingID], ...meta };
                            const numCell = container.querySelector(`[data-invnum='${b.BookingID}']`);
                            const dueCell = container.querySelector(`[data-invdue='${b.BookingID}']`);
                            const svcCell = container.querySelector(`[data-invsvc='${b.BookingID}']`);
                            const timeCell = container.querySelector(`[data-invtime='${b.BookingID}']`);
                            const typeCell = container.querySelector(`[data-invtype='${b.BookingID}']`);
                            const tzCell = container.querySelector(`[data-invtz='${b.BookingID}']`);
                            const locCell = container.querySelector(`[data-invloc='${b.BookingID}']`);
                            const guestsCell = container.querySelector(`[data-invguests='${b.BookingID}']`);
                            if (numCell) numCell.textContent = state.meta[b.BookingID].invoiceNumber || '—';
                            if (dueCell) dueCell.textContent = state.meta[b.BookingID].dueDate ? formatDate(state.meta[b.BookingID].dueDate) : '—';
                            if (svcCell) svcCell.textContent = state.meta[b.BookingID].servicesSummary || state.meta[b.BookingID].eventName || '—';
                            if (timeCell) timeCell.textContent = state.meta[b.BookingID].eventTimeText || '';
                            if (typeCell) typeCell.textContent = state.meta[b.BookingID].eventType || '';
                            if (tzCell) tzCell.textContent = state.meta[b.BookingID].timeZone || '';
                            if (locCell) locCell.textContent = state.meta[b.BookingID].eventLocation || '';
                            if (guestsCell) guestsCell.textContent = (state.meta[b.BookingID].attendeeCount!=null) ? state.meta[b.BookingID].attendeeCount : '';
                        }
                    } catch(_) {}
                }
            }

            async function tryFetchInvoiceMeta(bookingId){
                const uid = (window.currentUser && currentUser.id) ? currentUser.id : (typeof getUserIdFromToken === 'function' ? getUserIdFromToken() : null);
                if (!uid) return null;
                const primaryUrl = `${API_BASE_URL}/invoices/booking/${bookingId}?userId=${uid}`;
                try {
                    const resp = await fetch(primaryUrl, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` } });
                    const ct = resp.headers.get('content-type') || '';
                    if (!resp.ok || !ct.includes('application/json')) return null;
                    const data = await resp.json();
                    if (!data || !data.success || !data.invoice) return null;
                    const inv = data.invoice;
                    // Parse snapshot for services and times
                    let servicesSummary = '';
                    let eventTimeText = '';
                    let eventName = '';
                    let eventType = '';
                    let eventLocation = '';
                    let attendeeCount = null;
                    let timeZone = '';
                    try {
                        const snap = typeof inv.SnapshotJSON === 'string' ? JSON.parse(inv.SnapshotJSON) : (inv.SnapshotJSON || {});
                        const svcArr = Array.isArray(snap.services) ? snap.services : [];
                        const names = svcArr.map(s => s.ServiceName).filter(Boolean);
                        if (names.length > 0) {
                            const show = names.slice(0,2).join(', ');
                            const more = names.length > 2 ? ` +${names.length-2} more` : '';
                            servicesSummary = `${names.length} service${names.length>1?'s':''}: ${show}${more}`;
                        }
                        const bd = snap.booking?.EventDate ? new Date(snap.booking.EventDate) : null;
                        const ed = snap.booking?.EndDate ? new Date(snap.booking.EndDate) : null;
                        if (bd) {
                            const t1 = bd.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                            const t2 = ed ? ed.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : null;
                            eventTimeText = t2 ? `${t1} – ${t2}` : `${t1}`;
                        }
                        // Try to get event fields if present in snapshot
                        eventName = snap.booking?.EventName || snap.booking?.eventName || '';
                        eventType = snap.booking?.EventType || snap.booking?.eventType || '';
                        eventLocation = snap.booking?.EventLocation || snap.booking?.eventLocation || '';
                        timeZone = snap.booking?.TimeZone || snap.booking?.timeZone || '';
                        attendeeCount = (snap.booking && (snap.booking.AttendeeCount ?? snap.booking.attendeeCount)) ?? null;
                    } catch(_) {}

                    // Fill from invoice.booking if available (server enriches invoice with booking)
                    if (inv.booking) {
                        eventName = eventName || inv.booking.EventName || inv.booking.eventName || '';
                        eventType = eventType || inv.booking.EventType || inv.booking.eventType || '';
                        eventLocation = eventLocation || inv.booking.EventLocation || inv.booking.eventLocation || '';
                        timeZone = timeZone || inv.booking.TimeZone || inv.booking.timeZone || '';
                    }

                    // Compute servicesSummary from invoice items if missing
                    if (!servicesSummary && Array.isArray(inv.items)) {
                        const n2 = inv.items
                            .filter(it => (String(it.ItemType || '')).toLowerCase().includes('service'))
                            .map(it => it.Title)
                            .filter(Boolean);
                        if (n2.length > 0) {
                            const show = n2.slice(0,2).join(', ');
                            const more = n2.length > 2 ? ` +${n2.length-2} more` : '';
                            servicesSummary = `${n2.length} service${n2.length>1?'s':''}: ${show}${more}`;
                        }
                    }

                    // If any essential event fields missing, fetch booking details
                    if (!eventName || !eventType || !eventLocation || attendeeCount == null || !timeZone) {
                        try {
                            const detUrl = `${API_BASE_URL}/bookings/${bookingId}?userId=${uid}`;
                            const detResp = await fetch(detUrl, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` } });
                            const dct = detResp.headers.get('content-type') || '';
                            if (detResp.ok && dct.includes('application/json')) {
                                const det = await detResp.json();
                                const info = det?.info || det?.booking?.info || det || {};
                                const getFirst = (obj, keys) => {
                                    for (const k of keys) { if (obj && obj[k] != null && obj[k] !== '') return obj[k]; }
                                    return '';
                                };
                                eventName = getFirst(info, ['EventName','eventName','Name','name','Title','title']) || eventName;
                                eventType = getFirst(info, ['EventType','eventType','Type','type']) || eventType;
                                eventLocation = getFirst(info, ['EventLocation','eventLocation','Location','location','Address','address']) || eventLocation;
                                timeZone = getFirst(info, ['TimeZone','timeZone','Timezone','timezone']) || timeZone;
                                const guestsVal = getFirst(info, ['AttendeeCount','attendeeCount','Guests','guests','GuestCount','guestCount']);
                                if (guestsVal !== '') attendeeCount = Number(guestsVal) || null;

                                // Compute servicesSummary from booking services if still missing
                                if (!servicesSummary) {
                                    const sArr = Array.isArray(det?.services) ? det.services : [];
                                    const sn = sArr.map(s => s.ServiceName || s.Name || s.Title).filter(Boolean);
                                    if (sn.length > 0) {
                                        const show = sn.slice(0,2).join(', ');
                                        const more = sn.length > 2 ? ` +${sn.length-2} more` : '';
                                        servicesSummary = `${sn.length} service${sn.length>1?'s':''}: ${show}${more}`;
                                    }
                                }
                            }
                        } catch (_) {}
                    }
                    return {
                        invoiceNumber: inv.InvoiceNumber || inv.invoiceNumber || null,
                        dueDate: inv.DueDate || inv.dueDate || null,
                        servicesSummary,
                        eventTimeText,
                        eventName,
                        eventType,
                        eventLocation,
                        attendeeCount,
                        timeZone
                    };
                } catch { return null; }
            }

            function debounce(fn, ms){ let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }

            renderBody();
        }

        // Convenience: open invoice then download as PDF
        async function downloadInvoiceForBooking(bookingId) {
            try {
                await openInvoiceModal(bookingId);
                // Give the UI a moment to render then download
                setTimeout(() => { try { downloadInvoicePDF(); } catch(_) {} }, 350);
            } catch (e) {
                alert(e?.message || 'Failed to download invoice');
            }
        }

        function getUserIdFromToken() {
            try {
                const t = localStorage.getItem('token');
                if (!t || t.split('.').length !== 3) return null;
                const payload = JSON.parse(atob(t.split('.')[1]));
                return payload.userId || payload.id || null;
            } catch (_) { return null; }
        }

        async function renderVendorSetupReminder() {
            try {
                // Don't show on dedicated vendor profile page
                if (typeof vendorProfilePage !== 'undefined' && vendorProfilePage && vendorProfilePage.style.display === 'block') {
                    const banner = document.getElementById('vendor-setup-reminder');
                    if (banner) banner.style.display = 'none';
                    return;
                }

                // Rehydrate current user if needed
                if (!currentUser && typeof getCurrentUser === 'function') {
                    const stored = getCurrentUser();
                    if (stored) currentUser = stored;
                }

                const userId = currentUser?.id || getUserIdFromToken();
                if (!userId) {
                    const banner = document.getElementById('vendor-setup-reminder');
                    if (banner) banner.style.display = 'none';
                    return;
                }

                // Cleanup any legacy per-day flag (we'll decide visibility after we know completion status)
                try { localStorage.removeItem('vv_hideSetupReminderUntil'); } catch (_) {}

                // First, verify vendor status
                const statusRes = await fetch(`${API_BASE_URL}/vendors/status?userId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` }
                });
                if (!statusRes.ok) {
                    const banner = document.getElementById('vendor-setup-reminder');
                    if (banner) banner.style.display = 'none';
                    return;
                }
                const status = await statusRes.json();
                if (!status.isVendor) {
                    const banner = document.getElementById('vendor-setup-reminder');
                    if (banner) banner.style.display = 'none';
                    return;
                }

                // Get detailed setup status from vendor dashboard API
                const setupRes = await fetch(`${API_BASE_URL}/vendor/${userId}/setup-status`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` }
                });
                if (!setupRes.ok) {
                    const banner = document.getElementById('vendor-setup-reminder');
                    if (banner) banner.style.display = 'none';
                    return;
                }
                const setup = await setupRes.json();
                const allComplete = setup.allRequiredComplete ?? setup?.setupStatus?.allRequiredComplete;
                const incompleteSteps = setup.incompleteSteps ?? setup?.setupStatus?.incompleteSteps ?? [];
                const labelMap = {
                    basics: 'Business Basics',
                    location: 'Location Information',
                    additionalDetails: 'Additional Details',
                    social: 'Social Media',
                    servicesPackages: 'Services & Packages',
                    faq: 'FAQ Section',
                    gallery: 'Gallery & Media',
                    availability: 'Availability & Scheduling',
                    verification: 'Verification & legal',
                    policies: 'Policies',
                    stripe: 'Stripe payouts'
                };
                const stepsObj = setup.steps ?? setup?.setupStatus?.steps ?? {};
                // Only count required steps in the header (exclude optional 'policies') to match backend requiredOrder
                const requiredKeys = ['basics','location','additionalDetails','social','servicesPackages','faq','gallery','availability','verification','stripe'];
                const completedStepKeys = requiredKeys.filter(k => stepsObj[k]);
                const completedChips = completedStepKeys.map(k => `
                    <span data-step-key="${k}" style="display:inline-flex;align-items:center;gap:6px;background:#ecfdf5;color:#166534;border:1px solid #bbf7d0;border-radius:999px;padding:4px 10px;font-size:.85rem;white-space:nowrap;cursor:pointer;" title="Open ${labelMap[k] || k} settings">
                        <i class="fas fa-check-circle"></i>${labelMap[k] || k}
                    </span>
                `).join(' ');

                if (allComplete) {
                    // Clear any persisted hides once setup is complete
                    try {
                        localStorage.removeItem(`vv_hideSetupReminderUntilComplete_${userId}`);
                        sessionStorage.removeItem('vv_hideSetupReminderThisSession');
                    } catch (_) {}
                    const banner = document.getElementById('vendor-setup-reminder');
                    if (banner) banner.style.display = 'none';
                    return;
                }

                // Respect dismiss for this session only and bind it to current login token
                // This ensures banner reappears on next login even within the same tab
                try {
                    const token = localStorage.getItem('token') || '';
                    const tokenKey = token ? token.slice(-16) : 'no_token';
                    const sessKey = `vv_hideSetupReminderThisSession_${userId}_${tokenKey}`;
                    const sessionHide = sessionStorage.getItem(sessKey) === '1';
                    if (sessionHide) {
                        const banner = document.getElementById('vendor-setup-reminder');
                        if (banner) banner.style.display = 'none';
                        return;
                    }
                    // Clean legacy session/persistent flags
                    try {
                        sessionStorage.removeItem('vv_hideSetupReminderThisSession');
                        sessionStorage.removeItem(`vv_hideSetupReminderThisSession_${userId}`);
                    } catch (_) {}
                    try { localStorage.removeItem(`vv_hideSetupReminderUntilComplete_${userId}`); } catch (_) {}
                } catch (_) {}

                const banner = ensureSetupReminderContainer();
                const stepsHtml = incompleteSteps.slice(0, 6).map(s => `
                    <span data-step-key="${(s && (s.key || s))}" style="display:inline-flex;align-items:center;gap:6px;background:#ffedd5;color:#7c2d12;border:1px solid #fed7aa;border-radius:999px;padding:4px 10px;font-size:.85rem;white-space:nowrap;cursor:pointer;" title="Open ${(s && (labelMap[s.key] || s.label || s))} settings">
                        <i class="fas fa-circle-xmark"></i>${s.label || s.key}
                    </span>
                `).join(' ');
                const moreCount = Math.max(0, incompleteSteps.length - 6);
                const completedCount = completedStepKeys.length;
                const totalSteps = requiredKeys.length;

                banner.innerHTML = `
                    <div style="display:flex;gap:12px;align-items:flex-start;">
                        <div style="font-size:20px;line-height:1;color:#b45309;"><i class="fas fa-exclamation-circle"></i></div>
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;align-items:center;">
                                <div style="font-weight:700;color:#92400e;">Complete your vendor profile to go live</div>
                                <div style="display:flex;gap:8px;">
                                    <button id="vv-setup-continue" class="btn btn-primary" style="padding:.5rem .9rem;">Continue setup</button>
                                    <button id="vv-setup-dismiss" class="btn btn-outline" style="padding:.5rem .9rem;">Dismiss</button>
                                </div>
                            </div>
                            <div style="margin-top:8px;">
                                <div style="font-weight:600;color:#7c2d12;margin-bottom:6px;">Incomplete</div>
                                <div style="display:flex;flex-wrap:wrap;gap:8px;">${stepsHtml}${moreCount>0?`<span style=\"font-size:.85rem;color:#7c2d12;\">+${moreCount} more</span>`:''}</div>
                            </div>
                            <div style="margin-top:10px;">
                                <div style="font-weight:600;color:#166534;margin-bottom:6px;">Completed (${completedCount}/${totalSteps})</div>
                                <div style="display:flex;flex-wrap:wrap;gap:8px;">${completedChips}</div>
                            </div>
                            <div style="margin-top:8px;font-size:.9rem;color:#7c2d12;">Your profile will not be visible to clients until all required steps are complete.</div>
                        </div>
                    </div>
                `;
                banner.style.display = 'block';

                // Make chips clickable to open the corresponding settings tab
                try {
                    const vendorProfileId = setup.vendorProfileId || status.vendorProfileId || currentUser?.vendorProfileId || null;
                    const chipEls = banner.querySelectorAll('[data-step-key]');
                    chipEls.forEach(el => {
                        el.addEventListener('click', async () => {
                            const key = el.getAttribute('data-step-key');
                            try {
                                if (typeof openVendorSettingsStep === 'function' && vendorProfileId) {
                                    await openVendorSettingsStep(key, vendorProfileId);
                                } else if (typeof displayUserDashboard === 'function') {
                                    await displayUserDashboard('vendor', 'vendor-settings');
                                    // Fallback: try to activate tab by clicking its button
                                    const targetMap = {
                                        basics: 'vendor-profile-panel',
                                        location: 'vendor-location-panel',
                                        gallery: 'vendor-photos-panel',
                                        services: 'vendor-services-panel',
                                        servicesPackages: 'vendor-services-panel',
                                        social: 'vendor-social-panel',
                                        availability: 'vendor-availability-panel',
                                        policies: 'vendor-faqs-panel',
                                        additionalDetails: 'vendor-additional-details-panel',
                                        faq: 'vendor-faqs-panel',
                                        stripe: null
                                    };
                                    const targetId = targetMap[key] || 'vendor-profile-panel';
                                    if (key === 'stripe' && typeof startStripeOnboarding === 'function' && vendorProfileId) {
                                        await startStripeOnboarding(vendorProfileId);
                                        return;
                                    }
                                    const btn = document.querySelector(`#vendor-settings-section .settings-tabs .tab-btn[data-target='${targetId}']`);
                                    btn?.click();
                                } else {
                                    alert('Opening settings...');
                                }
                            } catch (err) {
                                console.warn('chip openVendorSettingsStep failed', err);
                            }
                        });
                    });
                } catch (_) {}

                const contBtn = document.getElementById('vv-setup-continue');
                contBtn?.addEventListener('click', async () => {
                    try {
                        const stepMap = { basics: 1, location: 2, services: 3, servicesPackages: 3, additionalDetails: 4, availability: 5, gallery: 6, social: 7, faq: 8 };
                        const list = Array.isArray(incompleteSteps) ? incompleteSteps : [];
                        const keys = list.map(s => (s && (s.key || s)));
                        const first = keys.find(k => stepMap[k]);
                        const vendorProfileId = (setup && (setup.vendorProfileId || setup.vendorProfileID)) || (status && status.vendorProfileId) || (currentUser && currentUser.vendorProfileId) || null;
                        if (!first && keys.length === 1 && keys[0] === 'stripe' && typeof startStripeOnboarding === 'function' && vendorProfileId) {
                            await startStripeOnboarding(vendorProfileId);
                            return;
                        }
                        const uid = (currentUser?.id) || (typeof getUserIdFromToken === 'function' ? getUserIdFromToken() : null) || (typeof userId !== 'undefined' ? userId : null);
                        if (typeof initializeVendorSetup === 'function' && uid) {
                            initializeVendorSetup(uid);
                            const target = stepMap[first] || 1;
                            setTimeout(() => {
                                try {
                                    if (typeof showStep === 'function') { showStep(target); }
                                    else if (typeof showSetupStep === 'function') { showSetupStep(target); }
                                } catch (_) {}
                            }, 200);
                            return;
                        }
                        const modal = document.getElementById('vendor-registration-modal');
                        if (modal) {
                            modal.style.display = 'flex';
                            try { document.body.style.overflow = 'hidden'; } catch(_) {}
                            const target = stepMap[first] || 1;
                            try { if (typeof setupVendorSetupEventListeners === 'function') setupVendorSetupEventListeners(); } catch(_) {}
                            setTimeout(() => {
                                try {
                                    if (typeof showStep === 'function') { showStep(target); }
                                    else if (typeof showSetupStep === 'function') { showSetupStep(target); }
                                } catch (_) {}
                            }, 200);
                            return;
                        }
                        if (typeof displayUserDashboard === 'function') {
                            await displayUserDashboard('vendor', 'vendor-settings');
                        } else {
                            alert('Opening vendor settings. If nothing happens, use the profile menu to open Vendor Dashboard.');
                        }
                    } catch (_) {
                        if (typeof displayUserDashboard === 'function') {
                            await displayUserDashboard('vendor', 'vendor-settings');
                        }
                    }
                });
                const dismissBtn = document.getElementById('vv-setup-dismiss');
                dismissBtn?.addEventListener('click', () => {
                    try {
                        const token = localStorage.getItem('token') || '';
                        const tokenKey = token ? token.slice(-16) : 'no_token';
                        const sessKey = `vv_hideSetupReminderThisSession_${userId}_${tokenKey}`;
                        sessionStorage.setItem(sessKey, '1');
                        // Cleanup any legacy persistent/day/session flags
                        localStorage.removeItem(`vv_hideSetupReminderUntilComplete_${userId}`);
                        localStorage.removeItem('vv_hideSetupReminderUntil');
                        sessionStorage.removeItem('vv_hideSetupReminderThisSession');
                        sessionStorage.removeItem(`vv_hideSetupReminderThisSession_${userId}`);
                    } catch (_) {}
                    banner.style.display = 'none';
                });
            } catch (e) {
                console.warn('renderVendorSetupReminder failed:', e);
            }
        }

        // Stripe Connect: show banner if vendor not connected
        function ensureStripeBannerContainer() {
            let container = document.getElementById('stripe-connect-banner');
            if (!container) {
                container = document.createElement('div');
                container.id = 'stripe-connect-banner';
                container.style.cssText = 'display:none; margin:16px auto; max-width:1000px; border:1px solid var(--border-color, #e5e7eb); background: #fff7ed; color:#7c2d12; border-radius:12px; padding:14px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04)';
                const anchor = document.getElementById('vendor-pending-requests');
                if (anchor && anchor.parentNode) {
                    anchor.parentNode.insertBefore(container, anchor);
                } else {
                    document.body.prepend(container);
                }
            }
            return container;
        }

        async function startStripeOnboarding(vendorProfileId) {
            try {
                // Show loading state
                const connectBtn = document.querySelector('#stripe-connect-btn');
                if (connectBtn) {
                    connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
                    connectBtn.disabled = true;
                }

                const resp = await fetch(`${API_BASE_URL}/payments/connect/onboard/${vendorProfileId}`, { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await resp.json();
                
                if (!resp.ok || !data.success) {
                    if (data.requiresSetup) {
                        alert('Stripe Connect is not configured on this server. Please contact support to set up payment processing.');
                        return;
                    }
                    throw new Error(data.message || 'Failed to start onboarding');
                }
                
                if (data.success && data.authUrl) {
                    // Open Stripe OAuth in new tab
                    window.open(data.authUrl, '_blank');
                    
                    // Reset button state since user will complete onboarding in new tab
                    const connectBtn = document.querySelector('#stripe-connect-btn');
                    if (connectBtn) {
                        connectBtn.innerHTML = '<i class="fab fa-stripe"></i> Connect with Stripe';
                        connectBtn.disabled = false;
                    }
                } else {
                    throw new Error('No authorization URL received');
                }
            } catch (e) {
                console.error('Stripe onboarding error:', e);
                alert(`Unable to start Stripe onboarding: ${e.message}`);
                
                // Reset button state
                const connectBtn = document.querySelector('#stripe-connect-btn');
                if (connectBtn) {
                    connectBtn.innerHTML = '<i class="fab fa-stripe"></i> Connect with Stripe';
                    connectBtn.disabled = false;
                }
            }
        }

        // Continue Stripe onboarding for incomplete setups
        async function continueStripeOnboarding(vendorProfileId) {
            await startStripeOnboarding(vendorProfileId);
        }

        async function checkVendorStripeStatus(vendorProfileId, showBannerIfDisconnected = true) {
            try {
                const resp = await fetch(`${API_BASE_URL}/payments/connect/status/${vendorProfileId}`);
                const data = await resp.json();
                
                if (!resp.ok) {
                    console.warn('Stripe status check failed:', data.message);
                    return false;
                }

                // Check if Stripe Connect is configured
                if (data.requiresSetup) {
                    if (showBannerIfDisconnected) {
                        const banner = ensureStripeBannerContainer();
                        banner.innerHTML = `
                            <div style="display:flex; align-items:center; gap:12px;">
                                <i class="fas fa-exclamation-triangle" style="color:#d97706;"></i>
                                <div style="flex:1;">
                                    <div style="font-weight:600; color:#92400e;">Payment Processing Not Available</div>
                                    <div style="font-size: 0.925rem; color:#b45309;">Stripe Connect is not configured on this server. Please contact support to enable payment processing.</div>
                                </div>
                            </div>
                        `;
                        banner.style.display = 'block';
                    }
                    return false;
                }

                const connected = !!(data && data.connected && data.chargesEnabled);
                
                if (!connected && showBannerIfDisconnected) {
                    const banner = ensureStripeBannerContainer();
                    banner.innerHTML = `
                        <div style="display:flex; align-items:center; gap:12px;">
                            <i class="fas fa-exclamation-circle" style="color:#b45309;"></i>
                            <div style="flex:1;">
                                <div style="font-weight:600; color:#92400e;">Connect your account to receive payouts</div>
                                <div style="font-size: 0.925rem; color:#b45309;">To accept payments for approved bookings, please complete Stripe Express onboarding. This enables payouts to your bank and automatically handles our 8% platform fee.</div>
                            </div>
                            <button id="stripe-connect-btn" class="btn btn-primary" style="white-space:nowrap;">
                                <i class="fab fa-stripe"></i> Connect with Stripe
                            </button>
                        </div>
                    `;
                    banner.style.display = 'block';
                    const btn = banner.querySelector('#stripe-connect-btn');
                    if (btn) {
                        btn.onclick = () => startStripeOnboarding(vendorProfileId);
                    }
                } else if (connected && showBannerIfDisconnected) {
                    // Hide banner if connected
                    const banner = document.getElementById('stripe-connect-banner');
                    if (banner) {
                        banner.style.display = 'none';
                    }
                }
                
                return connected;
            } catch (e) {
                console.warn('Stripe status check failed:', e);
                return false;
            }
        }

        // Access Stripe Dashboard for vendors
        async function accessStripeDashboard(vendorProfileId) {
            try {
                const resp = await fetch(`${API_BASE_URL}/payments/connect/dashboard/${vendorProfileId}`);
                const data = await resp.json();
                
                if (!resp.ok || !data.success) {
                    throw new Error(data.message || 'Failed to access dashboard');
                }
                
                if (data.dashboardUrl) {
                    // Open dashboard in new tab
                    window.open(data.dashboardUrl, '_blank');
                } else {
                    throw new Error('No dashboard URL received');
                }
            } catch (e) {
                console.error('Dashboard access failed:', e);
                alert(`Unable to access Stripe dashboard: ${e.message}`);
            }
        }

        // Process refund for a booking
        async function processRefund(chargeId, amount, reason) {
            try {
                const resp = await fetch(`${API_BASE_URL}/payments/refund/${chargeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, reason })
                });
                
                const data = await resp.json();
                if (!resp.ok || !data.success) {
                    throw new Error(data.message || 'Failed to process refund');
                }
                
                alert(`Refund processed successfully. Amount: $${data.amount}`);
                return data;
            } catch (e) {
                console.error('Refund processing failed:', e);
                alert(`Refund failed: ${e.message}`);
                throw e;
            }
        }

        // Enhanced vendor Stripe setup display
        function renderVendorStripeSetup(vendorProfileId, container) {
            container.innerHTML = `
                <div class="stripe-setup-card" style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px; background: white;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 48px; height: 48px; background: #635bff; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fab fa-stripe" style="color: white; font-size: 24px;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #1f2937;">Stripe Connect</h3>
                            <p style="margin: 4px 0 0 0; font-size: 14px; color: #6b7280;">Secure payment processing with automatic fee handling</p>
                        </div>
                    </div>
                    
                    <div id="stripe-status-display-${vendorProfileId}">
                        <div class="loading-spinner" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #6b7280;"></i>
                            <p style="margin: 8px 0 0 0; color: #6b7280;">Checking connection status...</p>
                        </div>
                    </div>
                </div>
            `;

            // Check and display Stripe status
            checkAndDisplayStripeStatus(vendorProfileId);
        }

        async function checkAndDisplayStripeStatus(vendorProfileId) {
            const statusDisplay = document.getElementById(`stripe-status-display-${vendorProfileId}`);
            if (!statusDisplay) return;

            try {
                const resp = await fetch(`${API_BASE_URL}/payments/connect/status/${vendorProfileId}`);
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.message || 'Failed to check status');
                }

                if (data.requiresSetup) {
                    statusDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">
                            <i class="fas fa-exclamation-triangle" style="color: #d97706;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #92400e;">Payment Processing Not Available</div>
                                <div style="font-size: 14px; color: #b45309;">Stripe Connect is not configured. Contact support to enable payments.</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (data.connected && data.chargesEnabled) {
                    statusDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px;">
                            <i class="fas fa-check-circle" style="color: #059669;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #065f46;">Connected & Ready</div>
                                <div style="font-size: 14px; color: #047857;">Your Stripe account is connected and ready to receive payments.</div>
                                ${data.payoutsEnabled ? '<div style="font-size: 12px; color: #047857; margin-top: 4px;"><i class="fas fa-check"></i> Payouts enabled</div>' : ''}
                            </div>
                            <button onclick="accessStripeDashboard(${vendorProfileId})" class="btn btn-outline" style="white-space: nowrap;">
                                <i class="fas fa-external-link-alt"></i> Dashboard
                            </button>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 14px; color: #64748b;">
                            <div><strong>Account ID:</strong> ${data.accountId}</div>
                            <div><strong>Country:</strong> ${data.country || 'Not specified'}</div>
                            <div><strong>Platform Fee:</strong> 8% per transaction</div>
                        </div>
                    `;
                } else if (data.connected && !data.chargesEnabled) {
                    statusDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">
                            <i class="fas fa-clock" style="color: #d97706;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #92400e;">Setup In Progress</div>
                                <div style="font-size: 14px; color: #b45309;">Complete your Stripe onboarding to start receiving payments.</div>
                            </div>
                            <button onclick="refreshStripeOnboarding(${vendorProfileId})" class="btn btn-primary">
                                <i class="fas fa-arrow-right"></i> Continue Setup
                            </button>
                        </div>
                    `;
                } else {
                    statusDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px;">
                            <i class="fas fa-times-circle" style="color: #dc2626;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #991b1b;">Not Connected</div>
                                <div style="font-size: 14px; color: #b91c1c;">Connect your Stripe account to receive payments. We handle the 8% platform fee automatically.</div>
                            </div>
                            <button onclick="startStripeOnboarding(${vendorProfileId})" class="btn btn-primary">
                                <i class="fab fa-stripe"></i> Connect with Stripe
                            </button>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 14px; color: #64748b;">
                            <div style="margin-bottom: 8px;"><strong>Benefits of connecting:</strong></div>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Secure payment processing</li>
                                <li>Automatic platform fee handling (8%)</li>
                                <li>Direct deposits to your bank account</li>
                                <li>Comprehensive transaction reporting</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error checking Stripe status:', e);
                statusDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px;">
                        <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #991b1b;">Connection Error</div>
                            <div style="font-size: 14px; color: #b91c1c;">Unable to check Stripe connection status. Please try again later.</div>
                        </div>
                        <button onclick="checkAndDisplayStripeStatus(${vendorProfileId})" class="btn btn-outline">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        async function refreshStripeOnboarding(vendorProfileId) {
            try {
                const resp = await fetch(`${API_BASE_URL}/payments/connect/refresh-onboarding/${vendorProfileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await resp.json();
                if (!resp.ok || !data.success) {
                    throw new Error(data.message || 'Failed to refresh onboarding');
                }
                
                if (data.onboardingUrl) {
                    window.location.href = data.onboardingUrl;
                } else {
                    throw new Error('No onboarding URL received');
                }
            } catch (e) {
                console.error('Refresh onboarding failed:', e);
                alert(`Unable to refresh onboarding: ${e.message}`);
            }
        }

        // Vendor requests filter state (inbound/outbound + status)
        let vendorReqFilters = { direction: 'inbound', status: 'all' };

        // Normalize backend status for consistent filtering/rendering
        function normalizeVendorRequestStatus(item) {
            try {
                let s = (item && item.Status ? String(item.Status) : 'pending').toLowerCase();
                if (s === 'pending') {
                    const isExpired = (item.IsExpired === 1) || (item.ExpiresAt && new Date(item.ExpiresAt) <= new Date());
                    if (isExpired) s = 'expired';
                }
                if (s === 'accepted') s = 'approved';
                return s;
            } catch (_) { return 'pending'; }
        }

        // Optimistic UI helpers for vendor requests
        const STATUS_STYLES = {
            approved: { label: 'Accepted', icon: 'fa-check-circle', color: '#059669', bg: '#d1fae5' },
            declined: { label: 'Declined', icon: 'fa-times-circle', color: '#b91c1c', bg: '#fee2e2' }
        };
        function optimisticUpdateRequestCard(requestId, status) {
            try {
                const card = document.querySelector(`.booking-item[data-request-id="${requestId}"]`);
                if (!card) return () => {};
                const previousHTML = card.outerHTML;
                const cfg = STATUS_STYLES[status] || { label: status };
                const badge = card.querySelector('.request-status-badge');
                if (badge) {
                    if (cfg.color) badge.style.borderColor = cfg.color;
                    if (cfg.bg) badge.style.background = cfg.bg;
                    const icon = badge.querySelector('i');
                    if (icon && cfg.icon) {
                        icon.className = `fas ${cfg.icon}`;
                        icon.style.color = cfg.color || icon.style.color;
                    }
                    const textSpan = badge.querySelector('span');
                    if (textSpan) textSpan.textContent = cfg.label || status;
                    const dot = badge.querySelector('.dot-new');
                    if (dot) dot.remove();
                }
                const note = card.querySelector('.request-deadline-note');
                if (note) note.remove();
                const actionsRow = card.querySelector('.actions-row');
                if (actionsRow) {
                    actionsRow.querySelectorAll('.btn-accept, .btn-decline').forEach(btn => btn.remove());
                }
                // If current tab excludes the new status, remove the card immediately
                const cur = (typeof vendorReqFilters !== 'undefined' && vendorReqFilters && vendorReqFilters.status) || 'all';
                if (cur !== 'all' && cur !== status) {
                    card.style.opacity = '0';
                    setTimeout(() => { 
                        try { 
                            const container = document.getElementById('vendor-pending-requests');
                            // Decrement visible count if present
                            const countEl = container ? container.querySelector('.booking-count') : null;
                            if (countEl) {
                                const n = parseInt(countEl.textContent, 10);
                                if (!isNaN(n) && n > 0) countEl.textContent = `${n - 1} requests`;
                            }
                            card.remove(); 
                        } catch (_) {} 
                    }, 150);
                }
                return () => {
                    try {
                        // Find by request id again, in case the original reference was removed
                        const existing = document.querySelector(`.booking-item[data-request-id="${requestId}"]`);
                        if (existing) {
                            existing.outerHTML = previousHTML;
                        } else {
                            // If card was removed due to filter mismatch, refresh list silently
                            try { loadVendorRequests(vendorReqFilters.direction, vendorReqFilters.status, { silent: true }); } catch (_) {}
                        }
                    } catch (_) {}
                };
            } catch (_) {
                return () => {};
            }
        }

        // Global functions for vendor request handling (accessible to onclick handlers)
        async function approveRequest(requestId) {
            let revertOptimistic = () => {};
            try {
                const vendorProfileId = await getVendorProfileId();
                // Optimistic UI: mark card as accepted immediately
                revertOptimistic = optimisticUpdateRequestCard(requestId, 'approved');
                
                const response = await fetch(`${API_BASE_URL}/bookings/requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        vendorProfileId: vendorProfileId,
                        responseMessage: 'Request approved! Looking forward to working with you.',
                        proposedPrice: null
                    })
                });
                
                if (!response.ok) throw new Error('Failed to approve request');
                
                const approvalData = await response.json();
                
                // Get the actual userId from the approval data or request
                const actualUserId = approvalData.userId || approvalData.UserID;
                
                if (!actualUserId) {
                    console.warn('No userId found in approval response, using fallback methods');
                    // Use fallback methods immediately
                    createLocalNotification(currentUser.id, 'booking_approved', 'Booking Request Approved!', 'Your booking request has been approved by the vendor. You can now proceed with payment.');
                    createLocalConversation(requestId, currentUser.id, vendorProfileId);
                } else {
                    // Create notification for user about approval
                    await createNotification({
                        userId: actualUserId,
                        type: 'booking_approved',
                        title: 'Booking Request Approved!',
                        message: `Your booking request has been approved by the vendor. You can now proceed with payment.`,
                        relatedId: requestId
                    });
                    
                    // Create chat conversation between user and vendor
                    await initiateChatAfterApproval(requestId, actualUserId, vendorProfileId);
                    
                    // Create confirmed booking entry
                    await createConfirmedBooking(requestId, approvalData);
                }
                
                showSuccess('Request approved successfully! Chat initiated with customer.');
                
                // Keep current filter; refresh list in background to reconcile
                if (typeof syncVendorRequestTabStates === 'function') { try { syncVendorRequestTabStates(); } catch (_) {} }
                if (typeof loadVendorRequests === 'function') {
                    try { loadVendorRequests(vendorReqFilters.direction, vendorReqFilters.status, { silent: true }); } catch (_) {}
                }
                
                // Update notifications
                if (typeof loadNotifications === 'function') {
                    await loadNotifications();
                }
                
            } catch (error) {
                console.error('Error approving request:', error);
                try { if (typeof revertOptimistic === 'function') revertOptimistic(); } catch (_) {}
                showGlobalError(`Failed to approve request: ${error.message}`);
            }
        }
        
        // Helper function to create notifications
        async function createNotification(notificationData) {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(notificationData)
                });
                
                if (response.ok) {
                    console.log('Notification created successfully via API');
                    return;
                }
                
                // Fallback: Create notification locally
                console.log('API failed, creating local notification');
                createLocalNotification(notificationData.userId, notificationData.type, notificationData.title, notificationData.message);
                
            } catch (error) {
                console.warn('Error creating notification, using fallback:', error);
                createLocalNotification(notificationData.userId, notificationData.type, notificationData.title, notificationData.message);
            }
        }
        
        // Fallback function to create notifications locally
        function createLocalNotification(userId, type, title, message) {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            const newNotification = {
                id: `notif_${Date.now()}`,
                userId: userId,
                type: type,
                title: title,
                message: message,
                read: false,
                createdAt: new Date().toISOString()
            };
            
            notifications.push(newNotification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update notification badges
            updateNotificationBadges();
            
            // Show toast notification if it's for current user
            if (currentUser && (userId === currentUser.id || userId === currentUser.vendorProfileId)) {
                showNotificationToast(title, message);
            }
            
            console.log('Local notification created successfully');
        }
        
        // Update notification badges (robust: works even before currentUser is hydrated)
        async function updateNotificationBadges() {
            try {
                // Resolve userId from currentUser or JWT
                let userId = currentUser?.id;
                if (!userId) {
                    const token = localStorage.getItem('token');
                    if (token && token.split('.').length === 3 && window.atob) {
                        try { const payload = JSON.parse(atob(token.split('.')[1])); userId = payload.userId || payload.id; } catch (_) {}
                    }
                }

                let unreadCount = null;
                let apiCountLoaded = false;
                let BASE = '';
                try {
                    if (typeof API_BASE_URL !== 'undefined' && API_BASE_URL) {
                        BASE = API_BASE_URL;
                    } else if (window.API_BASE_URL && /^https?:/i.test(String(window.API_BASE_URL))) {
                        BASE = window.API_BASE_URL;
                    } else {
                        const loc = window.location;
                        if (loc && /^https?:/i.test(loc.protocol)) BASE = `${loc.protocol}//${loc.host}/api`;
                    }
                } catch (_) {}
                if (userId && BASE) {
                    const response = await fetch(`${BASE}/notifications/user/${userId}/unread-count`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        unreadCount = Number(data.unreadCount || 0);
                        apiCountLoaded = true;
                    }
                }

                // Fallback to local notifications only if API/userId missing
                if (!userId || !apiCountLoaded) {
                    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    const uid = userId || currentUser?.id || currentUser?.vendorProfileId;
                    if (uid) {
                        unreadCount = notifications.filter(n => (n.userId === uid) && !n.isRead && !n.read).length;
                    }
                }

                const count = Number(unreadCount || 0);
                document.querySelectorAll('#notifications-badge, [id$="-notifications-badge"]').forEach(badge => {
                    setCircularBadge(badge, count);
                });

                // Ensure dashboard notification icons are visible when there are unread items
                try {
                    const dashBtn = document.getElementById('dashboard-notifications-btn');
                    const vendorBtn = document.getElementById('vendor-notifications-btn');
                    if (dashBtn) dashBtn.style.display = count > 0 ? 'inline-block' : dashBtn.style.display;
                    if (vendorBtn) vendorBtn.style.display = count > 0 ? 'inline-block' : vendorBtn.style.display;
                } catch (_) {}
            } catch (error) {
                // Silent fallback — avoid console noise in production
                try {
                    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    const uid = currentUser?.id || currentUser?.vendorProfileId;
                    const unreadCount = uid ? notifications.filter(n => (n.userId === uid) && !n.isRead && !n.read).length : 0;
                    document.querySelectorAll('#notifications-badge, [id$="-notifications-badge"]').forEach(badge => setCircularBadge(badge, unreadCount));
                } catch (_) {}
            }
        }

        // Helper: set badge as circular with 9+ cap and proper display
        function setCircularBadge(badgeEl, count) {
            if (!badgeEl) return;
            const n = Number(count) || 0;
            if (n > 0) {
                badgeEl.textContent = n > 9 ? '9+' : String(n);
                badgeEl.style.display = 'grid';
            } else {
                badgeEl.textContent = '0';
                badgeEl.style.display = 'none';
            }
        }

        // Update favorites badge
        function updateFavoritesBadge() {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const count = Array.isArray(favorites) ? favorites.length : 0;
            const badge = document.getElementById('favorites-badge');
            if (badge) {
                setCircularBadge(badge, count);
            }
        }

        // Update messages badge (unread messages for current user)
        function updateMessagesBadge() {
            if (!currentUser) return;
            const messages = JSON.parse(localStorage.getItem('messages') || '[]');
            // Expect each message to have recipientId and read flag
            const unread = messages.filter(m => (m.recipientId === currentUser.id || m.recipientId === currentUser.vendorProfileId) && !m.read).length;
            const badge = document.getElementById('messages-badge');
            if (badge) {
                setCircularBadge(badge, unread);
            }
        }

        // Initialize header badges on load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure API_BASE_URL fallback if not set BEFORE fetching counts
            if (!window.API_BASE_URL) {
                try {
                    const loc = window.location;
                    window.API_BASE_URL = `${loc.protocol}//${loc.host}/api`;
                } catch (_) { /* ignore */ }
            }

            updateNotificationBadges();
            updateFavoritesBadge();
            updateMessagesBadge();

            // If a prior navigation set this flag, open dashboard messages immediately
            try {
                if (localStorage.getItem('openMessagesOnLoad') === '1') {
                    localStorage.removeItem('openMessagesOnLoad');
                    if (typeof displayUserDashboard === 'function') {
                        const mode = (window.currentUser && window.currentUser.isVendor) ? 'vendor' : 'client';
                        const section = (mode === 'vendor') ? 'vendor-messages' : 'messages';
                        displayUserDashboard(mode, section);
                    }
                }
            } catch (e) { /* ignore */ }

            // Periodically refresh unread messages from API as fallback
            let badgePollInterval = null;
            if (typeof fetchAndUpdateMessagesBadge === 'function') {
                fetchAndUpdateMessagesBadge();
                // Poll faster (5s) until socket confirms connection
                badgePollInterval = setInterval(fetchAndUpdateMessagesBadge, 5000);
            }

            // Optional Socket.IO real-time updates if client is available
            try {
                if (window.io && typeof window.io === 'function') {
                    // Derive socket base URL (strip /api if present)
                    const socket = window.io(SOCKET_BASE_URL || (new URL(window.API_BASE_URL)).origin, {
                        withCredentials: true,
                        auth: { token: localStorage.getItem('token') },
                        transports: ['websocket', 'polling']
                    });
                    // expose globally for other code paths that use state.socket
                    window.state = window.state || {};
                    window.state.socket = socket;

                    socket.on('connect', () => {
                        console.log('[socket] connected', socket.id);
                        if (typeof fetchAndUpdateMessagesBadge === 'function') {
                            fetchAndUpdateMessagesBadge();
                        }
                        if (badgePollInterval) {
                            clearInterval(badgePollInterval);
                            badgePollInterval = setInterval(fetchAndUpdateMessagesBadge, 30000);
                        }
                    });
                    socket.on('connect_error', (err) => console.warn('[socket] connect_error', err?.message || err));
                    socket.on('error', (err) => console.warn('[socket] error', err));
                    socket.on('disconnect', (reason) => console.log('[socket] disconnected', reason));

                    socket.on('new-message', (payload) => {
                        try {
                            const badge = document.getElementById('messages-badge');
                            if (badge) {
                                const current = parseInt(badge.textContent || '0', 10) || 0;
                                const myId = window.currentUser?.id;
                                if (!myId || (payload && payload.senderId !== myId)) {
                                    const next = current + 1;
                                    badge.textContent = next;
                                    badge.style.display = next > 0 ? 'flex' : 'none';
                                }
                            }
                        } catch (_) { /* ignore */ }
                        if (typeof fetchAndUpdateMessagesBadge === 'function') {
                            fetchAndUpdateMessagesBadge();
                        }
                    });
                }
            } catch (e) { /* ignore */ }

            const chatBtn = document.getElementById('chat-btn');
            if (chatBtn) {
                chatBtn.addEventListener('click', () => {
                    // Preferred: open in-page dashboard modal directly to Messages
                    if (typeof displayUserDashboard === 'function') {
                        const mode = (window.currentUser && window.currentUser.isVendor) ? 'vendor' : 'client';
                        const section = (mode === 'vendor') ? 'vendor-messages' : 'messages';
                        displayUserDashboard(mode, section);
                        return;
                    }
                    // Try to open existing chat UI if present
                    if (typeof openChat === 'function') {
                        return openChat();
                    }
                    if (typeof openMessages === 'function') {
                        return openMessages();
                    }
                    if (typeof showSection === 'function') {
                        try { showSection('messages'); return; } catch (e) {}
                    }
                    // Scroll to a likely chat/messages container if it exists
                    const target = document.querySelector('#messages-section, #chat, .messages-panel, #inbox, #conversation-list');
                    if (target && target.scrollIntoView) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        return;
                    }
                    // Fallback: navigate to dashboard messages route (robust)
                    try { localStorage.setItem('openMessagesOnLoad', '1'); } catch (e) {}
                    const candidates = [
                        window.DASHBOARD_MESSAGES_URL,
                        '/dashboard#messages',
                        '/dashboard/messages',
                        '/messages',
                        '/inbox',
                        '/vendor-dashboard#messages',
                        '/user-dashboard#messages'
                    ].filter(Boolean);
                    // Try the first candidate; if it 404s, the user can use back and try another
                    window.location.href = candidates[0];
                });
            }
        });

        // Fetch unread counts from API and update badge
        async function fetchAndUpdateMessagesBadge() {
            try {
                if (!window.API_BASE_URL) return;
                let userId = currentUser?.id;
                if (!userId) {
                    // Derive userId from JWT if possible
                    const token = localStorage.getItem('token');
                    if (token && token.split('.').length === 3 && window.atob) {
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            userId = payload.userId || payload.id;
                        } catch (_) { /* ignore */ }
                    }
                }
                if (!userId) return;
                const res = await fetch(`${API_BASE_URL}/messages/conversations/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (!res.ok) return;
                const data = await res.json();
                const unreadTotal = Array.isArray(data.conversations)
                    ? data.conversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0)
                    : 0;
                const badge = document.getElementById('messages-badge');
                if (badge) {
                    badge.textContent = unreadTotal;
                    badge.style.display = unreadTotal > 0 ? 'block' : 'none';
                }
            } catch (e) {
                // ignore network errors, badge will still be maintained by local storage fallback
            }
        }
        
        // Show toast notification
        function showNotificationToast(title, message) {
            const sourceText = [title, message].filter(Boolean).join(' ');
            showBanner(message, detectBannerVariant(sourceText), title || undefined);
        }

        function showBanner(message, variant = 'info', title) {
            try {
                const normalizedVariant = (variant === 'notice') ? 'info' : variant;
                if (normalizedVariant === 'error' && typeof getVisibleModal === 'function') {
                    const modal = getVisibleModal();
                    if (modal && typeof renderModalError === 'function') {
                        renderModalError(modal, message);
                        return;
                    }
                }
            } catch {}

            try {
                const existing = document.getElementById('app-banner');
                if (existing) existing.remove();
            } catch {}

            const banner = document.createElement('div');
            banner.id = 'app-banner';
            const normalizedVariant = (variant === 'notice') ? 'info' : variant;
            banner.className = `app-banner app-banner--${normalizedVariant}`;
            const safeMsg = (typeof message === 'string') ? message : (message && message.message) || String(message);
            const heading = title || (normalizedVariant === 'error' ? 'Error' : (normalizedVariant === 'success' ? 'Success' : 'Notice'));
            banner.setAttribute('role', 'alert');
            banner.setAttribute('aria-live', 'assertive');
            banner.innerHTML = `
                <span class="app-banner__icon" aria-hidden="true">${getBannerIcon(normalizedVariant)}</span>
                <div class="app-banner__title">${heading}</div>
                <div style="flex:1;">${safeMsg}</div>
                <button class="app-banner__close" aria-label="Close">&times;</button>
            `;
            banner.querySelector('.app-banner__close').addEventListener('click', () => banner.remove());
            document.body.appendChild(banner);

            setTimeout(() => { if (banner.parentElement) banner.remove(); }, 5000);
        }

        function getBannerIcon(variant) {
            if (variant === 'success') {
                return `<svg viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.707a1 1 0 00-1.414-1.414L9 10.172 7.707 8.879a1 1 0 10-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>`;
            }
            if (variant === 'error') {
                return `<svg viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>`;
            }
            return `<svg viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M18 10A8 8 0 11.001 10 8 8 0 0118 10zM9 8a1 1 0 112 0v5a1 1 0 11-2 0V8zm1-3a1.25 1.25 0 100 2.5A1.25 1.25 0 0010 5z" clip-rule="evenodd"/></svg>`;
        }

        function detectBannerVariant(msg) {
            try {
                const t = String((typeof msg === 'string') ? msg : (msg && msg.message) || msg).toLowerCase();
                if (t.includes('error') || t.includes('failed') || t.includes('unable') || t.includes('cannot')) return 'error';
                if (
                    t.includes('success') || t.includes('saved') || t.includes('welcome') || t.includes('processed') ||
                    t.includes('approved') || t.includes('accepted') || t.includes('confirmed') || t.includes('completed') || t.includes('paid')
                ) return 'success';
                if (t.includes('declined') || t.includes('cancelled') || t.includes('canceled') || t.includes('notice') || t.includes('reminder') || t.includes('pending')) return 'notice';
                return 'info';
            } catch { return 'info'; }
        }

        (function initAlertOverride(){
            const nativeAlert = window.alert ? window.alert.bind(window) : null;
            window.alert = function(message) {
                try {
                    const variant = detectBannerVariant(message);
                    if (variant === 'error' && typeof showGlobalError === 'function') {
                        showGlobalError(message);
                    } else {
                        showBanner(message, variant);
                    }
                } catch (e) {
                    if (nativeAlert) nativeAlert(message);
                }
            };
        })();

        // Notifications Dropdown Functions
        function showNotificationsDropdown(buttonElement) {
            const dropdown = document.getElementById('notifications-dropdown');
            
            // Hide any existing dropdown
            hideNotificationsDropdown();
            try { hideProfileDropdown(); } catch {}
            
            // Move dropdown to body to avoid positioning issues
            document.body.appendChild(dropdown);
            
            // Position dropdown relative to the clicked button
            const buttonRect = buttonElement.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            // Calculate position
            const dropdownWidth = 380;
            let left = buttonRect.left + scrollLeft - dropdownWidth + buttonRect.width;
            let top = buttonRect.bottom + scrollTop + 5;
            
            // Ensure dropdown doesn't go off screen
            if (left < 10) {
                left = 10;
            }
            if (left + dropdownWidth > window.innerWidth - 10) {
                left = window.innerWidth - dropdownWidth - 10;
            }
            
            // Set position
            dropdown.style.position = 'absolute';
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.display = 'block';
            
            if (typeof window.loadNotifications === 'function') {
                const activeTab = document.querySelector('.notification-tab.active');
                const isUnread = activeTab ? activeTab.dataset.tab === 'unread' : false;
                window.loadNotifications(isUnread);
            }

            // Mark all read button handler is set up in loadNotifications function
        }

        function hideNotificationsDropdown() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown) dropdown.style.display = 'none';
        }

        function toggleNotificationsDropdown(buttonElement) {
            const dropdown = document.getElementById('notifications-dropdown');
            if (!dropdown) return;
            if (dropdown.style.display === 'block') {
                hideNotificationsDropdown();
            } else {
                showNotificationsDropdown(buttonElement);
            }
        }

        // Profile Dropdown Functions
        function showProfileDropdown(buttonElement) {
            const dropdown = document.getElementById('profile-dropdown');
            if (!dropdown) return;
            // Hide notifications if open
            try { hideNotificationsDropdown(); } catch {}
            // Move dropdown to body
            document.body.appendChild(dropdown);
            // Populate header with current user info (from in-memory or localStorage)
            try {
                const nameEl = document.getElementById('profile-dd-name');
                const emailEl = document.getElementById('profile-dd-email');
                const avatarEl = document.getElementById('profile-dd-avatar');
                const user = (typeof currentUser !== 'undefined' && currentUser) 
                    || (typeof getCurrentUser === 'function' ? getCurrentUser() : null);
                if (user) {
                    if (nameEl) nameEl.textContent = user.name || (user.email ? user.email.split('@')[0] : 'User');
                    if (emailEl) emailEl.textContent = user.email || '';
                    if (avatarEl) {
                        const initial = (user.avatar?.toString() || user.name?.[0] || user.email?.[0] || 'U').toString();
                        avatarEl.textContent = initial.toUpperCase();
                    }
                }
            } catch (_) { /* ignore */ }
            const rect = buttonElement.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const dropdownWidth = 280;
            let left = rect.left + scrollLeft - dropdownWidth + rect.width;
            let top = rect.bottom + scrollTop + 5;
            if (left < 10) left = 10;
            if (left + dropdownWidth > window.innerWidth - 10) left = window.innerWidth - dropdownWidth - 10;
            dropdown.style.position = 'absolute';
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            // Align arrow to the button horizontally
            try {
                const anchorCenter = rect.left + scrollLeft + (rect.width / 2);
                const arrowLeft = Math.max(16, Math.min(dropdownWidth - 16, anchorCenter - left));
                dropdown.style.setProperty('--arrow-left', arrowLeft + 'px');
            } catch (_) { /* ignore */ }
            dropdown.style.display = 'block';
        }

        function hideProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown) dropdown.style.display = 'none';
        }

        function toggleProfileDropdown(buttonElement) {
            const dropdown = document.getElementById('profile-dropdown');
            if (!dropdown) return;
            if (dropdown.style.display === 'block') {
                hideProfileDropdown();
            } else {
                showProfileDropdown(buttonElement);
            }
        }

        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications found</p>
                    </div>
                `;
                return;
            }
            
            notificationsList.innerHTML = notifications.map(notification => {
                const isUnread = !notification.IsRead && !notification.isRead;
                const createdAt = new Date(notification.CreatedAt || notification.createdAt);
                const timeAgo = getTimeAgo(createdAt);
                const nid = notification.NotificationID || notification.id || '';
                const ntype = notification.Type || notification.type || '';
                const rtype = notification.RelatedType || notification.relatedType || '';
                const rid = notification.RelatedID || notification.relatedId || '';
                const actionUrl = notification.ActionURL || notification.actionUrl || '';
                
                return `
                    <div class="notification-item ${isUnread ? 'unread' : ''}"
                         data-nid="${nid}"
                         data-type="${ntype}"
                         data-related-type="${rtype}"
                         data-related-id="${rid}"
                         data-action-url="${actionUrl}"
                         style="cursor: pointer;">
                        <div class="notification-title">${notification.Title || notification.title}</div>
                        <div class="notification-message">${notification.Message || notification.message}</div>
                        <div class="notification-meta">
                            <span class="notification-type ${ntype}">${ntype}</span>
                            <span>${timeAgo}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click event listeners to notification items
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', onNotificationItemClick);
            });
        }

        function onNotificationItemClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Notification click event triggered'); // Debug log
            
            const el = e.currentTarget || (e.target && e.target.closest && e.target.closest('.notification-item'));
            if (!el) {
                console.error('No notification element found');
                return;
            }
            
            const id = el.getAttribute('data-nid');
            console.log('Notification ID:', id);
            
            // Mark notification as read
            if (id) { 
                try { 
                    markNotificationAsRead(id); 
                    // Update the UI immediately
                    el.classList.remove('unread');
                    console.log('Marked notification as read:', id);
                    const activeTabEl = document.querySelector('.notification-tab.active');
                    if (activeTabEl && activeTabEl.dataset.tab === 'unread') {
                        const list = document.getElementById('notifications-list');
                        el.remove();
                        if (list && list.querySelectorAll('.notification-item').length === 0) {
                            list.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications found</p>
                    </div>
                `;
                        }
                    }
                } catch(error) {
                    console.error('Error marking notification as read:', error);
                } 
            }
            
            // Collect notification data for navigation
            const data = {
                id: id,
                type: el.getAttribute('data-type') || '',
                relatedType: el.getAttribute('data-related-type') || '',
                relatedId: el.getAttribute('data-related-id') || '',
                actionUrl: el.getAttribute('data-action-url') || ''
            };
            
            console.log('Notification clicked with data:', data); // Debug log
            
            // Hide dropdown first, then navigate
            try { 
                hideNotificationsDropdown(); 
                console.log('Notification dropdown hidden');
            } catch(error) {
                console.error('Error hiding dropdown:', error);
            }
            
            // Small delay to ensure dropdown is hidden before navigation
            setTimeout(() => {
                console.log('Starting navigation for notification:', data);
                navigateBasedOnNotification(data);
            }, 100);
        }

        function navigateBasedOnNotification(n) {
            console.log('Navigating based on notification:', n); // Debug log
            
            const rawType = (n.type || '').toLowerCase();
            const relatedType = (n.relatedType || '').toLowerCase();
            const actionUrl = n.actionUrl || '';
            
            // Check if displayUserDashboard function exists
            if (!(window && typeof window.displayUserDashboard === 'function')) {
                console.error('displayUserDashboard function not found');
                alert('Dashboard function not available. Please refresh the page.');
                return;
            }
            
            // Ensure currentUser is available
            if (!window.currentUser) {
                console.error('Current user not available for navigation');
                alert('User information not available. Please refresh the page.');
                return;
            }
            
            try {
                if (actionUrl) {
                    const isFull = /^https?:/i.test(actionUrl);
                    try {
                        const u = new URL(actionUrl, window.location.origin);
                        const sectionParam = (u.searchParams.get('section') || '').trim() || (u.hash ? u.hash.replace('#','').trim() : '');
                        const modeParam = (u.searchParams.get('mode') || '').trim();
                        if (sectionParam) {
                            const modeSel = sectionParam.startsWith('vendor-') ? 'vendor' : (modeParam === 'vendor' ? 'vendor' : (modeParam === 'client' ? 'client' : (typeof resolvePreferredMode === 'function' ? resolvePreferredMode() : ((window.currentUser && window.currentUser.isVendor) ? 'vendor' : 'client'))));
                            console.log('Opening dashboard with mode:', modeSel, 'section:', sectionParam);
                            window.displayUserDashboard(modeSel, sectionParam);
                            return;
                        }
                    } catch (err) {
                        console.error('Error parsing action URL:', err);
                    }
                    if (isFull) { window.open(actionUrl, '_blank'); return; }
                    if (actionUrl.startsWith('#')) {
                        const sec = actionUrl.slice(1);
                        const modeSel = sec.startsWith('vendor-') ? 'vendor' : (typeof resolvePreferredMode === 'function' ? resolvePreferredMode() : ((window.currentUser && window.currentUser.isVendor) ? 'vendor' : 'client'));
                        console.log('Opening dashboard with mode:', modeSel, 'section:', sec);
                        window.displayUserDashboard(modeSel, sec);
                        return;
                    }
                }
            } catch (err) {
                console.error('Error handling action URL:', err);
            }
            
            const prefMode = (typeof resolvePreferredMode === 'function') ? resolvePreferredMode() : ((window.currentUser && window.currentUser.isVendor) ? 'vendor' : 'client');
            const typeCombo = `${rawType}|${relatedType}`;
            
            function routeFor(t) {
                if (!t) return null;
                if (t.includes('new_request') || t.includes('booking_request') || t.includes('request_received') || t.includes('request_new')) return { mode: 'vendor', section: 'vendor-requests' };
                if (t === 'request_approved' || t.includes('booking_confirmed')) return { mode: (prefMode === 'vendor' ? 'vendor' : 'client'), section: (prefMode === 'vendor' ? 'vendor-invoices' : 'invoices') };
                if (t === 'request_declined' || t.includes('booking_cancelled') || t.includes('booking_canceled')) return { mode: (prefMode === 'vendor' ? 'vendor' : 'client'), section: (prefMode === 'vendor' ? 'vendor-requests' : 'bookings') };
                if (t.includes('invoice') || t.includes('payment') || t.includes('paid') || t.includes('payout') || t.includes('stripe')) return { mode: (prefMode === 'vendor' ? 'vendor' : 'client'), section: (prefMode === 'vendor' ? 'vendor-invoices' : 'invoices') };
                if (t.includes('message') || t.includes('chat')) return { mode: (prefMode === 'vendor' ? 'vendor' : 'client'), section: (prefMode === 'vendor' ? 'vendor-messages' : 'messages') };
                if (t.includes('review')) return { mode: (prefMode === 'vendor' ? 'vendor' : 'client'), section: (prefMode === 'vendor' ? 'vendor-requests' : 'bookings') };
                if (t.includes('booking') || t.includes('request') || t.includes('approval') || t.includes('confirm') || t.includes('application') || t.includes('applications') || t.includes('applciation')) return { mode: (prefMode === 'vendor' ? 'vendor' : 'client'), section: (prefMode === 'vendor' ? 'vendor-requests' : 'bookings') };
                return null;
            }
            
            const mapped = routeFor(rawType) || routeFor(relatedType) || routeFor(typeCombo);
            if (mapped) {
                console.log('Mapped route - mode:', mapped.mode, 'section:', mapped.section);
                try {
                    window.displayUserDashboard(mapped.mode, mapped.section);
                    console.log('Successfully navigated to dashboard:', mapped.mode, mapped.section);
                } catch (error) {
                    console.error('Error navigating to dashboard:', error);
                    alert('Failed to open dashboard. Please try again.');
                }
                return;
            }
            
            const vendorTypeHints = ['new_request', 'request_new', 'request_received', 'vendor', 'payout', 'stripe'];
            const clientTypeHints = ['request_approved', 'approval', 'approved', 'invoice', 'payment', 'paid', 'booking', 'review', 'confirmed', 'confirm'];
            const vendorTargeted = vendorTypeHints.some(k => rawType.includes(k)) || vendorTypeHints.some(k => relatedType.includes(k));
            const clientTargeted = clientTypeHints.some(k => rawType.includes(k)) || clientTypeHints.some(k => relatedType.includes(k));
            const targetMode = (clientTargeted ? 'client' : (vendorTargeted ? 'vendor' : prefMode));
            const isVendor = (targetMode === 'vendor');
            
            if (rawType.includes('message') || relatedType.includes('message') || rawType === 'chat_initiated') {
                const mode = isVendor ? 'vendor' : 'client';
                const section = mode === 'vendor' ? 'vendor-messages' : 'messages';
                console.log('Message notification - mode:', mode, 'section:', section);
                try {
                    window.displayUserDashboard(mode, section);
                    console.log('Successfully navigated to messages:', mode, section);
                } catch (error) {
                    console.error('Error navigating to messages:', error);
                    alert('Failed to open messages. Please try again.');
                }
                return;
            }
            
            if (relatedType.includes('booking') || rawType.includes('booking') || rawType.includes('request') || relatedType.includes('request') || rawType.includes('approved') || rawType.includes('confirm') || rawType.includes('application') || rawType.includes('applications') || rawType.includes('applciation') || relatedType.includes('application') || relatedType.includes('applications') || relatedType.includes('applciation')) {
                const mode = isVendor ? 'vendor' : 'client';
                const section = isVendor ? 'vendor-requests' : 'bookings';
                console.log('Booking/Request notification - mode:', mode, 'section:', section);
                try {
                    window.displayUserDashboard(mode, section);
                    console.log('Successfully navigated to bookings/requests:', mode, section);
                } catch (error) {
                    console.error('Error navigating to bookings/requests:', error);
                    alert('Failed to open bookings/requests. Please try again.');
                }
                return;
            }
            
            if (rawType.includes('invoice') || rawType.includes('payment') || relatedType.includes('invoice') || relatedType.includes('payment')) {
                const mode = isVendor ? 'vendor' : 'client';
                const section = mode === 'vendor' ? 'vendor-invoices' : 'invoices';
                console.log('Invoice/Payment notification - mode:', mode, 'section:', section);
                try {
                    window.displayUserDashboard(mode, section);
                    console.log('Successfully navigated to invoices:', mode, section);
                } catch (error) {
                    console.error('Error navigating to invoices:', error);
                    alert('Failed to open invoices. Please try again.');
                }
                return;
            }
            
            // Default fallback
            const mode = isVendor ? 'vendor' : 'client';
            const section = mode === 'vendor' ? 'vendor-dashboard' : 'dashboard';
            console.log('Default notification navigation - mode:', mode, 'section:', section);
            try {
                window.displayUserDashboard(mode, section);
                console.log('Successfully navigated to default dashboard:', mode, section);
            } catch (error) {
                console.error('Error navigating to default dashboard:', error);
                alert('Failed to open dashboard. Please try again.');
            }
        }
  
        function resolvePreferredMode() {
            try {
                // 1) Use explicit UI toggle state if available
                if (typeof isVendorMode !== 'undefined') return isVendorMode ? 'vendor' : 'client';
            } catch (_) {}
            try {
                // 2) Use persisted preference
                const stored = localStorage.getItem('isVendorMode');
                if (stored === 'true' || stored === true) return 'vendor';
                if (stored === 'false' || stored === false) return 'client';
            } catch (_) {}
            // 3) Fallback to currentUser role
            if (window.currentUser && window.currentUser.isVendor) return 'vendor';
            return 'client';
        }

        async function markNotificationAsRead(notificationId) {
            if (!notificationId) return;
            
            try {
                let BASE = '';
                try {
                    if (typeof API_BASE_URL !== 'undefined' && API_BASE_URL) {
                        BASE = API_BASE_URL;
                    } else if (window.API_BASE_URL && /^https?:/i.test(String(window.API_BASE_URL))) {
                        BASE = window.API_BASE_URL;
                    } else {
                        const loc = window.location; 
                        if (loc && /^https?:/i.test(loc.protocol)) BASE = `${loc.protocol}//${loc.host}/api`;
                    }
                } catch (_) {}
                const response = await fetch(`${BASE}/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const notificationItem = document.querySelector(`.notification-item[data-nid="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.classList.remove('unread');
                    }
                    updateNotificationBadges();
                } else {
                    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.isRead = true;
                        notification.read = true;
                        localStorage.setItem('notifications', JSON.stringify(notifications));
                        updateNotificationBadges();
                    }
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                // Update local storage as fallback
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.isRead = true;
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    updateNotificationBadges();
                }
            }
        }

        async function markAllNotificationsAsRead() {
            console.log('Mark All Read clicked'); // Debug log
            
            let userId = currentUser?.id;
            if (!userId) {
                try {
                    const token = localStorage.getItem('token');
                    if (token && token.split('.').length === 3 && window.atob) {
                        const base64Url = token.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const padded = base64 + '==='.slice((base64.length + 3) % 4);
                        const payload = JSON.parse(atob(padded));
                        userId = payload.userId || payload.id || payload.sub || null;
                    }
                } catch (_) {}
            }
            
            console.log('User ID for mark all read:', userId);
            
            // First update the UI immediately
            try {
                document.querySelectorAll('.notification-item.unread').forEach(el => el.classList.remove('unread'));
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const uid = userId || currentUser?.id || null;
                const vid = currentUser?.vendorProfileId;
                notifications.forEach(n => { if ((uid && n.userId === uid) || (vid && n.userId === vid) || !n.userId) { n.isRead = true; n.read = true; } });
                localStorage.setItem('notifications', JSON.stringify(notifications));
                // Hide read notifications in dropdown for this session
                updateNotificationBadges();
            } catch (_) {}
            
            // Make API call to backend
            try {
                let BASE = '';
                try {
                    if (typeof API_BASE_URL !== 'undefined' && API_BASE_URL) {
                        BASE = API_BASE_URL;
                    } else if (window.API_BASE_URL && /^https?:/i.test(String(window.API_BASE_URL))) {
                        BASE = window.API_BASE_URL;
                    } else {
                        const loc = window.location;
                        if (loc && /^https?:/i.test(loc.protocol)) BASE = `${loc.protocol}//${loc.host}/api`;
                    }
                } catch (_) {}
                if (userId && BASE) {
                    await fetch(`${BASE}/notifications/user/${userId}/read-all`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                }
            } catch (error) {
                console.warn('Mark all read API failed, using local fallback:', error);
            }
            
            // Refresh the notifications display to clear them from view
            try {
                // Switch to Unread tab to ensure cleared view
                const activeTabEl = document.querySelector('.notification-tab.active');
                const isUnread = activeTabEl ? activeTabEl.dataset.tab === 'unread' : false;

                // Clear current list immediately for better UX
                const listEl = document.getElementById('notifications-list');
                if (typeof loadNotifications === 'function') {
                    loadNotifications(isUnread);
                }

                // Reload unread to keep state consistent
                // Update badges to reflect the changes
                updateNotificationBadges();
            } catch (_) {}
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }
        
        // Helper function to initiate chat after approval
        async function initiateChatAfterApproval(requestId, userId, vendorProfileId) {
            try {
                // Use the correct API endpoint from messages.js
                const response = await fetch(`${API_BASE_URL}/messages/conversation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        userId: userId,
                        vendorProfileId: vendorProfileId,
                        requestId: requestId,
                        initialMessage: 'Hello! Your booking request has been approved. Feel free to ask any questions about your upcoming event.'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Chat initiated successfully via API:', result);
                    
                    // Refresh conversations in UI
                    if (typeof loadConversations === 'function') {
                        setTimeout(() => {
                            loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                            loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                        }, 1000);
                    }
                    return;
                }
                
                // Fallback: Create conversation in localStorage
                console.log('API failed, creating local conversation');
                createLocalConversation(requestId, userId, vendorProfileId);
                
            } catch (error) {
                console.warn('Error initiating chat, using fallback:', error);
                createLocalConversation(requestId, userId, vendorProfileId);
            }
        }
        
        // Fallback function to create conversation locally
        function createLocalConversation(requestId, userId, vendorProfileId) {
            const conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            
            // Get vendor and user names for display
            const vendorName = currentUser?.isVendor ? 'Client' : 'Vendor';
            const userName = currentUser?.name || 'User';
            
            const newConversation = {
                id: `conv_${Date.now()}`,
                requestId: requestId,
                userId: userId,
                vendorProfileId: vendorProfileId,
                userName: userName,
                vendorName: vendorName,
                createdAt: new Date().toISOString(),
                messages: [{
                    id: `msg_${Date.now()}`,
                    senderId: 'system',
                    content: 'Your booking request has been approved! You can now chat with your vendor.',
                    timestamp: new Date().toISOString()
                }],
                lastMessage: 'Your booking request has been approved!',
                timestamp: new Date().toISOString(),
                unreadCount: 1
            };
            
            conversations.push(newConversation);
            localStorage.setItem('conversations', JSON.stringify(conversations));
            
            console.log('Local conversation created successfully:', newConversation);
            
            // Create notification for both parties
            createLocalNotification(userId, 'chat_initiated', 'New Chat Started', 'You can now chat with your vendor about your approved booking.');
            createLocalNotification(vendorProfileId, 'chat_initiated', 'New Chat Started', 'A new chat has been started with your client.');
            
            // Immediately refresh conversations in UI
            setTimeout(() => {
                if (typeof loadConversations === 'function') {
                    loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                    loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                }
            }, 500);
        }
        
        // Helper function to create confirmed booking
        async function createConfirmedBooking(requestId, approvalData) {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/confirmed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        requestId: requestId,
                        status: 'confirmed',
                        approvedAt: new Date().toISOString(),
                        userId: approvalData.userId,
                        vendorProfileId: approvalData.vendorProfileId,
                        ...approvalData
                    })
                });
                
                if (response.ok) {
                    console.log('Confirmed booking created successfully via API');
                    return;
                }
                
                console.warn('Failed to create confirmed booking:', await response.text());
            } catch (error) {
                console.warn('Error creating confirmed booking:', error);
            }
        }
        
        // Payment initiation function (Stripe Destination Charges via Connect)
        async function initiatePayment(bookingId, amount, vendorProfileId) {
            const prevTextBtns = Array.from(document.querySelectorAll(`button[onclick*="initiatePayment('${bookingId}'"]`));
            prevTextBtns.forEach(b => { b.dataset.prev = b.innerText; b.innerText = 'Checking...'; b.disabled = true; });

            try {
                // First, check if booking is already paid
                const statusResp = await fetch(`${API_BASE_URL}/payments/booking/${bookingId}/status`);
                if (statusResp.ok) {
                    const statusData = await statusResp.json();
                    if (statusData.success && statusData.isPaid) {
                        alert('This booking has already been paid for.');
                        prevTextBtns.forEach(b => {
                            b.innerText = 'Already Paid';
                            b.disabled = true;
                            b.style.backgroundColor = '#28a745';
                            b.style.color = 'white';
                        });
                        if (typeof loadAllUserBookings === 'function') {
                            await loadAllUserBookings();
                        }
                        return;
                    }
                }

                prevTextBtns.forEach(b => { b.innerText = 'Processing...'; });

                // Ensure vendor is connected before creating intent
                if (vendorProfileId) {
                    const connected = await checkVendorStripeStatus(vendorProfileId, false);
                    if (!connected) {
                        alert('The vendor\'s Stripe account is not connected. Please contact the vendor to complete their payment setup.');
                        prevTextBtns.forEach(b => { b.innerText = b.dataset.prev || 'Pay Now'; b.disabled = false; });
                        return;
                    }
                }

                let displayAmount = Number(amount) || 0;
                try {
                    if (window.currentUser && currentUser.id) {
                        const invResp = await fetch(`${API_BASE_URL}/invoices/booking/${bookingId}?regenerate=1&userId=${currentUser.id}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` } });
                        if (invResp.ok) {
                            const invData = await invResp.json();
                            if (invData && invData.success && invData.invoice) {
                                const inv = invData.invoice;
                                if (typeof inv.TotalAmount !== 'undefined') displayAmount = Number(inv.TotalAmount || 0);
                                else if (inv.totals && typeof inv.totals.grandTotal !== 'undefined') displayAmount = Number(inv.totals.grandTotal || 0);
                            }
                        }
                    }
                } catch (_) {}

                // Create PaymentIntent for in-app modal flow (with fallback to legacy endpoint)
                let resp = await fetch(`${API_BASE_URL}/payments/payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bookingId,
                        vendorProfileId,
                        amount: displayAmount,
                        description: `Booking Payment #${bookingId}`
                    })
                });

                // Fallback: older API may not have /payments/payment-intent
                if (resp.status === 404) {
                    resp = await fetch(`${API_BASE_URL}/bookings/create-payment-intent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            bookingId,
                            vendorProfileId,
                            amount,
                            description: `Booking Payment #${bookingId}`
                        })
                    });
                }

                // Try to parse JSON; show useful error if server returned HTML/text
                let data;
                try {
                    const ct = (resp.headers.get('content-type') || '').toLowerCase();
                    if (ct.includes('application/json')) {
                        data = await resp.json();
                    } else {
                        const text = await resp.text();
                        try { data = JSON.parse(text); } catch (_) {
                            throw new Error(`API error (${resp.status}): ${text.slice(0, 200)}`);
                        }
                    }
                } catch (parseErr) {
                    throw parseErr;
                }

                if (!resp.ok || !data.clientSecret) {
                    throw new Error((data && (data.message || data.error)) || 'Failed to create payment intent');
                }

                // Open in-app payment modal
                openPaymentModal({
                    bookingId,
                    amount: Number(displayAmount) || 0,
                    clientSecret: data.clientSecret,
                    // publishableKey may not be present on legacy endpoint; fallback to global var if configured
                    publishableKey: data.publishableKey || (window && window.STRIPE_PUBLISHABLE_KEY) || null,
                    paymentIntentId: data.paymentIntentId
                });
            } catch (e) {
                console.error('Payment initiation failed:', e);
                alert(`Payment failed: ${e.message}`);
                prevTextBtns.forEach(b => { b.innerText = b.dataset.prev || 'Pay Now'; b.disabled = false; });
            }
        }
        
        // Open payment modal (Stripe Payment Element, no full-page redirect)
        function openPaymentModal({ bookingId, clientSecret, amount, publishableKey, paymentIntentId }) {
            const modal = document.createElement('div');
            modal.id = 'payment-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Complete Payment</h3>
                        <button class="modal-close" onclick="closePaymentModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="payment-summary">
                            <h4>Payment Summary</h4>
                            <div class="payment-amount">Total: $${Number(amount || 0).toFixed(2)}</div>
                        </div>
                        <div id="payment-element" style="margin: 20px 0;"></div>
                        <button id="submit-payment" class="btn btn-primary" style="width: 100%;">Pay Now</button>
                        <div id="payment-error" style="color:#b91c1c;margin-top:10px;display:none;"></div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize Stripe Elements if available
            if (window.Stripe) {
                const key = publishableKey || window.STRIPE_PUBLISHABLE_KEY || 'pk_test_placeholder';
                const stripe = Stripe(key);
                const elements = stripe.elements({ clientSecret });
                const paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

                const submitBtn = document.getElementById('submit-payment');
                const errEl = document.getElementById('payment-error');
                submitBtn.addEventListener('click', async () => {
                    submitBtn.disabled = true;
                    const prev = submitBtn.innerText; submitBtn.innerText = 'Processing...';
                    errEl.style.display = 'none'; errEl.textContent = '';
                    const { error, paymentIntent } = await stripe.confirmPayment({
                        elements,
                        redirect: 'if_required',
                        // Stripe requires an http(s) URL; use API origin landing page
                        confirmParams: { 
                            return_url: (() => {
                                try { return new URL(API_BASE_URL).origin + '/api/payments/redirect-complete'; }
                                catch (_) { return 'https://bdb-3-0-venuevue-api.onrender.com/api/payments/redirect-complete'; }
                            })()
                        }
                    });

                    if (error) {
                        errEl.textContent = `Payment failed: ${error.message}`;
                        errEl.style.display = 'block';
                        submitBtn.disabled = false; submitBtn.innerText = prev;
                        return;
                    }

                    // Verify on backend and update booking status
                    try {
                        const piId = (paymentIntent && paymentIntent.id) || paymentIntentId;
                        let verifyResp = await fetch(`${API_BASE_URL}/payments/verify-intent?payment_intent=${encodeURIComponent(piId)}`);
                        if (verifyResp.status === 404) {
                            // Fallback: use legacy booking payment confirm endpoint
                            verifyResp = await fetch(`${API_BASE_URL}/bookings/${encodeURIComponent(bookingId)}/payment`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                                },
                                body: JSON.stringify({ paymentIntentId: piId, amount: Number(amount || 0) })
                            });
                        }
                        let verifyData;
                        const vct = (verifyResp.headers.get('content-type') || '').toLowerCase();
                        if (vct.includes('application/json')) {
                            verifyData = await verifyResp.json();
                        } else {
                            const text = await verifyResp.text();
                            try { verifyData = JSON.parse(text); } catch (_) { verifyData = { success: verifyResp.ok, message: text }; }
                        }
                        if (!verifyResp.ok || (verifyData && verifyData.success === false)) {
                            throw new Error((verifyData && (verifyData.message || verifyData.error)) || 'Failed to verify payment');
                        }
                        if (typeof showSuccess === 'function') {
                            showSuccess('Payment completed successfully! Your booking has been confirmed.');
                        }
                        closePaymentModal();
                        if (typeof loadAllUserBookings === 'function') {
                            try { await loadAllUserBookings(); } catch (_) {}
                        }
                    } catch (verr) {
                        errEl.textContent = `Payment verification failed: ${verr.message}`;
                        errEl.style.display = 'block';
                        submitBtn.disabled = false; submitBtn.innerText = prev;
                    }
                });
            } else {
                // Fallback: no Stripe.js loaded
                const submitBtn = document.getElementById('submit-payment');
                submitBtn.addEventListener('click', () => {
                    const errEl = document.getElementById('payment-error');
                    errEl.textContent = 'Stripe.js failed to load. Please refresh and try again.';
                    errEl.style.display = 'block';
                });
            }
        }
        
        // Close payment modal
        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Update booking payment status
        async function updateBookingPaymentStatus(bookingId, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/${bookingId}/payment-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ paymentStatus: status })
                });
                
                if (!response.ok) throw new Error('Failed to update payment status');
                
                // Create notification for vendor about payment
                const bookingData = await response.json();
                await createNotification({
                    userId: bookingData.vendorUserId,
                    type: 'payment_received',
                    title: 'Payment Received',
                    message: `Payment has been received for booking #${bookingId}`,
                    relatedId: bookingId
                });
                
            } catch (error) {
                console.error('Error updating payment status:', error);
                throw error;
            }
        }
        
        // Open booking chat
        async function openBookingChat(bookingId) {
            try {
                // Get or create chat for this booking
                const response = await fetch(`${API_BASE_URL}/chats/booking/${bookingId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to get booking chat');
                
                const chatData = await response.json();
                
                // Switch to messages section and load this specific chat
                if (isVendorMode) {
                    displayVendorDashboard('vendor-messages');
                } else {
                    displayUserDashboard('client', 'messages');
                }
                
                // Load the specific chat conversation
                setTimeout(() => {
                    loadSpecificChat(chatData.chatId);
                }, 500);
                
            } catch (error) {
                console.error('Error opening booking chat:', error);
                showGlobalError(`Failed to open chat: ${error.message}`);
            }
        }
        
        // Load specific chat conversation
        async function loadSpecificChat(chatId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chats/${chatId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load chat messages');
                
                const messages = await response.json();
                
                // Display messages in chat interface
                const chatContainer = document.querySelector('.chat-messages');
                if (chatContainer) {
                    chatContainer.innerHTML = '';
                    messages.forEach(message => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;
                        messageEl.innerHTML = `
                            <div class="message-content">${message.content}</div>
                            <div class="message-time">${new Date(message.createdAt).toLocaleTimeString()}</div>
                        `;
                        chatContainer.appendChild(messageEl);
                    });
                    
                    // Scroll to bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
            } catch (error) {
                console.error('Error loading specific chat:', error);
            }
        }
        
        async function declineRequest(requestId) {
            const reason = prompt('Please provide a reason for declining (optional):');
            
            let revertOptimistic = () => {};
            try {
                const vendorProfileId = await getVendorProfileId();
                // Optimistic UI: mark card as declined immediately
                revertOptimistic = optimisticUpdateRequestCard(requestId, 'declined');
                
                const response = await fetch(`${API_BASE_URL}/bookings/requests/${requestId}/decline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        vendorProfileId: vendorProfileId,
                        responseMessage: reason || 'Request declined.'
                    })
                });
                
                if (!response.ok) throw new Error('Failed to decline request');
                
                const declineData = await response.json();
                
                // Create notification for user about decline
                const actualUserId = declineData.userId || declineData.UserID;
                if (actualUserId) {
                    await createNotification({
                        userId: actualUserId,
                        type: 'booking_declined',
                        title: 'Booking Request Declined',
                        message: `Your booking request has been declined. ${reason ? 'Reason: ' + reason : ''}`,
                        relatedId: requestId
                    });
                } else {
                    // Fallback notification
                    createLocalNotification(currentUser.id, 'booking_declined', 'Booking Request Declined', `Your booking request has been declined. ${reason ? 'Reason: ' + reason : ''}`);
                }
                
                showBanner('Request declined.', 'notice');
                
                // Keep current filter; refresh list in background to reconcile
                if (typeof syncVendorRequestTabStates === 'function') { try { syncVendorRequestTabStates(); } catch (_) {} }
                if (typeof loadVendorRequests === 'function') {
                    try { loadVendorRequests(vendorReqFilters.direction, vendorReqFilters.status, { silent: true }); } catch (_) {}
                }
                
                // Update notifications
                if (typeof loadNotifications === 'function') {
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error declining request:', error);
                try { if (typeof revertOptimistic === 'function') revertOptimistic(); } catch (_) {}
                showGlobalError(`Failed to decline request: ${error.message}`);
            }
        }

document.addEventListener('DOMContentLoaded', async function() {
            // API base URL
            const API_BASE_URL = 'https://bdb-3-0-venuevue-api.onrender.com/api';

            // Fetch payment configuration (platform fee, Stripe fees, etc.) - NO FALLBACKS
            try {
                const configRes = await fetch(`${API_BASE_URL}/payments/config`);
                if (configRes.ok) {
                    const config = await configRes.json();
                    if (config.success) {
                        // Store values directly from environment variables - no defaults
                        window.PLATFORM_FEE_PERCENT = config.platformFeePercent;
                        window.STRIPE_PROC_FEE_PERCENT = config.stripeProcFeePercent;
                        window.STRIPE_PROC_FEE_FIXED = config.stripeProcFeeFixed;
                        window.TAX_PERCENT = config.taxPercent;
                        window.STRIPE_CURRENCY = config.currency;
                        window.CONFIG_LOADED = true;
                        console.log('✅ Payment config loaded from environment:', config);
                        
                        // Warn if environment variables are not set (will be NaN)
                        if (isNaN(config.platformFeePercent)) {
                            console.error('⚠️ PLATFORM_FEE_PERCENT is not set in Render environment!');
                        }
                        if (isNaN(config.stripeProcFeePercent)) {
                            console.error('⚠️ STRIPE_PROC_FEE_PERCENT is not set in Render environment!');
                        }
                        if (isNaN(config.stripeProcFeeFixed)) {
                            console.error('⚠️ STRIPE_PROC_FEE_FIXED is not set in Render environment!');
                        }
                    } else {
                        console.error('❌ Payment config fetch failed: config.success is false');
                        window.CONFIG_LOADED = false;
                    }
                } else {
                    console.error('❌ Payment config fetch failed:', configRes.status);
                    window.CONFIG_LOADED = false;
                }
            } catch (err) {
                console.error('❌ Failed to fetch payment config:', err);
                window.CONFIG_LOADED = false;
            }

            // Handle Stripe Checkout return URLs for success/cancel
            try {
                const url = new URL(window.location.href);
                const pathname = url.pathname || '';
                if (pathname.includes('booking-success')) {
                    // Rehydrate currentUser from storage if page loaded fresh after redirect
                    try {
                        if (!currentUser && typeof getCurrentUser === 'function') {
                            const stored = getCurrentUser();
                            if (stored) currentUser = stored;
                        }
                    } catch (e) { /* no-op */ }
                    // Verify the session with backend as a fallback if webhook is delayed
                    const sessionId = url.searchParams.get('session_id') || url.searchParams.get('sessionId');
                    if (sessionId) {
                        try {
                            await fetch(`${API_BASE_URL}/payments/verify-session?session_id=${encodeURIComponent(sessionId)}`);
                        } catch (e) {
                            console.warn('verify-session failed:', e);
                        }
                    }
                    if (typeof showSuccess === 'function') {
                        showSuccess('Payment completed successfully! Your booking has been confirmed.');
                    }
                    if (typeof loadAllUserBookings === 'function') {
                        try { await loadAllUserBookings(); } catch (e) { console.warn('loadAllUserBookings failed:', e); }
                    }
                    // Clean up URL back to root
                    try { history.replaceState(null, '', '/'); } catch (e) {}
                } else if (pathname.includes('booking-cancelled')) {
                    if (typeof showGlobalError === 'function') {
                        showGlobalError('Payment was cancelled.');
                    }
                    try { history.replaceState(null, '', '/'); } catch (e) {}
                }
            } catch (e) { /* no-op */ }
            
            // Chat state manager - moved here to ensure it's initialized before state object
            const chatState = {
                messages: [],
                currentConversation: null,
                currentChatVendorId: null,

                init: function() {
                    this.messages = [];
                    this.currentConversation = null;
                    this.currentChatVendorId = null;
                    console.log('Chat state initialized.');
                },

                addMessage: function(message) {
                    if (!this.messages) this.messages = [];
                    const formattedMsg = this.formatMessage(message);
                    this.messages.push(formattedMsg);
                    console.log('Message added to chat state:', formattedMsg);
                    return formattedMsg;
                },

                setMessages: function(messages) {
                    this.messages = Array.isArray(messages) ? messages.map(msg => this.formatMessage(msg)) : [];
                    console.log('Chat messages set:', this.messages);
                },

                getMessages: function() {
                    return this.messages || [];
                },

                formatMessage: function(message) {
                    console.log('Formatting message:', message);
                    const content = message.Content || message.content || message.text || message.messageContent;
                    if (content === undefined) {
                        console.warn('Message content is undefined after formatting attempts for message:', message);
                    }
                    return {
                        id: message.MessageID || message.id || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        conversationId: message.ConversationID || message.conversationId || this.currentConversation,
                        senderId: message.SenderID || message.senderId,
                        senderName: message.SenderName || message.senderName || (message.SenderID === currentUser?.id ? currentUser.name : 'Vendor'),
                        content: content,
                        timestamp: message.CreatedAt || message.timestamp || new Date().toISOString(),
                        isCurrentUser: message.SenderID === currentUser?.id || message.isCurrentUser,
                        isRead: message.IsRead || message.isRead || false
                    };
                }
            };
            
            // Global state - moved here to ensure it's initialized before checkAuthStatus
            const state = {
                vendors: [],
                filteredVendors: [],
                markers: [],
                map: null,
                userLocation: null,
                currentPage: 1,
                vendorsPerPage: 12,
                currentView: 'list',
                currentCategory: 'all',
                favorites: [], // Initialize favorites array to prevent undefined error
                filters: {
                    location: '',
                    types: ['independent', 'company'],
                    price: 40,
                    popular: [],
                    startDate: null,
                    endDate: null,
                    region: ''
                },
                // New properties for dynamic map functionality
                originalSearchResults: [],
                isLoadingVendors: false,
                serverPageNumber: 1,
                serverPageSize: 24,
                serverTotalCount: 0,
                mapMoveTimeout: null,
                initialMapBounds: null,
                lastMapBounds: null,
                currentVendor: null,
                selectedServices: [],
                selectedDate: null,
                selectedTime: null,
                stripe: null,
                elements: null,
                paymentIntent: null,
                socket: null,
                chat: chatState
            };
            
            // Check for existing user session on page load
            await checkAuthStatus();
            
            // If no user is logged in, stay logged out (don't auto-create test user)
            // This ensures logout state persists on page refresh

            // Initialize variables
            const mainAppView = document.getElementById('app-container');
            const vendorProfilePage = document.getElementById('vendor-profile-page');
            const confirmationModal = document.getElementById('confirmation-modal');
            const locationPermissionModal = document.getElementById('location-permission');
            const vendorGrid = document.getElementById('vendor-grid');
            const appContainer = document.getElementById('app-container');
            const sidebarEl = document.querySelector('.sidebar');
            const mapVenueList = document.getElementById('map-venue-list');
            const resultsTitle = document.querySelector('.results-title');
            const resultsCount = document.querySelector('.results-count');
            const mapViewContainer = document.getElementById('map-view-container');
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const filtersToggleBtn = document.getElementById('filters-toggle');
            const wishlistBtn = document.getElementById('wishlist-btn');
            const notificationsBtn = document.getElementById('notifications-btn');
            const profileBtn = document.getElementById('profile-btn');
            const filterResetBtns = document.querySelectorAll('.filter-reset');
            const loadMoreWrapper = document.getElementById('load-more-wrapper');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const loadMoreSpinner = document.getElementById('load-more-spinner');

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', async () => {
                    if (state.isLoadingVendors) return;
                    state.isLoadingVendors = true;
                    try { if (loadMoreSpinner) loadMoreSpinner.style.display = 'inline-block'; } catch {}
                    try { loadMoreBtn.disabled = true; } catch {}
                    try {
                        try { appendVendorSkeletons(8); } catch {}
                        await loadVendors({ append: true });
                    } finally {
                        state.isLoadingVendors = false;
                        try { if (loadMoreSpinner) loadMoreSpinner.style.display = 'none'; } catch {}
                        try { loadMoreBtn.disabled = false; } catch {}
                    }
                });
            }


            // Sidebar collapse helpers
            function applySidebarState(collapsed) {
                if (!appContainer || !sidebarEl) return;
                appContainer.classList.toggle('sidebar-collapsed', collapsed);
                sidebarEl.classList.toggle('collapsed', collapsed);
                try { localStorage.setItem('filtersCollapsed', collapsed ? '1' : '0'); } catch (e) {}
            }
            const trendingTags = document.querySelectorAll('.trending-tag');
            const pagination = document.getElementById('pagination');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const locateMeBtn = document.getElementById('locate-me');
            const allowLocationBtn = document.getElementById('allow-location');
            const denyLocationBtn = document.getElementById('deny-location');
            const currentLocationCheckbox = document.getElementById('current-location');
            const locationLoading = document.getElementById('location-loading');
            const locationInput = document.getElementById('location-input');
            const categoryItems = document.querySelectorAll('.category-item');
            const advancedToggle = document.getElementById('advanced-toggle');
            const advancedContent = document.getElementById('advanced-content');
            const categoriesListInner = document.getElementById('categories-list');
            const categoriesListWrapper = document.querySelector('.categories-list-wrapper');
            const scrollLeftBtn = document.getElementById('scroll-left');
            const scrollRightBtn = document.getElementById('scroll-right');

            // Profile modal elements
            const profileModal = document.getElementById('profile-modal');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loggedInView = document.getElementById('logged-in-view');
            const showSignup = document.getElementById('show-signup');
            const showLogin = document.getElementById('show-login');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const googleLoginBtn = document.getElementById('google-login');
            const facebookLoginBtn = document.getElementById('facebook-login');
            const viewDashboardBtn = document.getElementById('view-dashboard-btn');
            const accountTypeSelect = document.getElementById('account-type');
            const twofaForm = document.getElementById('twofa-form');
            const verify2FABtn = document.getElementById('verify-2fa-btn');
            const resend2FABtn = document.getElementById('resend-2fa-btn');
            const backToLoginBtn = document.getElementById('back-to-login-btn');
            let twofaTempToken = null;
            let pendingLoginEmail = '';
            const otpInputs = Array.from(document.querySelectorAll('#twofa-form .otp-digit'));

            function updateTwoFACodeHidden() {
                const hidden = document.getElementById('twofa-code');
                if (!hidden) return;
                hidden.value = otpInputs.map(i => (i.value || '').replace(/\D/g, '')).join('');
            }

            function clearTwoFAOtp() {
                otpInputs.forEach(i => i.value = '');
                updateTwoFACodeHidden();
            }

            function focusFirstTwoFAOtp() {
                if (otpInputs.length) otpInputs[0].focus();
            }

            // OTP inputs behavior (auto-advance, backspace, paste)
            otpInputs.forEach((input, idx) => {
                input.addEventListener('input', (e) => {
                    const val = e.target.value.replace(/\D/g, '');
                    e.target.value = val.slice(-1);
                    if (e.target.value && idx < otpInputs.length - 1) {
                        otpInputs[idx + 1].focus();
                        otpInputs[idx + 1].select?.();
                    }
                    updateTwoFACodeHidden();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace') {
                        if (!input.value && idx > 0) {
                            otpInputs[idx - 1].focus();
                            otpInputs[idx - 1].value = '';
                            updateTwoFACodeHidden();
                            e.preventDefault();
                        }
                    } else if (e.key === 'ArrowLeft' && idx > 0) {
                        otpInputs[idx - 1].focus();
                        e.preventDefault();
                    } else if (e.key === 'ArrowRight' && idx < otpInputs.length - 1) {
                        otpInputs[idx + 1].focus();
                        e.preventDefault();
                    } else if (e.key === 'Enter') {
                        verify2FABtn?.click();
                    }
                });
            });

            document.getElementById('twofa-form')?.addEventListener('paste', (e) => {
                const text = (e.clipboardData || window.clipboardData)?.getData('text') || '';
                const digits = text.replace(/\D/g, '').slice(0, otpInputs.length).split('');
                if (digits.length) {
                    e.preventDefault();
                    otpInputs.forEach((inp, i) => { inp.value = digits[i] || ''; });
                    updateTwoFACodeHidden();
                    if (digits.length === otpInputs.length) verify2FABtn?.focus();
                }
            });

            // Dashboard elements (unified menu and container)
            const clientDashboardContainer = document.getElementById('dashboard-container');
            // Merge vendor menu items and sections into the unified dashboard
            (function unifyDashboardUI() {
                try {
                    const vendorContainer = document.getElementById('vendor-dashboard-container');
                    if (!clientDashboardContainer || !vendorContainer) return;

                    // Merge menus: move vendor menu items into client menu (before logout)
                    const clientMenu = clientDashboardContainer.querySelector('.dashboard-menu');
                    const vendorMenu = vendorContainer.querySelector('.dashboard-menu');
                    if (clientMenu && vendorMenu) {
                        const beforeNode = clientMenu.querySelector('#logout-dashboard')?.closest('li') || null;
                        Array.from(vendorMenu.querySelectorAll('li')).forEach(li => {
                            const a = li.querySelector('a');
                            if (!a) return;
                            const id = a.id || '';
                            // Skip vendor-only switch/logout items (we keep one unified Logout in client menu)
                            if (id === 'switch-to-client' || id === 'vendor-logout') return;
                            const section = a.dataset.section;
                            // Avoid duplicates by section key
                            if (section && clientMenu.querySelector(`a[data-section="${section}"]`)) return;
                            const clone = li.cloneNode(true);
                            const link = clone.querySelector('a');
                            if (link) link.classList.remove('active');
                            if (beforeNode) clientMenu.insertBefore(clone, beforeNode); else clientMenu.appendChild(clone);
                        });
                        // Remove client-side switch-to-vendor entry (redundant with unified menu)
                        const switchToVendorEl = clientMenu.querySelector('#switch-to-vendor');
                        if (switchToVendorEl) switchToVendorEl.closest('li')?.remove();
                    }

                    // Merge content sections: move vendor sections into client main
                    const clientMain = clientDashboardContainer.querySelector('main');
                    const vendorMain = vendorContainer.querySelector('main');
                    if (clientMain && vendorMain) {
                        const vendorSections = Array.from(vendorMain.querySelectorAll('div[id$="-section"]'));
                        vendorSections.forEach(sec => clientMain.appendChild(sec));
                    }

                    // Remove vendor container to avoid duplicate IDs and simplify logic
                    vendorContainer.remove();
                } catch (err) {
                    console.warn('Dashboard unify failed:', err);
                }
            })();

            // Group unified menu into Client and Vendor sections
            (function groupUnifiedMenu() {
                try {
                    const clientMenu = clientDashboardContainer?.querySelector('.dashboard-menu');
                    if (!clientMenu) return;

                    const logoutLi = clientMenu.querySelector('#logout-dashboard')?.closest('li') || null;
                    const allLis = Array.from(clientMenu.querySelectorAll('li'));
                    const clientLis = [];
                    const vendorLis = [];

                    allLis.forEach(li => {
                        if (logoutLi && li === logoutLi) return;
                        const a = li.querySelector('a');
                        if (!a) return;
                        const sec = a.dataset.section;
                        if (!sec) return;
                        if (sec.startsWith('vendor-')) vendorLis.push(li); else clientLis.push(li);
                    });

                    // Rebuild menu in grouped order
                    clientMenu.innerHTML = '';
                    const makeHeading = (text) => {
                        const h = document.createElement('li');
                        h.className = 'menu-heading';
                        h.textContent = text;
                        return h;
                    };

                    if (clientLis.length) {
                        clientMenu.appendChild(makeHeading('Client'));
                        clientLis.forEach(li => clientMenu.appendChild(li));
                    }

                    if (vendorLis.length) {
                        clientMenu.appendChild(makeHeading('Vendor'));
                        vendorLis.forEach(li => clientMenu.appendChild(li));
                    }

                    if (logoutLi) clientMenu.appendChild(logoutLi);
                } catch (err) {
                    console.warn('Menu grouping failed:', err);
                }
            })();

            const dashboardMenuItems = clientDashboardContainer.querySelectorAll('.dashboard-menu a');
            const logoutDashboardBtn = document.getElementById('logout-dashboard');
            
            // Chat modal elements
            const chatModal = document.getElementById('chat-modal');
            const chatVendorName = document.getElementById('chat-vendor-name');
            const profileChatInput = document.getElementById('profile-chat-input');
            const profileSendBtn = document.getElementById('profile-send-btn');
            const profileChatMessages = document.getElementById('profile-chat-messages');

            // Vendor registration elements
            const vendorRegistrationModal = document.getElementById('vendor-registration-modal');
            const regStatusMessage = document.getElementById('reg-status-message');

            // Comprehensive Vendor Setup Wizard State (consolidated)
            if (typeof vendorSetupState === 'undefined') {
                var vendorSetupState = {
                    currentStep: 1,
                    vendorId: null,
                    vendorProfileId: null,
                    stepData: {
                        step1: {}, // Business Basics
                        step2: {}, // Location Information
                        step3: {}, // Gallery & Media
                        step4: {}, // Services & Packages
                        step5: {}, // Team Information
                        step6: {}, // Social Media & Links
                        step7: {}, // Additional Details (Category-specific questions)
                        step8: {}, // FAQ Section
                        step9: {}, // Summary
                        step10: {} // Policies & Preferences
                    },
                    gallery: [],
                    portfolio: [],
                    packages: [],
                    services: [],
                    teamMembers: [],
                    faqs: [],
                    additionalDetailsAnswers: {},
                    selectedPredefinedServices: [],
                    selectedCities: []
                };
            }

            // Load & Save: Policies
            async function loadVendorPolicies(vendorProfileId) {
                const form = document.getElementById('vendor-policies-form');
                const inputs = {
                    deposit: document.getElementById('pol-deposit'),
                    cancel: document.getElementById('pol-cancel'),
                    reschedule: document.getElementById('pol-reschedule'),
                    methods: document.getElementById('pol-payment-methods'),
                    terms: document.getElementById('pol-payment-terms')
                };
                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/policies`);
                    if (res.ok) {
                        const data = await res.json();
                        const p = data?.policies || {};
                        inputs.deposit.value = p.DepositRequirements || '';
                        inputs.cancel.value = p.CancellationPolicy || '';
                        inputs.reschedule.value = p.ReschedulingPolicy || '';
                        inputs.methods.value = Array.isArray(p.PaymentMethods) ? p.PaymentMethods.join(', ') : (p.PaymentMethods || '');
                        inputs.terms.value = p.PaymentTerms || '';
                    }
                } catch (err) {
                    console.error('Load policies error:', err);
                }
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const payload = {
                            depositRequirements: safeMaybeJson(inputs.deposit.value?.trim()),
                            cancellationPolicy: inputs.cancel.value?.trim(),
                            reschedulingPolicy: inputs.reschedule.value?.trim(),
                            paymentMethods: safeMaybeJson(inputs.methods.value?.trim()) || inputs.methods.value?.split(',').map(s => s.trim()).filter(Boolean),
                            paymentTerms: inputs.terms.value?.trim()
                        };
                        const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/policies`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error('Failed to save policies');
                        alert('Policies saved');
                    } catch (err) {
                        console.error('Save policies error:', err);
                        alert('Failed to save policies: ' + err.message);
                    }
                };
            }

            // Load & Save: Verification
            async function loadVendorVerification(vendorProfileId) {
                const form = document.getElementById('vendor-verification-form');
                const inputs = {
                    lic: document.getElementById('ver-license'),
                    insured: document.getElementById('ver-insurance'),
                    awards: document.getElementById('ver-awards'),
                    certs: document.getElementById('ver-certifications'),
                    eco: document.getElementById('ver-eco'),
                    premium: document.getElementById('ver-premium')
                };
                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/verification`);
                    if (res.ok) {
                        const data = await res.json();
                        const v = data?.verification || {};
                        inputs.lic.value = v.LicenseNumber || '';
                        inputs.insured.checked = !!v.InsuranceVerified;
                        inputs.awards.value = tryStringifyIfJson(v.Awards) || '';
                        inputs.certs.value = tryStringifyIfJson(v.Certifications) || '';
                        inputs.eco.checked = !!v.IsEcoFriendly;
                        inputs.premium.checked = !!v.IsPremium;
                    }
                } catch (err) {
                    console.error('Load verification error:', err);
                }
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const payload = {
                            licenseNumber: inputs.lic.value?.trim(),
                            insuranceVerified: inputs.insured.checked,
                            awards: safeMaybeJson(inputs.awards.value?.trim()) || splitCsv(inputs.awards.value),
                            certifications: safeMaybeJson(inputs.certs.value?.trim()) || splitCsv(inputs.certs.value),
                            isEcoFriendly: inputs.eco.checked,
                            isPremium: inputs.premium.checked
                        };
                        const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/verification`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error('Failed to save verification');
                        alert('Verification saved');
                    } catch (err) {
                        console.error('Save verification error:', err);
                        alert('Failed to save verification: ' + err.message);
                    }
                };
            }

            // Load & Save: Team
            async function loadVendorTeam(vendorProfileId) {
                const list = document.getElementById('team-list');
                const addBtn = document.getElementById('add-team-member');
                const saveBtn = document.getElementById('save-team');
                list.innerHTML = '<p>Loading team...</p>';
                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/team`);
                    const data = await res.json();
                    const team = data?.team || [];
                    renderTeam(team);
                } catch (err) {
                    console.error('Load team error:', err);
                    list.innerHTML = '<p>Failed to load team.</p>';
                }
                function renderTeam(team) {
                    list.innerHTML = '';
                    if (!team || team.length === 0) {
                        list.innerHTML = '<p>No team members yet.</p>';
                        return;
                    }
                    team.forEach((t) => addTeamRow(t.Name, t.Role, t.Bio, t.ImageURL));
                }
                function addTeamRow(name = '', role = '', bio = '', imageUrl = '') {
                    const row = document.createElement('div');
                    row.className = 'form-row';
                    row.innerHTML = `
                        <div class="form-col"><div class="form-group"><label>Name</label><input type="text" class="team-name" value="${name}"></div></div>
                        <div class="form-col"><div class="form-group"><label>Role</label><input type="text" class="team-role" value="${role}"></div></div>
                        <div class="form-col"><div class="form-group"><label>Image URL</label><input type="text" class="team-image" value="${imageUrl}"></div></div>
                        <div class="form-col"><div class="form-group"><label>Bio</label><textarea class="team-bio" rows="2" style="width:100%;">${bio}</textarea></div></div>
                    `;
                    list.appendChild(row);
                }
                addBtn.onclick = () => addTeamRow();
                saveBtn.onclick = async () => {
                    try {
                        const teamMembers = Array.from(list.querySelectorAll('.form-row')).map(row => ({
                            name: row.querySelector('.team-name')?.value?.trim(),
                            role: row.querySelector('.team-role')?.value?.trim(),
                            bio: row.querySelector('.team-bio')?.value?.trim(),
                            imageUrl: row.querySelector('.team-image')?.value?.trim(),
                        })).filter(m => m.name);
                        const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/team/upsert`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ teamMembers })
                        });
                        if (!res.ok) throw new Error('Failed to save team');
                        alert('Team saved');
                        await loadVendorTeam(vendorProfileId);
                    } catch (err) {
                        console.error('Save team error:', err);
                        alert('Failed to save team: ' + err.message);
                    }
                };
            }

            // Load & Save: Services (Settings Panel)
            async function loadVendorServicesSettings(vendorProfileId) {
                // Elements
                const loadingEl = document.getElementById('vendor-settings-services-loading');
                const containerEl = document.getElementById('vendor-settings-services-container');
                const gridEl = document.getElementById('vendor-settings-services-grid');
                const noServicesEl = document.getElementById('vendor-settings-no-services');
                const countEl = document.getElementById('vendor-settings-selected-count');
                const summaryEl = document.getElementById('vendor-settings-selected-summary');
                const summaryListEl = document.getElementById('vendor-settings-selected-list');
                const saveBtn = document.getElementById('vendor-settings-save-services');

                if (!loadingEl || !containerEl || !gridEl) return;

                // State for settings
                window.vendorSettingsState = window.vendorSettingsState || { selectedPredefinedServices: [] };
                window.vendorSettingsState.selectedPredefinedServices = [];

                // Helpers (settings-scoped)
                const updateCount = () => {
                    const n = window.vendorSettingsState.selectedPredefinedServices?.length || 0;
                    if (countEl) countEl.textContent = `${n} added`;
                };
                const updateSummary = () => {
                    const selected = window.vendorSettingsState.selectedPredefinedServices || [];
                    if (!summaryEl || !summaryListEl) return;
                    if (selected.length === 0) { summaryEl.style.display = 'none'; return; }
                    summaryEl.style.display = 'block';
                    summaryListEl.innerHTML = selected.map(service => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; background:#fff; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
                            <div>
                                <div style="font-weight:500; margin-bottom:0.25rem;">${service.name}</div>
                                <div style="font-size:0.85rem; color:var(--text-light);">
                                    ${service.pricingModel === 'fixed_price' || service.pricingModel === 'per_attendee'
                                        ? (service.pricingModel === 'per_attendee'
                                            ? `$${service.pricePerPerson || 0}/person`
                                            : `$${service.fixedPrice || service.vendorPrice || 0} fixed`)
                                        : `$${service.baseRate || service.vendorPrice || 0} for ${service.vendorDuration || service.baseDurationMinutes || service.defaultDuration || 60} min`}
                                    ${service.vendorDescription ? ` • ${service.vendorDescription}` : ''}
                                </div>
                            </div>
                            <div style="color: var(--primary); font-size: 0.85rem; font-weight: 500;">${service.category || ''}</div>
                        </div>
                    `).join('');
                };

                function createSettingsAddServiceCard() {
                    const add = document.createElement('div');
                    add.className = 'add-service-card';
                    add.style.cssText = 'width:100%; border:2px dashed var(--border); border-radius:12px; height: fit-content; background:#f8fafc; display:flex; align-items:center; justify-content:center; padding:16px; cursor:pointer; position:relative;';
                    add.innerHTML = `
                        <div style="text-align:center; color:#64748b;">
                            <div style="font-size:28px; line-height:1; margin-bottom:8px;"><i class="fas fa-plus-circle"></i></div>
                            <div style="font-weight:600;">Add a service</div>
                            <div style="font-size:0.85rem;">Click to choose from the list</div>
                        </div>
                    `;
                    add.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        showSettingsServicePickerPopover(add);
                    });
                    return add;
                }

                function showSettingsServicePickerPopover(anchorEl) {
                    const existing = document.getElementById('service-picker-popover');
                    if (existing) existing.remove();
                    const pop = document.createElement('div');
                    pop.id = 'service-picker-popover';
                    pop.style.cssText = 'position:absolute; z-index:1000; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.12); width:320px; max-height:320px; overflow:auto; padding:8px;';
                    const rect = anchorEl.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                    pop.style.top = (rect.top + scrollTop + anchorEl.offsetHeight + 8) + 'px';
                    pop.style.left = (rect.left + scrollLeft) + 'px';
                    pop.innerHTML = `
                        <div style="position:sticky; top:0; background:#fff; padding:6px 6px 8px;">
                            <input id="service-picker-filter" type="text" placeholder="Search services..." style="width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                        <div id="service-picker-list"></div>
                    `;
                    document.body.appendChild(pop);
                    const listEl = pop.querySelector('#service-picker-list');
                    function renderList(query = '') {
                        const q = query.trim().toLowerCase();
                        const options = (window.vendorSettingsAvailableServices || []).filter(s =>
                            !q || s.name.toLowerCase().includes(q) || (s.category||'').toLowerCase().includes(q)
                        );
                        listEl.innerHTML = options.map(s => `
                            <button data-id="${s.id}" style="width:100%; text-align:left; padding:10px; border:none; background:#fff; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                                <span>${s.name}</span>
                                <span style="font-size:0.75rem; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:999px;">${s.category||''}</span>
                            </button>
                        `).join('');
                    }
                    renderList();
                    pop.querySelector('#service-picker-filter').addEventListener('input', (e) => renderList(e.target.value));
                    listEl.addEventListener('click', (e) => {
                        const btn = e.target.closest('button[data-id]');
                        if (!btn) return;
                        const id = btn.getAttribute('data-id');
                        addSettingsServiceById(id);
                        pop.remove();
                    });
                    const onDocClick = (e) => {
                        if (!pop.contains(e.target) && e.target !== anchorEl) {
                            pop.remove();
                            document.removeEventListener('mousedown', onDocClick);
                            document.removeEventListener('keydown', onKey);
                        }
                    };
                    const onKey = (e) => {
                        if (e.key === 'Escape') {
                            pop.remove();
                            document.removeEventListener('mousedown', onDocClick);
                            document.removeEventListener('keydown', onKey);
                        }
                    };
                    document.addEventListener('mousedown', onDocClick);
                    document.addEventListener('keydown', onKey);
                }

                function createSettingsServiceCard(service) {
                    const card = document.createElement('div');
                    card.className = 'predefined-service-card';
                    card.dataset.serviceId = service.id;
                    card.dataset.serviceName = service.name;
                    card.dataset.serviceCategory = service.category || '';
                    card.innerHTML = `
                        <div class="service-card-header">
                            <h6 class="service-card-title" style="display:flex; align-items:center; gap:0.5rem;">
                                ${service.name}
                                <span style="font-size:0.7rem; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:999px; font-weight:600;">${service.category || ''}</span>
                            </h6>
                            <div class="service-card-check" style="margin-left:auto;">
                                <i class="fas fa-check"></i>
                            </div>
                            <button type="button" class="remove-service-btn" aria-label="Remove" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="service-card-description">${service.description || 'Professional service offering'}</div>
                        <div class="vendor-customization-form">
                            <h6 style="margin: 0 0 1rem 0; color: var(--primary); font-size: 0.9rem;">Customize Your Service</h6>
                            <div class="form-row-inline">
                                <div class="form-group-inline" style="min-width: 200px;">
                                    <label>Pricing Model *</label>
                                    <select class="vendor-pricing-model">
                                        <option value="time_based" selected>Time-based</option>
                                        <option value="fixed_price">Fixed Price</option>
                                        <option value="per_attendee">Per Attendee</option>
                                    </select>
                                </div>
                            </div>
                            <div class="vendor-time-based" style="margin-top: 0.5rem;">
                                <div class="form-row-inline">
                                    <div class="form-group-inline"><label>Base Duration (min) *</label><input type="number" class="vendor-duration-input" min="15" step="15" value="${service.defaultDuration || 60}" placeholder="60" required></div>
                                    <div class="form-group-inline"><label>Base Rate ($) *</label><input type="number" class="vendor-base-rate" min="0" step="0.01" placeholder="0.00" required></div>
                                    <div class="form-group-inline"><label>Overtime ($/hr) *</label><input type="number" class="vendor-overtime-rate" min="0" step="0.01" placeholder="0.00" required></div>
                                </div>
                            </div>
                            <div class="vendor-fixed-price-section" style="margin-top: 0.5rem; display: none;">
                                <div class="form-row-inline">
                                    <div class="form-group-inline"><label>Price ($) *</label><input type="number" class="vendor-fixed-price-input" min="0" step="0.01" placeholder="0.00" required></div>
                                </div>
                            </div>
                            <div class="vendor-per-attendee-section" style="margin-top: 0.5rem; display: none;">
                                <div class="form-row-inline">
                                    <div class="form-group-inline"><label>Price Per Person ($) *</label><input type="number" class="vendor-price-per-person" min="0" step="0.01" placeholder="0.00" required></div>
                                    <div class="form-group-inline"><label>Min Attendees *</label><input type="number" class="vendor-min-attendees" min="1" step="1" placeholder="1" required></div>
                                    <div class="form-group-inline"><label>Max Attendees *</label><input type="number" class="vendor-max-attendees" min="1" step="1" placeholder="10" required></div>
                                </div>
                            </div>
                            <div class="form-group-inline">
                                <label>Your Description *</label>
                                <textarea class="vendor-description-input" placeholder="Add any specific details about how you provide this service..." rows="2" required></textarea>
                            </div>
                        </div>
                    `;
                    // select/deselect behavior (ignore clicks on inputs/remove)
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.vendor-customization-form input, .vendor-customization-form textarea, .vendor-customization-form select, .remove-service-btn')) return;
                        toggleSettingsServiceSelection(card, service);
                    });
                    // remove handler
                    card.querySelector('.remove-service-btn')?.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        removeSettingsSelectedService(service.id);
                        card.remove();
                        updateCount();
                        updateSummary();
                    });
                    return card;
                }

                function addSettingsServiceById(serviceId, isPreload = false) {
                    const svc = (window.vendorSettingsAvailableServices || []).find(s => String(s.id) === String(serviceId));
                    if (!svc || !gridEl) return;
                    if (gridEl.querySelector(`.predefined-service-card[data-service-id="${svc.id}"]`)) return; // prevent dup
                    const card = createSettingsServiceCard(svc);
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(6px)';
                    card.style.transition = 'opacity 160ms ease, transform 180ms ease';
                    // insert before add card if exists
                    const addCard = gridEl.querySelector('.add-service-card');
                    if (addCard) gridEl.insertBefore(card, addCard); else gridEl.appendChild(card);
                    requestAnimationFrame(() => { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; });
                    // mark selected and push to state
                    card.classList.add('selected');
                    if (!window.vendorSettingsState.selectedPredefinedServices?.some(s => s.id === svc.id)) {
                        addSettingsSelectedService(card, svc);
                    }
                    // focus first input on manual add
                    if (!isPreload) {
                        const firstInput = card.querySelector('.vendor-customization-form select, .vendor-customization-form input');
                        if (firstInput) setTimeout(() => { try { firstInput.focus(); } catch(_){} }, 200);
                    }
                    updateCount();
                    updateSummary();
                }

                function toggleSettingsServiceSelection(card, service) {
                    const isSelected = card.classList.contains('selected');
                    if (isSelected) {
                        card.classList.remove('selected');
                        removeSettingsSelectedService(service.id);
                    } else {
                        card.classList.add('selected');
                        addSettingsSelectedService(card, service);
                    }
                    updateCount();
                    updateSummary();
                }

                function addSettingsSelectedService(card, service) {
                    // ensure removed before add
                    removeSettingsSelectedService(service.id);
                    const selectedService = {
                        id: service.id,
                        predefinedServiceId: service.id,
                        name: service.name,
                        description: service.description,
                        category: service.category,
                        defaultDuration: service.defaultDuration,
                        price: 0,
                        durationMinutes: service.defaultDuration || 60,
                        vendorPrice: 0,
                        vendorDuration: service.defaultDuration || 60,
                        vendorDescription: '',
                        pricingModel: 'time_based',
                        baseDurationMinutes: service.defaultDuration || 60,
                        baseRate: null,
                        overtimeRatePerHour: null,
                        minimumBookingFee: null,
                        fixedPricingType: 'fixed_price',
                        fixedPrice: null,
                        pricePerPerson: null,
                        minimumAttendees: null,
                        maximumAttendees: null
                    };
                    window.vendorSettingsState.selectedPredefinedServices.push(selectedService);
                    // wire inputs
                    const durationInput = card.querySelector('.vendor-duration-input');
                    const descriptionInput = card.querySelector('.vendor-description-input');
                    const pricingModelSelect = card.querySelector('.vendor-pricing-model');
                    const timeBasedSection = card.querySelector('.vendor-time-based');
                    const fixedPriceSection = card.querySelector('.vendor-fixed-price-section');
                    const perAttendeeSection = card.querySelector('.vendor-per-attendee-section');
                    const baseRateInput = card.querySelector('.vendor-base-rate');
                    const overtimeRateInput = card.querySelector('.vendor-overtime-rate');
                    const minFeeInput = card.querySelector('.vendor-min-fee');
                    const fixedPriceInput = card.querySelector('.vendor-fixed-price-input');
                    const pppInput = card.querySelector('.vendor-price-per-person');
                    const minAttInput = card.querySelector('.vendor-min-attendees');
                    const maxAttInput = card.querySelector('.vendor-max-attendees');
                    const setRequired = (el, req) => { if (el) el.required = !!req; };
                    const togglePricingSections = (val) => {
                        if (timeBasedSection) timeBasedSection.style.display = (val === 'time_based') ? '' : 'none';
                        if (fixedPriceSection) fixedPriceSection.style.display = (val === 'fixed_price') ? '' : 'none';
                        if (perAttendeeSection) perAttendeeSection.style.display = (val === 'per_attendee') ? '' : 'none';
                        setRequired(baseRateInput, val === 'time_based');
                        setRequired(overtimeRateInput, val === 'time_based');
                        setRequired(durationInput, val === 'time_based');
                        setRequired(fixedPriceInput, val === 'fixed_price');
                        setRequired(pppInput, val === 'per_attendee');
                        setRequired(minAttInput, val === 'per_attendee');
                        setRequired(maxAttInput, val === 'per_attendee');
                        if (val === 'time_based') {
                            if (fixedPriceInput) fixedPriceInput.value = '';
                            if (pppInput) pppInput.value = '';
                            if (minAttInput) minAttInput.value = '';
                            if (maxAttInput) maxAttInput.value = '';
                        } else if (val === 'fixed_price') {
                            if (baseRateInput) baseRateInput.value = '';
                            if (overtimeRateInput) overtimeRateInput.value = '';
                            if (pppInput) pppInput.value = '';
                            if (minAttInput) minAttInput.value = '';
                            if (maxAttInput) maxAttInput.value = '';
                        } else if (val === 'per_attendee') {
                            if (baseRateInput) baseRateInput.value = '';
                            if (overtimeRateInput) overtimeRateInput.value = '';
                            if (fixedPriceInput) fixedPriceInput.value = '';
                        }
                    };
                    const updateServiceData = () => {
                        const idx = window.vendorSettingsState.selectedPredefinedServices.findIndex(s => s.id === service.id);
                        if (idx === -1) return;
                        const priceValue = 0;
                        const durationValue = parseInt(durationInput?.value) || service.defaultDuration || 60;
                        const descriptionValue = descriptionInput?.value?.trim() || '';
                        const pricingModelVal = pricingModelSelect?.value || 'time_based';
                        const baseRateVal = baseRateInput ? parseFloat(baseRateInput.value) : null;
                        const overtimeRateVal = overtimeRateInput ? parseFloat(overtimeRateInput.value) : null;
                        const minFeeVal = minFeeInput ? parseFloat(minFeeInput.value) : null;
                        const fixedPriceVal = fixedPriceInput ? parseFloat(fixedPriceInput.value) : null;
                        const pppVal = pppInput ? parseFloat(pppInput.value) : null;
                        const minAttVal = minAttInput ? parseInt(minAttInput.value) : null;
                        const maxAttVal = maxAttInput ? parseInt(maxAttInput.value) : null;
                        const st = window.vendorSettingsState.selectedPredefinedServices[idx];
                        st.vendorPrice = priceValue;
                        st.vendorDuration = durationValue;
                        st.vendorDescription = descriptionValue;
                        st.price = priceValue;
                        st.durationMinutes = durationValue;
                        st.description = descriptionValue;
                        st.pricingModel = pricingModelVal;
                        st.baseDurationMinutes = durationValue;
                        st.baseRate = Number.isFinite(baseRateVal) ? baseRateVal : null;
                        st.overtimeRatePerHour = Number.isFinite(overtimeRateVal) ? overtimeRateVal : null;
                        st.minimumBookingFee = Number.isFinite(minFeeVal) ? minFeeVal : null;
                        st.fixedPricingType = pricingModelVal === 'per_attendee' ? 'per_attendee' : (pricingModelVal === 'fixed_price' ? 'fixed_price' : null);
                        st.fixedPrice = Number.isFinite(fixedPriceVal) ? fixedPriceVal : null;
                        st.pricePerPerson = Number.isFinite(pppVal) ? pppVal : null;
                        st.minimumAttendees = Number.isFinite(minAttVal) ? minAttVal : null;
                        st.maximumAttendees = Number.isFinite(maxAttVal) ? maxAttVal : null;
                        if (pricingModelVal === 'time_based') {
                            st.fixedPricingType = null; st.fixedPrice = null; st.pricePerPerson = null; st.minimumAttendees = null; st.maximumAttendees = null;
                        } else if (pricingModelVal === 'fixed_price') {
                            st.pricePerPerson = null; st.minimumAttendees = null; st.maximumAttendees = null; st.baseRate = null; st.overtimeRatePerHour = null;
                        } else if (pricingModelVal === 'per_attendee') {
                            st.fixedPrice = null; st.baseRate = null; st.overtimeRatePerHour = null;
                        }
                        updateSummary();
                    };
                    // listeners
                    durationInput?.addEventListener('input', updateServiceData);
                    descriptionInput?.addEventListener('input', updateServiceData);
                    baseRateInput?.addEventListener('input', updateServiceData);
                    overtimeRateInput?.addEventListener('input', updateServiceData);
                    minFeeInput?.addEventListener('input', updateServiceData);
                    fixedPriceInput?.addEventListener('input', updateServiceData);
                    pppInput?.addEventListener('input', updateServiceData);
                    minAttInput?.addEventListener('input', updateServiceData);
                    maxAttInput?.addEventListener('input', updateServiceData);
                    // init sections
                    togglePricingSections(pricingModelSelect?.value || 'time_based');
                    pricingModelSelect?.addEventListener('change', (e) => { togglePricingSections(e.target.value); updateServiceData(); });
                }

                function removeSettingsSelectedService(serviceId) {
                    window.vendorSettingsState.selectedPredefinedServices = (window.vendorSettingsState.selectedPredefinedServices || []).filter(s => s.id !== serviceId);
                }

                // UI: show loading
                loadingEl.style.display = 'block';
                containerEl.style.display = 'none';
                if (noServicesEl) noServicesEl.style.display = 'none';

                try {
                    // Fetch predefined services (all categories; settings context may not have selected categories available)
                    const resp = await fetch(`${API_BASE_URL}/vendors/predefined-services`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const data = await resp.json();
                    const all = [];
                    const byCat = data?.servicesByCategory || {};
                    Object.keys(byCat).forEach(cat => { (byCat[cat] || []).forEach(s => all.push({ ...s, category: cat })); });

                    if (!all.length) {
                        loadingEl.style.display = 'none';
                        if (noServicesEl) noServicesEl.style.display = 'block';
                        return;
                    }

                    window.vendorSettingsAvailableServices = all;
                    gridEl.innerHTML = '';
                    gridEl.appendChild(createSettingsAddServiceCard());

                    // Preload existing selected predefined services (authoritative)
                    try {
                        const selResp = await fetch(`${API_BASE_URL}/vendors/${vendorProfileId}/selected-services`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        });
                        if (selResp.ok) {
                            const selData = await selResp.json();
                            const existingSelected = selData?.selectedServices || [];
                            existingSelected.forEach(s => {
                                // Prefer ID match to avoid name mismatches
                                const match = (window.vendorSettingsAvailableServices || []).find(a => String(a.id) === String(s.PredefinedServiceID));
                                if (match) {
                                    addSettingsServiceById(match.id, true);
                                    const card = gridEl.querySelector(`.predefined-service-card[data-service-id="${match.id}"]`);
                                    if (card) {
                                        // Default to time-based with base rate = VendorPrice and duration = VendorDurationMinutes
                                        const modelSel = card.querySelector('.vendor-pricing-model');
                                        const timeBasedSection = card.querySelector('.vendor-time-based');
                                        const baseRateInput = card.querySelector('.vendor-base-rate');
                                        const durationInput = card.querySelector('.vendor-duration-input');
                                        const descInput = card.querySelector('.vendor-description-input');
                                        if (modelSel) modelSel.value = 'time_based';
                                        if (timeBasedSection) timeBasedSection.style.display = '';
                                        if (baseRateInput && s.VendorPrice != null) baseRateInput.value = parseFloat(s.VendorPrice).toString();
                                        if (durationInput && s.VendorDurationMinutes != null) durationInput.value = parseInt(s.VendorDurationMinutes, 10).toString();
                                        if (descInput && s.VendorDescription) descInput.value = s.VendorDescription;
                                        // Trigger updates to sync state/summary
                                        durationInput?.dispatchEvent(new Event('input'));
                                        baseRateInput?.dispatchEvent(new Event('input'));
                                        descInput?.dispatchEvent(new Event('input'));
                                        modelSel?.dispatchEvent(new Event('change'));
                                    }
                                }
                            });
                            updateCount();
                            updateSummary();
                        }
                    } catch (preErr) {
                        console.warn('Preload selected services failed:', preErr);
                    }

                    loadingEl.style.display = 'none';
                    containerEl.style.display = 'block';
                } catch (err) {
                    console.error('Load services (settings) error:', err);
                    loadingEl.style.display = 'none';
                    if (noServicesEl) noServicesEl.style.display = 'block';
                }

                // Save handler
                if (saveBtn && !saveBtn.dataset.bound) {
                    saveBtn.dataset.bound = '1';
                    saveBtn.addEventListener('click', async () => {
                        try {
                            const resolvedVendorId = vendorProfileId || (currentUser?.vendorProfileId) || (typeof getVendorProfileId === 'function' ? await getVendorProfileId() : null);
                            if (!resolvedVendorId) { alert('Cannot save: missing vendor profile ID'); return; }
                            const selected = (window.vendorSettingsState.selectedPredefinedServices || []);
                            // Derive service categories from current selection so Services have CategoryID
                            const serviceCategories = Array.from(new Set(selected.map(s => s.category).filter(Boolean)))
                                .map((name, i) => ({ name, description: null, displayOrder: i }));
                            const body = {
                                vendorProfileId: resolvedVendorId,
                                serviceCategories,
                                selectedPredefinedServices: selected.map(s => ({
                                    predefinedServiceId: s.id,
                                    name: s.name,
                                    description: s.vendorDescription || s.description || '',
                                    durationMinutes: s.vendorDuration || s.baseDurationMinutes || s.defaultDuration || 60,
                                    pricingModel: s.pricingModel || 'time_based',
                                    baseDurationMinutes: s.baseDurationMinutes || s.vendorDuration || s.defaultDuration || 60,
                                    baseRate: s.baseRate ?? null,
                                    overtimeRatePerHour: s.overtimeRatePerHour ?? null,
                                    minimumBookingFee: s.minimumBookingFee ?? null,
                                    fixedPricingType: s.pricingModel === 'per_attendee' ? 'per_attendee' : (s.pricingModel === 'fixed_price' ? 'fixed_price' : null),
                                    fixedPrice: s.fixedPrice ?? null,
                                    pricePerPerson: s.pricePerPerson ?? null,
                                    minimumAttendees: s.minimumAttendees ?? null,
                                    maximumAttendees: s.maximumAttendees ?? null,
                                    price: s.vendorPrice || s.price || s.fixedPrice || 0
                                })),
                                services: selected.map(s => ({
                                    name: s.name,
                                    description: s.vendorDescription || s.description || '',
                                    // Pricing model is normalized server-side
                                    pricingModel: s.pricingModel || 'time_based',
                                    baseDurationMinutes: s.baseDurationMinutes || s.vendorDuration || s.defaultDuration || 60,
                                    baseRate: s.baseRate ?? null,
                                    overtimeRatePerHour: s.overtimeRatePerHour ?? null,
                                    minimumBookingFee: s.minimumBookingFee ?? null,
                                    fixedPricingType: s.pricingModel === 'per_attendee' ? 'per_attendee' : (s.pricingModel === 'fixed_price' ? 'fixed_price' : null),
                                    fixedPrice: s.fixedPrice ?? null,
                                    pricePerPerson: s.pricePerPerson ?? null,
                                    minimumAttendees: s.minimumAttendees ?? null,
                                    maximumAttendees: s.maximumAttendees ?? null,
                                    durationMinutes: s.vendorDuration || s.baseDurationMinutes || s.defaultDuration || 60,
                                    linkedPredefinedServiceId: s.id,
                                    // Best-effort category association (if categories exist for vendor)
                                    categoryName: s.category || null
                                }))
                            };
                            const resp = await fetch(`${API_BASE_URL}/vendors/setup/step3-services`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                                body: JSON.stringify(body)
                            });
                            if (!resp.ok) {
                                let msg = ''; try { msg = (await resp.json()).message || ''; } catch {}
                                throw new Error(msg || `HTTP ${resp.status}`);
                            }
                            // Post-save cleanup: remove any services no longer selected (best-effort by name)
                            try {
                                const exRespNow = await fetch(`${API_BASE_URL}/vendor/${resolvedVendorId}/services`);
                                if (exRespNow.ok) {
                                    const existingNow = await exRespNow.json();
                                    const norm = (v) => String(v || '').trim().toLowerCase();
                                    const selectedNames = new Set(selected.map(s => norm(s.name)));
                                    for (const svc of existingNow || []) {
                                        const svcName = norm(svc.ServiceName || svc.Name);
                                        const svcId = svc.ServiceID;
                                        if (svcId && svcName && !selectedNames.has(svcName)) {
                                            try {
                                                const del = await fetch(`${API_BASE_URL}/vendor/${resolvedVendorId}/services/${svcId}`, { method: 'DELETE' });
                                                if (!del.ok) console.warn('Failed to delete unselected service', svcId);
                                            } catch (e) {
                                                console.warn('Delete unselected service error', e);
                                            }
                                        }
                                    }
                                }
                            } catch (cleanupErr) {
                                console.warn('Post-save cleanup failed:', cleanupErr);
                            }
                            alert('Services saved');
                            window.dashboardUnsavedWarning = false;
                            await refreshVendorSetupCard();
                        } catch (e) {
                            console.error('Save services (settings) error:', e);
                            alert('Failed to save services: ' + e.message);
                        }
                    });
                }
            }

            // Load & Save: Packages
            async function loadVendorPackagesSettings(vendorProfileId) {
                const list = document.getElementById('packages-list');
                const addBtn = document.getElementById('add-package-btn');
                list.innerHTML = '<p>Loading packages...</p>';
                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/packages`);
                    const data = await res.json();
                    const items = data?.packages || [];
                    renderPackages(items);
                } catch (err) {
                    console.error('Load packages error:', err);
                    list.innerHTML = '<p>Failed to load packages.</p>';
                }
                function renderPackages(items) {
                    list.innerHTML = '';
                    if (!items || items.length === 0) {
                        list.innerHTML = '<p>No packages yet.</p>';
                        return;
                    }
                    items.forEach(p => {
                        const row = document.createElement('div');
                        row.className = 'form-row';
                        row.innerHTML = `
                            <div class="form-col"><div class="form-group"><label>Name</label><input type="text" value="${p.Name || ''}" disabled></div></div>
                            <div class="form-col"><div class="form-group"><label>Price</label><input type="text" value="${p.Price || ''}" disabled></div></div>
                            <div class="form-col"><div class="form-group"><label>Duration</label><input type="text" value="${p.DurationMinutes || ''}" disabled></div></div>
                            <div class="form-col"><div class="form-group"><label>Max Guests</label><input type="text" value="${p.MaxGuests || ''}" disabled></div></div>
                        `;
                        list.appendChild(row);
                    });
                }
                addBtn.onclick = async () => {
                    try {
                        const name = document.getElementById('pkg-name')?.value?.trim();
                        const price = parseFloat(document.getElementById('pkg-price')?.value);
                        const durationMinutes = parseInt(document.getElementById('pkg-duration')?.value, 10) || null;
                        const maxGuests = parseInt(document.getElementById('pkg-max-guests')?.value, 10) || null;
                        const description = document.getElementById('pkg-desc')?.value?.trim() || null;
                        const whatsIncluded = document.getElementById('pkg-includes')?.value?.trim() || null;
                        if (!name || isNaN(price)) {
                            alert('Please provide package name and price.');
                            return;
                        }
                        const payload = { name, description, price, durationMinutes, maxGuests, whatsIncluded };
                        const resp = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/packages/upsert`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!resp.ok) throw new Error('Failed to add package');
                        alert('Package added');
                        window.dashboardUnsavedWarning = false;
                        await loadVendorPackagesSettings(vendorProfileId);
                    } catch (err) {
                        console.error('Add package error:', err);
                        alert('Failed to add package: ' + err.message);
                    }
                };
            }

            // Helpers
            function safeMaybeJson(value) {
                if (!value) return null;
                try { return JSON.parse(value); } catch { return null; }
            }
            function tryStringifyIfJson(value) {
                if (!value) return '';
                try { const parsed = typeof value === 'string' ? JSON.parse(value) : value; return JSON.stringify(parsed); } catch { return String(value); }
            }
            function splitCsv(v) { return v ? v.split(',').map(s => s.trim()).filter(Boolean) : null; }

            // Lazy-load Google Maps JS (Places) on demand. Set window.GOOGLE_MAPS_API_KEY or localStorage.gmaps_api_key
            function loadGoogleMapsIfNeeded() {
                if (window.google && window.google.maps && window.google.maps.places) return Promise.resolve();
                if (window._gmapsLoadingPromise) return window._gmapsLoadingPromise;
                const apiKey = window.GOOGLE_MAPS_API_KEY || localStorage.getItem('gmaps_api_key');
                if (!apiKey) {
                    console.warn('Google Maps API key not set. Define window.GOOGLE_MAPS_API_KEY or localStorage.gmaps_api_key. Autocomplete will be disabled.');
                    return Promise.resolve();
                }
                window._gmapsLoadingPromise = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places&v=weekly`;
                    script.async = true;
                    script.defer = true;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load Google Maps JS'));
                    document.head.appendChild(script);
                });
                return window._gmapsLoadingPromise;
            }

            // Initialize Vendor Setup
            function initializeVendorSetup(vendorId) {
                vendorSetupState.vendorId = vendorId;
                vendorSetupState.currentStep = 1;
                
                // Reset all data
                Object.keys(vendorSetupState.stepData).forEach(key => {
                    vendorSetupState.stepData[key] = {};
                });
                vendorSetupState.gallery = [];
                vendorSetupState.portfolio = [];
                vendorSetupState.packages = [];
                vendorSetupState.services = [];
                vendorSetupState.teamMembers = [];
                vendorSetupState.faqs = [];
                vendorSetupState.additionalDetailsAnswers = {};
                vendorSetupState.selectedPredefinedServices = [];
                vendorSetupState.selectedCities = [];
                
                // Show the setup modal
                vendorRegistrationModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Setup event listeners
                setupVendorSetupEventListeners();
                
                // Show first step
                showSetupStep(1);
            }

            // Setup Event Listeners for All Steps
            function setupVendorSetupEventListeners() {
                // Navigation buttons - Forward
                document.getElementById('next-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('next-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('next-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('next-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('next-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('next-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('next-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('next-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                document.getElementById('next-to-step-10')?.addEventListener('click', () => goToSetupStep(10));
                
                // Navigation buttons - Backward
                document.getElementById('back-to-step-1')?.addEventListener('click', () => goToSetupStep(1));
                document.getElementById('back-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('back-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('back-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('back-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('back-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('back-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('back-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('back-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                
                // Step 3: Gallery & Media functionality
                document.getElementById('featured-image')?.addEventListener('change', handleFeaturedImageUpload);
                document.getElementById('gallery-images')?.addEventListener('change', handleGalleryUpload);
                document.getElementById('add-portfolio-btn')?.addEventListener('click', showPortfolioForm);
                document.getElementById('add-portfolio-item-btn')?.addEventListener('click', addPortfolioItem);
                
                // Step 4: Services & Packages functionality
                document.getElementById('add-service-category-btn')?.addEventListener('click', showServiceCategoryForm);
                document.getElementById('add-category-item-btn')?.addEventListener('click', addServiceCategory);
                document.getElementById('add-service-btn')?.addEventListener('click', showServiceForm);
                document.getElementById('add-service-item-btn')?.addEventListener('click', addServiceItem);
                document.getElementById('add-package-btn')?.addEventListener('click', showPackageForm);
                document.getElementById('add-package-item-btn')?.addEventListener('click', addPackageItem);
                
                // Step 5: Team functionality
                document.getElementById('add-team-member-btn')?.addEventListener('click', showTeamMemberForm);
                document.getElementById('add-team-item-btn')?.addEventListener('click', addTeamMember);
                
                // Step 8: FAQ functionality
                document.getElementById('add-faq-btn')?.addEventListener('click', showFaqForm);
                document.getElementById('add-faq-item-btn')?.addEventListener('click', addFaqItem);
                
                // Complete setup
                document.getElementById('complete-setup-btn')?.addEventListener('click', completeVendorSetup);
            }

            // Navigation Functions
            async function goToSetupStep(step) {
                // Validate current step before proceeding
                if (!validateCurrentStep()) {
                    return;
                }
                
                // Save current step data
                saveCurrentStepData();
                
                // Submit current step data to backend
                try {
                    await submitCurrentStepToBackend();
                } catch (error) {
                    console.error('Failed to save step data:', error);
                    alert('Failed to save step data. Please try again.');
                    return;
                }
                
                // Load category-specific questions when entering step 4
                if (step === 4) {
                    await loadCategoryQuestions();
                }
                
                // Load summary when entering step 9
                if (step === 9) {
                    await loadVendorSummary();
                }
                
                // Update step
                vendorSetupState.currentStep = step;
                showSetupStep(step);
            }

            // Load category-specific questions based on primary category
            async function loadCategoryQuestions() {
                const primaryCategory = document.getElementById('primary-category')?.value;
                if (!primaryCategory) {
                    console.warn('No primary category selected');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/category-questions/${primaryCategory}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load category questions');
                    }

                    const data = await response.json();
                    renderCategoryQuestions(data.questions || []);

                } catch (error) {
                    console.error('Error loading category questions:', error);
                    document.getElementById('category-questions-container').innerHTML = 
                        '<p style="color: var(--accent);">Failed to load questions. Please try again.</p>';
                }
            }

            // Geolocation: try to detect user location and update filters
            async function tryInitGeolocation() {
                if (!('geolocation' in navigator)) return;
                if (state.userLocationInitialized) return;
                state.userLocationInitialized = true;
                // Respect stored permission: skip calling geolocation if denied
                const stored = getStoredGeoPermission();
                if (stored === 'denied') {
                    console.log('Geolocation previously denied; skipping auto request.');
                    return;
                }
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    setStoredGeoPermission('granted');
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    state.userCoords = { lat, lon };
                    // Persist for future sessions
                    try { localStorage.setItem('userCoordsV1', JSON.stringify(state.userCoords)); } catch {}
                    // If map initialized, recenter and refresh markers/list
                    try { if (state.map && state.map.map) setMapToUser(lat, lon); } catch {}
                    try { updateMapMarkers(); } catch {}
                    try {
                        const label = await reverseGeocodeOSM(lat, lon);
                        state.userLocationLabel = label;
                        // If user hasn't manually set a location filter, use detected city/region
                        if (!state.filters || !state.filters.location) {
                            state.filters = state.filters || {};
                            state.filters.location = label;
                            filterVendors();
                            updateMetadata({});
                        }
                    } catch (e) {
                        console.warn('Reverse geocode failed:', e);
                    }
                }, (err) => {
                    console.warn('Geolocation blocked/unavailable:', err?.message || err);
                    if (err && err.code === err.PERMISSION_DENIED) setStoredGeoPermission('denied');
                }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 });
            }

            // Reverse geocode using OpenStreetMap Nominatim (no API key)
            async function reverseGeocodeOSM(lat, lon) {
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
                const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
                if (!res.ok) throw new Error(`OSM reverse geocode failed: ${res.status}`);
                const data = await res.json();
                const city = data.address?.city || data.address?.town || data.address?.village || data.address?.hamlet || '';
                const state = data.address?.state || data.address?.region || data.address?.county || '';
                const label = [city, state].filter(Boolean).join(', ');
                return label || (data.display_name?.split(',').slice(0,2).join(', ') || 'your area');
            }

            // Render category-specific questions
            function renderCategoryQuestions(questions) {
                const container = document.getElementById('category-questions-container');
                if (!container) return;

                if (questions.length === 0) {
                    container.innerHTML = '<p>No additional questions for this category.</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 1rem;">';
                
                questions.forEach((question, index) => {
                    html += `
                        <div class="form-group" style="padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                ${question.QuestionText}
                                ${question.IsRequired ? '<span style="color: var(--accent);">*</span>' : ''}
                            </label>
                    `;

                    if (question.QuestionType === 'YesNo') {
                        html += `
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="Yes" ${question.IsRequired ? 'required' : ''}>
                                    Yes
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="No" ${question.IsRequired ? 'required' : ''}>
                                    No
                                </label>
                            </div>
                        `;
                    } else if (question.QuestionType === 'Text') {
                        html += `
                            <textarea name="question_${question.QuestionID}" rows="3" 
                                     style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                     ${question.IsRequired ? 'required' : ''}></textarea>
                        `;
                    } else if (question.QuestionType === 'Number') {
                        html += `
                            <input type="number" name="question_${question.QuestionID}" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                   ${question.IsRequired ? 'required' : ''}>
                        `;
                    }

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            }

            // Load and display vendor summary
            async function loadVendorSummary() {
                const container = document.getElementById('setup-summary-content');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/summary/${vendorSetupState.vendorProfileId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load vendor summary');
                    }

                    const data = await response.json();
                    renderVendorSummary(data);

                } catch (error) {
                    console.error('Error loading vendor summary:', error);
                    container.innerHTML = '<p style="color: var(--accent);">Failed to load summary. Please try again.</p>';
                }
            }

            // Render comprehensive vendor summary
            function renderVendorSummary(summaryData) {
                const container = document.getElementById('setup-summary-content');
                if (!container || !summaryData.success) return;

                const data = summaryData.data;
                let html = '<div style="display: grid; gap: 1.5rem;">';

                // Business Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                📋 Business Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Business Name:</strong> ${info.BusinessName || 'Not provided'}</div>
                                <div><strong>Display Name:</strong> ${info.DisplayName || 'Not provided'}</div>
                                <div><strong>Email:</strong> ${info.BusinessEmail || 'Not provided'}</div>
                                <div><strong>Phone:</strong> ${info.BusinessPhone || 'Not provided'}</div>
                                <div><strong>Website:</strong> ${info.Website || 'Not provided'}</div>
                                <div><strong>Years in Business:</strong> ${info.YearsInBusiness || 'Not provided'}</div>
                            </div>
                            ${info.BusinessDescription ? `<div style="margin-top: 1rem;"><strong>Description:</strong><br>${info.BusinessDescription}</div>` : ''}
                            ${info.Tagline ? `<div style="margin-top: 0.5rem;"><strong>Tagline:</strong> ${info.Tagline}</div>` : ''}
                        </div>
                    `;
                }

                // Location Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Address:</strong> ${info.Address || 'Not provided'}</div>
                                <div><strong>City:</strong> ${info.City || 'Not provided'}</div>
                                <div><strong>State:</strong> ${info.State || 'Not provided'}</div>
                                <div><strong>Country:</strong> ${info.Country || 'Not provided'}</div>
                                <div><strong>Postal Code:</strong> ${info.PostalCode || 'Not provided'}</div>
                            </div>
                            ${info.AdditionalCitiesServed ? `<div style="margin-top: 1rem;"><strong>Additional Cities/Regions Served:</strong><br>${info.AdditionalCitiesServed}</div>` : ''}
                        </div>
                    `;
                }

                // Categories
                if (data.categories && data.categories.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-tags" style="margin-right: 0.5rem;"></i>Categories
                            </h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.categories.map(cat => `<span style="background-color: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">${cat.Category}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Gallery
                if (data.imageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-images" style="margin-right: 0.5rem;"></i>Gallery
                            </h5>
                            <div><strong>Images Uploaded:</strong> ${data.imageCount} images</div>
                            ${data.basicInfo?.FeaturedImageURL ? '<div style="margin-top: 0.5rem;"><strong>Featured Image:</strong> <i class="fas fa-check" style="color: #28a745;"></i> Set</div>' : ''}
                        </div>
                    `;
                }

                // Services & Packages
                if (data.serviceCount > 0 || data.packageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Services & Packages
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>Services:</strong> ${data.serviceCount || 0} services</div>
                                <div><strong>Packages:</strong> ${data.packageCount || 0} packages</div>
                            </div>
                        </div>
                    `;
                }

                // Social Media
                if (data.socialMedia && data.socialMedia.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🌐 Social Media
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.socialMedia.map(social => `<div><strong>${social.Platform}:</strong> ${social.URL}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Business Hours
                if (data.businessHours && data.businessHours.length > 0) {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🕒 Business Hours
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.businessHours.map(hours => `
                                    <div><strong>${days[hours.DayOfWeek]}:</strong> 
                                    ${hours.IsAvailable ? `${hours.OpenTime} - ${hours.CloseTime}` : 'Closed'}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Additional Details (Category-specific questions)
                if (data.additionalDetails && data.additionalDetails.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Additional Details
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.additionalDetails.map(detail => `<div><strong>${detail.QuestionText}:</strong> ${detail.Answer}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // FAQs
                if (data.faqs && data.faqs.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Frequently Asked Questions
                            </h5>
                            <div style="display: grid; gap: 1rem;">
                                ${data.faqs.map(faq => `
                                    <div style="padding: 1rem; background-color: white; border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Q: ${faq.Question}</div>
                                        <div>A: ${faq.Answer}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            }


            // Chat state manager moved to top of DOMContentLoaded to fix initialization order


            // Global state moved to top of DOMContentLoaded to fix initialization order

            // User state (now global)
            // let currentUser = null; // Moved to global scope

            // State variables for dashboard mode and active section, persisted in localStorage
            let isVendorMode = localStorage.getItem('isVendorMode') === 'true';
            let activeDashboardSection = localStorage.getItem('activeDashboardSection') || 'dashboard';
            // Track last section per mode (backward-compatible with activeDashboardSection)
            let activeClientSection = localStorage.getItem('activeClientSection') || 'dashboard';
            let activeVendorSection = localStorage.getItem('activeVendorSection') || 'vendor-dashboard';
            // Track currently displayed mode to detect mode switches
            let currentDashboardMode = isVendorMode;
            // Unsaved changes guard flag (set true by settings inputs)
            window.dashboardUnsavedWarning = false;

            // Valid sections per mode
            const CLIENT_SECTIONS = new Set(['dashboard','bookings','requests','favorites','messages','reviews','settings']);
            const VENDOR_SECTIONS = new Set(['vendor-dashboard','vendor-requests','vendor-messages','vendor-reviews','vendor-analytics','vendor-settings','vendor-business-profile','vendor-invoices']);

            function persistActiveSection(mode, section) {
                try {
                    localStorage.setItem('activeDashboardSection', section);
                    if (mode === 'vendor') {
                        activeVendorSection = section;
                        localStorage.setItem('activeVendorSection', section);
                    } else {
                        activeClientSection = section;
                        localStorage.setItem('activeClientSection', section);
                    }
                } catch (e) {}
            }

            // Mark unsaved when editing settings
            document.addEventListener('input', (e) => {
                if (e.target.closest('#vendor-settings-section, #settings-section')) {
                    window.dashboardUnsavedWarning = true;
                }
            });

            // Reset unsaved flag on settings form submits
            document.addEventListener('submit', (e) => {
                if (e.target && e.target.closest('#vendor-settings-section, #settings-section')) {
                    window.dashboardUnsavedWarning = false;
                }
            }, true);

            // Warn when leaving the page with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (window.dashboardUnsavedWarning) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Intercept dashboard modal close when there are unsaved settings changes
            document.addEventListener('click', (e) => {
                const closeBtn = e.target.closest('#dashboard-modal .close-modal');
                if (!closeBtn) return;
                if (!window.dashboardUnsavedWarning) return;
                const proceed = confirm('You have unsaved changes in Settings. Close dashboard and discard them?');
                if (!proceed) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                } else {
                    window.dashboardUnsavedWarning = false;
                }
            }, true);

            // Lightbox state
            let lightboxImages = [];
            // openBookingModal function removed - duplicate function, keeping the complete version below

            // Multi-Step Booking Modal State (Global)
            window.bookingState = {
                currentStep: 1,
                selectedServices: [],
                selectedPredefinedServices: [], // New: stores selected predefined services with individual budgets
                availablePredefinedServices: {}, // New: stores predefined services by category
                eventDetails: {},
                budget: 2000,
                availableVendors: [],
                selectedVendors: [],
                sentRequests: [],
                approvedVendors: [],
                totalCost: 0,
                paymentIntent: null,
                countdownTimers: {},
                // Dynamic map properties
                originalVendorSections: [],
                isLoadingVendors: false,
                lastMapBounds: null,
                initialMapBounds: null,
                
                reset: function() {
                    this.currentStep = 1;
                    this.selectedServices = [];
                    this.selectedPredefinedServices = [];
                    this.availablePredefinedServices = {};
                    this.eventDetails = {};
                    this.budget = 2000;
                    this.availableVendors = [];
                    this.selectedVendors = [];
                    this.sentRequests = [];
                    this.approvedVendors = [];
                    this.totalCost = 0;
                    this.paymentIntent = null;
                    this.countdownTimers = {};
                    // Reset dynamic map properties
                    this.originalVendorSections = [];
                    this.isLoadingVendors = false;
                    this.lastMapBounds = null;
                    this.initialMapBounds = null;
                }
            };

            // Inject skeleton styles once for vendor cards
            (function ensureVendorSkeletonStyles() {
                if (document.getElementById('vendor-skeleton-styles')) return;
                const style = document.createElement('style');
                style.id = 'vendor-skeleton-styles';
                style.textContent = `
                    /* Vendor card skeletons - inherit grid layout from .vendor-grid */
                    .vendor-grid.skeleton-active {
                        /* Grid columns defined by main .vendor-grid media queries */
                        display: grid;
                        align-items: stretch;
                    }
                    .skeleton-card {
                        display: flex;
                        flex-direction: column;
                        background: #fff;
                        border: none;
                        border-radius: 16px;
                        box-shadow: none;
                        overflow: hidden;
                    }
                    .skeleton-thumb {
                        width: 100%;
                        aspect-ratio: 4 / 3; /* match .vendor-image */
                        background: var(--skeleton-base, #f0f2f5);
                        position: relative;
                        overflow: hidden;
                    }
                    .skeleton-fav {
                        position: absolute;
                        top: 12px;
                        right: 12px;
                        width: 36px;
                        height: 36px;
                        border-radius: 9999px;
                        background: rgba(255,255,255,0.95);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    }
                    .skeleton-content {
                        display: grid;
                        gap: 10px;
                        padding: 1rem;
                        align-content: start;
                    }
                    .skeleton-line { height: 12px; border-radius: 6px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-line.xs { height: 10px; width: 90px; }
                    .skeleton-line.sm { height: 10px; width: 55%; }
                    .skeleton-line.md { height: 12px; width: 75%; }
                    .skeleton-line.lg { height: 14px; width: 40%; }
                    .skeleton-title { height: 16px; width: 60%; border-radius: 6px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-chip { height: 10px; border-radius: 9999px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-chip.xs { width: 60px; }
                    .skeleton-chip.sm { width: 80px; }
                    .skeleton-chip.md { width: 100px; }
                    .skeleton-dot { width: 6px; height: 6px; border-radius: 9999px; background: var(--skeleton-base, #e5e7eb); }
                    .skeleton-pill { height: 40px; width: 160px; border-radius: 12px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-price { height: 16px; width: 72px; border-radius: 6px; background: #e9f0ff; position: relative; overflow: hidden; }
                    .skeleton-featurebar {
                        margin: 6px 0 6px;
                        height: 44px;
                        border-radius: 8px;
                        background: #f8f9fa;
                        position: relative;
                        overflow: hidden;
                    }
                    .skeleton-featurebar::before { display: none; }
                    .skeleton-button-row { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-top: 8px; }
                    .skeleton-ghost-btn { height: 16px; width: 48px; border-radius: 8px; background: var(--skeleton-base, #f0f2f5); position: relative; overflow: hidden; }
                    .skeleton-primary-btn { height: 36px; width: 80px; border-radius: 12px; background: var(--skeleton-base, #e5e7eb); position: relative; overflow: hidden; }
                    /* Shimmer */
                    .skeleton-thumb::after, .skeleton-line::after, .skeleton-pill::after, .skeleton-price::after, .skeleton-chip::after, .skeleton-ghost-btn::after, .skeleton-primary-btn::after, .skeleton-fav::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.6) 50%, rgba(255,255,255,0) 100%); transform: translateX(-100%); animation: vv-shimmer 1.2s infinite; }
                    @keyframes vv-shimmer { 100% { transform: translateX(100%); } }
                `;
                document.head.appendChild(style);
            })();

            // Show skeletons in the vendor grid while loading
            function showVendorSkeletons(count = 8) {
                const grid = document.getElementById('vendor-grid');
                if (!grid) return;
                grid.classList.add('skeleton-active');
                grid.setAttribute('data-skeleton', '1');
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="skeleton-card" aria-hidden="true">
                            <div class="skeleton-thumb"></div>
                            <div class="skeleton-content">
                                <div style="display:grid; grid-template-columns: 1fr; gap:8px;">
                                    <div class="skeleton-title"></div>
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <div class="skeleton-chip sm"></div>
                                        <div class="skeleton-dot"></div>
                                        <div class="skeleton-chip xs"></div>
                                        <div class="skeleton-dot"></div>
                                        <div class="skeleton-chip xs"></div>
                                    </div>
                                </div>
                                <div class="skeleton-line md"></div>
                                <div class="skeleton-line md" style="width: 65%;"></div>
                                <div class="skeleton-starting-row" style="display:flex; align-items:center; gap:8px;">
                                    <div class="skeleton-line xs" style="width: 110px;"></div>
                                    <div class="skeleton-price"></div>
                                </div>
                                <div class="skeleton-button-row">
                                    <div class="skeleton-ghost-btn"></div>
                                    <div class="skeleton-primary-btn"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                grid.innerHTML = html;
            }

            function hideVendorSkeletons() {
                const grid = document.getElementById('vendor-grid');
                if (!grid) return;
                if (grid.getAttribute('data-skeleton') === '1') {
                    // Do not clear innerHTML here, vendors may have been rendered already
                    grid.removeAttribute('data-skeleton');
                    grid.classList.remove('skeleton-active');
                }
            }

            // Append skeleton placeholders to end of the vendor grid while fetching more
            function appendVendorSkeletons(count = 8) {
                const grid = document.getElementById('vendor-grid');
                if (!grid) return;
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="skeleton-card" data-append-skeleton="1" aria-hidden="true">
                            <div class="skeleton-thumb"></div>
                            <div class="skeleton-content">
                                <div style="display:grid; grid-template-columns: 1fr; gap:8px;">
                                    <div class="skeleton-title"></div>
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <div class="skeleton-chip sm"></div>
                                        <div class="skeleton-dot"></div>
                                        <div class="skeleton-chip xs"></div>
                                        <div class="skeleton-dot"></div>
                                        <div class="skeleton-chip xs"></div>
                                    </div>
                                </div>
                                <div class="skeleton-line md"></div>
                                <div class="skeleton-line md" style="width: 65%;"></div>
                                <div class="skeleton-starting-row" style="display:flex; align-items:center; gap:8px;">
                                    <div class="skeleton-line xs" style="width: 110px;"></div>
                                    <div class="skeleton-price"></div>
                                </div>
                                <div class="skeleton-button-row">
                                    <div class="skeleton-ghost-btn"></div>
                                    <div class="skeleton-primary-btn"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                grid.insertAdjacentHTML('beforeend', html);
            }

            // Check for Stripe Connect redirect parameters
            function checkStripeConnectRedirect() {
                const urlParams = new URLSearchParams(window.location.search);
                const stripeConnect = urlParams.get('stripe_connect');
                const vendor = urlParams.get('vendor');
                const message = urlParams.get('message');
                
                if (stripeConnect === 'success' && vendor) {
                    // Show success message
                    alert(`✅ ${decodeURIComponent(message || 'Successfully connected to Stripe!')}`);
                    
                    // Refresh Stripe status for the vendor
                    if (window.checkVendorStripeStatus) {
                        setTimeout(() => {
                            checkVendorStripeStatus(vendor, false);
                        }, 1000);
                    }
                    
                    // Clean up URL parameters
                    const newUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                    
                } else if (stripeConnect === 'error') {
                    // Show error message
                    alert(`❌ ${decodeURIComponent(message || 'Stripe connection failed. Please try again.')}`);
                    
                    // Clean up URL parameters
                    const newUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
            }
            
            checkStripeConnectRedirect();

            // Initialize the app
            init();

            async function init() {
                // Check for direct URL access immediately
                const pathname = window.location.pathname;
                const pathParts = pathname.split('/');
                const listingIndex = pathParts.findIndex(part => part === 'listings');
                let vendorIdFromPath = null;
                if (listingIndex !== -1 && pathParts[listingIndex + 1]) {
                    vendorIdFromPath = pathParts[listingIndex + 1];
                }
                
                // If a vendor ID is found from a direct path, show the profile page and exit the rest of the init() function
                if (vendorIdFromPath) {
                    console.log('🚀 Direct URL vendor ID found on initial load:', vendorIdFromPath);
                    await showVendorProfilePage(vendorIdFromPath);
                    // Keep the original URL format - don't add hash
                    return; // Important: Exit here to prevent loading the main app view.
                }
                
                // If no vendor ID from path, proceed with normal initialization.
                console.log('🚀 No direct URL vendor ID found, proceeding with normal initialization.');
                
                // Load categories first
                await loadCategories();

                // Check for existing user session
                await checkAuthStatus();
                
                // Initialize geolocation permission observer (keeps localStorage in sync)
                initGeoPermissionObserver();
                
                // Handle initial page load based on URL or state
                setTimeout(() => {
                    handleUrlChange();
                }, 100);

                // Apply saved sidebar state and wire toggle
                try {
                    const savedCollapsed = localStorage.getItem('filtersCollapsed') === '1';
                    applySidebarState(savedCollapsed);
                } catch (e) {}
                if (filtersToggleBtn) {
                    filtersToggleBtn.addEventListener('click', () => {
                        const willCollapse = !appContainer.classList.contains('sidebar-collapsed');
                        applySidebarState(willCollapse);
                    });
                }

                // Show skeleton loader while vendors load
                showSidebarSkeletonLoader?.();
                showVendorSkeletons(8);

                try {
                    // Sync category from URL, then load vendors
                    try { initCategoryFromUrl(); } catch {}
                    await loadVendors();

                    // Hide skeletons once loaded
                    hideSidebarSkeletonLoader?.();
                    hideVendorSkeletons();

                    // Initialize Stripe
                    initializeStripe();

                    // Connect to Socket.IO
                    connectToChat();

                    // Request location after everything is loaded
                    requestLocationWithFeedback();

                    // Setup event listeners
                    setupEventListeners();

                    // Show main app since we're not loading a direct vendor URL
                    mainAppView.style.display = 'grid';
                    clientDashboardContainer.style.display = 'none';
                    // vendor container removed (unified dashboard)

                    // Setup lightbox event listeners
                    setupLightboxEventListeners();

                    // Setup booking modal event listeners
                    setupBookingModalEventListeners();

                    // Show vendor setup reminder if applicable
                    try { await renderVendorSetupReminder(); } catch (e) {}

                } catch (error) {
                    console.error('Initialization error:', error);
                    showError("Failed to load vendors. Please try again later.");
                }
            }

            // Multi-Step Booking Modal Functions
            async function openBookingModal() {
                const bookingModal = document.getElementById('booking-modal');
                window.bookingState.reset();
                // Clear any prior errors before showing modal
                try { if (typeof clearBookingError === 'function') clearBookingError(); } catch {}
                try { if (typeof clearModalError === 'function') clearModalError(bookingModal); } catch {}
                updateBookingStep(1);
                bookingModal.style.display = 'flex';
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('event-date').min = today;
                
                // Load service categories
                await loadServiceCategories();
            }

            // Service Categories Loading Functions
            async function loadServiceCategories() {
                try {
                    console.log('Loading service categories...');
                    const response = await fetch(`${API_BASE_URL}/bookings/service-categories`);
                    const data = await response.json();
                    
                    console.log('Service categories response:', data);
                    
                    if (data.success && data.categories) {
                        window.bookingState.serviceCategories = data.categories;
                        renderServiceCategories();
                    } else {
                        console.warn('No categories found, using fallback');
                        renderDefaultServiceCategories();
                    }
                } catch (error) {
                    console.error('Error loading service categories:', error);
                    // Fallback to default categories if API fails
                    renderDefaultServiceCategories();
                }
            }

            function renderServiceCategories() {
                const categoriesContainer = document.getElementById('service-categories');
                if (!categoriesContainer) {
                    console.error('Service categories container not found');
                    return;
                }

                const categoriesHtml = bookingState.serviceCategories.map(category => `
                    <div class="category-card" data-category-id="${category.id}">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <div class="category-info">
                            <h5>${category.name}</h5>
                            <p>${category.serviceCount} services available</p>
                        </div>
                        <div class="category-checkbox">
                            <input type="checkbox" id="cat-${category.id}" />
                            <span class="checkmark"></span>
                        </div>
                    </div>
                `).join('');

                categoriesContainer.innerHTML = categoriesHtml;
                
                // Add click event listeners to category cards
                categoriesContainer.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const categoryId = card.getAttribute('data-category-id');
                        const category = bookingState.serviceCategories.find(c => c.id == categoryId);
                        if (category) {
                            toggleCategorySelection(categoryId, category.key);
                        }
                    });
                });
            }

            function renderDefaultServiceCategories() {
                const categoriesContainer = document.getElementById('service-categories');
                if (!categoriesContainer) {
                    console.error('Service categories container not found');
                    return;
                }

                const defaultCategories = [
                    { id: 1, key: 'venue', name: 'Venues', icon: 'fas fa-building' },
                    { id: 2, key: 'photo', name: 'Photo/Video', icon: 'fas fa-camera' },
                    { id: 3, key: 'music', name: 'Music/DJ', icon: 'fas fa-music' },
                    { id: 4, key: 'catering', name: 'Catering', icon: 'fas fa-utensils' },
                    { id: 5, key: 'entertainment', name: 'Entertainment', icon: 'fas fa-theater-masks' },
                    { id: 6, key: 'experiences', name: 'Experiences', icon: 'fas fa-star' },
                    { id: 7, key: 'decor', name: 'Decorations', icon: 'fas fa-ribbon' },
                    { id: 8, key: 'beauty', name: 'Beauty', icon: 'fas fa-spa' },
                    { id: 9, key: 'cake', name: 'Cake', icon: 'fas fa-birthday-cake' },
                    { id: 10, key: 'transport', name: 'Transportation', icon: 'fas fa-shuttle-van' },
                    { id: 11, key: 'planner', name: 'Planners', icon: 'fas fa-clipboard-list' },
                    { id: 12, key: 'fashion', name: 'Fashion', icon: 'fas fa-tshirt' },
                    { id: 13, key: 'stationery', name: 'Stationery', icon: 'fas fa-envelope' }
                ];

                const categoriesHtml = defaultCategories.map(category => `
                    <div class="category-card" data-category-id="${category.id}" data-category-key="${category.key}">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <div class="category-info">
                            <h5>${category.name}</h5>
                            <p>Multiple services available</p>
                        </div>
                        <div class="category-checkbox">
                            <input type="checkbox" id="cat-${category.id}" />
                            <span class="checkmark"></span>
                        </div>
                    </div>
                `).join('');

                categoriesContainer.innerHTML = categoriesHtml;
                
                // Add click event listeners to default category cards
                categoriesContainer.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const categoryId = card.getAttribute('data-category-id');
                        const categoryKey = card.getAttribute('data-category-key');
                        toggleCategorySelection(categoryId, categoryKey);
                    });
                });
            }

            async function toggleCategorySelection(categoryId, categoryKey) {
                const categoryCard = document.querySelector(`[data-category-id="${categoryId}"]`);
                const checkbox = categoryCard.querySelector('input[type="checkbox"]');
                
                if (checkbox.checked) {
                    // Unselect category
                    checkbox.checked = false;
                    categoryCard.classList.remove('selected');
                    
                    // Remove all services from this category
                    window.bookingState.selectedServices = bookingState.selectedServices.filter(s => s.categoryId !== parseInt(categoryId));
                } else {
                    // Select category and load its services
                    checkbox.checked = true;
                    categoryCard.classList.add('selected');
                    
                    await loadCategoryServices(categoryId, categoryKey);
                }
                
                updateBudgetRange();
                updateNextStepButton();
            }

            function updateBudgetRange() {
                // Update budget range based on selected services
                const totalServices = bookingState.selectedServices.length;
                if (totalServices > 0) {
                    // Adjust minimum budget based on number of services
                    const minBudget = Math.max(500, totalServices * 200);
                    const budgetSlider = document.getElementById('budget-slider');
                    const budgetInput = document.getElementById('budget-input');
                    
                    if (budgetSlider && budgetInput) {
                        budgetSlider.min = minBudget;
                        if (parseInt(budgetSlider.value) < minBudget) {
                            budgetSlider.value = minBudget;
                            window.bookingState.budget = minBudget;
                        }
                    }
                    
                    if (budgetInput) {
                        budgetInput.min = minBudget;
                        if (parseInt(budgetInput.value) < minBudget) {
                            budgetInput.value = minBudget;
                            window.bookingState.budget = minBudget;
                        }
                    }
                    
                    // Update budget display
                    const budgetDisplay = document.getElementById('budget-display');
                    if (budgetDisplay) {
                        budgetDisplay.textContent = bookingState.budget;
                    }
                }
            }
            
            function updateNextStepButton() {
                const nextButton = document.getElementById('next-to-booking-step-2');
                if (nextButton) {
                    nextButton.disabled = bookingState.selectedServices.length === 0;
                }
            }

            async function loadCategoryServices(categoryId, categoryKey) {
                try {
                    const response = await fetch(`${API_BASE_URL}/bookings/services/${categoryId}`);
                    const data = await response.json();
                    
                    if (data.success && data.services) {
                        // Add services from this category to selected services
                        data.services.forEach(service => {
                            const existingIndex = bookingState.selectedServices.findIndex(s => s.id === service.ServiceID);
                            if (existingIndex === -1) {
                                window.bookingState.selectedServices.push({
                                    id: service.ServiceID,
                                    categoryId: parseInt(categoryId),
                                    categoryKey: categoryKey,
                                    type: service.Name,
                                    description: service.Description,
                                    basePrice: service.BasePrice || 0,
                                    priceUnit: service.PriceUnit || 'fixed',
                                    priceRange: estimatePriceRange(service.BasePrice, categoryKey)
                                });
                            }
                        });
                    } else {
                        // Fallback to default service for category
                        addDefaultCategoryService(categoryId, categoryKey);
                    }
                } catch (error) {
                    console.error('Error loading category services:', error);
                    // Fallback to default service for category
                    addDefaultCategoryService(categoryId, categoryKey);
                }
            }

            function addDefaultCategoryService(categoryId, categoryKey) {
                const defaultServices = {
                    'photo': { name: 'Photography & Videography', priceRange: { min: 800, max: 3000 } },
                    'music': { name: 'DJ & Music Services', priceRange: { min: 400, max: 1500 } },
                    'catering': { name: 'Catering Services', priceRange: { min: 25, max: 150 } },
                    'venue': { name: 'Venue Rental', priceRange: { min: 500, max: 5000 } },
                    'decor': { name: 'Decorations & Flowers', priceRange: { min: 200, max: 1500 } },
                    'beauty': { name: 'Beauty & Styling', priceRange: { min: 100, max: 800 } }
                };

                const serviceInfo = defaultServices[categoryKey] || { name: 'Service', priceRange: { min: 100, max: 1000 } };
                
                window.bookingState.selectedServices.push({
                    id: `default-${categoryId}`,
                    categoryId: parseInt(categoryId),
                    categoryKey: categoryKey,
                    type: serviceInfo.name,
                    priceRange: serviceInfo.priceRange
                });
            }

            function estimatePriceRange(basePrice, categoryKey) {
                if (basePrice && basePrice > 0) {
                    return { min: basePrice, max: basePrice * 2 };
                }

                // Default price ranges by category
                const defaultRanges = {
                    'photo': { min: 800, max: 3000 },
                    'music': { min: 400, max: 1500 },
                    'catering': { min: 25, max: 150 },
                    'venue': { min: 500, max: 5000 },
                    'decor': { min: 200, max: 1500 },
                    'beauty': { min: 100, max: 800 }
                };

                return defaultRanges[categoryKey] || { min: 100, max: 1000 };
            }

            function closeBookingModal() {
                const bookingModal = document.getElementById('booking-modal');
                bookingModal.style.display = 'none';
                window.bookingState.reset();
                
                // Clear any countdown timers
                Object.values(bookingState.countdownTimers).forEach(timer => clearInterval(timer));

                // Clear any modal-scoped errors
                try { if (typeof clearBookingError === 'function') clearBookingError(); } catch {}
                try { if (typeof clearModalError === 'function') clearModalError(bookingModal); } catch {}
            }

            function ensureBookingAnimationsCSS() {
                if (document.getElementById('booking-anim-css')) return;
                const style = document.createElement('style');
                style.id = 'booking-anim-css';
                style.textContent = `
                /* Global loading overlay */
                #booking-loading-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); z-index: 9999; }
                #booking-loading-overlay.dark { background: rgba(0,0,0,0.35); }
                .vv-spinner { width: 52px; height: 52px; border: 4px solid rgba(0,0,0,0.06); border-top-color: var(--primary-color, #5e72e4); border-radius: 50%; animation: vv-spin 900ms linear infinite; }
                .vv-spinner-text { margin-top: 12px; color: var(--primary-color, #5e72e4); font-weight: 600; font-size: 0.95rem; text-align: center; }
                @keyframes vv-spin { to { transform: rotate(360deg); } }
                `;
                document.head.appendChild(style);
            }

            // Global loading overlay utilities
            function ensureBookingLoadingUI() {
                ensureBookingAnimationsCSS();
                let overlay = document.getElementById('booking-loading-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'booking-loading-overlay';
                    overlay.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                            <div class="vv-spinner"></div>
                            <div id="booking-loading-text" class="vv-spinner-text">Loading...</div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }
                return overlay;
            }
            function showBookingLoading(message = 'Loading...') {
                const overlay = ensureBookingLoadingUI();
                const txt = document.getElementById('booking-loading-text');
                if (txt) txt.textContent = message;
                overlay.style.display = 'flex';
            }
            function hideBookingLoading() {
                const overlay = document.getElementById('booking-loading-overlay');
                if (overlay) overlay.style.display = 'none';
            }

            // Utility: Haversine distance in kilometers
            function haversineKm(lat1, lon1, lat2, lon2) {
                const toRad = (v) => (v * Math.PI) / 180;
                const R = 6371; // km
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function updateBookingStep(step) {
                ensureBookingAnimationsCSS();
                // Clear any existing booking/modal error when changing steps
                try { if (typeof clearBookingError === 'function') clearBookingError(); } catch {}
                try { const m = document.getElementById('booking-modal'); if (typeof clearModalError === 'function' && m) clearModalError(m); } catch {}
                // Simple, stable show/hide to avoid layout jumps
                for (let i = 1; i <= 5; i++) {
                    const stepElement = document.getElementById(`booking-step-${i}`);
                    const indicatorElement = document.getElementById(`booking-step-indicator-${i}`);
                    if (stepElement) stepElement.style.display = i === step ? 'block' : 'none';
                    if (indicatorElement) {
                        indicatorElement.classList.remove('active', 'completed');
                        if (i === step) {
                            indicatorElement.classList.add('active');
                        } else if (i < step) {
                            indicatorElement.classList.add('completed');
                        }
                    }
                }
                // Progress
                const progressFill = document.getElementById('booking-progress-fill');
                if (progressFill) {
                    const progressPercentage = (step / 5) * 100;
                    progressFill.style.width = `${progressPercentage}%`;
                }
                // Title
                const modalTitle = document.getElementById('booking-modal-title');
                const stepTitles = { 1: 'Select Categories', 2: 'Event Details', 3: 'Select Services', 4: 'Available Vendors', 5: 'Booking Requests' };
                if (modalTitle) modalTitle.innerHTML = `<span class="step-number-badge">${step}</span>Step ${step} of 5: ${stepTitles[step] || 'Book Your Event'}`;
                // State
                window.bookingState.currentStep = step;
                if (step === 4) updateSearchCriteriaSummary();
                if (step === 2 || step === 3) setTimeout(drawTimeline, 0);
                const mc = document.querySelector('#booking-modal .modal-content');
                if (mc) { try { mc.scrollTo({ top: 0, behavior: 'smooth' }); } catch { mc.scrollTop = 0; } }
            }

            // Function to update search criteria summary
            function updateSearchCriteriaSummary() {
                const summaryContainer = document.getElementById('search-criteria-summary');
                const criteriaDetails = document.getElementById('criteria-details');
                if (!summaryContainer || !criteriaDetails) return;

                // Prefer Step 2 selected predefined services; fallback to Step 1 categories
                const selectedPredefined = window.bookingState?.selectedPredefinedServices || [];
                const selectedStep1 = window.bookingState?.selectedServices || [];
                let servicesText = 'Not specified';
                if (Array.isArray(selectedPredefined) && selectedPredefined.length > 0) {
                    servicesText = selectedPredefined.map(s => s.name).filter(Boolean).join(', ');
                } else if (Array.isArray(selectedStep1) && selectedStep1.length > 0) {
                    servicesText = selectedStep1.map(s => {
                        const t = (s && s.type) ? String(s.type) : '';
                        return t.charAt(0).toUpperCase() + t.slice(1);
                    }).filter(Boolean).join(', ');
                }

                // Event fields from Step 2 inputs
                const locationInput = document.getElementById('event-location');
                const eventLocation = (locationInput?.value && locationInput.value.trim()) ? locationInput.value.trim() : 'Not specified';
                const eventDate = document.getElementById('event-date')?.value || 'Not specified';
                const eventName = (document.getElementById('event-name')?.value || '').trim() || 'Not specified';
                const eventType = document.getElementById('event-type')?.value || 'Not specified';
                const startTime = document.getElementById('event-start-time')?.value || '';
                const endTime = document.getElementById('event-end-time')?.value || '';
                const timeText = (startTime && endTime) ? `${startTime} - ${endTime}` : (startTime || endTime || 'Not specified');

                // Budget from global bookingState (total event budget)
                const totalBudgetVal = window.bookingState?.budget;
                const budgetText = (typeof totalBudgetVal === 'number' && !isNaN(totalBudgetVal) && totalBudgetVal > 0)
                    ? `$${Number(totalBudgetVal).toLocaleString()}`
                    : 'Not specified';

                // Build criteria HTML (Guests removed)
                const criteriaHtml = `
                    <div style="color: var(--text);">
                        <strong>Services:</strong> ${servicesText}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Event Name:</strong> ${eventName}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Event Type:</strong> ${eventType}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Location:</strong> ${eventLocation}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Date:</strong> ${eventDate}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Time:</strong> ${timeText}
                    </div>
                    <div style="color: var(--text);">
                        <strong>Total Budget:</strong> ${budgetText}
                    </div>
                `;

                criteriaDetails.innerHTML = criteriaHtml;
                summaryContainer.style.display = 'block';
            }

            function setupBookingModalEventListeners() {
                // Service selection checkboxes
                const serviceCheckboxes = document.querySelectorAll('#service-categories input[type="checkbox"]');
                serviceCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', handleServiceSelection);
                });

                // Budget slider and input
                const budgetSlider = document.getElementById('budget-slider');
                const budgetInput = document.getElementById('budget-input');
                const budgetDisplay = document.getElementById('budget-display');

                if (budgetSlider && budgetInput && budgetDisplay) {
                    budgetSlider.addEventListener('input', (e) => {
                        const value = e.target.value;
                        budgetInput.value = value;
                        budgetDisplay.textContent = parseInt(value).toLocaleString();
                        window.bookingState.budget = parseInt(value);
                    });

                    budgetInput.addEventListener('input', (e) => {
                        const value = Math.max(500, Math.min(50000, parseInt(e.target.value) || 500));
                        budgetSlider.value = Math.min(20000, value);
                        budgetDisplay.textContent = value.toLocaleString();
                        window.bookingState.budget = value;
                    });
                }

                // Navigation buttons
                document.getElementById('next-to-booking-step-2')?.addEventListener('click', async () => {
                    if (validateStep1()) {
                        updateBookingStep(2);
                        // initialize date picker and timeline if needed
                        setTimeout(() => { initEventDatePicker(); drawTimeline(); }, 0);
                    }
                });

                // New: Step 2 -> Step 3
                document.getElementById('next-to-booking-step-3')?.addEventListener('click', async () => {
                    if (!validateStep2()) {
                        showError('Please fill in all required event details.');
                        return;
                    }
                    updateBookingStep(3);
                    await loadPredefinedServicesForStep2();
                    setTimeout(drawTimeline, 0);
                });

                document.getElementById('back-to-booking-step-1')?.addEventListener('click', () => updateBookingStep(1));
                document.getElementById('find-vendors-btn')?.addEventListener('click', handleFindVendors);
                document.getElementById('back-to-booking-step-2')?.addEventListener('click', () => updateBookingStep(2));
                document.getElementById('send-requests-btn')?.addEventListener('click', () => {
                    updateSelectedVendorsSummary();
                    updateBookingStep(5);
                });
                document.getElementById('back-to-booking-step-3')?.addEventListener('click', () => updateBookingStep(3));
                document.getElementById('back-to-booking-step-4')?.addEventListener('click', () => updateBookingStep(4));

                // Adjust criteria button (existing)
                document.getElementById('adjust-criteria-btn')?.addEventListener('click', () => updateBookingStep(2));
                
                // New adjust filters button in search criteria summary
                document.getElementById('adjust-filters-btn')?.addEventListener('click', () => updateBookingStep(2));

                // Modal close functionality
                document.querySelector('#booking-modal .close-modal')?.addEventListener('click', closeBookingModal);
                document.getElementById('booking-modal')?.addEventListener('click', (e) => {
                    if (e.target.id === 'booking-modal') return;
                });

                // Notification tabs
                document.querySelectorAll('.notification-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.notification-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        const isUnreadOnly = e.target.dataset.tab === 'unread';
                        loadNotifications(isUnreadOnly);
                    });
                });

                // Dashboard notification buttons
                document.getElementById('dashboard-notifications-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNotificationsDropdown(e.target);
                });
                document.getElementById('vendor-notifications-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNotificationsDropdown(e.target);
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('notifications-dropdown');
                    const isClickInsideDropdown = dropdown.contains(e.target);
                    const isNotificationButton = e.target.closest('[id$="-notifications-btn"]');
                    
                    if (!isClickInsideDropdown && !isNotificationButton && dropdown.style.display === 'block') {
                        hideNotificationsDropdown();
                    }
                });
            }

            function handleServiceSelection() {
                const selectedCheckboxes = document.querySelectorAll('#service-categories input[type="checkbox"]:checked');
                window.bookingState.selectedServices = Array.from(selectedCheckboxes).map(cb => ({
                    type: cb.value,
                    minPrice: parseInt(cb.dataset.minPrice),
                    maxPrice: parseInt(cb.dataset.maxPrice)
                }));

                // Update budget range based on selected services
                if (bookingState.selectedServices.length > 0) {
                    const totalMinPrice = bookingState.selectedServices.reduce((sum, service) => sum + service.minPrice, 0);
                    const totalMaxPrice = bookingState.selectedServices.reduce((sum, service) => sum + service.maxPrice, 0);
                    
                    const budgetSlider = document.getElementById('budget-slider');
                    const budgetInput = document.getElementById('budget-input');
                    
                    if (budgetSlider && budgetInput) {
                        budgetSlider.min = totalMinPrice;
                        budgetSlider.max = Math.max(totalMaxPrice, 20000);
                        budgetInput.min = totalMinPrice;
                        
                        // Adjust current budget if it's below minimum
                        if (bookingState.budget < totalMinPrice) {
                            window.bookingState.budget = totalMinPrice;
                            budgetSlider.value = totalMinPrice;
                            budgetInput.value = totalMinPrice;
                            document.getElementById('budget-display').textContent = totalMinPrice.toLocaleString();
                        }
                    }
                    
                    // Update budget display
                    const budgetDisplay = document.getElementById('budget-display');
                    if (budgetDisplay) {
                        budgetDisplay.textContent = bookingState.budget;
                    }
                }

                // Enable/disable next button
                const nextButton = document.getElementById('next-to-booking-step-2');
                if (nextButton) {
                    nextButton.disabled = bookingState.selectedServices.length === 0;
                }
            }

            function validateStep1() {
                return bookingState.selectedServices.length > 0;
            }

            // Load predefined services for Step 2 based on selected categories from Step 1
            async function loadPredefinedServicesForStep2() {
                const loadingDiv = document.getElementById('predefined-services-loading');
                const containerDiv = document.getElementById('booking-predefined-services-container');
                const noServicesDiv = document.getElementById('no-services-message');
                
                // Show loading
                loadingDiv.style.display = 'block';
                containerDiv.style.display = 'none';
                noServicesDiv.style.display = 'none';
                
                try {
                    // Get selected categories from Step 1
                    const selectedCategories = bookingState.selectedServices.map(service => service.categoryKey);
                    
                    if (selectedCategories.length === 0) {
                        throw new Error('No categories selected');
                    }
                    
                    // Fetch predefined services for selected categories
                    console.log('Fetching from:', `${API_BASE_URL}/vendors/predefined-services`);
                    const response = await fetch(`${API_BASE_URL}/vendors/predefined-services`);
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    const data = await response.json();
                    
                    console.log('Predefined services API response:', data);
                    console.log('Selected categories:', selectedCategories);
                    console.log('API servicesByCategory keys:', data.servicesByCategory ? Object.keys(data.servicesByCategory) : 'No servicesByCategory');
                    console.log('Full API response structure:', JSON.stringify(data, null, 2));
                    
                    if (data.success && data.servicesByCategory) {
                        // Map frontend category keys to database categories
                        const categoryMapping = {
                            'photo': 'Photography',
                            'music': 'Music & Entertainment',
                            'catering': 'Catering',
                            'venue': 'Venue',
                            'planning': 'Event Planning',
                            'beauty': 'Beauty & Styling',
                            'transport': 'Transportation',
                            'floral': 'Floral & Decor',
                            'wedding': 'Wedding'
                        };
                        
                        // Filter services by selected categories using mapping
                        const filteredServices = {};
                        selectedCategories.forEach(categoryKey => {
                            const dbCategory = categoryMapping[categoryKey] || categoryKey;
                            console.log(`Looking for category: ${categoryKey} -> ${dbCategory}`);
                            
                            if (data.servicesByCategory[dbCategory]) {
                                filteredServices[categoryKey] = data.servicesByCategory[dbCategory];
                                console.log(`Found services for ${categoryKey}:`, data.servicesByCategory[dbCategory]);
                            } else {
                                console.log(`No services found for category: ${categoryKey} (${dbCategory})`);
                                console.log('Available categories:', Object.keys(data.servicesByCategory));
                            }
                        });
                        
                        console.log('Filtered services:', filteredServices);
                        
                        // If no services found, use mock data for testing
                        if (Object.keys(filteredServices).length === 0) {
                            console.log('No matching services found, using mock data for testing...');
                            const mockServices = {};
                            selectedCategories.forEach(categoryKey => {
                                mockServices[categoryKey] = [
                                    {
                                        id: Math.floor(Math.random() * 1000),
                                        name: `${categoryKey} Service 1`,
                                        description: `Professional ${categoryKey} service for your event`,
                                    },
                                    {
                                        id: Math.floor(Math.random() * 1000) + 1000,
                                        name: `${categoryKey} Service 2`,
                                        description: `Premium ${categoryKey} service with additional features`,
                                    }
                                ];
                            });
                            window.bookingState.availablePredefinedServices = mockServices;
                            renderPredefinedServices(mockServices);
                        } else {
                            window.bookingState.availablePredefinedServices = filteredServices;
                            renderPredefinedServices(filteredServices);
                        }
                    } else {
                        console.error('API response error:', data);
                        console.log('Using mock data due to API error...');
                        
                        // Use mock data when API fails
                        const mockServices = {};
                        selectedCategories.forEach(categoryKey => {
                            mockServices[categoryKey] = [
                                {
                                    id: Math.floor(Math.random() * 1000),
                                    name: `${categoryKey} Service 1`,
                                    description: `Professional ${categoryKey} service for your event`,
                                    defaultDuration: 60
                                },
                                {
                                    id: Math.floor(Math.random() * 1000) + 1000,
                                    name: `${categoryKey} Service 2`,
                                    description: `Premium ${categoryKey} service with additional features`,
                                    defaultDuration: 90
                                }
                            ];
                        });
                        window.bookingState.availablePredefinedServices = mockServices;
                        renderPredefinedServices(mockServices);
                    }
                } catch (error) {
                    console.error('Error loading predefined services:', error);
                    loadingDiv.style.display = 'none';
                    noServicesDiv.style.display = 'block';
                }
            }

            // Render predefined services with individual budget allocation
            function renderPredefinedServices(servicesByCategory) {
                console.log('renderPredefinedServices called with:', servicesByCategory);
                
                const loadingDiv = document.getElementById('predefined-services-loading');
                const containerDiv = document.getElementById('booking-predefined-services-container');
                const noServicesDiv = document.getElementById('no-services-message');
                
                console.log('DOM elements found:', {
                    loadingDiv: !!loadingDiv,
                    containerDiv: !!containerDiv,
                    noServicesDiv: !!noServicesDiv
                });
                
                loadingDiv.style.display = 'none';
                
                if (Object.keys(servicesByCategory).length === 0) {
                    console.log('No services to display, showing no services message');
                    noServicesDiv.style.display = 'block';
                    return;
                }
                
                console.log('Processing services for dropdown display...');
                
                const dropdownsContainer = document.getElementById('service-selection-dropdowns');
                const selectedServicesContainer = document.getElementById('selected-services-list-container');
                
                let dropdownsHtml = '';
                
                Object.entries(servicesByCategory).forEach(([category, services]) => {
                    dropdownsHtml += `
                        <div class="service-category-dropdown" style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); text-transform: capitalize;">
                                ${category} Services
                            </label>
                            <select class="service-dropdown" data-category="${category}" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; background: var(--card-bg); color: var(--text); transition: border-color 0.3s ease;">
                                <option value="" data-placeholder="Select a ${category} service...">
                                    Select a ${category} service...
                                </option>
                    `;
                    
                    services.forEach(service => {
                        dropdownsHtml += `<option value="${service.id}" data-name="${service.name}" data-description="${service.description || ''}">
                            ${service.name}${service.description ? ' - ' + service.description.substring(0, 50) + '...' : ''}
                        </option>`;
                    });
                    
                    dropdownsHtml += `
                            </select>
                        </div>
                    `;
                });
                
                console.log('Generated dropdown HTML:', dropdownsHtml);
                dropdownsContainer.innerHTML = dropdownsHtml;
                
                // Initialize selected services container with a live count badge
                selectedServicesContainer.innerHTML = `
                    <div id="selected-services-display" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h6 style="color: var(--primary-color); margin: 0;">Selected Services & Budgets</h6>
                            <span id="booking-selected-services-count" style="font-size: 0.85rem; color: var(--text-light); background: #eef2ff; padding: 0.25rem 0.5rem; border-radius: 999px;">
                                0 selected
                            </span>
                        </div>
                        <div id="selected-services-items"></div>
                    </div>
                `;
                
                containerDiv.style.display = 'block';
                containerDiv.style.visibility = 'visible';
                containerDiv.style.opacity = '1';
                
                console.log('Dropdown container display set to block');
                console.log('Container computed styles:', {
                    display: window.getComputedStyle(containerDiv).display,
                    visibility: window.getComputedStyle(containerDiv).visibility,
                    opacity: window.getComputedStyle(containerDiv).opacity,
                    height: window.getComputedStyle(containerDiv).height,
                    position: window.getComputedStyle(containerDiv).position,
                    zIndex: window.getComputedStyle(containerDiv).zIndex
                });
                
                // Force show the container with important styles
                containerDiv.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;');
                
                // Trace through all parent elements to find what's hiding the content
                let currentElement = containerDiv;
                let level = 0;
                while (currentElement && level < 10) {
                    const styles = window.getComputedStyle(currentElement);
                    console.log(`Element level ${level}:`, {
                        tagName: currentElement.tagName,
                        id: currentElement.id,
                        className: currentElement.className,
                        display: styles.display,
                        visibility: styles.visibility,
                        opacity: styles.opacity,
                        height: styles.height,
                        overflow: styles.overflow
                    });
                    
                    // Force visibility on any hidden parent
                    if (styles.display === 'none' || styles.visibility === 'hidden' || styles.opacity === '0') {
                        console.log(`Forcing visibility on level ${level} element:`, currentElement.tagName, currentElement.id);
                        currentElement.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important;');
                    }
                    
                    currentElement = currentElement.parentElement;
                    level++;
                }
                
                // Also force the Step 2 section to be visible
                const step2Section = document.getElementById('step-2');
                if (step2Section) {
                    console.log('Step 2 section styles:', {
                        display: window.getComputedStyle(step2Section).display,
                        visibility: window.getComputedStyle(step2Section).visibility,
                        opacity: window.getComputedStyle(step2Section).opacity
                    });
                    step2Section.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                }
                
                // Remove debugging styles and apply proper styling
                containerDiv.style.border = '';
                containerDiv.style.backgroundColor = '';
                containerDiv.style.padding = '';
                containerDiv.style.margin = '';
                
                console.log('Container styling cleaned up');
                
                // Add event listeners for dropdown selection
                addDropdownEventListeners();

                // Update dropdown placeholders with current selection counts
                updateDropdownCounts();
            }

            // Create individual predefined service card with budget input
            function createPredefinedServiceCard(service, category) {
                const isSelected = bookingState.selectedPredefinedServices.some(s => s.id === service.id);
                const selectedService = bookingState.selectedPredefinedServices.find(s => s.id === service.id);
                const budget = selectedService ? selectedService.budget : 100;
                
                return `
                    <div class="predefined-service-card ${isSelected ? 'selected' : ''}" data-service-id="${service.id}" data-category="${category}">
                        <div class="service-card-header">
                            <div class="service-card-title">${service.name}</div>
                            <div class="service-card-check">
                                ${isSelected ? '<i class="fas fa-check" style="color: #28a745;"></i>' : ''}
                            </div>
                        </div>
                        
                        <div class="service-card-description">
                            ${service.description || 'Professional service for your event'}
                        </div>
                        
                        <div class="service-budget-form" style="display: ${isSelected ? 'block' : 'none'}; margin-top: 1rem; padding: 1rem; background: #f8faff; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">Your Budget for this Service</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-light);">$</span>
                                <input type="number" class="service-budget-input" min="1" max="10000" value="${budget}" 
                                       style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; background: var(--card-bg); color: var(--text);">
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-light);">
                                Set your budget for this specific service
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add event listeners for dropdown service selection
            function addDropdownEventListeners() {
                document.querySelectorAll('.service-dropdown').forEach(dropdown => {
                    dropdown.addEventListener('change', (e) => {
                        const serviceId = parseInt(e.target.value);
                        const category = e.target.dataset.category;
                        const selectedOption = e.target.selectedOptions[0];
                        
                        if (serviceId && selectedOption) {
                            const serviceName = selectedOption.dataset.name;
                            const serviceDescription = selectedOption.dataset.description;
                            const serviceDuration = parseInt(selectedOption.dataset.duration) || 60;
                            
                            addServiceFromDropdown(serviceId, serviceName, serviceDescription, category, serviceDuration);
                            
                            // Reset dropdown to default
                            e.target.value = '';
                        }
                    });
                });
            }

            // Add service from dropdown selection
            function addServiceFromDropdown(serviceId, serviceName, serviceDescription, category, duration) {
                // Check if service is already selected
                const existingService = bookingState.selectedPredefinedServices.find(s => s.id === serviceId);
                if (existingService) {
                    showError('This service is already selected.');
                    return;
                }
                
                // Add to selected services with default budget
                const newService = {
                    id: serviceId,
                    name: serviceName,
                    description: serviceDescription,
                    category: category,
                    budget: 100, // Default budget
                    duration: Math.max(15, Math.min(480, parseInt(duration) || 60)),
                    startTime: '',
                    endTime: ''
                };
                
                window.bookingState.selectedPredefinedServices.push(newService);
                renderSelectedServices();
                updateFindVendorsButton();
                updateDropdownCounts();
                drawTimeline();
            }

            // Render selected services with budget inputs
            function renderSelectedServices() {
                const selectedServicesDisplay = document.getElementById('selected-services-display');
                const selectedServicesItems = document.getElementById('selected-services-items');
                const selectedServicesCount = document.getElementById('booking-selected-services-count');
                
                if (bookingState.selectedPredefinedServices.length === 0) {
                    selectedServicesDisplay.style.display = 'none';
                    if (selectedServicesCount) selectedServicesCount.textContent = '0 selected';
                    return;
                }
                
                selectedServicesDisplay.style.display = 'block';
                if (selectedServicesCount) selectedServicesCount.textContent = `${bookingState.selectedPredefinedServices.length} selected`;
                
                let servicesHtml = '';
                let totalBudget = 0;
                
                window.bookingState.selectedPredefinedServices.forEach((service, index) => {
                    totalBudget += service.budget;
                    servicesHtml += `
                        <div class="selected-service-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; margin-bottom: 0.5rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">${service.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-light); text-transform: capitalize;">${service.category}</div>
                                ${service.description ? `<div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem;">${service.description}</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.9rem; color: var(--text);">Budget:</label>
                                    <div style="display: flex; align-items: center;">
                                        <span style="color: var(--text-light);">$</span>
                                        <input type="number" class="service-budget-input" data-service-id="${service.id}" 
                                               min="1" max="10000" value="${service.budget}" 
                                               style="width: 80px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; margin-left: 0.25rem;">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.9rem; color: var(--text);">Start:</label>
                                    <input type="time" class="service-start-time" data-service-id="${service.id}" value="${service.startTime || ''}" step="900" style="width: 120px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <label style="font-size: 0.9rem; color: var(--text);">End:</label>
                                    <input type="time" class="service-end-time" data-service-id="${service.id}" value="${service.endTime || ''}" step="900" style="width: 120px; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem; color: var(--text-light); font-size: 0.9rem;">
                                    <i class="fas fa-clock"></i>
                                    <span id="service-duration-display-${service.id}">${(service.duration || 0)} min</span>
                                </div>
                                <button type="button" class="remove-service-btn" data-service-id="${service.id}" 
                                        style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer;">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                servicesHtml += `
                    <div style="margin-top: 1rem; padding: 1rem; background: #f8faff; border-radius: 6px; border-left: 4px solid var(--primary-color);">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <span style="font-weight: 600; color: var(--text);">Total Budget:</span>
                            <span style="font-weight: 700; font-size: 1.1rem; color: var(--primary-color);">$${totalBudget.toLocaleString()}</span>
                        </div>
                    </div>
                `;
                
                selectedServicesItems.innerHTML = servicesHtml;
                
                // Add event listeners for budget inputs and remove buttons
                addSelectedServiceEventListeners();
                // Keep dropdown counts in sync on re-render
                updateDropdownCounts();
                // Keep timeline in sync after re-render
                drawTimeline();
            }

            // Global variable to store Google Maps initialization status
            window.googleMapsLoaded = false;
            
            // Legacy function - now redirects to consolidated implementation
            function initializeLocationAutocomplete() {
                console.log('Legacy initializeLocationAutocomplete called - redirecting to new implementation');
                initializeLocationAutocompleteNow();
            }
            
            // Search for locations using a geocoding service
            async function searchLocations(query) {
                const suggestionsDiv = document.getElementById('location-suggestions');
                
                try {
                    // Using OpenStreetMap Nominatim API as a free alternative to Google Maps
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`);
                    const locations = await response.json();
                    
                    if (locations.length === 0) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }
                    
                    let suggestionsHtml = '';
                    locations.forEach(location => {
                        const displayName = location.display_name;
                        suggestionsHtml += `
                            <div class="location-suggestion-item" data-location="${displayName}" data-lat="${location.lat}" data-lon="${location.lon}">
                                ${displayName}
                            </div>
                        `;
                    });
                    
                    suggestionsDiv.innerHTML = suggestionsHtml;
                    suggestionsDiv.style.display = 'block';
                    
                    // Add click event listeners to suggestions
                    suggestionsDiv.querySelectorAll('.location-suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const locationInput = document.getElementById('event-location');
                            locationInput.value = this.dataset.location;
                            suggestionsDiv.style.display = 'none';
                            
                            // Store coordinates for future use if needed
                            locationInput.dataset.lat = this.dataset.lat;
                            locationInput.dataset.lon = this.dataset.lon;
                        });
                    });
                    
                } catch (error) {
                    console.error('Error searching locations:', error);
                    suggestionsDiv.style.display = 'none';
                }
            }

            // Add event listeners for selected services (budget and duration inputs, remove buttons)
            function addSelectedServiceEventListeners() {
                // Budget input listeners
                document.querySelectorAll('.service-budget-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const serviceId = e.target.dataset.serviceId;
                        const value = Math.max(Math.min(10000, parseInt(e.target.value) || 0));
                        
                        updateServiceBudget(serviceId, value);
                        renderSelectedServices(); // Re-render to update total
                    });
                });
                
                // Start/End time listeners
                document.querySelectorAll('.service-start-time').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const serviceId = e.target.dataset.serviceId;
                        updateServiceTime(serviceId, 'startTime', e.target.value);
                    });
                });
                document.querySelectorAll('.service-end-time').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const serviceId = e.target.dataset.serviceId;
                        updateServiceTime(serviceId, 'endTime', e.target.value);
                    });
                });
                
                // Remove button listeners
                document.querySelectorAll('.remove-service-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const btn = e.currentTarget;
                        const serviceId = btn.dataset.serviceId;
                        removeSelectedService(serviceId);
                    });
                });
            }

            // Remove selected service
            function removeSelectedService(serviceId) {
                window.bookingState.selectedPredefinedServices = bookingState.selectedPredefinedServices.filter(s => String(s.id) !== String(serviceId));
                renderSelectedServices();
                updateFindVendorsButton();
                updateDropdownCounts();
                drawTimeline();
            }

            // Legacy function - keep for compatibility
            function addPredefinedServiceEventListeners() {
                // This function is now replaced by addDropdownEventListeners
                console.log('Legacy addPredefinedServiceEventListeners called');
            }

            // Toggle predefined service selection
            function togglePredefinedServiceSelection(serviceId, category, cardElement) {
                const isSelected = cardElement.classList.contains('selected');
                const budgetForm = cardElement.querySelector('.service-budget-form');
                const checkIcon = cardElement.querySelector('.service-card-check');
                
                if (isSelected) {
                    // Deselect service
                    cardElement.classList.remove('selected');
                    budgetForm.style.display = 'none';
                    checkIcon.textContent = '';
                    
                    // Remove from selected services
                    window.bookingState.selectedPredefinedServices = bookingState.selectedPredefinedServices.filter(s => s.id !== serviceId);
                    renderSelectedServices();
                    updateDropdownCounts();
                } else {
                    // Select service
                    cardElement.classList.add('selected');
                    budgetForm.style.display = 'block';
                    checkIcon.innerHTML = '<i class="fas fa-check" style="color: #28a745;"></i>';
                    
                    // Find service details
                    const serviceDetails = bookingState.availablePredefinedServices[category]?.find(s => s.id === serviceId);
                    if (serviceDetails) {
                        // Add to selected services
                        window.bookingState.selectedPredefinedServices.push({
                            id: serviceId,
                            name: serviceDetails.name,
                            description: serviceDetails.description,
                            category: category,
                            budget: 100, // Default budget
                            duration: 60
                        });
                        renderSelectedServices();
                        updateDropdownCounts();
                    }
                }
                
                updateSelectedServicesSummary();
                updateFindVendorsButton();
            }

            // Update the placeholder of each dropdown with count of selected services in that category
            function updateDropdownCounts() {
                const selected = Array.isArray(window.bookingState?.selectedPredefinedServices)
                    ? window.bookingState.selectedPredefinedServices
                    : [];
                document.querySelectorAll('.service-dropdown').forEach(selectEl => {
                    const cat = selectEl.dataset.category;
                    const count = selected.filter(s => s.category === cat).length;
                    const firstOpt = selectEl.querySelector('option[value=""]');
                    if (firstOpt) {
                        const base = firstOpt.dataset.placeholder || `Select a ${cat} service...`;
                        firstOpt.textContent = count > 0
                            ? `${count} service${count > 1 ? 's' : ''} selected`
                            : base;
                    }
                });
            }

            // Update individual service budget
            function updateServiceBudget(serviceId, budget) {
                const service = bookingState.selectedPredefinedServices.find(s => String(s.id) === String(serviceId));
                if (service) {
                    service.budget = Math.max(1, Math.min(10000, budget));
                    updateSelectedServicesSummary();
                }
            }

            // Update service duration
            function updateServiceDuration(serviceId, duration) {
                const service = bookingState.selectedPredefinedServices.find(s => String(s.id) === String(serviceId));
                if (service) {
                    service.duration = Math.max(15, Math.min(480, duration));
                }
            }

            // Update service start/end time and recompute duration
            function updateServiceTime(serviceId, field, value) {
                const service = bookingState.selectedPredefinedServices.find(s => String(s.id) === String(serviceId));
                if (!service) return;
                service[field] = value;
                // If both times present, compute duration
                const startMin = parseTimeToMinutes(service.startTime);
                const endMin = parseTimeToMinutes(service.endTime);
                if (Number.isFinite(startMin) && Number.isFinite(endMin) && endMin >= startMin) {
                    service.duration = endMin - startMin;
                    const disp = document.getElementById(`service-duration-display-${service.id}`);
                    if (disp) disp.textContent = `${service.duration} min`;
                }
                drawTimeline();
            }

            // Parse HH:MM to minutes from midnight
            function parseTimeToMinutes(t) {
                if (!t || typeof t !== 'string' || !t.includes(':')) return NaN;
                const [h, m] = t.split(':').map(v => parseInt(v, 10));
                if (Number.isNaN(h) || Number.isNaN(m)) return NaN;
                return h * 60 + m;
            }

            function formatMinutes(min) {
                const h = Math.floor(min / 60);
                const m = min % 60;
                return `${h}h ${m}m`;
            }
            // Format minutes from midnight to h:mm AM/PM
            function formatTimeLabel(mins) {
                const h24 = Math.floor(mins / 60);
                const m = mins % 60;
                const ampm = h24 < 12 ? 'AM' : 'PM';
                const h12 = ((h24 + 11) % 12) + 1;
                return `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
            }

            // Compute timeline range
            function getTimelineRange() {
                const eStart = parseTimeToMinutes(document.getElementById('event-start-time')?.value || '');
                const eEnd = parseTimeToMinutes(document.getElementById('event-end-time')?.value || '');
                const services = bookingState.selectedPredefinedServices || [];
                const sStarts = services.map(s => parseTimeToMinutes(s.startTime)).filter(Number.isFinite);
                const sEnds = services.map(s => parseTimeToMinutes(s.endTime)).filter(Number.isFinite);
                const mins = [eStart, ...sStarts].filter(Number.isFinite);
                const maxs = [eEnd, ...sEnds].filter(Number.isFinite);
                let minT = mins.length ? Math.min(...mins) : 8 * 60;
                let maxT = maxs.length ? Math.max(...maxs) : 20 * 60;
                if (Number.isFinite(eStart) && Number.isFinite(eEnd)) {
                    minT = Math.min(minT, eStart);
                    maxT = Math.max(maxT, eEnd);
                }
                if (maxT <= minT) maxT = minT + 60;
                return { minT, maxT };
            }

            // Detect conflicts and overlaps
            function computeConflicts() {
                const eStart = parseTimeToMinutes(document.getElementById('event-start-time')?.value || '');
                const eEnd = parseTimeToMinutes(document.getElementById('event-end-time')?.value || '');
                const services = bookingState.selectedPredefinedServices || [];
                const conflicts = new Map();
                services.forEach(s => {
                    const sStart = parseTimeToMinutes(s.startTime || '');
                    const sEnd = parseTimeToMinutes(s.endTime || '');
                    let has = false;
                    if (!(Number.isFinite(sStart) && Number.isFinite(sEnd) && sEnd >= sStart)) return; // incomplete
                    // outside event
                    if (Number.isFinite(eStart) && sStart < eStart) has = true;
                    if (Number.isFinite(eEnd) && sEnd > eEnd) has = true;
                    conflicts.set(s.id, has);
                });
                return conflicts;
            }

            // Draw timeline with axis and bars in all visible sections
            function drawTimeline() {
                const sections = document.querySelectorAll('[data-timeline="section"]');
                if (!sections || sections.length === 0) return;
                const { minT, maxT } = getTimelineRange();
                const range = maxT - minT;
                const pct = (mins) => (mins / range) * 100;
                const eStart = parseTimeToMinutes(document.getElementById('event-start-time')?.value || '');
                const eEnd = parseTimeToMinutes(document.getElementById('event-end-time')?.value || '');
                const services = bookingState.selectedPredefinedServices || [];

                sections.forEach(section => {
                    const axis = section.querySelector('[data-timeline="axis"]');
                    const layers = section.querySelector('[data-timeline="layers"]');
                    const warningEl = section.querySelector('[data-timeline="warning"]');
                    if (!axis || !layers) return;
                    // Axis
                    axis.innerHTML = '';
                    for (let t = Math.ceil(minT/60)*60; t <= maxT; t += 60) {
                        const label = document.createElement('div');
                        label.style.position = 'absolute';
                        label.style.left = pct(t - minT) + '%';
                        label.style.transform = 'translateX(-50%)';
                        label.textContent = formatTimeLabel(t);
                        axis.appendChild(label);
                    }
                    // Layers
                    layers.innerHTML = '';
                    // Event window
                    if (Number.isFinite(eStart) && Number.isFinite(eEnd) && eEnd > eStart) {
                        const el = document.createElement('div');
                        el.style.position = 'absolute';
                        el.style.left = pct(eStart - minT) + '%';
                        el.style.width = pct(eEnd - eStart) + '%';
                        el.style.top = '4px';
                        el.style.bottom = '4px';
                        el.style.background = '#e0e7ff';
                        el.style.borderRadius = '6px';
                        layers.appendChild(el);
                    }
                    // Vendor engagement window derived from services
                    const sStarts = services.map(s => parseTimeToMinutes(s.startTime)).filter(Number.isFinite);
                    const sEnds = services.map(s => parseTimeToMinutes(s.endTime)).filter(Number.isFinite);
                    if (sStarts.length && sEnds.length) {
                        const vStart = Math.min(...sStarts);
                        const vEnd = Math.max(...sEnds);
                        if (vEnd > vStart) {
                            const v = document.createElement('div');
                            v.style.position = 'absolute';
                            v.style.left = pct(vStart - minT) + '%';
                            v.style.width = pct(vEnd - vStart) + '%';
                            v.style.top = '44px';
                            v.style.height = '20px';
                            v.style.background = '#bbf7d0';
                            v.style.border = '1px solid #86efac';
                            v.style.borderRadius = '6px';
                            layers.appendChild(v);
                        }
                    }
                    // Services bars
                    let conflictCount = 0;
                    let row = 0;
                    services.forEach(s => {
                        const sStart = parseTimeToMinutes(s.startTime || '');
                        const sEnd = parseTimeToMinutes(s.endTime || '');
                        if (!(Number.isFinite(sStart) && Number.isFinite(sEnd) && sEnd > sStart)) return;
                        const bar = document.createElement('div');
                        bar.style.position = 'absolute';
                        bar.style.left = pct(sStart - minT) + '%';
                        bar.style.width = pct(sEnd - sStart) + '%';
                        bar.style.top = (72 + (row * 28)) + 'px';
                        bar.style.height = '20px';
                        const outside = Number.isFinite(eStart) && Number.isFinite(eEnd) && (sStart < eStart || sEnd > eEnd);
                        bar.style.background = outside ? '#fecaca' : '#fde68a';
                        bar.style.border = outside ? '1px solid #ef4444' : '1px solid #f59e0b';
                        bar.style.borderRadius = '6px';
                        bar.title = s.name || 'Service';
                        layers.appendChild(bar);
                        if (outside) conflictCount++;
                        row++;
                    });
                    if (warningEl) {
                        if (conflictCount > 0) {
                            warningEl.style.display = 'block';
                            warningEl.textContent = `${conflictCount} service time conflict(s) detected.`;
                        } else {
                            warningEl.style.display = 'none';
                            warningEl.textContent = '';
                        }
                    }
                });
            }

            // (Auto-Pack and Clear Times removed by request)

            // Wire up timeline controls and inputs
            document.addEventListener('DOMContentLoaded', () => {
                const ids = ['event-start-time','event-end-time'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', () => drawTimeline());
                });
                initEventDatePicker();
                setTimeout(drawTimeline, 0);
            });

            function initEventDatePicker() {
                const input = document.getElementById('event-date');
                if (!input || !window.flatpickr) return;
                if (input._flatpickr) return; // prevent double init
                flatpickr(input, {
                    minDate: 'today',
                    dateFormat: 'Y-m-d',
                    altInput: true,
                    altFormat: 'F j, Y',
                    allowInput: false,
                    onChange: () => {
                        drawTimeline();
                        // optionally update any summaries
                    }
                });
            }

            // Update selected services summary
            function updateSelectedServicesSummary() {
                const summaryDiv = document.getElementById('selected-services-summary');
                const listDiv = document.getElementById('selected-services-list');
                const totalBudgetSpan = document.getElementById('total-services-budget');
                
                if (bookingState.selectedPredefinedServices.length === 0) {
                    summaryDiv.style.display = 'none';
                    return;
                }
                
                summaryDiv.style.display = 'block';
                
                let listHtml = '';
                let totalBudget = 0;
                let totalMinutes = 0;
                
                window.bookingState.selectedPredefinedServices.forEach(service => {
                    const durMin = Math.max(0, parseInt(service.duration) || 0);
                    const durTxt = durMin > 0 ? formatMinutes(durMin) : '—';
                    const hourly = durMin > 0 ? (service.budget / (durMin/60)) : 0;
                    totalBudget += service.budget;
                    totalMinutes += durMin;
                    listHtml += `
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; padding: 0.25rem 0; align-items: center;">
                            <div>
                                <div style="color: var(--text); font-weight:600;">${service.name}</div>
                                <div style="color: var(--text-light); font-size:0.85rem;">Duration: ${durTxt}${durMin>0?` • ~$${Math.round(hourly).toLocaleString()}/hr`:''}</div>
                            </div>
                            <div style="font-weight: 700; color: var(--primary-color);">$${Number(service.budget||0).toLocaleString()}</div>
                        </div>
                    `;
                });
                
                const blendedHourly = totalMinutes>0 ? (totalBudget / (totalMinutes/60)) : 0;
                listHtml += `
                    <div style="margin-top: 0.5rem; padding-top:0.5rem; border-top:1px dashed var(--border); color: var(--text-light); font-size:0.9rem;">
                        <div>Total duration: ${formatMinutes(totalMinutes)}${totalMinutes>0?` • Blended ~$${Math.round(blendedHourly).toLocaleString()}/hr`:''}</div>
                    </div>
                `;
                
                listDiv.innerHTML = listHtml;
                totalBudgetSpan.textContent = totalBudget.toLocaleString();
            }

            // Update Find Vendors button state
            function updateFindVendorsButton() {
                const findVendorsBtn = document.getElementById('find-vendors-btn');
                if (findVendorsBtn) {
                    const hasSelectedServices = bookingState.selectedPredefinedServices.length > 0;
                    findVendorsBtn.disabled = !hasSelectedServices;
                }
            }

            function validateStep2() {
                const eventDate = document.getElementById('event-date');
                const eventStartTime = document.getElementById('event-start-time');
                const eventEndTime = document.getElementById('event-end-time');
                const eventTimezone = document.getElementById('event-timezone');
                const eventLocation = document.getElementById('event-location');
                const eventName = document.getElementById('event-name');
                const eventType = document.getElementById('event-type');
                
                // Check if all required fields exist and have values
                return eventDate?.value && 
                       eventStartTime?.value && 
                       eventEndTime?.value && 
                       eventTimezone?.value &&
                       eventLocation?.value &&
                       (eventName?.value || '').trim() &&
                       eventType?.value;
            }

            async function handleFindVendors() {
                // Validate that services are selected and event details are filled
                if (bookingState.selectedPredefinedServices.length === 0) {
                    showError('Please select at least one service.');
                    return;
                }
                
                if (!validateStep2()) {
                    showError('Please fill in all required event details.');
                    return;
                }

                // Collect event details - use stored location data if available
                const locationInput = document.getElementById('event-location');
                const eventLocationData = window.selectedEventLocation || {};
                
                window.bookingState.eventDetails = {
                    name: (document.getElementById('event-name')?.value || '').trim(),
                    type: document.getElementById('event-type')?.value || '',
                    date: document.getElementById('event-date').value,
                    startTime: document.getElementById('event-start-time').value,
                    endTime: document.getElementById('event-end-time').value,
                    location: locationInput.value,
                    locationCoords: eventLocationData.lat && eventLocationData.lng ? {
                        lat: eventLocationData.lat,
                        lng: eventLocationData.lng
                    } : null,
                    attendeeCount: parseInt(document.getElementById('attendee-count').value) || 50
                };
                
                // Also update the global bookingState to ensure consistency
                if (window.bookingState) {
                    window.bookingState.eventDetails = bookingState.eventDetails;
                }
                
                console.log('Event details collected:', bookingState.eventDetails);

                // Fallback: If user typed address but didn't select from autocomplete, geocode to get coords
                try {
                    if (!bookingState.eventDetails.locationCoords && bookingState.eventDetails.location) {
                        if (window.google && google.maps) {
                            const gc = typeof geocoder !== 'undefined' && geocoder ? geocoder : new google.maps.Geocoder();
                            const place = await new Promise((resolve, reject) => {
                                gc.geocode({ address: bookingState.eventDetails.location }, (results, status) => {
                                    if (status === 'OK' && results && results[0] && results[0].geometry && results[0].geometry.location) {
                                        resolve(results[0]);
                                    } else {
                                        reject(new Error('Geocode failed: ' + status));
                                    }
                                });
                            });
                            const lat = place.geometry.location.lat();
                            const lng = place.geometry.location.lng();
                            bookingState.eventDetails.locationCoords = { lat, lng };
                            window.bookingState.eventDetails = bookingState.eventDetails;
                            // Sync global and refresh map immediately
                            try { window.selectedEventLocation = { lat, lng }; } catch {}
                            try { if (typeof addEventLocationMarker === 'function') addEventLocationMarker(); } catch {}
                            try { if (state?.map?.map) { state.map.map.panTo({ lat, lng }); } } catch {}
                            try { if (typeof updateMapMarkers === 'function') { updateMapMarkers(); } } catch {}
                            console.log('📍 Geocoded event location to coords:', bookingState.eventDetails.locationCoords);
                        } else {
                            console.warn('Google Maps not available to geocode typed address; distance will be unavailable');
                        }
                    }
                } catch (geoErr) {
                    console.warn('Geocoding typed event location failed:', geoErr);
                }

                // Show loading overlay and prep UI
                showBookingLoading('Finding matching vendors...');
                const vendorLoading = document.getElementById('vendor-loading');
                if (vendorLoading) vendorLoading.style.display = 'none';
                document.getElementById('vendor-results').innerHTML = '';
                document.getElementById('no-vendors-found').style.display = 'none';

                updateBookingStep(4);

                try {
                    // Group selected services by category for sectioned display
                    const servicesByCategory = {};
                    window.bookingState.selectedPredefinedServices.forEach(service => {
                        const category = service.category || 'Other';
                        if (!servicesByCategory[category]) {
                            servicesByCategory[category] = [];
                        }
                        servicesByCategory[category].push(service);
                    });

                    console.log('Services grouped by category:', servicesByCategory);

                    // Make separate API calls for each category and service combination
                    const vendorSections = [];
                    let totalVendorsFound = 0;

                    for (const [category, services] of Object.entries(servicesByCategory)) {
                        for (const service of services) {
                            console.log(`Searching vendors for category: ${category}, service: ${service.name}`);
                            
                            const serviceRequirement = {
                                serviceId: service.id,
                                serviceName: service.name,
                                category: service.category,
                                budget: service.budget,
                                duration: service.duration, // Use user-specified duration instead of default
                                // NEW: include service-specific times for backend filtering
                                startTime: service.startTime || service.serviceStartTime || null,
                                endTime: service.endTime || service.serviceEndTime || null
                            };

                            const searchPayload = {
                                selectedServices: [serviceRequirement],
                                // Ensure EventDate is passed (backend uses date + service times)
                                eventDetails: {
                                    ...bookingState.eventDetails,
                                    // Pass only date/time fields the API expects; boundary times remain for UI validation
                                    date: bookingState?.eventDetails?.date || bookingState?.eventDetails?.EventDate || null
                                },
                                totalBudget: service.budget,
                                serviceIds: [service.id],
                                // Unified pricing filters
                                budgetType: 'total',
                                pricingModel: service.pricingModel || null,
                                fixedPricingType: service.fixedPricingType || null
                            };

                            try {
                                const response = await fetch(`${API_BASE_URL}/vendors/search-by-services`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(searchPayload)
                                });
                                const data = await response.json();
                                console.log(`API Response for ${category} - ${service.name}:`, data);
                                if (data.success && data.vendors && data.vendors.length > 0) {
                                    const vendorsWithCoords = data.vendors.map(vendor => {
                                        // Coerce lat/lng to numbers (backend may send strings)
                                        const rawLat = vendor.Latitude ?? vendor.latitude;
                                        const rawLng = vendor.Longitude ?? vendor.longitude;
                                        const latNum = (typeof rawLat === 'string') ? parseFloat(rawLat) : rawLat;
                                        const lngNum = (typeof rawLng === 'string') ? parseFloat(rawLng) : rawLng;
                                        const safeLat = (typeof latNum === 'number' && isFinite(latNum)) ? latNum : 43.6532; // Toronto default
                                        const safeLng = (typeof lngNum === 'number' && isFinite(lngNum)) ? lngNum : -79.3832;

                                        const vendorWithCoords = {
                                            ...vendor,
                                            coordinates: {
                                                lat: safeLat,
                                                lng: safeLng
                                            }
                                        };
                                        console.log(`Vendor ${vendor.BusinessName || vendor.name} coordinates:`, vendorWithCoords.coordinates);
                                        return vendorWithCoords;
                                    });

                                    // Compute distance from event location; if coords missing, fallback-geocode via Nominatim (no Google required)
                                    try {
                                        let evt = window.bookingState?.eventDetails?.locationCoords;
                                        const evtValid = evt && typeof evt.lat === 'number' && typeof evt.lng === 'number' && isFinite(evt.lat) && isFinite(evt.lng);
                                        if (!evtValid) {
                                            const addr = (window.bookingState?.eventDetails?.location || window.bookingState?.eventDetails?.address || '').trim();
                                            if (addr) {
                                                try {
                                                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`;
                                                    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                                                    if (resp.ok) {
                                                        const j = await resp.json();
                                                        if (Array.isArray(j) && j.length > 0) {
                                                            const lat = parseFloat(j[0].lat);
                                                            const lng = parseFloat(j[0].lon);
                                                            if (!isNaN(lat) && !isNaN(lng)) {
                                                                evt = { lat, lng };
                                                                if (window.bookingState?.eventDetails) {
                                                                    window.bookingState.eventDetails.locationCoords = evt;
                                                                }
                                                                console.log('🧭 Fallback geocoded event coords via OSM:', evt);
                                                            }
                                                        }
                                                    } else {
                                                        console.warn('OSM geocode failed status:', resp.status);
                                                    }
                                                } catch (gErr) {
                                                    console.warn('OSM geocode error:', gErr);
                                                }
                                            }
                                        }

                                        if (evt && typeof evt.lat === 'number' && typeof evt.lng === 'number' && isFinite(evt.lat) && isFinite(evt.lng)) {
                                            vendorsWithCoords.forEach(v => {
                                                // Prefer mapped coordinates, but coerce if needed
                                                const latRaw = (v.coordinates && v.coordinates.lat != null) ? v.coordinates.lat : (v.Latitude ?? v.latitude);
                                                const lngRaw = (v.coordinates && v.coordinates.lng != null) ? v.coordinates.lng : (v.Longitude ?? v.longitude);
                                                const lat = (typeof latRaw === 'string') ? parseFloat(latRaw) : latRaw;
                                                const lng = (typeof lngRaw === 'string') ? parseFloat(lngRaw) : lngRaw;
                                                if (typeof lat === 'number' && typeof lng === 'number' && isFinite(lat) && isFinite(lng)) {
                                                    v.distance = haversineKm(evt.lat, evt.lng, lat, lng);
                                                }
                                            });
                                        }
                                    } catch (distErr) {
                                        console.warn('Distance computation skipped:', distErr);
                                    }

                                    const vendorSection = { category, service, vendors: vendorsWithCoords };
                                    vendorSections.push(vendorSection);
                                    totalVendorsFound += vendorsWithCoords.length;
                                    console.log(`✅ Added section for ${category} - ${service.name} with ${vendorsWithCoords.length} vendors:`, vendorSection);
                                } else {
                                    console.log(`No vendors found for ${category} - ${service.name}`);
                                }
                            } catch (sectionError) {
                                console.error(`Error searching vendors for ${category} - ${service.name}:`, sectionError);
                            }
                        }
                    }

                    if (vendorLoading) vendorLoading.style.display = 'none';

                    console.log('🎯 Final vendor sections before rendering:', vendorSections);
                    console.log('🎯 vendorSections.length:', vendorSections.length);
                    console.log('🎯 totalVendorsFound:', totalVendorsFound);
                    
                    if (vendorSections.length > 0 && totalVendorsFound > 0) {
                        // Store all vendors for selection tracking
                        window.bookingState.availableVendors = vendorSections.flatMap(section => section.vendors);
                        console.log('📦 Stored available vendors:', window.bookingState.availableVendors.length);
                        
                        // Initialize Google Maps and render map-based vendor results
                        await initializeVendorMap(vendorSections);
                        
                        // Add a small delay to ensure DOM is ready
                        setTimeout(() => {
                            console.log('🎨 About to render vendor cards...');
                            console.log('Current booking step:', window.bookingState?.currentStep);
                            console.log('Vendor sections to render:', JSON.stringify(vendorSections, null, 2));
                            
                            // Force show container first
                            const container = document.getElementById('vendor-cards-container');
                            if (container) {
                                container.style.display = 'block';
                                console.log('✅ Forced container to be visible');
                            }
                            
                            // Add immediate test to bypass any issues
                            console.log('🧪 Testing direct card insertion...');
                            const cardsContainer = document.getElementById('vendor-horizontal-cards');
                            if (cardsContainer) {
                                cardsContainer.innerHTML = `
                                    <div style="padding: 1rem; background: #e8f5e8; border: 2px solid #4caf50; border-radius: 8px; margin: 1rem 0;">
                                        <h4 style="color: #2e7d32; margin: 0 0 0.5rem 0;">✅ Vendors Found!</h4>
                                        <p style="color: #2e7d32; margin: 0;">Found ${totalVendorsFound} vendors. Rendering cards now...</p>
                                    </div>
                                `;
                                console.log('✅ Test message inserted directly');
                                
                                // Wait a moment then try to render actual cards
                                setTimeout(() => {
                                    console.log('🎨 Now calling renderHorizontalVendorCards...');
                                    
                                    // Bypass the debouncing and call directly with retryCount = 1
                                    isRenderingVendorCards = false; // Reset the flag
                                    renderHorizontalVendorCards(vendorSections, 1);
                                }, 500);
                            } else {
                                console.error('❌ vendor-horizontal-cards container not found');
                            }
                        }, 100);
                        
                        // Update step 4 header with match info
                        const step4Title = document.querySelector('#booking-step-4 .form-section-title');
                        if (step4Title) {
                            step4Title.textContent = `Found ${totalVendorsFound} Matching Vendors across ${vendorSections.length} Services`;
                        }
                    } else {
                        // Even with no vendors found, show the map with event location
                        console.log('No vendors found initially, but showing map with event location for exploration');
                        
                        // Initialize empty vendor sections but still show the map
                        window.bookingState.availableVendors = [];
                        window.bookingState.originalVendorSections = [];
                        
                        // Initialize map with just the event location
                        await initializeVendorMap([]);
                        
                        // Show empty vendor cards container
                        const container = document.getElementById('vendor-cards-container');
                        if (container) {
                            container.style.display = 'block';
                        }
                        
                        // Update step 3 header
                        const step3Title = document.querySelector('#booking-step-3 .form-section-title');
                        if (step3Title) {
                            step3Title.textContent = 'Explore Map to Find Vendors';
                        }
                        
                        // Show message in vendor cards area
                        const cardsContainer = document.getElementById('vendor-horizontal-cards');
                        if (cardsContainer) {
                            cardsContainer.innerHTML = `
                                <div style="text-align: center; padding: 2rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd;">
                                    <h5 style="color: var(--text); margin-bottom: 1rem;">🗺️ Explore the Map</h5>
                                    <p style="color: var(--text-light); margin-bottom: 1rem;">
                                        No vendors found in your immediate area, but you can pan and zoom the map to discover vendors nearby.
                                    </p>
                                    <p style="font-size: 0.9rem; color: var(--text-light);">
                                        Move the map around your event location to find available vendors. They'll appear here as you explore!
                                    </p>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Error finding vendors:', error);
                    if (vendorLoading) vendorLoading.style.display = 'none';
                    document.getElementById('no-vendors-found').style.display = 'block';
                    showError('Failed to find vendors. Please try again.');
                } finally {
                    hideBookingLoading();
                }
            }

            function renderVendorResults(vendors) {
                const vendorResults = document.getElementById('vendor-results');
                
                const vendorCards = vendors.map(vendor => {
                    // Fix: vendor.categories is a string, not an array
                    const vendorCategories = vendor.categories ? vendor.categories.toLowerCase() : '';
                    const services = bookingState.selectedServices.filter(service => 
                        vendorCategories.includes(service.categoryKey.toLowerCase()) ||
                        vendorCategories.includes(service.type?.toLowerCase() || '')
                    );
                    
                    // Calculate estimated price based on selected services
                    const estimatedPrice = services.reduce((sum, service) => {
                        // Use service base price if available, otherwise estimate
                        const servicePrice = service.basePrice || service.minPrice || 500;
                        return sum + servicePrice;
                    }, 0);

                    return `
                        <div class="vendor-card" data-vendor-id="${vendor.VendorProfileID || vendor.id}">
                            <div class="vendor-image">
                                <div style="width:100%;height:100%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;">
                                    ${(vendor.BusinessName || vendor.name || 'V').charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name">${vendor.BusinessName || vendor.name || 'Vendor'}</h3>
                                <div class="vendor-location">
                                    <i class="fas fa-star" style="color: #fbbf24;"></i> ${vendor.rating || '4.5'} (${vendor.reviewCount || '12'} reviews)
                                </div>
                                <div class="vendor-features">
                                    <div class="feature">
                                        <span class="feature-icon"><i class="fas fa-briefcase"></i></span>
                                        <span>${services.map(s => s.type).join(', ') || 'Multiple services'}</span>
                                    </div>
                                    <div class="feature">
                                        <span class="feature-icon"><i class="fas fa-dollar-sign"></i></span>
                                        <span class="price-indicator">$${Math.round(estimatedPrice).toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="vendor-footer" style="margin-top: 1rem;">
                                    <button class="btn btn-primary" onclick="toggleVendorSelection(${vendor.VendorProfileID || vendor.id})" style="width: 100%; padding: 0.75rem; border-radius: 12px; font-weight: 600;">
                                        Select Vendor
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                vendorResults.innerHTML = vendorCards;
            }

            // Unified pricing formatter for services coming from API
            function formatUnifiedServicePrice(service) {
                if (!service || typeof service !== 'object') return { label: '', value: null };
                const toNum = (v) => {
                    const n = parseFloat(v);
                    return Number.isFinite(n) ? n : null;
                };
                const pm = (service.PricingModel || service.pricingModel || '').toLowerCase();
                const fixedType = (service.FixedPricingType || service.fixedPricingType || '').toLowerCase();
                const baseRate = toNum(service.BaseRate ?? service.baseRate ?? service.VendorPrice ?? service.Price);
                const baseDuration = parseInt(service.BaseDurationMinutes ?? service.baseDurationMinutes ?? service.VendorDurationMinutes ?? service.durationMinutes);
                const fixedPrice = toNum(service.FixedPrice ?? service.fixedPrice);
                const ppp = toNum(service.PricePerPerson ?? service.pricePerPerson);
                const ot = toNum(service.OvertimeRatePerHour ?? service.overtimeRatePerHour);
                // Prefer unified fields
                if (pm === 'fixed_based') {
                    if (fixedType === 'per_attendee' && ppp != null) {
                        return { label: `$${Math.round(ppp).toLocaleString()}/person`, value: ppp };
                    }
                    if (fixedPrice != null) {
                        return { label: `$${Math.round(fixedPrice).toLocaleString()} Fixed`, value: fixedPrice };
                    }
                }
                if (pm === 'time_based' || pm === '') {
                    if (baseRate != null) {
                        const base = `$${Math.round(baseRate).toLocaleString()}`;
                        const otPart = ot != null ? ` · Additional hour $${Math.round(ot).toLocaleString()}/hr` : '';
                        return { label: `${base}${otPart}`.trim(), value: baseRate };
                    }
                }
                // Fallback to legacy vendor price/duration if provided
                const legacyPrice = toNum(service.VendorPrice ?? service.MinPrice ?? service.Price);
                const legacyDuration = parseInt(service.VendorDurationMinutes ?? service.DurationMinutes ?? service.durationMinutes);
                if (legacyPrice != null) {
                    return { label: `$${Math.round(legacyPrice).toLocaleString()}`, value: legacyPrice };
                }
                return { label: '', value: null };
            }



            // Function to select all services for a vendor
            window.selectAllServicesForVendor = function(vendorId, servicesData) {
                console.log('🎯 Selecting all services for vendor:', vendorId, servicesData);
                
                servicesData.forEach(service => {
                    toggleVendorSelection(vendorId, service.serviceName, service.price);
                });
                
                // Show success message
                showNotificationToast('Success', `Selected all services for vendor!`);
            };

            // New function to render vendors grouped by category and service
            function renderSectionedVendorResults(vendorSections) {
                const vendorResults = document.getElementById('vendor-results');
                
                const sectionedHTML = vendorSections.map(section => {
                    const { category, service, vendors } = section;
                    
                    const vendorCards = vendors.map(vendor => {
                        // Get actual vendor service details from the services array returned by API
                        const vendorService = vendor.services?.find(vs => vs.ServiceName === service.name);
                        
                        // Unified price label/value resolution
                        const priceInfo = formatUnifiedServicePrice(vendorService || {});
                        const vendorDescription = vendorService?.VendorDescription ?? vendorService?.Description ?? '';
                        const vendorDuration = vendorService?.VendorDurationMinutes ?? vendorService?.BaseDurationMinutes;
                        
                        // Debug the full structure
                        console.log('🔍 Full vendor structure:', JSON.stringify(vendor, null, 2));
                        
                        // Extract vendor ID from the nested vendor object
                        const vendorId = vendor.vendor?.VendorProfileID || 
                                        vendor.VendorProfileID || 
                                        vendor.vendor?.id || 
                                        vendor.id ||
                                        138; // Fallback for testing
                        
                        console.log('🆔 Extracted vendorId:', vendorId);
                        console.log('🆔 vendor.vendor?.VendorProfileID:', vendor.vendor?.VendorProfileID);
                        console.log('🆔 vendor.VendorProfileID:', vendor.VendorProfileID);
                        const businessName = vendor.vendor?.BusinessName || vendor.BusinessName;
                        const location = vendor.vendor?.Location || vendor.Location; // This comes from API as "City, State"
                        const featuredImage = vendor.vendor?.FeaturedImageURL || vendor.FeaturedImageURL;
                        
                        // Debug service data
                        console.log('🔍 Service data check:');
                        console.log('  - actualPrice:', priceInfo.value);
                        console.log('  - vendorDescription:', vendorDescription);
                        console.log('  - vendorDuration:', vendorDuration);
                        console.log('  - vendorService:', vendorService);
                        
                        // Skip vendor if no price info at all
                        if (!priceInfo.label) {
                            console.warn(`⚠️ Skipping vendor ${vendorId} - missing service data for ${service.name}`);
                            console.warn('Missing:', {
                                priceInfo: !priceInfo.label
                            });
                            return '';
                        }

                        return `
                            <div class="vendor-card" data-vendor-id="${vendorId}">
                                <div class="vendor-image">
                                    ${featuredImage ? 
                                        `<img src="${featuredImage}" alt="${businessName}" style="width:100%;height:100%;object-fit:cover;">` : 
                                        `<div style="width:100%;height:100%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">${businessName.charAt(0).toUpperCase()}</div>`
                                    }
                                    <div class="vendor-badges" style="position: absolute; bottom: 12px; left: 12px; display: flex; gap: 6px;">
                                        ${(vendor.vendor?.IsPremium || vendor.IsPremium) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #5e72e4; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Premium</span>' : ''}
                                        ${(vendor.vendor?.IsEcoFriendly || vendor.IsEcoFriendly) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #38a169; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Eco-Friendly</span>' : ''}
                                        ${(vendor.vendor?.IsAwardWinning || vendor.IsAwardWinning) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #d69e2e; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Award Winning</span>' : ''}
                                    </div>
                                </div>
                                <div class="vendor-details">
                                    <h3 class="vendor-name">${businessName}</h3>
                                    <div class="vendor-location" style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">
                                        <span style="color: #888; margin-right: 0.5rem;">Location:</span>${location}
                                    </div>
                                    <div class="vendor-business-type" style="margin: 0.5rem 0; font-size: 0.85rem; color: #666; font-style: italic;">
                                        ${vendor.vendor?.BusinessType || vendor.BusinessType}
                                    </div>
                                    <div class="vendor-features" style="display: flex; justify-content: space-between; align-items: center; margin: 0.35rem 0; padding: 0.3rem 0.5rem; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display:flex; justify-content:space-between; width:100%; gap:6px; align-items:center;">
                                            <span style="color: #6b7280; font-weight: 500; font-size: 0.75rem;">${service.name}</span>
                                            <span style="color: #6b7280; font-weight: 600; font-size: 0.75rem;">${priceInfo.label}</span>
                                        </div>
                                    </div>
                                    <div style="margin-top: -0.25rem; color: #9ca3af; font-size: 0.70rem;">
                                        ${vendorDuration ? `${Math.round(vendorDuration)} min` : ''}
                                    </div>
                                    <div class="vendor-description" style="margin: 0.6rem 0; font-size: 0.9rem; color: #4b5563; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${vendorDescription || ''}
                                    </div>
                                    <div class="vendor-footer">
                                        <button class="btn btn-outline view-profile-btn" onclick="event.preventDefault(); event.stopPropagation(); const baseUrl = window.location.origin; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');" style="border-radius: 12px; font-weight: 600;">View Profile</button>
                                        <button class="btn btn-primary btn-select-vendor" onclick="toggleVendorSelection('${vendorId}', '${service.name}', ${priceInfo.value ?? 0})" style="border-radius: 12px; font-weight: 600;">
                                            Select Vendor
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).filter(card => card !== '').join(''); // Filter out empty cards

                    return `
                        <div class="vendor-section" style="margin-bottom: 3rem; border-radius: 12px;">
                            <div class="section-header" style="background: #2c3e50; color: #ffffff; padding: 1.2rem; border-radius: 10px 10px 0 0; margin-bottom: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                                            <span style="color: #3498db; font-weight: 600;">${category}</span> - ${service.name}
                                        </h4>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: #ecf0f1; opacity: 0.95;">
                                            ${vendors.filter(v => v.services?.find(vs => vs.ServiceName === service.name)).length} vendor${vendors.filter(v => v.services?.find(vs => vs.ServiceName === service.name)).length !== 1 ? 's' : ''} available | Budget: $${service.budget?.toLocaleString() || 'Not specified'}
                                        </p>
                                    </div>
                                    <div>
                                        <select class="vendor-sort-select" data-service="${service.name}" style="padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #34495e; background: #ffffff; color: #2c3e50; font-size: 0.9rem;">
                                            <option value="price-low">Price: Low to High</option>
                                            <option value="price-high">Price: High to Low</option>
                                            <option value="rating">Highest Rated</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="vendor-grid" style="padding: 2rem; background: #ffffff; border-radius: 0 0 10px 10px;">
                                ${vendorCards}
                            </div>
                        </div>
                    `;
                }).join('');

                vendorResults.innerHTML = sectionedHTML;
                
                // Add event listeners for sorting dropdowns
                document.querySelectorAll('.vendor-sort-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const serviceName = this.dataset.service;
                        const sortValue = this.value;
                        sortVendorSection(serviceName, sortValue);
                    });
                });
            }

            // Sort vendors within a specific service section
            function sortVendorSection(serviceName, sortValue) {
                // Find the section for this service
                const section = vendorSections.find(s => s.service.name === serviceName);
                if (!section) return;

                const vendors = section.vendors.filter(vendor => {
                    const vendorService = vendor.services?.find(vs => vs.ServiceName === serviceName);
                    const priceInfo = formatUnifiedServicePrice(vendorService || {});
                    return !!priceInfo.label;
                });

                switch(sortValue) {
                    case 'price-low':
                        vendors.sort((a, b) => {
                            const aInfo = formatUnifiedServicePrice(a.services.find(vs => vs.ServiceName === serviceName) || {});
                            const bInfo = formatUnifiedServicePrice(b.services.find(vs => vs.ServiceName === serviceName) || {});
                            return (aInfo.value ?? Number.POSITIVE_INFINITY) - (bInfo.value ?? Number.POSITIVE_INFINITY);
                        });
                        break;
                    case 'price-high':
                        vendors.sort((a, b) => {
                            const aInfo = formatUnifiedServicePrice(a.services.find(vs => vs.ServiceName === serviceName) || {});
                            const bInfo = formatUnifiedServicePrice(b.services.find(vs => vs.ServiceName === serviceName) || {});
                            return (bInfo.value ?? Number.NEGATIVE_INFINITY) - (aInfo.value ?? Number.NEGATIVE_INFINITY);
                        });
                        break;
                    case 'rating':
                        vendors.sort((a, b) => {
                            // Sort by premium status first, then by matching services count
                            if (a.IsPremium !== b.IsPremium) {
                                return b.IsPremium - a.IsPremium;
                            }
                            return (b.MatchingServices || 0) - (a.MatchingServices || 0);
                        });
                        break;
                    default:
                        // Sort by premium status, then eco-friendly, then award winning, then matching services
                        vendors.sort((a, b) => {
                            if (a.IsPremium !== b.IsPremium) return b.IsPremium - a.IsPremium;
                            if (a.IsEcoFriendly !== b.IsEcoFriendly) return b.IsEcoFriendly - a.IsEcoFriendly;
                            if (a.IsAwardWinning !== b.IsAwardWinning) return b.IsAwardWinning - a.IsAwardWinning;
                            return (b.MatchingServices || 0) - (a.MatchingServices || 0);
                        });
                        break;
                }

                // Update the section with sorted vendors
                section.vendors = vendors;
                
                // Re-render just this section
                renderSingleVendorSection(section);
            }

            // Render a single vendor section (helper function)
            function renderSingleVendorSection(section) {
                const { category, service, vendors } = section;
                
                const vendorCards = vendors.map(vendor => {
                    const vendorService = vendor.services?.find(vs => vs.ServiceName === service.name);
                    
                    const actualPrice = vendorService?.VendorPrice;
                    const vendorDescription = vendorService?.VendorDescription;
                    const vendorDuration = vendorService?.VendorDurationMinutes;
                    
                    const vendorId = vendor.VendorProfileID;
                    const businessName = vendor.BusinessName;
                    const location = vendor.Location;
                    const featuredImage = vendor.FeaturedImageURL;
                    
                    if (!actualPrice || !vendorDescription || !vendorDuration) {
                        return '';
                    }

                    return `
                        <div class="vendor-card" data-vendor-id="${vendorId}">
                            <div class="vendor-image">
                                ${featuredImage ? 
                                    `<img src="${featuredImage}" alt="${businessName}" style="width:100%;height:100%;object-fit:cover;">` : 
                                    `<div style="width:100%;height:100%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">${businessName.charAt(0).toUpperCase()}</div>`
                                }
                                <div class="vendor-badges" style="position: absolute; bottom: 12px; left: 12px; display: flex; gap: 6px;">
                                    ${vendor.IsPremium ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #5e72e4; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Premium</span>' : ''}
                                    ${vendor.IsEcoFriendly ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #38a169; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Eco-Friendly</span>' : ''}
                                    ${vendor.IsAwardWinning ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #d69e2e; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Award Winning</span>' : ''}
                                </div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name">${businessName}</h3>
                                <div class="vendor-location" style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">
                                    <span style="color: #888; margin-right: 0.5rem;">Location:</span>${location}
                                </div>
                                <div class="vendor-business-type" style="margin: 0.5rem 0; font-size: 0.85rem; color: #666; font-style: italic;">
                                    ${vendor.BusinessType}
                                </div>
                                <div class="vendor-features" style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                                    <span style="color: #2c3e50; font-size: 0.9rem;">${service.name}</span>
                                    <span style="color: #2c3e50; font-size: 0.9rem;">${Math.round(vendorDuration / 60)} hour${Math.round(vendorDuration / 60) !== 1 ? 's' : ''}</span>
                                    <span style="font-weight: 600; color: #27ae60; font-size: 0.95rem;">$${Math.round(actualPrice).toLocaleString()}</span>
                                </div>
                                <div class="vendor-description" style="margin: 0.75rem 0; font-size: 0.9rem; color: var(--text-light); line-height: 1.4;">
                                    ${vendorDescription.length > 100 ? vendorDescription.substring(0, 100) + '...' : vendorDescription}
                                </div>
                                <div class="vendor-footer">
                                    <button class="btn btn-outline view-profile-btn" onclick="event.preventDefault(); event.stopPropagation(); const baseUrl = window.location.origin + window.location.pathname; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');">View Profile</button>
                                    <button class="btn btn-primary btn-select-vendor" onclick="toggleVendorSelection('${vendorId}', '${service.name}', ${actualPrice})">
                                        Select Vendor
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).filter(card => card !== '').join('');

                // Find and update the specific section in the DOM
                const sectionElement = document.querySelector(`[data-service="${service.name}"]`).closest('.vendor-section');
                if (sectionElement) {
                    const vendorGrid = sectionElement.querySelector('.vendor-grid');
                    vendorGrid.innerHTML = vendorCards;
                }
            }

            // Function to view vendor profile in new tab
            function openVendorProfile(vendorId) {
                const baseUrl = window.location.origin;
                const profileUrl = `${baseUrl}/listings/${vendorId}`;
                console.log('Opening vendor profile:', profileUrl);
                window.open(profileUrl, '_blank');
            }

            // Legacy function - redirect to new function
            function viewVendorProfile(vendorId) {
                openVendorProfile(vendorId);
            }
            
            function viewVendorListing(vendorId) {
                viewVendorProfile(vendorId);
            }

            function toggleVendorSelectionOld(vendorId, serviceName, servicePrice) {
                console.log('🔘 toggleVendorSelection called:', { vendorId, serviceName, servicePrice });
                
                // Initialize service-specific structure if not exists
                if (!window.bookingState.selectedVendorsByService) {
                    window.bookingState.selectedVendorsByService = {};
                }
                if (!window.bookingState.selectedVendorsByService[serviceName]) {
                    window.bookingState.selectedVendorsByService[serviceName] = [];
                }
                
                const serviceVendors = window.bookingState.selectedVendorsByService[serviceName];
                const isSelected = serviceVendors.some(v => {
                    const vId = v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id;
                    return String(vId) === String(vendorId);
                });
                
                // Find vendor card
                let vendorCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
                let selectButton = vendorCard?.querySelector('.btn-select-vendor');
                
                if (isSelected) {
                    // Deselect vendor for this service
                    window.bookingState.selectedVendorsByService[serviceName] = serviceVendors.filter(v => {
                        const vId = v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id;
                        return String(vId) !== String(vendorId);
                    });
                    
                    // Update UI for vendor card if found
                    if (vendorCard && selectButton) {
                        // Only remove selected state if vendor is not selected for any other service
                        const isSelectedForOtherServices = Object.keys(window.bookingState.selectedVendorsByService)
                            .filter(service => service !== serviceName)
                            .some(service => 
                                window.bookingState.selectedVendorsByService[service].some(v => {
                                    const vId = v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id;
                                    return String(vId) === String(vendorId);
                                })
                            );
                        
                        if (!isSelectedForOtherServices) {
                            vendorCard.classList.remove('selected');
                            selectButton.classList.remove('selected');
                            selectButton.textContent = 'Select Vendor';
                        }
                    }
                    
                    console.log(`✅ Deselected vendor ${vendorId} for ${serviceName}`);
                } else {
                    // Select vendor for this service
                    const vendor = bookingState.availableVendors?.find(v => {
                        const vId = v.VendorProfileID || v.vendor?.VendorProfileID || v.id || v.vendor?.id;
                        return String(vId) === String(vendorId);
                    });
                    
                    if (vendor) {
                        const vendorSelection = {
                            VendorProfileID: vendorId,
                            vendorId: vendorId,
                            businessName: vendor.BusinessName || vendor.vendor?.BusinessName || vendor.name,
                            serviceName: serviceName,
                            servicePrice: servicePrice,
                            vendorData: vendor
                        };
                        
                        window.bookingState.selectedVendorsByService[serviceName].push(vendorSelection);
                        
                        // Update UI for vendor card if found
                        if (vendorCard && selectButton) {
                            vendorCard.classList.add('selected');
                            selectButton.classList.add('selected');
                            selectButton.textContent = 'Selected';
                        }
                        
                        console.log(`✅ Selected vendor ${vendorId} for ${serviceName}:`, vendorSelection);
                    }
                }
                
                // Update checkbox visual state for all vendor cards with this vendorId
                const allVendorCheckboxes = document.querySelectorAll(`[data-vendor-id="${vendorId}"] .vendor-checkbox`);
                allVendorCheckboxes.forEach(checkbox => {
                    // Check if vendor is selected for current active service
                    const activeTab = document.querySelector('.service-tab.active');
                    const currentServiceId = activeTab ? activeTab.getAttribute('data-service-id') : serviceName;
                    
                    // For specific service tabs, check if vendor is selected for that service
                    const serviceVendors = window.bookingState.selectedVendorsByService[currentServiceId] || [];
                    const shouldBeChecked = serviceVendors.some(v => {
                        const vId = v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id;
                        return String(vId) === String(vendorId);
                    });
                    
                    if (shouldBeChecked) {
                        checkbox.classList.add('checked');
                        checkbox.innerHTML = '<i class="fas fa-check"></i>';
                    } else {
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                    }
                });
                
                // Update button states in vendor cards
                const allButtons = document.querySelectorAll(`button[onclick*="toggleVendorSelection('${vendorId}', '${serviceName}'"]`);
                allButtons.forEach(btn => {
                    if (!isSelected) { // After selection (isSelected was false, now true)
                        btn.textContent = `Selected for ${serviceName}`;
                        btn.classList.add('selected');
                    } else { // After deselection (isSelected was true, now false)
                        btn.textContent = `Select for ${serviceName}`;
                        btn.classList.remove('selected');
                    }
                });
                
                // Update regular vendor card buttons
                vendorCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
                if (vendorCard) {
                    const selectButton = vendorCard.querySelector('.btn-select-vendor');
                    if (selectButton && !selectButton.onclick.toString().includes('toggleVendorSelection')) {
                        // For general select buttons, keep them as "Select for All Services"
                        selectButton.textContent = 'Select for All Services';
                        selectButton.classList.remove('selected');
                    }
                }

                // Calculate total selected vendors across all services
                const totalSelected = Object.values(window.bookingState.selectedVendorsByService)
                    .reduce((total, vendors) => total + vendors.length, 0);

                // Enable/disable send requests button
                const sendRequestsBtn = document.getElementById('send-requests-btn');
                if (sendRequestsBtn) {
                    sendRequestsBtn.disabled = totalSelected === 0;
                }
                
                // Update selected vendors summary
                updateSelectedVendorsSummary();
                
                console.log('📊 Current selections by service:', window.bookingState.selectedVendorsByService);
            }
            
            // Function to render selected vendors summary on Step 4
            window.updateSelectedVendorsSummary = function updateSelectedVendorsSummary() {
                const summaryContainer = document.getElementById('selected-vendors-summary');
                if (!summaryContainer) return;
                
                // Always use the global bookingState
                const globalBookingState = window.bookingState || { selectedVendors: [] };
                
                console.log('🔄 Updating selected vendors summary, count:', globalBookingState.selectedVendors?.length || 0);
                console.log('🔄 globalBookingState:', globalBookingState);
                console.log('🔄 selectedVendors array:', globalBookingState.selectedVendors);
                
                if (!globalBookingState.selectedVendorsByService || Object.keys(globalBookingState.selectedVendorsByService).length === 0) {
                    summaryContainer.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">No vendors selected yet.</p>';
                    return;
                }
                
                // Calculate total cost from service-specific selections
                const totalCost = Object.values(globalBookingState.selectedVendorsByService || {}).reduce((total, serviceVendors) => {
                    return total + serviceVendors.reduce((serviceSum, vendor) => {
                        return serviceSum + (vendor.servicePrice || 0);
                    }, 0);
                }, 0);
                
                // Calculate total vendor count across all services
                const totalVendorCount = Object.values(globalBookingState.selectedVendorsByService || {}).reduce((count, serviceVendors) => {
                    return count + serviceVendors.length;
                }, 0);

                // Transparent fee estimates for client - use environment config ONLY
                const platformFeePercent = Number(window.PLATFORM_FEE_PERCENT);
                const stripeProcFeePercent = Number(window.STRIPE_PROC_FEE_PERCENT);
                const stripeProcFeeFixed = Number(window.STRIPE_PROC_FEE_FIXED);
                
                // Calculate fees using environment values
                const platformFee = +(totalCost * (platformFeePercent / 100)).toFixed(2);
                const stripeFee = +((totalCost * (stripeProcFeePercent / 100)) + (stripeProcFeeFixed * totalVendorCount)).toFixed(2);
                const grandTotal = +(totalCost + platformFee + stripeFee).toFixed(2);
                const fmt = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // Build Step 3-style horizontal cards for selected vendors
                const vendorCardsHTML = `
                    <div style="margin-bottom: 2rem;">
                        <!-- Per-vendor special requests are now in each card's right panel -->

                        <!-- Review-only styling: disable vendor card hover animations within this area -->
                        <style>
                            #selected-vendor-horizontal-cards .vendor-card,
                            #selected-vendor-horizontal-cards .vendor-card:hover,
                            #selected-vendor-horizontal-cards .selected-vendor-card-wrapper:hover .vendor-card,
                            #selected-vendor-horizontal-cards .vendor-card:focus,
                            #selected-vendor-horizontal-cards .vendor-card:active,
                            #selected-vendor-horizontal-cards .vendor-card:focus-visible,
                            #selected-vendor-horizontal-cards .vendor-image img,
                            #selected-vendor-horizontal-cards .vendor-card:hover .vendor-image img {
                                transition: none !important;
                                transform: none !important;
                                box-shadow: none !important;
                                border: none !important; /* absolutely no border */
                                background: #ffffff !important;   /* fixed neutral bg */
                                cursor: default !important;
                                will-change: auto !important;
                            }

                            /* Absolutely disable any transitions/animations for all nested elements */
                            #selected-vendor-horizontal-cards,
                            #selected-vendor-horizontal-cards * {
                                transition: none !important;
                                animation: none !important;
                            }
                            #selected-vendor-horizontal-cards .selected-vendor-card-left *:hover,
                            #selected-vendor-horizontal-cards .selected-vendor-card-left *:focus,
                            #selected-vendor-horizontal-cards .selected-vendor-card-left *:active,
                            #selected-vendor-horizontal-cards .selected-vendor-card-left *:focus-visible {
                                transform: none !important;
                                box-shadow: none !important;
                                filter: none !important;
                                background: transparent !important;
                                border-color: currentColor !important;
                                outline: none !important;
                            }

                            /* Do not allow hover interactions on the left visual/card area in Review */
                            #selected-vendor-horizontal-cards .selected-vendor-card-left {
                                pointer-events: none !important;
                            }

                            /* Disable all interactions on the entire vendor card to prevent any hover effects */
                            #selected-vendor-horizontal-cards .vendor-card,
                            #selected-vendor-horizontal-cards .vendor-card * {
                                pointer-events: none !important;
                            }
                            /* Preserve interactions on the right Request panel */
                            #selected-vendor-horizontal-cards .selected-vendor-actions-right,
                            #selected-vendor-horizontal-cards .selected-vendor-actions-right * {
                                pointer-events: auto !important;
                            }

                            /* Neutralize link hover styling inside Review */
                            #selected-vendor-horizontal-cards a,
                            #selected-vendor-horizontal-cards a:hover,
                            #selected-vendor-horizontal-cards a:focus,
                            #selected-vendor-horizontal-cards a:active {
                                color: inherit !important;
                                text-decoration: none !important;
                            }
                            /* Ensure Send Request button keeps primary color and does not disappear on hover */
                            #selected-vendor-horizontal-cards .selected-vendor-actions-right .btn-send-request,
                            #selected-vendor-horizontal-cards .selected-vendor-actions-right .btn-send-request:hover,
                            #selected-vendor-horizontal-cards .selected-vendor-actions-right .btn-send-request:focus {
                                background: var(--primary) !important;
                                color: #ffffff !important;
                                border: 1px solid var(--primary) !important;
                            }
                        </style>

                        <!-- Horizontal vendor cards grouped by service -->
                        <div id="selected-vendor-horizontal-cards" class="vendor-horizontal-container">
                            ${Object.entries(globalBookingState.selectedVendorsByService || {}).map(([serviceId, serviceVendors]) => {
                                if (!serviceVendors || serviceVendors.length === 0) return '';
                                
                                const serviceName = serviceVendors[0]?.serviceName || serviceId;
                                
                                return `
                                    <div class="service-group-section" style="margin: 0.75rem 0 0.75rem;">
                                        <div class="service-header" style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem;">
                                            <div style="font-size:0.8rem; color:#6b7280; font-weight:600;">${serviceName}</div>
                                        </div>
                                        <div style="height:1px; background:#e5e7eb; margin:0.4rem 0 0.65rem 0;"></div>
                                        <div class="service-vendors-container" style="padding: 0;">
                                            ${serviceVendors.map((entry, serviceIndex) => {
                                // Prefer full vendor object if stored; otherwise resolve from availableVendors
                                const av = (window.bookingState && Array.isArray(window.bookingState.availableVendors)) ? window.bookingState.availableVendors : [];
                                const entryId = entry.VendorProfileID || entry.vendorProfileId || entry.vendorId || entry.id;
                                const resolved = av.find(v => {
                                    const vId = v.VendorProfileID || v.vendorProfileId || v.id;
                                    return String(vId) === String(entryId);
                                });
                                // Merge precedence: resolved vendor data > entry.vendorData > entry (to keep selection fields too)
                                const base = { ...(entry || {}), ...(entry.vendorData || {}), ...(resolved || {}) };

                                // Resolve vendor id consistently and ensure not empty (needed for carousel ids)
                                let vendorId = base.VendorProfileID || base.vendorProfileId || base.id || entry.vendorId || entry.id;
                                if (!vendorId) {
                                    vendorId = `selected-${serviceIndex}`;
                                }

                                // Normalize core fields for the card
                                const normalized = {
                                    ...base,
                                    // IDs for createHorizontalVendorCard and data-vendor-id
                                    // Use unique VendorProfileID for Step 5 to avoid ID collisions
                                    id: base.id || entry.id || entry.vendorId || vendorId,
                                    vendorProfileId: (base.vendorProfileId || base.VendorProfileID || entry.vendorId || vendorId) + '-s5-' + serviceId,
                                    VendorProfileID: (base.VendorProfileID || base.vendorProfileId || entry.vendorId || vendorId) + '-s5-' + serviceId,
                                    __realVendorId: vendorId,
                                    __context: 'review',
                                    // Core display fields
                                    BusinessName: base.BusinessName || base.businessName || base.name || entry.name || 'Unknown Business',
                                    Location: base.Location || base.location || entry.location || '',
                                    BusinessDescription: base.BusinessDescription || base.description || entry.description || '',
                                };

                                // Normalize images so carousel can render (gather from many possible fields)
                                const images = [];
                                const pushIf = (val) => { if (val && typeof val === 'string') images.push(val.trim()); };
                                const urlFrom = (obj) => {
                                    if (!obj) return null;
                                    if (typeof obj === 'string') return obj;
                                    const cand = obj.ImageURL || obj.ImageUrl || obj.URL || obj.Url || obj.url || obj.src || obj.image || obj.Path || obj.ImagePath || obj.path;
                                    return typeof cand === 'string' ? cand : null;
                                };
                                // Common fields
                                pushIf(base.FeaturedImageURL || base.featuredImageUrl || base.profileImageUrl || base.ProfileImageUrl || base.ProfileImageURL);
                                if (Array.isArray(base.images)) images.push(...base.images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
                                if (Array.isArray(base.Images)) images.push(...base.Images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
                                if (Array.isArray(base.VendorImages)) images.push(...base.VendorImages.map(img => urlFrom(img)).filter(Boolean));
                                if (Array.isArray(base.GalleryImages)) images.push(...base.GalleryImages.map(img => urlFrom(img)).filter(Boolean));
                                if (Array.isArray(base.Photos)) images.push(...base.Photos.map(img => urlFrom(img)).filter(Boolean));
                                if (Array.isArray(base.photoUrls)) images.push(...base.photoUrls);
                                // Comma-separated string of URLs
                                if (typeof base.ImageURLs === 'string') {
                                    images.push(...base.ImageURLs.split(',').map(s => s.trim()));
                                }
                                if (typeof base.imageUrls === 'string') {
                                    images.push(...base.imageUrls.split(',').map(s => s.trim()));
                                }
                                // Individual fields image1..image5
                                ['image1','image2','image3','image4','image5','Image1','Image2','Image3','Image4','Image5'].forEach(k => {
                                    if (base[k]) images.push(base[k]);
                                });
                                // De-duplicate
                                normalized.images = [...new Set(images.filter(Boolean))];
                                console.log('🖼️ Step 4 images collected for vendor', vendorId, normalized.images);
                                if (!normalized.FeaturedImageURL && normalized.images.length > 0) {
                                    normalized.FeaturedImageURL = normalized.images[0];
                                }

                                // Create service-specific inferred service for this vendor
                                const serviceSpecificService = {
                                    ServiceName: entry.serviceName || serviceName,
                                    VendorPrice: entry.servicePrice || 0,
                                    VendorDurationMinutes: entry.selectedService?.VendorDurationMinutes
                                };
                                
                                // Prepend service-specific service to services array
                                // In Review, show ONLY the selected service for this vendor
                                normalized.services = [serviceSpecificService];

                                // Provide service names for tags
                                if (!normalized.MatchingServiceNames) {
                                    normalized.MatchingServiceNames = [serviceName];
                                }

                                const card = (typeof createHorizontalVendorCard === 'function') ? createHorizontalVendorCard(normalized) : '';
                                const uniqueIndex = `${serviceId}-${serviceIndex}`;
                                
                                return `
                                    <div class="selected-vendor-card-wrapper" data-selected-index="${uniqueIndex}" style="display:flex; gap:1rem; align-items:stretch; margin-bottom: 1rem;">
                                        <div class="selected-vendor-card-left" style="flex:1; position:relative;">
                                            ${card}
                                        </div>
                                        <div class="selected-vendor-actions-right" style="width:320px; min-width:300px; background:transparent; border:none; box-shadow:none; padding:0.5rem 0 0.5rem 1rem; display:flex; flex-direction:column; gap:0.75rem;">
                                                <h6 style="margin:0; color:#2c3e50; font-weight:600;">Special Request for ${serviceName}</h6>
                                            <textarea id="special-requests-${uniqueIndex}" placeholder="Write a message to this vendor for ${serviceName}..." style="flex:1; min-height:120px; padding:0.75rem; border:1px solid #e1e8f0; border-radius:8px; font-family:inherit; font-size:0.9rem; resize:vertical;"></textarea>
                                            <div style="font-size: 0.8rem; color:#6b7280; line-height:1.35; padding: 0.25rem 0.25rem 0.25rem 0;">
                                                By clicking '<strong>Send Request</strong>', you agree that your information will be shared with the vendor. Please see our <a href="#" style="color: var(--primary); text-decoration: none;">Privacy Policy</a> and <a href="#" style="color: var(--primary); text-decoration: none;">Terms of Use</a> for details.
                                            </div>
                                            <button onclick="sendBookingRequest('${vendorId}', '${uniqueIndex}', '${serviceId}')"
                                                class="btn btn-primary btn-send-request"
                                                style="border:none; padding:0.6rem 1rem; border-radius:8px; font-weight:600; cursor:pointer;">
                                                <i class="fas fa-paper-plane" style="margin-right:0.4rem;"></i>Send Request for ${serviceName}
                                            </button>
                                            <div class="request-status" id="request-status-${uniqueIndex}" style="display:none; padding:0.6rem; border-radius:8px;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Summary Footer -->
                        <div style="background: #f8faff; border: 1px solid #e1e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; margin-top:1rem;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.75rem;">Estimated Cost Breakdown</div>
                            <div style="display:flex; justify-content:center;">
                                <div style="display:inline-block; width:100%; max-width:520px; text-align:left;">
                                    <div style="display:flex; justify-content:space-between; padding:6px 0;">
                                        <span>Services Subtotal</span>
                                        <strong>$${fmt(totalCost)}</strong>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; padding:6px 0;">
                                        <span>Platform fee (${platformFeePercent}%)</span>
                                        <strong>$${fmt(platformFee)}</strong>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; padding:6px 0;">
                                        <span>Processing fees <span style="color:#6b7280; font-weight:400;">(from Stripe)</span></span>
                                        <strong>$${fmt(stripeFee)}</strong>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-top:2px solid #e5e7eb; margin-top:6px; font-size:1.05rem;">
                                        <span>Estimated Grand Total</span>
                                        <strong style="color:#27ae60;">$${fmt(grandTotal)}</strong>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
                                ${totalVendorCount} vendor${totalVendorCount !== 1 ? 's' : ''} selected across ${Object.keys(globalBookingState.selectedVendorsByService || {}).length} service${Object.keys(globalBookingState.selectedVendorsByService || {}).length !== 1 ? 's' : ''}
                            </div>
                        </div>
                    </div>
                `;

                summaryContainer.innerHTML = vendorCardsHTML;

                // Initialize carousels for the newly injected cards in Step 4
                setTimeout(() => {
                    try {
                        const vendorCards = document.querySelectorAll('#selected-vendor-horizontal-cards .vendor-horizontal-card');
                        vendorCards.forEach(card => {
                            const vendorId = card.getAttribute('data-vendor-id');
                            // Remove only the Select/Selected button that toggles vendor selection
                            const toggleBtn = card.querySelector('button[onclick*="toggleVendorSelection"]');
                            if (toggleBtn) {
                                toggleBtn.parentElement?.removeChild(toggleBtn);
                            }
                            // Initialize carousel
                            if (vendorId && typeof initializeVendorCarousel === 'function') {
                                initializeVendorCarousel(vendorId);
                            }
                        });
                    } catch (e) {
                        console.warn('Step 4 post-processing failed:', e);
                    }
                }, 100);
            };

            // Function to send booking request to vendor
            window.sendBookingRequest = function(vendorId, uniqueIndex, serviceId) {
                console.log('📤 Sending booking request to vendor:', vendorId, 'for service:', serviceId, 'unique index:', uniqueIndex);
                
                // Check if user is authenticated
                console.log('🔐 Current user:', currentUser);
                
                if (!currentUser || !currentUser.userId) {
                    console.log('❌ User not authenticated, showing auth modal');
                    showAuthModal();
                    return;
                }
                
                console.log('✅ User authenticated, proceeding with request');
                
                // Read service-specific special requests textarea
                const perVendorTextarea = document.getElementById(`special-requests-${uniqueIndex}`);
                const specialRequests = perVendorTextarea?.value || '';
                const bookingState = window.bookingState;
                
                // Find vendor in service-specific selections
                const serviceVendors = bookingState.selectedVendorsByService?.[serviceId] || [];
                const vendor = serviceVendors.find(v => {
                    const vId = v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id;
                    return String(vId) === String(vendorId);
                });
                
                if (!vendor) {
                    console.error('❌ Vendor not found for service:', serviceId, 'vendorId:', vendorId);
                    return;
                }
                
                // Update button state to loading
                const button = document.querySelector(`button[onclick="sendBookingRequest('${vendorId}', '${uniqueIndex}', '${serviceId}')"]`);
                if (button) {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Sending...';
                    button.disabled = true;
                    button.style.background = '#95a5a6';
                }
                
                // Show status area
                const statusDiv = document.getElementById(`request-status-${uniqueIndex}`);
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<div style="color: #3498db;"><i class="fas fa-clock" style="margin-right: 0.5rem;"></i>Sending request...</div>';
                    statusDiv.style.background = '#e8f4fd';
                    statusDiv.style.border = '1px solid #3498db';
                }
                
                // Collect current event details from form (mimicking handleSendRequests)
                const eventDetails = {
                    name: (document.getElementById('event-name')?.value || '').trim(),
                    type: document.getElementById('event-type')?.value || '',
                    date: document.getElementById('event-date')?.value,
                    startTime: document.getElementById('event-start-time')?.value,
                    endTime: document.getElementById('event-end-time')?.value,
                    location: document.getElementById('event-location')?.value,
                    attendeeCount: parseInt(document.getElementById('attendee-count')?.value) || 50,
                    timezone: (document.getElementById('event-timezone')?.value || '').trim()
                };

                // Format time for backend (mimicking handleSendRequests)
                const formattedTime = formatTimeForBackend(eventDetails.startTime);

                // Prepare booking request data using service-specific vendor data
                const requestData = {
                    userId: currentUser.userId || currentUser.id,
                    vendorIds: [parseInt(vendorId)],
                    services: (() => {
                        const svc = (window.bookingState?.selectedPredefinedServices || []).find(s => String(s.id) === String(serviceId));
                        return [{
                            vendorId: parseInt(vendorId),
                            serviceName: vendor.serviceName || serviceId,
                            servicePrice: vendor.servicePrice || 0,
                            startTime: svc?.startTime ? formatTimeForBackend(svc.startTime) : undefined,
                            endTime: svc?.endTime ? formatTimeForBackend(svc.endTime) : undefined,
                            durationMinutes: Number(svc?.duration) || undefined,
                            budget: Number(svc?.budget) || undefined
                        }];
                    })(),
                    eventDetails: {
                        ...eventDetails,
                        time: formattedTime,
                        specialRequests: specialRequests
                    },
                    budget: vendor.servicePrice || 0
                };
                
                console.log('📋 Request data:', requestData);
                console.log('🌐 About to make API call to:', 'https://bdb-3-0-venuevue-api.onrender.com/api/bookings/requests');
                
                // Make actual API call
                fetch('https://bdb-3-0-venuevue-api.onrender.com/api/bookings/requests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token || ''}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('📡 API Response received:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 API Response data:', data);
                    if (data.success) {
                        // Success
                        if (button) {
                            button.innerHTML = '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>Request Sent!';
                            button.style.background = '#27ae60';
                            button.disabled = true;
                        }
                        
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <div style="color: #27ae60;">
                                    <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                                    Booking request sent successfully! Request ID: ${data.requestId}. The vendor will respond within 24 hours.
                                </div>
                            `;
                            statusDiv.style.background = '#d5f4e6';
                            statusDiv.style.border = '1px solid #27ae60';
                        }
                        
                        // Mark vendor as requested in bookingState
                        vendor.requestSent = true;
                        vendor.requestTimestamp = new Date().toISOString();
                        vendor.requestId = data.requestId;
                        
                    } else {
                        throw new Error(data.message || 'Failed to send request');
                    }
                })
                .catch(error => {
                    console.error('❌ Error sending request:', error);
                    
                    // Error state
                    if (button) {
                        button.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>Try Again';
                        button.style.background = '#e74c3c';
                        button.disabled = false;
                    }
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div style="color: #e74c3c;">
                                <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
                                Failed to send request: ${error.message}
                            </div>
                        `;
                        statusDiv.style.background = '#fdf2f2';
                        statusDiv.style.border = '1px solid #e74c3c';
                    }
                });
            };

            // Authentication helper functions
            function getCurrentUser() {
                // Check for user session in localStorage or sessionStorage
                const userSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
                console.log('🔍 Raw userSession from localStorage:', userSession);
                console.log('🔍 localStorage.getItem("userSession"):', localStorage.getItem('userSession'));
                
                if (userSession) {
                    try {
                        const parsed = JSON.parse(userSession);
                        console.log('✅ Parsed user session:', parsed);
                        return parsed;
                    } catch (e) {
                        console.error('❌ Error parsing user session:', e);
                        return null;
                    }
                }
                console.log('❌ No user session found');
                return null;
            }

            function showAuthModal() {
                // Create authentication modal
                const authModal = document.createElement('div');
                authModal.id = 'auth-modal';
                authModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                authModal.innerHTML = `
                    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;">
                        <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">Sign In Required</h3>
                        <p style="margin: 0 0 1.5rem 0; color: #6b7280;">You need to sign in to send booking requests to vendors.</p>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="showLoginForm()" style="background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Sign In
                            </button>
                            <button onclick="showSignupForm()" style="background: #27ae60; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Sign Up
                            </button>
                            <button onclick="closeAuthModal()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(authModal);
            }

            window.closeAuthModal = function() {
                const authModal = document.getElementById('auth-modal');
                if (authModal) {
                    authModal.remove();
                }
            };

            window.showLoginForm = function() {
                closeAuthModal();
                // Redirect to login page or show login form
                alert('Please implement login functionality. For now, you can manually set user session in localStorage.');
                console.log('To test booking requests, set user session in console:');
                console.log('localStorage.setItem("userSession", JSON.stringify({userId: 1, token: "test-token", name: "Test User"}))');
            };

            window.showSignupForm = function() {
                closeAuthModal();
                // Redirect to signup page or show signup form
                alert('Please implement signup functionality. For now, you can manually set user session in localStorage.');
                console.log('To test booking requests, set user session in console:');
                console.log('localStorage.setItem("userSession", JSON.stringify({userId: 1, token: "test-token", name: "Test User"}))');
            };

            // Helper function to format time to HH:MM:SS
            function formatTimeForBackend(timeStr) {
                if (!timeStr) return '12:00:00'; // Default to noon if no time provided
                
                // If time is already in HH:MM:SS format, return as is
                if (timeStr.match(/^\d{2}:\d{2}:\d{2}$/)) {
                    return timeStr;
                }
                
                // If time is in HH:MM format, add seconds
                if (timeStr.match(/^\d{1,2}:\d{2}$/)) {
                    const [hours, minutes] = timeStr.split(':');
                    return `${hours.padStart(2, '0')}:${minutes}:00`;
                }
                
                // Fallback to default time
                return '12:00:00';
            }

            // Booking-specific error handler
            function showBookingError(message) {
                const errorContainer = document.getElementById('booking-error-container') || createBookingErrorContainer();
                errorContainer.innerHTML = `
                    <div class="alert alert-error" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; color: var(--accent);">
                        <strong>Error:</strong> ${message}
                    </div>
                `;
                errorContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function createBookingErrorContainer() {
                const container = document.createElement('div');
                container.id = 'booking-error-container';
                const modalBody = document.querySelector('#booking-modal .modal-body');
                modalBody.insertBefore(container, modalBody.firstChild);
                return container;
            }

            function clearBookingError() {
                const errorContainer = document.getElementById('booking-error-container');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }

            async function handleSendRequests() {
                clearBookingError();
                
                // Collect current event details from form before validation
                const eventDetails = {
                    date: document.getElementById('event-date')?.value,
                    startTime: document.getElementById('event-start-time')?.value,
                    endTime: document.getElementById('event-end-time')?.value,
                    location: document.getElementById('event-location')?.value,
                    attendeeCount: parseInt(document.getElementById('attendee-count')?.value) || 50,
                    timezone: (document.getElementById('event-timezone')?.value || '').trim(),
                    name: (document.getElementById('event-name')?.value || '').trim(),
                    type: document.getElementById('event-type')?.value || ''
                };
                
                // Use the global bookingState where vendors are actually stored
                const globalBookingState = window.bookingState || bookingState;
                
                // Update event details in global state
                if (!globalBookingState.eventDetails) {
                    globalBookingState.eventDetails = {};
                }
                Object.assign(globalBookingState.eventDetails, eventDetails);
                
                console.log('🔍 Debug - globalBookingState:', globalBookingState);
                console.log('🔍 Debug - selectedVendors:', globalBookingState.selectedVendors);
                console.log('🔍 Debug - selectedVendors length:', globalBookingState.selectedVendors?.length);
                console.log('🔍 Debug - eventDetails:', globalBookingState.eventDetails);
                console.log('🔍 Debug - startTime:', globalBookingState.eventDetails?.startTime);
                
                // Debug each selected vendor structure
                globalBookingState.selectedVendors?.forEach((vendor, index) => {
                    console.log(`🔍 Debug - vendor[${index}]:`, vendor);
                    console.log(`🔍 Debug - vendor[${index}].id:`, vendor.id);
                    console.log(`🔍 Debug - vendor[${index}].vendorData:`, vendor.vendorData);
                    console.log(`🔍 Debug - vendor[${index}].vendorData?.VendorProfileID:`, vendor.vendorData?.VendorProfileID);
                });
                
                if (!globalBookingState.selectedVendors || globalBookingState.selectedVendors.length === 0) {
                    showBookingError('Please select at least one vendor.');
                    return;
                }

                // Check if user is authenticated
                if (!currentUser?.userId && !currentUser?.id) {
                    showBookingError('Please log in to send booking requests. Run this in console: localStorage.setItem("token", "test-token")');
                    return;
                }

                // Validate and format time
                if (!globalBookingState.eventDetails?.startTime) {
                    console.log('🚨 Event time validation failed - eventDetails:', globalBookingState.eventDetails);
                    console.log('🚨 Start time value:', globalBookingState.eventDetails?.startTime);
                    showBookingError('Please select an event time.');
                    return;
                }

                const formattedTime = formatTimeForBackend(globalBookingState.eventDetails.startTime);

                try {
                    // Prepare vendor IDs and services data
                    const vendorIds = globalBookingState.selectedVendors
                        .map(v => v.VendorProfileID || v.vendorProfileId || v.VendorProfileId || v.id || v.vendorId)
                        .filter(id => id != null);
                    
                    const selectedServicesList = Array.isArray(window.bookingState?.selectedPredefinedServices)
                        ? window.bookingState.selectedPredefinedServices
                        : [];
                    const services = globalBookingState.selectedVendors.map(v => {
                        const vendorId = v.VendorProfileID || v.vendorProfileId || v.VendorProfileId || v.id || v.vendorId;
                        const serviceName = v.selectedService?.ServiceName || v.serviceName || v.MatchingServiceNames || 'General Service';
                        const svcInfo = selectedServicesList.find(s => (s.name || '').toLowerCase() === (serviceName || '').toLowerCase());
                        return {
                            vendorId,
                            serviceName,
                            servicePrice: v.selectedService?.VendorPrice || v.servicePrice || v.VendorPrice || 0,
                            startTime: svcInfo?.startTime ? formatTimeForBackend(svcInfo.startTime) : undefined,
                            endTime: svcInfo?.endTime ? formatTimeForBackend(svcInfo.endTime) : undefined,
                            durationMinutes: Number(svcInfo?.duration) || undefined,
                            budget: Number(svcInfo?.budget) || undefined
                        };
                    }).filter(s => s.vendorId != null);

                    console.log('🔍 Debug - vendorIds:', vendorIds);
                    console.log('🔍 Debug - services:', services);

                    if (vendorIds.length === 0) {
                        showBookingError('No valid vendor IDs found. Please reselect your vendors.');
                        return;
                    }

                    // Send booking requests to backend API
                    const requestData = {
                        userId: currentUser.userId || currentUser.id,
                        vendorIds: vendorIds,
                        services: services,
                        eventDetails: {
                            ...globalBookingState.eventDetails,
                            time: formattedTime
                        },
                        budget: globalBookingState.budget
                    };

                    console.log('📤 Sending bulk booking request:', requestData);
                    
                    const response = await fetch(`${API_BASE_URL}/bookings/requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    const data = await response.json();
                    console.log('📊 API Response:', data);

                    if (data.success && data.requests) {
                        // Map API response to booking state format
                        globalBookingState.sentRequests = data.requests.map(req => ({
                            id: req.requestId,
                            vendorId: req.vendorId,
                            vendorName: globalBookingState.selectedVendors.find(v => v.id === req.vendorId)?.name || 'Vendor',
                            status: req.status,
                            sentAt: new Date(req.createdAt),
                            expiresAt: new Date(req.expiresAt),
                            services: globalBookingState.selectedServices,
                            eventDetails: globalBookingState.eventDetails
                        }));

                        renderRequestSummary();
                        updateBookingStep(5);
                        
                        // Start polling for approval updates
                        startApprovalPolling();
                    } else {
                        throw new Error(data.message || 'Failed to send requests');
                    }

                } catch (error) {
                    console.error('Error sending requests:', error);
                    showBookingError('Failed to send booking requests. Please try again.');
                }
            }

            function renderRequestSummary() {
                const requestSummary = document.getElementById('request-summary');
                
                const summaryHtml = bookingState.sentRequests.map(request => `
                    <div class="request-item">
                        <div class="request-header">
                            <h5>${request.vendorName}</h5>
                            <span class="request-status ${request.status}">${request.status.toUpperCase()}</span>
                        </div>
                        <p><strong>Services:</strong> ${request.services.map(s => s.type).join(', ')}</p>
                        <p><strong>Event Date:</strong> ${request.eventDetails.date} at ${request.eventDetails.time}</p>
                        <div class="countdown-timer" id="timer-${request.id}">
                            <span><i class="fas fa-clock"></i></span>
                            <span>Expires in: <span class="time-remaining">24:00:00</span></span>
                        </div>
                    </div>
                `).join('');

                requestSummary.innerHTML = summaryHtml;

                // Start countdown timers
                window.bookingState.sentRequests.forEach(request => {
                    startCountdownTimer(request.id, request.expiresAt);
                });
            }

            function startCountdownTimer(requestId, expiresAt) {
                const timerElement = document.getElementById(`timer-${requestId}`);
                if (!timerElement) return;

                const timer = setInterval(() => {
                    const now = new Date().getTime();
                    const expiry = new Date(expiresAt).getTime();
                    const timeLeft = expiry - now;

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        const timeDisplay = timerElement.querySelector('.time-remaining');
                        if (timeDisplay) {
                            timeDisplay.textContent = 'EXPIRED';
                            timerElement.classList.add('urgent');
                        }
                        return;
                    }

                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                    const timeDisplay = timerElement.querySelector('.time-remaining');
                    if (timeDisplay) {
                        timeDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Add urgent class if less than 2 hours remaining
                        if (timeLeft < 2 * 60 * 60 * 1000) {
                            timerElement.classList.add('urgent');
                        }
                    }
                }, 1000);

                window.bookingState.countdownTimers[requestId] = timer;
            }

            // Approval polling and real-time updates
            function startApprovalPolling() {
                // Poll for approval updates every 30 seconds
                const pollInterval = setInterval(async () => {
                    if (bookingState.currentStep !== 5 && bookingState.currentStep !== 4) {
                        clearInterval(pollInterval);
                        return;
                    }

                    try {
                        await checkApprovalUpdates();
                    } catch (error) {
                        console.error('Error polling for approvals:', error);
                    }
                }, 30000);

                // Store interval for cleanup
                window.bookingState.approvalPollingInterval = pollInterval;
            }

            async function checkApprovalUpdates() {
                if (!currentUser?.id) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/bookings/requests/${currentUser.id}`);
                    const data = await response.json();
                    console.log('📊 API Response:', data);

                    if (data.success && data.requests) {
                        // Update request statuses
                        window.bookingState.sentRequests.forEach(sentRequest => {
                            const updatedRequest = data.requests.find(r => r.RequestID === sentRequest.id);
                            if (updatedRequest && updatedRequest.Status !== sentRequest.status) {
                                sentRequest.status = updatedRequest.Status;
                                sentRequest.responseMessage = updatedRequest.ResponseMessage;
                                sentRequest.proposedPrice = updatedRequest.ProposedPrice;
                            }
                        });

                        // Update approved vendors
                        window.bookingState.approvedVendors = bookingState.sentRequests
                            .filter(req => req.status === 'approved')
                            .map(req => ({
                                id: req.vendorId,
                                name: req.vendorName,
                                proposedPrice: req.proposedPrice || 0,
                                services: req.services
                            }));

                        // Calculate total cost
                        window.bookingState.totalCost = bookingState.approvedVendors.reduce((sum, vendor) => 
                            sum + (vendor.proposedPrice || 0), 0
                        );

                        // Update UI if on approval step
                        if (bookingState.currentStep === 5) {
                            renderApprovalStatus();
                        }

                        // Check if we can proceed to payment
                        const hasAllApprovals = bookingState.approvedVendors.length > 0;
                        const proceedButton = document.getElementById('proceed-to-payment');
                        if (proceedButton) {
                            proceedButton.disabled = !hasAllApprovals;
                        }
                    }
                } catch (error) {
                    console.error('Error checking approval updates:', error);
                }
            }

            function renderApprovalStatus() {
                const approvalStatus = document.getElementById('approval-status');
                if (!approvalStatus) return;

                const statusHtml = bookingState.sentRequests.map(request => {
                    const statusClass = request.status === 'approved' ? 'approved' : 
                                       request.status === 'declined' ? 'declined' : 'pending';
                    
                    const timeRemaining = request.status === 'pending' ? 
                        getTimeRemaining(request.expiresAt) : null;

                    return `
                        <div class="request-item">
                            <div class="request-header">
                                <h5>${request.vendorName}</h5>
                                <span class="request-status ${statusClass}">
                                    ${request.status === 'approved' ? '<i class="fas fa-check-circle" style="color: #28a745;"></i> APPROVED' : 
                                      request.status === 'declined' ? '<i class="fas fa-times-circle" style="color: #dc3545;"></i> DECLINED' : 
                                      '<i class="fas fa-clock" style="color: #ffc107;"></i> PENDING'}
                                </span>
                            </div>
                            <p><strong>Services:</strong> ${request.services.map(s => s.type).join(', ')}</p>
                            ${request.proposedPrice ? `<p><strong>Proposed Price:</strong> $${request.proposedPrice.toLocaleString()}</p>` : ''}
                            ${request.responseMessage ? `<p><strong>Message:</strong> ${request.responseMessage}</p>` : ''}
                            ${timeRemaining ? `
                                <div class="countdown-timer ${timeRemaining.urgent ? 'urgent' : ''}">
                                    <span><i class="fas fa-clock"></i></span>
                                    <span>Expires in: ${timeRemaining.display}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                approvalStatus.innerHTML = statusHtml;
            }

            function getTimeRemaining(expiresAt) {
                const now = new Date().getTime();
                const expiry = new Date(expiresAt).getTime();
                const timeLeft = expiry - now;

                if (timeLeft <= 0) {
                    return { display: 'EXPIRED', urgent: true };
                }

                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                return {
                    display: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
                    urgent: timeLeft < 2 * 60 * 60 * 1000 // Less than 2 hours
                };
            }

            async function handleCompleteBooking() {
                try {
                    if (bookingState.approvedVendors.length === 0) {
                        showError('No approved vendors to book.');
                        return;
                    }

                    // Create payment intent with Stripe
                    const response = await fetch(`${API_BASE_URL}/bookings/create-payment-intent`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: bookingState.totalCost,
                            currency: 'usd'
                        })
                    });

                    const data = await response.json();

                    if (data.clientSecret) {
                        // Initialize Stripe Elements for payment
                        if (state.stripe && state.elements) {
                            const cardElement = state.elements.create('card');
                            cardElement.mount('#card-element');

                            // Handle form submission
                            const { error, paymentIntent } = await state.stripe.confirmCardPayment(data.clientSecret, {
                                payment_method: {
                                    card: cardElement,
                                    billing_details: {
                                        name: currentUser?.name || 'Customer'
                                    }
                                }
                            });

                            if (error) {
                                showError(`Payment failed: ${error.message}`);
                            } else if (paymentIntent.status === 'succeeded') {
                                // Create final bookings
                                await createFinalBookings(paymentIntent.id);
                                showSuccess('Booking completed successfully! You will receive confirmation emails shortly.');
                                closeBookingModal();
                            }
                        } else {
                            // Fallback to default categories if API fails
                            console.log('Processing payment:', { amount: bookingState.totalCost });
                            showSuccess('Booking completed successfully! You will receive confirmation emails shortly.');
                            closeBookingModal();
                        }
                    } else {
                        throw new Error('Failed to create payment intent');
                    }

                } catch (error) {
                    console.error('Error completing booking:', error);
                    showBookingError('Failed to complete booking. Please try again.');
                }
            }

            async function createFinalBookings(paymentIntentId) {
                // Create final bookings for approved vendors
                const bookingPromises = bookingState.approvedVendors.map(vendor => {
                    return fetch(`${API_BASE_URL}/bookings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            vendorProfileId: vendor.id,
                            eventDate: bookingState.eventDetails.date,
                            endDate: bookingState.eventDetails.date, // Same day for now
                            attendeeCount: bookingState.eventDetails.attendeeCount,
                            specialRequests: bookingState.eventDetails.specialRequests,
                            services: vendor.services,
                            paymentIntentId: paymentIntentId
                        })
                    });
                });

                await Promise.all(bookingPromises);
            }

            function renderBookingSummary() {
                const bookingSummary = document.getElementById('booking-summary');
                if (!bookingSummary || bookingState.approvedVendors.length === 0) return;

                const summaryHtml = `
                    <div class="booking-summary-card">
                        <h5 style="margin-bottom: 1rem; color: var(--primary);">Booking Summary</h5>
                        
                        <div class="summary-row">
                            <span>Event Date:</span>
                            <span>${bookingState.eventDetails.date} at ${bookingState.eventDetails.time}</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Location:</span>
                            <span>${bookingState.eventDetails.location || 'TBD'}</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Attendees:</span>
                            <span>${bookingState.eventDetails.attendeeCount}</span>
                        </div>
                        
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">
                        
                        <h6 style="margin-bottom: 0.5rem; color: var(--primary);">Confirmed Vendors:</h6>
                        ${bookingState.approvedVendors.map(vendor => `
                            <div class="summary-row">
                                <span>${vendor.name}</span>
                                <span>$${vendor.proposedPrice?.toLocaleString() || '0'}</span>
                            </div>
                        `).join('')}
                        
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">
                        
                        <div class="summary-row">
                            <span><strong>Total Cost:</strong></span>
                            <span><strong>$${bookingState.totalCost.toLocaleString()}</strong></span>
                        </div>
                    </div>
                `;

                bookingSummary.innerHTML = summaryHtml;
            }

            // Override updateBookingStep to handle step-specific logic
            const originalUpdateBookingStep = updateBookingStep;
            updateBookingStep = function(step) {
                originalUpdateBookingStep(step);
                
                // Step-specific logic
                if (step === 5) {
                    renderApprovalStatus();
                } else if (step === 6) {
                    renderBookingSummary();
                }
                
                // Clean up polling when leaving approval steps
                if (step !== 4 && step !== 5 && bookingState.approvalPollingInterval) {
                    clearInterval(bookingState.approvalPollingInterval);
                    window.bookingState.approvalPollingInterval = null;
                }
            };

            // Override closeBookingModal to clean up polling
            const originalCloseBookingModal = closeBookingModal;
            closeBookingModal = function() {
                if (bookingState.approvalPollingInterval) {
                    clearInterval(bookingState.approvalPollingInterval);
                    window.bookingState.approvalPollingInterval = null;
                }
                originalCloseBookingModal();
                // Make socket globally available
                window.socket = state.socket;
                
                // Set up global Socket.IO event listeners for new chat system
                window.socket.on('new-message', (messageData) => {
                    console.log('Global: Received new message via Socket.IO:', messageData);
                    if (messageData.conversationId === currentConversation?.id) {
                        addMessageToUI(messageData);
                    }
                    // Update conversation list with new message
                    updateConversationInList(messageData);
                });
            };

            // Make functions globally available
        window.openBookingModal = openBookingModal;
        // toggleVendorSelection will be defined later in the file
            
            // New router-like functionality for SPA
            let isInitialLoad = true;
            function handleUrlChange() {
                console.log('🔄 handleUrlChange called');
                console.log('🔄 Current URL:', window.location.href);
                console.log('🔄 Current hash:', window.location.hash);
                console.log('🔄 Current pathname:', window.location.pathname);
                console.log('🔄 isInitialLoad:', isInitialLoad);
                
                // Check both hash-based and path-based routing
                const hashPath = window.location.hash.substring(1);
                const pathname = window.location.pathname;
                
                let vendorId = null;
                let shouldUpdateHash = false;
                
                // Check hash-based routing first (e.g., #/listings/144)
                if (hashPath.startsWith('/listings/')) {
                    vendorId = hashPath.split('/')[2];
                    console.log('🔄 Found vendor ID from hash:', vendorId);
                }
                // Check path-based routing (e.g., /listings/144)
                else if (pathname.includes('/listings/')) {
                    const pathParts = pathname.split('/');
                    const listingIndex = pathParts.findIndex(part => part === 'listings');
                    if (listingIndex !== -1 && pathParts[listingIndex + 1]) {
                        vendorId = pathParts[listingIndex + 1];
                        shouldUpdateHash = true;
                        console.log('🔄 Found vendor ID from path:', vendorId);
                    }
                }
                
                // Check DOM elements
                console.log('🔄 mainAppView exists:', !!mainAppView);
                console.log('🔄 vendorProfilePage exists:', !!vendorProfilePage);
                
                if (vendorId) {
                    console.log(`🔗 Loading vendor profile for ID: ${vendorId}`);
                    
                    // Update hash only after successful profile load to prevent redirect loops
                    if (shouldUpdateHash && !isInitialLoad) {
                        console.log('🔄 Updating hash for subsequent navigation');
                        window.history.replaceState(null, null, `${window.location.origin}${window.location.pathname}#/listings/${vendorId}`);
                    } else if (shouldUpdateHash && isInitialLoad) {
                        console.log('🔄 Setting hash for initial load');
                        // For initial load, set hash without triggering navigation
                        window.location.hash = `/listings/${vendorId}`;
                    }
                    
                    showVendorProfilePage(vendorId);
                } else {
                    console.log('🔄 No vendor ID found, showing main app');
                    showMainApp();
                }
                
                // Mark that initial load is complete
                isInitialLoad = false;
            }

            function showMainApp() {
                console.log('🏠 showMainApp called');
                if (mainAppView) {
                    mainAppView.style.display = 'grid';
                    console.log('🏠 mainAppView shown');
                    try { renderVendorSetupReminder(); } catch (e) {}
                } else {
                    console.error('❌ mainAppView not found');
                }
                
                if (vendorProfilePage) {
                    vendorProfilePage.style.display = 'none';
                    console.log('🏠 vendorProfilePage hidden');
                } else {
                    console.error('❌ vendorProfilePage not found');
                }
                
                // Dashboards are now in a modal, so we don't hide them here
                // The modal's own close button will handle hiding it.
                if (window.location.hash !== '') {
                    window.location.hash = '';
                }
                document.body.style.overflow = 'auto';
            }

            // Load categories from API
            async function loadCategories() {
                try {
                    // In a real app, you would fetch categories from your API
                    // For now, we'll use a predefined list that matches the backend
                    state.categories = [
                        { id: 'all', name: 'All Categories' },
                        { id: 'venue', name: 'Venues' },
                        { id: 'photo', name: 'Photo/Video' },
                        { id: 'music', name: 'Music/DJ' },
                        { id: 'catering', name: 'Catering' },
                        { id: 'entertainment', name: 'Entertainment' },
                        { id: 'experiences', name: 'Experiences' },
                        { id: 'decor', name: 'Decorations' },
                        { id: 'beauty', name: 'Beauty' },
                        { id: 'cake', name: 'Cake' },
                        { id: 'transport', name: 'Transportation' },
                        { id: 'planner', name: 'Planners' },
                        { id: 'fashion', name: 'Fashion' },
                        { id: 'stationery', name: 'Stationery' }
                    ];

            // Render categories
            renderCategories();

        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Render categories in the navigation with icons vertically stacked
    function renderCategories() {
        categoriesListInner.innerHTML = '';

        state.categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            if (category.id === state.currentCategory || (state.currentCategory === 'all' && category.id === 'all')) categoryItem.classList.add('active');
            categoryItem.dataset.category = category.id;

            // Add icon element above label
            const iconHtml = getCategoryIconHtml(category.id);
            categoryItem.innerHTML = `${iconHtml}<span>${category.name}</span>`;

            categoryItem.addEventListener('click', () => {
                document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
                categoryItem.classList.add('active');
                state.currentCategory = category.id;
                const params = new URLSearchParams(window.location.search);
                if (state.currentCategory === 'all') {
                    params.set('category', 'all');
                    params.delete('categories');
                } else {
                    params.set('category', buildCategoryParamFromKey(state.currentCategory));
                    params.delete('categories');
                }
                const qs = params.toString();
                const url = qs ? `${location.pathname}?${qs}` : location.pathname;
                history.pushState({}, '', url);
                loadVendors();
            });

            categoriesListInner.appendChild(categoryItem);
        });
    }

    // Helper function to get category icon HTML using Font Awesome icons
    function getCategoryIconHtml(category) {
        const icons = {
            "all": "<i class='fas fa-th-large'></i>",
            "venue": "<i class='fas fa-building'></i>",
            "photo": "<i class='fas fa-camera'></i>",
            "music": "<i class='fas fa-music'></i>",
            "catering": "<i class='fas fa-utensils'></i>",
            "entertainment": "<i class='fas fa-theater-masks'></i>",
            "experiences": "<i class='fas fa-star'></i>",
            "decor": "<i class='fas fa-ribbon'></i>",
            "beauty": "<i class='fas fa-spa'></i>",
            "cake": "<i class='fas fa-birthday-cake'></i>",
            "transport": "<i class='fas fa-shuttle-van'></i>",
            "planner": "<i class='fas fa-clipboard-list'></i>",
            "fashion": "<i class='fas fa-tshirt'></i>",
            "stationery": "<i class='fas fa-envelope'></i>"
        };
        return icons[category] || "<i class='fas fa-gem'></i>";
    }

            // Helper function to generate sample reviews
            function generateSampleReviews() {
                const reviews = [];
                const reviewTexts = [
                    "Great service! Would definitely book again.",
                    "Very professional and easy to work with.",
                    "The venue was perfect for our event.",
                    "Everything went smoothly, highly recommend!",
                    "Good quality but communication could be better.",
                    "Delivered exactly what was promised."
                ];

                const names = ["John D.", "Sarah M.", "Michael T.", "Emily R.", "David K.", "Jessica L."];

                for (let i = 0; i < 5; i++) {
                    reviews.push({
                        id: `review-${i}`,
                        user: names[i],
                        rating: Math.floor(Math.random() * 2) + 4,
                        comment: reviewTexts[i],
                        date: new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000).toISOString()
                    });
                }

                return reviews;
            }

            // Helper function to map vendor types to categories
            function mapTypeToCategory(type) {
                const typeMap = {
                    "Photography": "photo",
                    "Photo": "photo",
                    "Videography": "photo",
                    "Entertainment": "entertainment",
                    "Music": "music",
                    "DJ": "music",
                    "Decor": "decor",
                    "Florist": "decor",
                    "Catering": "catering",
                    "Food": "catering",
                    "Venue": "venue",
                    "Hotel": "venue",
                    "Transportation": "transport",
                };
                return typeMap[type] || type.toLowerCase();
            }

            function buildCategoryParamFromKey(key) {
                switch ((key || '').toLowerCase()) {
                    case 'music': return 'Music/DJ';
                    case 'photo': return 'Photo/Video';
                    case 'decor': return 'Decorations';
                    case 'venue': return 'Venues';
                    case 'transport': return 'Transportation';
                    case 'catering': return 'Catering';
                    case 'entertainment': return 'Entertainment';
                    case 'planner': return 'Planners';
                    case 'fashion': return 'Fashion';
                    case 'stationery': return 'Stationery';
                    case 'beauty': return 'Beauty';
                    case 'cake': return 'Cake';
                    case 'experiences': return 'Experiences';
                    default: return key;
                }
            }

            function deriveKeyFromCategoryParam(label) {
                const v = decodeURIComponent(label || '').toLowerCase();
                if (v === 'music/dj' || v === 'music' || v === 'dj') return 'music';
                if (v === 'photo/video' || v === 'photo' || v === 'photography' || v === 'videography') return 'photo';
                if (v === 'venues' || v === 'venue' || v === 'hotel') return 'venue';
                if (v === 'decorations' || v === 'decor' || v === 'florist') return 'decor';
                if (v === 'transportation') return 'transport';
                if (v === 'catering') return 'catering';
                if (v === 'entertainment') return 'entertainment';
                if (v === 'planners' || v === 'planner') return 'planner';
                if (v === 'beauty') return 'beauty';
                if (v === 'cake') return 'cake';
                if (v === 'experiences') return 'experiences';
                if (v === 'fashion') return 'fashion';
                if (v === 'stationery') return 'stationery';
                return 'all';
            }

            function initCategoryFromUrl() {
                const params = new URLSearchParams(window.location.search);
                let key = 'all';
                if (params.has('category')) key = deriveKeyFromCategoryParam(params.get('category'));
                else if (params.has('categories')) {
                    const first = (params.get('categories') || '').split(',')[0];
                    if (first) key = deriveKeyFromCategoryParam(first);
                }
                state.currentCategory = key;
                try {
                    document.querySelectorAll('.category-item').forEach(el => {
                        const match = el.dataset.category === key || (key === 'all' && el.dataset.category === 'all');
                        el.classList.toggle('active', !!match);
                    });
                } catch {}
            }

            window.addEventListener('popstate', () => {
                initCategoryFromUrl();
                loadVendors();
            });

            // Check for existing user session
            async function checkAuthStatus() {
                const token = localStorage.getItem('token');
 
                if (!token) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/users/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });

                        // Load user favorites
                        await loadUserFavorites();

                        // Load notifications
                        await loadNotifications();
                        
                        // Update notification badges from localStorage
                        updateNotificationBadges();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    localStorage.removeItem('token');
                }
            }

            // Load user favorites
            async function loadUserFavorites() {
                if (!currentUser) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (response.ok) {
                        const favorites = await response.json();
                        state.favorites = favorites.map(fav => fav.vendorProfileID);

                        // Update favorites badge
                        document.querySelectorAll('.badge').forEach(badge => {
                            if (badge.id === 'favorites-badge' || !badge.id) {
                                badge.textContent = state.favorites.length;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading favorites:', error);
                }
            }

            // Load notifications
            async function loadNotifications(isUnreadOnly = false) {
                console.log('loadNotifications called with isUnreadOnly:', isUnreadOnly);
                
                if (!currentUser) {
                    console.log('No current user, skipping notification load');
                    return;
                }

                const listEl = document.getElementById('notifications-list');
                if (listEl) {
                    listEl.innerHTML = `
                        <div class="loading-notifications">
                            <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                        </div>
                    `;
                }

                try {
                    let url = `${API_BASE_URL}/notifications/user/${currentUser.id}`;
                    if (isUnreadOnly) url += `?unreadOnly=true`;
                    console.log('Fetching notifications from:', url);
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Notifications API response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Notifications API data:', data);
                        let items = Array.isArray(data) ? data : (data.notifications || []);
                        const hideRead = isUnreadOnly;
                        if (hideRead) {
                            items = items.filter(n => !(n.IsRead || n.isRead || n.read));
                        }
                        console.log('Notifications items to display:', items.length);
                        displayNotifications(items);
                        updateNotificationBadges();
                    } else {
                        console.log('API failed, using localStorage fallback');
                        const all = JSON.parse(localStorage.getItem('notifications') || '[]').filter(n => (n.userId === currentUser.id || n.userId === currentUser.vendorProfileId));
                        const hideRead = isUnreadOnly;
                        const items = hideRead ? all.filter(n => !(n.isRead || n.read || n.IsRead)) : all;
                        console.log('LocalStorage notifications:', items.length);
                        displayNotifications(items);
                        updateNotificationBadges();
                    }
                } catch (error) {
                    console.error('Error loading notifications, using local fallback:', error);
                    const all = JSON.parse(localStorage.getItem('notifications') || '[]').filter(n => (n.userId === currentUser.id || n.userId === currentUser.vendorProfileId));
                    const hideRead = isUnreadOnly;
                    const items = hideRead ? all.filter(n => !(n.isRead || n.read || n.IsRead)) : all;
                    console.log('Error fallback notifications:', items.length);
                    displayNotifications(items);
                    updateNotificationBadges();
                }

                const markAllBtn = document.getElementById('mark-all-read');
                if (markAllBtn && !markAllBtn.__bound) {
                    console.log('Binding mark all read button');
                    markAllBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Mark all read button clicked');
                        try {
                            await markAllNotificationsAsRead();
                        } catch (error) {
                            console.error('Error marking all notifications as read:', error);
                        }
                    });
                    markAllBtn.__bound = true;
                } else if (markAllBtn) {
                    console.log('Mark all read button already bound');
                } else {
                    console.log('Mark all read button not found');
                }
            }
            window.loadNotifications = loadNotifications;

            // Initialize Stripe
            function initializeStripe() {
                state.stripe = Stripe('pk_test_YOUR_STRIPE_PUBLIC_KEY');
                state.elements = state.stripe.elements();
            }


            // Connect to Socket.IO for chat
            function connectToChat() {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No token available for chat connection. Chat features may be limited.');
                    return;
                }

                if (state.socket && state.socket.connected) {
                    console.log('Socket already connected.');
                    return;
                }

                console.log('Attempting to connect to chat server...');
                try {
                    const base = SOCKET_BASE_URL || (new URL(API_BASE_URL)).origin;
                    state.socket = window.io(base, {
                        withCredentials: true,
                        auth: { token },
                        transports: ['websocket', 'polling'],
                        reconnectionAttempts: 5
                    });
                } catch (e) {
                    console.error('Failed to initialize Socket.IO:', e);
                    return;
                }
                
                state.socket.on('connect', () => {
                    console.log('Connected to chat server.');
                    if (currentUser) {
                        state.socket.emit('authenticate', { userId: currentUser.id });
                    }
                });
                
                state.socket.on('new-message', (message) => {
                    console.log('Received new message via Socket.IO:', message);
                    
                    if (!message || !message.ConversationID) {
                        console.error('Invalid message format received:', message);
                        return;
                    }
                    
                    // Only process if it's for the current conversation
                    if (message.ConversationID === state.chat.currentConversation) {
                        const formattedMessage = state.chat.formatMessage(message);
                        state.chat.addMessage(formattedMessage);
                        renderChatMessages();
                    } else {
                        console.log(`Received message for conversation ${message.ConversationID}, but current is ${state.chat.currentConversation}. Not rendering.`);
                    }
                });
                
                state.socket.on('error', (error) => {
                    console.error('Socket error:', error);
                    showChatError('Connection error. Please refresh the page.');
                });
                
                state.socket.on('disconnect', () => {
                    console.log('Disconnected from chat server.');
                    showChatError('Disconnected. Trying to reconnect...');
                });
            }

async function loadInitialMessages() {
                if (!currentUser || !state.chat.currentConversation) {
                    console.warn('Cannot load messages: Missing user or conversation ID.', {
                        user: currentUser,
                        conversation: state.chat.currentConversation
                    });
                    return;
                }
                
                try {
                    console.log(`Loading messages for conversation: ${state.chat.currentConversation} and user: ${currentUser.id}`);
                    const response = await fetch(`${API_BASE_URL}/messages/conversation/${state.chat.currentConversation}?userId=${currentUser.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to load messages: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    
                    // The API returns messages directly as an array
                    if (!Array.isArray(data.messages)) {
                        throw new Error('Invalid message data format from API');
                    }
                    
                    state.chat.setMessages(data.messages);
                    renderChatMessages();
                } catch (error) {
                    console.error('Error loading messages:', error);
                    state.chat.setMessages([]); // Clear messages on error
                    renderChatMessages();
                    showChatError('Failed to load messages. Please try again.');
                }
            }


            function setupChatEventListeners(chatInputId, sendButtonId) {
                console.log(`Setting up chat listeners for: ${chatInputId}, ${sendButtonId}`);
                
                const chatInput = document.getElementById(chatInputId);
                const sendButton = document.getElementById(sendButtonId);

                console.log('Found elements:', { chatInput: !!chatInput, sendButton: !!sendButton });

                if (chatInput && sendButton) {
                    // Remove existing listeners
                    sendButton.removeEventListener('click', sendChatMessage);
                    chatInput.removeEventListener('keypress', handleChatInputKeypress);

                    // Add new listeners
                    sendButton.addEventListener('click', (e) => {
                        console.log('Send button clicked!');
                        e.preventDefault();
                        sendChatMessage();
                    });
                    
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('Enter key pressed!');
                            e.preventDefault();
                            sendChatMessage();
                        }
                    });
                    
                    console.log(`Chat event listeners attached successfully for input: ${chatInputId}, button: ${sendButtonId}`);
                } else {
                    console.error(`Could not find chat elements: Input ID ${chatInputId} (${!!chatInput}), Button ID ${sendButtonId} (${!!sendButton})`);
                }
            }

            function handleChatInputKeypress(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            }

async function sendChatMessage() {
                console.log('sendChatMessage function called');
                
                const input = document.getElementById('chat-input') ||
                            document.getElementById('dashboard-chat-input') ||
                            document.getElementById('vendor-chat-input') ||
                            document.getElementById('vendor-all-chat-input') ||
                            document.getElementById('profile-chat-input');
                            
                console.log('Found input element:', !!input, input?.id);
                const message = input?.value.trim();

                console.log('Attempting to send message:', message, 'Current User:', currentUser, 'Current Conversation:', state.chat.currentConversation);

                if (!message) {
                    console.warn('Message is empty.');
                    return;
                }

                if (!currentUser) {
                    alert('Please login to send messages.');
                    profileModal.style.display = 'flex';
                    showLoginView();
                    return;
                }
                
                if (!state.chat.currentConversation && !state.chat.currentChatVendorId) {
                    alert('Please select a conversation first.');
                    return;
                }
                
                if (!state.chat.currentConversation && state.chat.currentChatVendorId) {
                    console.log('No existing conversation found, creating a new one...');
                    try {
                        const createResponse = await fetch(`${API_BASE_URL}/messages/conversation`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                vendorProfileId: state.chat.currentChatVendorId
                            })
                        });
                        
                        if (!createResponse.ok) {
                             const errorText = await createResponse.text();
                            throw new Error(`Failed to create conversation: ${createResponse.status} ${createResponse.statusText} - ${errorText}`);
                        }
                        
                        const createData = await createResponse.json();
                        state.chat.currentConversation = createData.conversation.ConversationID || createData.conversationId;
                        console.log('New conversation created:', state.chat.currentConversation);
                    } catch (err) {
                        console.error('Failed to create new conversation:', err);
                        showChatError('Failed to start chat. Please try again.');
                        return;
                    }
                }

                try {

                    const tempMessage = {
                        id: `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        conversationId: state.chat.currentConversation,
                        senderId: currentUser.id,
                        senderName: currentUser.name,
                        content: message,
                        timestamp: new Date().toISOString(),
                        isCurrentUser: true,
                        isPending: true
                    };


                    state.chat.addMessage(tempMessage);
                    input.value = '';
                    renderChatMessages();
                    
                    // Send message via Socket.IO if connected
                    if (state.socket && state.socket.connected) {
                        console.log('Sending message via Socket.IO...');
                        state.socket.emit('send-message', {
                            conversationId: state.chat.currentConversation,
                            senderId: currentUser.id,
                            content: message
                        });
                    } else {
                        console.log('Socket not connected, falling back to HTTP POST...');

                        const response = await fetch(`${API_BASE_URL || process.env.API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                conversationId: currentConversation.id,
                                senderId: currentUser?.id,
                                content: message
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to send message via HTTP.');
                        }

                        const result = await response.json();
                        console.log('HTTP POST message response:', result);

                        const savedMessage = state.chat.formatMessage(result);


                        state.chat.setMessages(
                            state.chat.getMessages()
                                .filter(m => m.id !== tempMessage.id)
                                .concat([savedMessage])
                        );
                    }

                    renderChatMessages();

                } catch (err) {
                    console.error('Message send failed:', err);

                    state.chat.setMessages(
                        state.chat.getMessages().filter(m => m.id !== tempMessage.id)
                    );
                    renderChatMessages();
                    showChatError('Failed to send message: ' + err.message);
                }
            }

            function renderChatMessages() {
                const chatContainer = document.getElementById('chat-messages') ||
                                    document.getElementById('dashboard-chat-messages') ||
                                    document.getElementById('vendor-chat-messages') ||
                                    document.getElementById('vendor-all-chat-messages') ||
                                    document.getElementById('profile-chat-messages');
                
                if (!chatContainer) {
                    console.warn('Chat container not found for rendering messages.');
                    return;
                }

                chatContainer.innerHTML = '';


                const sortedMessages = [...state.chat.getMessages()].sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp));


                sortedMessages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === currentUser?.id ? 'sent' : 'received'}`;

                    const messageDate = new Date(message.timestamp);
                    const timeString = messageDate.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });


                    const senderInfo = (message.senderId !== currentUser?.id && message.senderName) ?
                        `<div class="message-sender">${message.senderName}</div>` : '';

                    messageDiv.innerHTML = `
                        ${senderInfo}
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${timeString}</div>
                    `;

                    chatContainer.appendChild(messageDiv);
                });


                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Add this function to load conversations for the dashboard
async function loadConversations(containerId, chatInputId, sendButtonId) {
                if (!currentUser) {
                    console.warn('Cannot load conversations: User not logged in.');
                    return;
                }
                
                try {
                    console.log(`Loading conversations for user: ${currentUser.id}`);
                    // Use the correct API endpoint from messages.js
                    const url = `${API_BASE_URL}/messages/conversations/user/${currentUser.id}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    let conversations = [];
                    
                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('API response:', responseData);
                        conversations = responseData.conversations || [];
                        
                        // Map API response to expected format
                        conversations = conversations.map(conv => ({
                            id: conv.id || conv.ConversationID,
                            userName: conv.OtherPartyName || conv.userName || 'Unknown User',
                            OtherPartyName: conv.OtherPartyName || conv.userName || 'Unknown User',
                            lastMessageContent: conv.lastMessageContent || conv.LastMessageContent || 'No messages yet',
                            lastMessageCreatedAt: conv.lastMessageCreatedAt || conv.LastMessageCreatedAt || conv.createdAt,
                            lastMessageSenderId: conv.lastMessageSenderId || conv.LastMessageSenderID,
                            unreadCount: conv.unreadCount || conv.UnreadCount || 0
                        }));
                    } else {
                        console.log('API failed, loading local conversations');
                        // Fallback: Load from localStorage
                        const localConversations = JSON.parse(localStorage.getItem('conversations') || '[]');
                        console.log('Local conversations found:', localConversations);
                        conversations = localConversations.filter(conv => 
                            conv.userId === currentUser.id || conv.vendorProfileId === currentUser.vendorProfileId
                        );
                        console.log('Filtered conversations for current user:', conversations);
                    }
                    
                    console.log('Final conversations:', conversations);
                    renderConversationsList(conversations, containerId, chatInputId, sendButtonId);
                } catch (error) {
                    console.error('Error loading conversations, using local fallback:', error);
                    // Load local conversations as fallback
                    const localConversations = JSON.parse(localStorage.getItem('conversations') || '[]');
                    console.log('Error fallback - Local conversations:', localConversations);
                    const conversations = localConversations.filter(conv => 
                        conv.userId === currentUser.id || conv.vendorProfileId === currentUser.vendorProfileId
                    );
                    console.log('Error fallback - Filtered conversations:', conversations);
                    renderConversationsList(conversations, containerId, chatInputId, sendButtonId);
                }
            }

            function renderConversationsList(conversations, containerId, chatInputId, sendButtonId) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn('Conversations container not found:', containerId);
                    return;
                }


                container.innerHTML = `
                    <div class="dashboard-card">
                        <h2 class="dashboard-card-title">Messages</h2>
                        <div id="chat-app" style="height: 500px; display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                            <!-- Conversations sidebar -->
                            <div id="conversations-sidebar" style="width: 300px; border-right: 1px solid var(--border); background: #f8f9fa;">
                                <div style="padding: 1rem; border-bottom: 1px solid var(--border); background: white;">
                                    <h3 style="margin: 0; font-size: 1rem;">Conversations</h3>
                                </div>
                                <div id="conversations-list" style="height: calc(100% - 60px); overflow-y: auto;">
                                    <div style="padding: 1rem; text-align: center; color: #666;">Loading conversations...</div>
                                </div>
                            </div>
                            
                            <!-- Chat area -->
                            <div id="chat-area" style="flex: 1; display: flex; flex-direction: column;">
                                <!-- Chat header -->
                                <div id="chat-header" style="padding: 1rem; border-bottom: 1px solid var(--border); background: white;">
                                    <div id="chat-partner-name" style="font-weight: 600; color: #666;">Select a conversation</div>
                                </div>
                                
                                <!-- Messages container -->
                                <div id="messages-container" style="flex: 1; padding: 1rem; overflow-y: auto; background: #f8f9fa;">
                                    <div id="welcome-message" style="text-align: center; color: #666; margin-top: 2rem;">
                                        Select a conversation to start messaging
                                    </div>
                                </div>
                                
                                <!-- Message input -->
                                <div id="message-input-area" style="padding: 1rem; border-top: 1px solid var(--border); background: white; display: none;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="message-input" placeholder="Type your message..." 
                                               style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 4px; outline: none;">
                                        <button id="send-message-btn" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Store conversations globally and initialize the new chat system
                window.lastLoadedConversations = conversations;
                initializeChatSystem(conversations);
            }

            // New Clean Chat System
            let currentConversation = null;
            let chatPollingInterval = null;

            function initializeChatSystem(conversations) {
                console.log('Initializing new chat system with conversations:', conversations);
                
                // Populate conversations list
                populateConversationsList(conversations);
                
                // Set up event listeners
                setupNewChatEventListeners();
                
                // Auto-select first conversation if available
                if (conversations && conversations.length > 0) {
                    selectConversation(conversations[0]);
                }
            }

            function populateConversationsList(conversations) {
                const conversationsList = document.getElementById('conversations-list');
                if (!conversationsList) return;

                if (!conversations || conversations.length === 0) {
                    conversationsList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No conversations found</div>';
                    return;
                }

                conversationsList.innerHTML = conversations.map(conv => {
                    // Format last message with sender prefix
                    let lastMessageDisplay = 'No messages yet';
                    if (conv.lastMessageContent) {
                        const isOwnLastMessage = conv.lastMessageSenderId === currentUser?.id;
                        const senderPrefix = isOwnLastMessage ? 'You: ' : `${conv.userName || conv.OtherPartyName || 'Other'}: `;
                        lastMessageDisplay = senderPrefix + conv.lastMessageContent;
                    }
                    
                    return `
                        <div class="conversation-item" data-conversation-id="${conv.id}" 
                             style="padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${conv.userName || conv.OtherPartyName || 'Unknown User'}</div>
                            <div style="font-size: 0.85rem; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${lastMessageDisplay}
                            </div>
                            <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                                ${conv.lastMessageCreatedAt ? new Date(conv.lastMessageCreatedAt).toLocaleString() : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function setupNewChatEventListeners() {
                // Conversation selection
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.conversation-item')) {
                        const conversationItem = e.target.closest('.conversation-item');
                        const conversationId = parseInt(conversationItem.dataset.conversationId);
                        
                        // Find conversation data
                        const conversations = window.lastLoadedConversations || [];
                        const conversation = conversations.find(c => c.id === conversationId);
                        
                        if (conversation) {
                            selectConversation(conversation);
                        }
                    }
                });

                // Message sending
                const sendBtn = document.getElementById('send-message-btn');
                const messageInput = document.getElementById('message-input');
                
                console.log('🔍 Send button found:', sendBtn);
                console.log('🔍 Message input found:', messageInput);
                
                if (sendBtn) {
                    console.log('✅ Adding click listener to send button');
                    sendBtn.addEventListener('click', (e) => {
                        console.log('🚀 Send button clicked!');
                        e.preventDefault();
                        sendNewMessage();
                    });
                } else {
                    console.log('❌ Send button not found!');
                }
                
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            sendNewMessage();
                        }
                    });
                }
            }

            function selectConversation(conversation) {
                console.log('Selecting conversation:', conversation);
                currentConversation = conversation;
                
                // Update UI
                updateConversationSelection(conversation.id);
                updateChatHeader(conversation.OtherPartyName || 'Unknown');
                showMessageInput();
                
                // Load messages
                loadConversationMessages(conversation.id);
                
                // Start polling for new messages
                startMessagePolling(conversation.id);
            }

            function updateConversationSelection(conversationId) {
                // Remove previous selection
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.style.backgroundColor = 'transparent';
                });
                
                // Highlight selected
                const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (selectedItem) {
                    selectedItem.style.backgroundColor = '#e3f2fd';
                }
            }

            function updateChatHeader(partnerName) {
                const chatPartnerName = document.getElementById('chat-partner-name');
                if (chatPartnerName) {
                    chatPartnerName.textContent = partnerName;
                }
            }

            function showMessageInput() {
                const messageInputArea = document.getElementById('message-input-area');
                const welcomeMessage = document.getElementById('welcome-message');
                
                if (messageInputArea) messageInputArea.style.display = 'block';
                if (welcomeMessage) welcomeMessage.style.display = 'none';
            }

            async function loadConversationMessages(conversationId) {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;

                messagesContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">Loading messages...</div>';

                try {
                    const response = await fetch(`${API_BASE_URL}/messages/conversation/${conversationId}?userId=${currentUser?.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }

                    const data = await response.json();
                    displayMessages(data.messages || []);
                    
                } catch (error) {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 2rem;">Failed to load messages</div>';
                }
            }

            function displayMessages(messages) {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;

                if (!messages || messages.length === 0) {
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No messages yet. Start the conversation!</div>';
                    return;
                }

                messagesContainer.innerHTML = messages.map(message => {
                    const isOwnMessage = message.SenderID === currentUser?.id;
                    const containerStyle = isOwnMessage ? 'display: flex; justify-content: flex-end;' : 'display: flex; justify-content: flex-start;';
                    const bubbleStyle = isOwnMessage 
                        ? 'background: #007bff; color: white; border-bottom-right-radius: 4px;' 
                        : 'background: #e9ecef; color: #333; border: 1px solid #dee2e6; border-bottom-left-radius: 4px;';
                    
                    // Get sender name
                    const senderName = isOwnMessage ? 'You' : (message.SenderName || 'Other User');
                    
                    return `
                        <div style="margin-bottom: 1rem; ${containerStyle}">
                            <div style="padding: 0.75rem 1rem; border-radius: 18px; ${bubbleStyle} box-shadow: 0 1px 2px rgba(0,0,0,0.1); max-width: 70%;">
                                <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem; opacity: 0.8;">${senderName}</div>
                                <div style="margin-bottom: 0.25rem;">${message.Content}</div>
                                <div style="font-size: 0.75rem; opacity: 0.7;">
                                    ${new Date(message.CreatedAt).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            async function sendNewMessage() {
                console.log('🚀 sendNewMessage called!');
                console.log('🔍 currentConversation:', currentConversation);
                console.log('🔍 currentUser:', currentUser);
                
                if (!currentConversation) {
                    console.log('❌ No current conversation!');
                    return;
                }

                const messageInput = document.getElementById('message-input');
                const message = messageInput?.value.trim();
                
                console.log('🔍 Message input value:', message);

                if (!message) {
                    console.log('❌ No message content!');
                    return;
                }

                console.log('Sending message via Socket.IO:', message);

                // Use Socket.IO for real-time message sending
                if (window.socket) {
                    window.socket.emit('send-message', {
                        conversationId: currentConversation.id,
                        senderId: currentUser?.id,
                        content: message
                    });

                    // Clear input immediately
                    messageInput.value = '';
                    
                    // Add message to UI immediately for instant feedback
                    addMessageToUI({
                        senderId: currentUser.id,
                        senderName: 'You',
                        content: message,
                        conversationId: currentConversation.id
                    });
                } else {
                    // Fallback to REST API if Socket.IO not available
                    console.log('🌐 Socket not available, using HTTP POST to:', 'https://bdb-3-0-venuevue-api.onrender.com/api/messages');
                    try {
                        const response = await fetch('https://bdb-3-0-venuevue-api.onrender.com/api/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                conversationId: currentConversation.id,
                                senderId: currentUser?.id,
                                content: message
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to send message');
                        }

                        // Clear input immediately
                        messageInput.value = '';
                        
                        // Add message to UI immediately for instant feedback
                        addMessageToUI({
                            senderId: currentUser.id,
                            senderName: 'You',
                            content: message,
                            conversationId: currentConversation.id
                        });

                    } catch (error) {
                        console.error('Error sending message:', error);
                        alert('Failed to send message. Please try again.');
                    }
                }
            }

            function startMessagePolling(conversationId) {
                // Clear existing polling - we'll use Socket.IO instead
                if (chatPollingInterval) {
                    clearInterval(chatPollingInterval);
                    chatPollingInterval = null;
                }

                // Socket.IO listeners are now handled globally - no need for duplicate listeners here
            }

            // Add new message to UI without full reload
            function addMessageToUI(messageData) {
                const messagesContainer = document.getElementById('messages-container');
                if (!messagesContainer) return;

                const isOwnMessage = messageData.senderId === currentUser?.id;
                const containerStyle = isOwnMessage ? 'display: flex; justify-content: flex-end;' : 'display: flex; justify-content: flex-start;';
                const bubbleStyle = isOwnMessage 
                    ? 'background: #007bff; color: white; border-bottom-right-radius: 4px;' 
                    : 'background: #e9ecef; color: #333; border: 1px solid #dee2e6; border-bottom-left-radius: 4px;';
                
                const senderName = isOwnMessage ? 'You' : (messageData.senderName || 'Other User');
                
                const messageHTML = `
                    <div style="margin-bottom: 1rem; ${containerStyle}">
                        <div style="padding: 0.75rem 1rem; border-radius: 18px; ${bubbleStyle} box-shadow: 0 1px 2px rgba(0,0,0,0.1); max-width: 70%;">
                            <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem; opacity: 0.8;">${senderName}</div>
                            <div style="margin-bottom: 0.25rem;">${messageData.content}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">
                                ${new Date().toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
                
                messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Update conversation in list with new message
            function updateConversationInList(messageData) {
                const conversationItem = document.querySelector(`[data-conversation-id="${messageData.conversationId}"]`);
                if (!conversationItem) return;

                const isOwnMessage = messageData.senderId === currentUser?.id;
                const senderPrefix = isOwnMessage ? 'You: ' : `${messageData.senderName || 'Other'}: `;
                const lastMessageDisplay = senderPrefix + messageData.content;

                // Update last message content
                const lastMessageElement = conversationItem.querySelector('div:nth-child(2)');
                if (lastMessageElement) {
                    lastMessageElement.textContent = lastMessageDisplay;
                }

                // Update timestamp
                const timestampElement = conversationItem.querySelector('div:nth-child(3)');
                if (timestampElement) {
                    timestampElement.textContent = new Date().toLocaleString();
                }

                // Move conversation to top of list
                const conversationsList = document.getElementById('conversations-list');
                if (conversationsList && conversationItem.parentNode === conversationsList) {
                    conversationsList.insertBefore(conversationItem, conversationsList.firstChild);
                }
            }

            // Store conversations globally for event handlers
            window.lastLoadedConversations = null;

            function disableChatInput() {
                const chatInput = document.getElementById('chat-input');
                const sendBtn = document.getElementById('send-btn');
                if (chatInput) chatInput.disabled = true;
                if (sendBtn) sendBtn.disabled = true;
                console.log('Chat input and send button disabled.');
            }

            function showChatError(message) {
                const chatMessagesContainer = document.getElementById('chat-messages') ||
                                              document.getElementById('dashboard-chat-messages') ||
                                              document.getElementById('vendor-chat-messages') ||
                                              document.getElementById('vendor-all-chat-messages') ||
                                              document.getElementById('profile-chat-messages');
                if (chatMessagesContainer) {
                    const errorElement = document.createElement('p');
                    errorElement.style.color = 'var(--accent)';
                    errorElement.style.fontSize = '0.8rem';
                    errorElement.textContent = message;
                    chatMessagesContainer.appendChild(errorElement);
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                console.error('Chat error displayed:', message);
            }

            async function initializeChat(vendorProfileId, vendorName) {
                if (!currentUser) {
                    showChatError('Please log in to start a chat.');
                    return;
                }
                
                // Set the current chat vendor ID and name
                state.chat.currentChatVendorId = vendorProfileId;
                chatVendorName.textContent = vendorName;
                chatModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                console.log(`Initializing chat for vendor: ${vendorProfileId} and user: ${currentUser.id}`);
                state.chat.init();

                try {
                    // Check for an existing conversation
                    const checkResponse = await fetch(`${API_BASE_URL}/messages/conversation/check`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            vendorProfileId: vendorProfileId
                        })
                    });

                    if (!checkResponse.ok) {
                        const errorText = await checkResponse.text();
                        throw new Error(`Failed to check conversation: ${checkResponse.status} ${checkResponse.statusText} - ${errorText}`);
                    }

                    const checkData = await checkResponse.json();

                    if (checkData.conversationId) {
                        state.chat.currentConversation = checkData.conversationId;
                        console.log('Existing conversation found:', state.chat.currentConversation);
                        await loadInitialMessages();
                    } else {
                        console.log('No existing conversation found. A new one will be created on the first message.');
                        profileChatMessages.innerHTML = '<p style="text-align:center; color: var(--text-light); margin-top: 1rem;">Start a new conversation...</p>';
                    }
                    
                    setupChatEventListeners('profile-chat-input', 'profile-send-btn');
                    
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    showChatError('Failed to initialize chat: ' + error.message);
                }
            }
            
            // Geolocation permission persistence helpers
            const GEO_PERMISSION_KEY = 'geo_permission_state';
            const GEO_PERMISSION_TS_KEY = 'geo_permission_ts';
            function getStoredGeoPermission() {
                try { return localStorage.getItem(GEO_PERMISSION_KEY) || null; } catch (e) { return null; }
            }
            function setStoredGeoPermission(state) {
                try {
                    if (state) {
                        localStorage.setItem(GEO_PERMISSION_KEY, state);
                        localStorage.setItem(GEO_PERMISSION_TS_KEY, String(Date.now()));
                    } else {
                        localStorage.removeItem(GEO_PERMISSION_KEY);
                        localStorage.removeItem(GEO_PERMISSION_TS_KEY);
                    }
                } catch (e) {}
            }
            function initGeoPermissionObserver() {
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        navigator.permissions.query({ name: 'geolocation' }).then((p) => {
                            setStoredGeoPermission(p.state);
                            p.onchange = () => setStoredGeoPermission(p.state);
                        }).catch(() => {});
                    } catch (e) {}
                }
            }

            // New improved location request function
            function requestLocationWithFeedback() {
                console.log("Attempting to get location...");
                if (!navigator.geolocation) {
                    console.log("Geolocation not supported by this browser");
                    return;
                }

                // Respect stored permission decision
                const stored = getStoredGeoPermission();
                if (stored === 'denied') {
                    // Do not re-prompt; keep UI neutral
                    currentLocationCheckbox.checked = false;
                    locationInput.placeholder = "City or ZIP code";
                    return;
                }

                // Visual feedback
                locationInput.placeholder = "Detecting your location...";

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Location obtained:", position);
                        setStoredGeoPermission('granted');
                        handleLocationSuccess(position);
                    },
                    (error) => {
                        console.log("Location error:", error);
                        locationInput.placeholder = "City or ZIP code";

                        if (error.code === error.PERMISSION_DENIED) {
                            setStoredGeoPermission('denied');
                            // Only show modal if this is a fresh page load
                            if (!sessionStorage.getItem('locationRequested')) {
                                locationPermissionModal.style.display = 'flex';
                                sessionStorage.setItem('locationRequested', 'true');
                            }
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }

            // Modified location success handler
            function handleLocationSuccess(position) {
                state.userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Update UI
                currentLocationCheckbox.checked = true;
                document.getElementById('within50').checked = true;
                locationInput.value = "Near You";
                locationInput.placeholder = "Near You";

                filterVendors();

                if (state.map) {
                    centerMapOnUser();
                }
            }

            // Enhanced Google Maps initialization with dynamic features and event location prioritization
            function initLegacyMap() {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    console.error('Google Maps API not loaded.');
                    document.getElementById('map').innerHTML = '<p style="text-align:center; padding: 2rem; color: var(--accent);">Map could not be loaded. Please check your connection and API key.</p>';
                    return;
                }

                if (state.filteredVendors.length === 0) return;

                // Store original search results for reset functionality
                state.originalSearchResults = [...state.filteredVendors];

                // Sort vendors by distance from event location if available
                if (window.selectedEventLocation) {
                    console.log('📍 Prioritizing vendors by distance from event location');
                    state.filteredVendors.sort((a, b) => {
                        const distA = calculateDistanceFromCoords(
                            window.selectedEventLocation.lat, 
                            window.selectedEventLocation.lng,
                            a.coordinates.lat, 
                            a.coordinates.lng
                        );
                        const distB = calculateDistanceFromCoords(
                            window.selectedEventLocation.lat, 
                            window.selectedEventLocation.lng,
                            b.coordinates.lat, 
                            b.coordinates.lng
                        );
                        return distA - distB;
                    });
                    
                    // Update the original search results with sorted order
                    state.originalSearchResults = [...state.filteredVendors];
                }

                // Calculate center and bounds for initial search results (AC1)
                const bounds = new google.maps.LatLngBounds();
                
                // Include event location in bounds if available
                if (window.selectedEventLocation) {
                    bounds.extend(new google.maps.LatLng(
                        window.selectedEventLocation.lat, 
                        window.selectedEventLocation.lng
                    ));
                }
                
                state.filteredVendors.forEach(vendor => {
                    bounds.extend(new google.maps.LatLng(vendor.coordinates.lat, vendor.coordinates.lng));
                });

                // Create map
                state.map = new google.maps.Map(document.getElementById("map"), {
                    styles: [
                        {
                            "featureType": "poi",
                            "stylers": [
                                { "visibility": "off" }
                            ]
                        }
                    ]
                });

                // AC1: Center map prioritizing event location if available
                if (window.selectedEventLocation) {
                    // Center on event location with vendors in view
                    state.map.fitBounds(bounds);
                    google.maps.event.addListenerOnce(state.map, 'bounds_changed', () => {
                        if (state.map.getZoom() > 13) {
                            state.map.setZoom(13);
                        }
                    });
                } else if (state.filteredVendors.length === 1) {
                    state.map.setCenter({
                        lat: state.filteredVendors[0].coordinates.lat,
                        lng: state.filteredVendors[0].coordinates.lng
                    });
                    state.map.setZoom(14);
                } else {
                    state.map.fitBounds(bounds);
                    // Ensure minimum zoom level
                    google.maps.event.addListenerOnce(state.map, 'bounds_changed', () => {
                        if (state.map.getZoom() > 15) {
                            state.map.setZoom(15);
                        }
                    });
                }

                // Store initial bounds for reset functionality
                state.initialMapBounds = bounds;

                // Add event location marker if available
                if (window.selectedEventLocation) {
                    addEventLocationMarker();
                }

                // Add vendor markers - CREATE ONCE AND NEVER RECREATE
                createMarkersOnce();

                // AC2 & AC4: Add debounced map movement listeners - DISABLED
                // addMapMovementListeners(); // Causing marker bouncing issue

                // Add loading indicator to map
                addMapLoadingIndicator();

                // Add reset button to map
                addResetSearchButton();
            }

            // Helper function to calculate distance between two points (Haversine formula)
            function calculateDistanceFromCoords(lat1, lng1, lat2, lng2) {
                const R = 6371; // Radius of the Earth in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in kilometers
            }

            // Pan/zoom to the event location without adding a marker
            function addEventLocationMarker() {
                if (!state.map || !window.selectedEventLocation) return;

                // Remove existing event marker if it exists (we no longer show one)
                if (state.eventLocationMarker) {
                    try { state.eventLocationMarker.setMap(null); } catch {}
                    state.eventLocationMarker = null;
                }

                try {
                    const target = {
                        lat: window.selectedEventLocation.lat,
                        lng: window.selectedEventLocation.lng
                    };
                    state.map.panTo(target);
                    const currentZoom = typeof state.map.getZoom === 'function' ? state.map.getZoom() : 0;
                    if (!currentZoom || currentZoom < 12) {
                        state.map.setZoom(13);
                    }
                } catch (e) {
                    console.warn('Failed to pan/zoom to event location:', e);
                }
            }

            // AC2 & AC4: Add debounced map movement listeners
            function addMapMovementListeners() {
                if (!state.map) return;

                // DISABLED: Map movement listeners are causing markers to constantly bounce
                // The issue is that bounds_changed fires constantly and recreates markers
                // For now, we'll show all vendors from search results without dynamic filtering
                console.log('🚫 Map movement listeners disabled to prevent marker bouncing');
                
                // TODO: Implement proper marker management that doesn't recreate markers on every bounds change
            }

            // AC3: Add loading indicator to map
            function addMapLoadingIndicator() {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;

                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'map-loading-indicator';
                loadingDiv.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    display: none;
                    z-index: 1000;
                    align-items: center;
                    gap: 12px;
                `;
                loadingDiv.innerHTML = `
                    <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="color: #333; font-weight: 500;">Loading vendors...</span>
                `;

                // Add CSS animation for spinner
                if (!document.getElementById('map-loading-styles')) {
                    const style = document.createElement('style');
                    style.id = 'map-loading-styles';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                mapContainer.style.position = 'relative';
                mapContainer.appendChild(loadingDiv);
            }

            // AC6: Add reset search button
            function addResetSearchButton() {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;

                const resetButton = document.createElement('button');
                resetButton.id = 'reset-search-btn';
                resetButton.innerHTML = `
                    <i class="fas fa-undo"></i>
                    <span>Reset Search</span>
                `;
                resetButton.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 8px 12px;
                    cursor: pointer;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    font-size: 14px;
                    color: #333;
                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                    transition: all 0.2s ease;
                `;

                resetButton.addEventListener('mouseenter', () => {
                    resetButton.style.backgroundColor = '#f8f9fa';
                    resetButton.style.transform = 'translateY(-1px)';
                });

                resetButton.addEventListener('mouseleave', () => {
                    resetButton.style.backgroundColor = 'white';
                    resetButton.style.transform = 'translateY(0)';
                });

                resetButton.addEventListener('click', resetToOriginalSearch);
                mapContainer.appendChild(resetButton);
            }

            // AC2: Load vendors within map bounds - filter existing search results by bounds
            async function loadVendorsInMapBounds(bounds) {
                if (state.isLoadingVendors) return;

                state.isLoadingVendors = true;
                showMapLoadingIndicator();
                showSidebarSkeletonLoader();

                try {
                    // Get bounds coordinates
                    const ne = bounds.getNorthEast();
                    const sw = bounds.getSouthWest();

                    // Instead of calling /vendors/map API, filter existing search results by bounds
                    const allVendors = state.originalSearchResults || [];
                    
                    // Filter vendors that are within the current map bounds
                    const vendorsInBounds = allVendors.filter(vendor => {
                        if (!vendor.Latitude || !vendor.Longitude) return false;
                        
                        const lat = parseFloat(vendor.Latitude);
                        const lng = parseFloat(vendor.Longitude);
                        
                        return lat >= sw.lat() && lat <= ne.lat() && 
                               lng >= sw.lng() && lng <= ne.lng();
                    });

                    console.log(`🗺️ Filtered ${vendorsInBounds.length} vendors from ${allVendors.length} search results within map bounds`);

                    console.log(`🎯 Found ${vendorsInBounds.length} vendors in map bounds`);

                    // AC5: Update sidebar list with contextual results
                    state.filteredVendors = vendorsInBounds;
                    
                    // If we have event location, sort vendors by distance from event first
                    if (window.selectedEventLocation && vendorsInBounds.some(v => v.distanceFromEvent)) {
                        state.filteredVendors.sort((a, b) => {
                            const distA = parseFloat(a.distanceFromEvent) || 999;
                            const distB = parseFloat(b.distanceFromEvent) || 999;
                            return distA - distB;
                        });
                        console.log('📍 Sorted vendors by distance from event location');
                    }

                    updateVendorListForMapBounds();
                    updateMapMarkers();

                    // Update results count with distance info
                    const resultsCount = document.getElementById('results-count');
                    if (resultsCount) {
                        let countText = `${vendorsInBounds.length} vendors in this area`;
                        if (window.selectedEventLocation && vendorsInBounds.length > 0) {
                            countText += ' (sorted by distance from event)';
                        }
                        resultsCount.textContent = countText;
                    }

                } catch (error) {
                    console.error('Error loading vendors in bounds:', error);
                    
                    // Fallback to existing vendor filtering if API fails
                    console.log('🔄 Falling back to local vendor filtering');
                    const ne = bounds.getNorthEast();
                    const sw = bounds.getSouthWest();
                    
                    const vendorsInBounds = state.vendors.filter(vendor => {
                        if (!vendor.coordinates) return false;
                        const lat = vendor.coordinates.lat;
                        const lng = vendor.coordinates.lng;
                        return lat >= sw.lat() && lat <= ne.lat() && 
                               lng >= sw.lng() && lng <= ne.lng();
                    });

                    state.filteredVendors = vendorsInBounds;
                    updateVendorListForMapBounds();
                    // updateMapMarkers(); // DISABLED - causing marker bouncing

                    const resultsCount = document.getElementById('results-count');
                    if (resultsCount) {
                        resultsCount.textContent = `${vendorsInBounds.length} vendors in this area (cached)`;
                    }
                } finally {
                    state.isLoadingVendors = false;
                    hideMapLoadingIndicator();
                    hideSidebarSkeletonLoader();
                }
            }

            // AC6: Reset to original search results
            function resetToOriginalSearch() {
                if (!state.initialMapBounds || !state.originalSearchResults.length) return;

                // Restore original filtered vendors
                state.filteredVendors = [...state.originalSearchResults];
                
                // Reset map bounds
                state.map.fitBounds(state.initialMapBounds);
                
                // Update UI
                // updateMapMarkers(); // DISABLED - causing marker bouncing
                renderVendors();
                
                // Update results count
                const resultsCount = document.getElementById('results-count');
                if (resultsCount) {
                    resultsCount.textContent = `${state.filteredVendors.length} vendors available`;
                }
            }

            // AC5: Update vendor list for map bounds (contextual results)
            function updateVendorListForMapBounds() {
                // Reset to first page when map bounds change
                state.currentPage = 1;
                
                // Update metadata
                updateMetadata({ total: state.filteredVendors.length });
                
                // Re-render vendor cards
                renderVendors();
            }

            // Utility functions (Global)
            window.debounce = function(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            window.boundsEqual = function(bounds1, bounds2, tolerance = 0.001) {
                if (!bounds1 || !bounds2) return false;
                
                const ne1 = bounds1.getNorthEast();
                const sw1 = bounds1.getSouthWest();
                const ne2 = bounds2.getNorthEast();
                const sw2 = bounds2.getSouthWest();
                
                return Math.abs(ne1.lat() - ne2.lat()) < tolerance &&
                       Math.abs(ne1.lng() - ne2.lng()) < tolerance &&
                       Math.abs(sw1.lat() - sw2.lat()) < tolerance &&
                       Math.abs(sw1.lng() - sw2.lng()) < tolerance;
            }

            function showMapLoadingIndicator() {
                const indicator = document.getElementById('map-loading-indicator');
                if (indicator) {
                    indicator.style.display = 'flex';
                }
            }

            function hideMapLoadingIndicator() {
                const indicator = document.getElementById('map-loading-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // Skeleton loader for sidebar during map loading (unified with grid skeletons)
            function showSidebarSkeletonLoader() {
                const vendorGrid = document.getElementById('vendor-grid');
                if (!vendorGrid) return;
                if (vendorGrid.getAttribute('data-skeleton') === '1') return; // already active
                // Use unified skeleton implementation so visuals match vendor cards
                showVendorSkeletons(8);
            }

            function hideSidebarSkeletonLoader() {
                // Use unified hide to remove skeleton state only
                hideVendorSkeletons();
            }

            // Helper function to generate random coordinates (for demo)
            function getRandomLat() { return 34.0522 + (Math.random() * 0.2 - 0.1); }
            function getRandomLng() { return -118.2437 + (Math.random() * 0.2 - 0.1); }

            // Helper function to generate random price level (for demo)
            function getRandomPriceLevel() {
                const levels = ['$', '$$', '$$$'];
                return levels[Math.floor(Math.random() * levels.length)];
            }

            // Setup all event listeners
            function setupEventListeners() {
                // View toggle buttons (new segmented control)
                const listBtnNew = document.getElementById('btn-view-list');
                const mapBtnNew = document.getElementById('btn-view-map');
                const mapEl = document.getElementById('map-view');
                const gridEl = document.getElementById('vendor-grid');
                const paginationEl = document.getElementById('load-more-wrapper');
                const horizEl = document.getElementById('main-horizontal-cards');

                if (listBtnNew && mapBtnNew && mapEl && gridEl) {
                    listBtnNew.addEventListener('click', () => {
                        state.currentView = 'list';
                        document.body.classList.remove('map-active');
                        mapEl.style.display = 'none';
                        gridEl.style.display = 'grid';
                        if (horizEl) horizEl.style.display = 'none';
                        if (paginationEl) paginationEl.style.display = '';
                        listBtnNew.classList.add('active');
                        mapBtnNew.classList.remove('active');
                    });

                    mapBtnNew.addEventListener('click', () => {
                        state.currentView = 'map';
                        document.body.classList.add('map-active');
                        mapEl.style.display = 'block';
                        gridEl.style.display = 'none';
                        if (horizEl) {
                            horizEl.style.display = 'flex';
                            try { renderMainHorizontalCards(); } catch (e) { console.warn('horizontal cards render failed', e); }
                        }
                        if (paginationEl) paginationEl.style.display = 'none';
                        mapBtnNew.classList.add('active');
                        listBtnNew.classList.remove('active');
                        // Initialize Google Map if needed and refresh markers
                        initMapIfNeeded().then(() => updateMapMarkers());
                    });
                }

            // Search
            searchInput.addEventListener('input', filterVendors);

            // Make search icon clickable to focus input
            const searchButton = document.getElementById('search-button');
            if (searchButton) {
                searchButton.addEventListener('click', () => {
                    searchInput.focus();
                });
            }

            // Sorting
            sortSelect.addEventListener('change', sortVendors);

                // Filter resets
                filterResetBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const filterType = btn.id.replace('-reset', '');
                        resetFilter(filterType);
                    });
                });

                // Filter inputs
                document.querySelectorAll('.filter-section input').forEach(input => {
                    input.addEventListener('change', filterVendors);
                });

                // Current location checkbox
                currentLocationCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        requestLocationWithFeedback();
                    } else {
                        state.userLocation = null;
                        locationInput.value = '';
                        locationInput.placeholder = 'City or ZIP code';
                        filterVendors();
                    }
                });

                // Popular filters
                trendingTags.forEach(tag => {
                    tag.addEventListener('click', () => {
                        tag.classList.toggle('active');
                        const filter = tag.dataset.filter;

                        if (tag.classList.contains('active')) {
                            if (!state.filters.popular.includes(filter)) {
                                state.filters.popular.push(filter);
                            }
                        } else {
                            state.filters.popular = state.filters.popular.filter(f => f !== filter);
                        }

                        filterVendors();
                    });
                });

                // Advanced filters toggle
                advancedToggle.addEventListener('click', () => {
                    advancedContent.classList.toggle('show');
                    advancedToggle.querySelector('span').textContent =
                        advancedContent.classList.contains('show') ? '−' : '+';
                });

                // Date filters
                document.getElementById('start-date').addEventListener('change', function() {
                    state.filters.startDate = this.value;
                    filterVendors();
                });

                document.getElementById('end-date').addEventListener('change', function() {
                    state.filters.endDate = this.value;
                    filterVendors();
                });

                // Region filter
                document.getElementById('region-select').addEventListener('change', function() {
                    state.filters.region = this.value;
                    filterVendors();
                });

                // Legacy pagination (no-op when controls not present)
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', () => {
                        if (state.currentPage > 1) {
                            state.currentPage--;
                            renderVendors();
                        }
                    });
                }

                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', () => {
                        const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                        if (state.currentPage < totalPages) {
                            state.currentPage++;
                            renderVendors();
                        }
                    });
                }

                // User nav buttons
                wishlistBtn.addEventListener('click', () => {
                    if (currentUser) {
                        displayUserDashboard('client', 'favorites');
                    } else {
                        profileModal.style.display = 'flex';
                    }
                });

                notificationsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentUser) {
                        toggleNotificationsDropdown(e.target);
                    } else {
                        profileModal.style.display = 'flex';
                    }
                });

            // Profile button click handler (dropdown when logged in, modal when not)
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentUser) {
                    toggleProfileDropdown(e.currentTarget || profileBtn);
                } else {
                    showLoginView();
                    profileModal.style.display = 'flex';
                }
            });

            // Close profile dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('profile-dropdown');
                if (!dropdown) return;
                const isClickInsideDropdown = dropdown.contains(e.target);
                const isProfileButton = e.target.closest('#profile-btn');
                if (!isClickInsideDropdown && !isProfileButton && dropdown.style.display === 'block') {
                    hideProfileDropdown();
                }
            });

            // Logo click navigates to main page
            document.querySelectorAll('.logo').forEach(logo => {
                logo.addEventListener('click', () => {
                    console.log('🏠 Logo clicked - navigating to main page');
                    // Clear the URL path and navigate to main page
                    const baseUrl = window.location.origin;
                    window.history.pushState(null, null, baseUrl);
                    window.location.hash = '';
                    showMainApp();
                });
            });

                // Generic close modal buttons (for all modals)
                document.querySelectorAll('.close-modal').forEach(closeBtn => {
                    closeBtn.addEventListener('click', function() {
                        this.closest('.modal').style.display = 'none';
                        document.body.style.overflow = 'auto';
                    });
                });

                // Generic close modals when clicking outside the content (for modals that allow it)
                document.querySelectorAll('.modal').forEach(m => {
                    const oldListener = m.__overlayClickListener;
                    if (oldListener) {
                        m.removeEventListener('click', oldListener);
                    }

                    const newListener = (e) => {
                        // Only close modal if it doesn't have data-no-outside-close attribute
                        if (e.target === m && !m.hasAttribute('data-no-outside-close')) {
                            m.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }
                    };
                    m.addEventListener('click', newListener);
                    m.__overlayClickListener = newListener;
                });

                // Add an event listener for hash changes
                window.addEventListener('hashchange', handleUrlChange);
                
                // Add window load listener as backup
                window.addEventListener('load', () => {
                    console.log('🔄 Window load event - checking URL again');
                    setTimeout(handleUrlChange, 200);
                });
                
                // Add additional check for direct URL access
                if (window.location.pathname.includes('/listings/') && !window.location.hash) {
                    console.log('🔄 Direct URL detected, forcing routing check');
                    setTimeout(handleUrlChange, 300);
                }

                // Toggle between login and signup forms
                showSignup.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSignupView();
                });

                showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showLoginView();
                });

                // Login with email/password
                loginBtn.addEventListener('click', async () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;

                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email, password }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Login failed');
                        }

                        const userData = await response.json();

                        if (userData.twoFactorRequired) {
                            twofaTempToken = userData.tempToken;
                            pendingLoginEmail = email;
                            showTwoFAView();
                            return;
                        }

                        if (!userData.token) {
                            throw new Error('Login failed: missing token');
                        }

                        // Store the token in localStorage
                        localStorage.setItem('token', userData.token);

                        // Update UI with user data
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });

                        // Connect to chat after login
                        connectToChat();
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Login failed. ' + error.message);
                    }
                });

                // Two-Factor Verification handlers
                verify2FABtn?.addEventListener('click', async () => {
                    const codeEl = document.getElementById('twofa-code');
                    const code = (codeEl?.value || '').trim();
                    if (!code || code.length !== 6) {
                        alert('Enter the 6-digit code');
                        return;
                    }
                    try {
                        const res = await fetch(`${API_BASE_URL}/users/login/verify-2fa`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tempToken: twofaTempToken, code })
                        });
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.message || 'Verification failed');
                        }
                        const userData = await res.json();
                        localStorage.setItem('token', userData.token);
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });
                        connectToChat();
                        twofaTempToken = null;
                        pendingLoginEmail = '';
                        profileModal.style.display = 'none';
                    } catch (e) {
                        console.error('Verify 2FA error:', e);
                        alert(e.message || 'Verification failed');
                    }
                });

                resend2FABtn?.addEventListener('click', async () => {
                    if (!twofaTempToken) { alert('Start login again.'); showLoginView(); return; }
                    try {
                        const res = await fetch(`${API_BASE_URL}/users/login/resend-2fa`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tempToken: twofaTempToken })
                        });
                        if (!res.ok) throw new Error('Could not resend code');
                        alert('A new code was sent to your email.');
                    } catch (e) {
                        console.error('Resend 2FA error:', e);
                        alert(e.message || 'Resend failed');
                    }
                });

                backToLoginBtn?.addEventListener('click', () => {
                    twofaTempToken = null;
                    pendingLoginEmail = '';
                    showLoginView();
                });

                // Sign up with email/password
                signupBtn.addEventListener('click', async () => {
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const accountType = document.getElementById('account-type').value;

                    if (!name || !email || !password) {
                        alert('Please fill in all fields');
                        return;
                    }

                    if (password.length < 8) {
                        alert('Password should be at least 8 characters');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name,
                                email,
                                password,
                                isVendor: accountType === 'vendor'
                            }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Signup failed');
                        }

                        const userData = await response.json();

                        // Store the token
                        localStorage.setItem('token', userData.token);

                        // Update user object and UI
                        currentUser = {
                            id: userData.userId,
                            name: userData.name,
                            email: userData.email,
                            avatar: userData.name[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        };
                        showLoggedInView();
                        profileModal.style.display = 'none';
                        alert(`Welcome, ${currentUser.name}! You are now logged in.`);

                        // Connect to chat after signup
                        connectToChat();

                        // If signing up as vendor, show setup wizard
                        if (accountType === 'vendor') {
                            initializeVendorSetup(currentUser.id);
                        }
                    } catch (error) {
                        console.error('Signup error:', error);
                        alert('Signup failed. ' + error.message);
                    }
                });

                // Google Login Handler
                googleLoginBtn.addEventListener('click', () => {
                    google.accounts.id.initialize({
                        client_id: '900405597637-50g402qo0kbh2msi9bqii8e9od6oq0fk.apps.googleusercontent.com',
                        callback: handleGoogleSignIn
                    });
                    google.accounts.id.prompt();
                });

                // Facebook Login Handler
                facebookLoginBtn.addEventListener('click', () => {
                    FB.login(function(response) {
                        if (response.authResponse) {
                            fetch(`${API_BASE_URL}/users/social-login`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                  email: 'mock-facebook-email@example.com',
                                  name: 'Mock Facebook User',
                                  authProvider: 'facebook',
                                  avatar: 'M'
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.token) {
                                    localStorage.setItem('token', data.token);
                                    simulateLogin({
                                        id: data.userId,
                                        name: data.name,
                                        email: data.email,
                                        avatar: data.name[0].toUpperCase(),
                                        isVendor: data.isVendor || false
                                    });
                                    connectToChat();
                                    promptForAccountType(data.userId);
                                }
                            })
                            .catch(error => {
                                console.error('Facebook login error:', error);
                                alert('Facebook login failed. Please try again.');
                            });
                        }
                    }, {scope: 'public_profile,email'});
                });

                // Logout handler
                logoutBtn.addEventListener('click', () => {
                    // Clear ALL authentication-related data from storage
                    localStorage.removeItem('token');
                    localStorage.removeItem('userSession');
                    localStorage.removeItem('isVendorMode');
                    localStorage.removeItem('activeDashboardSection');
                    localStorage.removeItem('activeClientSection');
                    localStorage.removeItem('activeVendorSection');
                    sessionStorage.clear();

                    // Disconnect from chat
                    if (state.socket) {
                        state.socket.disconnect();
                    }

                    currentUser = null;
                    window.currentUser = null;
                    showLoginView();
                    alert('You have been logged out');

                    // Reset profile button
                    profileBtn.textContent = '👤';
                    profileBtn.style.backgroundColor = '';
                    profileBtn.style.color = '';
                    profileBtn.style.borderRadius = '';
                    profileBtn.style.width = '';
                    profileBtn.style.height = '';
                    profileBtn.style.display = '';
                    profileBtn.style.alignItems = '';
                    profileBtn.style.justifyContent = '';

                    showMainApp();
                });

                // View dashboard button (respects last used mode & section)
                viewDashboardBtn.addEventListener('click', () => {
                    profileModal.style.display = 'none';
                    const preferredMode = (isVendorMode && currentUser.isVendor) ? 'vendor' : 'client';
                    const section = preferredMode === 'vendor' ? (activeVendorSection || 'vendor-dashboard') : (activeClientSection || 'dashboard');
                    displayUserDashboard(preferredMode, section);
                });

                // Profile dropdown menu actions
                document.getElementById('profile-view-dashboard')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideProfileDropdown();
                    const preferredMode = (isVendorMode && currentUser?.isVendor) ? 'vendor' : 'client';
                    const section = preferredMode === 'vendor' ? (activeVendorSection || 'vendor-dashboard') : (activeClientSection || 'dashboard');
                    displayUserDashboard(preferredMode, section);
                });

                document.getElementById('profile-logout')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideProfileDropdown();
                    // Clear ALL authentication-related data from storage
                    localStorage.removeItem('token');
                    localStorage.removeItem('userSession');
                    localStorage.removeItem('isVendorMode');
                    localStorage.removeItem('activeDashboardSection');
                    localStorage.removeItem('activeClientSection');
                    localStorage.removeItem('activeVendorSection');
                    sessionStorage.clear();

                    // Disconnect from chat
                    if (state.socket) {
                        state.socket.disconnect();
                    }

                    currentUser = null;
                    window.currentUser = null;
                    showLoginView();
                    alert('You have been logged out');

                    // Reset profile button
                    profileBtn.textContent = '👤';
                    profileBtn.style.backgroundColor = '';
                    profileBtn.style.color = '';
                    profileBtn.style.borderRadius = '';
                    profileBtn.style.width = '';
                    profileBtn.style.height = '';
                    profileBtn.style.display = '';
                    profileBtn.style.alignItems = '';
                    profileBtn.style.justifyContent = '';

                    showMainApp();
                });

                // Dashboard menu items (unified, event delegation)
                const dashboardMenuEl = clientDashboardContainer.querySelector('.dashboard-menu');
                if (dashboardMenuEl) {
                    dashboardMenuEl.addEventListener('click', (e) => {
                        const link = e.target.closest('a[data-section]');
                        if (!link || !dashboardMenuEl.contains(link)) return;
                        e.preventDefault();
                        const section = link.dataset.section;
                        if (!section) return;
                        const mode = section.startsWith('vendor-') ? 'vendor' : 'client';
                        displayUserDashboard(mode, section);
                    });
                }

                // Removed switch-to-vendor/client buttons in unified menu

                // Header segmented toggle handlers
                const headerToggleClient = document.getElementById('mode-toggle-client');
                const headerToggleVendor = document.getElementById('mode-toggle-vendor');
                if (headerToggleClient && headerToggleVendor) {
                    headerToggleClient.addEventListener('click', () => {
                        displayUserDashboard('client', activeClientSection || 'dashboard');
                    });
                    headerToggleVendor.addEventListener('click', () => {
                        displayUserDashboard('vendor', activeVendorSection || 'vendor-dashboard');
                    });
                }

                // Keyboard shortcut: Ctrl/Cmd + Shift + M toggles mode
                document.addEventListener('keydown', (e) => {
                    const isMeta = navigator.platform.includes('Mac') ? e.metaKey : e.ctrlKey;
                    if (isMeta && e.shiftKey && (e.key === 'M' || e.key === 'm')) {
                        e.preventDefault();
                        const nextMode = isVendorMode ? 'client' : 'vendor';
                        const section = nextMode === 'vendor' ? (activeVendorSection || 'vendor-dashboard') : (activeClientSection || 'dashboard');
                        displayUserDashboard(nextMode, section);
                    }
                });

                // Logout from dashboard
                logoutDashboardBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutBtn.click();
                });

                // Vendor logout item removed; using unified Logout only

                // Vendor registration form steps
                document.querySelectorAll('.next-step').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const currentStep = btn.closest('.form-section');
                        const nextStepId = `reg-step-${btn.dataset.step}`;
                        const nextStep = document.getElementById(nextStepId);

                        if (validateStep(currentStep.id)) {
                            currentStep.style.display = 'none';
                            nextStep.style.display = 'block';
                            updateRegistrationStatus(btn.dataset.step);
                        } else {
                            alert('Please fill out all required fields.');
                        }
                    });
                });

                document.querySelectorAll('.prev-step').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const currentStep = btn.closest('.form-section');
                        const prevStepId = `reg-step-${btn.dataset.step}`;
                        const prevStep = document.getElementById(prevStepId);

                        currentStep.style.display = 'none';
                        prevStep.style.display = 'block';
                        updateRegistrationStatus(btn.dataset.step);
                    });
                });


                // Map controls
                document.getElementById('zoom-in')?.addEventListener('click', () => {
                    if (state.map) {
                        state.map.setZoom(state.map.getZoom() + 1);
                    }
                });

                document.getElementById('zoom-out')?.addEventListener('click', () => {
                    if (state.map) {
                        state.map.setZoom(state.map.getZoom() - 1);
                    }
                });

                locateMeBtn?.addEventListener('click', () => {
                    if (state.userLocation) {
                        centerMapOnUser();
                    } else {
                        requestLocationWithFeedback();
                    }
                });

                // Location permission
                allowLocationBtn.addEventListener('click', () => {
                    locationLoading.style.display = 'inline-block';
                    allowLocationBtn.disabled = true;

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            locationPermissionModal.style.display = 'none';
                            handleLocationSuccess(position);
                            locationLoading.style.display = 'none';
                            allowLocationBtn.disabled = false;
                        },
                        (error) => {
                            console.log("Location error:", error);
                            locationPermissionModal.style.display = 'none';
                            locationLoading.style.display = 'none';
                            allowLocationBtn.disabled = false;
                            currentLocationCheckbox.checked = false;
                            alert("Could not get your location. Please try again or enter a location manually.");
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000
                        }
                    );
                });

                denyLocationBtn.addEventListener('click', () => {
                    locationPermissionModal.style.display = 'none';
                    currentLocationCheckbox.checked = false;
                });

                // Confirmation modal
                document.getElementById('conf-done-btn').addEventListener('click', () => {
                    confirmationModal.style.display = 'none';
                });

                // Category scroll buttons
                if (scrollLeftBtn && scrollRightBtn && categoriesListWrapper) {
                    scrollLeftBtn.addEventListener('click', () => {
                        categoriesListWrapper.scrollBy({
                            left: -200,
                            behavior: 'smooth'
                        });
                    });

                    scrollRightBtn.addEventListener('click', () => {
                        categoriesListWrapper.scrollBy({
                            left: 200,
                            behavior: 'smooth'
                        });
                    });
                }
            }

            // Comprehensive Vendor Setup Wizard State (updated with new steps)
            if (typeof vendorSetupState === 'undefined') {
                var vendorSetupState = {
                    currentStep: 1,
                    vendorId: null,
                    vendorProfileId: null,
                    stepData: {
                        step1: {}, // Business Basics
                        step2: {}, // Location Information
                        step3: {}, // Gallery & Media
                        step4: {}, // Services & Packages
                        step5: {}, // Social Media
                        step6: {}, // Availability & Scheduling
                        step7: {}, // Additional Details (Category-specific questions)
                        step8: {}, // FAQ Section
                        step9: {} // Summary & Completion
                    },
                    gallery: [],
                    portfolio: [],
                    packages: [],
                    services: [],
                    teamMembers: [],
                    faqs: [],
                    categoryQuestions: [],
                    additionalDetails: [],
                    selectedCities: [], // Fix for Step 2 cities/regions
                    serviceCategories: [] // Fix for service categories
                };
            }

            // Initialize Vendor Setup
            function initializeVendorSetup(vendorId) {
                vendorSetupState.vendorId = vendorId;
                vendorSetupState.currentStep = 1;
                
                // Reset all data
                Object.keys(vendorSetupState.stepData).forEach(key => {
                    vendorSetupState.stepData[key] = {};
                });
                vendorSetupState.gallery = [];
                vendorSetupState.portfolio = [];
                vendorSetupState.packages = [];
                vendorSetupState.services = [];
                vendorSetupState.teamMembers = [];
                vendorSetupState.faqs = [];
                
                // Show the setup modal
                vendorRegistrationModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Setup event listeners
                setupVendorSetupEventListeners();
                
                // Show first step
                showSetupStep(1);
            }

            // Setup Event Listeners for All 10 Steps
            function setupVendorSetupEventListeners() {
                // Navigation buttons - Forward
                document.getElementById('next-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('next-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('next-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('next-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('next-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('next-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('next-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('next-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                document.getElementById('next-to-step-10')?.addEventListener('click', () => goToSetupStep(10));
                
                // Navigation buttons - Backward
                document.getElementById('back-to-step-1')?.addEventListener('click', () => goToSetupStep(1));
                document.getElementById('back-to-step-2')?.addEventListener('click', () => goToSetupStep(2));
                document.getElementById('back-to-step-3')?.addEventListener('click', () => goToSetupStep(3));
                document.getElementById('back-to-step-4')?.addEventListener('click', () => goToSetupStep(4));
                document.getElementById('back-to-step-5')?.addEventListener('click', () => goToSetupStep(5));
                document.getElementById('back-to-step-6')?.addEventListener('click', () => goToSetupStep(6));
                document.getElementById('back-to-step-7')?.addEventListener('click', () => goToSetupStep(7));
                document.getElementById('back-to-step-8')?.addEventListener('click', () => goToSetupStep(8));
                document.getElementById('back-to-step-9')?.addEventListener('click', () => goToSetupStep(9));
                
                // Step 3: Gallery & Media functionality
                document.getElementById('featured-image')?.addEventListener('change', handleFeaturedImageUpload);
                document.getElementById('gallery-images')?.addEventListener('change', handleGalleryUpload);
                document.getElementById('add-portfolio-btn')?.addEventListener('click', showPortfolioForm);
                document.getElementById('add-portfolio-item-btn')?.addEventListener('click', addPortfolioItem);
                
                // Step 4: Services & Packages functionality
                document.getElementById('add-service-category-btn')?.addEventListener('click', showServiceCategoryForm);
                document.getElementById('add-category-item-btn')?.addEventListener('click', addServiceCategory);
                document.getElementById('add-service-btn')?.addEventListener('click', showServiceForm);
                document.getElementById('add-service-item-btn')?.addEventListener('click', addServiceItem);
                document.getElementById('add-package-btn')?.addEventListener('click', showPackageForm);
                document.getElementById('add-package-item-btn')?.addEventListener('click', addPackageItem);
                
                // Step 5: Team functionality
                document.getElementById('add-team-member-btn')?.addEventListener('click', showTeamMemberForm);
                document.getElementById('add-team-item-btn')?.addEventListener('click', addTeamMember);
                
                // Step 10: FAQ functionality
                // Move FAQ event listeners to Step 7 for immediate FAQ step functionality
                document.getElementById('add-faq-btn')?.addEventListener('click', showFaqForm);
                document.getElementById('add-faq-item-btn')?.addEventListener('click', addFaqItem);
                
                // Complete setup
                document.getElementById('complete-setup-btn')?.addEventListener('click', completeVendorSetup);
            }

            // Navigation Functions
            async function goToSetupStep(step) {
                // Validate current step before proceeding
                if (!validateCurrentStep()) {
                    return;
                }
                
                // Save current step data
                saveCurrentStepData();
                
                // Submit current step data to backend
                try {
                    await submitCurrentStepToBackend();
                } catch (error) {
                    console.error('Failed to save step data:', error);
                    alert('Failed to save step data. Please try again.');
                    return;
                }
                
                // Load category-specific questions when entering step 4
                if (step === 4) {
                    await loadCategoryQuestions();
                }
                
                // Load summary when entering step 9
                if (step === 9) {
                    await loadVendorSummary();
                }
                
                // Update step
                vendorSetupState.currentStep = step;
                showSetupStep(step);
            }

            // Load category-specific questions based on primary category
            async function loadCategoryQuestions() {
                const primaryCategory = document.getElementById('primary-category')?.value;
                if (!primaryCategory) {
                    console.warn('No primary category selected');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/category-questions/${primaryCategory}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load category questions');
                    }

                    const data = await response.json();
                    renderCategoryQuestions(data.questions || []);

                } catch (error) {
                    console.error('Error loading category questions:', error);
                    document.getElementById('category-questions-container').innerHTML = 
                        '<p style="color: var(--accent);">Failed to load questions. Please try again.</p>';
                }
            }

            // Render category-specific questions
            function renderCategoryQuestions(questions) {
                const container = document.getElementById('category-questions-container');
                if (!container) return;

                if (questions.length === 0) {
                    container.innerHTML = '<p>No additional questions for this category.</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 1rem;">';
                
                questions.forEach((question, index) => {
                    html += `
                        <div class="form-group" style="padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                ${question.QuestionText}
                                ${question.IsRequired ? '<span style="color: var(--accent);">*</span>' : ''}
                            </label>
                    `;

                    if (question.QuestionType === 'YesNo') {
                        html += `
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="Yes" ${question.IsRequired ? 'required' : ''}>
                                    Yes
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                    <input type="radio" name="question_${question.QuestionID}" value="No" ${question.IsRequired ? 'required' : ''}>
                                    No
                                </label>
                            </div>
                        `;
                    } else if (question.QuestionType === 'Text') {
                        html += `
                            <textarea name="question_${question.QuestionID}" rows="3" 
                                     style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                     ${question.IsRequired ? 'required' : ''}></textarea>
                        `;
                    } else if (question.QuestionType === 'Number') {
                        html += `
                            <input type="number" name="question_${question.QuestionID}" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"
                                   ${question.IsRequired ? 'required' : ''}>
                        `;
                    }

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            }

            // Load and display vendor summary
            async function loadVendorSummary() {
                const container = document.getElementById('setup-summary-content');
                if (!container) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/vendors/summary/${vendorSetupState.vendorProfileId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load vendor summary');
                    }

                    const data = await response.json();
                    renderVendorSummary(data);

                } catch (error) {
                    console.error('Error loading vendor summary:', error);
                    container.innerHTML = '<p style="color: var(--accent);">Failed to load summary. Please try again.</p>';
                }
            }

            // Render comprehensive vendor summary
            function renderVendorSummary(summaryData) {
                const container = document.getElementById('setup-summary-content');
                if (!container || !summaryData.success) return;

                const data = summaryData.data;
                let html = '<div style="display: grid; gap: 1.5rem;">';

                // Business Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                📋 Business Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Business Name:</strong> ${info.BusinessName || 'Not provided'}</div>
                                <div><strong>Display Name:</strong> ${info.DisplayName || 'Not provided'}</div>
                                <div><strong>Email:</strong> ${info.BusinessEmail || 'Not provided'}</div>
                                <div><strong>Phone:</strong> ${info.BusinessPhone || 'Not provided'}</div>
                                <div><strong>Website:</strong> ${info.Website || 'Not provided'}</div>
                                <div><strong>Years in Business:</strong> ${info.YearsInBusiness || 'Not provided'}</div>
                            </div>
                            ${info.BusinessDescription ? `<div style="margin-top: 1rem;"><strong>Description:</strong><br>${info.BusinessDescription}</div>` : ''}
                            ${info.Tagline ? `<div style="margin-top: 0.5rem;"><strong>Tagline:</strong> ${info.Tagline}</div>` : ''}
                        </div>
                    `;
                }

                // Location Information
                if (data.basicInfo) {
                    const info = data.basicInfo;
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location Information
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div><strong>Address:</strong> ${info.Address || 'Not provided'}</div>
                                <div><strong>City:</strong> ${info.City || 'Not provided'}</div>
                                <div><strong>State:</strong> ${info.State || 'Not provided'}</div>
                                <div><strong>Country:</strong> ${info.Country || 'Not provided'}</div>
                                <div><strong>Postal Code:</strong> ${info.PostalCode || 'Not provided'}</div>
                            </div>
                            ${info.AdditionalCitiesServed ? `<div style="margin-top: 1rem;"><strong>Additional Cities/Regions Served:</strong><br>${info.AdditionalCitiesServed}</div>` : ''}
                        </div>
                    `;
                }

                // Categories
                if (data.categories && data.categories.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-tags" style="margin-right: 0.5rem;"></i>Categories
                            </h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.categories.map(cat => `<span style="background-color: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">${cat.Category}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Gallery
                if (data.imageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-images" style="margin-right: 0.5rem;"></i>Gallery
                            </h5>
                            <div><strong>Images Uploaded:</strong> ${data.imageCount} images</div>
                            ${data.basicInfo?.FeaturedImageURL ? '<div style="margin-top: 0.5rem;"><strong>Featured Image:</strong> <i class="fas fa-check" style="color: #28a745;"></i> Set</div>' : ''}
                        </div>
                    `;
                }

                // Services & Packages
                if (data.serviceCount > 0 || data.packageCount > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                <i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Services & Packages
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>Services:</strong> ${data.serviceCount || 0} services</div>
                                <div><strong>Packages:</strong> ${data.packageCount || 0} packages</div>
                            </div>
                        </div>
                    `;
                }

                // Social Media
                if (data.socialMedia && data.socialMedia.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🌐 Social Media
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.socialMedia.map(social => `<div><strong>${social.Platform}:</strong> ${social.URL}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Business Hours
                if (data.businessHours && data.businessHours.length > 0) {
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                🕒 Business Hours
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.businessHours.map(hours => `
                                    <div><strong>${days[hours.DayOfWeek]}:</strong> 
                                    ${hours.IsAvailable ? `${hours.OpenTime} - ${hours.CloseTime}` : 'Closed'}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Additional Details (Category-specific questions)
                if (data.additionalDetails && data.additionalDetails.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Additional Details
                            </h5>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.additionalDetails.map(detail => `<div><strong>${detail.QuestionText}:</strong> ${detail.Answer}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // FAQs
                if (data.faqs && data.faqs.length > 0) {
                    html += `
                        <div class="summary-section">
                            <h5 style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                                ❓ Frequently Asked Questions
                            </h5>
                            <div style="display: grid; gap: 1rem;">
                                ${data.faqs.map(faq => `
                                    <div style="padding: 1rem; background-color: white; border-radius: var(--radius); border: 1px solid var(--border);">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Q: ${faq.Question}</div>
                                        <div>A: ${faq.Answer}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            }

            function showSetupStep(step) {
                // Clear any previous setup modal error
                try { const m = document.getElementById('vendor-registration-modal'); if (typeof clearModalError === 'function' && m) clearModalError(m); } catch {}
                // Hide all steps
                document.querySelectorAll('.setup-step').forEach(stepEl => {
                    stepEl.style.display = 'none';
                });
                
                // Show current step
                const currentStepEl = document.getElementById(`setup-step-${step}`);
                if (currentStepEl) {
                    currentStepEl.style.display = 'block';
                }
                
                // Update progress bar (10 steps total)
                const progressBar = document.getElementById('setup-progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${(step / 9) * 100}%`;
                }
                const registrationTitle = document.getElementById('registration-title');
                const setupTitles = { 1: 'Business Basics', 2: 'Location Information', 3: 'Services & Packages', 4: 'Additional Details', 5: 'Availability & Scheduling', 6: 'Gallery & Media', 7: 'Social Media', 8: 'FAQ Section', 9: 'Setup Summary' };
                if (registrationTitle) registrationTitle.innerHTML = `<span class="step-number-badge">${step}</span>Step ${step} of 9: ${setupTitles[step] || 'Complete Your Vendor Setup'}`;
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    indicator.classList.remove('active', 'completed');
                    if (index + 1 === step) {
                        indicator.classList.add('active');
                    } else if (index + 1 < step) {
                        indicator.classList.add('completed');
                    }
                });
                if (step === 3) {
                    try { if (typeof loadPredefinedServices === 'function') { loadPredefinedServices(); } } catch (e) {}
                }
                
                switch(step) {
                    case 1: // Business Basics
                        const businessName = document.getElementById('business-name')?.value;
                        const businessDescription = document.getElementById('business-description')?.value;
                        if (!businessName || !businessDescription) {
                            alert('Please fill in all required fields for Business Basics.');
                            return false;
                        }
                        break;
                    case 2: // Location Information
                        const address = document.getElementById('business-address')?.value;
                        if (!address) {
                            alert('Please provide your business address.');
                            return false;
                        }
                        break;
                    case 3: // Services & Packages
                        const selectedServices = vendorSetupState.selectedPredefinedServices || [];
                        if (selectedServices.length === 0) {
                            alert('Please select at least one service to offer to your clients.');
                            return false;
                        }
                        
                        // Validate that all selected services have pricing based on selected pricing model
                        const invalidServices = selectedServices.filter(svc => {
                            const model = svc.pricingModel; // 'time_based' | 'fixed_price' | 'per_attendee'
                            if (model === 'time_based') {
                                return !(svc.baseRate > 0 && (svc.baseDurationMinutes > 0 || svc.durationMinutes > 0));
                            } else if (model === 'fixed_price') {
                                return !(svc.fixedPrice > 0);
                            } else if (model === 'per_attendee') {
                                return !(svc.pricePerPerson > 0);
                            }
                            // Fallback to legacy checks if model missing
                            return !((svc.vendorPrice && svc.vendorPrice > 0) || (svc.price && svc.price > 0));
                        });
                        if (invalidServices.length > 0) {
                            const names = invalidServices.map(s => s.name || s.serviceName || 'Unnamed Service').join(', ');
                            alert('Please provide pricing for all selected services. Missing: ' + names);
                            return false;
                        }
                        break;
                    // Add more validation as needed
                }
                return true;
            }

            // Data Collection Functions
            function saveCurrentStepData() {
                const step = vendorSetupState.currentStep;
                
                switch(step) {
                    case 1: // Business Basics
                        const primaryCategory = document.getElementById('primary-category')?.value || '';
                        const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || [])
                            .map(option => option.value);
                        
                        vendorSetupState.stepData.step1 = {
                            businessName: document.getElementById('business-name')?.value || '',
                            displayName: document.getElementById('display-name')?.value || '',
                            businessEmail: document.getElementById('business-email')?.value || '',
                            businessPhone: document.getElementById('business-phone')?.value || '',
                            websiteUrl: document.getElementById('website-url')?.value || '',
                            yearsInBusiness: document.getElementById('years-in-business')?.value || '',
                            businessDescription: document.getElementById('business-description')?.value || '',
                            tagline: document.getElementById('tagline')?.value || '',
                            primaryCategory: primaryCategory,
                            additionalCategories: additionalCategories,
                            allCategories: [primaryCategory, ...additionalCategories].filter(cat => cat)
                        };
                        break;
                    case 2: // Location Information
                        vendorSetupState.stepData.step2 = {
                            businessAddress: document.getElementById('business-address')?.value || '',
                            businessCity: document.getElementById('business-city')?.value || '',
                            businessState: document.getElementById('business-state')?.value || '',
                            businessCountry: document.getElementById('business-country')?.value || 'Canada',
                            businessPostal: document.getElementById('business-postal')?.value || '',
                            businessLatitude: document.getElementById('business-latitude')?.value || '',
                            businessLongitude: document.getElementById('business-longitude')?.value || '',
                            additionalCities: vendorSetupState.selectedCities.join(', ') // Save selected cities properly
                        };
                        console.log('Step 2 data saved:', vendorSetupState.stepData.step2);
                        break;
                    case 6: // Social Media & Links
                        vendorSetupState.stepData.step6 = {
                            website: document.getElementById('business-website')?.value || '',
                            facebook: document.getElementById('social-facebook')?.value || '',
                            instagram: document.getElementById('social-instagram')?.value || '',
                            twitter: document.getElementById('social-twitter')?.value || '',
                            linkedin: document.getElementById('social-linkedin')?.value || '',
                            youtube: document.getElementById('social-youtube')?.value || '',
                            tiktok: document.getElementById('social-tiktok')?.value || ''
                        };
                        break;
                    case 7: // Additional Details (Category-specific questions)
                        const categoryAnswers = [];
                        const questionInputs = document.querySelectorAll('#category-questions-container input, #category-questions-container textarea, #category-questions-container select');
                        
                        questionInputs.forEach(input => {
                            if (input.name && input.name.startsWith('question_')) {
                                const questionId = input.name.replace('question_', '');
                                let answer = input.value?.trim() || '';
                                
                                // Handle different input types
                                if (input.type === 'checkbox') {
                                    answer = input.checked ? 'Yes' : 'No';
                                } else if (input.type === 'radio') {
                                    if (input.checked) {
                                        answer = input.value;
                                    } else {
                                        return; // Skip unchecked radio buttons
                                    }
                                }
                                
                                if (answer) {
                                    categoryAnswers.push({
                                        questionId: parseInt(questionId),
                                        answer: answer
                                    });
                                }
                            }
                        });
                        
                        vendorSetupState.stepData.step4 = {
                            categoryAnswers: categoryAnswers,
                            primaryCategory: document.getElementById('primary-category')?.value || ''
                        };
                        break;
                    case 8: // FAQ Section - COMPLETELY OVERRIDE ANY LEGACY POLICIES DATA
                        // Collect FAQ data from the FAQ list
                        const faqs = [];
                        const faqItems = document.querySelectorAll('#faqs-list .faq-item-display');
                        
                        faqItems.forEach(item => {
                            const questionText = item.querySelector('.faq-question-text')?.textContent?.trim();
                            const answerText = item.querySelector('.faq-answer-text')?.textContent?.trim();
                            
                            // Clean up the question and answer text (remove "Q:" and "A:" prefixes)
                            const question = questionText ? questionText.replace(/^Q:\s*/, '').trim() : '';
                            const answer = answerText ? answerText.replace(/^A:\s*/, '').trim() : '';
                            
                            if (question && answer) {
                                faqs.push({
                                    question: question,
                                    answer: answer
                                });
                            }
                        });
                        
                        // Also collect from vendorSetupState.faqs if it exists
                        if (vendorSetupState.faqs && vendorSetupState.faqs.length > 0) {
                            vendorSetupState.faqs.forEach(faq => {
                                if (faq.question && faq.answer) {
                                    faqs.push({
                                        question: faq.question,
                                        answer: faq.answer
                                    });
                                }
                            });
                        }
                        
                        // FORCE FAQ data structure - completely override any legacy policies data
                        vendorSetupState.stepData.step8 = {
                            faqs: faqs
                        };
                        
                        // CRITICAL: Remove any legacy policies data that might exist
                        delete vendorSetupState.stepData.step8.depositRequirements;
                        delete vendorSetupState.stepData.step8.cancellationPolicy;
                        delete vendorSetupState.stepData.step8.reschedulingPolicy;
                        delete vendorSetupState.stepData.step8.paymentMethods;
                        delete vendorSetupState.stepData.step8.paymentTerms;
                        
                        console.log('Step 8 FAQ data collected:', vendorSetupState.stepData.step8);
                        break;
                    case 9: // Verification & Legal
                        vendorSetupState.stepData.step9 = {
                            licenseNumber: document.getElementById('license-number')?.value || '',
                            insuranceVerified: document.getElementById('insurance-verified')?.checked || false,
                            awardsCertifications: document.getElementById('awards-certifications')?.value || '',
                            ecoFriendly: document.getElementById('eco-friendly')?.checked || false,
                            premiumStatus: document.getElementById('premium-status')?.checked || false
                        };
                        break;

                }
            }

            // Predefined Services Functions
            async function loadPredefinedServices() {
                console.log('Loading predefined services...');
                
                // Show loading state
                document.getElementById('predefined-services-loading').style.display = 'block';
                document.getElementById('predefined-services-container').style.display = 'none';
                document.getElementById('no-services-message').style.display = 'none';
                
                try {
                    // Get selected categories from Step 1
                    const primaryCategory = document.getElementById('primary-category')?.value;
                    const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || [])
                        .map(option => option.value);
                    
                    const selectedCategories = [primaryCategory, ...additionalCategories].filter(cat => cat);
                    console.log('Selected categories from Step 1:', selectedCategories);
                    
                    if (selectedCategories.length === 0) {
                        console.warn('No categories selected in Step 1');
                        showNoServicesMessage();
                        return;
                    }
                    
                    // Fetch all predefined services
                    const response = await fetch(`${API_BASE_URL}/vendors/predefined-services`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Predefined services response:', data);
                    
                    if (!data.success || !data.servicesByCategory) {
                        throw new Error('Invalid response format');
                    }
                    
                    // Filter services by selected categories
                    const relevantServices = [];
                    selectedCategories.forEach(category => {
                        const categoryKey = findMatchingCategoryKey(category, data.servicesByCategory);
                        if (categoryKey && data.servicesByCategory[categoryKey]) {
                            data.servicesByCategory[categoryKey].forEach(service => {
                                relevantServices.push({
                                    ...service,
                                    category: categoryKey
                                });
                            });
                        }
                    });
                    
                    console.log('Relevant services found:', relevantServices);
                    
                    if (relevantServices.length === 0) {
                        showNoServicesMessage();
                        return;
                    }
                    
                    // Initialize selected services in vendor state
                    if (!vendorSetupState.selectedPredefinedServices) {
                        vendorSetupState.selectedPredefinedServices = [];
                    }
                    
                    // Display services
                    displayPredefinedServices(relevantServices);
                    
                } catch (error) {
                    console.error('Error loading predefined services:', error);
                    showNoServicesMessage();
                }
            }
            
            function findMatchingCategoryKey(selectedCategory, servicesByCategory) {
                // Direct match first
                if (servicesByCategory[selectedCategory]) {
                    return selectedCategory;
                }
                
                // Case-insensitive match
                const lowerSelected = selectedCategory.toLowerCase();
                for (const key of Object.keys(servicesByCategory)) {
                    if (key.toLowerCase() === lowerSelected) {
                        return key;
                    }
                }
                
                // Partial match for common mappings
                const categoryMappings = {
                    'photo': ['Photography', 'Photo'],
                    'music': ['Music & Entertainment', 'Music'],
                    'beauty': ['Beauty & Wellness', 'Beauty'],
                    'catering': ['Catering', 'Food & Catering'],
                    'venue': ['Venue', 'Venues'],
                    'transport': ['Transportation', 'Transport'],
                    'decor': ['Floral & Decor', 'Decor'],
                    'planner': ['Event Planning', 'Planning'],
                    'entertainment': ['Music & Entertainment', 'Entertainment']
                };
                
                if (categoryMappings[lowerSelected]) {
                    for (const mapping of categoryMappings[lowerSelected]) {
                        for (const key of Object.keys(servicesByCategory)) {
                            if (key.toLowerCase().includes(mapping.toLowerCase())) {
                                return key;
                            }
                        }
                    }
                }
                
                return null;
            }
            
            // Add Service skeleton card and popover picker (restored inside script)
            function createAddServiceCard() {
                const add = document.createElement('div');
                add.className = 'add-service-card';
                add.style.cssText = 'width:100%; border:2px dashed var(--border); border-radius:12px; height: fit-content; background:#f8fafc; display:flex; align-items:center; justify-content:center; padding:16px; cursor:pointer; position:relative;';
                add.innerHTML = `
                    <div style="text-align:center; color:#64748b;">
                        <div style="font-size:28px; line-height:1; margin-bottom:8px;"><i class=\"fas fa-plus-circle\"></i></div>
                        <div style="font-weight:600;">Add a service</div>
                        <div style="font-size:0.85rem;">Click to choose from the list</div>
                    </div>
                `;
                add.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showServicePickerPopover(add);
                });
                return add;
            }

            function showServicePickerPopover(anchorEl) {
                // remove any existing popover
                const existing = document.getElementById('service-picker-popover');
                if (existing) existing.remove();
                
                const pop = document.createElement('div');
                pop.id = 'service-picker-popover';
                pop.style.cssText = 'position:absolute; z-index:1000; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.12); width:320px; max-height:320px; overflow:auto; padding:8px;';
                
                // Position relative to anchor
                const rect = anchorEl.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                pop.style.top = (rect.top + scrollTop + anchorEl.offsetHeight + 8) + 'px';
                pop.style.left = (rect.left + scrollLeft) + 'px';
                
                // Build list with simple filter
                pop.innerHTML = `
                    <div style=\"position:sticky; top:0; background:#fff; padding:6px 6px 8px;\">
                        <input id=\"service-picker-filter\" type=\"text\" placeholder=\"Search services...\" style=\"width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px;\">
                    </div>
                    <div id=\"service-picker-list\"></div>
                `;
                document.body.appendChild(pop);
                
                const listEl = pop.querySelector('#service-picker-list');
                function renderList(query = '') {
                    const q = query.trim().toLowerCase();
                    const options = (window.vendorAvailableServices || []).filter(s =>
                        !q || s.name.toLowerCase().includes(q) || (s.category||'').toLowerCase().includes(q)
                    );
                    listEl.innerHTML = options.map(s => `
                        <button data-id=\"${s.id}\" style=\"width:100%; text-align:left; padding:10px; border:none; background:#fff; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;\">\n                            <span>${s.name}</span>\n                            <span style=\"font-size:0.75rem; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:999px;\">${s.category||''}</span>\n                        </button>
                    `).join('');
                }
                renderList();
                
                pop.querySelector('#service-picker-filter').addEventListener('input', (e) => renderList(e.target.value));
                listEl.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-id]');
                    if (!btn) return;
                    const id = btn.getAttribute('data-id');
                    addVendorServiceById(id);
                    pop.remove();
                });
                
                // Close on outside click or ESC
                const onDocClick = (e) => {
                    if (!pop.contains(e.target) && e.target !== anchorEl) {
                        pop.remove();
                        document.removeEventListener('mousedown', onDocClick);
                        document.removeEventListener('keydown', onKey);
                    }
                };
                const onKey = (e) => {
                    if (e.key === 'Escape') {
                        pop.remove();
                        document.removeEventListener('mousedown', onDocClick);
                        document.removeEventListener('keydown', onKey);
                    }
                };
                document.addEventListener('mousedown', onDocClick);
                document.addEventListener('keydown', onKey);
            }

            function displayPredefinedServices(services) {
                const grid = document.getElementById('predefined-services-grid');
                const loadingEl = document.getElementById('predefined-services-loading');
                const containerEl = document.getElementById('predefined-services-container');
                
                // Hide loading, show container
                loadingEl.style.display = 'none';
                containerEl.style.display = 'block';
                
                // Save services globally for picker access
                window.vendorAvailableServices = Array.isArray(services) ? services.slice() : [];
                
                // Build horizontal row with Add Service skeleton
                const rowHtml = `
                    <div id="vendor-services-grid"></div>
                `;
                grid.innerHTML = rowHtml;
                
                // Insert initial Add Service card
                const gridEl = document.getElementById('vendor-services-grid');
                gridEl.appendChild(createAddServiceCard());
                
                // Preload already selected services if any
                (vendorSetupState.selectedPredefinedServices || []).forEach(sel => {
                    addVendorServiceById(sel.id, true);
                });
            }
            
            function createPredefinedServiceCard(service) {
                const card = document.createElement('div');
                card.className = 'predefined-service-card';
                card.dataset.serviceId = service.id;
                card.dataset.serviceName = service.name;
                card.dataset.serviceCategory = service.category;
                
                card.innerHTML = `
                    <div class="service-card-header">
                        <h6 class="service-card-title" style="display:flex; align-items:center; gap:0.5rem;">
                            ${service.name}
                            <span style="font-size:0.7rem; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:999px; font-weight:600;">${service.category}</span>
                        </h6>
                        <div class="service-card-check" style="margin-left:auto;">
                            <i class="fas fa-check"></i>
                        </div>
                        <button type="button" class="remove-service-btn" aria-label="Remove" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="service-card-description">
                        ${service.description || 'Professional service offering'}
                    </div>
                    
                    <div class="vendor-customization-form">
                        <h6 style="margin: 0 0 1rem 0; color: var(--primary); font-size: 0.9rem;">Customize Your Service</h6>
                        <div class="form-row-inline">
                            <div class="form-group-inline" style="min-width: 200px;">
                                <label>Pricing Model *</label>
                                <select class="vendor-pricing-model">
                                    <option value="time_based" selected>Time-based</option>
                                    <option value="fixed_price">Fixed Price</option>
                                    <option value="per_attendee">Per Attendee</option>
                                </select>
                            </div>
                        </div>

                        <div class="vendor-time-based" style="margin-top: 0.5rem;">
                            <div class="form-row-inline">
                                <div class="form-group-inline">
                                    <label>Base Duration (min) *</label>
                                    <input type="number" class="vendor-duration-input" min="15" step="15" value="${service.defaultDuration || 60}" placeholder="60" required>
                                </div>
                                <div class="form-group-inline">
                                    <label>Base Rate ($) *</label>
                                    <input type="number" class="vendor-base-rate" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group-inline">
                                    <label>Overtime ($/hr) *</label>
                                    <input type="number" class="vendor-overtime-rate" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>

                        <div class="vendor-fixed-price-section" style="margin-top: 0.5rem; display: none;">
                            <div class="form-row-inline">
                                <div class="form-group-inline">
                                    <label>Price ($) *</label>
                                    <input type="number" class="vendor-fixed-price-input" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>

                        <div class="vendor-per-attendee-section" style="margin-top: 0.5rem; display: none;">
                            <div class="form-row-inline">
                                <div class="form-group-inline">
                                    <label>Price Per Person ($) *</label>
                                    <input type="number" class="vendor-price-per-person" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group-inline">
                                    <label>Min Attendees *</label>
                                    <input type="number" class="vendor-min-attendees" min="1" step="1" placeholder="1" required>
                                </div>
                                <div class="form-group-inline">
                                    <label>Max Attendees *</label>
                                    <input type="number" class="vendor-max-attendees" min="1" step="1" placeholder="10" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group-inline">
                            <label>Your Description *</label>
                            <textarea class="vendor-description-input" 
                                      placeholder="Add any specific details about how you provide this service..."
                                      rows="2" required></textarea>
                        </div>
                    </div>
                `;
                
                // Add click handler for service selection (ignore when clicking inputs or remove)
                card.addEventListener('click', (e) => {
                    // Don't toggle if clicking on form inputs
                    if (e.target.closest('.vendor-customization-form input, .vendor-customization-form textarea, .vendor-customization-form select, .remove-service-btn')) {
                        return;
                    }
                    toggleServiceSelection(card, service);
                });
                
                // Remove handler
                const removeBtn = card.querySelector('.remove-service-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    removeSelectedService(service.id);
                    card.remove();
                    updateSelectedServicesCount();
                    updateSelectedServicesSummary();
                    const countEl = document.getElementById('vendor-added-count');
                    const gridEl = document.getElementById('vendor-services-grid');
                    if (countEl && gridEl) {
                        const count = gridEl.querySelectorAll('.predefined-service-card').length;
                        countEl.textContent = `${count} added`;
                    }
                });

                return card;
            }

            // Add a vendor service card by its ID from the picker
            function addVendorServiceById(serviceId, isPreload = false) {
                const svc = (window.vendorAvailableServices || []).find(s => String(s.id) === String(serviceId));
                if (!svc) return;
                const gridEl = document.getElementById('vendor-services-grid');
                if (!gridEl) return;
                // Prevent duplicates in DOM
                if (gridEl.querySelector(`.predefined-service-card[data-service-id="${svc.id}"]`)) {
                    return;
                }
                const card = createPredefinedServiceCard(svc);
                card.style.opacity = '0';
                card.style.transform = 'translateY(6px)';
                card.style.transition = 'opacity 160ms ease, transform 180ms ease';
                
                // Insert before the Add card (which should be last)
                const addCard = gridEl.querySelector('.add-service-card');
                if (addCard) {
                    gridEl.insertBefore(card, addCard);
                } else {
                    gridEl.appendChild(card);
                }
                
                requestAnimationFrame(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                });
                // Mark as selected and push to state if not already there
                card.classList.add('selected');
                if (!vendorSetupState.selectedPredefinedServices?.some(s => s.id === svc.id)) {
                    addSelectedService(card, svc);
                }
                // Update counts and empty state msg
                const countEl = document.getElementById('vendor-added-count');
                const gridEl2 = document.getElementById('vendor-services-grid');
                const count = gridEl2 ? gridEl2.querySelectorAll('.predefined-service-card').length : 0;
                if (countEl) countEl.textContent = `${count} added`;
                
                // Focus first relevant input in the card and scroll into view
                if (!isPreload) {
                    card.scrollIntoView({ behavior: 'smooth', inline: 'end', block: 'nearest' });
                    const firstInput = card.querySelector('.vendor-customization-form select, .vendor-customization-form input');
                    if (firstInput) {
                        setTimeout(() => { try { firstInput.focus(); } catch(_){} }, 200);
                    }
                }
            }
            
            function toggleServiceSelection(card, service) {
                const isSelected = card.classList.contains('selected');
                
                if (isSelected) {
                    // Deselect service
                    card.classList.remove('selected');
                    removeSelectedService(service.id);
                } else {
                    // Select service
                    card.classList.add('selected');
                    addSelectedService(card, service);
                }
                
                updateSelectedServicesCount();
                updateSelectedServicesSummary();
            }
            
            function addSelectedService(card, service) {
                // Remove if already exists
                removeSelectedService(service.id);
                
                const selectedService = {
                    id: service.id,
                    predefinedServiceId: service.id,
                    name: service.name,
                    description: service.description,
                    category: service.category,
                    defaultDuration: service.defaultDuration,
                    price: 0,
                    durationMinutes: service.defaultDuration || 60,
                    vendorPrice: 0,
                    vendorDuration: service.defaultDuration || 60,
                    vendorDescription: '',
                    // Unified pricing fields
                    pricingModel: 'time_based',
                    baseDurationMinutes: service.defaultDuration || 60,
                    baseRate: null,
                    overtimeRatePerHour: null,
                    minimumBookingFee: null,
                    fixedPricingType: 'fixed_price',
                    fixedPrice: null,
                    pricePerPerson: null,
                    minimumAttendees: null,
                    maximumAttendees: null
                };
                
                vendorSetupState.selectedPredefinedServices.push(selectedService);
                
                // Add event listeners to form inputs
                const durationInput = card.querySelector('.vendor-duration-input');
                const descriptionInput = card.querySelector('.vendor-description-input');
                const pricingModelSelect = card.querySelector('.vendor-pricing-model');
                const timeBasedSection = card.querySelector('.vendor-time-based');
                // distinct sections for fixed price and per attendee
                const fixedPriceSection = card.querySelector('.vendor-fixed-price-section');
                const perAttendeeSection = card.querySelector('.vendor-per-attendee-section');
                const baseRateInput = card.querySelector('.vendor-base-rate');
                const overtimeRateInput = card.querySelector('.vendor-overtime-rate');
                const minFeeInput = card.querySelector('.vendor-min-fee');
                // pricing type is determined by pricingModelSelect; there's no separate selector
                const fixedPriceInput = card.querySelector('.vendor-fixed-price-input');
                const pppInput = card.querySelector('.vendor-price-per-person');
                const minAttInput = card.querySelector('.vendor-min-attendees');
                const maxAttInput = card.querySelector('.vendor-max-attendees');
                
                const updateServiceData = () => {
                    const serviceIndex = vendorSetupState.selectedPredefinedServices.findIndex(s => s.id === service.id);
                    if (serviceIndex !== -1) {
                        // no generic price input in the card; derive price per model
                        const priceValue = 0;
                        const durationValue = parseInt(durationInput.value) || service.defaultDuration || 60;
                        const descriptionValue = descriptionInput.value.trim();
                        const pricingModelVal = pricingModelSelect?.value || 'time_based';
                        const baseRateVal = baseRateInput ? parseFloat(baseRateInput.value) : null;
                        const overtimeRateVal = overtimeRateInput ? parseFloat(overtimeRateInput.value) : null;
                        const minFeeVal = minFeeInput ? parseFloat(minFeeInput.value) : null;
                        // derive fixedPricingType from pricingModel
                        const fixedTypeVal = pricingModelVal === 'per_attendee' ? 'per_attendee' : (pricingModelVal === 'fixed_price' ? 'fixed_price' : null);
                        const fixedPriceVal = fixedPriceInput ? parseFloat(fixedPriceInput.value) : null;
                        const pppVal = pppInput ? parseFloat(pppInput.value) : null;
                        const minAttVal = minAttInput ? parseInt(minAttInput.value) : null;
                        const maxAttVal = maxAttInput ? parseInt(maxAttInput.value) : null;
                        
                        vendorSetupState.selectedPredefinedServices[serviceIndex].vendorPrice = priceValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].vendorDuration = durationValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].vendorDescription = descriptionValue;
                        
                        // Update API-compatible fields
                        vendorSetupState.selectedPredefinedServices[serviceIndex].price = priceValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].durationMinutes = durationValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].description = descriptionValue;
                        // Unified pricing fields
                        vendorSetupState.selectedPredefinedServices[serviceIndex].pricingModel = pricingModelVal;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].baseDurationMinutes = durationValue;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].baseRate = Number.isFinite(baseRateVal) ? baseRateVal : null;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].overtimeRatePerHour = Number.isFinite(overtimeRateVal) ? overtimeRateVal : null;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].minimumBookingFee = Number.isFinite(minFeeVal) ? minFeeVal : null;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].fixedPricingType = fixedTypeVal;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].fixedPrice = Number.isFinite(fixedPriceVal) ? fixedPriceVal : null;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].pricePerPerson = Number.isFinite(pppVal) ? pppVal : null;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].minimumAttendees = Number.isFinite(minAttVal) ? minAttVal : null;
                        vendorSetupState.selectedPredefinedServices[serviceIndex].maximumAttendees = Number.isFinite(maxAttVal) ? maxAttVal : null;

                        // Clear out non-applicable values based on selected pricing model
                        if (pricingModelVal === 'time_based') {
                            vendorSetupState.selectedPredefinedServices[serviceIndex].fixedPricingType = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].fixedPrice = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].pricePerPerson = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].minimumAttendees = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].maximumAttendees = null;
                        } else if (pricingModelVal === 'fixed_price') {
                            vendorSetupState.selectedPredefinedServices[serviceIndex].pricePerPerson = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].minimumAttendees = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].maximumAttendees = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].baseRate = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].overtimeRatePerHour = null;
                        } else if (pricingModelVal === 'per_attendee') {
                            vendorSetupState.selectedPredefinedServices[serviceIndex].fixedPrice = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].baseRate = null;
                            vendorSetupState.selectedPredefinedServices[serviceIndex].overtimeRatePerHour = null;
                        }
                        
                        updateSelectedServicesSummary();
                    }
                };
                
                // no generic price input to listen to
                durationInput.addEventListener('input', updateServiceData);
                descriptionInput.addEventListener('input', updateServiceData);
                baseRateInput?.addEventListener('input', updateServiceData);
                overtimeRateInput?.addEventListener('input', updateServiceData);
                minFeeInput?.addEventListener('input', updateServiceData);
                fixedPriceInput?.addEventListener('input', updateServiceData);
                pppInput?.addEventListener('input', updateServiceData);
                minAttInput?.addEventListener('input', updateServiceData);
                maxAttInput?.addEventListener('input', updateServiceData);
                const setRequired = (el, req) => { if (el) el.required = !!req; };
                const togglePricingSections = (val) => {
                    // Show/hide containers
                    if (timeBasedSection) timeBasedSection.style.display = (val === 'time_based') ? '' : 'none';
                    if (fixedPriceSection) fixedPriceSection.style.display = (val === 'fixed_price') ? '' : 'none';
                    if (perAttendeeSection) perAttendeeSection.style.display = (val === 'per_attendee') ? '' : 'none';
                    // Toggle required attributes
                    setRequired(baseRateInput, val === 'time_based');
                    setRequired(overtimeRateInput, val === 'time_based');
                    setRequired(durationInput, val === 'time_based');
                    setRequired(fixedPriceInput, val === 'fixed_price');
                    setRequired(pppInput, val === 'per_attendee');
                    setRequired(minAttInput, val === 'per_attendee');
                    setRequired(maxAttInput, val === 'per_attendee');
                    // Clear values for now-hidden sections to avoid shared/lingering values
                    if (val === 'time_based') {
                        if (fixedPriceInput) fixedPriceInput.value = '';
                        if (pppInput) pppInput.value = '';
                        if (minAttInput) minAttInput.value = '';
                        if (maxAttInput) maxAttInput.value = '';
                    } else if (val === 'fixed_price') {
                        if (baseRateInput) baseRateInput.value = '';
                        if (overtimeRateInput) overtimeRateInput.value = '';
                        if (pppInput) pppInput.value = '';
                        if (minAttInput) minAttInput.value = '';
                        if (maxAttInput) maxAttInput.value = '';
                    } else if (val === 'per_attendee') {
                        if (baseRateInput) baseRateInput.value = '';
                        if (overtimeRateInput) overtimeRateInput.value = '';
                        if (fixedPriceInput) fixedPriceInput.value = '';
                    }
                };
                // initialize state
                togglePricingSections(pricingModelSelect?.value || 'time_based');
                pricingModelSelect?.addEventListener('change', (e) => {
                    const val = e.target.value;
                    togglePricingSections(val);
                    updateServiceData();
                });
            }
            
            function removeSelectedService(serviceId) {
                vendorSetupState.selectedPredefinedServices = vendorSetupState.selectedPredefinedServices.filter(s => s.id !== serviceId);
            }
            
            function updateSelectedServicesCount() {
                const count = vendorSetupState.selectedPredefinedServices?.length || 0;
                const countEl = document.getElementById('selected-services-count');
                if (countEl) {
                    countEl.textContent = `${count} service${count !== 1 ? 's' : ''} selected`;
                }
            }
            
            function updateSelectedServicesSummary() {
                const summaryContainer = document.getElementById('selected-services-summary');
                const summaryList = document.getElementById('selected-services-list');
                const selectedServices = vendorSetupState.selectedPredefinedServices || [];
                
                if (selectedServices.length === 0) {
                    summaryContainer.style.display = 'none';
                    return;
                }
                
                summaryContainer.style.display = 'block';
                
                const summaryHTML = selectedServices.map(service => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background-color: white; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${service.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">
                                ${service.pricingModel === 'fixed_price' || service.pricingModel === 'per_attendee'
                                    ? (service.pricingModel === 'per_attendee'
                                        ? `$${service.pricePerPerson || 0}/person`
                                        : `$${service.fixedPrice || service.vendorPrice || 0} fixed`)
                                    : `$${service.baseRate || service.vendorPrice || 0} for ${service.vendorDuration || service.baseDurationMinutes || service.defaultDuration || 60} min`}
                                ${service.vendorDescription ? ` • ${service.vendorDescription}` : ''}
                            </div>
                        </div>
                        <div style="color: var(--primary); font-size: 0.85rem; font-weight: 500;">
                            ${service.category}
                        </div>
                    </div>
                `).join('');
                
                summaryList.innerHTML = summaryHTML;
            }
            
            function showNoServicesMessage() {
                document.getElementById('predefined-services-loading').style.display = 'none';
                document.getElementById('predefined-services-container').style.display = 'none';
                document.getElementById('no-services-message').style.display = 'block';
            }

            // Cloudinary Upload Function
            async function uploadImageToCloudinary(file, imageType) {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('imageType', imageType);
                
                try {
                    console.log(`Uploading ${imageType} image to Cloudinary:`, file.name);
                    
                    const response = await fetch(`${API_BASE_URL}/upload/image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed');
                    }
                    
                    const result = await response.json();
                    console.log('Cloudinary upload successful:', result);
                    
                    // Return the secure URL from Cloudinary - handle backend response format
                    return result.data?.url || result.secure_url || result.url;
                    
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    throw new Error(`Failed to upload ${imageType} image: ${error.message}`);
                }
            }

            // Gallery & Media Functions
            async function handleFeaturedImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    try {
                        console.log('Uploading featured image to Cloudinary...');
                        const uploadedUrl = await uploadImageToCloudinary(file, 'featured');
                        vendorSetupState.stepData.step3 = {
                            ...vendorSetupState.stepData.step3,
                            featuredImage: uploadedUrl
                        };
                        console.log('Featured image uploaded:', uploadedUrl);
                        
                        // Auto-submit Step 3 to save the featured image to database
                        console.log('Auto-submitting Step 3 to save featured image...');
                        await submitCurrentStepToBackend();
                    } catch (error) {
                        console.error('Failed to upload featured image:', error);
                        alert('Failed to upload featured image. Please try again.');
                    }
                }
            }

            async function handleGalleryUpload(event) {
                const files = event.target.files;
                for (const file of files) {
                    try {
                        console.log('Uploading gallery image to Cloudinary:', file.name);
                        const uploadedUrl = await uploadImageToCloudinary(file, 'gallery');
                        vendorSetupState.gallery.push({
                            url: uploadedUrl,
                            type: 'upload',
                            caption: file.name
                        });
                        updateGalleryDisplay();
                        console.log('Gallery image uploaded:', uploadedUrl);
                        
                        // Auto-submit Step 3 to save gallery images to database
                        console.log('Auto-submitting Step 3 to save gallery images...');
                        await submitCurrentStepToBackend();
                    } catch (error) {
                        console.error('Failed to upload gallery image:', error);
                        alert(`Failed to upload ${file.name}. Please try again.`);
                    }
                }
            }

            function showPortfolioForm() {
                document.getElementById('portfolio-form').style.display = 'block';
            }

            async function addPortfolioItem() {
                const title = document.getElementById('portfolio-title')?.value;
                const description = document.getElementById('portfolio-description')?.value;
                const imageFile = document.getElementById('portfolio-image')?.files[0];
                
                if (title && description) {
                    const portfolioItem = { title, description };
                    
                    if (imageFile) {
                        try {
                            console.log('Uploading portfolio image to Cloudinary:', imageFile.name);
                            portfolioItem.imageUrl = await uploadImageToCloudinary(imageFile, 'portfolio');
                            console.log('Portfolio image uploaded:', portfolioItem.imageUrl);
                        } catch (error) {
                            console.error('Failed to upload portfolio image:', error);
                            alert('Failed to upload portfolio image. Please try again.');
                            return;
                        }
                    }
                    
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            portfolioItem.image = e.target.result;
                            vendorSetupState.portfolio.push(portfolioItem);
                            updatePortfolioDisplay();
                            clearPortfolioForm();
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        vendorSetupState.portfolio.push(portfolioItem);
                        updatePortfolioDisplay();
                        clearPortfolioForm();
                    }
                }
            }

            // Services & Packages Functions
            function showServiceCategoryForm() {
                document.getElementById('service-category-form').style.display = 'block';
            }

            function addServiceCategory() {
                const name = document.getElementById('category-name')?.value;
                const description = document.getElementById('category-description')?.value;
                
                if (name) {
                    if (!vendorSetupState.serviceCategories) {
                        vendorSetupState.serviceCategories = [];
                    }
                    vendorSetupState.serviceCategories.push({
                        name, 
                        description: description || ''
                    });
                    updateServiceCategoriesDisplay();
                    clearServiceCategoryForm();
                    document.getElementById('service-category-form').style.display = 'none';
                }
            }

            function showServiceForm() {
                document.getElementById('service-form').style.display = 'block';
                const addServiceBtn = document.getElementById('add-service-btn');
                if (addServiceBtn) {
                    addServiceBtn.style.display = 'block';
                    addServiceBtn.textContent = 'Add Another Service';
                }
            }

            function addServiceItem() {
                const name = document.getElementById('service-name')?.value?.trim();
                const description = document.getElementById('service-description')?.value?.trim();
                const price = document.getElementById('service-price')?.value;
                const duration = document.getElementById('service-duration')?.value;
                
                if (!name || !description || !price) {
                    alert('Please fill in all required fields: Service Name, Description, and Price.');
                    return;
                }
                
                if (parseFloat(price) <= 0) {
                    alert('Please enter a valid price greater than 0.');
                    return;
                }
                
                vendorSetupState.services.push({
                    name, 
                    description, 
                    price: parseFloat(price), 
                    duration: duration ? parseInt(duration) : null
                });
                
                updateServicesDisplay();
                clearServiceForm();
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.style.cssText = 'background-color: #d4edda; color: #155724; padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid #c3e6cb;';
                successMsg.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>Service "${name}" added successfully!`;
                
                const serviceForm = document.getElementById('service-form');
                serviceForm.parentNode.insertBefore(successMsg, serviceForm);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);
                
                console.log('Service added:', { name, description, price, duration });
                console.log('Current services:', vendorSetupState.services);
            }

            function showPackageForm() {
                document.getElementById('package-form').style.display = 'block';
            }

            function addPackageItem() {
                const name = document.getElementById('package-name')?.value;
                const description = document.getElementById('package-description')?.value;
                const price = document.getElementById('package-price')?.value;
                const includes = document.getElementById('package-includes')?.value;
                
                if (name && description && price) {
                    vendorSetupState.packages.push({
                        name, description, price: parseFloat(price), includes
                    });
                    updatePackagesDisplay();
                    clearPackageForm();
                }
            }

            // Team Functions
            function showTeamMemberForm() {
                document.getElementById('team-form').style.display = 'block';
            }

            function addTeamMember() {
                const name = document.getElementById('team-name')?.value;
                const role = document.getElementById('team-role')?.value;
                const bio = document.getElementById('team-bio')?.value;
                const photoFile = document.getElementById('team-photo')?.files[0];
                
                if (name && role) {
                    const teamMember = { name, role, bio };
                    
                    if (photoFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            teamMember.photo = e.target.result;
                            vendorSetupState.teamMembers.push(teamMember);
                            updateTeamDisplay();
                            clearTeamForm();
                        };
                        reader.readAsDataURL(photoFile);
                    } else {
                        vendorSetupState.teamMembers.push(teamMember);
                        updateTeamDisplay();
                        clearTeamForm();
                    }
                }
            }

            // FAQ Functions
            function showFaqForm() {
                document.getElementById('faq-form').style.display = 'block';
            }

            // Old addFaqItem function removed - using the new one that properly handles FAQ data

            // Display Update Functions
            function updateGalleryDisplay() {
                // Update gallery preview
                console.log('Gallery updated:', vendorSetupState.gallery);
            }

            function updatePortfolioDisplay() {
                const container = document.getElementById('portfolio-list');
                if (container) {
                    container.innerHTML = vendorSetupState.portfolio.map((item, index) => `
                        <div class="portfolio-item">
                            <strong>${item.title}</strong>
                            <p>${item.description}</p>
                            <button onclick="removePortfolioItem(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateServiceCategoriesDisplay() {
                const container = document.getElementById('service-categories-list');
                if (container && vendorSetupState.serviceCategories) {
                    container.innerHTML = vendorSetupState.serviceCategories.map((category, index) => `
                        <div class="service-category-item">
                            <strong>${category.name}</strong>
                            <p>${category.description}</p>
                            <button onclick="removeServiceCategory(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateServicesDisplay() {
                const container = document.getElementById('services-list');
                if (container) {
                    if (vendorSetupState.services.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No services added yet. Please add at least one service to continue.</p>';
                    } else {
                        container.innerHTML = vendorSetupState.services.map((service, index) => `
                            <div class="service-item" style="background-color: var(--secondary); padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <h6 style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--primary);">${service.name}</h6>
                                        <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-light);">${service.description}</p>
                                        <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
                                            <span style="font-weight: 600; color: var(--primary);">$${service.price}</span>
                                            ${service.duration ? `<span style="color: var(--text-light);">${service.duration} min</span>` : ''}
                                        </div>
                                    </div>
                                    <button onclick="removeService(${index})" style="background-color: var(--accent); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; margin-left: 1rem;">×</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }

            function updatePackagesDisplay() {
                const container = document.getElementById('packages-list');
                if (container) {
                    container.innerHTML = vendorSetupState.packages.map((pkg, index) => `
                        <div class="package-item">
                            <strong>${pkg.name}</strong> - $${pkg.price}
                            <p>${pkg.description}</p>
                            <button onclick="removePackage(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateTeamDisplay() {
                const container = document.getElementById('team-list');
                if (container) {
                    container.innerHTML = vendorSetupState.teamMembers.map((member, index) => `
                        <div class="team-item">
                            <strong>${member.name}</strong> - ${member.role}
                            <p>${member.bio}</p>
                            <button onclick="removeTeamMember(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            function updateFaqDisplay() {
                const container = document.getElementById('faqs-list');
                if (container) {
                    container.innerHTML = vendorSetupState.faqs.map((faq, index) => `
                        <div class="faq-item">
                            <strong>Q: ${faq.question}</strong>
                            <p>A: ${faq.answer}</p>
                            <button onclick="removeFaq(${index})">Remove</button>
                        </div>
                    `).join('');
                }
            }

            // Clear Form Functions
            function clearPortfolioForm() {
                document.getElementById('portfolio-title').value = '';
                document.getElementById('portfolio-description').value = '';
                document.getElementById('portfolio-image').value = '';
                document.getElementById('portfolio-form').style.display = 'none';
            }

            function clearServiceCategoryForm() {
                document.getElementById('category-name').value = '';
                document.getElementById('category-description').value = '';
            }

            function clearServiceForm() {
                document.getElementById('service-name').value = '';
                document.getElementById('service-description').value = '';
                document.getElementById('service-price').value = '';
                document.getElementById('service-duration').value = '';
                // Don't hide the form automatically - let user decide
            }

            function clearPackageForm() {
                document.getElementById('package-name').value = '';
                document.getElementById('package-description').value = '';
                document.getElementById('package-price').value = '';
                document.getElementById('package-includes').value = '';
                document.getElementById('package-form').style.display = 'none';
            }

            function clearTeamForm() {
                document.getElementById('team-name').value = '';
                document.getElementById('team-role').value = '';
                document.getElementById('team-bio').value = '';
                document.getElementById('team-photo').value = '';
                document.getElementById('team-form').style.display = 'none';
            }

            function clearFaqForm() {
                document.getElementById('faq-question').value = '';
                document.getElementById('faq-answer').value = '';
                document.getElementById('faq-form').style.display = 'none';
            }

            // FAQ Management Functions
            function addFaqItem() {
                const question = document.getElementById('faq-question').value.trim();
                const answer = document.getElementById('faq-answer').value.trim();
                
                if (!question || !answer) {
                    alert('Please provide both question and answer.');
                    return;
                }
                
                // Initialize FAQ array if it doesn't exist
                if (!vendorSetupState.faqs) {
                    vendorSetupState.faqs = [];
                }
                
                // Add FAQ to state
                vendorSetupState.faqs.push({
                    question: question,
                    answer: answer
                });
                
                // Update display
                updateFaqsDisplay();
                
                // Clear form
                clearFaqForm();
            }

            function updateFaqsDisplay() {
                const faqsList = document.getElementById('faqs-list');
                if (!faqsList) return;
                
                faqsList.innerHTML = '';
                
                if (vendorSetupState.faqs && vendorSetupState.faqs.length > 0) {
                    vendorSetupState.faqs.forEach((faq, index) => {
                        const faqItem = document.createElement('div');
                        faqItem.className = 'faq-item-display';
                        faqItem.style.cssText = 'background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;';
                        faqItem.innerHTML = `
                            <div class="faq-question-text" style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">
                                Q: ${faq.question}
                            </div>
                            <div class="faq-answer-text" style="margin-bottom: 1rem; color: var(--text);">
                                A: ${faq.answer}
                            </div>
                            <button type="button" class="btn btn-outline" onclick="removeFaq(${index})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                Remove
                            </button>
                        `;
                        faqsList.appendChild(faqItem);
                    });
                }
            }

            function removeFaq(index) {
                if (vendorSetupState.faqs && vendorSetupState.faqs[index]) {
                    vendorSetupState.faqs.splice(index, 1);
                    updateFaqsDisplay();
                }
            }

            // Step 8 API Submission Function
            async function submitStep8FAQ() {
                try {
                    // Save current step data
                    saveCurrentStepData();
                    
                    const step8Data = vendorSetupState.stepData.step8;
                    
                    if (!vendorSetupState.vendorProfileId) {
                        throw new Error('Vendor profile ID not found');
                    }
                    
                    // Submit FAQ data to backend
                    const response = await fetch(`${API_BASE_URL}/vendors/setup/step8-faq`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            faqs: step8Data.faqs || []
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save FAQ data');
                    }
                    
                    const result = await response.json();
                    console.log('Step 8 FAQ data saved successfully:', result);
                    
                    // Move to next step
                    vendorSetupState.currentStep = 9;
                    showSetupStep(9);
                    
                } catch (error) {
                    console.error('Error submitting Step 8 FAQ data:', error);
                    alert('Failed to save FAQ data: ' + error.message);
                }
            }

            // Remove Functions
            function removeServiceCategory(index) {
                if (vendorSetupState.serviceCategories) {
                    vendorSetupState.serviceCategories.splice(index, 1);
                    updateServiceCategoriesDisplay();
                }
            }

            // Services Functions
            function addServiceItem() {
                const serviceName = document.getElementById('service-name')?.value?.trim();
                const serviceDescription = document.getElementById('service-description')?.value?.trim();
                const servicePrice = document.getElementById('service-price')?.value;
                const serviceDuration = document.getElementById('service-duration')?.value || '60';

                if (!serviceName || !serviceDescription || !servicePrice) {
                    alert('Please fill in all required service fields.');
                    return;
                }

                const service = {
                    id: Date.now(),
                    name: serviceName,
                    description: serviceDescription,
                    price: parseFloat(servicePrice),
                    duration: parseInt(serviceDuration)
                };

                // Add to vendor setup state (with safety check)
                if (typeof vendorSetupState !== 'undefined') {
                    if (!vendorSetupState.services) {
                        vendorSetupState.services = [];
                    }
                    vendorSetupState.services.push(service);
                } else {
                    // Fallback: create temporary storage if vendorSetupState doesn't exist
                    if (!window.tempServices) {
                        window.tempServices = [];
                    }
                    window.tempServices.push(service);
                }

                // Update display
                updateServicesDisplay();

                // Clear form
                clearServiceForm();

                console.log('✓ Service added:', service);
            }

            function updateServicesDisplay() {
                const servicesList = document.getElementById('services-list');
                if (!servicesList) return;

                // Get services from either vendorSetupState or temporary storage
                let services = [];
                if (typeof vendorSetupState !== 'undefined' && vendorSetupState.services) {
                    services = vendorSetupState.services;
                } else if (window.tempServices) {
                    services = window.tempServices;
                }

                if (services.length === 0) {
                    servicesList.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No services added yet.</p>';
                    return;
                }

                const servicesHtml = services.map((service, index) => `
                    <div class="service-item" style="
                        background-color: white;
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 1rem;
                        margin-bottom: 0.5rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                    ">
                        <div style="flex: 1;">
                            <h6 style="margin: 0 0 0.5rem 0; color: var(--primary); font-weight: 600;">${service.name}</h6>
                            <p style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">${service.description}</p>
                            <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-light);">
                                <span><strong>Price:</strong> $${service.price.toFixed(2)}</span>
                                <span><strong>Duration:</strong> ${service.duration} min</span>
                            </div>
                        </div>
                        <button onclick="removeService(${index})" style="
                            background: var(--accent);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-left: 0.5rem;
                        " title="Remove service">×</button>
                    </div>
                `).join('');

                servicesList.innerHTML = servicesHtml;
            }

            function removeService(index) {
                // Remove from either vendorSetupState or temporary storage
                if (typeof vendorSetupState !== 'undefined' && vendorSetupState.services && index >= 0 && index < vendorSetupState.services.length) {
                    vendorSetupState.services.splice(index, 1);
                    updateServicesDisplay();
                    console.log('✓ Service removed at index:', index);
                } else if (window.tempServices && index >= 0 && index < window.tempServices.length) {
                    window.tempServices.splice(index, 1);
                    updateServicesDisplay();
                    console.log('✓ Service removed at index:', index);
                }
            }

            function clearServiceForm() {
                document.getElementById('service-name').value = '';
                document.getElementById('service-description').value = '';
                document.getElementById('service-price').value = '';
                document.getElementById('service-duration').value = '';
            }

            // FAQ Functions (ensure they exist)
            function showFaqForm() {
                const faqForm = document.getElementById('faq-form');
                if (faqForm) {
                    faqForm.style.display = 'block';
                }
            }

            function addFaqItem() {
                const faqQuestion = document.getElementById('faq-question')?.value?.trim();
                const faqAnswer = document.getElementById('faq-answer')?.value?.trim();

                if (!faqQuestion || !faqAnswer) {
                    alert('Please fill in both question and answer fields.');
                    return;
                }

                const faq = {
                    id: Date.now(),
                    question: faqQuestion,
                    answer: faqAnswer
                };

                // Add to vendor setup state
                if (!vendorSetupState.faqs) {
                    vendorSetupState.faqs = [];
                }
                vendorSetupState.faqs.push(faq);

                // Update display
                updateFaqsDisplay();

                // Clear form and hide it
                document.getElementById('faq-question').value = '';
                document.getElementById('faq-answer').value = '';
                document.getElementById('faq-form').style.display = 'none';

                console.log('✓ FAQ added:', faq);
            }

            function updateFaqsDisplay() {
                const faqsList = document.getElementById('faqs-list');
                if (!faqsList || !vendorSetupState.faqs) return;

                if (vendorSetupState.faqs.length === 0) {
                    faqsList.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No FAQs added yet.</p>';
                    return;
                }

                const faqsHtml = vendorSetupState.faqs.map((faq, index) => `
                    <div class="faq-item" style="
                        background-color: white;
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 1rem;
                        margin-bottom: 0.5rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                    ">
                        <div style="flex: 1;">
                            <h6 style="margin: 0 0 0.5rem 0; color: var(--primary); font-weight: 600;">${faq.question}</h6>
                            <p style="margin: 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">${faq.answer}</p>
                        </div>
                        <button onclick="removeFaq(${index})" style="
                            background: var(--accent);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-left: 0.5rem;
                        " title="Remove FAQ">×</button>
                    </div>
                `).join('');

                faqsList.innerHTML = faqsHtml;
            }

            function removeFaq(index) {
                if (vendorSetupState.faqs && index >= 0 && index < vendorSetupState.faqs.length) {
                    vendorSetupState.faqs.splice(index, 1);
                    updateFaqsDisplay();
                    console.log('✓ FAQ removed at index:', index);
                }
            }

            // Complete Vendor Setup
            async function completeVendorSetup() {
                try {
                    // Save current step data (Step 10)
                    saveCurrentStepData();

                    // Show loading
                    const completeBtn = document.getElementById('complete-setup-btn');
                    completeBtn.textContent = 'Completing Setup...';
                    completeBtn.disabled = true;

                    // Get vendor profile ID
                    if (!vendorSetupState.vendorProfileId) {
                        const vendorProfileResponse = await fetch(`${API_BASE_URL}/vendors/profile?userId=${vendorSetupState.vendorId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (!vendorProfileResponse.ok) {
                            throw new Error('Failed to fetch vendor profile ID');
                        }

                        const vendorProfileData = await vendorProfileResponse.json();
                        vendorSetupState.vendorProfileId = vendorProfileData.vendorProfileId;
                    }

                    // Submit completion data to backend
                    const response = await fetch(`${API_BASE_URL}/vendors/setup/step9-completion`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            faqs: vendorSetupState.faqs || [],
                            testimonials: vendorSetupState.testimonials || []
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Setup completion failed');
                    }

                    const result = await response.json();
                    
                    alert('🎉 Congratulations! Your vendor profile setup is complete and now live!');
                    vendorRegistrationModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    
                    // Update current user to vendor mode
                    currentUser.isVendor = true;
                    
                    // Redirect to vendor dashboard
                    displayUserDashboard('vendor', 'vendor-dashboard');
                    
                } catch (error) {
                    console.error('Setup completion error:', error);
                    alert('Setup failed: ' + error.message);
                } finally {
                    const completeBtn = document.getElementById('complete-setup-btn');
                    if (completeBtn) {
                        completeBtn.textContent = '🚀 Complete Setup & Go Live!';
                        completeBtn.disabled = false;
                    }
                }
            }

            // Remove FAQ function
            function removeFaq(index) {
                vendorSetupState.faqs.splice(index, 1);
                updateFaqDisplay();
            }

            function renderGalleryPreview() {
                const container = document.getElementById('gallery-preview');
                container.innerHTML = vendorSetupState.gallery.map((item, index) => `
                    <div class="gallery-item">
                        <img src="${item.url}" alt="${item.caption}">
                        <button class="remove-btn" onclick="removeGalleryItem(${index})">×</button>
                    </div>
                `).join('');
            }

            function removeGalleryItem(index) {
                vendorSetupState.gallery.splice(index, 1);
                renderGalleryPreview();
            }

            function addPackage() {
                const form = document.getElementById('package-form');
                const packageData = {
                    name: form.querySelector('[name="package_name"]').value,
                    description: form.querySelector('[name="description"]').value,
                    price: parseFloat(form.querySelector('[name="price"]').value),
                    duration: form.querySelector('[name="duration"]').value,
                    maxGuests: parseInt(form.querySelector('[name="max_guests"]').value),
                    includes: form.querySelector('[name="includes"]').value
                };
                
                if (!packageData.name || !packageData.price) {
                    alert('Please fill in package name and price');
                    return;
                }
                
                vendorSetupState.packages.push(packageData);
                renderPackagesList();
                form.reset();
                form.style.display = 'none';
            }

            function addService() {
                const form = document.getElementById('service-form');
                const serviceData = {
                    name: form.querySelector('[name="service_name"]').value,
                    description: form.querySelector('[name="service_description"]').value,
                    price: parseFloat(form.querySelector('[name="service_price"]').value),
                    duration: form.querySelector('[name="service_duration"]').value
                };
                
                if (!serviceData.name || !serviceData.price) {
                    alert('Please fill in service name and price');
                    return;
                }
                
                vendorSetupState.services.push(serviceData);
                renderServicesList();
                form.reset();
                form.style.display = 'none';
            }

            function renderPackagesList() {
                const container = document.getElementById('packages-list');
                container.innerHTML = vendorSetupState.packages.map((pkg, index) => `
                    <div class="package-item">
                        <h6>${pkg.name}</h6>
                        <p>${pkg.description}</p>
                        <div class="price">$${pkg.price} - ${pkg.duration}</div>
                        <button onclick="removePackage(${index})" style="margin-top: 0.5rem; background: var(--accent); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            }

            function renderServicesList() {
                const container = document.getElementById('services-list');
                container.innerHTML = vendorSetupState.services.map((service, index) => `
                    <div class="service-item">
                        <h6>${service.name}</h6>
                        <p>${service.description}</p>
                        <div class="price">$${service.price} - ${service.duration}</div>
                        <button onclick="removeService(${index})" style="margin-top: 0.5rem; background: var(--accent); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            }

            function removePackage(index) {
                vendorSetupState.packages.splice(index, 1);
                renderPackagesList();
            }

            function removeService(index) {
                vendorSetupState.services.splice(index, 1);
                updateServicesDisplay();
                
                // If no services left, show the service form again
                if (vendorSetupState.services.length === 0) {
                    document.getElementById('service-form').style.display = 'block';
                    const addServiceBtn = document.getElementById('add-service-btn');
                    if (addServiceBtn) {
                        addServiceBtn.style.display = 'none';
                        addServiceBtn.textContent = 'Add Service';
                    }
                }
            }

            function saveCurrentStepData() {
                console.log('saveCurrentStepData called for step:', vendorSetupState.currentStep);
                switch (vendorSetupState.currentStep) {
                    case 3: // Social Media
                        const platforms = ['facebook', 'instagram', 'twitter', 'linkedin', 'youtube', 'tiktok'];
                        platforms.forEach(platform => {
                            const input = document.getElementById(`social-${platform}`);
                            if (input && input.value.trim()) {
                                vendorSetupState.socialMedia[platform] = input.value.trim();
                            }
                        });
                        break;
                    case 4: // Additional Details - Category Questions
                        // Collect category question responses
                        if (!vendorSetupState.categoryQuestions) {
                            vendorSetupState.categoryQuestions = [];
                        }
                        
                        // Find all question inputs in the category-questions-container
                        const container = document.getElementById('category-questions-container');
                        if (container) {
                            const questionInputs = container.querySelectorAll('input[name^="question_"], textarea[name^="question_"]');
                            questionInputs.forEach(input => {
                                const questionId = input.name.replace('question_', '');
                                let value = null;
                                
                                if (input.type === 'radio' && input.checked) {
                                    value = input.value;
                                } else if (input.type === 'number' || input.tagName === 'TEXTAREA') {
                                    value = input.value.trim();
                                }
                                
                                if (value) {
                                    // Update existing answer or add new one
                                    const existingIndex = vendorSetupState.categoryQuestions.findIndex(q => q.questionId === questionId);
                                    if (existingIndex >= 0) {
                                        vendorSetupState.categoryQuestions[existingIndex].answer = value;
                                    } else {
                                        vendorSetupState.categoryQuestions.push({
                                            questionId: questionId,
                                            answer: value
                                        });
                                    }
                                }
                            });
                        }
                        console.log('Step 4 - Category questions collected:', vendorSetupState.categoryQuestions);
                        break;
                    case 5: // Time & Availability
                        const businessHours = {};
                        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        dayNames.forEach((day, index) => {
                            const checkbox = document.getElementById(`available-${index}`);
                            const startTime = document.getElementById(`start-time-${index}`);
                            const endTime = document.getElementById(`end-time-${index}`);
                            businessHours[day] = {
                                enabled: checkbox?.checked || false,
                                start: startTime?.value || '',
                                end: endTime?.value || ''
                            };
                        });
                        
                        // Get available dates
                        const availableDates = document.getElementById('availability-dates')?.value || '';
                        
                        // Validate that at least one date is provided
                        if (!availableDates.trim()) {
                            alert('Please provide at least one available date to continue.');
                            return false;
                        }
                        
                        vendorSetupState.stepData.step5 = {
                            businessHours,
                            minimumBookingLeadTime: document.getElementById('lead-time')?.value || '',
                            maximumBookingAdvance: document.getElementById('maximum-booking-advance')?.value || '',
                            cancellationPolicy: document.getElementById('cancellation-policy')?.value || '',
                            availableDates: availableDates
                        };
                        
                        console.log('Step 5 data saved:', vendorSetupState.stepData.step5);
                        break;
                    case 10: // Setup Completion - Collect FAQ data
                        // Collect FAQ data from the UI
                        if (!vendorSetupState.faqs) {
                            vendorSetupState.faqs = [];
                        }
                        // FAQs are already collected via addFAQ function, so just ensure they exist
                        console.log('Step 10 - FAQ data collected:', vendorSetupState.faqs);
                        break;
                }
            }

            // Remove functions for various items
            function removePortfolioItem(index) {
                vendorSetupState.portfolio.splice(index, 1);
                updatePortfolioDisplay();
            }

            function removeTeamMember(index) {
                vendorSetupState.teamMembers.splice(index, 1);
                updateTeamDisplay();
            }

            // Submit current step data to backend
            async function submitCurrentStepToBackend() {
                const currentStep = vendorSetupState.currentStep;
                const token = localStorage.getItem('token');
                
                if (!token) {
                    throw new Error('No authentication token found');
                }

                // Get vendor profile ID if not already set
                if (!vendorSetupState.vendorProfileId) {
                    const vendorProfileResponse = await fetch(`${API_BASE_URL}/vendors/profile?userId=${vendorSetupState.vendorId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!vendorProfileResponse.ok) {
                        throw new Error('Failed to fetch vendor profile ID');
                    }

                    const vendorProfileData = await vendorProfileResponse.json();
                    vendorSetupState.vendorProfileId = vendorProfileData.vendorProfileId;
                }

                // Function to get city coordinates using Google Places API
                async function getCityCoordinates(cityName, state, country) {
                    return new Promise((resolve) => {
                        if (!window.google || !window.google.maps || !window.google.maps.places) {
                            console.warn('Google Places API not available, using fallback coordinates');
                            resolve({
                                lat: 0,
                                lng: 0,
                                placeId: '',
                                formattedAddress: `${cityName}, ${state || ''}, ${country || ''}`,
                                placeType: 'locality',
                                postalCode: null,
                                bounds: null
                            });
                            return;
                        }

                        const service = new google.maps.places.PlacesService(document.createElement('div'));
                        const request = {
                            query: `${cityName}, ${state || ''}, ${country || ''}`,
                            fields: ['place_id', 'geometry', 'formatted_address', 'types', 'address_components']
                        };

                        service.textSearch(request, (results, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                                const place = results[0];
                                const location = place.geometry.location;
                                
                                // Extract postal code from address components
                                let postalCode = null;
                                if (place.address_components) {
                                    const postalComponent = place.address_components.find(comp => 
                                        comp.types.includes('postal_code')
                                    );
                                    postalCode = postalComponent ? postalComponent.long_name : null;
                                }

                                resolve({
                                    lat: location.lat(),
                                    lng: location.lng(),
                                    placeId: place.place_id,
                                    formattedAddress: place.formatted_address,
                                    placeType: place.types[0] || 'locality',
                                    postalCode: postalCode,
                                    bounds: place.geometry.viewport ? {
                                        northeast: {
                                            lat: place.geometry.viewport.getNorthEast().lat(),
                                            lng: place.geometry.viewport.getNorthEast().lng()
                                        },
                                        southwest: {
                                            lat: place.geometry.viewport.getSouthWest().lat(),
                                            lng: place.geometry.viewport.getSouthWest().lng()
                                        }
                                    } : null
                                });
                            } else {
                                console.warn(`Could not find coordinates for ${cityName}, using fallback`);
                                resolve({
                                    lat: 0,
                                    lng: 0,
                                    placeId: '',
                                    formattedAddress: `${cityName}, ${state || ''}, ${country || ''}`,
                                    placeType: 'locality',
                                    postalCode: null,
                                    bounds: null
                                });
                            }
                        });
                    });
                }

                // Prepare step data based on current step
                let stepData = {};
                let endpoint = '';

                switch (currentStep) {
                    case 1: // Business Basics
                        const primaryCategory = document.getElementById('primary-category')?.value || '';
                        const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || []).map(option => option.value);
                        const allCategories = primaryCategory ? [primaryCategory, ...additionalCategories.filter(cat => cat !== primaryCategory)] : additionalCategories;
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            businessName: document.getElementById('business-name')?.value || '',
                            businessEmail: document.getElementById('business-email')?.value || '',
                            businessPhone: document.getElementById('business-phone')?.value || '',
                            businessDescription: document.getElementById('business-description')?.value || '',
                            primaryCategory: primaryCategory,
                            displayName: document.getElementById('display-name')?.value || '',
                            website: document.getElementById('website-url')?.value || '',
                            tagline: document.getElementById('tagline')?.value || '',
                            yearsInBusiness: parseInt(document.getElementById('years-in-business')?.value) || 0,
                            categories: allCategories
                        };
                        endpoint = '/vendors/setup/step1-business-basics';
                        break;

                    case 2: // Location Information
                        // Collect service areas from vendorSetupState.selectedCities or any available city containers
                        const serviceAreas = [];
                        
                        // Method 1: Use vendorSetupState.selectedCities if available
                        if (typeof vendorSetupState !== 'undefined' && vendorSetupState.selectedCities && vendorSetupState.selectedCities.length > 0) {
                            for (const cityName of vendorSetupState.selectedCities) {
                                try {
                                    // Try to get coordinates using Google Places API
                                    const coordinates = await getCityCoordinates(cityName, document.getElementById('business-state')?.value, document.getElementById('business-country')?.value);
                                    console.log(`🌍 Coordinates for ${cityName}:`, coordinates);
                                    
                                    // Ensure we always have valid coordinates (never null/undefined)
                                    const lat = (coordinates && typeof coordinates.lat === 'number') ? coordinates.lat : 0;
                                    const lng = (coordinates && typeof coordinates.lng === 'number') ? coordinates.lng : 0;
                                    
                                    serviceAreas.push({
                                        placeId: (coordinates && coordinates.placeId) || '',
                                        city: cityName,
                                        state: document.getElementById('business-state')?.value || '',
                                        country: document.getElementById('business-country')?.value || 'Canada',
                                        latitude: lat,
                                        longitude: lng,
                                        formattedAddress: (coordinates && coordinates.formattedAddress) || `${cityName}, ${document.getElementById('business-state')?.value || ''}`,
                                        placeType: (coordinates && coordinates.placeType) || 'locality',
                                        postalCode: (coordinates && coordinates.postalCode) || null,
                                        serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                        travelCost: null,
                                        minimumBookingAmount: null,
                                        bounds: (coordinates && coordinates.bounds) || null
                                    });
                                } catch (error) {
                                    console.error(`❌ Error getting coordinates for ${cityName}:`, error);
                                    // Fallback with guaranteed valid coordinates
                                    serviceAreas.push({
                                        placeId: '',
                                        city: cityName,
                                        state: document.getElementById('business-state')?.value || '',
                                        country: document.getElementById('business-country')?.value || 'Canada',
                                        latitude: 0,
                                        longitude: 0,
                                        formattedAddress: `${cityName}, ${document.getElementById('business-state')?.value || ''}`,
                                        placeType: 'locality',
                                        postalCode: null,
                                        serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                        travelCost: null,
                                        minimumBookingAmount: null,
                                        bounds: null
                                    });
                                }
                            }
                        }
                        
                        // Method 2: Try to find city tags in any container
                        if (serviceAreas.length === 0) {
                            const cityTags = document.querySelectorAll('.city-tag, .city-item, [data-city]');
                            cityTags.forEach(item => {
                                const cityName = item.textContent.replace('×', '').trim() || item.dataset.city;
                                if (cityName) {
                                    // Ensure coordinates are never null
                                    const lat = parseFloat(item.dataset.latitude) || 0;
                                    const lng = parseFloat(item.dataset.longitude) || 0;
                                    
                                    serviceAreas.push({
                                        placeId: item.dataset.placeId || '',
                                        city: cityName,
                                        state: document.getElementById('business-state')?.value || '',
                                        country: document.getElementById('business-country')?.value || 'Canada',
                                        latitude: lat,
                                        longitude: lng,
                                        formattedAddress: item.dataset.formattedAddress || `${cityName}, ${document.getElementById('business-state')?.value || ''}`,
                                        placeType: item.dataset.placeType || 'locality',
                                        postalCode: item.dataset.postalCode || null,
                                        serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                        travelCost: parseFloat(item.dataset.travelCost) || null,
                                        minimumBookingAmount: parseFloat(item.dataset.minimumBooking) || null,
                                        bounds: item.dataset.bounds ? JSON.parse(item.dataset.bounds) : null
                                    });
                                }
                            });
                        }
                        
                        // Method 3: Fallback - create a default service area based on main business location
                        if (serviceAreas.length === 0) {
                            const businessCity = document.getElementById('business-city')?.value;
                            if (businessCity) {
                                const businessLat = parseFloat(document.getElementById('business-latitude')?.value) || 0;
                                const businessLng = parseFloat(document.getElementById('business-longitude')?.value) || 0;
                                
                                serviceAreas.push({
                                    placeId: '',
                                    city: businessCity,
                                    state: document.getElementById('business-state')?.value || '',
                                    country: document.getElementById('business-country')?.value || 'Canada',
                                    latitude: businessLat,
                                    longitude: businessLng,
                                    formattedAddress: document.getElementById('business-address')?.value || `${businessCity}, ${document.getElementById('business-state')?.value || ''}`,
                                    placeType: 'locality',
                                    postalCode: document.getElementById('business-postal')?.value || null,
                                    serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                                    travelCost: null,
                                    minimumBookingAmount: null,
                                    bounds: null
                                });
                            }
                        }
                        
                        console.log('🔍 Service areas collected:', serviceAreas);
                        
                        // Validate that no service area has null coordinates
                        serviceAreas.forEach((area, index) => {
                            if (area.latitude === null || area.longitude === null || area.latitude === undefined || area.longitude === undefined) {
                                console.error(`❌ Service area ${index} has null coordinates:`, area);
                                // Force to 0 if somehow null got through
                                area.latitude = area.latitude || 0;
                                area.longitude = area.longitude || 0;
                            }
                            console.log(`✓ Service area ${index}: ${area.city} (${area.latitude}, ${area.longitude})`);
                        });
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            address: document.getElementById('business-address')?.value || '',
                            city: document.getElementById('business-city')?.value || '',
                            state: document.getElementById('business-state')?.value || '',
                            postalCode: document.getElementById('business-postal')?.value || '',
                            country: document.getElementById('business-country')?.value || 'USA',
                            latitude: parseFloat(document.getElementById('business-latitude')?.value) || null,
                            longitude: parseFloat(document.getElementById('business-longitude')?.value) || null,
                            serviceRadius: parseInt(document.getElementById('service-radius')?.value) || 25,
                            serviceAreas: serviceAreas
                        };
                        endpoint = '/vendors/setup/step2-location';
                        break;

                    case 3: // Services & Packages
                        // Build services array from selectedPredefinedServices with unified pricing fields
                        const selected = vendorSetupState.selectedPredefinedServices || [];
                        const servicesMapped = selected.map(s => {
                            const toNum = v => (v === '' || v === undefined || v === null) ? null : Number(v);
                            const toInt = v => (v === '' || v === undefined || v === null) ? null : parseInt(v);
                            const inferredModel = s.pricingModel || (
                                toNum(s.fixedPrice) > 0 ? 'fixed_price' :
                                toNum(s.pricePerPerson) > 0 ? 'per_attendee' :
                                toNum(s.baseRate) > 0 ? 'time_based' : null
                            );
                            const baseDuration = toInt(s.baseDurationMinutes) ?? toInt(s.durationMinutes);
                            const fixedPrice = toNum(s.fixedPrice) ?? toNum(s.price); // map legacy price => fixedPrice when applicable
                            return {
                                name: s.name,
                                description: s.description || s.vendorDescription || null,
                                categoryName: s.categoryName || s.category || null,
                                linkedPredefinedServiceId: s.predefinedServiceId || s.id || null,
                                pricingModel: inferredModel,
                                baseRate: toNum(s.baseRate),
                                baseDurationMinutes: baseDuration,
                                overtimeRatePerHour: toNum(s.overtimeRatePerHour),
                                minimumBookingFee: toNum(s.minimumBookingFee),
                                fixedPrice: inferredModel === 'fixed_price' ? fixedPrice : null,
                                pricePerPerson: inferredModel === 'per_attendee' ? toNum(s.pricePerPerson) : null,
                                minimumAttendees: toInt(s.minimumAttendees),
                                maximumAttendees: toInt(s.maximumAttendees),
                                maxAttendees: toInt(s.maxAttendees),
                                depositPercentage: toNum(s.depositPercentage) ?? 20,
                                cancellationPolicy: s.cancellationPolicy || null
                            };
                        });

                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            serviceCategories: vendorSetupState.serviceCategories || [],
                            services: servicesMapped,
                            packages: vendorSetupState.packages || [],
                            selectedPredefinedServices: selected
                        };
                        // Post to step3-services (backend 307-forwards to step4-services logic)
                        endpoint = '/vendors/setup/step3-services';
                        break;

                    case 4: // Additional Details - Category Questions
                        // Convert categoryQuestions to the format expected by backend
                        const categoryAnswers = (vendorSetupState.categoryQuestions || []).map(q => ({
                            questionId: parseInt(q.questionId), // Convert to integer
                            answer: q.answer
                        }));
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            categoryAnswers: categoryAnswers,
                            primaryCategory: document.getElementById('primary-category')?.value || ''
                        };
                        endpoint = '/vendors/setup/step4-additional-details';
                        break;

                    case 5: // Time & Availability
                        // Collect business hours data directly from DOM if step5 data doesn't exist
                        let businessHoursData = vendorSetupState.stepData.step5?.businessHours;
                        
                        if (!businessHoursData) {
                            // Collect directly from DOM
                            businessHoursData = {};
                            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            dayNames.forEach((day, index) => {
                                const checkbox = document.getElementById(`available-${index}`);
                                const startTime = document.getElementById(`start-time-${index}`);
                                const endTime = document.getElementById(`end-time-${index}`);
                                if (checkbox?.checked) {
                                    businessHoursData[index] = {
                                        isOpen: true,
                                        openTime: startTime?.value || '',
                                        closeTime: endTime?.value || ''
                                    };
                                }
                            });
                        } else {
                            // Convert from saved format to backend format
                            const convertedHours = {};
                            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            dayNames.forEach((day, index) => {
                                if (businessHoursData[day] && businessHoursData[day].enabled) {
                                    convertedHours[index] = {
                                        isOpen: true,
                                        openTime: businessHoursData[day].start,
                                        closeTime: businessHoursData[day].end
                                    };
                                }
                            });
                            businessHoursData = convertedHours;
                        }
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            businessHours: businessHoursData,
                            bookingSettings: {
                                minimumBookingLeadTime: document.getElementById('lead-time')?.value || '',
                                maximumBookingAdvance: document.getElementById('maximum-booking-advance')?.value || '',
                                cancellationPolicy: document.getElementById('cancellation-policy')?.value || ''
                            }
                        };
                        endpoint = '/vendors/setup/step5-availability';
                        break;

                    case 6: // Gallery & Media
                        // Use the Cloudinary URLs that were uploaded via handleFeaturedImageUpload
                        const featuredImage = vendorSetupState.stepData.step3?.featuredImage || 
                                            document.getElementById('featured-image-url')?.value || 
                                            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            featuredImage: featuredImage,
                            galleryImages: vendorSetupState.gallery || [],
                            portfolioItems: vendorSetupState.portfolio || []
                        };
                        endpoint = '/vendors/setup/step6-gallery';
                        break;

                    case 7: // Social Media
                        const socialMediaProfiles = [];
                        
                        // Collect ALL social media profiles including YouTube and TikTok
                        const socialPlatforms = [
                            { platform: 'facebook', id: 'social-facebook', prefix: 'https://facebook.com/' },
                            { platform: 'instagram', id: 'social-instagram', prefix: 'https://instagram.com/' },
                            { platform: 'twitter', id: 'social-twitter', prefix: 'https://twitter.com/' },
                            { platform: 'linkedin', id: 'social-linkedin', prefix: 'https://linkedin.com/in/' },
                            { platform: 'youtube', id: 'social-youtube', prefix: 'https://youtube.com/' },
                            { platform: 'tiktok', id: 'social-tiktok', prefix: 'https://tiktok.com/@' }
                        ];
                        
                        socialPlatforms.forEach(item => {
                            const input = document.getElementById(item.id);
                            const userInput = input?.value?.trim() || '';
                            if (userInput) {
                                // Create full URL by combining prefix + user input
                                const fullUrl = item.prefix + userInput;
                                socialMediaProfiles.push({
                                    platform: item.platform,
                                    url: fullUrl
                                });
                            }
                        });
                        
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            socialMediaProfiles,
                            bookingLink: document.getElementById('booking-link')?.value || ''
                        };
                        endpoint = '/vendors/setup/step7-social';
                        break;

                    case 8: // FAQ
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            faqs: vendorSetupState.faqs || []
                        };
                        endpoint = '/vendors/setup/step8-faq';
                        break;

                    case 9: // Verification & Legal
                        stepData = {
                            vendorProfileId: vendorSetupState.vendorProfileId,
                            licenseNumber: document.getElementById('license-number')?.value || '',
                            insuranceVerified: document.getElementById('insurance-verified')?.checked || false,
                            awardsCertifications: document.getElementById('awards-certifications')?.value || '',
                            businessType: document.getElementById('business-type')?.value || '',
                            taxId: document.getElementById('tax-id')?.value || '',
                            isEcoFriendly: document.getElementById('eco-friendly')?.checked || false,
                            isPremium: document.getElementById('premium-status')?.checked || false
                        };
                        endpoint = '/vendors/setup/step9-verification';
                        break;

                    default:
                        // No submission needed for steps that don't have backend endpoints
                        return;
                }

                // Submit to backend
                console.log(`Submitting step ${currentStep} data:`, stepData);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(stepData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Step ${currentStep} submission failed`);
                }

                const result = await response.json();
                console.log(`Step ${currentStep} submitted successfully:`, result);
                return result;
            }

            // Make functions global for onclick handlers
            window.addPackage = addPackage;
            window.addService = addService;
            window.removePackage = removePackage;
            window.removeService = removeService;
            window.removeGalleryItem = removeGalleryItem;
            window.addServiceItem = addServiceItem;
            window.addFaqItem = addFaqItem;
            window.removeFaq = removeFaq;
            window.removeServiceCategory = removeServiceCategory;
            window.removeTeamMember = removeTeamMember;
            window.navigateToStep = navigateToStep;
            window.showStep = showStep;
            
            // Step navigation function with data saving
            async function navigateToStep(targetStep) {
                try {
                    // Save current step data before navigating
                    if (vendorSetupState.currentStep) {
                        saveCurrentStepData();
                        await submitCurrentStepToBackend();
                    }
                    
                    // Navigate to target step
                    vendorSetupState.currentStep = targetStep;
                    showStep(targetStep);
                    
                    // Load summary if navigating to step 9
                    if (targetStep === 9) {
                        setTimeout(() => {
                            loadVendorSummary();
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error navigating to step:', error);
                    alert('Error saving data: ' + error.message);
                }
            }

            // Show step function
            function showStep(stepNumber) {
                // Hide all steps
                document.querySelectorAll('.setup-step').forEach(step => {
                    step.style.display = 'none';
                });
                
                // Show target step
                const targetStep = document.getElementById(`setup-step-${stepNumber}`);
                if (targetStep) {
                    targetStep.style.display = 'block';
                }
                
                // Update step indicators
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    indicator.classList.remove('active', 'completed');
                    if (index + 1 === stepNumber) {
                        indicator.classList.add('active');
                    } else if (index + 1 < stepNumber) {
                        indicator.classList.add('completed');
                    }
                });

                // Update vendor registration header title and progress bar
                const registrationTitle = document.getElementById('registration-title');
                if (registrationTitle) {
                    const setupTitles = { 1: 'Business Basics', 2: 'Location Information', 3: 'Services & Packages', 4: 'Additional Details', 5: 'Availability & Scheduling', 6: 'Gallery & Media', 7: 'Social Media', 8: 'FAQ Section', 9: 'Setup Summary' };
                    registrationTitle.innerHTML = `<span class="step-number-badge">${stepNumber}</span>Step ${stepNumber} of 9: ${setupTitles[stepNumber] || 'Complete Your Vendor Setup'}`;
                }
                const setupProgressBar = document.getElementById('setup-progress-bar');
                if (setupProgressBar) {
                    setupProgressBar.style.width = `${(stepNumber / 9) * 100}%`;
                }
                
                vendorSetupState.currentStep = stepNumber;
            }

            function validateCurrentStep() {
                const step = vendorSetupState.currentStep;
                if (step === 1) {
                    const businessName = document.getElementById('business-name')?.value;
                    const businessDescription = document.getElementById('business-description')?.value;
                    if (!businessName || !businessDescription) { alert('Please fill in all required fields for Business Basics.'); return false; }
                } else if (step === 2) {
                    const address = document.getElementById('business-address')?.value;
                    if (!address) { alert('Please provide your business address.'); return false; }
                } else if (step === 3) {
                    const selectedServices = vendorSetupState.selectedPredefinedServices || [];
                    if (selectedServices.length === 0) { alert('Please select at least one service to offer to your clients.'); return false; }
                    const invalidServices = selectedServices.filter(svc => {
                        const model = svc.pricingModel;
                        if (model === 'time_based') {
                            return !(svc.baseRate > 0 && (svc.baseDurationMinutes > 0 || svc.durationMinutes > 0));
                        } else if (model === 'fixed_price') {
                            return !(svc.fixedPrice > 0);
                        } else if (model === 'per_attendee') {
                            return !(svc.pricePerPerson > 0);
                        }
                        return !((svc.vendorPrice && svc.vendorPrice > 0) || (svc.price && svc.price > 0));
                    });
                    if (invalidServices.length > 0) {
                        const names = invalidServices.map(s => s.name || s.serviceName || 'Unnamed Service').join(', ');
                        alert('Please provide pricing for all selected services. Missing: ' + names);
                        return false;
                    }
                }
                return true;
            }
            
            // Initialize event listeners when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Add Service button event listener
                const addServiceBtn = document.getElementById('add-service-item-btn');
                if (addServiceBtn) {
                    addServiceBtn.addEventListener('click', addServiceItem);
                }
                
                // Add FAQ button event listener
                const addFaqBtn = document.getElementById('add-faq-item-btn');
                if (addFaqBtn) {
                    addFaqBtn.addEventListener('click', addFaqItem);
                }
                
                // Complete setup button event listener
                const completeSetupBtn = document.getElementById('complete-setup-btn');
                if (completeSetupBtn) {
                    completeSetupBtn.addEventListener('click', completeVendorSetup);
                }
                
                // Step navigation buttons - Add event listeners for ALL step navigation buttons
                const stepButtons = [
                    { id: 'next-to-step-2', targetStep: 2 },
                    { id: 'next-to-step-3', targetStep: 3 },
                    { id: 'next-to-step-4', targetStep: 4 },
                    { id: 'next-to-step-5', targetStep: 5 },
                    { id: 'next-to-step-6', targetStep: 6 },
                    { id: 'next-to-step-7', targetStep: 7 },
                    { id: 'next-to-step-8', targetStep: 8 },
                    { id: 'next-to-step-9', targetStep: 9 },
                    { id: 'back-to-step-1', targetStep: 1 },
                    { id: 'back-to-step-2', targetStep: 2 },
                    { id: 'back-to-step-3', targetStep: 3 },
                    { id: 'back-to-step-4', targetStep: 4 },
                    { id: 'back-to-step-5', targetStep: 5 },
                    { id: 'back-to-step-6', targetStep: 6 },
                    { id: 'back-to-step-7', targetStep: 7 },
                    { id: 'back-to-step-8', targetStep: 8 }
                ];
                
                stepButtons.forEach(button => {
                    const btn = document.getElementById(button.id);
                    if (btn) {
                        btn.addEventListener('click', function() {
                            navigateToStep(button.targetStep);
                        });
                    }
                });
                
                // Social media inputs - ensure proper URL concatenation
                const socialInputs = ['social-facebook', 'social-instagram', 'social-twitter', 'social-linkedin', 'social-youtube', 'social-tiktok'];
                socialInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('blur', function() {
                            const prefix = this.getAttribute('data-prefix');
                            if (this.value && prefix) {
                                // Store the full URL in a data attribute for later use
                                this.setAttribute('data-full-url', prefix + this.value);
                            }
                        });
                    }
                });
            });
            
            // Handle Google Sign-in response
            async function handleGoogleSignIn(response) {
                const credential = response.credential;
                const decodedToken = parseJwt(credential);

                if (!decodedToken.email || !decodedToken.name) {
                    alert('Google sign-in failed. Email or name is missing.');
                    return;
                }

                try {
                    const apiResponse = await fetch(`${API_BASE_URL}/users/social-login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: decodedToken.email,
                            name: decodedToken.name,
                            authProvider: 'google',
                            avatar: decodedToken.picture
                        })
                    });

                    if (!apiResponse.ok) {
                        const errorData = await apiResponse.json();
                        throw new Error(errorData.message || 'Social login failed.');
                    }

                    const userData = await apiResponse.json();
                    localStorage.setItem('token', userData.token);
                    
                    simulateLogin({
                        id: userData.userId,
                        name: userData.name,
                        email: userData.email,
                        avatar: userData.avatar || userData.name[0].toUpperCase(),
                        isVendor: userData.isVendor || false
                    });
                    connectToChat();
                    promptForAccountType(userData.userId);

                } catch (error) {
                    console.error('Google sign-in API error:', error);
                    alert('Google sign-in failed: ' + error.message);
                }
            }

            function parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    return null;
                }
            }

            // Prompt user for account type after social login
            function promptForAccountType(userId) {
                const accountType = prompt("Welcome! Are you a Client or a Vendor? (Type 'client' or 'vendor')");
                if (accountType && accountType.toLowerCase() === 'vendor') {
                    if (currentUser) currentUser.isVendor = true;
                    // Automatically show the vendor setup wizard
                    initializeVendorSetup(userId);
                } else {
                    alert("You have been registered as a client. You can switch to a vendor account later.");
                }
            }


            // Filter vendors based on current filters
            function filterVendors() {
                // Get search term
                const searchTerm = searchInput.value.toLowerCase();

                // Get filter values
                const selectedTypes = [];
                document.querySelectorAll('.filter-section input[type="checkbox"]:checked').forEach(checkbox => {
                    if (checkbox.id !== 'current-location' && checkbox.id !== 'within50') {
                        selectedTypes.push(checkbox.id);
                    }
                });

                const priceRange = document.getElementById('price-slider').value;
                const useCurrentLocation = document.getElementById('current-location').checked;
                const within50Miles = document.getElementById('within50').checked;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const region = document.getElementById('region-select').value;

                // First apply all filters EXCEPT location
                let filtered = state.vendors.filter(vendor => {
                    // Category filter
                    if (state.currentCategory !== 'all' && vendor.category !== state.currentCategory) {
                        return false;
                    }

                    // Search term (vendor name, location, or services)
                    if (searchTerm) {
                        const nameMatch = vendor.name.toLowerCase().includes(searchTerm);
                        const locationMatch = vendor.location.toLowerCase().includes(searchTerm);
                        let serviceMatch = false;

                        if (vendor.services) {
                            serviceMatch = vendor.services.some(category =>
                                category.services.some(service =>
                                    service.name.toLowerCase().includes(searchTerm) ||
                                    service.description.toLowerCase().includes(searchTerm))
                            );
                        }

                        if (!nameMatch && !locationMatch && !serviceMatch) {
                            return false;
                        }
                    }


                    // Vendor type
                    const vendorType = vendor.type?.toLowerCase() || 'independent';
                    if (selectedTypes.length > 0 && !selectedTypes.includes(vendorType)) {
                        return false;
                    }

                    // Price range
                    if (priceRange < 33 && vendor.priceLevel === '$$$') return false;
                    if (priceRange > 66 && vendor.priceLevel === '$') return false;

                    // Popular filters
                    if (state.filters.popular.length > 0) {
                        if (state.filters.popular.includes('premium') && !vendor.isPremium) return false;
                        if (state.filters.popular.includes('eco-friendly') && !vendor.isEcoFriendly) return false;
                        if (state.filters.popular.includes('award-winning') && !vendor.isAwardWinning) return false;
                    }

                    // Date and time availability filter
                    const eventDateInput = document.getElementById('event-date');
                    const eventStartTimeInput = document.getElementById('event-start-time');
                    const eventEndTimeInput = document.getElementById('event-end-time');
                    
                    if (eventDateInput && eventDateInput.value && eventStartTimeInput && eventEndTimeInput) {
                        const eventDate = new Date(eventDateInput.value);
                        const eventDayOfWeek = eventDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                        const eventStartTime = eventStartTimeInput.value;
                        const eventEndTime = eventEndTimeInput.value;
                        
                        console.log('Filtering vendor:', vendor.name, 'for date:', eventDateInput.value, 'day:', eventDayOfWeek, 'time:', eventStartTime, '-', eventEndTime);
                        
                        // Check if vendor has business hours data
                        if (vendor.businessHours && Array.isArray(vendor.businessHours)) {
                            console.log('Vendor business hours:', vendor.businessHours);
                            
                            // Find schedule for the event day
                            const daySchedule = vendor.businessHours.find(h => h.DayOfWeek === eventDayOfWeek);
                            console.log('Day schedule for day', eventDayOfWeek, ':', daySchedule);
                            
                            if (!daySchedule || !daySchedule.IsAvailable) {
                                console.log('Vendor', vendor.name, 'is closed on day', eventDayOfWeek);
                                return false; // Vendor is closed on this day
                            }
                            
                            // Check if event time falls within business hours
                            if (eventStartTime && eventEndTime) {
                                const businessStart = daySchedule.OpenTime;
                                const businessEnd = daySchedule.CloseTime;
                                
                                console.log('Business hours:', businessStart, '-', businessEnd, 'vs Event time:', eventStartTime, '-', eventEndTime);
                                
                                if (eventStartTime < businessStart || eventEndTime > businessEnd) {
                                    console.log('Vendor', vendor.name, 'event time is outside business hours');
                                    return false; // Event time is outside business hours
                                }
                            }
                        } else {
                            console.log('Vendor', vendor.name, 'has no business hours data');
                        }
                    }

                    // Region filter
                    if (region && vendor.region !== region) {
                        return false;
                    }

                    return true;
                });

                // Handle location filter - backend already filters by distance radius when coordinates are provided
                state.filteredVendors = filtered;
                
                let locationMessage = '';
                if (useCurrentLocation && state.userLocation && within50Miles) {
                    locationMessage = `${filtered.length} vendors available within 50 miles`;
                } else {
                    locationMessage = `${filtered.length} vendors available`;
                }
                resultsCount.textContent = locationMessage;

                // Apply sorting
                sortVendors(false);

                // Reset to first page
                state.currentPage = 1;

                // Update UI
                updateMetadata({ total: state.filteredVendors.length });
                renderVendors();

                // Update map if in map view
                if (state.map) {
                    // updateMapMarkers(); // DISABLED - causing marker bouncing
                }
            }

            // Sort vendors
            function sortVendors(shouldRender = true) {
                const sortValue = sortSelect.value;

                switch(sortValue) {
                    case 'price-low':
                        state.filteredVendors.sort((a, b) => {
                            const priceA = a.priceLevel === '$' ? 1 : a.priceLevel === '$$' ? 2 : 3;
                            const priceB = b.priceLevel === '$' ? 1 : b.priceLevel === '$$' ? 2 : 3;
                            return priceA - priceB;
                        });
                        break;
                    case 'price-high':
                        state.filteredVendors.sort((a, b) => {
                            const priceA = a.priceLevel === '$' ? 1 : a.priceLevel === '$$' ? 2 : 3;
                            const priceB = b.priceLevel === '$' ? 1 : b.priceLevel === '$$' ? 2 : 3;
                            return priceB - priceA;
                        });
                        break;
                    case 'popular':
                        state.filteredVendors.sort((a, b) => {
                            const ratingA = parseFloat(a.rating?.split(' ')[0] || 0);
                            const ratingB = parseFloat(b.rating?.split(' ')[0] || 0);
                            return ratingB - ratingA;
                        });
                        break;
                    case 'nearest':
                        // Sort by actual distance from user location (calculated by backend)
                        state.filteredVendors.sort((a, b) => {
                            const distA = a.distanceMiles ?? a.DistanceMiles ?? 999999;
                            const distB = b.distanceMiles ?? b.DistanceMiles ?? 999999;
                            return distA - distB;
                        });
                        break;
                    case 'rating':
                        state.filteredVendors.sort((a, b) => {
                            const ratingA = a.rating || 0;
                            const ratingB = b.rating || 0;
                            return ratingB - ratingA;
                        });
                        break;
                    default:
                        break;
                }

                if (shouldRender) {
                    renderVendors();
                    if (state.map) {
                        // updateMapMarkers(); // DISABLED - causing marker bouncing
                    }
                }
            }

            // Reset specific filter
            function resetFilter(filterType) {
                switch(filterType) {
                    case 'location':
                        document.getElementById('location-input').value = '';
                        document.getElementById('current-location').checked = false;
                        break;
                    case 'type':
                        const ind = document.getElementById('independent');
                        const comp = document.getElementById('company');
                        if (ind) ind.checked = false;
                        if (comp) comp.checked = false;
                        if (state.filters) {
                            // Clear any stored type fields if present
                            if (state.filters.type) delete state.filters.type;
                            if (state.filters.vendorType) delete state.filters.vendorType;
                        }
                        break;
                }

                filterVendors();
            }


            // Helper function to get category icon
            function getCategoryIcon(category) {
                const icons = {
                    "all": "<i class='fas fa-sparkles'></i>",
                    "venue": "<i class='fas fa-building'></i>",
                    "photo": "<i class='fas fa-camera'></i>",
                    "music": "<i class='fas fa-music'></i>",
                    "catering": "<i class='fas fa-utensils'></i>",
                    "entertainment": "<i class='fas fa-theater-masks'></i>",
                    "experiences": "<i class='fas fa-star'></i>",
                    "decor": "<i class='fas fa-palette'></i>",
                    "beauty": "<i class='fas fa-spa'></i>",
                    "cake": "<i class='fas fa-birthday-cake'></i>",
                    "transport": "<i class='fas fa-car'></i>",
                    "planner": "<i class='fas fa-clipboard-list'></i>",
                    "fashion": "<i class='fas fa-tshirt'></i>",
                    "stationery": "<i class='fas fa-envelope'></i>"
                };
                return icons[category] || "<i class='fas fa-calendar-alt'></i>";
            }

            // Helper function to get category name
            function getCategoryName(category) {
                const names = {
                    "all": "All Categories",
                    "venue": "Venue",
                    "photo": "Photo/Video",
                    "music": "Music/DJ",
                    "catering": "Catering",
                    "entertainment": "Entertainment",
                    "experiences": "Experiences",
                    "decor": "Decorations",
                    "beauty": "Beauty",
                    "cake": "Cake",
                    "transport": "Transportation",
                    "planner": "Planner",
                    "fashion": "Fashion",
                    "stationery": "Stationery"
                };
                return names[category] || "Vendor";
            }

            // Render price indicator
            function renderPriceIndicator(priceLevel) {
                const levels = priceLevel || '$';
                let html = '';

                for (let i = 0; i < 3; i++) {
                    const isFilled = i < levels.length;
                    html += `<span class="price-dot ${isFilled ? 'filled' : ''}"></span>`;
                }

                return html;
            }

            // Update pagination controls
            function updatePagination() {
                // Control Load More visibility and label
                if (!loadMoreWrapper) return;
                const isMap = document.body.classList.contains('map-active');
                const loaded = state.filteredVendors.length;
                const total = state.serverTotalCount || loaded;
                const hasMore = loaded < total;
                loadMoreWrapper.style.display = isMap ? 'none' : (hasMore ? 'flex' : 'none');
                const btn = document.getElementById('load-more-btn');
                if (btn) btn.textContent = hasMore ? 'Load more' : 'No more results';
            }

            // Update metadata in header
            function updateMetadata(metadata) {
                const usingLocation = state.userLocation && document.getElementById('current-location').checked;
                const locationText = usingLocation ? "Near You" : (metadata?.location || 'Los Angeles');
                const categoryText = state.currentCategory === 'all' ? '' : getCategoryName(state.currentCategory) + ' ';

                resultsTitle.textContent = `${categoryText}Vendors in ${locationText}`;
                resultsCount.textContent = `${state.filteredVendors.length} vendors available${usingLocation ? ' near you' : ''}`;
            }

            // Show error message
            function showError(message) {
                try {
                    // If a modal is open, render the error inside the modal instead of the main page
                    if (typeof getVisibleModal === 'function') {
                        const modal = getVisibleModal();
                        if (modal) {
                            if (modal.id === 'booking-modal' && typeof showBookingError === 'function') {
                                showBookingError(message);
                            } else if (typeof renderModalError === 'function') {
                                renderModalError(modal, message);
                            }
                            return;
                        }
                    }
                } catch (_) { /* ignore and fallback below */ }

                // Fallback: update main page vendor results area
                if (typeof vendorGrid !== 'undefined' && vendorGrid) {
                    vendorGrid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--accent)">${message}</div>`;
                }
                if (typeof resultsTitle !== 'undefined' && resultsTitle) {
                    resultsTitle.textContent = "Error";
                }
                if (typeof resultsCount !== 'undefined' && resultsCount) {
                    resultsCount.textContent = String(message);
                }
            }

            // Show dedicated vendor profile page
            async function showVendorProfilePage(vendorId) {
                console.log(`🔍 showVendorProfilePage called with vendorId: ${vendorId}`);
                console.log(`🔍 API_BASE_URL: ${API_BASE_URL}`);
                
                // Validate vendor ID
                if (!vendorId || vendorId === 'undefined' || vendorId === 'null') {
                    console.error('❌ Invalid vendor ID:', vendorId);
                    vendorProfilePage.innerHTML = `
                        <div style="text-align: center; margin-top: 5rem;">
                            <p style="color: var(--accent); margin-bottom: 1rem;">Invalid vendor ID</p>
                            <button onclick="window.location.hash = ''" class="btn btn-outline">← Back to search results</button>
                        </div>
                    `;
                    return;
                }

                mainAppView.style.display = 'none';
                clientDashboardContainer.style.display = 'none';
                vendorDashboardContainer.style.display = 'none';
                vendorProfilePage.style.display = 'block';
                document.body.style.overflow = 'auto';

                vendorProfilePage.innerHTML = '<p style="text-align: center; margin-top: 5rem;">Loading vendor profile...</p>';

                try {
                    const apiUrl = `${API_BASE_URL}/vendors/${vendorId}?userId=${currentUser ? currentUser.id : ''}`;
                    console.log(`🔍 Fetching vendor data from: ${apiUrl}`);
                    
                    const response = await fetch(apiUrl);
                    console.log(`🔍 API Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch vendor details: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    const fullVendorDetails = data.data;

                    // Debug logging for services
                    console.log('🔍 Full API Response:', data);
                    console.log('🔍 Vendor Details:', fullVendorDetails);
                    console.log('🔍 Services Data:', fullVendorDetails.services);
                    console.log('🔍 Services Length:', fullVendorDetails.services ? fullVendorDetails.services.length : 'undefined');

                    renderVendorProfile(fullVendorDetails);
                    
                    // Add logic for the new review form
                    const reviewForm = document.getElementById('review-form');
                    const showReviewFormBtn = document.getElementById('show-review-form');
                    const ratingStars = document.querySelectorAll('#review-form .rating-star');
                    let currentRating = 0;
                    
                    if(showReviewFormBtn) {
                        showReviewFormBtn.addEventListener('click', () => {
                            reviewForm.style.display = 'block';
                            showReviewFormBtn.style.display = 'none';
                        });
                    }

                    ratingStars.forEach(star => {
                        star.addEventListener('click', () => {
                            currentRating = parseInt(star.dataset.rating);
                            ratingStars.forEach(s => {
                                s.classList.toggle('selected', parseInt(s.dataset.rating) <= currentRating);
                            });
                        });
                    });
                    
                    const submitReviewBtn = document.getElementById('submit-review');
                    if (submitReviewBtn) {
                        submitReviewBtn.addEventListener('click', async () => {
                            if (!currentUser) {
                                alert('You must be logged in to leave a review.');
                                return;
                            }
                            const reviewText = document.getElementById('review-text').value;
                            if (reviewText.trim() === '' || currentRating === 0) {
                                alert('Please provide a rating and a comment.');
                                return;
                            }
                            
                            try {
                                const reviewResponse = await fetch(`${API_BASE_URL}/reviews/submit`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                                    },
                                    body: JSON.stringify({
                                        userId: currentUser.id,
                                        vendorProfileId: vendorId,
                                        rating: currentRating,
                                        comment: reviewText
                                    })
                                });
                                
                                if (!reviewResponse.ok) {
                                    const errorData = await reviewResponse.json();
                                    throw new Error(errorData.message || 'Failed to submit review');
                                }
                                
                                alert('Review submitted successfully!');
                                // Simulate adding the new review to the list
                                const newReview = {
                                    ReviewerName: currentUser.name,
                                    Rating: currentRating,
                                    Comment: reviewText,
                                    CreatedAt: new Date().toISOString()
                                };
                                const reviewsList = document.getElementById('vendor-profile-reviews-list');
                                const existingReviews = reviewsList.innerHTML;
                                reviewsList.innerHTML = renderReviews([newReview]) + existingReviews;
                                
                                // Reset the form
                                reviewForm.style.display = 'none';
                                showReviewFormBtn.style.display = 'block';
                                document.getElementById('review-text').value = '';
                                ratingStars.forEach(s => s.classList.remove('selected'));
                                currentRating = 0;
                                
                            } catch (error) {
                                console.error('Review submission failed:', error);
                                alert('Failed to submit review: ' + error.message);
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('Error fetching vendor profile:', error);
                    vendorProfilePage.innerHTML = `
                        <div style="text-align: center; margin-top: 5rem;">
                            <p style="color: var(--accent); margin-bottom: 1rem;">Error loading profile: ${error.message}</p>
                            <button onclick="window.location.hash = ''" class="btn btn-outline">← Back to search results</button>
                        </div>
                    `;
                    // Don't redirect to main page on error - stay on vendor profile page
                }
            }

            // Helper function to render services with booking functionality
            function renderServices(services) {
                console.log('🔍 renderServices called with:', services);
                console.log('🔍 Services type:', typeof services);
                console.log('🔍 Services is array:', Array.isArray(services));
                
                if (!services || services.length === 0) {
                    console.log('🔍 No services found or empty array');
                    return '';
                }
                
                console.log('🔍 Rendering', services.length, 'services');
                let servicesHtml = '';
                services.forEach((service, index) => {
                    console.log(`🔍 Service ${index}:`, service);
                    console.log(`🔍 Service properties:`, Object.keys(service));
                    
                    // Try different possible property names from database
                    const serviceName = service.ServiceName || service.Name || service.service_name || service.name || 'Unnamed Service';
                    const servicePrice = service.Price || service.price || service.BasePrice || service.base_price || 0;
                    const serviceDescription = service.Description || service.description || service.ServiceDescription || service.service_description || '';
                    const serviceDuration = service.Duration || service.duration || service.EstimatedDuration || service.estimated_duration || '';
                    const serviceCapacity = service.Capacity || service.capacity || service.MaxCapacity || service.max_capacity || '';
                    const serviceId = service.ServiceID || service.ID || service.id || service.service_id || index;
                    
                    console.log(`🔍 Mapped values - Name: ${serviceName}, Price: ${servicePrice}, Description: ${serviceDescription}`);
                    
                    const price = servicePrice ? `$${parseFloat(servicePrice).toFixed(2)}` : 'Contact for pricing';
                    const duration = serviceDuration ? ` • ${serviceDuration}` : '';
                    const capacity = serviceCapacity ? ` • Up to ${serviceCapacity} people` : '';
                    
                    servicesHtml += `
                        <div class="service-card" style="background-color: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); transition: all 0.2s; cursor: pointer;" 
                             onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='var(--shadow)'" 
                             onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <h3 class="service-name" style="font-weight: 600; margin: 0; color: var(--text);">${serviceName}</h3>
                                <div class="service-price" style="font-weight: 600; color: var(--primary); white-space: nowrap;">${price}</div>
                            </div>
                            
                            ${serviceDescription ? `
                            <p class="service-description" style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem; line-height: 1.5;">
                                ${serviceDescription}
                            </p>
                            ` : ''}
                            
                            ${(duration || capacity) ? `
                            <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">
                                ${duration}${capacity}
                            </div>
                            ` : ''}
                            
                            <div class="service-actions" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                <button class="btn btn-outline btn-sm add-to-booking-btn" 
                                        data-service-id="${serviceId}" 
                                        data-service-name="${serviceName}" 
                                        data-service-price="${servicePrice || 0}"
                                        style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    Add to Booking
                                </button>
                            </div>
                        </div>
                    `;
                });
                return servicesHtml;
            }

            function renderVendorProfile(details) {
                const profile = details.profile;
                const isFavorite = details.isFavorite;
                const socialMedia = details.socialMedia || [];
                const businessHours = details.businessHours || [];
                const categoryAnswers = details.categoryAnswers || [];
                const faqs = details.faqs || [];
                const team = details.team || [];

                // Helper function to format business hours
                function formatBusinessHours(hours) {
                    if (!hours || hours.length === 0) return '';
                    
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    let hoursHtml = '';
                    
                    hours.forEach(hour => {
                        if (hour.IsAvailable) {
                            const openTime = new Date(hour.OpenTime).toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true 
                            });
                            const closeTime = new Date(hour.CloseTime).toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit', 
                                hour12: true 
                            });
                            hoursHtml += `
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="font-weight: 500;">${dayNames[hour.DayOfWeek]}</span>
                                    <span>${openTime} - ${closeTime}</span>
                                </div>
                            `;
                        } else {
                            hoursHtml += `
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; opacity: 0.6;">
                                    <span style="font-weight: 500;">${dayNames[hour.DayOfWeek]}</span>
                                    <span>Closed</span>
                                </div>
                            `;
                        }
                    });
                    return hoursHtml;
                }

                // Helper function to render social media links (compact version for header)
                function renderSocialMediaIcons(socialMedia) {
                    if (!socialMedia || socialMedia.length === 0) return '';
                    
                    let socialHtml = '';
                    socialMedia.forEach(social => {
                        const platformIcons = {
                            'facebook': 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg',
                            'instagram': 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png',
                            'twitter': 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Logo_of_Twitter.svg',
                            'linkedin': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png',
                            'youtube': 'https://upload.wikimedia.org/wikipedia/commons/4/42/YouTube_icon_%282013-2017%29.png'
                        };
                        
                        const iconUrl = platformIcons[social.Platform.toLowerCase()] || 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
                        socialHtml += `
                            <a href="${social.URL.startsWith('http') ? social.URL : 'https://' + social.URL}" target="_blank" 
                               style="text-decoration: none; opacity: 0.8; transition: opacity 0.2s;" 
                               onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                                <img src="${iconUrl}" width="28" height="28" alt="${social.Platform}" style="border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </a>
                        `;
                    });
                    
                    // Add website if available
                    if (profile.Website) {
                        socialHtml += `
                            <a href="${profile.Website.startsWith('http') ? profile.Website : 'https://' + profile.Website}" target="_blank" 
                               style="text-decoration: none; opacity: 0.8; transition: opacity 0.2s;" 
                               onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg" width="28" height="28" alt="Website" style="border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </a>
                        `;
                    }
                    
                    return socialHtml;
                }

                // Helper function to render social media links (detailed version for content section)
                function renderSocialMedia(socialMedia) {
                    if (!socialMedia || socialMedia.length === 0) return '<p style="color: var(--text-light); font-style: italic;">No social media links available.</p>';
                    
                    let socialHtml = '';
                    socialMedia.forEach(social => {
                        const platformIcons = {
                            'facebook': 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg',
                            'instagram': 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png',
                            'twitter': 'https://upload.wikimedia.org/wikipedia/commons/6/6f/Logo_of_Twitter.svg',
                            'linkedin': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png',
                            'youtube': 'https://upload.wikimedia.org/wikipedia/commons/4/42/YouTube_icon_%282013-2017%29.png'
                        };
                        
                        const iconUrl = platformIcons[social.Platform.toLowerCase()] || 'https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg';
                        socialHtml += `
                            <a href="${social.URL.startsWith('http') ? social.URL : 'https://' + social.URL}" target="_blank" 
                               style="text-decoration: none; color: var(--text); display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s;" 
                               onmouseover="this.style.backgroundColor='var(--secondary)'" onmouseout="this.style.backgroundColor='transparent'">
                                <img src="${iconUrl}" width="32" height="32" alt="${social.Platform}" style="border-radius: 6px;">
                                <span style="text-transform: capitalize; font-weight: 500;">${social.Platform}</span>
                            </a>
                        `;
                    });
                    
                    // Add website if available
                    if (profile.Website) {
                        socialHtml += `
                            <a href="${profile.Website.startsWith('http') ? profile.Website : 'https://' + profile.Website}" target="_blank" 
                               style="text-decoration: none; color: var(--text); display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s;" 
                               onmouseover="this.style.backgroundColor='var(--secondary)'" onmouseout="this.style.backgroundColor='transparent'">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c4/Globe_icon.svg" width="32" height="32" alt="Website" style="border-radius: 6px;">
                                <span style="font-weight: 500;">Website</span>
                            </a>
                        `;
                    }
                    
                    return socialHtml;
                }

                // Helper function to render category answers
                function renderCategoryAnswers(answers) {
                    if (!answers || answers.length === 0) return '';
                    
                    let answersHtml = '';
                    answers.forEach(answer => {
                        const isYes = answer.Answer.toLowerCase() === 'yes';
                        answersHtml += `
                            <div style="background-color: white; padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="color: ${isYes ? '#38a169' : '#e53e3e'}; font-size: 1.2rem;">
                                        ${isYes ? '✓' : '✗'}
                                    </span>
                                    <span style="font-weight: 500;">${answer.QuestionText}</span>
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">
                                    ${answer.Answer}
                                </div>
                            </div>
                        `;
                    });
                    return answersHtml;
                }

                // Helper function to render FAQs
                function renderFAQs(faqs) {
                    if (!faqs || faqs.length === 0) return '';
                    
                    let faqHtml = '';
                    faqs.forEach((faq, index) => {
                        faqHtml += `
                            <div style="background-color: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 1rem;">
                                <h4 style="margin-bottom: 0.75rem; color: var(--primary); font-weight: 600;">
                                    ${faq.Question}
                                </h4>
                                <p style="line-height: 1.6; color: var(--text);">
                                    ${faq.Answer}
                                </p>
                            </div>
                        `;
                    });
                    return faqHtml;
                }

                // Helper function to render team members
                function renderTeam(team) {
                    if (!team || team.length === 0) return '';
                    
                    let teamHtml = '';
                    team.forEach(member => {
                        teamHtml += `
                            <div style="background-color: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); text-align: center;">
                                ${member.PhotoURL ? `<img src="${member.PhotoURL}" alt="${member.Name}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem;">` : ''}
                                <h4 style="margin-bottom: 0.5rem; font-weight: 600;">${member.Name}</h4>
                                <p style="color: var(--primary); font-size: 0.9rem; margin-bottom: 0.75rem;">${member.Role}</p>
                                ${member.Bio ? `<p style="color: var(--text-light); font-size: 0.85rem; line-height: 1.4;">${member.Bio}</p>` : ''}
                            </div>
                        `;
                    });
                    return teamHtml;
                }

                // Build HTML for the entire page
                let html = `
                    <!-- Back Button -->
                    <div style="margin-bottom: 2rem;">
                        <button onclick="window.location.hash = ''" class="btn btn-outline" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>← Back to search results</span>
                        </button>
                    </div>
                    
                    <!-- Image Gallery -->
                    <div id="modal-image-gallery" class="image-gallery">
                        <!-- Images will be loaded dynamically here -->
                    </div>

                    <!-- Vendor Header -->
                    <div class="vendor-profile-header" style="padding: 1.5rem 0; margin-bottom: 2rem; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem;">
                            <div class="vendor-profile-info" style="flex: 1;">
                                <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text);">${profile.BusinessName || profile.DisplayName}</h1>
                                <p style="font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem;">${profile.Tagline || 'Professional Event Services'}</p>
                                
                                <!-- Main Info Row -->
                                <div style="display: flex; align-items: center; gap: 1.25rem; color: var(--text-light); margin-bottom: 0.75rem; flex-wrap: wrap; font-size: 0.9rem;">
                                    <span><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location</span>
                                    ${profile.YearsInBusiness ? `<span><i class="fas fa-trophy" style="color: #fbbf24; margin-right: 0.5rem;"></i>${profile.YearsInBusiness} years in business</span>` : ''}
                                    <span style="color: #fbbf24;">★★★★★ (5.0) • 1 Reviews</span>
                                </div>
                                
                                <!-- Social Media Icons Row -->
                                ${socialMedia.length > 0 || profile.Website ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                                    ${renderSocialMediaIcons(socialMedia)}
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Favorite Button -->
                            <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${profile.VendorProfileID}" style="flex-shrink: 0; font-size: 1.25rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"><i class="fas fa-heart"></i></div>
                        </div>
                    </div>

                    <!-- Vendor Content Sections -->
                    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 2rem; margin-top: 1rem;">
                        <!-- Main Content Area -->
                        <div>
                            <!-- About Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">About Us</h2>
                                <p style="line-height: 1.6; color: var(--text);">${profile.BusinessDescription || 'Welcome to our business! We provide exceptional event services tailored to your needs.'}</p>
                            </div>
                            
                            ${(() => {
                                console.log('🔍 Checking services condition:', details.services);
                                console.log('🔍 Services exists:', !!details.services);
                                console.log('🔍 Services length:', details.services ? details.services.length : 'N/A');
                                const hasServices = details.services && details.services.length > 0;
                                console.log('🔍 Will render services section:', hasServices);
                                return hasServices;
                            })() ? `
                            <!-- Services & Packages Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Services & Packages</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                    ${renderServices(details.services)}
                                </div>
                            </div>
                            ` : (() => {
                                console.log('🔍 Services section NOT rendered - no services found');
                                return '';
                            })()}
                            
                            ${categoryAnswers.length > 0 ? `
                            <!-- Category Services Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Our Specialties</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    ${renderCategoryAnswers(categoryAnswers)}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${faqs.length > 0 ? `
                            <!-- FAQ Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Frequently Asked Questions</h2>
                                <div style="display: flex; flex-direction: column; gap: 1rem;">
                                    ${renderFAQs(faqs)}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${team.length > 0 ? `
                            <!-- Team Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Our Team</h2>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                    ${renderTeam(team)}
                                </div>
                            </div>
                            ` : ''}

                            <!-- Reviews Section -->
                            <div style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: 1rem;">Reviews (1)</h2>
                                <div id="vendor-profile-reviews-list" style="margin-bottom: 1rem;">
                                    ${renderReviews(details.reviews || [])}
                                </div>
                                ${currentUser ? `
                                    <button class="btn btn-outline add-review-btn" id="show-review-form" style="margin-top: 1rem;">Add Review</button>
                                    <div class="review-form" id="review-form" style="display: none; margin-top: 1rem; padding: 1.25rem; background: var(--secondary); border-radius: 8px;">
                                        <div class="rating-input" style="margin-bottom: 1rem;">
                                            <span class="rating-star" data-rating="1" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="2" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="3" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="4" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                            <span class="rating-star" data-rating="5" style="font-size: 1.25rem; cursor: pointer; color: #ddd;">☆</span>
                                        </div>
                                        <textarea class="review-textarea" id="review-text" placeholder="Share your experience..." style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; resize: vertical; margin-bottom: 1rem;"></textarea>
                                        <button class="btn btn-primary" id="submit-review">Submit Review</button>
                                    </div>
                                ` : '<p style="padding: 0.75rem; background: var(--secondary); border-radius: 6px; margin-top: 1rem; text-align: center;"><a href="#" id="login-to-review" style="color: var(--primary); text-decoration: none;">Log in</a> to leave a review</p>'}
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div style="display: flex; flex-direction: column; gap: 1.5rem; position: sticky; top: 5.5rem; align-self: flex-start; height: fit-content; max-height: calc(100vh - 11rem); overflow-y: auto;">
                            <!-- Booking Summary -->
                            <div id="booking-summary" style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Your Booking</h3>
                                <div id="selected-services-list" style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.9rem; color: var(--text-light); text-align: center; font-style: italic;">Select services from the list to get started.</p>
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 1rem 0; padding-top: 1rem; display: flex; justify-content: space-between; font-weight: 600;">
                                    <span>Total</span>
                                    <span id="booking-total-price">$0.00</span>
                                </div>
                                <button class="btn btn-primary" id="proceed-to-book-btn" style="width: 100%;" disabled>Choose Services</button>
                            </div>

                            ${businessHours.length > 0 ? `
                            <!-- Business Hours -->
                            <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Business Hours</h3>
                                <div style="font-size: 0.9rem;">
                                    ${formatBusinessHours(businessHours)}
                                </div>
                            </div>
                            ` : ''}

                            <!-- Contact -->
                            <div style="background: var(--secondary); padding: 1.5rem; border-radius: var(--radius);">
                                <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Contact Vendor</h3>
                                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-light);">Have questions? Get in touch!</p>
                                <button class="btn btn-outline" id="open-chat-btn" style="width: 100%;">Message Vendor</button>
                            </div>
                        </div>
                    </div>
                `;

                vendorProfilePage.innerHTML = html;

                // Set current vendor object for gallery population
                window.currentVendor = {
                    ...profile,
                    images: details.images || [],
                    featuredImageURL: profile.FeaturedImageURL,
                    featuredImage: details.images && details.images.length > 0 ? details.images.find(img => img.IsPrimary) || details.images[0] : null
                };
                
                console.log('<i class="fas fa-check" style="color: #28a745;"></i> Set window.currentVendor with images:', window.currentVendor.images);

                // Add event listeners for the new elements on the profile page
                vendorProfilePage.querySelector('.vendor-favorite').addEventListener('click', () => {
                    toggleFavorite(profile.VendorProfileID);
                });
                
                // FIXED: Populate gallery immediately with images from API response
                console.log('🖼️ Populating gallery with images from API response:', details.images);
                populateVendorGallery(details.images || []);

                vendorProfilePage.querySelector('#open-chat-btn').addEventListener('click', () => {
                    // Simple chat functionality - you can replace this with your actual chat system
                    if (!currentUser) {
                        alert('Please log in to message this vendor.');
                        profileModal.style.display = 'flex';
                        showLoginView();
                        return;
                    }
                    
                    // For now, show a simple contact modal or redirect to contact form
                    const vendorName = profile.BusinessName || profile.DisplayName;
                    const confirmed = confirm(`Would you like to start a conversation with ${vendorName}? This will open a new chat window.`);
                    
                    if (confirmed) {
                        // You can replace this with your actual chat initialization
                        // For now, we'll show a placeholder message
                        alert(`Chat feature coming soon! For now, you can contact ${vendorName} through their website or social media links.`);
                        
                        // Optional: Scroll to social media section
                        const socialSection = document.querySelector('.services-section');
                        if (socialSection) {
                            socialSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                });
                
                 if(document.getElementById('login-to-review')) {
                    document.getElementById('login-to-review').addEventListener('click', (e) => {
                         e.preventDefault();
                         profileModal.style.display = 'flex';
                         showLoginView();
                    });
                }

                // Add event listeners for service booking buttons
                const addToBookingBtns = vendorProfilePage.querySelectorAll('.add-to-booking-btn');
                addToBookingBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const serviceId = btn.dataset.serviceId;
                        const serviceName = btn.dataset.serviceName;
                        const servicePrice = parseFloat(btn.dataset.servicePrice) || 0;
                        
                        addServiceToBooking({
                            id: serviceId,
                            name: serviceName,
                            price: servicePrice
                        });
                        
                        // Update button state
                        btn.textContent = 'Added ✓';
                        btn.style.backgroundColor = 'var(--primary)';
                        btn.style.color = 'white';
                        btn.disabled = true;
                    });
                });
            }

            // Booking management functionality
            let selectedServices = [];
            
            function addServiceToBooking(service) {
                // Check if service is already added
                const existingService = selectedServices.find(s => s.id === service.id);
                if (existingService) {
                    return; // Service already added
                }
                
                selectedServices.push(service);
                updateBookingSummary();
            }
            
            function removeServiceFromBooking(serviceId) {
                selectedServices = selectedServices.filter(s => s.id !== serviceId);
                updateBookingSummary();
                
                // Reset the button state
                const btn = document.querySelector(`[data-service-id="${serviceId}"]`);
                if (btn) {
                    btn.textContent = 'Add to Booking';
                    btn.style.backgroundColor = '';
                    btn.style.color = '';
                    btn.disabled = false;
                }
            }
            
            function updateBookingSummary() {
                const selectedServicesList = document.getElementById('selected-services-list');
                const bookingTotalPrice = document.getElementById('booking-total-price');
                const proceedToBookBtn = document.getElementById('proceed-to-book-btn');
                
                if (!selectedServicesList || !bookingTotalPrice || !proceedToBookBtn) {
                    return; // Elements not found
                }
                
                if (selectedServices.length === 0) {
                    selectedServicesList.innerHTML = '<p style="font-size: 0.9rem; color: var(--text-light); text-align: center; font-style: italic;">Select services from the list to get started.</p>';
                    bookingTotalPrice.textContent = '$0.00';
                    proceedToBookBtn.textContent = 'Choose Services';
                    proceedToBookBtn.disabled = true;
                } else {
                    let servicesHtml = '';
                    let total = 0;
                    
                    selectedServices.forEach(service => {
                        const price = service.price || 0;
                        total += price;
                        
                        servicesHtml += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; font-size: 0.9rem;">${service.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">$${price.toFixed(2)}</div>
                                </div>
                                <button onclick="removeServiceFromBooking('${service.id}')" 
                                        style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.25rem; font-size: 0.8rem;"
                                        title="Remove service">
                                    ✕
                                </button>
                            </div>
                        `;
                    });
                    
                    selectedServicesList.innerHTML = servicesHtml;
                    bookingTotalPrice.textContent = `$${total.toFixed(2)}`;
                    proceedToBookBtn.textContent = `Book ${selectedServices.length} Service${selectedServices.length > 1 ? 's' : ''}`;
                    proceedToBookBtn.disabled = false;
                    
                    // Add click handler for proceed to book button
                    proceedToBookBtn.onclick = () => {
                        if (!currentUser) {
                            alert('Please log in to book services.');
                            profileModal.style.display = 'flex';
                            showLoginView();
                            return;
                        }
                        
                        // For now, show a confirmation dialog
                        const serviceNames = selectedServices.map(s => s.name).join(', ');
                        const confirmed = confirm(`Ready to book these services?\n\n${serviceNames}\n\nTotal: $${total.toFixed(2)}\n\nThis will redirect you to the booking process.`);
                        
                        if (confirmed) {
                            alert('Booking feature coming soon! Your selected services have been saved.');
                            // Here you would typically redirect to a booking/checkout page
                            // or open a booking modal with calendar and payment options
                        }
                    };
                }
            }

            // Make removeServiceFromBooking available globally
            window.removeServiceFromBooking = removeServiceFromBooking;

            // Render reviews for a vendor
            function renderReviews(reviews) {
                if (!reviews || reviews.length === 0) {
                    return '<p>No reviews yet.</p>';
                }
                return reviews.map(review => `
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer">${review.ReviewerName || review.UserName || 'Anonymous'}</div>
                            <div class="review-date">${new Date(review.CreatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <div class="review-rating">${'★'.repeat(review.Rating)}${'☆'.repeat(5 - review.Rating)}</div>
                        ${review.Title ? `<div class="review-title">${review.Title}</div>` : ''}
                        <div class="review-text">${review.Comment}</div>
                    </div>
                `).join('');
            }

            // Close modal (specifically for vendor-modal and its state)
            function closeBookingModal() {
                document.getElementById('vendor-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
                resetBookingModalState();
            }

            // New function to reset the state related to the booking modal
            function resetBookingModalState() {
                state.currentVendor = null;
                state.selectedServices = [];
                state.selectedDate = null;
                state.selectedTime = null;
                // Potentially clear calendar selection or time slots if FullCalendar allows
                const calendarEl = document.getElementById('booking-calendar');
                if (calendarEl && calendarEl._fullCalendar) {
                    calendarEl._fullCalendar.unselect();
                    document.getElementById('time-slots').innerHTML = '';
                }
                document.getElementById('payment-section').style.display = 'none';
                document.getElementById('book-now-btn').style.display = 'block';
            }

            // Show login view in profile modal
            function showLoginView() {
                const titleEl = document.getElementById('profile-modal-title');
                const twofaVisible = twofaForm && window.getComputedStyle(twofaForm).display !== 'none';

                if (twofaVisible) {
                    const container = profileModal.querySelector('.modal-body');
                    if (container) container.style.position = 'relative';

                    loginForm.style.display = 'block';
                    loginForm.style.position = 'absolute';
                    loginForm.style.left = '0';
                    loginForm.style.right = '0';
                    loginForm.style.transform = 'translateX(-24px)';
                    loginForm.style.opacity = '0';

                    twofaForm.style.position = 'absolute';
                    twofaForm.style.left = '0';
                    twofaForm.style.right = '0';
                    twofaForm.style.transform = 'translateX(0)';
                    twofaForm.style.opacity = '1';

                    loginForm.style.transition = 'transform 200ms ease, opacity 200ms ease';
                    twofaForm.style.transition = 'transform 200ms ease, opacity 200ms ease';

                    requestAnimationFrame(() => {
                        loginForm.style.transform = 'translateX(0)';
                        loginForm.style.opacity = '1';
                        twofaForm.style.transform = 'translateX(24px)';
                        twofaForm.style.opacity = '0';
                    });

                    setTimeout(() => {
                        if (twofaForm) twofaForm.style.display = 'none';
                        twofaForm.style.position = '';
                        twofaForm.style.transition = '';
                        twofaForm.style.transform = '';
                        twofaForm.style.opacity = '';

                        loginForm.style.position = '';
                        loginForm.style.transition = '';
                        loginForm.style.transform = '';
                        loginForm.style.opacity = '';

                        if (container) container.style.position = '';
                        if (titleEl) titleEl.textContent = 'Welcome to PlanHive';
                    }, 220);
                } else {
                    loginForm.style.display = 'block';
                    signupForm.style.display = 'none';
                    loggedInView.style.display = 'none';
                    if (twofaForm) twofaForm.style.display = 'none';
                    if (titleEl) titleEl.textContent = 'Welcome to PlanHive';
                }

                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            }

            function showTwoFAView() {
                signupForm.style.display = 'none';
                loggedInView.style.display = 'none';

                const container = profileModal.querySelector('.modal-body');
                if (container) container.style.position = 'relative';
                // Keep the 2FA panel the same height as the login panel
                try {
                    const loginHeight = loginForm.scrollHeight || loginForm.getBoundingClientRect().height;
                    if (twofaForm && loginHeight) twofaForm.style.minHeight = `${Math.ceil(loginHeight)}px`;
                } catch (e) {}

                if (twofaForm) {
                    twofaForm.style.display = 'flex';
                    twofaForm.style.flexDirection = 'column';
                    twofaForm.style.position = 'absolute';
                    twofaForm.style.left = '0';
                    twofaForm.style.right = '0';
                    twofaForm.style.transform = 'translateX(24px)';
                    twofaForm.style.opacity = '0';
                    twofaForm.style.transition = 'transform 200ms ease, opacity 200ms ease';
                }

                loginForm.style.position = 'absolute';
                loginForm.style.left = '0';
                loginForm.style.right = '0';
                loginForm.style.transform = 'translateX(0)';
                loginForm.style.opacity = '1';
                loginForm.style.transition = 'transform 200ms ease, opacity 200ms ease';

                requestAnimationFrame(() => {
                    loginForm.style.transform = 'translateX(-24px)';
                    loginForm.style.opacity = '0';
                    if (twofaForm) {
                        twofaForm.style.transform = 'translateX(0)';
                        twofaForm.style.opacity = '1';
                    }
                });

                setTimeout(() => {
                    loginForm.style.display = 'none';
                    loginForm.style.position = '';
                    loginForm.style.transition = '';
                    loginForm.style.transform = '';
                    loginForm.style.opacity = '';

                    if (twofaForm) {
                        twofaForm.style.position = '';
                        twofaForm.style.transition = '';
                        twofaForm.style.transform = '';
                        twofaForm.style.opacity = '';
                    }

                    if (container) container.style.position = '';
                }, 220);

                const title = document.getElementById('profile-modal-title');
                if (title) title.textContent = 'Verify your login';
                const codeEl = document.getElementById('twofa-code');
                if (codeEl) { codeEl.value = ''; }
                clearTwoFAOtp();
                focusFirstTwoFAOtp();
                const emailEl = document.getElementById('twofa-email');
                if (emailEl) emailEl.textContent = pendingLoginEmail || '';
            }

            // Show signup view in profile modal
            function showSignupView() {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                loggedInView.style.display = 'none';
                document.getElementById('profile-modal-title').textContent = 'Create an Account';
                // Clear form fields
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
            }

            // Show logged in view in profile modal
            function showLoggedInView() {
                const loginFormEl = document.getElementById('login-form');
                const signupFormEl = document.getElementById('signup-form');
                const loggedInViewEl = document.getElementById('logged-in-view');
                
                if (loginFormEl) loginFormEl.style.display = 'none';
                if (signupFormEl) signupFormEl.style.display = 'none';
                if (loggedInViewEl) loggedInViewEl.style.display = 'block';
                
                const titleEl = document.getElementById('profile-modal-title');
                if (titleEl) titleEl.textContent = 'My Account';

                // Update user info
                const nameEl = document.getElementById('profile-name');
                const emailEl = document.getElementById('profile-email');
                const avatarEl = document.getElementById('profile-avatar');
                
                if (nameEl && currentUser) nameEl.textContent = currentUser.name;
                if (emailEl && currentUser) emailEl.textContent = currentUser.email;
                if (avatarEl && currentUser) avatarEl.textContent = currentUser.avatar;
            }

            
            async function loadVendorRequests(direction = (vendorReqFilters?.direction || 'inbound'), status = (vendorReqFilters?.status || 'all'), options = {}) {
                const container = document.getElementById('vendor-pending-requests');
                const pendingCountEl = document.getElementById('pending-requests-count');
                const expiringSoonCountEl = document.getElementById('expiring-soon-count');
                const silent = options && options.silent;
                
                if (!silent) container.innerHTML = '<p>Loading requests...</p>';
                
                try {
                    // Get vendor profile ID using current user's ID
                    if (!currentUser || !currentUser.id) {
                        throw new Error('User not logged in');
                    }
                    
                    const vendorProfileResponse = await fetch(`${API_BASE_URL}/vendors/profile?userId=${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!vendorProfileResponse.ok) throw new Error('Failed to fetch vendor profile');
                    const vendorProfileData = await vendorProfileResponse.json();
                    const vendorProfileId = vendorProfileData.vendorProfileId;
                    if (!vendorProfileId) throw new Error('Vendor profile not found');
                    
                    const qs = new URLSearchParams({ direction, status }).toString();
                    const url = `${API_BASE_URL}/bookings/vendor/${vendorProfileId}/requests?${qs}`;
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                    if (!response.ok) throw new Error('Failed to fetch vendor requests');
                    const data = await response.json();
                    const allRequests = data.requests || [];
                    // Client-side safety filter matching selected status (handles edge cases)
                    const normalizeStatus = (r) => {
                        let s = (r.Status || 'pending').toString().toLowerCase();
                        if (s === 'pending' && (r.IsExpired === 1 || (r.ExpiresAt && new Date(r.ExpiresAt) <= new Date()))) s = 'expired';
                        if (s === 'accepted') s = 'approved';
                        return s;
                    };
                    const requests = (status && status !== 'all') ? allRequests.filter(r => normalizeStatus(r) === status) : allRequests;
                    
                    // Update inbound pending stats (independent of current filter)
                    try {
                        const statResp = await fetch(`${API_BASE_URL}/bookings/vendor/${vendorProfileId}/requests?${new URLSearchParams({ direction: 'inbound', status: 'pending' }).toString()}`, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                        if (statResp.ok) {
                            const statData = await statResp.json();
                            const now = new Date();
                            const expSoon = (statData.requests || []).filter(req => {
                                if (!req.ExpiresAt) return false;
                                const exp = new Date(req.ExpiresAt);
                                const hrs = (exp.getTime() - now.getTime()) / (1000 * 60 * 60);
                                return hrs <= 6 && hrs > 0;
                            }).length;
                            if (pendingCountEl) pendingCountEl.textContent = (statData.requests || []).length;
                            if (expiringSoonCountEl) expiringSoonCountEl.textContent = expSoon;
                        }
                    } catch (_) { /* non-blocking */ }
                    
                    renderVendorRequests(requests, direction, status);
                } catch (error) {
                    console.error('Error loading vendor requests:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load requests: ${error.message}</p>`;
                }
            }
            
            function renderVendorRequests(requests, direction = 'inbound', status = 'all') {
                const container = document.getElementById('vendor-pending-requests');
                // Non-blocking: prompt vendor to connect to Stripe if needed
                getVendorProfileId().then(vId => { if (vId) checkVendorStripeStatus(vId, true); }).catch(() => {});
                
                if (requests.length === 0) {
                    const msg = (status === 'pending') ? 'No pending requests at this time.' : 'No requests for this filter.';
                    container.innerHTML = `<p>${msg}</p>`;
                    return;
                }
                
                const countHtml = `<div class="booking-count">${requests.length} requests</div>`;
                container.innerHTML = countHtml + requests.map(request => {
                    // Compute hours remaining from ExpiresAt if available
                    let hoursRemaining = 0;
                    try {
                        const now = new Date();
                        const exp = request.ExpiresAt ? new Date(request.ExpiresAt) : null;
                        if (exp) {
                            const diffMs = exp.getTime() - now.getTime();
                            hoursRemaining = Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60)));
                        }
                    } catch(_) {}

                    // Parse services JSON for display (robust)
                    let servicesList = [];
                    let primaryService = null;
                    let servicesRaw = '';
                    try {
                        if (typeof request.Services === 'string' && request.Services.trim()) {
                            servicesRaw = request.Services;
                            const parsed = JSON.parse(request.Services);
                            if (Array.isArray(parsed)) {
                                servicesList = parsed;
                            } else if (parsed && typeof parsed === 'object') {
                                if (Array.isArray(parsed.services)) servicesList = parsed.services;
                                else if (Array.isArray(parsed.selectedServices)) servicesList = parsed.selectedServices;
                                else if (Array.isArray(parsed.items)) servicesList = parsed.items;
                                else if (parsed.Service || parsed.service || parsed.Name || parsed.name) servicesList = [parsed];
                                else {
                                    const values = Object.values(parsed).filter(v => v && typeof v === 'object');
                                    if (values.length) servicesList = values;
                                }
                            }
                        } else if (Array.isArray(request.Services)) {
                            servicesList = request.Services;
                        }
                        primaryService = servicesList[0] || null;
                    } catch(_) {
                        // Fallback: use raw string if JSON parse fails
                        servicesList = [];
                        primaryService = null;
                    }

                    const eventDate = request.EventDate ? new Date(request.EventDate) : null;
                    const month = eventDate ? eventDate.toLocaleDateString('en-US', { month: 'short' }) : '—';
                    const day = eventDate ? eventDate.getDate() : '—';
                    const weekday = eventDate ? eventDate.toLocaleDateString('en-US', { weekday: 'short' }) : '—';
                    const eventDateStr = eventDate ? eventDate.toLocaleDateString() : '—';
                    const getServiceName = (s) => (typeof s === 'string'
                        ? s
                        : (s.Name || s.name || s.ServiceName || s.serviceName || s.service || s.Service || s.Title || s.title || s.Label || s.label || s.DisplayName || s.displayName || s.CategoryName || s.category || s.Category));
                    let serviceNamesArr = servicesList.map(getServiceName).filter(Boolean);
                    // Fallback: if Services is a raw CSV or plain string
                    if ((!serviceNamesArr || serviceNamesArr.length === 0) && servicesRaw && typeof servicesRaw === 'string') {
                        const rawList = servicesRaw.split(',').map(s => s.trim()).filter(Boolean);
                        if (rawList.length > 0) serviceNamesArr = rawList;
                    }
                    const primaryServiceName = serviceNamesArr[0] || (primaryService ? getServiceName(primaryService) : (servicesRaw && typeof servicesRaw === 'string' ? servicesRaw.split(',')[0].trim() : ''));
                    const additionalServiceCount = Math.max(0, serviceNamesArr.length - 1);
                    const serviceNames = serviceNamesArr.length 
                        ? serviceNamesArr.join(', ')
                        : (servicesRaw || '—');
                    const serviceCost = (request.Budget && Number(request.Budget) > 0) ? `$${Number(request.Budget).toLocaleString()}` : (primaryService && (primaryService.BasePrice || primaryService.FixedPrice)) ? `$${Number(primaryService.BasePrice || primaryService.FixedPrice).toLocaleString()}` : '—';
                    const clientEmail = request.ClientEmail || '';
                    const budgetStr = (request.Budget && Number(request.Budget) > 0) ? `$${Number(request.Budget).toLocaleString()}` : '';
                    const expiresStr = request.ExpiresAt ? new Date(request.ExpiresAt).toLocaleString() : '';
                    // Event start/end with duration
                    const parseTime = (val) => {
                        try {
                            if (!val) return { mins:null, label:'' };
                            // If Date object, use UTC components to avoid TZ shifts
                            if (val instanceof Date) {
                                const h = val.getUTCHours();
                                const m = val.getUTCMinutes();
                                return { mins: h*60+m, label: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` };
                            }
                            const s = String(val).trim();
                            // 1) Prefer extracting time-of-day tokens directly (avoids TZ issues)
                            const m1 = s.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM|am|pm)?/);
                            if (m1) {
                                let h = parseInt(m1[1],10);
                                const mm = parseInt(m1[2],10);
                                const ap = m1[4] ? m1[4].toLowerCase() : '';
                                if (ap) {
                                    if (ap === 'pm' && h < 12) h += 12;
                                    if (ap === 'am' && h === 12) h = 0;
                                }
                                return { mins: h*60+mm, label: `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}` };
                            }
                            // 2) ISO-like string: extract the HH:MM(:SS) part after 'T' if present
                            const tMatch = s.match(/T(\d{2}):(\d{2})(?::(\d{2}))?/);
                            if (tMatch) {
                                const h = parseInt(tMatch[1],10);
                                const mm = parseInt(tMatch[2],10);
                                return { mins: h*60+mm, label: `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}` };
                            }
                            // 3) Fallback: construct Date and use UTC components
                            const iso = s.includes('T') ? new Date(s) : null;
                            if (iso && !isNaN(iso.getTime())) {
                                const h = iso.getUTCHours();
                                const m = iso.getUTCMinutes();
                                return { mins: h*60+m, label: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` };
                            }
                            // Fallback: return as-is
                            return { mins:null, label: s };
                        } catch { return { mins:null, label:'' }; }
                    };
                    const startCandidate = request.EventStartTime || request.EventTime || (primaryService && (primaryService.StartTime || primaryService.startTime)) || '';
                    const endCandidate = request.EventEndTime || (primaryService && (primaryService.EndTime || primaryService.endTime)) || '';
                    const parsedStart = parseTime(startCandidate);
                    let parsedEnd = parseTime(endCandidate);
                    const primaryDurationMin = (primaryService && (Number(primaryService.VendorDurationMinutes || primaryService.Duration || primaryService.duration || primaryService.durationMinutes))) || null;
                    if (!parsedEnd.label && parsedStart.mins != null && primaryDurationMin) {
                        const total = (parsedStart.mins + primaryDurationMin) % (24*60);
                        parsedEnd = { mins: total, label: `${String(Math.floor(total/60)).padStart(2,'0')}:${String(total%60).padStart(2,'0')}` };
                    }
                    let durationMin = null;
                    if (parsedStart.mins != null && parsedEnd.mins != null) {
                        durationMin = (parsedEnd.mins - parsedStart.mins + 24*60) % (24*60);
                    } else if (primaryDurationMin) {
                        durationMin = primaryDurationMin;
                    }
                    const durationLabel = durationMin != null ? (durationMin >= 60 ? `${Math.floor(durationMin/60)}h ${durationMin%60 ? (durationMin%60)+'m' : ''}`.trim() : `${durationMin}m`) : '';
                    const to12h = (lab) => {
                        try {
                            if (!lab) return '';
                            const [hh, mm] = String(lab).split(':');
                            let h = parseInt(hh, 10);
                            const m = parseInt(mm, 10);
                            const ap = h >= 12 ? 'PM' : 'AM';
                            h = h % 12; if (h === 0) h = 12;
                            return `${h}:${String(m).padStart(2,'0')} ${ap}`;
                        } catch { return lab; }
                    };
                    const eventTimeStr = (parsedStart.label && parsedEnd.label)
                        ? `${to12h(parsedStart.label)} – ${to12h(parsedEnd.label)}${durationLabel ? ` (${durationLabel})` : ''}`
                        : (to12h(parsedStart.label) || to12h(parsedEnd.label) || '');
                    const createdAtStr = request.CreatedAt ? new Date(request.CreatedAt).toLocaleString() : '';
                    
                    // Status badge config
                    let statusRaw = (request.Status || 'pending').toString().toLowerCase();
                    // Normalize expired pending
                    if (statusRaw === 'pending' && (request.IsExpired === 1 || (request.ExpiresAt && new Date(request.ExpiresAt) <= new Date()))) {
                        statusRaw = 'expired';
                    }
                    const statusMap = {
                        pending:  { icon: 'fa-clock',          color: '#f59e0b', textColor: '#111827', bg: 'rgba(245, 158, 11, 0.12)', label: 'Pending response' },
                        approved: { icon: 'fa-check-circle',   color: '#10b981', textColor: '#111827', bg: 'rgba(16, 185, 129, 0.12)', label: 'Accepted' },
                        accepted: { icon: 'fa-check-circle',   color: '#10b981', textColor: '#111827', bg: 'rgba(16, 185, 129, 0.12)', label: 'Accepted' },
                        declined: { icon: 'fa-times-circle',   color: '#ef4444', textColor: '#111827', bg: 'rgba(239, 68, 68, 0.12)', label: 'Declined' },
                        expired:  { icon: 'fa-hourglass-end',  color: '#6b7280', textColor: '#111827', bg: 'rgba(107, 114, 128, 0.12)', label: 'Expired' }
                    };
                    const statusCfg = statusMap[statusRaw] || statusMap.pending;
                    const isPending = statusRaw === 'pending';
                    const pendingResponseText = isPending ? 'Pending response' : '';

                    // Build details grid with specific order
                    const detailsRows = [];
                    const pushRow = (label, value, full = false) => {
                        if (value && value !== '—') {
                            detailsRows.push(`<div class=\"request-detail-row\" ${full ? 'style=\"grid-column: span 2;\"' : ''}><span class=\"request-detail-label\">${label}</span><span class=\"request-detail-value\">${value}</span></div>`);
                        }
                    };
                    // Include previous info in details
                    pushRow('Event Name', request.EventName);
                    pushRow('Event', request.EventType);
                    pushRow('Time Zone', request.TimeZone);
                    pushRow('Attendees', (request.AttendeeCount !== null && request.AttendeeCount !== undefined) ? request.AttendeeCount : '');
                    // Service-specific times for display and details
                    const serviceStartRaw = (primaryService && (primaryService.StartTime || primaryService.startTime)) || '';
                    const serviceEndRaw = (primaryService && (primaryService.EndTime || primaryService.endTime)) || '';
                    const serviceParsedStart = serviceStartRaw ? parseTime(serviceStartRaw) : { mins:null, label:'' };
                    let serviceParsedEnd = serviceEndRaw ? parseTime(serviceEndRaw) : { mins:null, label:'' };
                    // derive end from duration if missing
                    if (!serviceParsedEnd.label && serviceParsedStart.mins != null && primaryDurationMin) {
                        const total = (serviceParsedStart.mins + primaryDurationMin) % (24*60);
                        serviceParsedEnd = { mins: total, label: `${String(Math.floor(total/60)).padStart(2,'0')}:${String(total%60).padStart(2,'0')}` };
                    }
                    let serviceDurationMin = null;
                    if (serviceParsedStart.mins != null && serviceParsedEnd.mins != null) {
                        serviceDurationMin = (serviceParsedEnd.mins - serviceParsedStart.mins + 24*60) % (24*60);
                    } else if (primaryDurationMin) {
                        serviceDurationMin = primaryDurationMin;
                    }
                    const serviceDurationLabel = serviceDurationMin != null ? (serviceDurationMin >= 60 ? `${Math.floor(serviceDurationMin/60)}h ${serviceDurationMin%60 ? (serviceDurationMin%60)+'m' : ''}`.trim() : `${serviceDurationMin}m`) : '';
                    const serviceStart = serviceParsedStart.label ? to12h(serviceParsedStart.label) : '';
                    const serviceEnd = serviceParsedEnd.label ? to12h(serviceParsedEnd.label) : '';
                    const serviceTimeStr = (serviceParsedStart.label && serviceParsedEnd.label)
                        ? `${serviceStart} – ${serviceEnd}${serviceDurationLabel ? ` (${serviceDurationLabel})` : ''}`
                        : (serviceStart || serviceEnd || '');
                    // Services already shown in main summary; include full list in details if multiple
                    if (additionalServiceCount > 0 && serviceNames && serviceNames !== '—') {
                        pushRow('Services', serviceNames, true);
                    }
                    if (request.SpecialRequests) pushRow('Special Requests', request.SpecialRequests, true);
                    pushRow('Respond By', expiresStr);
                    pushRow('Requested On', createdAtStr);
                    // Price breakdown (from services or total budget)
                    try {
                        const money = (n) => `$${Number(n || 0).toLocaleString()}`;
                        const items = Array.isArray(servicesList) ? servicesList : [];
                        let rows = [];
                        let subtotal = 0;
                        items.forEach(s => {
                            const name = (typeof getServiceName === 'function' ? getServiceName(s) : (s.ServiceName||s.Name||s.Title||'Service'));
                            const amt = Number(s.budget ?? s.Budget ?? s.Price ?? s.BasePrice ?? s.FixedPrice ?? 0);
                            if (amt > 0) {
                                subtotal += amt;
                                rows.push(`<div style=\"display:flex;justify-content:space-between;padding:4px 0;\"><span>${name}</span><strong>${money(amt)}</strong></div>`);
                            }
                        });
                        const totalBudget = Number(request.Budget || 0);
                        const hasServiceAmounts = subtotal > 0 && rows.length > 0;
                        if (hasServiceAmounts || totalBudget > 0) {
                            const total = hasServiceAmounts ? subtotal : totalBudget;
                            const totalRow = `<div style=\"display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed var(--border);margin-top:6px;\"><span>Total</span><strong>${money(total)}</strong></div>`;
                            const budgetNote = (totalBudget > 0 && hasServiceAmounts && totalBudget !== subtotal)
                                ? `<div style=\"margin-top:6px;color:#6b7280;font-size:12px;\">Budget provided: ${money(totalBudget)}</div>`
                                : '';
                            const box = `<div class=\"price-breakdown\" style=\"border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.04);\">`
                                + `\n                                <div style=\"font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:8px;\"><i class=\"fas fa-receipt\" style=\"color:#6b7280;\"></i><span>Price breakdown</span></div>`
                                + `\n                                ${rows.join('')}`
                                + `\n                                ${totalRow}`
                                + `\n                                ${budgetNote}`
                                + `\n                            </div>`;
                            detailsRows.push(`<div class=\"request-detail-row\" style=\"grid-column: span 2;\">${box}</div>`);
                        }
                    } catch(_) {}
                    const detailsHtml = detailsRows.join('');

                    return `
                    <div class="booking-item has-details" data-request-id="${request.RequestID}" data-user-id="${request.UserID || ''}">
                        <div class="booking-date-section">
                            <div class="booking-month">${month}</div>
                            <div class="booking-day">${day}</div>
                            <div class="booking-weekday">${weekday}</div>
                        </div>
                        <div class="booking-info">
                            <div class="booking-client" style="gap:6px; margin-bottom: 0;">
                                <span class="booking-client-name" style="font-size:16px; font-weight:700; color:#111827;">${request.ClientName || 'New Client'}</span>
                            </div>
                            ${primaryServiceName ? `<div class="booking-service-row"><span class="booking-service" title="${serviceNames}">${primaryServiceName}</span></div>` : ''}
                            ${request.EventLocation ? `<div class="booking-location-row">
                                <i class="fas fa-map-marker-alt" style="color: #6b7280; font-size: 12px;"></i>
                                <span class="booking-location" title="${request.EventLocation}" style="max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: bottom;">${request.EventLocation}</span>
                            </div>` : ''}
                            ${(eventDateStr && eventDateStr !== '—') ? `<div class="booking-date-row">
                                <i class="fas fa-calendar-alt" style="color: #6b7280; font-size: 12px;"></i>
                                <span class="booking-date">${eventDateStr}</span>
                            </div>` : ''}
                            ${serviceTimeStr ? `<div class="booking-time-row">
                                <i class="fas fa-clock" style="color: #6b7280; font-size: 12px;"></i>
                                <span class="booking-time">${serviceTimeStr}</span>
                            </div>` : ''}
                            ${(serviceCost && serviceCost !== '—') ? `<div class="booking-price-row"><i class="fas fa-dollar-sign" style="color:#6b7280;font-size:12px;"></i><span class="booking-price">${serviceCost}</span></div>` : ''}
                        </div>
                        <div class="booking-actions" style="display:flex; flex-direction:column; align-items:flex-end; gap:12px; padding-right:10px;">
                            <div class="status-col" style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; margin:8px 10px 8px 0; padding:2px 0;">
                                <div class="request-status-badge" style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; font-size:12px; background:${(statusCfg && (statusCfg.bg || '#f3f4f6'))}; color:#111827; border:1px solid ${statusCfg.color};">
                                    <i class="fas ${statusCfg.icon}" style="color:${statusCfg.color};"></i>
                                    <span>${isPending ? pendingResponseText : statusCfg.label}</span>${isPending ? '<span class="dot-new" title="New request"></span>' : ''}
                                </div>
                                ${isPending ? `<div class="request-deadline-note" style="font-size:12px; color:#6b7280; text-align:right;">${hoursRemaining > 0 ? `${hoursRemaining} ${hoursRemaining === 1 ? 'hour' : 'hours'} remaining` : 'Timer expired'}</div>` : ''}
                            </div>
                            ${detailsHtml ? `<button class="link-btn" onclick="openBookingDetails(this)" style="margin-top:2px;">More info</button>` : ''}
                            <div class="actions-row" style="display:flex; align-items:center; gap:6px;">
                                ${(direction === 'inbound' && isPending) ? `<button class="btn-accept" onclick="approveRequest(${request.RequestID})">Accept</button>` : ''}
                                ${(direction === 'inbound' && isPending) ? `<button class="btn-decline" onclick="declineRequest(${request.RequestID})">Decline</button>` : ''}
                                ${request.ConversationID ? `<button class="btn btn-outline" onclick="openChatForRequest(${request.ConversationID})" style="padding: 6px 12px; border-radius: 8px; font-size: 13px;">Chat</button>` : ''}
                            </div>
                        </div>
                        ${detailsHtml ? `<div class=\"request-details collapsed\">${detailsHtml}</div>` : ''}
                    </div>`;
                }).join('');
            }
            
            
            function openChatForRequest(conversationId) {
                // Switch to messages section and load the specific conversation
                document.querySelector('[data-section="messages"]').click();
                // TODO: Load specific conversation
            }
            
            window.toggleVendorDetails = function(btn) {
                try {
                    const item = btn.closest('.booking-item');
                    if (!item) return;
                    const details = item.querySelector('.request-details');
                    if (!details) return;
                    const isCollapsed = details.classList.toggle('collapsed');
                    // Force display to avoid any cascade override edge-cases
                    if (isCollapsed) {
                        details.style.display = 'none';
                    } else {
                        details.style.display = 'grid';
                    }
                    btn.textContent = isCollapsed ? 'More info' : 'Less info';
                } catch (e) {
                    console.error('toggleVendorDetails error:', e);
                }
            }
            
            window.openBookingDetails = function(btn) {
                try {
                    const item = btn.closest('.booking-item');
                    const modal = document.getElementById('booking-details-modal');
                    const content = document.getElementById('booking-details-content');
                    const titleEl = document.getElementById('booking-details-title');
                    if (!modal || !content) return;
                    const info = item ? item.querySelector('.booking-info') : null;
                    const statusWrap = item ? item.querySelector('.status-col') : null;
                    const details = item ? item.querySelector('.request-details') : null;
                    let overviewHtml = '';
                    if (info) {
                        const inf = info.cloneNode(true);
                        const name = inf.querySelector('.booking-client-name') ? inf.querySelector('.booking-client-name').textContent : '';
                        const service = inf.querySelector('.booking-service') ? inf.querySelector('.booking-service').textContent : '';
                        const location = inf.querySelector('.booking-location') ? inf.querySelector('.booking-location').textContent : '';
                        const dateText = inf.querySelector('.booking-date') ? inf.querySelector('.booking-date').textContent : '';
                        const timeText = inf.querySelector('.booking-time') ? inf.querySelector('.booking-time').textContent : '';
                        overviewHtml = `
                          <div style="line-height:1.5;">
                            ${name ? `<div style=\"font-weight:700;font-size:18px;color:#111827;\">${name}</div>` : ''}
                            ${service ? `<div style=\"margin-top:6px;color:#111827;display:flex;align-items:center;gap:8px;\"><i class=\"fas fa-briefcase\" style=\"color:#6b7280;font-size:12px;\"></i><span>${service}</span></div>` : ''}
                            ${location ? `<div style=\"margin-top:6px;color:#6b7280;display:flex;align-items:center;gap:8px;\"><i class=\"fas fa-map-marker-alt\" style=\"font-size:12px;\"></i><span>${location}</span></div>` : ''}
                            ${(dateText || timeText) ? `<div style=\"margin-top:6px;color:#374151;display:flex;align-items:center;gap:8px;\"><i class=\"fas fa-calendar-alt\" style=\"color:#6b7280;font-size:12px;\"></i><span>${dateText}</span></div>` : ''}
                            ${timeText ? `<div style=\"margin-top:4px;color:#374151;display:flex;align-items:center;gap:8px;\"><i class=\"fas fa-clock\" style=\"color:#6b7280;font-size:12px;\"></i><span>${timeText}</span></div>` : ''}
                          </div>`;
                    }
                    let priceBoxHtml = '';
                    let cleanDetailsHtml = '<div style="color:#6b7280;">No additional details.</div>';
                    if (details) {
                        const clone = details.cloneNode(true);
                        const pb = clone.querySelector('.price-breakdown');
                        if (pb) { priceBoxHtml = pb.outerHTML; pb.remove(); }
                        cleanDetailsHtml = clone.innerHTML;
                    }
                    let totalDisplay = '';
                    if (priceBoxHtml) {
                        const m = priceBoxHtml.match(/<span>Total<\\\/span>\s*<strong>(.*?)<\\\/strong>/);
                        if (m && m[1]) totalDisplay = m[1];
                        priceBoxHtml = priceBoxHtml.replace('dashed', 'solid');
                    }
                    let pill = '';
                    const headerStatus = document.getElementById('booking-details-status-slot');
                    if (statusWrap) {
                        const el = statusWrap.querySelector('.request-status-badge') || statusWrap.querySelector('.request-status');
                        pill = el ? el.outerHTML : '';
                    }
                    if (headerStatus) headerStatus.innerHTML = '';
                    content.innerHTML = `
                        <div class="booking-details-header" style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;padding:8px 4px 0;">
                            <div style="flex:1;min-width:0;">${overviewHtml || '<div style=\"color:#6b7280;\">No summary available.</div>'}</div>
                            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                                ${pill || ''}
                                ${totalDisplay ? `<div style=\"display:flex;align-items:center;gap:8px;font-weight:700;color:#111827;\"><i class=\"fas fa-dollar-sign\" style=\"color:#6b7280;font-size:12px;\"></i><span>${totalDisplay}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="request-details" style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">${cleanDetailsHtml}</div>
                        ${priceBoxHtml ? `<div style=\"margin-top:16px;\">${priceBoxHtml.replace('dashed','solid')}</div>` : ''}
                    `;
                    const closeIcon = document.getElementById('booking-details-close');
                    if (closeIcon && !closeIcon._wired) { closeIcon._wired = true; closeIcon.addEventListener('click', () => { modal.style.display = 'none'; }); }
                    const closeBtn = document.getElementById('booking-details-close-btn');
                    if (closeBtn && !closeBtn._wired) { closeBtn._wired = true; closeBtn.addEventListener('click', () => { modal.style.display = 'none'; }); }
                    // No header popover; price breakdown is rendered at bottom
                    // Wire Reply button for vendors
                    const replyBtn = document.getElementById('booking-details-reply-btn');
                    if (replyBtn) {
                        const isVendor = !!(window.currentUser && currentUser.isVendor);
                        const reqId = item?.dataset?.requestId;
                        const clientUserId = item?.dataset?.userId;
                        replyBtn.style.display = (isVendor && reqId) ? 'inline-flex' : 'none';
                        if (!replyBtn._wired) {
                            replyBtn._wired = true;
                            replyBtn.addEventListener('click', async () => {
                                try {
                                    if (!reqId) return;
                                    if (!isVendor) { alert('Only vendors can reply to requests.'); return; }
                                    const vendorProfileId = await getVendorProfileId();
                                    let targetUserId = clientUserId || null;
                                    if (!targetUserId) {
                                        // Try to resolve from details markup if not provided
                                        try { targetUserId = item?.getAttribute('data-user-id') || null; } catch (_) {}
                                    }
                                    if (!targetUserId) { alert('Cannot determine client user for this request.'); return; }
                                    const msg = prompt('Write your reply to the client:');
                                    if (!msg || !msg.trim()) return;
                                    // 1) Check for existing conversation
                                    let convId = null;
                                    try {
                                        const chk = await fetch(`${API_BASE_URL}/messages/conversation/check`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` },
                                            body: JSON.stringify({ userId: Number(targetUserId), vendorProfileId: Number(vendorProfileId) })
                                        });
                                        if (chk.ok) {
                                            const cd = await chk.json();
                                            convId = cd.conversationId || null;
                                        }
                                    } catch(_) {}
                                    // 2) Create if needed (without initialMessage to avoid wrong sender attribution)
                                    if (!convId) {
                                        const create = await fetch(`${API_BASE_URL}/messages/conversation`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` },
                                            body: JSON.stringify({ userId: Number(targetUserId), vendorProfileId: Number(vendorProfileId), requestId: Number(reqId) })
                                        });
                                        if (!create.ok) throw new Error('Failed to start conversation');
                                        const cr = await create.json();
                                        convId = cr?.conversation?.ConversationID || cr?.conversationId || null;
                                        if (!convId) throw new Error('Conversation not created');
                                    }
                                    // 3) Send vendor message
                                    const send = await fetch(`${API_BASE_URL}/messages`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` },
                                        body: JSON.stringify({ conversationId: Number(convId), senderId: Number(currentUser.id), content: msg.trim() })
                                    });
                                    if (!send.ok) throw new Error('Failed to send reply');
                                    if (typeof showSuccess === 'function') { showSuccess('Reply sent to client.'); }
                                    // Optionally open Messages view
                                    if (typeof displayUserDashboard === 'function') {
                                        const mode = (window.currentUser && currentUser.isVendor) ? 'vendor' : 'client';
                                        const section = (mode === 'vendor') ? 'vendor-messages' : 'messages';
                                        displayUserDashboard(mode, section);
                                    }
                                } catch (err) {
                                    console.error('Reply failed:', err);
                                    alert('Failed to send reply. Please try again.');
                                }
                            });
                        }
                    }
                    // Wire Approve/Decline buttons for vendors if available
                    const acceptBtn = document.getElementById('booking-details-accept-btn');
                    const declineBtn = document.getElementById('booking-details-decline-btn');
                    if (acceptBtn && declineBtn) {
                        const isVendor = !!(window.currentUser && currentUser.isVendor);
                        const reqId = item?.dataset?.requestId;
                        const hasCardApprove = !!(item && item.querySelector('.btn-accept'));
                        const showDecision = isVendor && reqId && hasCardApprove;
                        acceptBtn.style.display = showDecision ? 'inline-flex' : 'none';
                        declineBtn.style.display = showDecision ? 'inline-flex' : 'none';
                        if (showDecision) {
                            if (!acceptBtn._wired) {
                                acceptBtn._wired = true;
                                acceptBtn.addEventListener('click', async () => { try { await approveRequest(Number(reqId)); } catch(e) { console.error(e); } });
                            }
                            if (!declineBtn._wired) {
                                declineBtn._wired = true;
                                declineBtn.addEventListener('click', async () => { try { await declineRequest(Number(reqId)); } catch(e) { console.error(e); } });
                            }
                        }
                    }
                    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
                    if (titleEl) titleEl.textContent = 'Event Details';
                    modal.style.display = 'flex';
                } catch (e) {
                    console.error('openBookingDetails error:', e);
                }
            }
            

            // Setup vendor requests status tabs only (direction hidden)
            function setupVendorRequestTabs() {
                // Always default to inbound
                vendorReqFilters.direction = 'inbound';
                const statusTabsWrap = document.getElementById('vendor-request-status-tabs');
                if (!statusTabsWrap) return;

                // Hard-hide any legacy direction tab bars in this section (defensive)
                try {
                    const vendorSection = document.getElementById('vendor-requests-section');
                    const strayTabs = vendorSection ? vendorSection.querySelectorAll('.booking-tabs') : [];
                    strayTabs.forEach(el => { el.style.display = 'none'; });
                } catch (_) {}

                // Prevent duplicate bindings
                if (statusTabsWrap.dataset.bound === '1') {
                    syncVendorRequestTabStates();
                    return;
                }
                statusTabsWrap.dataset.bound = '1';

                const statusTabs = statusTabsWrap.querySelectorAll('.tab-btn');
                statusTabs.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        statusTabs.forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        vendorReqFilters.status = e.currentTarget.dataset.status || 'all';
                        await loadVendorRequests(vendorReqFilters.direction, vendorReqFilters.status);
                    });
                });

                // Ensure initial active states match current filters
                syncVendorRequestTabStates();
            }

            function syncVendorRequestTabStates() {
                try {
                    // Only status tabs are present now
                    const statusTabsWrap = document.getElementById('vendor-request-status-tabs');
                    if (statusTabsWrap) {
                        const statusTabs = statusTabsWrap.querySelectorAll('.tab-btn');
                        statusTabs.forEach(b => b.classList.toggle('active', (b.dataset.status || 'all') === (vendorReqFilters.status || 'all')));
                    }
                } catch (_) {}
            }

            // Generic settings tabs setup for a given container
            function setupSettingsTabs(rootEl, onChange) {
                if (!rootEl) return;
                const btns = rootEl.querySelectorAll('.settings-tabs .tab-btn');
                const panels = rootEl.querySelectorAll('.settings-panels .settings-panel');
                btns.forEach(btn => {
                    if (btn.dataset.bound === '1') return; // prevent duplicate binding
                    btn.dataset.bound = '1';
                    btn.addEventListener('click', async () => {
                        // button active state
                        btns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        // panels active state
                        const targetId = btn.dataset.target;
                        panels.forEach(p => p.classList.remove('active'));
                        const targetPanel = rootEl.querySelector(`#${targetId}`);
                        if (targetPanel) targetPanel.classList.add('active');
                        // callback for lazy loading per tab
                        if (onChange) await onChange(targetId);
                    });
                });
            }

            // Client settings tabs
            function setupClientSettingsTabs() {
                const section = document.getElementById('settings-section');
                setupSettingsTabs(section, null);
            }

            // Vendor business profile tabs with lazy-loading for each panel
            let vendorSettingsLoaded = { location: false, additional: false, social: false, services: false, faqs: false, photos: false, availability: false, stripe: false };
            function setupVendorBusinessProfileTabs(vendorProfileId) {
                const section = document.getElementById('vendor-business-profile-section');
                vendorSettingsLoaded = { location: false, additional: false, social: false, services: false, faqs: false, photos: false, availability: false, stripe: false };
                
                // Initialize panel toggle handlers
                setTimeout(() => {
                    console.log('Calling initBusinessProfilePanels from setupVendorBusinessProfileTabs');
                    initBusinessProfilePanels(vendorProfileId);
                }, 100);
                
                setupSettingsTabs(section, async (targetId) => {
                    if (targetId === 'vendor-location-panel' && !vendorSettingsLoaded.location) {
                        await loadVendorLocation(vendorProfileId);
                        vendorSettingsLoaded.location = true;
                    }
                    if (targetId === 'vendor-additional-details-panel' && !vendorSettingsLoaded.additional) {
                        await loadVendorAdditionalDetails(vendorProfileId);
                        vendorSettingsLoaded.additional = true;
                    }
                    if (targetId === 'vendor-social-panel' && !vendorSettingsLoaded.social) {
                        await loadVendorSocial(vendorProfileId);
                        vendorSettingsLoaded.social = true;
                    }
                    if (targetId === 'vendor-services-panel' && !vendorSettingsLoaded.services) {
                        await loadVendorServicesSettings(vendorProfileId);
                        vendorSettingsLoaded.services = true;
                    }
                    if (targetId === 'vendor-faqs-panel' && !vendorSettingsLoaded.faqs) {
                        await loadVendorFaqs(vendorProfileId);
                        vendorSettingsLoaded.faqs = true;
                    }
                    if (targetId === 'vendor-photos-panel' && !vendorSettingsLoaded.photos) {
                        await loadVendorImages(vendorProfileId);
                        vendorSettingsLoaded.photos = true;
                    }
                    if (targetId === 'vendor-availability-panel' && !vendorSettingsLoaded.availability) {
                        await loadVendorAvailability(vendorProfileId);
                        vendorSettingsLoaded.availability = true;
                    }
                    if (targetId === 'vendor-stripe-panel' && !vendorSettingsLoaded.stripe) {
                        await loadStripeConnectStatus(vendorProfileId);
                        vendorSettingsLoaded.stripe = true;
                    }
                });
            }

            // Panel Toggle Handlers for Business Profile
            function initBusinessProfilePanels(vendorProfileId) {
                const cards = document.querySelectorAll('.settings-card[data-panel]');
                console.log('Found', cards.length, 'cards with data-panel attribute');
                
                cards.forEach(card => {
                    // Remove any existing handlers to avoid duplicates
                    const newCard = card.cloneNode(true);
                    card.parentNode.replaceChild(newCard, card);
                    
                    newCard.addEventListener('click', function() {
                        const panelId = this.getAttribute('data-panel');
                        console.log('Card clicked, panelId:', panelId);
                        const panel = document.getElementById(panelId);
                        console.log('Panel found:', !!panel);
                        
                        if (panel) {
                            // Hide all other panels in the same section
                            const allPanels = document.querySelectorAll('#vendor-business-profile-section [id$="-panel"]');
                            console.log('Found', allPanels.length, 'total panels');
                            allPanels.forEach(p => {
                                if (p.id !== panelId) {
                                    p.style.display = 'none';
                                }
                            });
                            
                            // Navigation-style: hide grid, show only the panel
                            if (panel.style.display === 'none' || !panel.style.display) {
                                // Hide the grid and category title
                                const categoryTitle = document.querySelector('#vendor-business-profile-section .settings-category-title');
                                const grid = document.querySelector('#vendor-business-profile-section .settings-grid');
                                if (categoryTitle) categoryTitle.style.display = 'none';
                                if (grid) grid.style.display = 'none';
                                
                                panel.style.display = 'block';
                                console.log('Panel opened:', panelId);
                                
                                // Load data if needed (reuse existing lazy loading logic)
                                if (panelId === 'vendor-profile-panel' && !vendorSettingsLoaded.profile) {
                                    loadVendorProfileDetails(vendorProfileId);
                                    vendorSettingsLoaded.profile = true;
                                }
                                if (panelId === 'vendor-location-panel' && !vendorSettingsLoaded.location) {
                                    loadVendorLocation(vendorProfileId);
                                    vendorSettingsLoaded.location = true;
                                }
                                if (panelId === 'vendor-additional-details-panel' && !vendorSettingsLoaded.additionalDetails) {
                                    loadVendorQuestionnaire(vendorProfileId);
                                    vendorSettingsLoaded.additionalDetails = true;
                                }
                                if (panelId === 'vendor-services-panel' && !vendorSettingsLoaded.services) {
                                    loadVendorServicesSettings(vendorProfileId);
                                    vendorSettingsLoaded.services = true;
                                }
                                if (panelId === 'vendor-social-panel' && !vendorSettingsLoaded.social) {
                                    loadVendorSocial(vendorProfileId);
                                    vendorSettingsLoaded.social = true;
                                }
                                if (panelId === 'vendor-faqs-panel' && !vendorSettingsLoaded.faqs) {
                                    loadVendorFaqs(vendorProfileId);
                                    vendorSettingsLoaded.faqs = true;
                                }
                                if (panelId === 'vendor-photos-panel' && !vendorSettingsLoaded.photos) {
                                    loadVendorImages(vendorProfileId);
                                    vendorSettingsLoaded.photos = true;
                                }
                                if (panelId === 'vendor-availability-panel' && !vendorSettingsLoaded.availability) {
                                    loadVendorAvailability(vendorProfileId);
                                    vendorSettingsLoaded.availability = true;
                                }
                                if (panelId === 'vendor-stripe-panel' && !vendorSettingsLoaded.stripe) {
                                    loadStripeConnectStatus(vendorProfileId);
                                    vendorSettingsLoaded.stripe = true;
                                }
                            } else {
                                panel.style.display = 'none';
                                console.log('Panel closed:', panelId);
                            }
                        } else {
                            console.error('Panel not found:', panelId);
                        }
                    });
                });
                
                // Back to Menu button handlers
                const backButtons = document.querySelectorAll('.back-to-menu-btn');
                backButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // Hide all panels
                        const allPanels = document.querySelectorAll('#vendor-business-profile-section [id$="-panel"]');
                        allPanels.forEach(p => p.style.display = 'none');
                        
                        // Show the grid and category title
                        const categoryTitle = document.querySelector('#vendor-business-profile-section .settings-category-title');
                        const grid = document.querySelector('#vendor-business-profile-section .settings-grid');
                        if (categoryTitle) categoryTitle.style.display = 'block';
                        if (grid) grid.style.display = 'grid';
                        
                        console.log('Returned to Business Profile menu');
                    });
                });
            }

            // =============================================
            // VENDOR QUESTIONNAIRE FUNCTIONS
            // =============================================
            let vendorQuestionnaireData = null;
            let selectedFeatureIds = new Set();
            let currentVendorProfileId = null; // Store vendorProfileId globally for save operation
            let currentVendorProfileData = null; // Store vendor profile data

            // Helper function to get vendor's selected categories
            function getVendorCategories() {
                const categories = [];
                
                // Try to get from stored profile data (for existing vendors viewing dashboard)
                if (currentVendorProfileData) {
                    if (currentVendorProfileData.Categories) {
                        // Categories is a comma-separated string like "photography,videography"
                        const cats = currentVendorProfileData.Categories.split(',').map(c => c.trim().toLowerCase());
                        categories.push(...cats);
                    }
                }
                
                // Fallback: try to get from form inputs in the Business Profile panel
                const vendorCategorySelect = document.getElementById('vendor-category');
                const vendorAdditionalCategoriesSelect = document.getElementById('vendor-additional-categories');
                
                if (vendorCategorySelect && vendorCategorySelect.value && vendorCategorySelect.value !== 'Loading...') {
                    if (!categories.includes(vendorCategorySelect.value)) {
                        categories.push(vendorCategorySelect.value);
                    }
                }
                
                if (vendorAdditionalCategoriesSelect) {
                    const additionalSelected = Array.from(vendorAdditionalCategoriesSelect.selectedOptions || [])
                        .map(option => option.value)
                        .filter(val => val && val !== 'Loading...');
                    additionalSelected.forEach(cat => {
                        if (cat && !categories.includes(cat)) {
                            categories.push(cat);
                        }
                    });
                }
                
                // Additional fallback: try registration form inputs (during registration)
                const primaryCategorySelect = document.getElementById('primary-category');
                const additionalCategoriesSelect = document.getElementById('additional-categories');
                
                if (primaryCategorySelect && primaryCategorySelect.value) {
                    if (!categories.includes(primaryCategorySelect.value)) {
                        categories.push(primaryCategorySelect.value);
                    }
                }
                
                if (additionalCategoriesSelect) {
                    const additionalSelected = Array.from(additionalCategoriesSelect.selectedOptions || [])
                        .map(option => option.value);
                    additionalSelected.forEach(cat => {
                        if (cat && !categories.includes(cat)) {
                            categories.push(cat);
                        }
                    });
                }
                
                console.log('getVendorCategories result:', categories);
                return categories;
            }

            // Load vendor questionnaire data
            async function loadVendorQuestionnaire(vendorProfileId) {
                try {
                    const container = document.getElementById('vendor-questionnaire-container');
                    const saveBtn = document.getElementById('save-vendor-questionnaire');

                    // Store vendorProfileId globally for save operation
                    currentVendorProfileId = vendorProfileId;

                    // Show loading state
                    container.innerHTML = `
                        <div class="questionnaire-loading">
                            <i class="fas fa-circle-notch"></i>
                            <p>Loading questionnaire...</p>
                        </div>
                    `;

                    // Load vendor profile data to get categories
                    if (vendorProfileId) {
                        try {
                            const profileResponse = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/profile-details`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });
                            if (profileResponse.ok) {
                                currentVendorProfileData = await profileResponse.json();
                                console.log('Loaded vendor profile data:', currentVendorProfileData);
                            }
                        } catch (profileError) {
                            console.warn('Could not load vendor profile data:', profileError);
                        }
                    }

                    // Fetch all features grouped by category
                    const response = await fetch(`${API_BASE_URL}/vendor-features/all-grouped`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) throw new Error('Failed to load questionnaire');

                    const data = await response.json();
                    vendorQuestionnaireData = data.categories || [];

                    // Load vendor's existing selections if vendorProfileId is provided
                    if (vendorProfileId) {
                        const selectionsResponse = await fetch(`${API_BASE_URL}/vendor-features/vendor/${vendorProfileId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (selectionsResponse.ok) {
                            const selectionsData = await selectionsResponse.json();
                            selectedFeatureIds = new Set(
                                selectionsData.selectedFeatures.map(f => f.FeatureID)
                            );
                        }
                    }

                    // Render the questionnaire
                    renderVendorQuestionnaire();
                    saveBtn.style.display = 'block';

                } catch (error) {
                    console.error('Error loading vendor questionnaire:', error);
                    document.getElementById('vendor-questionnaire-container').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <p>Failed to load questionnaire. Please try again.</p>
                        </div>
                    `;
                }
            }

            // Render vendor questionnaire
            function renderVendorQuestionnaire() {
                const container = document.getElementById('vendor-questionnaire-container');
                
                if (!vendorQuestionnaireData || vendorQuestionnaireData.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <p>No questionnaire data available.</p>
                        </div>
                    `;
                    return;
                }

                // Get vendor's selected categories from their profile
                const vendorCategories = getVendorCategories();
                console.log('Vendor categories for filtering:', vendorCategories);
                
                // Filter categories based on applicableVendorCategories
                const filteredCategories = vendorQuestionnaireData.filter(category => {
                    // If no vendor categories loaded yet, show categories marked as 'all' only
                    if (!vendorCategories || vendorCategories.length === 0) {
                        return !category.applicableVendorCategories || category.applicableVendorCategories === 'all';
                    }
                    
                    if (!category.applicableVendorCategories) return true; // Show if no filter specified
                    if (category.applicableVendorCategories === 'all') return true; // Show if applies to all
                    
                    // Check if any of the vendor's categories match the applicable categories
                    const applicableList = category.applicableVendorCategories.split(',').map(c => c.trim().toLowerCase());
                    const hasMatch = vendorCategories.some(vendorCat => applicableList.includes(vendorCat.toLowerCase()));
                    
                    console.log(`Category: ${category.categoryName}, Applicable: ${category.applicableVendorCategories}, Match: ${hasMatch}`);
                    return hasMatch;
                });

                console.log('Filtered categories:', filteredCategories.map(c => c.categoryName));

                if (filteredCategories.length === 0) {
                    const categoriesText = vendorCategories.length > 0 
                        ? `for your selected categories (${vendorCategories.join(', ')})`
                        : 'for your profile';
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-info-circle" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></i>
                            <p>No questionnaire features available ${categoriesText}.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Please make sure you have set your primary category in Business Information.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';

                filteredCategories.forEach(category => {
                    if (!category.features || category.features.length === 0) return;

                    html += `
                        <div class="questionnaire-category">
                            <div class="questionnaire-category-header">
                                <div class="questionnaire-category-icon">
                                    <i class="fas fa-${getCategoryIcon(category.categoryIcon)}"></i>
                                </div>
                                <h3 class="questionnaire-category-title">${category.categoryName}</h3>
                            </div>
                            <div class="questionnaire-features-grid">
                    `;

                    category.features.forEach(feature => {
                        const isSelected = selectedFeatureIds.has(feature.featureID);
                        html += createFeatureTile(feature, isSelected);
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // Attach click handlers to feature tiles
                document.querySelectorAll('.feature-tile').forEach(tile => {
                    tile.addEventListener('click', () => {
                        const featureId = parseInt(tile.dataset.featureId);
                        toggleFeatureSelection(featureId, tile);
                    });
                });
            }

            // Create a feature tile HTML
            function createFeatureTile(feature, isSelected) {
                const selectedClass = isSelected ? 'selected' : '';
                const icon = getFeatureIcon(feature.featureIcon);

                return `
                    <div class="feature-tile ${selectedClass}" data-feature-id="${feature.featureID}">
                        <i class="fas fa-${icon} feature-tile-icon"></i>
                        <span class="feature-tile-name">${feature.featureName}</span>
                        <i class="fas fa-check feature-tile-checkmark"></i>
                    </div>
                `;
            }

            // Toggle feature selection
            function toggleFeatureSelection(featureId, tileElement) {
                if (selectedFeatureIds.has(featureId)) {
                    selectedFeatureIds.delete(featureId);
                    tileElement.classList.remove('selected');
                } else {
                    selectedFeatureIds.add(featureId);
                    tileElement.classList.add('selected');
                }
                
                // Update selection count
                updateSelectionCount();
            }
            
            // Update selection count display
            function updateSelectionCount() {
                const count = selectedFeatureIds.size;
                const countElement = document.getElementById('selection-count');
                if (countElement) {
                    countElement.textContent = `${count} feature${count !== 1 ? 's' : ''} selected`;
                }
                
                // Show/hide save button based on selection
                const saveBtn = document.getElementById('save-vendor-questionnaire');
                if (saveBtn) {
                    saveBtn.style.display = count > 0 ? 'inline-flex' : 'none';
                }
            }

            // Get Font Awesome icon name from Lucide icon name (mapping)
            function getCategoryIcon(iconName) {
                const iconMap = {
                    'building-2': 'building',
                    'camera': 'camera',
                    'music': 'music',
                    'utensils': 'utensils',
                    'flower-2': 'seedling',
                    'party-popper': 'glass-cheers',
                    'car': 'car',
                    'sparkles': 'sparkles',
                    'clipboard-list': 'clipboard-list'
                };
                return iconMap[iconName] || 'check-circle';
            }

            function getFeatureIcon(iconName) {
                const iconMap = {
                    'church': 'church',
                    'chef-hat': 'hat-chef',
                    'accessibility': 'wheelchair',
                    'car-front': 'car',
                    'speaker': 'volume-up',
                    'wifi': 'wifi',
                    'trees': 'tree',
                    'eye': 'eye',
                    'disc': 'circle',
                    'presentation': 'chalkboard',
                    'door-closed': 'door-closed',
                    'bed': 'bed',
                    'plane': 'plane',
                    'users': 'users',
                    'camera-off': 'camera',
                    'zap': 'bolt',
                    'heart': 'heart',
                    'file': 'file',
                    'images': 'images',
                    'printer': 'print',
                    'book-open': 'book-open',
                    'video': 'video',
                    'film': 'film',
                    'radio': 'broadcast-tower',
                    'mic': 'microphone',
                    'volume-2': 'volume-up',
                    'lightbulb': 'lightbulb',
                    'glass-water': 'glass-martini',
                    'list-music': 'list',
                    'guitar': 'guitar',
                    'mic-vocal': 'microphone-alt',
                    'lamp': 'lamp',
                    'cloud': 'cloud',
                    'truck': 'truck',
                    'badge-check': 'check-circle',
                    'leaf': 'leaf',
                    'wheat-off': 'ban',
                    'utensils-crossed': 'utensils',
                    'wine': 'wine-glass',
                    'arrow-right-circle': 'arrow-circle-right',
                    'beer': 'beer',
                    'scroll-text': 'scroll',
                    'cake': 'birthday-cake',
                    'coffee': 'coffee',
                    'flower': 'flower',
                    'hexagon': 'hexagon',
                    'rainbow': 'rainbow',
                    'trending-up': 'arrow-up',
                    'armchair': 'couch',
                    'layers': 'layer-group',
                    'lamp-desk': 'lamp',
                    'wallpaper': 'image',
                    'signpost': 'sign',
                    'flame': 'fire',
                    'circle': 'circle',
                    'drama': 'theater-masks',
                    'wand': 'magic',
                    'flame-kindling': 'fire-alt',
                    'person-standing': 'walking',
                    'baby': 'baby',
                    'gamepad-2': 'gamepad',
                    'bus': 'bus',
                    'bus-front': 'bus',
                    'key-round': 'key',
                    'move': 'arrows-alt',
                    'palette': 'palette',
                    'scissors': 'cut',
                    'spray-can': 'spray-can',
                    'calendar-check': 'calendar-check',
                    'map-pin': 'map-marker-alt',
                    'users-round': 'users',
                    'hand': 'hand-paper',
                    'clipboard-check': 'clipboard-check',
                    'clipboard-list': 'clipboard-list',
                    'calendar-days': 'calendar-alt',
                    'handshake': 'handshake',
                    'dollar-sign': 'dollar-sign',
                    'clock': 'clock'
                };
                return iconMap[iconName] || 'check';
            }

            // Save vendor questionnaire selections
            async function saveVendorQuestionnaire() {
                const saveBtn = document.getElementById('save-vendor-questionnaire');
                const originalBtnText = saveBtn.innerHTML;
                
                try {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';

                    // Get vendor profile ID from stored global variable
                    const vendorProfileId = currentVendorProfileId;
                    if (!vendorProfileId) {
                        throw new Error('Vendor profile ID not found. Please reload the page.');
                    }

                    const response = await fetch(`${API_BASE_URL}/vendor-features/vendor/${vendorProfileId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            featureIds: Array.from(selectedFeatureIds)
                        })
                    });

                    if (!response.ok) throw new Error('Failed to save selections');

                    const result = await response.json();

                    // Show success message
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => {
                        saveBtn.innerHTML = originalBtnText;
                        saveBtn.disabled = false;
                    }, 2000);

                    console.log('Questionnaire saved successfully:', result);

                } catch (error) {
                    console.error('Error saving questionnaire:', error);
                    alert('Failed to save selections. ' + error.message);
                    saveBtn.innerHTML = originalBtnText;
                    saveBtn.disabled = false;
                }
            }

            // Initialize on DOMContentLoaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    initBusinessProfilePanels();
                    // Attach save button handler after DOM is loaded
                    document.getElementById('save-vendor-questionnaire')?.addEventListener('click', saveVendorQuestionnaire);
                });
            } else {
                // DOM is already loaded, run immediately
                initBusinessProfilePanels();
                // Attach save button handler
                document.getElementById('save-vendor-questionnaire')?.addEventListener('click', saveVendorQuestionnaire);
            }

            // Backward compatibility for legacy calls
            function displayVendorDashboard(section) {
                return displayUserDashboard('vendor', section || 'vendor-dashboard');
            }

            // Unified function to display either client or vendor dashboard
            async function displayUserDashboard(mode, section) {
                const targetVendorMode = (mode === 'vendor');

                // Warn on unsaved changes when switching modes
                if (currentDashboardMode !== targetVendorMode && window.dashboardUnsavedWarning) {
                    const proceed = confirm('You have unsaved changes in Settings. Switch modes and discard them?');
                    if (!proceed) return;
                    window.dashboardUnsavedWarning = false;
                }

                // Warn on unsaved changes when leaving Settings within the same mode
                if (currentDashboardMode === targetVendorMode && window.dashboardUnsavedWarning) {
                    const prevSection = targetVendorMode ? (activeVendorSection || 'vendor-dashboard') : (activeClientSection || 'dashboard');
                    const settingsKey = targetVendorMode ? 'vendor-settings' : 'settings';
                    const leavingSettings = (prevSection === settingsKey) && (section !== settingsKey);
                    if (leavingSettings) {
                        const proceed = confirm('You have unsaved changes in Settings. Leave this section and discard them?');
                        if (!proceed) return;
                        window.dashboardUnsavedWarning = false;
                    }
                }

                // If switching to vendor mode, ensure vendor status is ready
                if (targetVendorMode && currentUser && !currentUser.isVendor) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        });
                        const data = await response.json();
                        if (data.isVendor && data.isProfileComplete) {
                            currentUser.isVendor = true;
                        } else {
                            initializeVendorSetup(currentUser.id);
                            return;
                        }
                    } catch (err) {
                        console.error('Error checking vendor status:', err);
                        alert('Unable to switch to Vendor mode right now. Please try again.');
                        return;
                    }
                }

                // Update global state and resolve section per mode
                isVendorMode = targetVendorMode;
                // Derive allowed sections from DOM (unified container)
                const allSections = Array.from(document.querySelectorAll('#dashboard-container main > div[id$="-section"]'))
                    .map(el => el.id.replace('-section', ''));
                const allowed = new Set(allSections.filter(id => isVendorMode ? id.startsWith('vendor-') : !id.startsWith('vendor-')));
                const defaultSection = isVendorMode ? 'vendor-dashboard' : 'dashboard';
                if (!section || !allowed.has(section)) {
                    section = isVendorMode ? (activeVendorSection || defaultSection) : (activeClientSection || defaultSection);
                    if (!allowed.has(section)) section = defaultSection;
                }
                activeDashboardSection = section;
                localStorage.setItem('isVendorMode', isVendorMode);
                localStorage.setItem('activeDashboardSection', activeDashboardSection);
                persistActiveSection(isVendorMode ? 'vendor' : 'client', section);

                // Show the dashboard modal
                const dashboardModal = document.getElementById('dashboard-modal');
                dashboardModal.style.display = 'flex';
                try { if (typeof clearModalError === 'function') clearModalError(dashboardModal); } catch {}
                document.body.style.overflow = 'hidden';

                // Ensure unified dashboard container is visible
                clientDashboardContainer.style.display = 'grid';

                // Sync segmented toggle in header
                const toggleClient = document.getElementById('mode-toggle-client');
                const toggleVendor = document.getElementById('mode-toggle-vendor');
                if (toggleClient && toggleVendor) {
                    toggleClient.setAttribute('aria-pressed', (!isVendorMode).toString());
                    toggleVendor.setAttribute('aria-pressed', (isVendorMode).toString());
                    toggleClient.style.background = isVendorMode ? 'transparent' : '#ffffff';
                    toggleVendor.style.background = isVendorMode ? '#ffffff' : 'transparent';
                }

                // Get the menu and content sections from unified container
                const currentDashboardMenu = clientDashboardContainer.querySelector('.dashboard-menu');
                const currentDashboardContentSections = document.querySelectorAll('#dashboard-container main > div[id$="-section"]');

                // Hide all sections in the active dashboard first
                currentDashboardContentSections.forEach(sec => {
                    sec.style.display = 'none';
                });

                // Show the selected section
                const targetSectionElement = document.getElementById(section + '-section');
                if (targetSectionElement) {
                    targetSectionElement.style.display = 'block';
                    // Update dashboard title
                    const dashboardTitleElement = document.getElementById('dashboard-modal-title');
                    // Prefer the sidebar menu text for the active section; fallback to normalized section key
                    const activeLink = currentDashboardMenu?.querySelector(`a[data-section="${section}"]`);
                    let titleText = activeLink ? activeLink.textContent.trim() : '';
                    if (!titleText) {
                        const normalized = section.replace(/^vendor-/, '').replace(/-/g, ' ');
                        titleText = normalized.charAt(0).toUpperCase() + normalized.slice(1);
                    }
                    if (dashboardTitleElement) {
                        dashboardTitleElement.textContent = isVendorMode ? `Vendor Dashboard - ${titleText}` : `Dashboard - ${titleText}`;
                    }
                    // Also update the main header title inside the content area
                    const mainTitleEl = document.getElementById(isVendorMode ? 'vendor-dashboard-title' : 'dashboard-title');
                    if (mainTitleEl) mainTitleEl.textContent = titleText;
                } else {
                    // Fallback for the main dashboard view
                    const mainDashboardSection = document.getElementById(isVendorMode ? 'vendor-dashboard-section' : 'dashboard-section');
                    if(mainDashboardSection) mainDashboardSection.style.display = 'block';
                    const modalTitleEl = document.getElementById('dashboard-modal-title');
                    if (modalTitleEl) modalTitleEl.textContent = isVendorMode ? 'Vendor Dashboard - Dashboard' : 'Dashboard';
                    const mainTitleEl = document.getElementById(isVendorMode ? 'vendor-dashboard-title' : 'dashboard-title');
                    if (mainTitleEl) mainTitleEl.textContent = 'Dashboard';
                }

                // Update active class on menu items
                currentDashboardMenu.querySelectorAll('a').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.section === section) {
                        link.classList.add('active');
                    }
                });

                // Load specific data for sections
                if (currentUser) {
                    if (mode === 'client') {
                        await loadClientDashboardData(section);
                    } else {
                        await loadVendorDashboardData(section);
                    }
                } else {
                    // Handle not logged in scenario for dashboard views
                    alert('Please log in to view the dashboard.');
                    dashboardModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    showLoginView();
                    profileModal.style.display = 'flex';
                }

                // Update current displayed mode tracker
                currentDashboardMode = isVendorMode;
            }
            try { window.displayUserDashboard = displayUserDashboard; window.displayVendorDashboard = displayVendorDashboard; } catch (e) {}

            // Client Dashboard Data Loading
            async function loadClientDashboardData(section) {
                if (!currentUser || !currentUser.id) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/dashboard`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch client dashboard data');
                    const dashboardData = await response.json();

                    // Update notifications badge
                    document.getElementById('dashboard-notifications-badge').textContent = dashboardData.unreadNotifications || 0;

                    if (section === 'dashboard') {
                        // Ensure top KPI container exists and render client KPIs similar to vendor look
                        ensureClientOverviewContainers();

                        // Derive KPI counts
                        const upcomingCount = Array.isArray(dashboardData.upcomingBookings) ? dashboardData.upcomingBookings.length : 0;
                        const unreadMsgs = dashboardData.unreadMessages || 0;

                        // Fetch favorites count
                        let favoritesCount = 0;
                        try {
                            const favResp = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                            });
                            if (favResp.ok) {
                                const favs = await favResp.json();
                                favoritesCount = Array.isArray(favs) ? favs.length : (favs?.length || 0);
                            }
                        } catch (_) {}

                        // Fetch pending requests count
                        let pendingRequests = 0;
                        try {
                            const reqResp = await fetch(`${API_BASE_URL}/bookings/requests/${currentUser.id}`, {
                                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                            });
                            if (reqResp.ok) {
                                const reqData = await reqResp.json();
                                const reqs = reqData.requests || [];
                                pendingRequests = reqs.filter(r => (r.Status || r.status) === 'pending').length;
                            }
                        } catch (_) {}

                        renderClientStats({
                            upcoming: upcomingCount,
                            favorites: favoritesCount,
                            pendingRequests: pendingRequests,
                            unreadMessages: unreadMsgs
                        });

                        // Render existing dashboard cards
                        renderUpcomingBookings(dashboardData.upcomingBookings);
                        // Load recent messages preview for client
                        if (document.getElementById('client-recent-messages')) {
                            await loadClientRecentMessagesPreview();
                            const openBtnClient = document.getElementById('open-all-messages-btn-client');
                            if (openBtnClient) {
                                openBtnClient.addEventListener('click', () => {
                                    try { displayUserDashboard('client', 'messages'); } catch(_) {}
                                });
                            }
                        }
                    } else if (section === 'bookings') {
                        await loadAllUserBookings();
                        setupBookingTabs();
                    } else if (section === 'invoices') {
                        await loadClientInvoices();
                    } else if (section === 'favorites') {
                        await loadUserFavoritesDashboard();
                    } else if (section === 'messages') {
                        await loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                    } else if (section === 'reviews') {
                        await loadUserReviews();
                    } else if (section === 'settings') {
                        // Load client settings cards - no additional data needed
                        // Settings are now managed via modal cards instead of tabs
                    }
                } catch (error) {
                    console.error('Error loading client dashboard:', error);
                    alert('Failed to load dashboard data: ' + error.message);
                }
            }

            async function loadAllUserBookings() {
                const section = document.getElementById('bookings-section');
                if (!section || !currentUser || !currentUser.id) return;

                const allList = section.querySelector('#all-bookings-list');
                const pendingList = section.querySelector('#pending-bookings-list');
                const acceptedList = section.querySelector('#completed-bookings');
                const declinedList = section.querySelector('#declined-bookings-list');
                const expiredList = section.querySelector('#expired-bookings-list');

                if (allList) allList.innerHTML = '<p>Loading...</p>';
                if (pendingList) pendingList.innerHTML = '<p>Loading...</p>';
                if (acceptedList) acceptedList.innerHTML = '<p>Loading...</p>';
                if (declinedList) declinedList.innerHTML = '<p>Loading...</p>';
                if (expiredList) expiredList.innerHTML = '<p>Loading...</p>';

                try {
                    const resp = await fetch(`${API_BASE_URL}/users/${currentUser.id}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error('Failed to fetch bookings');
                    const data = await resp.json();
                    const bookings = Array.isArray(data) ? data : [];

                    const normalized = bookings.map(b => ({ ...b, _status: ((b.Status || '').toString().toLowerCase()) }));
                    const acceptedStatuses = new Set(['accepted', 'approved', 'confirmed', 'paid']);
                    const pending = normalized.filter(b => b._status === 'pending');
                    const accepted = normalized.filter(b => acceptedStatuses.has(b._status));
                    const declined = normalized.filter(b => b._status === 'declined');
                    const expired = normalized.filter(b => b._status === 'expired');

                    const byDateAsc = (a, b) => new Date(a.EventDate) - new Date(b.EventDate);
                    normalized.sort(byDateAsc);
                    pending.sort(byDateAsc);
                    accepted.sort(byDateAsc);
                    declined.sort(byDateAsc);
                    expired.sort(byDateAsc);

                    const allCountEl = section.querySelector('#all-bookings .booking-count');
                    const pendingCountEl = section.querySelector('#pending-bookings .booking-count');
                    const acceptedCountEl = section.querySelector('#accepted-bookings .booking-count');
                    const declinedCountEl = section.querySelector('#declined-bookings .booking-count');
                    const expiredCountEl = section.querySelector('#expired-bookings .booking-count');
                    if (allCountEl) allCountEl.textContent = `${normalized.length} items`;
                    if (pendingCountEl) pendingCountEl.textContent = `${pending.length} requests`;
                    if (acceptedCountEl) acceptedCountEl.textContent = `${accepted.length} items`;
                    if (declinedCountEl) declinedCountEl.textContent = `${declined.length} items`;
                    if (expiredCountEl) expiredCountEl.textContent = `${expired.length} items`;

                    renderClientBookingsList(normalized, allList);
                    renderClientBookingsList(pending, pendingList);
                    renderClientBookingsList(accepted, acceptedList);
                    renderClientBookingsList(declined, declinedList);
                    renderClientBookingsList(expired, expiredList);
                } catch (e) {
                    if (allList) allList.innerHTML = `<p style="color:var(--accent);">${e.message || 'Failed to load bookings'}</p>`;
                    if (pendingList) pendingList.innerHTML = '<p>No pending items.</p>';
                    if (acceptedList) acceptedList.innerHTML = '<p>No accepted items.</p>';
                    if (declinedList) declinedList.innerHTML = '<p>No declined items.</p>';
                    if (expiredList) expiredList.innerHTML = '<p>No expired items.</p>';
                    throw e;
                }
            }

            function renderClientBookingsList(items, container) {
                if (!container) return;
                container.innerHTML = '';
                if (!Array.isArray(items) || items.length === 0) {
                    container.innerHTML = '<div class="empty-state">No items.</div>';
                    return;
                }
                const html = items.map(booking => {
                    const isPaid = booking.FullAmountPaid === true || booking.FullAmountPaid === 1 || booking._status === 'paid';
                    const isDepositOnly = !isPaid && (booking.DepositPaid === true || booking.DepositPaid === 1);
                    const eventDate = booking.EventDate ? new Date(booking.EventDate) : null;
                    let month = '', day = '', weekday = '', timeStr = '';
                    if (eventDate) {
                        month = eventDate.toLocaleDateString('en-US', { month: 'short' });
                        day = eventDate.getDate();
                        weekday = eventDate.toLocaleDateString('en-US', { weekday: 'short' });
                        const startTime = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        const endTime = new Date(eventDate.getTime() + 90 * 60000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        timeStr = `${startTime} - ${endTime}`;
                    }

                    // Build details rows - matching vendor dashboard
                    const detailsRows = [];
                    const pushRow = (label, value, full = false) => {
                        if (value && value !== '—' && value !== null && value !== undefined && value !== '') {
                            detailsRows.push(`<div class="request-detail-row" ${full ? 'style="grid-column: span 2;"' : ''}><span class="request-detail-label">${label}</span><span class="request-detail-value">${value}</span></div>`);
                        }
                    };

                    // Add detail rows in same order as vendor dashboard
                    if (booking.EventName) pushRow('Event Name', booking.EventName);
                    if (booking.EventType) pushRow('Event', booking.EventType);
                    if (booking.TimeZone) pushRow('Time Zone', booking.TimeZone);
                    if (booking.AttendeeCount) pushRow('Attendees', booking.AttendeeCount);
                    
                    // Service start/end times if available
                    if (booking.ServiceStartTime && booking.ServiceEndTime) {
                        const serviceTimeRange = `${booking.ServiceStartTime} – ${booking.ServiceEndTime}`;
                        pushRow('Service Time', serviceTimeRange);
                    }
                    
                    if (booking.SpecialRequests) pushRow('Special Requests', booking.SpecialRequests, true);
                    
                    // Respond By (expiry date) if available
                    if (booking.ExpiresAt || booking.RespondBy) {
                        const expiresStr = new Date(booking.ExpiresAt || booking.RespondBy).toLocaleString();
                        pushRow('Respond By', expiresStr);
                    }
                    
                    // Requested On (creation date)
                    if (booking.CreatedAt || booking.Created) {
                        pushRow('Requested On', new Date(booking.CreatedAt || booking.Created).toLocaleString());
                    }
                    
                    // Price breakdown matching vendor dashboard format
                    try {
                        const money = (n) => `$${Number(n || 0).toLocaleString()}`;
                        const items = booking.Services && Array.isArray(booking.Services) ? booking.Services : [];
                        let rows = [];
                        let subtotal = 0;
                        
                        items.forEach(svc => {
                            const svcName = svc.ServiceName || svc.Name || svc.Title || 'Service';
                            const amt = Number(svc.Price || svc.Budget || svc.BasePrice || svc.FixedPrice || 0);
                            if (amt > 0) {
                                subtotal += amt;
                                rows.push(`<div style="display:flex;justify-content:space-between;padding:4px 0;"><span>${svcName}</span><strong>${money(amt)}</strong></div>`);
                            }
                        });
                        
                        const totalBudget = Number(booking.TotalAmount || booking.Budget || 0);
                        const hasServiceAmounts = subtotal > 0 && rows.length > 0;
                        
                        if (hasServiceAmounts || totalBudget > 0) {
                            const total = hasServiceAmounts ? subtotal : totalBudget;
                            const totalRow = `<div style="display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed var(--border);margin-top:6px;"><span>Total</span><strong>${money(total)}</strong></div>`;
                            const budgetNote = (totalBudget > 0 && hasServiceAmounts && totalBudget !== subtotal)
                                ? `<div style="margin-top:6px;color:#6b7280;font-size:12px;">Budget provided: ${money(totalBudget)}</div>`
                                : '';
                            const box = `<div class="price-breakdown" style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.04);">`
                                + `\n                                <div style="font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:8px;"><i class="fas fa-receipt" style="color:#6b7280;"></i><span>Price breakdown</span></div>`
                                + `\n                                ${rows.join('')}`
                                + `\n                                ${totalRow}`
                                + `\n                                ${budgetNote}`
                                + `\n                            </div>`;
                            detailsRows.push(`<div class="request-detail-row" style="grid-column: span 2;">${box}</div>`);
                        }
                    } catch(_) {}
                    
                    const detailsHtml = detailsRows.join('');
                    const moreInfoBtn = detailsHtml ? `<button class="link-btn" onclick="openBookingDetails(this)" style="margin-top:2px;">More info</button>` : '';

                    // Status badge configuration
                    const s = (booking._status || '').toString().toLowerCase();
                    const bookingStatusMap = {
                        pending:  { icon: 'fa-clock',        color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.12)', label: 'Pending' },
                        confirmed:{ icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Confirmed' },
                        accepted: { icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Accepted' },
                        approved: { icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Accepted' },
                        paid:     { icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Paid' },
                        cancelled:{ icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Cancelled' },
                        declined: { icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Declined' }
                    };
                    const status = isPaid ? 'paid' : s;
                    const statusCfg = bookingStatusMap[status] || bookingStatusMap.pending;
                    const statusBadgeHtml = `<div class="request-status-badge" style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;background:${statusCfg.bg};color:#111827;border:1px solid ${statusCfg.color};"><i class="fas ${statusCfg.icon}" style="color:${statusCfg.color};"></i><span>${statusCfg.label}</span></div>`;

                    // Action buttons
                    let actionButtons = '';
                    if (s === 'confirmed' || s === 'accepted' || s === 'approved') {
                        if (isDepositOnly) {
                            actionButtons = `<button class="btn-pay-now" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount || 0}, ${booking.VendorProfileID})">Pay Balance</button>`;
                        } else if (!isPaid) {
                            actionButtons = `<button class="btn-pay-now" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount || 0}, ${booking.VendorProfileID})">Pay Now</button>`;
                        }
                    }
                    // Add Chat and Invoice buttons for confirmed/paid bookings
                    if (s === 'confirmed' || s === 'accepted' || s === 'approved' || isPaid) {
                        if (booking.ConversationID) {
                            actionButtons += `<button class="btn btn-outline" onclick="openChatForRequest(${booking.ConversationID})" style="padding: 6px 12px; border-radius: 8px; font-size: 13px;">Chat</button>`;
                        }
                        actionButtons += `<button class="btn btn-outline" onclick="openInvoiceModal('${booking.BookingID}')" style="padding: 6px 12px; border-radius: 8px; font-size: 13px;">Invoice</button>`;
                    }

                    return `
                        <div class="booking-item has-details">
                            <div class="booking-date-section">
                                <div class="booking-month">${month || ''}</div>
                                <div class="booking-day">${day || ''}</div>
                                <div class="booking-weekday">${weekday || ''}</div>
                            </div>
                            <div class="booking-info">
                                <div class="booking-client" style="gap:6px; margin-bottom: 0;">
                                    <span class="booking-client-name" style="font-size:16px; font-weight:700; color:#111827;">${booking.VendorName || 'Vendor'}</span>
                                </div>
                                <div class="booking-service-row"><span class="booking-service">${booking.ServiceName || 'Booking'}</span></div>
                                ${booking.Location ? `<div class="booking-location-row">
                                    <i class="fas fa-map-marker-alt" style="color:#6b7280;font-size:12px;"></i>
                                    <span class="booking-location" title="${booking.Location}" style="max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: bottom;">${booking.Location}</span>
                                </div>` : ''}
                                ${eventDate ? `<div class="booking-date-row">
                                    <i class="fas fa-calendar-alt" style="color:#6b7280;font-size:12px;"></i>
                                    <span class="booking-date">${eventDate.toLocaleDateString()}</span>
                                </div>` : ''}
                                ${timeStr ? `<div class="booking-time-row">
                                    <i class="fas fa-clock" style="color:#6b7280;font-size:12px;"></i>
                                    <span class="booking-time">${timeStr}</span>
                                </div>` : ''}
                                ${booking.TotalAmount ? `<div class="booking-price-row">
                                    <i class="fas fa-dollar-sign" style="color:#6b7280;font-size:12px;"></i>
                                    <span class="booking-price">$${Number(booking.TotalAmount).toLocaleString()}</span>
                                </div>` : ''}
                            </div>
                            <div class="booking-actions" style="display:flex; flex-direction:column; align-items:flex-end; gap:12px; padding-right:10px;">
                                <div class="status-col" style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; margin:8px 10px 8px 0; padding:2px 0;">
                                    ${statusBadgeHtml}
                                </div>
                                ${moreInfoBtn}
                                <div class="actions-row" style="display:flex; align-items:center; gap:6px;">
                                    ${actionButtons}
                                </div>
                            </div>
                            ${detailsHtml ? `<div class="request-details collapsed">${detailsHtml}</div>` : ''}
                        </div>
                    `;
                }).join('');
                container.innerHTML = html;
            }

            function setupBookingTabs() {
                const section = document.getElementById('bookings-section');
                if (!section) return;
                const buttons = section.querySelectorAll('.booking-tab');
                const contents = section.querySelectorAll('.booking-tab-content');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        buttons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        contents.forEach(c => c.classList.remove('active'));
                        const target = btn.getAttribute('data-tab');
                        const panel = section.querySelector(`#${target}-bookings`);
                        if (panel) panel.classList.add('active');
                    });
                });
            }

            // Ensure client overview containers (KPI grid at the top of dashboard)
            function ensureClientOverviewContainers() {
                const section = document.getElementById('dashboard-section');
                if (!section) return;
                if (!document.getElementById('client-stats')) {
                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'vendor-stats';
                    statsDiv.id = 'client-stats';
                    statsDiv.innerHTML = '<p>Loading your stats...</p>';
                    section.insertBefore(statsDiv, section.firstChild);
                }
            }

            // Render client KPIs in the same look as vendor
            function renderClientStats(kpis) {
                const container = document.getElementById('client-stats');
                if (!container) return;
                try {
                    container.classList.remove('kpi-grid');
                    container.classList.add('stats-top-grid');
                } catch (_) {}

                const now = new Date();
                const month = now.toLocaleString([], { month: 'long' });
                const day = now.getDate();
                const year = now.getFullYear();

                container.innerHTML = `
                    <div class="kpi-grid two-col">
                        <div class="kpi-card kpi-click" data-target="bookings" data-kpi="upcoming">
                            <div class="kpi-icon bookings"><i class="fas fa-calendar-check"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${kpis.upcoming || 0}</div>
                                <div class="kpi-label">Upcoming Bookings</div>
                            </div>
                        </div>
                        <div class="kpi-card kpi-click" data-target="bookings" data-kpi="pending">
                            <div class="kpi-icon requests"><i class="fas fa-paper-plane"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${kpis.pendingRequests || 0}</div>
                                <div class="kpi-label">Pending Requests</div>
                            </div>
                        </div>
                        <div class="kpi-card kpi-click" data-target="favorites" data-kpi="favorites">
                            <div class="kpi-icon favorites"><i class="fas fa-heart"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${kpis.favorites || 0}</div>
                                <div class="kpi-label">Favorites Saved</div>
                            </div>
                        </div>
                        <div class="kpi-card kpi-click" data-target="messages" data-kpi="messages">
                            <div class="kpi-icon messages"><i class="fas fa-envelope"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${kpis.unreadMessages || 0}</div>
                                <div class="kpi-label">Unread Messages</div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-card calendar-tile full-height" id="client-mini-calendar">
                        <div class="cal-header">${month} ${year}</div>
                        <div class="cal-body">
                            <div class="cal-day">${now.toLocaleString([], { weekday: 'long' })}</div>
                            <div class="cal-date">${day}</div>
                        </div>
                    </div>
                `;

                try {
                    const go = (section, after) => {
                        try { displayUserDashboard('client', section); } catch(_) {}
                        if (after) {
                            let tries = 0;
                            const i = setInterval(() => {
                                tries++;
                                after();
                                if (tries > 30) clearInterval(i);
                            }, 120);
                            setTimeout(() => clearInterval(i), 4000);
                        }
                    };
                    container.querySelectorAll('.kpi-card.kpi-click').forEach(card => {
                        card.addEventListener('click', () => {
                            const target = card.getAttribute('data-target');
                            const k = card.getAttribute('data-kpi');
                            if (target === 'bookings') {
                                go('bookings', () => {
                                    if (k === 'pending') {
                                        const btn = document.querySelector('#bookings-section .booking-tabs button[data-tab="pending"]');
                                        if (btn) btn.click();
                                    }
                                    if (k === 'upcoming') {
                                        const btn = document.querySelector('#bookings-section .booking-tabs button[data-tab="accepted"]');
                                        if (btn) btn.click();
                                    }
                                });
                            } else if (target) {
                                go(target);
                            }
                        });
                    });
                } catch(_) {}
            }

            // Lightweight recent messages preview for client dashboard overview
            async function loadClientRecentMessagesPreview() {
                const container = document.getElementById('client-recent-messages');
                if (!container || !currentUser) return;
                container.innerHTML = '<p>Loading recent messages...</p>';
                try {
                    const resp = await fetch(`${API_BASE_URL}/messages/conversations/user/${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    let conversations = [];
                    if (resp.ok) {
                        const data = await resp.json();
                        conversations = (data.conversations || []).map(conv => ({
                            id: conv.id || conv.ConversationID,
                            name: conv.OtherPartyName || conv.userName || 'Unknown',
                            last: conv.lastMessageContent || conv.LastMessageContent || '',
                            ts: new Date(conv.lastMessageCreatedAt || conv.LastMessageCreatedAt || conv.createdAt || Date.now())
                        })).sort((a,b) => b.ts - a.ts);
                    } else {
                        const localConversations = JSON.parse(localStorage.getItem('conversations') || '[]');
                        conversations = localConversations
                            .filter(c => c.userId === currentUser.id)
                            .map(c => ({ id: c.id, name: c.OtherPartyName || c.userName || 'Unknown', last: c.lastMessageContent || '', ts: new Date(c.lastMessageCreatedAt || c.createdAt || Date.now()) }))
                            .sort((a,b) => b.ts - a.ts);
                    }
                    renderClientRecentMessages(conversations.slice(0,5));
                } catch (e) {
                    console.warn('loadClientRecentMessagesPreview failed', e);
                    container.innerHTML = '<p style="color:var(--accent);">Failed to load messages.</p>';
                }
            }

            function renderClientRecentMessages(items) {
                const container = document.getElementById('client-recent-messages');
                if (!container) return;
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="empty-state">No recent messages.</div>';
                    return;
                }
                container.innerHTML = '';
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'message-preview-item';
                    const initials = (item.name || 'U').trim().charAt(0).toUpperCase();
                    const timeStr = item.ts ? item.ts.toLocaleString([], { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
                    el.innerHTML = `
                        <div class="preview-avatar">${initials}</div>
                        <div class="preview-content">
                            <div class="preview-name">${item.name}</div>
                            <div class="preview-snippet">${(item.last || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                        </div>
                        <div class="preview-time">${timeStr}</div>
                    `;
                    el.addEventListener('click', () => {
                        try { displayUserDashboard('client', 'messages'); } catch(_) {}
                    });
                    container.appendChild(el);
                });
            }

            function renderUpcomingBookings(bookings) {
                const container = document.getElementById('upcoming-bookings');
                container.innerHTML = '';
                if (bookings && bookings.length > 0) {
                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.className = 'booking-item';
                        // Use the same card layout as Vendor Bookings
                        const isPaid = booking.FullAmountPaid === true || booking.FullAmountPaid === 1;
                        const isDepositOnly = !isPaid && (booking.DepositPaid === true || booking.DepositPaid === 1);
                        const eventDate = new Date(booking.EventDate);
                        const month = eventDate.toLocaleDateString('en-US', { month: 'short' });
                        const day = eventDate.getDate();
                        const weekday = eventDate.toLocaleDateString('en-US', { weekday: 'short' });
                        const startTime = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        const endTime = new Date(eventDate.getTime() + 90 * 60000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        const timeStr = `${startTime} - ${endTime}`;

                        let actionButtons = '';
                        if (booking.Status === 'confirmed') {
                            if (isPaid) {
                                actionButtons = `<button class="btn-paid">✓ Paid</button>`;
                            } else if (isDepositOnly) {
                                actionButtons = `<button class="btn-pay-now" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount}, ${booking.VendorProfileID})">Pay Balance</button>`;
                            } else {
                                actionButtons = `<button class="btn-pay-now" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount}, ${booking.VendorProfileID})">Pay Now</button>`;
                            }
                        } else if ((booking.Status || '').toString().toLowerCase() === 'paid') {
                            actionButtons = `<button class=\"btn-paid\">✓ Paid</button>`;
                        }
                        if (booking.Status === 'confirmed' || (booking.Status || '').toString().toLowerCase() === 'paid') {
                            actionButtons += `<a href=\"#\" class=\"link-btn\" onclick=\"openInvoiceModal('${booking.BookingID}')\" style=\"margin-left: 10px;\">Invoice</a>`;
                        }

                        const status = (booking.Status || '').toString().toLowerCase();
                        const statusText = isPaid ? 'Paid' : (status === 'confirmed' ? 'Accepted' : (status.charAt(0).toUpperCase() + status.slice(1)));

                        bookingItem.innerHTML = `
                            <div class="booking-date-section">
                                <div class="booking-month">${month}</div>
                                <div class="booking-day">${day}</div>
                                <div class="booking-weekday">${weekday}</div>
                            </div>
                            <div class="booking-info">
                                <div class="booking-client"><i class="fas fa-store" style="color:#6b7280;font-size:12px;"></i><span class="booking-client-name">${booking.VendorName || 'Vendor'}</span></div>
                                <div class="booking-service-row"><span class="booking-service">${booking.ServiceName || 'Confirmed Booking'}</span></div>
                                <div class="booking-time-row"><i class="fas fa-clock" style="color:#6b7280;font-size:12px;"></i><span class="booking-time">${timeStr}</span></div>
                                ${booking.TotalAmount ? `<div class=\"booking-price-row\"><i class=\"fas fa-dollar-sign\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-price\">$${Number(booking.TotalAmount).toLocaleString()}</span></div>` : ''}
                                ${booking.Location ? `<div class=\"booking-location-row\"><i class=\"fas fa-map-marker-alt\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-location\">${booking.Location}</span></div>` : ''}
                            </div>
                            <div class="booking-actions">
                                ${actionButtons}
                            </div>
                        `;
                        container.appendChild(bookingItem);
                    });
                } else {
                    container.innerHTML = '<div class="empty-state">No upcoming bookings.</div>';
                }
            }

            function renderRecentFavorites(favorites) {
                const container = document.getElementById('dashboard-favorites');
                container.innerHTML = '';
                // Ensure same grid layout as main vendor grid
                try { container.classList.add('vendor-grid'); } catch {}
                if (favorites && favorites.length > 0) {
                    const cardsHtml = favorites.map(vendor => {
                        const imageUrl = vendor.PortfolioImage || vendor.FeaturedImageURL || vendor.ImageURL || vendor.imageUrl || vendor.image || 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
                        const businessName = vendor.VendorName || vendor.BusinessName || vendor.name || 'Vendor';
                        const isFavorite = true; // favorites list by definition
                        const rawPrice = vendor.startingPrice ?? vendor.MinPriceNumeric ?? vendor.MinPrice ?? vendor.price ?? vendor.Price ?? vendor.minPrice ?? vendor.starting_price ?? vendor.price;
                        let priceDisplay = '';
                        if (rawPrice !== undefined && rawPrice !== null && rawPrice !== '') {
                            if (typeof rawPrice === 'number') priceDisplay = `$${Math.round(rawPrice)}`;
                            else if (typeof rawPrice === 'string') {
                                const trimmed = rawPrice.trim();
                                priceDisplay = trimmed.startsWith('$') ? trimmed : `$${trimmed}`;
                            }
                        }
                        const descText = (vendor.Bio || vendor.bio || vendor.BusinessDescription || vendor.businessDescription || vendor.Description || vendor.description || vendor.About || vendor.about || '').toString();
                        const shortDesc = descText.length > 140 ? `${descText.slice(0, 140)}…` : descText;
                        const ratingRaw = vendor.averageRating ?? vendor.rating ?? '4.5';
                        const ratingValue = (() => { const r = parseFloat(ratingRaw); return isNaN(r) ? 4.5 : r; })();
                        const reviewCount = (() => {
                            if (vendor.totalReviews != null) return vendor.totalReviews;
                            if (vendor.reviewCount != null) return vendor.reviewCount;
                            if (typeof ratingRaw === 'string') { const m = ratingRaw.match(/\((\d+)\)/); if (m) return parseInt(m[1]); }
                            return 0;
                        })();
                        const locCity = vendor.City || vendor.city || '';
                        const locState = vendor.State || vendor.state || '';
                        const locationText = (vendor.location && vendor.location.trim()) || [locCity, locState].filter(Boolean).join(', ');
                        const vendorId = vendor.VendorProfileID || vendor.id;
                        const badges = [];
                        if (vendor.isPremium) badges.push('<span class="vendor-badge premium">Premium</span>');
                        if (vendor.isEcoFriendly) badges.push('<span class="vendor-badge eco">Eco-Friendly</span>');
                        if (vendor.isAwardWinning) badges.push('<span class="vendor-badge award">Award Winner</span>');

                        return `
                            <div class="vendor-card">
                                <div class="vendor-image">
                                    <img src="${imageUrl}" alt="${businessName}" 
                                         style="width:100%;height:100%;object-fit:cover;"
                                         onerror="this.src='https://placehold.co/800x600/e2e8f0/718096?text=No+Image'">
                                    <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${vendorId}"><i class="fas fa-heart"></i></div>
                                    <div class="vendor-badges" style="position: absolute; bottom: 8px; left: 8px; display: flex; gap: 6px;">
                                        ${badges.join('')}
                                    </div>
                                </div>
                                <div class="vendor-details">
                                    <h3 class="vendor-name" style="font-size:1.1rem;">${businessName}</h3>
                                    <div class="vendor-location" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
                                        <span><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${locationText || 'Location unavailable'}</span>
                                        <span style="color:#6b7280;">•</span>
                                        <span style="display:flex;align-items:center;gap:.5rem;">
                                            <span style="color:#f59e0b;font-size:.9rem;">${'★'.repeat(Math.floor(ratingValue))}${'☆'.repeat(5-Math.floor(ratingValue))}</span>
                                            <span style="font-size:.85rem;color:#6b7280;">${ratingValue.toFixed(1)} (${reviewCount})</span>
                                        </span>
                                    </div>
                                    ${shortDesc ? `<div class="vendor-description" style="margin:.5rem 0 0.25rem;color:var(--text-light);font-size:.95rem;line-height:1.4;">${shortDesc}</div>` : ''}
                                    <div class="vendor-footer">
                                        <div class="vendor-price" style="font-weight:600;">${priceDisplay ? `<span>Starting from</span> ${priceDisplay}` : ''}</div>
                                        <div class="vendor-actions">
                                            <button class="btn btn-outline save-btn" data-id="${vendorId}">Save</button>
                                            <button class="btn btn-primary view-btn" data-id="${vendorId}">View</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    container.innerHTML = cardsHtml;
                    // Wire up actions to match main cards
                    try { setupVendorCardEventListeners(); } catch {}
                } else {
                    container.innerHTML = '<p>No saved favorites.</p>';
                }
            }

            async function loadUserFavoritesDashboard() {
                const container = document.getElementById('saved-favorites');
                if (!container) return;
                container.innerHTML = '<p>Loading saved favorites...</p>';
                if (!currentUser || !currentUser.id) {
                    container.innerHTML = '<p>Please log in to view favorites.</p>';
                    return;
                }
                try {
                    const resp = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!resp.ok) throw new Error('Failed to fetch favorites');
                    const favorites = await resp.json();
                    renderSavedFavorites(Array.isArray(favorites) ? favorites : []);
                } catch (e) {
                    console.error('loadUserFavoritesDashboard error:', e);
                    container.innerHTML = `<p style="color:var(--accent);">${e.message || 'Failed to load favorites'}</p>`;
                }
            }

            function renderSavedFavorites(favorites) {
                const container = document.getElementById('saved-favorites');
                if (!container) return;
                container.innerHTML = '';
                // Ensure same grid layout as main vendor grid
                try { container.classList.add('vendor-grid'); } catch {}
                if (favorites && favorites.length > 0) {
                    const cardsHtml = favorites.map(vendor => {
                        const imageUrl = vendor.PortfolioImage || vendor.FeaturedImageURL || vendor.ImageURL || vendor.imageUrl || vendor.image || 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
                        const businessName = vendor.VendorName || vendor.BusinessName || vendor.name || 'Vendor';
                        const isFavorite = true;
                        const rawPrice = vendor.startingPrice ?? vendor.MinPriceNumeric ?? vendor.MinPrice ?? vendor.price ?? vendor.Price ?? vendor.minPrice ?? vendor.starting_price ?? vendor.price;
                        let priceDisplay = '';
                        if (rawPrice !== undefined && rawPrice !== null && rawPrice !== '') {
                            if (typeof rawPrice === 'number') priceDisplay = `$${Math.round(rawPrice)}`;
                            else if (typeof rawPrice === 'string') {
                                const trimmed = rawPrice.trim();
                                priceDisplay = trimmed.startsWith('$') ? trimmed : `$${trimmed}`;
                            }
                        }
                        const descText = (vendor.Bio || vendor.bio || vendor.BusinessDescription || vendor.businessDescription || vendor.Description || vendor.description || vendor.About || vendor.about || '').toString();
                        const shortDesc = descText.length > 140 ? `${descText.slice(0, 140)}…` : descText;
                        const ratingRaw = vendor.averageRating ?? vendor.rating ?? '4.5';
                        const ratingValue = (() => { const r = parseFloat(ratingRaw); return isNaN(r) ? 4.5 : r; })();
                        const reviewCount = (() => {
                            if (vendor.totalReviews != null) return vendor.totalReviews;
                            if (vendor.reviewCount != null) return vendor.reviewCount;
                            if (typeof ratingRaw === 'string') { const m = ratingRaw.match(/\((\d+)\)/); if (m) return parseInt(m[1]); }
                            return 0;
                        })();
                        const locCity = vendor.City || vendor.city || '';
                        const locState = vendor.State || vendor.state || '';
                        const locationText = (vendor.location && vendor.location.trim()) || [locCity, locState].filter(Boolean).join(', ');
                        const vendorId = vendor.VendorProfileID || vendor.id;
                        const badges = [];
                        if (vendor.isPremium) badges.push('<span class="vendor-badge premium">Premium</span>');
                        if (vendor.isEcoFriendly) badges.push('<span class="vendor-badge eco">Eco-Friendly</span>');
                        if (vendor.isAwardWinning) badges.push('<span class="vendor-badge award">Award Winner</span>');

                        return `
                            <div class="vendor-card">
                                <div class="vendor-image">
                                    <img src="${imageUrl}" alt="${businessName}" 
                                         style="width:100%;height:100%;object-fit:cover;"
                                         onerror="this.src='https://placehold.co/800x600/e2e8f0/718096?text=No+Image'">
                                    <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${vendorId}"><i class="fas fa-heart"></i></div>
                                    <div class="vendor-badges" style="position: absolute; bottom: 8px; left: 8px; display: flex; gap: 6px;">
                                        ${badges.join('')}
                                    </div>
                                </div>
                                <div class="vendor-details">
                                    <h3 class="vendor-name" style="font-size:1.1rem;">${businessName}</h3>
                                    <div class="vendor-location" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
                                        <span><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${locationText || 'Location unavailable'}</span>
                                        <span style="color:#6b7280;">•</span>
                                        <span style="display:flex;align-items:center;gap:.5rem;">
                                            <span style="color:#f59e0b;font-size:.9rem;">${'★'.repeat(Math.floor(ratingValue))}${'☆'.repeat(5-Math.floor(ratingValue))}</span>
                                            <span style="font-size:.85rem;color:#6b7280;">${ratingValue.toFixed(1)} (${reviewCount})</span>
                                        </span>
                                    </div>
                                    ${shortDesc ? `<div class="vendor-description" style="margin:.5rem 0 0.25rem;color:var(--text-light);font-size:.95rem;line-height:1.4;">${shortDesc}</div>` : ''}
                                    <div class="vendor-footer">
                                        <div class="vendor-price" style="font-weight:600;">${priceDisplay ? `<span>Starting from</span> ${priceDisplay}` : ''}</div>
                                        <div class="vendor-actions">
                                            <button class="btn btn-outline save-btn" data-id="${vendorId}">Save</button>
                                            <button class="btn btn-primary view-btn" data-id="${vendorId}">View</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    container.innerHTML = cardsHtml;
                    // Wire up actions to match main cards
                    try { setupVendorCardEventListeners(); } catch {}
                } else {
                    container.innerHTML = '<p>No saved favorites.</p>';
                }
            }

            async function loadUserReviews() {
                const container = document.getElementById('user-reviews');
                container.innerHTML = '<p>Loading your reviews...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/reviews`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user reviews');
                    const reviews = await response.json();
                    renderReviewsList(reviews, container);
                } catch (error) {
                    console.error('Error loading user reviews:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load reviews: ${error.message}</p>`;
                }
            }

            function renderReviewsList(reviews, container) {
                container.innerHTML = '';
                if (reviews && reviews.length > 0) {
                    reviews.forEach(review => {
                        const reviewCard = document.createElement('div');
                        reviewCard.className = 'review-card';
                        reviewCard.innerHTML = `
                            <div class="review-header">
                                <div class="reviewer">${review.VendorName}</div>
                                <div class="review-date">${new Date(review.CreatedAt).toLocaleDateString()}</div>
                            </div>
                            <div class="review-rating">${'★'.repeat(review.Rating)}${'☆'.repeat(5 - review.Rating)}</div>
                            ${review.Title ? `<div class="review-title">${review.Title}</div>` : ''}
                            <div class="review-text">${review.Comment}</div>
                        `;
                        container.appendChild(reviewCard);
                    });
                } else {
                    container.innerHTML = '<p>No reviews submitted yet.</p>';
                }
            }

            async function loadUserProfileDetails() {
                const nameInput = document.getElementById('profile-name');
                const emailInput = document.getElementById('profile-email');
                const phoneInput = document.getElementById('profile-phone');
                const profileForm = document.getElementById('profile-form');
                const passwordForm = document.getElementById('password-form');

                nameInput.value = 'Loading...';
                emailInput.value = 'Loading...';
                phoneInput.value = 'Loading...';

                try {
                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/profile-details`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user profile details');
                    const profile = await response.json();

                    nameInput.value = profile.Name || '';
                    emailInput.value = profile.Email || '';
                    phoneInput.value = profile.Phone || '';
                } catch (error) {
                    console.error('Error loading user profile details:', error);
                    nameInput.value = 'Error';
                    emailInput.value = 'Error';
                    phoneInput.value = 'Error';
                    alert('Failed to load profile details: ' + error.message);
                }

                profileForm.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/profile-update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                name: nameInput.value,
                                phone: phoneInput.value,
                                bio: currentUser.bio,
                                avatar: currentUser.avatar
                            })
                        });
                        if (!response.ok) throw new Error('Failed to update profile');
                        alert('Profile updated successfully!');
                        await checkAuthStatus();
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        alert('Failed to update profile: ' + error.message);
                    }
                };

                passwordForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    if (newPassword !== confirmPassword) {
                        alert('New password and confirm password do not match.');
                        return;
                    }
                    if (newPassword.length < 8) {
                        alert('New password must be at least 8 characters long.');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/password-update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({ newPassword })
                        });
                        if (!response.ok) throw new Error('Failed to update password');
                        alert('Password updated successfully!');
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-password').value = '';
                        window.dashboardUnsavedWarning = false;
                    } catch (error) {
                        console.error('Error updating password:', error);
                        alert('Failed to update password: ' + error.message);
                    }
                };
            }

            // Vendor Dashboard Data Loading
            // Safe DOM helpers for unified dashboard
            function setHTMLIfExists(id, html) {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = html;
                    return true;
                }
                return false;
            }
            function getEl(id) { return document.getElementById(id); }
            // Ensure vendor overview containers exist (in case DOM was regrouped)
            function ensureVendorOverviewContainers() {
                const section = document.getElementById('vendor-dashboard-section');
                if (!section) return;
                
                // Ensure incomplete setup panel container at the top
                if (!document.getElementById('vendor-incomplete-setup')) {
                    const incDiv = document.createElement('div');
                    incDiv.id = 'vendor-incomplete-setup';
                    section.insertBefore(incDiv, section.firstChild);
                }

                // Ensure stats container
                if (!document.getElementById('vendor-stats')) {
                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'vendor-stats';
                    statsDiv.id = 'vendor-stats';
                    statsDiv.innerHTML = '<p>Loading vendor stats...</p>';
                    section.insertBefore(statsDiv, section.firstChild);
                }

                // Ensure recent bookings card + container
                if (!document.getElementById('vendor-recent-bookings')) {
                    const card = document.createElement('div');
                    card.className = 'dashboard-card';
                    card.innerHTML = `
                        <h2 class="dashboard-card-title">Recent Bookings</h2>
                        <div id="vendor-recent-bookings" class="dashboard-fixed-list"><p class="empty-state">Loading recent bookings...</p></div>
                    `;
                    section.appendChild(card);
                }
            }
            async function loadVendorDashboardData(section) {
                if (!currentUser || !currentUser.id) return;

                // First, get the VendorProfileID for the current user
                let vendorProfileId = null;
                try {
                    const statusResponse = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!statusResponse.ok) throw new Error('Failed to fetch vendor status');
                    const statusData = await statusResponse.json();
                    if (statusData.isVendor && statusData.vendorProfileId) {
                        vendorProfileId = statusData.vendorProfileId;
                    } else {
                        setHTMLIfExists('vendor-dashboard-section', '<p>You are not registered as a vendor or your profile is incomplete. Please register or complete your profile to access the vendor dashboard.</p>');
                        return;
                    }
                } catch (error) {
                    console.error('Error getting vendor profile ID:', error);
                    setHTMLIfExists('vendor-dashboard-section', `<p style="color:var(--accent);">Error: ${error.message}. Could not load vendor dashboard.</p>`);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.id}/dashboard`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor dashboard data');
                    const dashboardData = await response.json();

                    // Update notifications badge
                    const notifBadge = document.getElementById('dashboard-notifications-badge') || document.getElementById('vendor-notifications-badge');
                    if (notifBadge) notifBadge.textContent = dashboardData.unreadNotifications || 0;

                    if (section === 'vendor-dashboard') {
                        ensureVendorOverviewContainers();
                        // Incomplete setup panel
                        if (document.getElementById('vendor-incomplete-setup')) {
                            renderVendorIncompleteSetup(dashboardData.setupStatus, vendorProfileId);
                        }
                        // Render only if containers exist (extra safety across unified DOM)
                        if (document.getElementById('vendor-stats')) {
                            const now = new Date();
                            const upcomingCount = Array.isArray(dashboardData.recentBookings)
                                ? dashboardData.recentBookings.filter(b => {
                                    try {
                                        const d = new Date(b.EventDate);
                                        const s = (b.Status || '').toString().toLowerCase();
                                        return !isNaN(d) && d >= now && (s === 'approved' || s === 'accepted' || s === 'confirmed' || s === 'paid');
                                    } catch { return false; }
                                  }).length
                                : 0;
                            let pendingCount = 0;
                            try {
                                const qs = new URLSearchParams({ direction: 'inbound', status: 'pending' }).toString();
                                const url = `${API_BASE_URL}/bookings/vendor/${vendorProfileId}/requests?${qs}`;
                                const pResp = await fetch(url, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                                if (pResp.ok) {
                                    const j = await pResp.json();
                                    pendingCount = (j.requests || []).length;
                                }
                            } catch(_) {}
                            const avgRating = (() => { const s = dashboardData.stats || {}; const v = s.averageRating ?? s.AvgRating ?? 0; const n = parseFloat(v); return isNaN(n) ? 0 : n; })();
                            const unreadMsgs = dashboardData.unreadMessages || 0;
                            renderVendorStats({ upcoming: upcomingCount, pendingRequests: pendingCount, avgRating: avgRating, unreadMessages: unreadMsgs });
                        }
                        if (document.getElementById('vendor-recent-bookings')) {
                            renderVendorRecentBookings(dashboardData.recentBookings);
                        }
                        // Load recent messages PREVIEW for the vendor dashboard overview
                        if (document.getElementById('vendor-recent-messages')) {
                            await loadVendorRecentMessagesPreview();
                            const openBtn = document.getElementById('open-all-messages-btn');
                            if (openBtn) {
                                openBtn.addEventListener('click', () => {
                                    try { displayUserDashboard('vendor','vendor-messages'); } catch(_) {}
                                });
                            }
                        }
                    } else if (section === 'vendor-requests') {
                        // Initialize vendor request tabs and load with current filters
                        try { setupVendorRequestTabs(); } catch (_) {}
                        await loadVendorRequests(vendorReqFilters.direction, vendorReqFilters.status);
                    } else if (section === 'vendor-invoices') {
                        await loadVendorInvoices(vendorProfileId);
                    } else if (section === 'vendor-messages') {
                        await loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                    } else if (section === 'vendor-reviews') {
                        await loadAllVendorReviews(vendorProfileId);
                    } else if (section === 'vendor-analytics') {
                        await loadVendorAnalytics(vendorProfileId);
                    } else if (section === 'vendor-business-profile') {
                        await loadVendorProfileDetails(vendorProfileId);
                        setupVendorBusinessProfileTabs(vendorProfileId);
                    } else if (section === 'vendor-settings') {
                        // Load vendor settings cards - no additional data needed
                    }
                } catch (error) {
                    console.error('Error loading vendor dashboard:', error);
                    alert('Failed to load vendor dashboard data: ' + error.message);
                }
            }

            function renderVendorIncompleteSetup(setupStatus, vendorProfileId) {
                const container = document.getElementById('vendor-incomplete-setup');
                if (!container) return;
                container.innerHTML = '';
                container.style.display = 'block';

                // Respect session dismissal (same behavior as main page banner)
                try {
                    const token = localStorage.getItem('token') || '';
                    const tokenKey = token ? token.slice(-16) : 'no_token';
                    const uid = (window.currentUser && window.currentUser.id) ? window.currentUser.id : 'unknown';
                    const sessKey = `vv_hideSetupReminderThisSession_${uid}_${tokenKey}`;
                    if (sessionStorage.getItem(sessKey) === '1') {
                        container.style.display = 'none';
                        return;
                    }
                    // Clean legacy session/persistent flags (parity with banner)
                    try {
                        sessionStorage.removeItem('vv_hideSetupReminderThisSession');
                        sessionStorage.removeItem(`vv_hideSetupReminderThisSession_${uid}`);
                    } catch (_) {}
                    try {
                        localStorage.removeItem(`vv_hideSetupReminderUntilComplete_${uid}`);
                        localStorage.removeItem('vv_hideSetupReminderUntil');
                    } catch (_) {}
                } catch (_) {}

                // Consistent list of steps with labels
                const stepLabels = {
                    basics: 'Business Basics',
                    location: 'Location Information',
                    additionalDetails: 'Additional Details',
                    social: 'Social Media',
                    servicesPackages: 'Services & Packages',
                    faq: 'FAQ Section',
                    gallery: 'Gallery & Media',
                    availability: 'Availability & Scheduling',
                    verification: 'Verification & legal',
                    policies: 'Policies',
                    stripe: 'Stripe payouts'
                };
                const requiredOrder = ['basics','location','additionalDetails','social','servicesPackages','faq','gallery','availability','verification','stripe'];

                const steps = setupStatus?.steps || {};
                const labelMap = stepLabels;
                // Hide entire card if all required steps are complete (parity with banner)
                const allComplete = setupStatus?.allRequiredComplete ?? setupStatus?.setupStatus?.allRequiredComplete;
                if (allComplete) {
                    try {
                        const userId = (window.currentUser && window.currentUser.id) ? window.currentUser.id : (typeof getUserIdFromToken === 'function' ? getUserIdFromToken() : null);
                        if (userId) localStorage.removeItem(`vv_hideSetupReminderUntilComplete_${userId}`);
                        sessionStorage.removeItem('vv_hideSetupReminderThisSession');
                        // Also clear potential per-user session keys
                        try {
                            const token = localStorage.getItem('token') || '';
                            const tokenKey = token ? token.slice(-16) : 'no_token';
                            const uid = userId || 'unknown';
                            sessionStorage.removeItem(`vv_hideSetupReminderThisSession_${uid}_${tokenKey}`);
                        } catch (_) {}
                    } catch (_) {}
                    container.style.display = 'none';
                    return;
                }
                const completedKeys = requiredOrder.filter(k => steps[k]);
                const incompleteKeys = requiredOrder.filter(k => !steps[k]);
                const completedCount = completedKeys.length;
                const totalSteps = requiredOrder.length;
                const needsStripe = !steps.stripe;

                const incompleteSteps = setupStatus?.incompleteSteps ?? [];
                const stepsHtml = incompleteSteps.slice(0, 6).map(s => `
                    <span data-step-key="${(s && (s.key || s))}" style="display:inline-flex;align-items:center;gap:6px;background:#ffedd5;color:#7c2d12;border:1px solid #fed7aa;border-radius:999px;padding:4px 10px;font-size:.85rem;white-space:nowrap;cursor:pointer;" title="Open ${(s && (labelMap[s.key] || s.label || s))} settings">
                        <i class=\"fas fa-circle-xmark\"></i>${s.label || s.key}
                    </span>
                `).join(' ');
                const moreCount = Math.max(0, incompleteSteps.length - 6);
                const completedChips = completedKeys.map(k => `
                    <span data-step-key="${k}" style="display:inline-flex;align-items:center;gap:6px;background:#ecfdf5;color:#166534;border:1px solid #bbf7d0;border-radius:999px;padding:4px 10px;font-size:.85rem;white-space:nowrap;cursor:pointer;" title="Open ${labelMap[k] || k} settings">
                        <i class="fas fa-check-circle"></i>${labelMap[k] || k}
                    </span>
                `).join(' ');

                container.innerHTML = `
                    <div class="dashboard-card" style="margin:16px 0; border:1px solid var(--border, #e5e7eb); background:#fff7ed; color:#7c2d12; border-radius:12px; padding:14px 16px; box-shadow:0 1px 2px rgba(0,0,0,0.04);">
                        <div style="display:flex;gap:12px;align-items:flex-start;">
                            <div style="font-size:20px;line-height:1;color:#b45309;"><i class="fas fa-exclamation-circle"></i></div>
                            <div style="flex:1;">
                                <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;align-items:center;">
                                    <div style="font-weight:700;color:#92400e;">Complete your vendor profile to go live</div>
                                    <div style="display:flex;gap:8px;">
                                        <button id="vv-dash-continue" class="btn btn-primary" style="padding:.5rem .9rem;">Continue setup</button>
                                        <button id="vv-dash-dismiss" class="btn btn-outline" style="padding:.5rem .9rem;">Dismiss</button>
                                    </div>
                                </div>
                                <div style="margin-top:8px;">
                                    <div style="font-weight:600;color:#7c2d12;margin-bottom:6px;">Incomplete</div>
                                    <div style="display:flex;flex-wrap:wrap;gap:8px;">${stepsHtml}${moreCount>0?`<span style=\"font-size:.85rem;color:#7c2d12;\">+${moreCount} more</span>`:''}</div>
                                </div>
                                <div style="margin-top:10px;">
                                    <div style="font-weight:600;color:#166534;margin-bottom:6px;">Completed (${completedCount}/${totalSteps})</div>
                                    <div style="display:flex;flex-wrap:wrap;gap:8px;">${completedChips}</div>
                                </div>
                                <div style="margin-top:8px;font-size:.9rem;color:#7c2d12;">Your profile will not be visible to clients until all required steps are complete.</div>
                            </div>
                        </div>
                    </div>
                `;

                // Chip click handlers
                try {
                    const chipEls = container.querySelectorAll('[data-step-key]');
                    chipEls.forEach(el => {
                        el.addEventListener('click', async () => {
                            const key = el.getAttribute('data-step-key');
                            try {
                                if (key === 'stripe' && typeof startStripeOnboarding === 'function') {
                                    await startStripeOnboarding(vendorProfileId);
                                    return;
                                }
                                if (typeof openVendorSettingsStep === 'function') {
                                    await openVendorSettingsStep(key, vendorProfileId);
                                } else if (typeof displayUserDashboard === 'function') {
                                    await displayUserDashboard('vendor', 'vendor-settings');
                                }
                            } catch (err) { console.warn('dashboard chip openVendorSettingsStep failed', err); }
                        });
                    });
                } catch (_) {}

                // Button handlers
                container.querySelector('#vv-dash-continue')?.addEventListener('click', async () => {
                    try {
                        const stepMap = { basics: 1, location: 2, services: 3, servicesPackages: 3, additionalDetails: 4, availability: 5, gallery: 6, social: 7, faq: 8 };
                        const list = Array.isArray(setupStatus?.incompleteSteps) ? setupStatus.incompleteSteps : [];
                        const keys = list.map(s => (s && (s.key || s)));
                        const first = keys.find(k => stepMap[k]);
                        if (!first && keys.length === 1 && keys[0] === 'stripe' && typeof startStripeOnboarding === 'function') {
                            await startStripeOnboarding(vendorProfileId);
                            return;
                        }
                        const uid = (currentUser?.id) || (typeof getUserIdFromToken === 'function' ? getUserIdFromToken() : null);
                        if (typeof initializeVendorSetup === 'function' && uid) {
                            initializeVendorSetup(uid);
                            const target = stepMap[first] || 1;
                            setTimeout(() => {
                                try {
                                    if (typeof showStep === 'function') { showStep(target); }
                                    else if (typeof showSetupStep === 'function') { showSetupStep(target); }
                                } catch (_) {}
                            }, 200);
                            return;
                        }
                        const modal = document.getElementById('vendor-registration-modal');
                        if (modal) {
                            modal.style.display = 'flex';
                            try { document.body.style.overflow = 'hidden'; } catch(_) {}
                            const target = stepMap[first] || 1;
                            try { if (typeof setupVendorSetupEventListeners === 'function') setupVendorSetupEventListeners(); } catch(_) {}
                            setTimeout(() => {
                                try {
                                    if (typeof showStep === 'function') { showStep(target); }
                                    else if (typeof showSetupStep === 'function') { showSetupStep(target); }
                                } catch (_) {}
                            }, 200);
                            return;
                        }
                        if (typeof displayUserDashboard === 'function') {
                            await displayUserDashboard('vendor', 'vendor-settings');
                        }
                    } catch (_) {
                        if (typeof displayUserDashboard === 'function') {
                            await displayUserDashboard('vendor', 'vendor-settings');
                        }
                    }
                });
                container.querySelector('#vv-dash-dismiss')?.addEventListener('click', () => {
                    try {
                        const token = localStorage.getItem('token') || '';
                        const tokenKey = token ? token.slice(-16) : 'no_token';
                        const uid = (window.currentUser && window.currentUser.id) ? window.currentUser.id : 'unknown';
                        const sessKey = `vv_hideSetupReminderThisSession_${uid}_${tokenKey}`;
                        sessionStorage.setItem(sessKey, '1');
                        // Cleanup any legacy persistent/day/session flags
                        localStorage.removeItem(`vv_hideSetupReminderUntilComplete_${uid}`);
                        localStorage.removeItem('vv_hideSetupReminderUntil');
                        sessionStorage.removeItem('vv_hideSetupReminderThisSession');
                        sessionStorage.removeItem(`vv_hideSetupReminderThisSession_${uid}`);
                    } catch (_) {}
                    container.style.display = 'none';
                });
            }

            // Lightweight refresher for the "Complete your setup" card
            async function refreshVendorSetupCard() {
                try {
                    if (!currentUser?.id) return;
                    const res = await fetch(`${API_BASE_URL}/vendor/${currentUser.id}/setup-status`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!res.ok) return; // silent fail
                    const data = await res.json();
                    const vendorPid = currentUser.vendorProfileId || data.vendorProfileId;
                    if (document.getElementById('vendor-incomplete-setup')) {
                        renderVendorIncompleteSetup(data, vendorPid);
                    }
                } catch (e) {
                    console.warn('refreshVendorSetupCard failed', e);
                }
            }

            // Submit for Review: mark setup as completed (server can review and set live)
            async function submitVendorProfileForReview(vendorProfileId) {
                try {
                    const resp = await fetch(`${API_BASE_URL}/vendors/setup/step10-completion`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ vendorProfileId })
                    });
                    if (!resp.ok) {
                        const j = await resp.json().catch(() => ({}));
                        throw new Error(j.message || `HTTP ${resp.status}`);
                    }
                    alert('Submitted for review. We will notify you once your profile is live.');
                    await refreshVendorSetupCard();
                } catch (err) {
                    console.error('Submit for review failed:', err);
                    alert('Failed to submit for review: ' + err.message);
                }
            }

            async function openVendorSettingsStep(stepKey, vendorProfileId) {
                try {
                    // Special handling for Stripe: go straight to onboarding
                    if (stepKey === 'stripe') {
                        await startStripeOnboarding(vendorProfileId);
                        return;
                    }

                    // Open vendor settings section
                    await displayUserDashboard('vendor', 'vendor-settings');

                    // Additionally click the left menu as a robust fallback to switch the section
                    for (let i = 0; i < 30; i++) {
                        const menuLink = document.querySelector('.dashboard-menu a[data-section="vendor-settings"]');
                        if (menuLink) { menuLink.click(); break; }
                        await new Promise(r => setTimeout(r, 100));
                    }

                    // Map setup step keys to settings tab target IDs
                    const targetMap = {
                        basics: 'vendor-profile-panel',
                        location: 'vendor-location-panel',
                        gallery: 'vendor-photos-panel',
                        // Back-compat key
                        services: 'vendor-services-panel',
                        // New key from enhanced checklist
                        servicesPackages: 'vendor-services-panel',
                        social: 'vendor-social-panel',
                        availability: 'vendor-availability-panel',
                        // Policies currently handled via FAQ panel in UI
                        policies: 'vendor-faqs-panel',
                        // New sections
                        additionalDetails: 'vendor-additional-details-panel',
                        faq: 'vendor-faqs-panel',
                        // Verification & Legal removed from Settings
                    };
                    const targetId = targetMap[stepKey] || 'vendor-profile-panel';

                    // Wait for tab buttons to be ready, then activate the matching tab
                    for (let i = 0; i < 30; i++) { // up to ~3s
                        const btn = document.querySelector(`#vendor-settings-section .settings-tabs .tab-btn[data-target='${targetId}']`);
                        if (btn) { btn.click(); break; }
                        await new Promise(r => setTimeout(r, 100));
                    }

                    // If panel didn't activate via click (e.g., listeners not bound yet), do a manual activation fallback
                    let activated = false;
                    for (let i = 0; i < 20; i++) { // ~1s wait for active class
                        const panel = document.querySelector(`#${targetId}.active`);
                        if (panel) { activated = true; break; }
                        await new Promise(r => setTimeout(r, 50));
                    }
                    if (!activated) {
                        manuallyActivateVendorSettingsTab(targetId, vendorProfileId);
                    }

                    // After activating, try to focus the most relevant subsection within that panel
                    const anchorMap = {
                        basics: '#vendor-profile-form',
                        location: '#vendor-location-form',
                        gallery: '#vendor-photos, #upload-photos-btn',
                        services: '#vendor-settings-services-grid, #vendor-settings-services-loading',
                        servicesPackages: '#vendor-settings-services-grid, #vendor-settings-services-loading',
                        social: '#vendor-social-form',
                        availability: '#business-hours-container, #vendor-availability-panel',
                        policies: '#faqs-list, #vendor-faqs-panel',
                        additionalDetails: '#additional-questions-container, #vendor-additional-details-panel',
                        faq: '#faqs-list, #vendor-faqs-panel'
                    };
                    const selectorList = (anchorMap[stepKey] || '').split(',').map(s => s.trim()).filter(Boolean);
                    let anchorEl = null;
                    if (selectorList.length) {
                        for (let i = 0; i < 50 && !anchorEl; i++) { // wait up to ~5s for lazy content
                            for (const sel of selectorList) {
                                const el = document.querySelector(sel);
                                if (el) { anchorEl = el; break; }
                            }
                            if (!anchorEl) await new Promise(r => setTimeout(r, 100));
                        }
                    }
                    if (anchorEl) {
                        anchorEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        try {
                            anchorEl.style.outline = '2px solid var(--primary)';
                            anchorEl.style.transition = 'outline 0.3s ease';
                            setTimeout(() => { anchorEl.style.outline = ''; }, 1500);
                        } catch {}
                    } else {
                        document.getElementById('vendor-settings-section')?.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (e) {
                    console.error('Failed to open vendor settings step:', stepKey, e);
                }
            }
            // Ensure global access for inline handlers
            window.openVendorSettingsStep = openVendorSettingsStep;

            // Fallback: directly activate the desired settings tab and run its lazy-loader if needed
            function manuallyActivateVendorSettingsTab(targetId, vendorProfileId) {
                try {
                    const root = document.getElementById('vendor-settings-section');
                    if (!root) return;
                    const btns = root.querySelectorAll('.settings-tabs .tab-btn');
                    const panels = root.querySelectorAll('.settings-panels .settings-panel');
                    // Toggle active classes
                    btns.forEach(b => b.classList.remove('active'));
                    const targetBtn = root.querySelector(`.settings-tabs .tab-btn[data-target='${targetId}']`);
                    if (targetBtn) targetBtn.classList.add('active');
                    panels.forEach(p => p.classList.remove('active'));
                    const targetPanel = root.querySelector(`#${targetId}`);
                    if (targetPanel) targetPanel.classList.add('active');

                    // Trigger corresponding lazy-load one-off if it hasn't run yet
                    if (typeof vendorSettingsLoaded !== 'undefined') {
                        if (targetId === 'vendor-services-panel' && !vendorSettingsLoaded.services && typeof loadVendorServicesSettings === 'function') {
                            loadVendorServicesSettings(vendorProfileId); vendorSettingsLoaded.services = true;
                        }
                        if (targetId === 'vendor-availability-panel' && !vendorSettingsLoaded.availability && typeof loadVendorAvailability === 'function') {
                            loadVendorAvailability(vendorProfileId); vendorSettingsLoaded.availability = true;
                        }
                        if (targetId === 'vendor-faqs-panel' && !vendorSettingsLoaded.faqs && typeof loadVendorFAQs === 'function') {
                            loadVendorFAQs(vendorProfileId); vendorSettingsLoaded.faqs = true;
                        }
                        if (targetId === 'vendor-photos-panel' && !vendorSettingsLoaded.photos && typeof loadVendorImages === 'function') {
                            loadVendorImages(vendorProfileId); vendorSettingsLoaded.photos = true;
                        }
                        if (targetId === 'vendor-location-panel' && !vendorSettingsLoaded.location && typeof loadVendorLocation === 'function') {
                            loadVendorLocation(vendorProfileId); vendorSettingsLoaded.location = true;
                        }
                        if (targetId === 'vendor-social-panel' && !vendorSettingsLoaded.social && typeof loadVendorSocial === 'function') {
                            loadVendorSocial(vendorProfileId); vendorSettingsLoaded.social = true;
                        }
                    }
                } catch (err) {
                    console.warn('Manual tab activation failed for', targetId, err);
                }
            }

            function renderVendorStats(kpis) {
                const container = document.getElementById('vendor-stats');
                if (!container) return;
                try {
                    container.classList.remove('kpi-grid');
                    container.classList.add('stats-top-grid');
                } catch (_) {}
                const now = new Date();
                const month = now.toLocaleString([], { month: 'long' });
                const day = now.getDate();
                const year = now.getFullYear();

                const upcoming = (kpis && (kpis.upcoming ?? kpis.UpcomingBookings)) || 0;
                const pending = (kpis && (kpis.pendingRequests ?? kpis.PendingRequests)) || 0;
                const avg = (() => { const val = kpis && (kpis.avgRating ?? kpis.AvgRating ?? kpis.averageRating ?? kpis.average_rating); const n = parseFloat(val); return isNaN(n) ? 0 : n; })();
                const unread = (kpis && (kpis.unreadMessages ?? kpis.UnreadMessages)) || 0;

                container.innerHTML = `
                    <div class="kpi-grid two-col">
                        <div class="kpi-card kpi-click" data-target="vendor-requests" data-kpi="upcoming">
                            <div class="kpi-icon bookings"><i class="fas fa-calendar-check"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${upcoming}</div>
                                <div class="kpi-label">Upcoming Bookings</div>
                            </div>
                        </div>
                        <div class="kpi-card kpi-click" data-target="vendor-requests" data-kpi="pending">
                            <div class="kpi-icon requests"><i class="fas fa-paper-plane"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${pending}</div>
                                <div class="kpi-label">Pending Requests</div>
                            </div>
                        </div>
                        <div class="kpi-card kpi-click" data-target="vendor-reviews">
                            <div class="kpi-icon rating"><i class="fas fa-star-half-alt"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${avg.toFixed(1)}</div>
                                <div class="kpi-label">Average Rating</div>
                            </div>
                        </div>
                        <div class="kpi-card kpi-click" data-target="vendor-messages">
                            <div class="kpi-icon messages"><i class="fas fa-envelope"></i></div>
                            <div class="kpi-content">
                                <div class="kpi-value">${unread}</div>
                                <div class="kpi-label">Unread Messages</div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-card calendar-tile full-height" id="vendor-mini-calendar">
                        <div class="cal-header">${month} ${year}</div>
                        <div class="cal-body">
                            <div class="cal-day">${now.toLocaleString([], { weekday: 'long' })}</div>
                            <div class="cal-date">${day}</div>
                        </div>
                    </div>
                `;

                try {
                    const go = (section, after) => {
                        try { displayUserDashboard('vendor', section); } catch(_) {}
                        if (after) {
                            let tries = 0;
                            const i = setInterval(() => {
                                tries++;
                                after();
                                if (tries > 30) clearInterval(i);
                            }, 120);
                            setTimeout(() => clearInterval(i), 4000);
                        }
                    };
                    container.querySelectorAll('.kpi-card.kpi-click').forEach(card => {
                        card.addEventListener('click', () => {
                            const target = card.getAttribute('data-target');
                            const k = card.getAttribute('data-kpi');
                            if (target === 'vendor-requests') {
                                go('vendor-requests', () => {
                                    if (k === 'pending') {
                                        const btn = document.querySelector('#vendor-requests-section .requests-filter-tabs .tab-btn[data-status="pending"]');
                                        if (btn) btn.click();
                                    } else if (k === 'upcoming') {
                                        const btn = document.querySelector('#vendor-requests-section .requests-filter-tabs .tab-btn[data-status="approved"]');
                                        if (btn) btn.click();
                                    }
                                });
                            } else if (target) {
                                go(target);
                            }
                        });
                    });
                } catch(_) {}
            }
            function renderVendorRecentBookings(bookings) {
                const container = document.getElementById('vendor-recent-bookings');
                if (!container) return;
                container.innerHTML = '';
                if (bookings && bookings.length > 0) {
                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.className = 'booking-item';
                        // Match Vendor Bookings card layout and info
                        const eventDate = new Date(booking.EventDate);
                        const month = eventDate.toLocaleDateString('en-US', { month: 'short' });
                        const day = eventDate.getDate();
                        const weekday = eventDate.toLocaleDateString('en-US', { weekday: 'short' });
                        const startTime = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        const endTime = new Date(eventDate.getTime() + 90 * 60000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        const timeStr = `${startTime} - ${endTime}`;

                        const isPaid = booking.FullAmountPaid === true || booking.FullAmountPaid === 1;
                        const status = (booking.Status || '').toString().toLowerCase();
                        const statusText = isPaid ? 'Paid' : (status === 'confirmed' ? 'Accepted' : (status.charAt(0).toUpperCase() + status.slice(1)));

                        let actionButtons = '';
                        if (isPaid) {
                            actionButtons = `<span class="btn btn-success btn-sm" style="margin-left: 10px; cursor: default;">✓ Paid</span>`;
                        }
                        if (status === 'confirmed' || status === 'paid') {
                            actionButtons += `<button class=\"btn btn-outline btn-sm\" onclick=\"openBookingChat('${booking.BookingID}')\" style=\"margin-left: 8px;\">Chat</button>`;
                            actionButtons += `<button class=\"btn btn-outline btn-sm\" onclick=\"openInvoiceModal('${booking.BookingID}')\" style=\"margin-left: 8px;\">Invoice</button>`;
                        }

                        bookingItem.innerHTML = `
                            <div class="booking-date-section">
                                <div class="booking-month">${month}</div>
                                <div class="booking-day">${day}</div>
                                <div class="booking-weekday">${weekday}</div>
                            </div>
                            <div class="booking-info">
                                <div class="booking-client">
                                    <i class="fas fa-user" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-client-name">${booking.ClientName || 'Client'}</span>
                                </div>
                                <div class="booking-service-row">
                                    <span class="booking-service">${booking.ServiceName || 'Confirmed Booking'}</span>
                                </div>
                                <div class="booking-time-row">
                                    <i class="fas fa-clock" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-time">${timeStr}</span>
                                </div>
                                ${booking.TotalAmount ? `<div class="booking-price-row">
                                    <i class="fas fa-dollar-sign" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-price">$${Number(booking.TotalAmount).toLocaleString()}</span>
                                </div>` : ''}
                                ${booking.Location ? `<div class="booking-location-row">
                                    <i class="fas fa-map-marker-alt" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-location">${booking.Location}</span>
                                </div>` : ''}
                            </div>
                            <div class="booking-actions">
                                <span class="request-status ${status}" style="margin-right:12px;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;text-transform:capitalize;">${statusText}</span>
                                ${actionButtons}
                            </div>
                        `;
                        container.appendChild(bookingItem);
                    });
                } else {
                    container.innerHTML = '<div class="empty-state">No recent bookings found.</div>';
                }
            }

            // Lightweight recent messages preview for dashboard overview
            async function loadVendorRecentMessagesPreview() {
                const container = document.getElementById('vendor-recent-messages');
                if (!container || !currentUser) return;
                container.innerHTML = '<p>Loading recent messages...</p>';
                try {
                    const resp = await fetch(`${API_BASE_URL}/messages/conversations/user/${currentUser.id}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    let conversations = [];
                    if (resp.ok) {
                        const data = await resp.json();
                        conversations = (data.conversations || []).map(conv => ({
                            id: conv.id || conv.ConversationID,
                            name: conv.OtherPartyName || conv.userName || 'Unknown',
                            last: conv.lastMessageContent || conv.LastMessageContent || '',
                            ts: new Date(conv.lastMessageCreatedAt || conv.LastMessageCreatedAt || conv.createdAt || Date.now())
                        })).sort((a,b) => b.ts - a.ts);
                    } else {
                        const localConversations = JSON.parse(localStorage.getItem('conversations') || '[]');
                        conversations = localConversations
                            .filter(c => c.userId === currentUser.id || c.vendorProfileId === currentUser.vendorProfileId)
                            .map(c => ({ id: c.id, name: c.OtherPartyName || c.userName || 'Unknown', last: c.lastMessageContent || '', ts: new Date(c.lastMessageCreatedAt || c.createdAt || Date.now()) }))
                            .sort((a,b) => b.ts - a.ts);
                    }
                    renderVendorRecentMessages(conversations.slice(0,5));
                } catch (e) {
                    console.warn('loadVendorRecentMessagesPreview failed', e);
                    container.innerHTML = '<p style="color:var(--accent);">Failed to load messages.</p>';
                }
            }

            function renderVendorRecentMessages(items) {
                const container = document.getElementById('vendor-recent-messages');
                if (!container) return;
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="empty-state">No recent messages.</div>';
                    return;
                }
                container.innerHTML = '';
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'message-preview-item';
                    const initials = (item.name || 'U').trim().charAt(0).toUpperCase();
                    const timeStr = item.ts ? item.ts.toLocaleString([], { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
                    el.innerHTML = `
                        <div class="preview-avatar">${initials}</div>
                        <div class="preview-content">
                            <div class="preview-name">${item.name}</div>
                            <div class="preview-snippet">${(item.last || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                        </div>
                        <div class="preview-time">${timeStr}</div>
                    `;
                    el.addEventListener('click', () => {
                        try { displayUserDashboard('vendor','vendor-messages'); } catch(_) {}
                    });
                    container.appendChild(el);
                });
            }

            function renderBookingsList(bookings, container) {
                container.innerHTML = '';
                if (bookings && bookings.length > 0) {
                    bookings.forEach(booking => {
                        const bookingItem = document.createElement('div');
                        bookingItem.className = 'booking-item has-details';
                        const vendorOrClientName = isVendorMode ? booking.ClientName : booking.VendorName;
                        
                        // Compute payment status from flags returned by API
                        const isPaid = booking.FullAmountPaid === true || booking.FullAmountPaid === 1;
                        const isDepositOnly = !isPaid && (booking.DepositPaid === true || booking.DepositPaid === 1);
                        
                        // Format date and time
                        const eventDate = new Date(booking.EventDate);
                        const day = eventDate.getDate();
                        const month = eventDate.toLocaleDateString('en-US', { month: 'short' });
                        const weekday = eventDate.toLocaleDateString('en-US', { weekday: 'short' });
                        
                        // Format time range (assuming 1.5 hour duration for now)
                        const startTime = eventDate.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        const endDate = new Date(eventDate.getTime() + 90 * 60000); // Add 1.5 hours
                        const endTime = endDate.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        const timeStr = `${startTime} - ${endTime}`;

                        // Build details rows
                        const detailsRows = [];
                        const pushRow = (label, value, full = false) => {
                            if (value && value !== '—' && value !== null && value !== undefined && value !== '') {
                                detailsRows.push(`<div class="request-detail-row" ${full ? 'style="grid-column: span 2;"' : ''}><span class="request-detail-label">${label}</span><span class="request-detail-value">${value}</span></div>`);
                            }
                        };

                        // Add detail rows
                        if (booking.EventName) pushRow('Event Name', booking.EventName);
                        if (booking.EventType) pushRow('Event', booking.EventType);
                        if (booking.TimeZone) pushRow('Time Zone', booking.TimeZone);
                        if (booking.AttendeeCount) pushRow('Attendees', booking.AttendeeCount);
                        if (booking.SpecialRequests) pushRow('Special Requests', booking.SpecialRequests, true);
                        if (booking.CreatedAt) pushRow('Created On', new Date(booking.CreatedAt).toLocaleString());
                        
                        const detailsHtml = detailsRows.join('');
                        const moreInfoBtn = detailsHtml ? `<button class="link-btn" onclick="openBookingDetails(this)" style="margin-top:2px;">More info</button>` : '';

                        // Status badge
                        const bookingStatusMap = {
                            pending:  { icon: 'fa-clock',        color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.12)', label: 'Pending' },
                            confirmed:{ icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Confirmed' },
                            paid:     { icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Paid' },
                            cancelled:{ icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Cancelled' },
                            declined: { icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Declined' }
                        };
                        const status = (booking.Status || 'pending').toLowerCase();
                        const statusCfg = bookingStatusMap[status] || bookingStatusMap.pending;
                        const statusBadgeHtml = `<div class="request-status-badge" style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;background:${statusCfg.bg};color:#111827;border:1px solid ${statusCfg.color};"><i class="fas ${statusCfg.icon}" style="color:${statusCfg.color};"></i><span>${statusCfg.label}</span></div>`;

                        // Determine action buttons based on booking status and payment
                        let actionButtons = '';
                        if (booking.Status === 'confirmed') {
                            if (isDepositOnly) {
                                actionButtons = `<button class="btn-pay-now" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount}, ${booking.VendorProfileID})">Pay Balance</button>`;
                            } else if (!isPaid) {
                                actionButtons = `<button class="btn-pay-now" onclick="initiatePayment('${booking.BookingID}', ${booking.TotalAmount}, ${booking.VendorProfileID})">Pay Now</button>`;
                            }
                        }
                        
                        // Add chat and invoice buttons for confirmed/paid bookings (no Paid button - status badge shows payment status)
                        if (booking.Status === 'confirmed' || booking.Status === 'paid' || isPaid) {
                            if (booking.ConversationID) {
                                actionButtons += `<button class="btn btn-outline" onclick="openChatForRequest(${booking.ConversationID})" style="padding: 6px 12px; border-radius: 8px; font-size: 13px;">Chat</button>`;
                            }
                            actionButtons += `<button class="btn btn-outline" onclick="openInvoiceModal('${booking.BookingID}')" style="padding: 6px 12px; border-radius: 8px; font-size: 13px;">Invoice</button>`;
                        }
                        
                        bookingItem.innerHTML = `
                            <div class="booking-date-section">
                                <div class="booking-month">${month}</div>
                                <div class="booking-day">${day}</div>
                                <div class="booking-weekday">${weekday}</div>
                            </div>
                            <div class="booking-info">
                                <div class="booking-client" style="gap:6px; margin-bottom: 0;">
                                    ${isVendorMode ? '<i class="fas fa-user" style="color: #6b7280; font-size: 12px;"></i>' : '<i class="fas fa-store" style="color: #6b7280; font-size: 12px;"></i>'}
                                    <span class="booking-client-name" style="font-size:16px; font-weight:700; color:#111827;">${vendorOrClientName}</span>
                                </div>
                                <div class="booking-service-row">
                                    <span class="booking-service">${booking.ServiceName || 'Event Service'}</span>
                                </div>
                                ${booking.Location ? `<div class="booking-location-row">
                                    <i class="fas fa-map-marker-alt" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-location" title="${booking.Location}" style="max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: bottom;">${booking.Location}</span>
                                </div>` : ''}
                                <div class="booking-date-row">
                                    <i class="fas fa-calendar-alt" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-date">${eventDate.toLocaleDateString()}</span>
                                </div>
                                <div class="booking-time-row">
                                    <i class="fas fa-clock" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-time">${timeStr}</span>
                                </div>
                                ${booking.TotalAmount ? `<div class="booking-price-row">
                                    <i class="fas fa-dollar-sign" style="color: #6b7280; font-size: 12px;"></i>
                                    <span class="booking-price">$${booking.TotalAmount.toFixed(2)}</span>
                                </div>` : ''}
                            </div>
                            <div class="booking-actions" style="display:flex; flex-direction:column; align-items:flex-end; gap:12px; padding-right:10px;">
                                <div class="status-col" style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; margin:8px 10px 8px 0; padding:2px 0;">
                                    ${statusBadgeHtml}
                                </div>
                                ${moreInfoBtn}
                                <div class="actions-row" style="display:flex; align-items:center; gap:6px;">
                                    ${actionButtons}
                                </div>
                            </div>
                            ${detailsHtml ? `<div class="request-details collapsed">${detailsHtml}</div>` : ''}
                        `;
                        container.appendChild(bookingItem);
                    });
                } else {
                    container.innerHTML = '<p>No bookings found.</p>';
                }
            }

            // Unified client "All" list: merge booking requests and bookings into one ordered feed (global)
            function renderUnifiedClientAll(bookings, requests, container, statusFilter) {
                try {
                    const items = [];
                    // Map bookings
                    (Array.isArray(bookings) ? bookings : []).forEach(b => {
                        const sortTs = (() => { try { return new Date(b.EventDate).getTime(); } catch (_) { return Date.now(); } })();
                        const isPaid = b.FullAmountPaid === true || b.FullAmountPaid === 1;
                        const isDepositOnly = !isPaid && (b.DepositPaid === true || b.DepositPaid === 1);
                        items.push({
                            type: 'booking',
                            sortTs,
                            id: b.BookingID,
                            vendorName: b.VendorName,
                            eventDate: b.EventDate,
                            serviceName: b.ServiceName,
                            location: b.Location,
                            totalAmount: b.TotalAmount,
                            status: (b.Status || '').toString().toLowerCase(),
                            vendorProfileId: b.VendorProfileID,
                            isPaid,
                            isDepositOnly,
                            // Additional fields for details
                            eventName: b.EventName || '',
                            eventType: b.EventType || '',
                            timeZone: b.TimeZone || '',
                            attendeeCount: (b.AttendeeCount != null ? b.AttendeeCount : ''),
                            createdAt: b.CreatedAt || b.Created || ''
                        });
                    });
                    // Map requests
                    const normReqStatus = (r) => {
                        try {
                            let s = (r.Status || r.status || 'pending').toString().toLowerCase();
                            if (s === 'accepted') s = 'approved';
                            if (s === 'pending' && r.ExpiresAt) {
                                const exp = new Date(r.ExpiresAt);
                                if (!isNaN(exp.getTime()) && exp <= new Date()) s = 'expired';
                            }
                            return s;
                        } catch { return 'pending'; }
                    };
                    (Array.isArray(requests) ? requests : []).forEach(r => {
                        const createdTs = (() => { try { return new Date(r.CreatedAt || r.Created || r.ExpiresAt || r.EventDate || Date.now()).getTime(); } catch (_) { return Date.now(); } })();
                        items.push({
                            type: 'request',
                            sortTs: createdTs,
                            id: r.RequestID,
                            vendorName: r.VendorName,
                            eventDate: r.EventDate,
                            eventTime: r.EventTime,
                            budget: r.Budget,
                            location: r.EventLocation,
                            status: normReqStatus(r),
                            vendorProfileId: r.VendorProfileID,
                            expiresAt: r.ExpiresAt,
                            // Fields for details
                            servicesRaw: r.Services,
                            specialRequests: r.SpecialRequests,
                            timeZone: r.TimeZone,
                            eventName: r.EventName,
                            eventType: r.EventType,
                            attendeeCount: (r.AttendeeCount != null ? r.AttendeeCount : ''),
                            createdAt: r.CreatedAt || r.Created
                        });
                    });

                    // Dedupe: if a confirmed booking exists for same vendor/date, drop the approved request
                    try {
                        const bookingKey = new Set(items.filter(i => i.type === 'booking')
                            .map(i => `${i.vendorProfileId || ''}|${i.eventDate ? new Date(i.eventDate).toDateString() : ''}`));
                        for (let i = items.length - 1; i >= 0; i--) {
                            const it = items[i];
                            if (it.type === 'request' && it.status === 'approved') {
                                const key = `${it.vendorProfileId || ''}|${it.eventDate ? new Date(it.eventDate).toDateString() : ''}`;
                                if (bookingKey.has(key)) {
                                    items.splice(i, 1);
                                }
                            }
                        }
                    } catch(_) {}

                    // Optional filter
                    if (statusFilter && statusFilter !== 'all') {
                        const keep = (it) => {
                            const s = it.status;
                            if (statusFilter === 'pending') return (it.type === 'request' && s === 'pending') || (it.type === 'booking' && s === 'pending');
                            if (statusFilter === 'accepted') return (it.type === 'request' && s === 'approved') || (it.type === 'booking' && (s === 'confirmed' || s === 'paid'));
                            if (statusFilter === 'declined') return (it.type === 'request' && s === 'declined') || (it.type === 'booking' && (s === 'cancelled' || s === 'rejected' || s === 'declined'));
                            if (statusFilter === 'expired') return (it.type === 'request' && s === 'expired');
                            return true;
                        };
                        for (let i = items.length - 1; i >= 0; i--) if (!keep(items[i])) items.splice(i, 1);
                    }

                    // Sort most recent first
                    items.sort((a, b) => b.sortTs - a.sortTs);

                    if (!items.length) {
                        container.innerHTML = '<p>No activity yet.</p>';
                        return;
                    }

                    // Helpers for times similar to vendor cards
                    const parseTime = (val) => {
                        try {
                            if (!val) return { mins:null, label:'' };
                            if (val instanceof Date) {
                                const h = val.getUTCHours();
                                const m = val.getUTCMinutes();
                                return { mins: h*60+m, label: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` };
                            }
                            const s = String(val).trim();
                            const m1 = s.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM|am|pm)?/);
                            if (m1) {
                                let h = parseInt(m1[1],10);
                                const mm = parseInt(m1[2],10);
                                const ap = m1[4] ? m1[4].toLowerCase() : '';
                                if (ap) { if (ap === 'pm' && h < 12) h += 12; if (ap === 'am' && h === 12) h = 0; }
                                return { mins: h*60+mm, label: `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}` };
                            }
                            const tMatch = s.match(/T(\d{2}):(\d{2})(?::(\d{2}))?/);
                            if (tMatch) { const h = parseInt(tMatch[1],10); const mm = parseInt(tMatch[2],10); return { mins: h*60+mm, label: `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}` }; }
                            const iso = s.includes('T') ? new Date(s) : null;
                            if (iso && !isNaN(iso.getTime())) { const h = iso.getUTCHours(); const m = iso.getUTCMinutes(); return { mins: h*60+m, label: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` }; }
                            return { mins:null, label: s };
                        } catch { return { mins:null, label:'' }; }
                    };
                    const to12h = (lab) => {
                        try { if (!lab) return ''; const [hh, mm] = String(lab).split(':'); let h = parseInt(hh,10); const m = parseInt(mm,10); const ap = h>=12?'PM':'AM'; h = h%12; if (h===0) h=12; return `${h}:${String(m).padStart(2,'0')} ${ap}`; } catch { return lab; }
                    };

                    // Render using vendor card layout
                    const html = items.map(it => {
                        const eventDate = it.eventDate ? new Date(it.eventDate) : null;
                        const month = eventDate ? eventDate.toLocaleDateString('en-US', { month: 'short' }) : '—';
                        const day = eventDate ? eventDate.getDate() : '—';
                        const weekday = eventDate ? eventDate.toLocaleDateString('en-US', { weekday: 'short' }) : '—';
                        // Build details rows based on item type
                        const detailsRows = [];
                        const pushRow = (label, value, full = false) => { if (value && value !== '—') { detailsRows.push(`<div class=\"request-detail-row\" ${full ? 'style=\"grid-column: span 2;\"' : ''}><span class=\"request-detail-label\">${label}</span><span class=\"request-detail-value\">${value}</span></div>`); } };
                        let mainPriceHtml = '';
                        let mainDateHtml = '';
                        let mainTimeHtml = '';
                        let statusBadgeHtml = '';
                        let moreInfoBtn = '';
                        let actionsHtml = '';
                        let displayService = it.serviceName || '';

                        if (it.type === 'booking') {
                            // Status + actions for bookings
                            const bookingStatusMap = {
                                pending:  { icon: 'fa-clock',        color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.12)', label: 'Pending' },
                                confirmed:{ icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Accepted' },
                                paid:     { icon: 'fa-check-circle', color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Paid' },
                                cancelled:{ icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Cancelled' },
                                declined: { icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Declined' }
                            };
                            const s = bookingStatusMap[it.status] || bookingStatusMap.pending;
                            statusBadgeHtml = `<div class=\"request-status-badge\" style=\"display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;background:${s.bg};color:#111827;border:1px solid ${s.color};\"><i class=\"fas ${s.icon}\" style=\"color:${s.color};\"></i><span>${s.label}</span></div>`;
                            // Actions
                            if (it.status === 'confirmed') {
                                if (it.isPaid) {
                                    actionsHtml = `<button class=\"btn-paid\">✓ Paid</button>`;
                                } else if (it.isDepositOnly) {
                                    actionsHtml = `<button class=\"btn-pay-now\" onclick=\"initiatePayment('${it.id}', ${Number(it.totalAmount || 0)}, ${it.vendorProfileId})\">Pay Balance</button>`;
                                } else {
                                    actionsHtml = `<button class=\"btn-pay-now\" onclick=\"initiatePayment('${it.id}', ${Number(it.totalAmount || 0)}, ${it.vendorProfileId})\">Pay Now</button>`;
                                }
                            } else if (it.status === 'paid') {
                                actionsHtml = `<button class=\"btn-paid\">✓ Paid</button>`;
                            }
                            if (it.status === 'confirmed' || it.status === 'paid') {
                                actionsHtml += `<a href=\"#\" class=\"link-btn\" onclick=\"openInvoiceModal('${it.id}')\" style=\"margin-left: 10px;\">Invoice</a>`;
                            }
                            // Main fields
                            if (it.totalAmount) mainPriceHtml = `<div class=\"booking-price-row\"><i class=\"fas fa-dollar-sign\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-price\">$${Number(it.totalAmount).toLocaleString()}</span></div>`;
                            if (eventDate) mainDateHtml = `<div class=\"booking-date-row\"><i class=\"fas fa-calendar-alt\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-date\">${eventDate.toLocaleDateString()}</span></div>`;
                            // Time: approximate if not provided
                            let timeStr = '';
                            if (it.eventTime) {
                                const p = parseTime(it.eventTime); timeStr = to12h(p.label);
                            } else if (eventDate) {
                                const start = eventDate.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', hour12:true });
                                const end = new Date(eventDate.getTime() + 90*60000).toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', hour12:true });
                                timeStr = `${start} – ${end}`;
                            }
                            if (timeStr) mainTimeHtml = `<div class=\"booking-time-row\"><i class=\"fas fa-clock\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-time\">${timeStr}</span></div>`;
                            // Details
                            pushRow('Event Name', it.eventName);
                            pushRow('Event', it.eventType);
                            pushRow('Time Zone', it.timeZone);
                            pushRow('Attendees', it.attendeeCount);
                            pushRow('Requested On', it.createdAt ? new Date(it.createdAt).toLocaleString() : '');
                            moreInfoBtn = detailsRows.length ? `<button class=\"link-btn\" onclick=\"openBookingDetails(this)\" style=\"margin-top:2px;\">More info</button>` : '';
                        } else {
                            // Client view of requests sent to vendors - match vendor card
                            let hoursRemaining = 0;
                            try { const now = new Date(); const exp = it.expiresAt ? new Date(it.expiresAt) : null; if (exp) { const diffMs = exp.getTime() - now.getTime(); hoursRemaining = Math.max(0, Math.ceil(diffMs / (1000*60*60))); } } catch {}
                            const statusMap = {
                                pending:  { icon: 'fa-clock',          color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.12)', label: 'Pending response' },
                                approved: { icon: 'fa-check-circle',   color: '#10b981', bg: 'rgba(16, 185, 129, 0.12)', label: 'Accepted' },
                                declined: { icon: 'fa-times-circle',   color: '#ef4444', bg: 'rgba(239, 68, 68, 0.12)', label: 'Declined' },
                                expired:  { icon: 'fa-hourglass-end',  color: '#6b7280', bg: 'rgba(107, 114, 128, 0.12)', label: 'Expired' }
                            };
                            const cfg = statusMap[it.status] || statusMap.pending;
                            statusBadgeHtml = `<div class=\"request-status-badge\" style=\"display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;background:${cfg.bg};color:#111827;border:1px solid ${cfg.color};\"><i class=\"fas ${cfg.icon}\" style=\"color:${cfg.color};\"></i><span>${cfg.label}</span>${it.status==='pending' ? '<span class=\"dot-new\" title=\"New request\"></span>' : ''}</div>`;
                            if (it.status === 'pending') {
                                statusBadgeHtml += `<div class=\"request-deadline-note\" style=\"font-size:12px; color:#6b7280; text-align:right; margin-top:4px;\">${hoursRemaining > 0 ? `${hoursRemaining} ${hoursRemaining === 1 ? 'hour' : 'hours'} remaining` : 'Timer expired'}</div>`;
                            }
                            // Main fields
                            if (it.budget) mainPriceHtml = `<div class=\"booking-price-row\"><i class=\"fas fa-dollar-sign\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-price\">$${Number(it.budget).toLocaleString()}</span></div>`;
                            if (eventDate) mainDateHtml = `<div class=\"booking-date-row\"><i class=\"fas fa-calendar-alt\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-date\">${eventDate.toLocaleDateString()}</span></div>`;
                            const tParsed = parseTime(it.eventTime);
                            const timeLabel = tParsed.label ? to12h(tParsed.label) : '';
                            if (timeLabel) mainTimeHtml = `<div class=\"booking-time-row\"><i class=\"fas fa-clock\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-time\">${timeLabel}</span></div>`;
                            // Try to extract primary service name from Services JSON for main row
                            try {
                                if (!displayService && it.servicesRaw) {
                                    let names = [];
                                    if (typeof it.servicesRaw === 'string') {
                                        const parsed = JSON.parse(it.servicesRaw);
                                        const list = Array.isArray(parsed) ? parsed : (parsed && Array.isArray(parsed.services) ? parsed.services : []);
                                        names = list.map(s => (s.ServiceName||s.Name||s.name||s.service||s.Service||s.Title||s.title)).filter(Boolean);
                                    } else if (Array.isArray(it.servicesRaw)) {
                                        names = it.servicesRaw.map(s => (s.ServiceName||s.Name||s.name||s.service||s.Service||s.Title||s.title)).filter(Boolean);
                                    }
                                    displayService = names[0] || displayService;
                                }
                            } catch {}
                            // Details (use memory preferences)
                            pushRow('Event Name', it.eventName);
                            pushRow('Event', it.eventType);
                            pushRow('Time Zone', it.timeZone);
                            pushRow('Attendees', it.attendeeCount);
                            // Services: show in details if multiple present in Services JSON
                            try {
                                if (it.servicesRaw && typeof it.servicesRaw === 'string') {
                                    const parsed = JSON.parse(it.servicesRaw);
                                    const list = Array.isArray(parsed) ? parsed : (parsed && Array.isArray(parsed.services) ? parsed.services : []);
                                    const names = list.map(s => (s.ServiceName||s.Name||s.name||s.service||s.Service||s.Title||s.title)).filter(Boolean);
                                    if (names.length > 1) pushRow('Services', names.join(', '), true);
                                }
                            } catch {}
                            if (it.specialRequests) pushRow('Special Requests', it.specialRequests, true);
                            pushRow('Respond By', it.expiresAt ? new Date(it.expiresAt).toLocaleString() : '');
                            pushRow('Requested On', it.createdAt ? new Date(it.createdAt).toLocaleString() : '');
                            moreInfoBtn = detailsRows.length ? `<button class=\"link-btn\" onclick=\"openBookingDetails(this)\" style=\"margin-top:2px;\">More info</button>` : '';
                        }

                        // Price breakdown (client view of requests)
                        let priceBreakdownBlock = '';
                        try {
                            const money = (n) => `$${Number(n || 0).toLocaleString()}`;
                            let svc = [];
                            if (typeof it.servicesRaw === 'string') {
                                const parsed = JSON.parse(it.servicesRaw);
                                svc = Array.isArray(parsed) ? parsed : (parsed && Array.isArray(parsed.services) ? parsed.services : []);
                            } else if (Array.isArray(it.servicesRaw)) {
                                svc = it.servicesRaw;
                            }
                            let rows = [];
                            let subtotal = 0;
                            svc.forEach(s => {
                                const name = (s.ServiceName||s.Name||s.name||s.service||s.Service||s.Title||s.title||'Service');
                                const amt = Number(s.budget ?? s.Budget ?? s.Price ?? s.BasePrice ?? s.FixedPrice ?? 0);
                                if (amt > 0) {
                                    subtotal += amt;
                                    rows.push(`<div style=\"display:flex;justify-content:space-between;padding:4px 0;\"><span>${name}</span><strong>${money(amt)}</strong></div>`);
                                }
                            });
                            const totalBudget = Number(it.budget || 0);
                            const hasServiceAmounts = subtotal > 0 && rows.length > 0;
                            if (hasServiceAmounts || totalBudget > 0) {
                                const total = hasServiceAmounts ? subtotal : totalBudget;
                                const totalRow = `<div style=\"display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed var(--border);margin-top:6px;\"><span>Total</span><strong>${money(total)}</strong></div>`;
                                const budgetNote = (totalBudget > 0 && hasServiceAmounts && totalBudget !== subtotal)
                                    ? `<div style=\"margin-top:6px;color:#6b7280;font-size:12px;\">Budget provided: ${money(totalBudget)}</div>`
                                    : '';
                                const box = `<div class=\"price-breakdown\" style=\"border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.04);\">
                                    <div style=\"font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:8px;\"><i class=\"fas fa-receipt\" style=\"color:#6b7280;\"></i><span>Price breakdown</span></div>
                                    ${rows.join('')}
                                    ${totalRow}
                                    ${budgetNote}
                                </div>`;
                                priceBreakdownBlock = `<div class=\"request-detail-row\" style=\"grid-column: span 2;\">${box}</div>`;
                            }
                        } catch(_) {}
                        const detailsHtml = detailsRows.join('') + priceBreakdownBlock;
                        const middleInfoHtml = `
                            <div class=\"booking-client\" style=\"gap:6px; margin-bottom: 0;\"><i class=\"fas fa-store\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-client-name\" style=\"font-size:16px; font-weight:700; color:#111827;\">${it.vendorName || 'Vendor'}</span></div>
                            ${displayService ? `<div class=\"booking-service-row\"><span class=\"booking-service\">${displayService}</span></div>` : ''}
                            ${it.location ? `<div class=\"booking-location-row\"><i class=\"fas fa-map-marker-alt\" style=\"color:#6b7280;font-size:12px;\"></i><span class=\"booking-location\" title=\"${it.location}\" style=\"max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: bottom;\">${it.location}</span></div>` : ''}
                            ${mainDateHtml}
                            ${mainTimeHtml}
                            ${mainPriceHtml}
                        `;

                        return `
                        <div class=\"booking-item has-details\">
                            <div class=\"booking-date-section\">
                                <div class=\"booking-month\">${month}</div>
                                <div class=\"booking-day\">${day}</div>
                                <div class=\"booking-weekday\">${weekday}</div>
                            </div>
                            <div class=\"booking-info\">${middleInfoHtml}</div>
                            <div class=\"booking-actions\" style=\"display:flex; flex-direction:column; align-items:flex-end; gap:12px; padding-right:10px;\">
                                <div class=\"status-col\" style=\"display:flex; flex-direction:column; align-items:flex-end; gap:4px; margin:8px 10px 8px 0; padding:2px 0;\">${statusBadgeHtml}</div>
                                ${moreInfoBtn}
                                <div class=\"actions-row\" style=\"display:flex; align-items:center; gap:6px;\">${actionsHtml}</div>
                            </div>
                            ${detailsHtml ? `<div class=\"request-details collapsed\">${detailsHtml}</div>` : ''}
                        </div>`;
                    }).join('');
                    container.innerHTML = html;
                } catch (e) {
                    console.error('renderUnifiedClientAll error:', e);
                    container.innerHTML = '<p style="color:var(--accent);">Failed to render bookings.</p>';
                }
            }

            async function loadAllVendorBookings(vendorProfileId) {
                const container = document.getElementById('vendor-all-bookings');
                container.innerHTML = '<p>Loading all bookings...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/bookings/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch all vendor bookings');
                    const bookings = await response.json();
                    renderBookingsList(bookings, container);
                } catch (error) {
                    console.error('Error loading all vendor bookings:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load all bookings: ${error.message}</p>`;
                }
            }

            async function loadVendorServices(vendorProfileId) {
                const container = document.getElementById('vendor-services');
                container.innerHTML = '<p>Loading services...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/services`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load services');
                    }
                    
                    const services = await response.json();
                    renderManageServices(services, container);
                } catch (error) {
                    console.error('Error loading vendor services:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load services: ${error.message}</p>`;
                }
            }

            async function loadStripeConnectStatus(vendorProfileId) {
                const statusDisplay = document.getElementById('stripe-status-display');
                if (!statusDisplay) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/payments/connect/status/${vendorProfileId}`);
                    const data = await response.json();
                    
                    if (data.success && data.connected && data.charges_enabled) {
                        // Connected and ready
                        statusDisplay.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
                                <i class="fas fa-check-circle" style="color: #16a34a; font-size: 20px;"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #15803d; margin-bottom: 4px;">Connected & Ready</div>
                                    <div style="font-size: 14px; color: #166534;">Your Stripe account is connected and ready to receive payments. ${data.mock ? '(Mock mode - Connect not enabled on server)' : ''}</div>
                                </div>
                                <button onclick="refreshStripeStatus(${vendorProfileId})" class="btn btn-outline" style="white-space: nowrap;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        `;
                    } else if (data.success && data.connected && !data.charges_enabled) {
                        // Connected but not ready for charges
                        statusDisplay.innerHTML = `
                            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 16px; background: #fffbeb; border: 1px solid #fde68a; border-radius: 6px;">
                                <i class="fas fa-exclamation-triangle" style="color: #d97706; font-size: 20px; margin-top: 2px;"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Setup Incomplete</div>
                                    <div style="font-size: 14px; color: #b45309; margin-bottom: 8px;">Your Stripe account is connected but needs additional information before you can receive payments.</div>
                                    <div style="font-size: 13px; color: #a16207;">
                                        <strong>Next steps:</strong> Complete bank details, business verification, and tax information in Stripe.
                                    </div>
                                </div>
                                <button onclick="continueStripeOnboarding(${vendorProfileId})" class="btn btn-primary" style="white-space: nowrap;">
                                    <i class="fab fa-stripe"></i> Complete Setup
                                </button>
                            </div>
                        `;
                    } else {
                        // Not connected
                        statusDisplay.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
                                <i class="fas fa-times-circle" style="color: #dc2626; font-size: 20px;"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 4px;">Not Connected</div>
                                    <div style="font-size: 14px; color: #b91c1c;">Connect your Stripe account to start receiving payments from customers. We automatically handle the 10% platform fee.</div>
                                </div>
                                <button onclick="startStripeOnboarding(${vendorProfileId})" class="btn btn-primary">
                                    <i class="fab fa-stripe"></i> Connect with Stripe
                                </button>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading Stripe status:', error);
                    statusDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
                            <i class="fas fa-exclamation-circle" style="color: #dc2626; font-size: 20px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #991b1b; margin-bottom: 4px;">Connection Error</div>
                                <div style="font-size: 14px; color: #b91c1c;">Unable to check Stripe connection status. Please try again later.</div>
                            </div>
                            <button onclick="refreshStripeStatus(${vendorProfileId})" class="btn btn-outline">
                                <i class="fas fa-sync-alt"></i> Retry
                            </button>
                        </div>
                    `;
                }
            }

            async function refreshStripeStatus(vendorProfileId) {
                const statusDisplay = document.getElementById('stripe-status-display');
                statusDisplay.innerHTML = `
                    <div class="loading-spinner" style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #6b7280;"></i>
                        <p style="margin: 8px 0 0 0; color: #6b7280;">Refreshing connection status...</p>
                    </div>
                `;
                await loadStripeConnectStatus(vendorProfileId);
            }


            function renderManageServices(services, container) {
                container.innerHTML = '';
                if (services && services.length > 0) {
                    // Group services by category for rendering
                    const servicesByCategory = services.reduce((acc, service) => {
                        const categoryName = service.CategoryName || 'Uncategorized';
                        if (!acc[categoryName]) {
                            acc[categoryName] = [];
                        }
                        acc[categoryName].push(service);
                        return acc;
                    }, {});

                    for (const categoryName in servicesByCategory) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'service-category';
                        categoryDiv.innerHTML = `
                            <h4 class="category-title">${categoryName}</h4>
                            <div class="service-grid">
                                ${(servicesByCategory[categoryName].map(service => `
                                    <div class="service-card">
                                        <div class="service-name">${service.ServiceName}</div>
                                        <div class="service-description">${service.ServiceDescription || 'No description.'}</div>
                                        <div class="service-price">$${service.Price.toFixed(2)}</div>
                                        <div class="service-actions">
                                            <button class="btn btn-outline btn-sm edit-service-btn" data-service-id="${service.ServiceID}">Edit</button>
                                            <button class="btn btn-primary btn-sm delete-service-btn" data-service-id="${service.ServiceID}">Delete</button>
                                        </div>
                                    </div>
                                `)).join('')}
                            </div>
                        `;
                        container.appendChild(categoryDiv);
                    }
                } else {
                    container.innerHTML = '<p>No services added yet. Add your first service!</p>';
                }
                // Add a button to add new services
                const addServiceBtn = document.createElement('button');
                addServiceBtn.className = 'btn btn-primary';
                addServiceBtn.textContent = 'Add New Service';
                addServiceBtn.addEventListener('click', () => {
                    // Implement logic to open a form for adding/editing a service
                    // For now, a simple alert
                    alert('Add New Service form would open here!');
                });
                container.appendChild(addServiceBtn);
            }

            async function loadAllVendorReviews(vendorProfileId) {
                const container = document.getElementById('vendor-reviews');
                container.innerHTML = '<p>Loading customer reviews...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/reviews/all`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch all vendor reviews');
                    const reviews = await response.json();
                    renderReviewsList(reviews, container);
                } catch (error) {
                    console.error('Error loading all vendor reviews:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load reviews: ${error.message}</p>`;
                }
            }

            // Chart instances to prevent re-initialization
            let bookingStatsChart = null;
            let revenueByServiceChart = null;
            let revenueByMonthChart = null;
            let reviewStatsChart = null;

            async function loadVendorAnalytics(vendorProfileId) {
                const container = document.getElementById('analytics-charts');
                container.innerHTML = '<p>Loading analytics data...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/analytics`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor analytics');
                    const analyticsData = await response.json();

                    container.innerHTML = '';

                    // Render Booking Stats Chart (Pie Chart)
                    const bookingStatsCanvas = document.createElement('canvas');
                    bookingStatsCanvas.id = 'bookingStatsChart';
                    const bookingStatsChartContainer = document.createElement('div');
                    bookingStatsChartContainer.className = 'chart-container';
                    bookingStatsChartContainer.innerHTML = '<h3>Booking Status Overview</h3>';
                    bookingStatsChartContainer.appendChild(bookingStatsCanvas);
                    container.appendChild(bookingStatsChartContainer);

                    if (bookingStatsChart) bookingStatsChart.destroy();
                    bookingStatsChart = new Chart(bookingStatsCanvas, {
                        type: 'pie',
                        data: {
                            labels: ['Completed', 'Confirmed', 'Pending', 'Cancelled'],
                            datasets: [{
                                data: [
                                    analyticsData.bookingStats.CompletedBookings,
                                    analyticsData.bookingStats.ConfirmedBookings,
                                    analyticsData.bookingStats.PendingBookings,
                                    analyticsData.bookingStats.CancelledBookings
                                ],
                                backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Booking Status Distribution'
                                }
                            }
                        }
                    });

                    // Render Revenue by Service Chart (Bar Chart)
                    const revenueByServiceCanvas = document.createElement('canvas');
                    revenueByServiceCanvas.id = 'revenueByServiceChart';
                    const revenueByServiceChartContainer = document.createElement('div');
                    revenueByServiceChartContainer.className = 'chart-container';
                    revenueByServiceChartContainer.innerHTML = '<h3>Revenue by Service</h3>';
                    revenueByServiceChartContainer.appendChild(revenueByServiceCanvas);
                    container.appendChild(revenueByServiceChartContainer);

                    if (revenueByServiceChart) revenueByServiceChart.destroy();
                    revenueByServiceChart = new Chart(revenueByServiceCanvas, {
                        type: 'bar',
                        data: {
                            labels: analyticsData.revenueByService.map(s => s.ServiceName),
                            datasets: [{
                                label: 'Total Revenue ($)',
                                data: analyticsData.revenueByService.map(s => s.TotalRevenue),
                                backgroundColor: 'rgba(94, 114, 228, 0.6)'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Revenue Generated by Each Service'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Render Revenue by Month Chart (Line Chart)
                    const revenueByMonthCanvas = document.createElement('canvas');
                    revenueByMonthCanvas.id = 'revenueByMonthChart';
                    const revenueByMonthChartContainer = document.createElement('div');
                    revenueByMonthChartContainer.className = 'chart-container';
                    revenueByMonthChartContainer.innerHTML = '<h3>Monthly Revenue Trends</h3>';
                    revenueByMonthChartContainer.appendChild(revenueByMonthCanvas);
                    container.appendChild(revenueByMonthChartContainer);

                    const monthlyLabels = analyticsData.revenueByMonth.map(m => `${m.Year}-${String(m.Month).padStart(2, '0')}`);
                    const monthlyRevenue = analyticsData.revenueByMonth.map(m => m.TotalRevenue);

                    if (revenueByMonthChart) revenueByMonthChart.destroy();
                    revenueByMonthChart = new Chart(revenueByMonthCanvas, {
                        type: 'line',
                        data: {
                            labels: monthlyLabels,
                            datasets: [{
                                label: 'Total Revenue ($)',
                                data: monthlyRevenue,
                                borderColor: 'var(--primary)',
                                tension: 0.1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Revenue Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // Render Review Stats Chart (Doughnut Chart)
                    const reviewStatsCanvas = document.createElement('canvas');
                    reviewStatsCanvas.id = 'reviewStatsChart';
                    const reviewStatsChartContainer = document.createElement('div');
                    reviewStatsChartContainer.className = 'chart-container';
                    reviewStatsChartContainer.innerHTML = '<h3>Review Rating Distribution</h3>';
                    reviewStatsChartContainer.appendChild(reviewStatsCanvas);
                    container.appendChild(reviewStatsChartContainer);

                    if (reviewStatsChart) reviewStatsChart.destroy();
                    reviewStatsChart = new Chart(reviewStatsCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                            datasets: [{
                                data: [
                                    analyticsData.reviewStats.FiveStarReviews,
                                    analyticsData.reviewStats.FourStarReviews,
                                    analyticsData.reviewStats.ThreeStarReviews,
                                    analyticsData.reviewStats.TwoStarReviews,
                                    analyticsData.reviewStats.OneStarReviews
                                ],
                                backgroundColor: ['#4CAF50', '#8BC34A', '#FFEB3B', '#FF9800', '#F44336']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Customer Review Ratings'
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error('Error loading vendor analytics:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load analytics: ${error.message}</p>`;
                }
            }

            async function loadVendorProfileDetails(vendorProfileId) {
                const form = document.getElementById('vendor-profile-form');
                const inputs = {
                    businessName: document.getElementById('vendor-name'),
                    displayName: document.getElementById('vendor-display-name'),
                    category: document.getElementById('vendor-category'),
                    additionalCategories: document.getElementById('vendor-additional-categories'),
                    description: form.querySelector('#vendor-description'),
                    phone: document.getElementById('vendor-phone'),
                    email: document.getElementById('vendor-email'),
                    website: document.getElementById('vendor-website'),
                    yearsInBusiness: document.getElementById('vendor-years-in-business'),
                    tagline: document.getElementById('vendor-tagline')
                };

                // Populate category dropdown
                inputs.category.innerHTML = '<option value="">Select category</option>' +
                    state.categories.filter(c => c.id !== 'all').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                // Populate additional categories
                inputs.additionalCategories.innerHTML = state.categories
                    .filter(c => c.id !== 'all')
                    .map(c => `<option value="${c.id}">${c.name}</option>`)
                    .join('');

                for (const key in inputs) {
                    if (inputs[key] instanceof HTMLInputElement || inputs[key] instanceof HTMLTextAreaElement || inputs[key] instanceof HTMLSelectElement) {
                        inputs[key].value = 'Loading...';
                        if (inputs[key].type === 'checkbox') inputs[key].checked = false;
                    }
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/profile-details`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor profile details');
                    const profile = await response.json();

                    inputs.businessName.value = profile.BusinessName || '';
                    inputs.displayName.value = profile.DisplayName || profile.BusinessName || '';
                    inputs.description.value = profile.BusinessDescription || '';
                    inputs.phone.value = profile.BusinessPhone || '';
                    inputs.email.value = profile.BusinessEmail || '';
                    inputs.website.value = profile.Website || '';
                    inputs.yearsInBusiness.value = profile.YearsInBusiness || 0;
                    inputs.tagline.value = profile.Tagline || '';

                    // Set selected category
                    if (profile.Categories) {
                        const primaryCategory = profile.Categories.split(',')[0].trim().toLowerCase();
                        const option = Array.from(inputs.category.options).find(opt => opt.value === primaryCategory);
                        if (option) {
                            option.selected = true;
                        }
                    }

                    // Defer heavy loads to tab activation to keep settings fast
                    const photosPanel = document.getElementById('vendor-photos-panel');
                    const availabilityPanel = document.getElementById('vendor-availability-panel');
                    if (photosPanel && photosPanel.classList.contains('active')) {
                        await loadVendorImages(vendorProfileId);
                    }
                    if (availabilityPanel && availabilityPanel.classList.contains('active')) {
                        await loadVendorAvailability(vendorProfileId);
                    }

                } catch (error) {
                    console.error('Error loading vendor profile details:', error);
                    for (const key in inputs) {
                        if (inputs[key] instanceof HTMLInputElement || inputs[key] instanceof HTMLTextAreaElement || inputs[key] instanceof HTMLSelectElement) {
                            inputs[key].value = 'Error';
                        }
                    }
                    alert('Failed to load vendor profile details: ' + error.message);
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        // Basic validation to satisfy deployed API requirements
                        const name = inputs.businessName.value?.trim();
                        const display = inputs.displayName.value?.trim() || name;
                        const email = inputs.email.value?.trim();
                        const phone = inputs.phone.value?.trim();
                        const website = inputs.website.value?.trim();
                        const description = inputs.description.value?.trim();
                        const tagline = inputs.tagline.value?.trim();
                        const years = inputs.yearsInBusiness.value ? parseInt(inputs.yearsInBusiness.value, 10) : null;
                        const primaryCategory = inputs.category.value?.trim();
                        const additionalCategories = Array.from(inputs.additionalCategories.selectedOptions)
                            .map(o => o.value)
                            .filter(v => v && v !== primaryCategory);

                        if (!name || !email || !phone || !primaryCategory) {
                            alert('Please fill in Business Name, Email, Phone, and Category.');
                            return;
                        }
                        // Compatibility: remote API currently requires a non-empty description
                        if (!description) {
                            alert('Please enter a brief business description.');
                            inputs.description?.focus();
                            return;
                        }

                        const payload = {
                            vendorProfileId: vendorProfileId,
                            businessName: name,
                            displayName: display,
                            businessEmail: email,
                            businessPhone: phone,
                            website: website,
                            businessDescription: description,
                            tagline: tagline,
                            yearsInBusiness: years,
                            primaryCategory: primaryCategory,
                            additionalCategories: additionalCategories
                        };

                        const response = await fetch(`${API_BASE_URL}/vendors/setup/step1-business-basics`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to update vendor profile');
                        }
                        alert('Vendor profile updated successfully!');
                        await refreshVendorSetupCard();
                    } catch (error) {
                        console.error('Error updating vendor profile:', error);
                        alert('Failed to update vendor profile: ' + error.message);
                    }
                };
            }

            async function loadVendorImages(vendorProfileId) {
                const container = document.getElementById('vendor-photos');
                container.innerHTML = '<p>Loading photos...</p>';
                try {
                    // Resolve vendorProfileId if not provided
                    if (!vendorProfileId) {
                        try {
                            vendorProfileId = currentUser?.vendorProfileId || (typeof getVendorProfileId === 'function' ? await getVendorProfileId() : null);
                        } catch (_) { vendorProfileId = null; }
                    }
                    if (!vendorProfileId) throw new Error('Missing vendor profile ID');

                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/images`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch vendor images');
                    const images = await response.json();
                    renderVendorImages(images, container);
                } catch (error) {
                    console.error('Error loading vendor images:', error);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load photos: ${error.message}</p>`;
                }
            }

            function renderVendorImages(images, container) {
                container.innerHTML = '';
                if (images && images.length > 0) {
                    images.forEach(img => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.width = '100%';
                        imgDiv.style.height = '100px';
                        imgDiv.style.borderRadius = 'var(--radius)';
                        imgDiv.style.overflow = 'hidden';
                        imgDiv.style.position = 'relative';
                        imgDiv.innerHTML = `
                            <img src="${img.ImageURL}" alt="${img.Caption || 'Vendor Image'}" style="width:100%;height:100%;object-fit:cover;">
                            ${img.IsPrimary ? '<span style="position:absolute;top:5px;left:5px;background-color:var(--primary);color:white;padding:3px 8px;border-radius:10px;font-size:0.7rem;">Primary</span>' : ''}
                            <button class="btn btn-sm" style="position:absolute;bottom:5px;right:5px;background-color:rgba(255,255,255,0.8);border:none;color:var(--accent);" data-image-id="${img.ImageID}">Delete</button>
                        `;
                        container.appendChild(imgDiv);
                        imgDiv.querySelector('button').addEventListener('click', async () => {
                            if (confirm('Are you sure you want to delete this image?')) {
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.vendorProfileId}/images/${img.ImageID}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to delete image');
                                    alert('Image deleted successfully!');
                                    await refreshVendorSetupCard();
                                    loadVendorImages(currentUser.vendorProfileId);
                                } catch (error) {
                                    console.error('Error deleting image:', error);
                                    alert('Failed to delete image: ' + error.message);
                                }
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<p>No photos uploaded.</p>';
                }

                // Handle upload photos button
                document.getElementById('upload-photos-btn').onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.multiple = true;
                    input.onchange = async (e) => {
                        const files = Array.from(e.target.files || []);
                        if (!files.length) return;

                        const btn = document.getElementById('upload-photos-btn');
                        const originalText = btn ? btn.textContent : '';
                        if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }

                        try {
                            // 1) Try batch upload endpoint
                            let uploadedUrls = [];
                            try {
                                const fd = new FormData();
                                files.forEach(f => fd.append('images', f));
                                const resp = await fetch(`${API_BASE_URL}/upload/images`, { method: 'POST', body: fd });
                                if (resp.ok) {
                                    const data = await resp.json();
                                    uploadedUrls = (data.data || []).map(d => d.url).filter(Boolean);
                                } else {
                                    throw new Error('Batch upload failed');
                                }
                            } catch (batchErr) {
                                // 2) Fallback to single-file uploads
                                uploadedUrls = [];
                                for (const f of files) {
                                    const url = await uploadImageToCloudinary(f, 'gallery');
                                    if (url) uploadedUrls.push(url);
                                }
                            }

                            if (!uploadedUrls.length) throw new Error('No images were uploaded');

                            // 3) Persist each uploaded image to vendor images table
                            // Resolve vendorProfileId securely
                            let vpid = currentUser?.vendorProfileId;
                            if (!vpid && typeof getVendorProfileId === 'function') {
                                try { vpid = await getVendorProfileId(); } catch (_) { vpid = null; }
                            }
                            if (!vpid) throw new Error('Missing vendor profile ID (are you logged in as a vendor?)');
                            const hadImages = Array.isArray(images) && images.length > 0;
                            for (let i = 0; i < uploadedUrls.length; i++) {
                                const payload = {
                                    imageId: null,
                                    imageUrl: uploadedUrls[i],
                                    isPrimary: (!hadImages && i === 0) ? true : false,
                                    caption: files[i]?.name || null,
                                    displayOrder: (images?.length || 0) + i
                                };
                                const upsertRes = await fetch(`${API_BASE_URL}/vendor/${vpid}/images/upsert`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                                    },
                                    body: JSON.stringify(payload)
                                });
                                if (!upsertRes.ok) {
                                    const errData = await upsertRes.json().catch(() => ({}));
                                    throw new Error(errData.message || 'Failed to save image');
                                }
                            }

                            // 4) Refresh UI
                            await loadVendorImages(vpid);
                            await refreshVendorSetupCard();
                        } catch (err) {
                            console.error('Upload images error:', err);
                            alert('Failed to upload images: ' + err.message);
                        } finally {
                            if (btn) { btn.disabled = false; btn.textContent = originalText; }
                        }
                    };
                    input.click();
                };

                // Add image by URL handler
                const addUrlBtn = document.getElementById('add-photo-url-btn');
                if (addUrlBtn) {
                    addUrlBtn.onclick = async () => {
                        try {
                            const urlInput = document.getElementById('image-url-input');
                            const captionInput = document.getElementById('image-caption-input');
                            const primaryCheckbox = document.getElementById('image-primary-checkbox');
                            const imageUrl = urlInput?.value?.trim();
                            if (!imageUrl) {
                                alert('Please enter an image URL');
                                return;
                            }
                            // Resolve vendorProfileId securely
                            let vpid = currentUser?.vendorProfileId;
                            if (!vpid && typeof getVendorProfileId === 'function') {
                                try { vpid = await getVendorProfileId(); } catch (_) { vpid = null; }
                            }
                            if (!vpid) throw new Error('Missing vendor profile ID (are you logged in as a vendor?)');
                            const payload = {
                                imageUrl,
                                caption: captionInput?.value?.trim() || null,
                                isPrimary: !!primaryCheckbox?.checked,
                                displayOrder: 0
                            };
                            const resp = await fetch(`${API_BASE_URL}/vendor/${vpid}/images/upsert`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                                body: JSON.stringify(payload)
                            });
                            if (!resp.ok) throw new Error('Failed to add image');
                            if (urlInput) urlInput.value = '';
                            if (captionInput) captionInput.value = '';
                            if (primaryCheckbox) primaryCheckbox.checked = false;
                            await loadVendorImages(vpid);
                            await refreshVendorSetupCard();
                        } catch (err) {
                            console.error('Add image by URL error:', err);
                            alert('Failed to add image: ' + err.message);
                        }
                    };
                }
            }

            async function loadVendorAvailability(vendorProfileId) {
                const calendarEl = document.getElementById('vendor-availability-calendar');
                let lastBusinessHours = [];

                // Ensure we have a VendorProfileID; fall back to currentUser or status endpoint if needed
                try {
                    if (!vendorProfileId) {
                        if (currentUser?.vendorProfileId) {
                            vendorProfileId = currentUser.vendorProfileId;
                        } else if (typeof getVendorProfileId === 'function') {
                            vendorProfileId = await getVendorProfileId();
                        }
                    }
                } catch (e) {
                    console.warn('Could not determine vendorProfileId for availability:', e);
                }
                console.debug('loadVendorAvailability()', { vendorProfileId, url: `${API_BASE_URL}/vendor/${vendorProfileId}/availability` });

                // If we still don't have a valid vendorProfileId, skip API fetch; UI will render defaults below
                // (no user-facing error message here to keep the panel clean)

                // Destroy existing calendar instance if it exists
                if (calendarEl && calendarEl._fullCalendar) {
                    calendarEl._fullCalendar.destroy();
                    calendarEl._fullCalendar = null;
                }

                try {
                    if (vendorProfileId) {
                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/availability`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!response.ok) {
                        let serverMsg = '';
                        try { serverMsg = (await response.json())?.message || ''; } catch {}
                        const msg = serverMsg || `HTTP ${response.status}`;
                        throw new Error(`Failed to fetch vendor availability (${msg})`);
                    }
                    const data = await response.json();
                    const businessHours = data.businessHours || [];
                    const exceptions = data.availabilityExceptions || [];
                    lastBusinessHours = businessHours;

                    const events = [];

                    // Add business hours as recurring events
                    businessHours.forEach(bh => {
                        if (bh.IsAvailable) {
                            events.push({
                                daysOfWeek: [bh.DayOfWeek],
                                startTime: bh.OpenTime,
                                endTime: bh.CloseTime,
                                display: 'background',
                                color: '#d1fae5'
                            });
                        } else {
                            events.push({
                                daysOfWeek: [bh.DayOfWeek],
                                display: 'background',
                                color: '#fee2e2'
                            });
                        }
                    });

                    // Add exceptions
                    exceptions.forEach(ex => {
                        events.push({
                            start: ex.StartDate + (ex.StartTime ? 'T' + ex.StartTime : ''),
                            end: ex.EndDate + (ex.EndTime ? 'T' + ex.EndTime : ''),
                            title: ex.Reason || (ex.IsAvailable ? 'Available' : 'Unavailable'),
                            color: ex.IsAvailable ? '#2196F3' : '#F44336',
                            allDay: !ex.StartTime && !ex.EndTime,
                            extendedProps: {
                                exceptionId: ex.ExceptionID,
                                isAvailable: ex.IsAvailable,
                                reason: ex.Reason
                            }
                        });
                    });

                    if (calendarEl) {
                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        events: events,
                        selectable: true,
                        editable: true,
                        eventClick: function(info) {
                            const ex = info.event.extendedProps;
                            alert(`Exception: ${ex.reason || 'N/A'}\nAvailable: ${ex.isAvailable ? 'Yes' : 'No'}\nID: ${ex.exceptionId}`);
                        },
                        select: function(info) {
                            const reason = prompt('Reason for availability exception (e.g., "Holiday", "Closed for Maintenance")');
                            if (reason) {
                                const isAvailable = confirm('Is the vendor available during this exception? (OK for Yes, Cancel for No)');
                                upsertVendorAvailabilityException(
                                    null,
                                    info.startStr.split('T')[0],
                                    info.endStr.split('T')[0],
                                    null,
                                    null,
                                    isAvailable,
                                    reason
                                );
                            }
                        }
                    });
                    calendar.render();
                    calendarEl._fullCalendar = calendar;
                    }

                }
                } catch (error) {
                    console.error('Error loading vendor availability:', error);
                    // Calendar UI has been removed from Availability settings.
                    // We simply log the error; the Business Hours UI will still render below with defaults.
                }

                // Render and save Business Hours
                try {
                    const bhContainer = document.getElementById('business-hours-container');
                    if (bhContainer) {
                        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                        const byDay = {};
                        // Re-fetch or reuse businessHours if available in outer scope
                        // businessHours is defined above in try block
                        // For safety, if not available, initialize empty
                        const existing = Array.isArray(lastBusinessHours) ? lastBusinessHours : [];
                        existing.forEach(bh => { byDay[bh.DayOfWeek] = bh; });
                        bhContainer.innerHTML = '';
                        days.forEach((day, idx) => {
                            const bh = byDay[idx] || { HoursID: null, DayOfWeek: idx, OpenTime: '09:00:00', CloseTime: '17:00:00', IsAvailable: false };
                            const row = document.createElement('div');
                            row.className = 'form-row';
                            row.dataset.day = String(idx);
                            row.dataset.hoursId = bh.HoursID || '';
                            const openVal = (bh.OpenTime || '09:00:00').slice(0,5);
                            const closeVal = (bh.CloseTime || '17:00:00').slice(0,5);
                            row.innerHTML = `
                                <div class="form-col"><div class="form-group"><label>${day}</label><input type="checkbox" class="bh-available" ${bh.IsAvailable ? 'checked' : ''}> Available</div></div>
                                <div class="form-col"><div class="form-group"><label>Open</label><input type="time" class="bh-open" value="${openVal}"></div></div>
                                <div class="form-col"><div class="form-group"><label>Close</label><input type="time" class="bh-close" value="${closeVal}"></div></div>
                            `;
                            bhContainer.appendChild(row);
                        });

                        const saveHoursBtn = document.getElementById('save-business-hours-btn');
                        if (saveHoursBtn) {
                            saveHoursBtn.onclick = async () => {
                                try {
                                    const resolvedVendorId = vendorProfileId || (currentUser?.vendorProfileId) || (typeof getVendorProfileId === 'function' ? await getVendorProfileId() : null);
                                    if (!resolvedVendorId) {
                                        alert('Cannot save: missing vendor profile ID');
                                        return;
                                    }
                                    const rows = Array.from(bhContainer.querySelectorAll('.form-row'));
                                    for (const row of rows) {
                                        const dayOfWeek = parseInt(row.dataset.day, 10);
                                        const hoursId = row.dataset.hoursId ? parseInt(row.dataset.hoursId, 10) : null;
                                        const isAvailable = row.querySelector('.bh-available')?.checked || false;
                                        const openRaw = (row.querySelector('.bh-open')?.value || '').trim();
                                        const closeRaw = (row.querySelector('.bh-close')?.value || '').trim();

                                        let openTime = null;
                                        let closeTime = null;
                                        if (isAvailable) {
                                            const timeRe = /^\d{2}:\d{2}$/;
                                            if (!timeRe.test(openRaw) || !timeRe.test(closeRaw)) {
                                                throw new Error(`Please enter valid times (HH:mm) for ${days[dayOfWeek]}`);
                                            }
                                            const [oh, om] = openRaw.split(':').map(n => parseInt(n, 10));
                                            const [ch, cm] = closeRaw.split(':').map(n => parseInt(n, 10));
                                            const oMin = oh * 60 + om;
                                            const cMin = ch * 60 + cm;
                                            if (oMin >= cMin) {
                                                throw new Error(`Open time must be earlier than close time for ${days[dayOfWeek]}`);
                                            }
                                            openTime = `${openRaw}:00`;
                                            closeTime = `${closeRaw}:00`;
                                        }

                                        const payload = { hoursId, dayOfWeek, openTime, closeTime, isAvailable };
                                        const resp = await fetch(`${API_BASE_URL}/vendor/${resolvedVendorId}/business-hours/upsert`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                                            body: JSON.stringify(payload)
                                        });
                                        if (!resp.ok) throw new Error('Failed to save hours for ' + days[dayOfWeek]);
                                    }
                                    alert('Business hours saved');
                                    await loadVendorAvailability(resolvedVendorId);
                                } catch (err) {
                                    console.error('Save business hours error:', err);
                                    alert('Failed to save business hours: ' + err.message);
                                }
                            };
                        }
                    }
                } catch (err) {
                    console.error('Render business hours UI error:', err);
                }
            }

            async function upsertVendorAvailabilityException(exceptionId, startDate, endDate, startTime, endTime, isAvailable, reason) {
                try {
                    const payload = {
                        exceptionId: exceptionId,
                        startDate: startDate,
                        endDate: endDate,
                        startTime: startTime,
                        endTime: endTime,
                        isAvailable: isAvailable,
                        reason: reason
                    };
                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.vendorProfileId}/availability-exceptions/upsert`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to upsert availability exception');
                    }
                    alert('Availability exception saved successfully!');
                    await refreshVendorSetupCard();
                    loadVendorAvailability(currentUser.vendorProfileId);
                } catch (error) {
                    console.error('Error upserting availability exception:', error);
                    alert('Failed to save availability exception: ' + error.message);
                }
            }

            // Load and Save: Location
            async function loadVendorLocation(vendorProfileId) {
                const form = document.getElementById('vendor-location-form');
                const inputs = {
                    address: document.getElementById('loc-address'),
                    city: document.getElementById('loc-city'),
                    state: document.getElementById('loc-state'),
                    country: document.getElementById('loc-country'),
                    postal: document.getElementById('loc-postal'),
                    lat: document.getElementById('loc-lat'),
                    lng: document.getElementById('loc-lng'),
                };
                const areasListEl = document.getElementById('service-areas-list');
                const areaInputEl = document.getElementById('service-area-input');
                const addAreaBtn = document.getElementById('add-service-area-btn');
                const areasState = { list: [] };

                function renderAreas() {
                    if (!areasListEl) return;
                    areasListEl.innerHTML = '';
                    areasState.list.forEach((area, idx) => {
                        const tag = document.createElement('span');
                        tag.style.display = 'inline-flex';
                        tag.style.alignItems = 'center';
                        tag.style.gap = '6px';
                        tag.style.background = 'var(--muted)';
                        tag.style.border = '1px solid var(--border)';
                        tag.style.padding = '4px 8px';
                        tag.style.borderRadius = '9999px';
                        const label = [area.city, area.province || area.state, area.country].filter(Boolean).join(', ');
                        tag.innerHTML = `${label} <button type="button" aria-label="Remove" style="border:none;background:transparent;color:var(--accent);cursor:pointer;">×</button>`;
                        tag.querySelector('button').onclick = () => {
                            areasState.list.splice(idx, 1);
                            renderAreas();
                        };
                        areasListEl.appendChild(tag);
                    });
                }

                // Initialize Google Places Autocomplete for Location panel
                try {
                    await loadGoogleMapsIfNeeded();
                    if (window.google && window.google.maps && window.google.maps.places) {
                        // Address Autocomplete (fills city/province/country/postal and lat/lng)
                        if (inputs.address) {
                            const addrAuto = new google.maps.places.Autocomplete(inputs.address, {
                                fields: ['address_components','geometry','formatted_address','place_id','types'],
                                types: ['address'],
                                componentRestrictions: { country: ['ca'] }
                            });
                            addrAuto.addListener('place_changed', () => {
                                const place = addrAuto.getPlace();
                                if (!place || !place.address_components) return;
                                inputs.address.value = place.formatted_address || inputs.address.value;
                                const comps = place.address_components;
                                const pick = (t) => comps.find(c => c.types.includes(t))?.long_name || '';
                                const city = pick('locality') || pick('sublocality') || pick('postal_town') || pick('administrative_area_level_3') || '';
                                const province = pick('administrative_area_level_1') || '';
                                const country = pick('country') || '';
                                const postal = pick('postal_code') || '';
                                if (inputs.city) inputs.city.value = city;
                                if (inputs.state) inputs.state.value = province;
                                if (inputs.country) inputs.country.value = country;
                                if (inputs.postal) inputs.postal.value = postal;
                                const loc = place.geometry?.location;
                                if (loc) {
                                    if (inputs.lat) inputs.lat.value = (typeof loc.lat === 'function') ? loc.lat() : loc.lat;
                                    if (inputs.lng) inputs.lng.value = (typeof loc.lng === 'function') ? loc.lng() : loc.lng;
                                }
                            });
                        }

                        // Helper to check duplicate areas
                        const areaExists = (a) => areasState.list.some(x =>
                            (a.placeId && x.placeId && a.placeId === x.placeId) ||
                            (
                                (x.city || '').toLowerCase() === (a.city || '').toLowerCase() &&
                                (x.province || x.state || '').toLowerCase() === (a.province || a.state || '').toLowerCase() &&
                                (x.country || '').toLowerCase() === (a.country || '').toLowerCase()
                            )
                        );

                        // Service Area Autocomplete (cities)
                        if (areaInputEl) {
                            const cityAuto = new google.maps.places.Autocomplete(areaInputEl, {
                                fields: ['address_components','geometry','formatted_address','place_id','types'],
                                types: ['(cities)'],
                                componentRestrictions: { country: ['ca'] }
                            });
                            cityAuto.addListener('place_changed', () => {
                                const place = cityAuto.getPlace();
                                if (!place || !place.address_components) return;
                                const comps = place.address_components;
                                const pick = (t) => comps.find(c => c.types.includes(t))?.long_name || '';
                                const city = pick('locality') || pick('postal_town') || pick('administrative_area_level_3') || '';
                                const province = pick('administrative_area_level_1') || '';
                                const country = pick('country') || (inputs.country?.value || '') || '';
                                const loc = place.geometry?.location;
                                const newArea = {
                                    placeId: place.place_id || null,
                                    city,
                                    province,
                                    country,
                                    latitude: loc ? ((typeof loc.lat === 'function') ? loc.lat() : loc.lat) : null,
                                    longitude: loc ? ((typeof loc.lng === 'function') ? loc.lng() : loc.lng) : null,
                                    formattedAddress: place.formatted_address || [city, province, country].filter(Boolean).join(', '),
                                    placeType: Array.isArray(place.types) ? place.types[0] : 'locality',
                                    serviceRadius: 25.0
                                };
                                if (!areaExists(newArea)) {
                                    areasState.list.push(newArea);
                                    renderAreas();
                                }
                                areaInputEl.value = '';
                            });
                        }
                    }
                } catch (e) {
                    console.warn('Google Maps not available:', e);
                }

                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/location`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!res.ok) throw new Error('Failed to load location');
                    const data = await res.json();
                    const loc = data.location || {};
                    inputs.address.value = loc.Address || '';
                    inputs.city.value = loc.City || '';
                    inputs.state.value = loc.State || '';
                    inputs.country.value = loc.Country || '';
                    inputs.postal.value = loc.PostalCode || '';
                    inputs.lat.value = loc.Latitude || '';
                    inputs.lng.value = loc.Longitude || '';

                    // Initialize service areas
                    areasState.list = (data.serviceAreas || []).map(a => ({
                        placeId: a.GooglePlaceID || null,
                        city: a.CityName || '',
                        province: a.StateProvince || '',
                        country: a.Country || (inputs.country.value || ''),
                        latitude: a.Latitude ?? null,
                        longitude: a.Longitude ?? null,
                        serviceRadius: a.ServiceRadius ?? 25.0,
                        formattedAddress: a.FormattedAddress || null,
                        placeType: a.PlaceType || null,
                        postalCode: a.PostalCode || null,
                        travelCost: a.TravelCost ?? null,
                        minimumBookingAmount: a.MinimumBookingAmount ?? null
                    }));
                    renderAreas();
                } catch (err) {
                    console.error('Error loading location:', err);
                }

                if (addAreaBtn) {
                    addAreaBtn.onclick = () => {
                        const raw = areaInputEl?.value?.trim();
                        if (!raw) return;
                        const parts = raw.split(',').map(s => s.trim()).filter(Boolean);
                        const city = parts[0] || raw;
                        const province = parts[1] || inputs.state.value || '';
                        const country = inputs.country.value || 'Canada';
                        areasState.list.push({ city, province, country, serviceRadius: 25.0 });
                        areaInputEl.value = '';
                        renderAreas();
                    };
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const payload = {
                            address: inputs.address.value?.trim(),
                            city: inputs.city.value?.trim(),
                            state: inputs.state.value?.trim(),
                            country: inputs.country.value?.trim(),
                            postalCode: inputs.postal.value?.trim(),
                            latitude: inputs.lat.value || null,
                            longitude: inputs.lng.value || null,
                            serviceAreas: areasState.list
                        };
                        const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/location`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) {
                            const errData = await res.json();
                            throw new Error(errData.message || 'Failed to save location');
                        }
                        alert('Location saved');
                        await refreshVendorSetupCard();
                    } catch (err) {
                        console.error('Save location error:', err);
                        alert('Failed to save location: ' + err.message);
                    }
                };
            }

            // Load: Additional Details (category questions + existing answers)
            async function loadVendorAdditionalDetails(vendorProfileId) {
                const container = document.getElementById('additional-questions-container');
                container.innerHTML = '<p>Loading questions...</p>';
                try {
                    // Get vendor primary category from profile details
                    const profileRes = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/profile-details`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!profileRes.ok) throw new Error('Failed to fetch profile for category');
                    const profile = await profileRes.json();
                    const primaryCategory = (profile.Categories || '').split(',')[0]?.trim().toLowerCase();

                    // Load questions by category
                    const qRes = await fetch(`${API_BASE_URL}/vendors/category-questions/${encodeURIComponent(primaryCategory)}`);
                    const qData = await qRes.json();
                    const questions = qData?.questions || [];

                    // Load existing answers
                    const aRes = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/category-answers`);
                    const aData = await aRes.json();
                    const answers = aData?.answers || [];

                    // Normalize answers into a map keyed by stringified QuestionID/QuestionId
                    const answerMap = new Map();
                    answers.forEach(a => {
                        const key = (a.QuestionID ?? a.QuestionId ?? a.QuestionID)?.toString();
                        if (key) {
                            const val = a.Answer ?? a.AnswerValue ?? a.Value ?? a.Response ?? null;
                            answerMap.set(key, val);
                        }
                    });
                    if (questions.length === 0) {
                        container.innerHTML = '<p>No additional questions for your category.</p>';
                        return;
                    }
                    const formHtml = questions.map(q => {
                        const qId = (q.QuestionID ?? q.QuestionId ?? q.ID ?? q.Id ?? q.QID);
                        const qIdStr = qId != null ? String(qId) : String(q.QuestionID);
                        const qText = q.QuestionText ?? q.Question ?? q.Text ?? q.Prompt ?? 'Question';
                        const typeCandidates = [
                            q.QuestionType, q.Type, q.AnswerType, q.InputType, q.ResponseType, q.Format, q.QuestionFormat
                        ].map(v => (v ? String(v).toLowerCase() : ''));
                        const flagCandidates = [q.IsBoolean, q.IsBool, q.IsYesNo, q.YesNo];
                        const isBoolFlag = flagCandidates.some(v => {
                            const s = String(v).toLowerCase();
                            return s === '1' || s === 'true' || s === 'yes' || s === 'y';
                        });
                        const isBoolType = typeCandidates.some(t =>
                            t.includes('boolean') || t.includes('bool') || t.includes('yes_no') || t.includes('yes/no') || t.includes('yes no') || t.includes('yesno') || t === 'yn' || t === 'y/n' || t.includes('bit') || t.includes('radio') || t.includes('switch') || t.includes('toggle')
                        );
                        // Extract options if present and see if they are Yes/No
                        function getOptionsArray(o) {
                            if (!o) return [];
                            if (Array.isArray(o)) return o.map(x => String(x));
                            try {
                                const parsed = JSON.parse(o);
                                if (Array.isArray(parsed)) return parsed.map(x => String(x));
                            } catch {}
                            const s = String(o);
                            if (/[\|,;]/.test(s)) return s.split(/[\|,;]+/).map(x => x.trim());
                            return [s];
                        }
                        const options = [
                            ...getOptionsArray(q.Options),
                            ...getOptionsArray(q.OptionsJSON),
                            ...getOptionsArray(q.OptionList)
                        ].map(x => x.toLowerCase());
                        const hasYesNoOptions = options.includes('yes') && options.includes('no');
                        const textLower = String(q.QuestionText || '').toLowerCase();
                        const isYesNoInText = textLower.includes('yes/no') || textLower.includes('yes or no') || textLower.includes('(yes/no)') || textLower.includes('y/n');
                        const isBoolean = isBoolFlag || isBoolType || hasYesNoOptions || isYesNoInText;

                        const rawAns = answerMap.get(qIdStr);
                        const ansStr = (() => {
                            if (typeof rawAns === 'string') return rawAns;
                            if (rawAns === true || rawAns === 1) return 'Yes';
                            if (rawAns === false || rawAns === 0) return 'No';
                            return '';
                        })();
                        try { console.debug('AdditionalDetails detect', { id: qIdStr, text: qText, typeCandidates, options, isBoolean }); } catch {}
                        const yesChecked = ansStr && ['yes','true','y','1'].includes(String(ansStr).toLowerCase());
                        const noChecked = ansStr && ['no','false','n','0'].includes(String(ansStr).toLowerCase());
                        if (isBoolean) {
                            return `
                                <div class="form-group">
                                    <label style="display:block;margin-bottom:.25rem;">${qText}</label>
                                    <div style="display:flex;gap:1rem;align-items:center;">
                                        <label style="display:flex;gap:.4rem;align-items:center;"><input type="radio" name="ad-q-${qIdStr}" value="Yes" ${yesChecked ? 'checked' : ''}> Yes</label>
                                        <label style="display:flex;gap:.4rem;align-items:center;"><input type="radio" name="ad-q-${qIdStr}" value="No" ${noChecked ? 'checked' : ''}> No</label>
                                    </div>
                                </div>
                            `;
                        }
                        return `
                            <div class="form-group">
                                <label>${q.QuestionText}</label>
                                <textarea data-question-id="${q.QuestionID}" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);">${ansStr || ''}</textarea>
                            </div>
                        `;
                    }).join('');
                    container.innerHTML = formHtml;

                    const form = document.getElementById('vendor-additional-details-form');
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        try {
                            const compiled = questions.map(q => {
                                const qId = (q.QuestionID ?? q.QuestionId ?? q.ID ?? q.Id ?? q.QID);
                                const qIdStr = qId != null ? String(qId) : String(q.QuestionID);
                                const typeCandidates = [
                                    q.QuestionType, q.Type, q.AnswerType, q.InputType, q.ResponseType, q.Format, q.QuestionFormat
                                ].map(v => (v ? String(v).toLowerCase() : ''));
                                const flagCandidates = [q.IsBoolean, q.IsBool, q.IsYesNo, q.YesNo];
                                const isBoolFlag = flagCandidates.some(v => {
                                    const s = String(v).toLowerCase();
                                    return s === '1' || s === 'true' || s === 'yes' || s === 'y';
                                });
                                const isBoolType = typeCandidates.some(t =>
                                    t.includes('boolean') || t.includes('bool') || t.includes('yes_no') || t.includes('yes/no') || t.includes('yes no') || t.includes('yesno') || t === 'yn' || t === 'y/n' || t.includes('bit') || t.includes('radio') || t.includes('switch') || t.includes('toggle')
                                );
                                function getOptionsArray(o) {
                                    if (!o) return [];
                                    if (Array.isArray(o)) return o.map(x => String(x));
                                    try {
                                        const parsed = JSON.parse(o);
                                        if (Array.isArray(parsed)) return parsed.map(x => String(x));
                                    } catch {}
                                    const s = String(o);
                                    if (/[\|,;]/.test(s)) return s.split(/[\|,;]+/).map(x => x.trim());
                                    return [s];
                                }
                                const options = [
                                    ...getOptionsArray(q.Options),
                                    ...getOptionsArray(q.OptionsJSON),
                                    ...getOptionsArray(q.OptionList)
                                ].map(x => x.toLowerCase());
                                const hasYesNoOptions = options.includes('yes') && options.includes('no');
                                const textLower = String(q.QuestionText || '').toLowerCase();
                                const isYesNoInText = textLower.includes('yes/no') || textLower.includes('yes or no') || textLower.includes('(yes/no)') || textLower.includes('y/n');
                                const isBoolean = isBoolFlag || isBoolType || hasYesNoOptions || isYesNoInText;

                                if (isBoolean) {
                                    const val = container.querySelector(`input[name="ad-q-${qIdStr}"]:checked`)?.value || '';
                                    return { questionId: qId, answer: val };
                                }
                                const t = container.querySelector(`textarea[data-question-id="${qIdStr}"]`);
                                return { questionId: qId, answer: t?.value?.trim() || '' };
                            }).filter(a => a && String(a.answer).length > 0);

                            const payload = { answers: compiled };
                            const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/category-answers/upsert`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                                body: JSON.stringify(payload)
                            });
                            if (!res.ok) throw new Error('Failed to save answers');
                            alert('Additional details saved');
                        } catch (err) {
                            console.error('Save additional details error:', err);
                            alert('Failed to save: ' + err.message);
                        }
                    };
                } catch (err) {
                    console.error('Load additional details error:', err);
                    container.innerHTML = `<p style="color:var(--accent);">Failed to load additional details: ${err.message}</p>`;
                }
            }

            // Load & Save: Social
            async function loadVendorSocial(vendorProfileId) {
                const form = document.getElementById('vendor-social-form');
                const inputs = {
                    bookingLink: document.getElementById('booking-link'),
                    fb: document.getElementById('social-facebook-settings'),
                    ig: document.getElementById('social-instagram-settings'),
                    tw: document.getElementById('social-twitter-settings'),
                    li: document.getElementById('social-linkedin-settings'),
                    yt: document.getElementById('social-youtube-settings'),
                    tk: document.getElementById('social-tiktok-settings'),
                };
                // Helpers to convert full URLs to handles and back using the data-prefix
                function stripProtoWww(s) {
                    return String(s || '').replace(/^https?:\/\//i, '').replace(/^www\./i, '');
                }
                function toHandle(url, prefix) {
                    if (!url) return '';
                    const u = String(url).trim();
                    const p = String(prefix || '').trim();
                    const uStripped = stripProtoWww(u);
                    const pStripped = stripProtoWww(p);
                    const uLower = uStripped.toLowerCase();
                    const pLower = pStripped.toLowerCase();
                    // Prefer exact prefix match (includes path like 'linkedin.com/in/' or 'tiktok.com/@')
                    if (pLower && uLower.startsWith(pLower)) {
                        return uStripped.slice(pStripped.length).replace(/^\/+/, '').replace(/^@/, '');
                    }
                    // Fallback: match domain only
                    const domain = pStripped.split('/')[0]; // e.g., 'instagram.com'
                    if (domain && uLower.startsWith(domain.toLowerCase() + '/')) {
                        const remainder = uStripped.slice(domain.length + 1);
                        // Drop common path prefixes if present
                        return remainder.replace(/^(in\/|@)/, '');
                    }
                    // Last resort: try URL API
                    try {
                        const parsed = new URL(u);
                        const hostPath = `${parsed.host}${parsed.pathname}`.replace(/^www\./i, '');
                        if (pLower && hostPath.toLowerCase().startsWith(pLower)) {
                            return hostPath.slice(pStripped.length).replace(/^\/+/, '').replace(/^@/, '');
                        }
                        if (domain && hostPath.toLowerCase().startsWith(domain.toLowerCase() + '/')) {
                            return hostPath.slice(domain.length + 1).replace(/^(in\/|@)/, '');
                        }
                    } catch {}
                    return u; // Unknown format; show as-is
                }
                function toUrl(handle, prefix) {
                    const h = String(handle || '').trim();
                    if (!h) return '';
                    if (/^https?:\/\//i.test(h)) return h; // user pasted a full URL
                    const p = String(prefix || '').trim();
                    // Remove leading slashes or '@' in handle; prefix will include these if needed
                    const clean = h.replace(/^\/+/, '').replace(/^@/, '');
                    return p ? (p.endsWith('/') || p.endsWith('@') ? p + clean : p + '/' + clean) : clean;
                }
                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/social`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        inputs.bookingLink.value = data?.bookingLink || '';
                        const profiles = data?.socialMediaProfiles || [];
                        const map = new Map(profiles.map(p => [String(p.Platform || p.platform).toLowerCase(), p.URL || p.url]));
                        inputs.fb.value = toHandle(map.get('facebook') || '', inputs.fb.dataset.prefix);
                        inputs.ig.value = toHandle(map.get('instagram') || '', inputs.ig.dataset.prefix);
                        inputs.tw.value = toHandle(map.get('twitter') || '', inputs.tw.dataset.prefix);
                        inputs.li.value = toHandle(map.get('linkedin') || '', inputs.li.dataset.prefix);
                        inputs.yt.value = toHandle(map.get('youtube') || '', inputs.yt.dataset.prefix);
                        inputs.tk.value = toHandle(map.get('tiktok') || '', inputs.tk.dataset.prefix);
                    }
                } catch (err) {
                    console.error('Load social error:', err);
                }

                form.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const entries = [
                            ['Facebook', inputs.fb],
                            ['Instagram', inputs.ig],
                            ['Twitter', inputs.tw],
                            ['LinkedIn', inputs.li],
                            ['YouTube', inputs.yt],
                            ['TikTok', inputs.tk]
                        ];
                        const profiles = entries.map(([platform, el]) => {
                            const handle = el.value?.trim();
                            const url = toUrl(handle, el.dataset.prefix);
                            return { platform, url };
                        }).filter(p => p.url);
                        const payload = {
                            bookingLink: inputs.bookingLink.value?.trim(),
                            socialMediaProfiles: profiles
                        };
                        const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/social`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error('Failed to save social');
                        alert('Social saved');
                        await refreshVendorSetupCard();
                    } catch (err) {
                        console.error('Save social error:', err);
                        alert('Failed to save social: ' + err.message);
                    }
                };
            }

            // Load & Save: FAQs
            async function loadVendorFaqs(vendorProfileId) {
                const list = document.getElementById('faqs-list');
                const addBtn = document.getElementById('add-faq-btn');
                const saveBtn = document.getElementById('save-faqs-btn');
                list.innerHTML = '<p>Loading FAQs...</p>';
                try {
                    const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/faqs`);
                    if (!res.ok) throw new Error('Failed to load FAQs');
                    const data = await res.json();
                    const faqs = data?.faqs || [];
                    renderFaqs(faqs);
                } catch (err) {
                    console.error('Load FAQs error:', err);
                    list.innerHTML = `<p style=\"color:var(--accent);\">Failed to load FAQs: ${err.message}</p>`;
                }

                function renderFaqs(faqs) {
                    list.innerHTML = '';
                    if (!faqs || faqs.length === 0) {
                        list.innerHTML = '<p>No FAQs yet.</p>';
                    } else {
                        faqs.forEach((f) => {
                            const row = document.createElement('div');
                            row.className = 'form-row';
                            row.innerHTML = `
                                <div class=\"form-col\"><div class=\"form-group\"><label>Question</label><input type=\"text\" class=\"faq-q\" value=\"${f.Question || ''}\"></div></div>
                                <div class=\"form-col\"><div class=\"form-group\"><label>Answer</label><textarea class=\"faq-a\" rows=\"2\" style=\"width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);\">${f.Answer || ''}</textarea></div></div>
                            `;
                            list.appendChild(row);
                        });
                    }
                }

                addBtn.onclick = () => {
                    const row = document.createElement('div');
                    row.className = 'form-row';
                    row.innerHTML = `
                        <div class=\"form-col\"><div class=\"form-group\"><label>Question</label><input type=\"text\" class=\"faq-q\"></div></div>
                        <div class=\"form-col\"><div class=\"form-group\"><label>Answer</label><textarea class=\"faq-a\" rows=\"2\" style=\"width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);\"></textarea></div></div>
                    `;
                    list.appendChild(row);
                };

                saveBtn.onclick = async () => {
                    try {
                        const faqs = Array.from(list.querySelectorAll('.form-row')).map(row => ({
                            question: row.querySelector('.faq-q')?.value?.trim(),
                            answer: row.querySelector('.faq-a')?.value?.trim(),
                        })).filter(f => f.question && f.answer);
                        const res = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/faqs/upsert`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ faqs })
                        });
                        if (!res.ok) throw new Error('Failed to save FAQs');
                        alert('FAQs saved');
                        await loadVendorFaqs(vendorProfileId);
                    } catch (err) {
                        console.error('Save FAQs error:', err);
                        alert('Failed to save FAQs: ' + err.message);
                    }
                };
            }

            // Simulate user login (for demo purposes)
            function simulateLogin(user) {
                currentUser = {
                    ...user,
                    userId: user.id, // Add userId for compatibility
                    isVendor: user.isVendor || false
                };
                // Expose globally for parts of the app that reference window.currentUser
                window.currentUser = currentUser;
                
                // Also store in localStorage for consistency with getCurrentUser function
                localStorage.setItem('userSession', JSON.stringify(currentUser));

                showLoggedInView();
                
                // Close profile modal safely
                const profileModalEl = document.getElementById('profile-modal');
                if (profileModalEl) {
                    profileModalEl.style.display = 'none';
                }
                
                alert(`Welcome, ${user.name}! You are now logged in.`);

                // Update profile button to show user is logged in
                const profileBtnEl = document.getElementById('profile-btn');
                if (profileBtnEl) {
                    profileBtnEl.textContent = user.avatar;
                    profileBtnEl.style.backgroundColor = 'var(--primary)';
                    profileBtnEl.style.color = 'white';
                    profileBtnEl.style.borderRadius = '50%';
                    profileBtnEl.style.width = '36px';
                    profileBtnEl.style.height = '36px';
                    profileBtnEl.style.display = 'flex';
                    profileBtnEl.style.alignItems = 'center';
                    profileBtnEl.style.justifyContent = 'center';
                }

                // Update favorites badge safely
                const badge = document.querySelector('.badge');
                if (badge) {
                    // Check if state exists and has favorites, otherwise default to 0
                    const favoritesCount = (typeof state !== 'undefined' && state.favorites) ? state.favorites.length : 0;
                    badge.textContent = favoritesCount;
                }
                
                console.log('✅ User logged in:', currentUser);
            }

            // Toggle vendor favorite status
            async function toggleFavorite(vendorId) {
                if (!currentUser) {
                    profileModal.style.display = 'flex';
                    showLoginView();
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/favorites/toggle`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            vendorProfileId: vendorId
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to toggle favorite');
                    }

                    const result = await response.json();

                    const index = state.favorites.indexOf(vendorId);
                    if (result.isFavorite && index === -1) {
                        state.favorites.push(vendorId);
                    } else if (!result.isFavorite && index !== -1) {
                        state.favorites.splice(index, 1);
                    }

                    // Update UI
                    document.querySelectorAll(`.vendor-favorite[data-id="${vendorId}"]`).forEach(icon => {
                        icon.classList.toggle('active', result.isFavorite);
                    });

                    // Update badge
                    document.querySelector('.badge').textContent = state.favorites.length;

                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    alert('Failed to toggle favorite: ' + error.message);
                }
            }

            // Center map on user location
            function centerMapOnUser() {
                if (state.map && state.userLocation) {
                    state.map.setCenter(new google.maps.LatLng(state.userLocation.lat, state.userLocation.lng));
                    state.map.setZoom(12);
                }
            }

            // Create markers ONCE from search-by-services API response - NEVER recreate them
            function createMarkersOnce() {
                console.log('🎯 Creating markers from search-by-services API response');
                
                // Clear any existing markers first
                if (state.markers && state.markers.length > 0) {
                    state.markers.forEach(marker => marker.setMap(null));
                }
                state.markers = [];

                // Get vendors from the booking state where they are actually stored
                const vendorsToShow = window.bookingState?.availableVendors || 
                                   state.originalSearchResults || 
                                   state.filteredVendors || [];
                
                console.log('📊 Available vendors from bookingState:', window.bookingState?.availableVendors);
                console.log('📊 Vendors to show on map:', vendorsToShow);
                
                if (vendorsToShow.length === 0) {
                    console.warn('⚠️ No vendors found to display on map');
                    console.log('🔍 Checking all possible vendor sources:');
                    console.log('  - window.bookingState.availableVendors:', window.bookingState?.availableVendors);
                    console.log('  - state.originalSearchResults:', state.originalSearchResults);
                    console.log('  - state.filteredVendors:', state.filteredVendors);
                    return;
                }
                
                vendorsToShow.forEach(vendor => {
                    // Get coordinates directly from search-by-services API response
                    const lat = parseFloat(vendor.Latitude);
                    const lng = parseFloat(vendor.Longitude);

                    console.log(`🔍 Processing vendor: ${vendor.BusinessName}, Lat: ${lat}, Lng: ${lng}`);

                    // Skip vendors without valid coordinates
                    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                        console.warn('❌ Skipping vendor with invalid coordinates:', vendor.BusinessName, { lat, lng });
                        return;
                    }

                    console.log(`📍 Creating marker for ${vendor.BusinessName} at ${lat}, ${lng}`);

                    const marker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: state.map,
                        title: vendor.BusinessName,
                        animation: google.maps.Animation.DROP,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#3498db',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });

                    state.markers.push(marker);

                    // Add click event to show vendor info
                    marker.addListener('click', () => {
                        console.log(`🖱️ Clicked on vendor: ${vendor.BusinessName} (ID: ${vendor.VendorProfileID})`);
                        window.location.hash = `/listings/${vendor.VendorProfileID}`;
                    });
                });

                console.log(`✅ Created ${state.markers.length} markers from search-by-services API`);
                
                // Center map on markers if they exist
                if (state.markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    state.markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    state.map.fitBounds(bounds);
                    
                    // Set reasonable zoom level
                    google.maps.event.addListenerOnce(state.map, 'bounds_changed', () => {
                        if (state.map.getZoom() > 15) {
                            state.map.setZoom(15);
                        }
                    });
                }
            }

            // DISABLED: Old updateMapMarkers function that was causing bouncing
            function updateMapMarkers() {
                console.log('🚫 updateMapMarkers() disabled - use createMarkersOnce() instead');
                return;
            }

            // --- IMAGE GALLERY AND LIGHTBOX FUNCTIONS ---

            // FIXED: New function to properly populate vendor gallery using images[] array
            function populateVendorGallery(images) {
                console.log('🎯 populateVendorGallery called with:', images);
                
                const galleryContainer = document.getElementById('modal-image-gallery');
                if (!galleryContainer) {
                    console.warn('Gallery container not found');
                    return;
                }

                // Clear existing content
                galleryContainer.innerHTML = '';

                // Extract image URLs from the images array (handles Cloudinary format)
                const imageUrls = [];
                if (images && Array.isArray(images)) {
                    images.forEach(img => {
                        if (img.url) {
                            imageUrls.push(img.url);
                        } else if (img.ImageURL) {
                            imageUrls.push(img.ImageURL);
                        }
                    });
                }

                console.log('📸 Extracted image URLs:', imageUrls);

                // Set lightbox images for navigation
                lightboxImages = imageUrls;

                const totalImages = imageUrls.length;
                const placeholderImage = "https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png";

                // Create main image (large)
                const largeImageDiv = document.createElement('div');
                largeImageDiv.className = 'gallery-item large-image';
                const mainImageUrl = totalImages > 0 ? imageUrls[0] : placeholderImage;
                largeImageDiv.innerHTML = `<img src="${mainImageUrl}" alt="Main Venue Image">`;
                
                // Add click event for lightbox if we have real images
                if (totalImages > 0) {
                    largeImageDiv.addEventListener('click', () => openLightbox(0));
                    largeImageDiv.style.cursor = 'pointer';
                }
                
                galleryContainer.appendChild(largeImageDiv);

                // Create thumbnails container
                const thumbnailsContainer = document.createElement('div');
                thumbnailsContainer.className = 'thumbnails-container';

                // Add 4 thumbnail slots with fixed positions
                for (let i = 1; i <= 4; i++) {
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'gallery-item';
                    
                    const thumbImageUrl = i < totalImages ? imageUrls[i] : placeholderImage;
                    thumbDiv.innerHTML = `<img src="${thumbImageUrl}" alt="Thumbnail ${i}">`;

                    // Add click event to update main image but keep thumbnails fixed
                    if (i < totalImages) {
                        thumbDiv.addEventListener('click', () => {
                            const mainImg = galleryContainer.querySelector('.large-image img');
                            if (mainImg) {
                                mainImg.src = imageUrls[i];
                            }
                            // Open lightbox
                            openLightbox(i);
                        });
                        thumbDiv.style.cursor = 'pointer';
                    }

                    // Add "+X See All" overlay on the last thumbnail if there are more images
                    if (i === 4 && totalImages > 5) {
                        const hiddenCount = totalImages - 5;
                        const overlay = document.createElement('div');
                        overlay.className = 'see-all-overlay';
                        overlay.textContent = `+${hiddenCount} See All`;
                        thumbDiv.appendChild(overlay);
                        
                        // Make the overlay clickable to open lightbox
                        thumbDiv.onclick = () => openLightbox(0);
                    }

                    thumbnailsContainer.appendChild(thumbDiv);
                }

                galleryContainer.appendChild(thumbnailsContainer);
                
                console.log(`✅ Gallery populated with ${totalImages} images`);
            }

            // NEW: Simplified and reliable gallery population function
    function populateVendorGallery(images) {
        console.log('🖼️ populateVendorGallery called with:', images);
        
        const galleryContainer = document.getElementById('modal-image-gallery');
        if (!galleryContainer) {
            console.warn('Gallery container not found');
            return;
        }

        // Extract image URLs from the images array
        const imageUrls = [];
        if (images && Array.isArray(images)) {
            images.forEach(img => {
                if (img.url) {
                    imageUrls.push(img.url);
                } else if (img.ImageURL) {
                    imageUrls.push(img.ImageURL);
                } else if (typeof img === 'string') {
                    imageUrls.push(img);
                }
            });
        }

        console.log('📸 Extracted image URLs:', imageUrls);

        // Set lightbox images for navigation
        lightboxImages = imageUrls;

        // Clear and rebuild gallery
        galleryContainer.innerHTML = '';

        // Create main image (left side)
        const mainImageDiv = document.createElement('div');
        mainImageDiv.className = 'gallery-item large-image';
        
        const mainImg = document.createElement('img');
        mainImg.src = imageUrls.length > 0 ? imageUrls[0] : 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
        mainImg.alt = 'Main Venue Image';
        mainImg.style.width = '100%';
        mainImg.style.height = '100%';
        mainImg.style.objectFit = 'cover';
        
        // Add subtle border for placeholder images
        if (imageUrls.length === 0) {
            mainImg.style.border = '1px solid var(--border)';
            mainImg.style.borderRadius = 'var(--radius)';
        }
        
        if (imageUrls.length > 0) {
            mainImg.style.cursor = 'pointer';
            mainImg.addEventListener('click', () => openLightbox(0));
        }
        
        mainImageDiv.appendChild(mainImg);
        galleryContainer.appendChild(mainImageDiv);

        // Create thumbnails container (right side)
        const thumbnailsContainer = document.createElement('div');
        thumbnailsContainer.className = 'thumbnails-container';

        // Create 4 thumbnail slots
        for (let i = 1; i <= 4; i++) {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'gallery-item';
            
            const thumbImg = document.createElement('img');
            thumbImg.src = i < imageUrls.length ? imageUrls[i] : 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
            thumbImg.alt = `Thumbnail ${i}`;
            thumbImg.style.width = '100%';
            thumbImg.style.height = '100%';
            thumbImg.style.objectFit = 'cover';
            
            // Add subtle border for placeholder thumbnails
            if (i >= imageUrls.length) {
                thumbImg.style.border = '1px solid var(--border)';
                thumbImg.style.borderRadius = 'var(--radius)';
            }
            
            // FIXED: Add click functionality for real images - ONLY open lightbox, don't change main image
            if (i < imageUrls.length) {
                thumbImg.style.cursor = 'pointer';
                thumbImg.addEventListener('click', () => {
                    // Only open lightbox at the thumbnail's image index
                    openLightbox(i);
                });
            }
            
            thumbDiv.appendChild(thumbImg);

            // Add "See All" overlay on last thumbnail if there are more images
            if (i === 4 && imageUrls.length > 5) {
                const overlay = document.createElement('div');
                overlay.className = 'see-all-overlay';
                overlay.textContent = `+${imageUrls.length - 5} See All`;
                overlay.style.cursor = 'pointer';
                overlay.addEventListener('click', () => openLightbox(0));
                thumbDiv.appendChild(overlay);
            }

            thumbnailsContainer.appendChild(thumbDiv);
        }

        galleryContainer.appendChild(thumbnailsContainer);
        
        console.log(`✅ Gallery populated with ${imageUrls.length} images`);
    }

    // Keep the old function for backward compatibility but make it call the new one
    function populateImageGallery(images) {
        console.log('⚠️ populateImageGallery (legacy) called, redirecting to populateVendorGallery');
        populateVendorGallery(images);
    }

            function setupLightboxEventListeners() {
                const lightbox = document.getElementById('lightbox-modal');
                const closeBtn = lightbox.querySelector('.lightbox-close');
                const prevBtn = lightbox.querySelector('.lightbox-prev');
                const nextBtn = lightbox.querySelector('.lightbox-nav.lightbox-next');
                
                // Ensure only one listener is active
                if (closeBtn) closeBtn.removeEventListener('click', closeLightbox);
                if (prevBtn) prevBtn.removeEventListener('click', showPrevImage);
                if (nextBtn) nextBtn.removeEventListener('click', showNextImage);
                
                if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
                if (prevBtn) prevBtn.addEventListener('click', showPrevImage);
                if (nextBtn) nextBtn.addEventListener('click', showNextImage);

                if (lightbox) {
                    if (lightbox.__overlayClickListener) {
                        lightbox.removeEventListener('click', lightbox.__overlayClickListener);
                    }
                    
                    const newListener = (e) => {
                        if (e.target === lightbox) {
                            closeLightbox();
                        }
                    };
                    lightbox.addEventListener('click', newListener);
                    lightbox.__overlayClickListener = newListener;
                }

                document.addEventListener('keydown', (e) => {
                    if (lightbox.style.display === 'flex') {
                        if (e.key === 'Escape') closeLightbox();
                        if (e.key === 'ArrowLeft') showPrevImage();
                        if (e.key === 'ArrowRight') showNextImage();
                    }
                });
            }

            function openLightbox(index) {
                currentLightboxIndex = index;
                updateLightboxImage();
                document.getElementById('lightbox-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeLightbox() {
                document.getElementById('lightbox-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            function updateLightboxImage() {
                const lightboxImage = document.getElementById('lightbox-image');
                if (lightboxImages.length > 0) {
                    lightboxImage.src = lightboxImages[currentLightboxIndex];
                } else {
                     lightboxImage.src = 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
                }
            }

            function showPrevImage() {
                if (lightboxImages.length > 0) {
                    currentLightboxIndex = (currentLightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
                    updateLightboxImage();
                }
            }

            function showNextImage() {
                if (lightboxImages.length > 0) {
                    currentLightboxIndex = (currentLightboxIndex + 1) % lightboxImages.length;
                    updateLightboxImage();
                }
            }

            // Render vendors with Cloudinary images
            function renderVendors() {
                if (!vendorGrid) return;
                
                const vendorsToShow = state.filteredVendors;

                if (vendorsToShow.length === 0) {
                    vendorGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-light);">No vendors found matching your criteria.</div>';
                    return;
                }

                vendorGrid.innerHTML = vendorsToShow.map(vendor => {
                    // Try all possible field name variations for featured image
                    const imageUrl = vendor.FeaturedImageURL || 
                                   vendor.featuredImageURL ||
                                   vendor.featuredImageUrl ||  // lowercase 'u'
                                   vendor.FeaturedImageUrl ||   // mixed case
                                   vendor.image || 
                                   vendor.ImageURL ||
                                   vendor.imageURL ||
                                   vendor.imageUrl ||
                                   vendor.featuredImage?.url || 
                                   vendor.featuredImage?.thumbnailUrl || 
                                   (vendor.images && vendor.images.length > 0 ? vendor.images[0].url : null) ||
                                   'https://res.cloudinary.com/dxgy4apj5/image/upload/v1755105530/image_placeholder.png';
                    
                    console.log('Rendering vendor:', vendor.name || vendor.BusinessName, 'with image:', imageUrl, 'Available fields:', Object.keys(vendor));
                    console.log('Full vendor object:', vendor);
                    console.log('Image field value:', vendor.image);
                    console.log('FeaturedImage object:', vendor.featuredImage);
                    console.log('Images array:', vendor.images);
                    
                    const isFavorite = state.favorites.includes(vendor.VendorProfileID || vendor.id);
                    const badges = [];
                    
                    if (vendor.isPremium) badges.push('<span class="vendor-badge premium">Premium</span>');
                    if (vendor.isEcoFriendly) badges.push('<span class="vendor-badge eco">Eco-Friendly</span>');
                    if (vendor.isAwardWinning) badges.push('<span class="vendor-badge award">Award Winner</span>');

                    const priceLevel = vendor.priceLevel || 2;
                    const priceDots = Array.from({length: 3}, (_, i) => 
                        `<span class="price-dot ${i < priceLevel ? 'filled' : ''}"></span>`
                    ).join('');

                    // Robust price resolution and formatting (prefer backend startingPrice)
                    const rawPrice = vendor.startingPrice ?? vendor.MinPriceNumeric ?? vendor.MinPrice ?? vendor.price ?? vendor.Price ?? vendor.minPrice ?? vendor.starting_price;
                    let priceDisplay = '';
                    if (rawPrice !== undefined && rawPrice !== null && rawPrice !== '') {
                        if (typeof rawPrice === 'number') {
                            priceDisplay = `$${Math.round(rawPrice)}`;
                        } else if (typeof rawPrice === 'string') {
                            const trimmed = rawPrice.trim();
                            priceDisplay = trimmed.startsWith('$') ? trimmed : `$${trimmed}`;
                        }
                    }

                    // Vendor description/bio resolution with truncation
                    const fullDesc = vendor.Bio || vendor.bio || vendor.Description || vendor.description || vendor.About || vendor.about || '';
                    const descText = (fullDesc || '').toString();
                    const shortDesc = descText.length > 140 ? `${descText.slice(0, 140)}…` : descText;

                    // Rating and location meta
                    const ratingValue = (() => { const r = parseFloat(vendor.averageRating ?? vendor.rating ?? 4.5); return isNaN(r) ? 4.5 : r; })();
                    const reviewCount = vendor.totalReviews ?? vendor.reviewCount ?? 0;
                    const locCity = vendor.City || vendor.city || '';
                    const locState = vendor.State || vendor.state || '';
                    const locationText = (vendor.location && vendor.location.trim()) || [locCity, locState].filter(Boolean).join(', ');
                    
                    // Distance display when available
                    const distanceMiles = vendor.distanceMiles ?? vendor.DistanceMiles;
                    const distanceHTML = (distanceMiles !== null && distanceMiles !== undefined) ? 
                        `<span style="color:#6b7280;">•</span>
                         <span style="color:#059669;font-size:.85rem;"><i class="fas fa-location-arrow" style="margin-right:0.25rem;"></i>${distanceMiles.toFixed(1)} mi</span>` : '';

                    return `
                        <div class="vendor-card">
                            <div class="vendor-image">
                                <img src="${imageUrl}" alt="${vendor.BusinessName || vendor.name}" 
                                     style="width:100%;height:100%;object-fit:cover;"
                                     onerror="this.src='https://placehold.co/800x600/e2e8f0/718096?text=No+Image'">
                                <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${vendor.VendorProfileID || vendor.id}"><i class="fas fa-heart"></i></div>
                                <div class="vendor-badges" style="position: absolute; bottom: 8px; left: 8px; display: flex; gap: 6px;">
                                    ${badges.join('')}
                                </div>
                            </div>
                            <div class="vendor-details">
                                <h3 class="vendor-name" style="font-size:1.1rem;">${vendor.BusinessName || vendor.name}</h3>
                                <div class="vendor-location" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
                                    <span><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${locationText || 'Location unavailable'}</span>
                                    ${distanceHTML}
                                    <span style="color:#6b7280;">•</span>
                                    <span style="display:flex;align-items:center;gap:.5rem;">
                                        <span style="color:#f59e0b;font-size:.9rem;">${'★'.repeat(Math.floor(ratingValue))}${'☆'.repeat(5-Math.floor(ratingValue))}</span>
                                        <span style="font-size:.85rem;color:#6b7280;">${ratingValue.toFixed(1)} (${reviewCount})</span>
                                    </span>
                                </div>
                                ${shortDesc ? `<div class="vendor-description" style="margin:.5rem 0 0.25rem;color:var(--text-light);font-size:.95rem;line-height:1.4;">${shortDesc}</div>` : ''}
                                <div class="vendor-footer">
                                    <div class="vendor-price" style="font-weight:600;">${priceDisplay ? `<span>Starting from</span> ${priceDisplay}` : ''}</div>
                                    <div class="vendor-actions">
                                        <button class="btn btn-outline save-btn" data-id="${vendor.VendorProfileID || vendor.id}">Save</button>
                                        <button class="btn btn-primary view-btn" data-id="${vendor.VendorProfileID || vendor.id}">View</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add event listeners for the new vendor cards
                setupVendorCardEventListeners();
                updatePagination();
                // If map is visible, refresh markers for current page
                const mapEl = document.getElementById('map-view');
                if (mapEl && mapEl.style.display === 'block') {
                    updateMapMarkers();
                }
            }

            // Render main-page horizontal cards (used in Map view)
            function renderMainHorizontalCards() {
                const container = document.getElementById('main-horizontal-cards');
                if (!container) return;
                // When map is active, render viewport-matched vendors with incremental list (infinite scroll)
                const isMapActive = document.body.classList.contains('map-active');
                let vendors = [];
                if (isMapActive && Array.isArray(state.map?.vendorsInViewport)) {
                    vendors = state.map.vendorsInViewport.slice(0, state.map.viewportRenderCount || 20);
                } else {
                    // Fallback to previous paged approach
                    const start = (state.currentPage - 1) * state.vendorsPerPage;
                    const end = start + state.vendorsPerPage;
                    vendors = state.filteredVendors.slice(start, end);
                }
                if (!vendors || vendors.length === 0) {
                    container.innerHTML = `
                        <div style="width:100%; padding:1rem; color:#6b7280; font-size:0.95rem;">
                            No vendors to display in this area. Try adjusting the map or filters.
                        </div>
                    `;
                } else {
                    container.innerHTML = vendors.map(v => createHorizontalVendorCard(v)).join('');
                }

                // Wire card interactions to select on click
                container.querySelectorAll('.vendor-horizontal-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const vid = card.getAttribute('data-vendor-id');
                        if (vid) selectVendor(vid, true);
                    });
                });

                // Ensure infinite scroll is attached in map mode
                if (document.body.classList.contains('map-active')) {
                    setupMapListInfiniteScroll();
                }
            }

            // Attach infinite scroll to the horizontal cards container in map view
            function setupMapListInfiniteScroll() {
                const container = document.getElementById('main-horizontal-cards');
                if (!container) return;
                if (container.dataset.infiniteAttached === '1') return;
                container.dataset.infiniteAttached = '1';
                let ticking = false;
                container.addEventListener('scroll', () => {
                    if (ticking) return;
                    ticking = true;
                    requestAnimationFrame(() => {
                        ticking = false;
                        if (!document.body.classList.contains('map-active')) return;
                        const nearBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 200;
                        if (nearBottom) {
                            const total = (state.map.vendorsInViewport || []).length;
                            const current = state.map.viewportRenderCount || 20;
                            if (current < total) {
                                state.map.viewportRenderCount = Math.min(current + 20, total);
                                renderMainHorizontalCards();
                            }
                        }
                    });
                }, { passive: true });
            }

            // Setup event listeners for vendor cards
            function setupVendorCardEventListeners() {
                // Favorite buttons
                document.querySelectorAll('.vendor-favorite').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const vendorId = btn.dataset.id;
                        toggleFavorite(vendorId);
                    });
                });

                // View buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const vendorId = btn.dataset.id;
                        // Open in new tab with listings path format
                        const baseUrl = window.location.origin;
                        const profileUrl = `${baseUrl}/listings/${vendorId}`;
                        window.open(profileUrl, '_blank');
                    });
                });

                // Save buttons
                document.querySelectorAll('.save-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const vendorId = btn.dataset.id;
                        toggleFavorite(vendorId);
                    });
                });
            }

            // Update metadata display
            function updateMetadata(data) {
                if (resultsTitle) {
                    const label = (state.filters && state.filters.location) || state.userLocationLabel || 'Near you';
                    resultsTitle.textContent = `Vendors in ${label}`;
                }
                if (resultsCount) {
                    resultsCount.textContent = `${data.total || state.filteredVendors.length} vendors available`;
                }
            }

            // =============== Map (Google Maps) Integration ===============
            // Attempt to retrieve the Google Maps API key similar to booking process
            function getGoogleMapsApiKey() {
                // Try common globals used elsewhere in the app
                const fromBookingState = (window.bookingState && window.bookingState.googleMapsApiKey) || null;
                const fromBookingConfig = (window.bookingConfig && window.bookingConfig.googleMapsApiKey) || null;
                const fromAppConfig = (window.APP_CONFIG && window.APP_CONFIG.googleMapsApiKey) || null;
                const fromMeta = (() => {
                    const tag = document.querySelector('meta[name="google-maps-api-key"]');
                    return tag ? tag.getAttribute('content') : null;
                })();
                const fromStorage = localStorage.getItem('googleMapsApiKey');
                return fromBookingState || fromBookingConfig || fromAppConfig || fromMeta || fromStorage || null;
            }

            let googleMapsLoadingPromise = null;
            function loadGoogleMaps() {
                if (window.google && window.google.maps) return Promise.resolve();
                if (googleMapsLoadingPromise) return googleMapsLoadingPromise;
                const apiKey = getGoogleMapsApiKey();
                googleMapsLoadingPromise = new Promise((resolve, reject) => {
                    if (!apiKey) {
                        return reject(new Error('Google Maps API key not found. Provide it via booking config or a meta tag.'));
                    }
                    const cbName = 'initGMap_' + Math.random().toString(36).slice(2);
                    window[cbName] = () => { resolve(); delete window[cbName]; };
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&callback=${cbName}`;
                    script.async = true;
                    script.onerror = () => reject(new Error('Failed to load Google Maps JS API'));
                    document.body.appendChild(script);
                });
                return googleMapsLoadingPromise;
            }

            // Initialize map state
            function ensureMapState() {
                state.map = state.map || {
                    initialized: false,
                    map: null,
                    markers: [],
                    vendorMarkers: {},
                    cluster: null,
                    vendorsInViewport: [],
                    viewportRenderCount: 20,
                    selectedVendorId: null,
                    hoverVendorId: null,
                    geoCache: {},
                    geocoder: null,
                };
                // Load cached geocodes
                try {
                    const cached = localStorage.getItem('geoCacheV1');
                    if (cached) state.map.geoCache = JSON.parse(cached);
                } catch (e) { console.warn('Geo cache load failed', e); }
            }

            function saveGeoCache() {
                try { localStorage.setItem('geoCacheV1', JSON.stringify(state.map.geoCache || {})); } catch {}
            }

            // Helpers to store/retrieve user coordinates and recenter map
            function getStoredUserCoords() {
                try {
                    const raw = localStorage.getItem('userCoordsV1');
                    if (!raw) return null;
                    const obj = JSON.parse(raw);
                    if (obj && typeof obj.lat === 'number' && typeof obj.lon === 'number') return obj;
                } catch {}
                return null;
            }

            function setMapToUser(lat, lon) {
                if (!(state.map && state.map.map)) return;
                try {
                    state.map.map.setCenter({ lat, lng: lon });
                    state.map.map.setZoom(Math.max(11, state.map.map.getZoom() || 10));
                } catch {}
            }

            // Load Google MarkerClusterer dynamically when needed
            let markerClustererLoading = null;
            async function loadMarkerClusterer() {
                if (window.markerClusterer) return;
                if (markerClustererLoading) return markerClustererLoading;
                markerClustererLoading = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js';
                    script.async = true;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load MarkerClusterer'));
                    document.head.appendChild(script);
                });
                return markerClustererLoading;
            }

            async function initMapIfNeeded() {
                ensureMapState();
                if (state.map.initialized) return;
                await loadGoogleMaps();
                const mapEl = document.getElementById('map-view');
                if (!mapEl) return;
                // Choose best available initial center
                const stored = getStoredUserCoords();
                if (stored) state.userCoords = stored;
                // Require explicit coordinates before initializing the map
                const initialCenter = (state.userCoords)
                    ? { lat: state.userCoords.lat, lng: state.userCoords.lon }
                    : (window.selectedEventLocation && typeof window.selectedEventLocation.lat === 'number' && typeof window.selectedEventLocation.lng === 'number'
                        ? { lat: window.selectedEventLocation.lat, lng: window.selectedEventLocation.lng }
                        : null);
                if (!initialCenter) {
                    console.warn('Map initialization skipped: no coordinates available yet. Enter/select an event location.');
                    return;
                }
                const initialZoom = 11;
                state.map.map = new google.maps.Map(mapEl, {
                    center: initialCenter,
                    zoom: initialZoom,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                });
                state.map.geocoder = new google.maps.Geocoder();
                state.map.initialized = true;
                // Track user interactions to avoid auto-fit fighting user
                state.map.userInteractedAt = 0;
                state.map.lastFitCount = 0;
                state.map.map.addListener('dragstart', () => { state.map.userInteractedAt = Date.now(); });
                state.map.map.addListener('zoom_changed', () => { state.map.userInteractedAt = Date.now(); });
                // Center on user if we have coords
                if (state.userCoords) {
                    setMapToUser(state.userCoords.lat, state.userCoords.lon);
                }

                // Refresh data when map viewport changes
                state.map.map.addListener('idle', () => {
                    // Debounce rapid movements
                    clearTimeout(state.map._idleTimer);
                    state.map._idleTimer = setTimeout(() => updateMapMarkers(), 150);
                });
            }

            // Geocode a location string via Google Geocoder, with cache; fallback to OSM
            async function geocodeLocation(query) {
                ensureMapState();
                if (!query) return null;
                const key = query.trim().toLowerCase();
                if (state.map.geoCache[key]) return state.map.geoCache[key];
                await initMapIfNeeded();
                // Try Google Geocoder first if available
                if (state.map.geocoder) {
                    const googleResult = await new Promise((resolve) => {
                        try {
                            state.map.geocoder.geocode({ address: query }, (results, status) => {
                                if (status === 'OK' && results && results[0]) {
                                    const loc = results[0].geometry.location;
                                    resolve({ lat: loc.lat(), lon: loc.lng(), label: results[0].formatted_address });
                                } else {
                                    resolve(null);
                                }
                            });
                        } catch { resolve(null); }
                    });
                    if (googleResult) {
                        state.map.geoCache[key] = googleResult;
                        saveGeoCache();
                        return googleResult;
                    }
                }
                // Fallback to OpenStreetMap Nominatim forward geocoder
                try {
                    const osm = await forwardGeocodeOSM(query);
                    if (osm) {
                        state.map.geoCache[key] = osm;
                        saveGeoCache();
                        return osm;
                    }
                } catch {}
                return null;
            }

            // Forward geocode using OSM Nominatim (no API key)
            async function forwardGeocodeOSM(query) {
                const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(query)}`;
                const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
                if (!res.ok) return null;
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) return null;
                const best = data[0];
                return { lat: parseFloat(best.lat), lon: parseFloat(best.lon), label: best.display_name };
            }

            function clearMapMarkers() {
                if (!state.map) return;
                if (state.map.cluster) {
                    try { state.map.cluster.clearMarkers(); } catch {}
                    state.map.cluster = null;
                }
                if (state.map.markers) {
                    state.map.markers.forEach(m => { try { m.setMap(null); } catch {} });
                }
                state.map.markers = [];
                state.map.vendorMarkers = {};
            }

            // Helper to get current map bounds as a simple object
            function getCurrentBounds() {
                const gBounds = state.map.map.getBounds();
                if (!gBounds) return null;
                const ne = gBounds.getNorthEast();
                const sw = gBounds.getSouthWest();
                return { north: ne.lat(), south: sw.lat(), east: ne.lng(), west: sw.lng() };
            }

            // Fetch vendors for current viewport bounds from API
            async function fetchVendorsForBounds(bounds) {
                const params = new URLSearchParams();
                params.set('bounds', JSON.stringify(bounds));
                if (state.currentCategory && state.currentCategory !== 'all') {
                    // Pass category key so backend LIKE '%key%' matches common synonyms (e.g., 'photo' -> 'Photography')
                    params.set('category', state.currentCategory);
                }
                // Include event details for backend filtering (business hours + proximity)
                try {
                    const ed = (window.bookingState && window.bookingState.eventDetails) ? window.bookingState.eventDetails : null;
                    // Pass event date/time
                    if (ed && ed.date) params.set('eventDate', ed.date);
                    if (ed && ed.startTime) params.set('eventStartTime', ed.startTime);
                    if (ed && ed.endTime) params.set('eventEndTime', ed.endTime);
                    // Fallback: if start/end not present but we have a combined timeRange like "12:00 - 16:00"
                    if (ed && (!ed.startTime || !ed.endTime) && typeof ed.timeRange === 'string' && ed.timeRange.includes('-')) {
                        try {
                            const parts = ed.timeRange.split('-');
                            const s = (parts[0] || '').trim();
                            const e = (parts[1] || '').trim();
                            if (!params.has('eventStartTime') && s) params.set('eventStartTime', s);
                            if (!params.has('eventEndTime') && e) params.set('eventEndTime', e);
                        } catch {}
                    }

                    // Pass event location coordinates if available
                    const coords = (ed && ed.locationCoords) ? ed.locationCoords : (window.selectedEventLocation || null);
                    if (coords && typeof coords.lat === 'number' && typeof coords.lng === 'number') {
                        params.set('eventLat', coords.lat);
                        params.set('eventLng', coords.lng);
                        params.set('prioritizeEventLocation', 'true');
                        // Sync global selectedEventLocation so the map marker centers correctly
                        try { window.selectedEventLocation = { lat: Number(coords.lat), lng: Number(coords.lng) }; } catch {}
                        try { if (state?.map?.map && typeof addEventLocationMarker === 'function') { addEventLocationMarker(); } } catch {}
                    } else if (ed && ed.location) {
                        // Geocode on the fly to ensure map and proximity use event location
                        try {
                            const geo = await geocodeLocation(ed.location);
                            if (geo && typeof geo.lat === 'number' && typeof geo.lon === 'number' && isFinite(geo.lat) && isFinite(geo.lon)) {
                                params.set('eventLat', geo.lat);
                                params.set('eventLng', geo.lon);
                                params.set('prioritizeEventLocation', 'true');
                                // Persist to bookingState and sync global for the map
                                try {
                                    if (window.bookingState && window.bookingState.eventDetails) {
                                        window.bookingState.eventDetails.locationCoords = { lat: geo.lat, lng: geo.lon };
                                    }
                                } catch {}
                                try { window.selectedEventLocation = { lat: geo.lat, lng: geo.lon }; } catch {}
                                try {
                                    if (state?.map?.map) {
                                        if (typeof addEventLocationMarker === 'function') addEventLocationMarker();
                                        try { state.map.map.panTo({ lat: geo.lat, lng: geo.lon }); } catch {}
                                    }
                                } catch {}
                            } else {
                                console.warn('Skipping /vendors/map: geocoding did not return coordinates');
                                return [];
                            }
                        } catch {
                            console.warn('Skipping /vendors/map: geocoding threw without coordinates');
                            return [];
                        }
                    }
                } catch (e) {
                    console.warn('Could not attach event details to map search:', e);
                }
                // optional filters can be added here (minPrice, maxPrice, etc.)
                const url = `${API_BASE_URL}/vendors/map?${params.toString()}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Map vendors fetch failed: ${res.status}`);
                const data = await res.json();
                const raw = data.vendors || [];
                // Normalize primary category for each vendor in viewport results
                const normalized = raw.map(v => {
                    const primary = v.PrimaryCategory || v.primaryCategory || v.type || (v.categories || '').split(',')[0] || '';
                    const categoryKey = mapTypeToCategory(primary);
                    return { ...v, category: categoryKey || '' };
                });
                return normalized;
            }

            // Highlight helper for markers and cards
            function applyHighlight(vendorId, active) {
                state.map.hoverVendorId = active ? vendorId : (state.map.hoverVendorId === vendorId ? null : state.map.hoverVendorId);
                const marker = state.map.vendorMarkers[vendorId];
                if (marker) {
                    try {
                        if (active) {
                            marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                            marker.setIcon({ path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#2563eb', fillOpacity: 1, strokeColor: '#ffffff', strokeWeight: 2 });
                        } else if (!active && state.map.selectedVendorId !== vendorId) {
                            marker.setZIndex(undefined);
                            marker.setIcon(null);
                        }
                    } catch {}
                }
                // Card highlight
                const card = document.querySelector(`.vendor-horizontal-card[data-vendor-id="${vendorId}"]`);
                if (card) {
                    card.classList.toggle('map-hover', !!active);
                }
            }

            // Expose minimal globals for card events already present
            window.highlightMapMarker = function(vendorId, hover) {
                try { applyHighlight(vendorId, hover); } catch {}
            };

            function selectVendor(vendorId, center = true) {
                state.map.selectedVendorId = vendorId;
                // Update card classes
                document.querySelectorAll('.vendor-horizontal-card').forEach(el => el.classList.remove('map-active'));
                const card = document.querySelector(`.vendor-horizontal-card[data-vendor-id="${vendorId}"]`);
                if (card) {
                    card.classList.add('map-active');
                    // Scroll into view
                    const container = document.getElementById('main-horizontal-cards') || document.querySelector('.results-left');
                    if (container) {
                        try { card.scrollIntoView({ block: 'nearest', behavior: 'smooth' }); } catch {}
                    }
                }
                // Update marker icon and center
                Object.entries(state.map.vendorMarkers).forEach(([id, m]) => {
                    try { if (id !== String(vendorId)) m.setIcon(null); } catch {}
                });
                const marker = state.map.vendorMarkers[vendorId];
                if (marker) {
                    try {
                        marker.setIcon({ path: google.maps.SymbolPath.CIRCLE, scale: 9, fillColor: '#1d4ed8', fillOpacity: 1, strokeColor: '#ffffff', strokeWeight: 2 });
                        marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 2);
                        if (center) state.map.map.panTo(marker.getPosition());
                    } catch {}
                }
            }

            async function updateMapMarkers() {
                const mapEl = document.getElementById('map-view');
                if (!mapEl || mapEl.style.display === 'none') return; // Map hidden
                await initMapIfNeeded();
                if (!(window.google && state.map.map)) return;

                const bounds = getCurrentBounds();
                if (!bounds) return;

                // Fetch vendors for bounds
                let vendorsInBounds = [];
                try {
                    vendorsInBounds = await fetchVendorsForBounds(bounds);
                } catch (e) {
                    console.warn('Viewport vendor fetch failed', e);
                }

                const hasViewportResults = Array.isArray(vendorsInBounds) && vendorsInBounds.length > 0;
                // Safety: if no viewport results and filtered list empty, fetch a baseline list
                if (!hasViewportResults && (!Array.isArray(state.filteredVendors) || state.filteredVendors.length === 0)) {
                    try {
                        const url = `${API_BASE_URL}/vendors?pageNumber=1&pageSize=50&includeImages=false`;
                        const res = await fetch(url);
                        if (res.ok) {
                            const data = await res.json();
                            if (Array.isArray(data.vendors)) {
                                state.filteredVendors = data.vendors;
                            }
                        }
                    } catch (e) { console.warn('Baseline vendors fetch failed', e); }
                }
                state.map.vendorsInViewport = hasViewportResults
                    ? vendorsInBounds
                    : (state.filteredVendors || []).slice(0, Math.min(50, (state.filteredVendors || []).length));
                state.map.viewportRenderCount = Math.max(state.map.viewportRenderCount || 20, 20);
                console.log('Map Debug:', {
                    viewportCount: vendorsInBounds.length || 0,
                    usingViewport: hasViewportResults,
                    filteredCount: (state.filteredVendors || []).length,
                    renderCount: state.map.viewportRenderCount
                });
                renderMainHorizontalCards();

                // Build markers and cluster
                clearMapMarkers();
                const markers = [];
                if (hasViewportResults) {
                    vendorsInBounds.forEach(vendor => {
                        const lat = vendor.latitude ?? vendor.Latitude;
                        const lng = vendor.longitude ?? vendor.Longitude;
                        if (typeof lat !== 'number' || typeof lng !== 'number') return;
                        const m = new google.maps.Marker({
                            position: { lat, lng },
                            title: vendor.name || vendor.BusinessName || 'Vendor',
                        });
                        const vid = String(vendor.vendorProfileId || vendor.VendorProfileID || vendor.id);
                        state.map.vendorMarkers[vid] = m;
                        m.addListener('mouseover', () => applyHighlight(vid, true));
                        m.addListener('mouseout', () => applyHighlight(vid, false));
                        m.addListener('click', () => selectVendor(vid, true));
                        markers.push(m);
                    });
                } else {
                    // Fallback: geocode vendors from filtered list to place markers
                    const fallback = state.map.vendorsInViewport.slice(0, 25); // cap to avoid rate limits
                    for (const vendor of fallback) {
                        const q = (vendor.fullAddress && vendor.fullAddress.trim())
                            || (vendor.address && vendor.city && vendor.state && `${vendor.address}, ${vendor.city}, ${vendor.state} ${vendor.postalCode || ''}`.trim())
                            || (vendor.address && vendor.address.trim())
                            || (vendor.location && vendor.location.trim())
                            || (vendor.Location && vendor.Location.trim())
                            || [vendor.city, vendor.state].filter(Boolean).join(', ')
                            || [vendor.City, vendor.State].filter(Boolean).join(', ');
                        if (!q) continue;
                        try {
                            const geo = await geocodeLocation(q);
                            if (!geo) continue;
                            const position = { lat: geo.lat, lng: geo.lon };
                            const m = new google.maps.Marker({ position, title: vendor.BusinessName || vendor.name || 'Vendor' });
                            const vid = String(vendor.vendorProfileId || vendor.VendorProfileID || vendor.id || q);
                            state.map.vendorMarkers[vid] = m;
                            m.addListener('mouseover', () => applyHighlight(vid, true));
                            m.addListener('mouseout', () => applyHighlight(vid, false));
                            m.addListener('click', () => selectVendor(vid, true));
                            markers.push(m);
                        } catch (e) { console.warn('Geocode fallback failed for', q, e); }
                    }
                }

                state.map.markers = markers;
                try { await loadMarkerClusterer(); } catch {}
                if (window.markerClusterer) {
                    try {
                        state.map.cluster = new markerClusterer.MarkerClusterer({ map: state.map.map, markers });
                    } catch (e) { console.warn('Clusterer init failed', e); }
                } else {
                    // Fallback: add markers directly if clusterer not available
                    markers.forEach(m => m.setMap(state.map.map));
                }
                // Fit map to markers if any and not during active user interaction
                const canAutoFit = (!state.map.userInteractedAt) || (Date.now() - state.map.userInteractedAt > 800);
                if (markers.length > 0 && canAutoFit && state.map.lastFitCount !== markers.length) {
                    try {
                        const bounds = new google.maps.LatLngBounds();
                        markers.forEach(m => bounds.extend(m.getPosition()));
                        state.map.map.fitBounds(bounds, { padding: 30 });
                        state.map.lastFitCount = markers.length;
                    } catch {}
                }
                else {
                    console.log('Map markers: none produced for current filters/viewport.');
                }
            }

            // View toggle (List | Map) — insert segmented control in header location
            (function setupViewToggle() {
                const targetSlot = document.getElementById('legacy-view-toggle');
                if (!targetSlot) return;

                // Inject minimal CSS once
                if (!document.getElementById('view-toggle-styles')) {
                    const style = document.createElement('style');
                    style.id = 'view-toggle-styles';
                    style.textContent = `
                        .view-toggle { display:inline-flex; align-items:center; height:36px; margin-left:8px; background:#fff; border:1px solid var(--border); box-shadow:none !important; border-radius: var(--radius); overflow:hidden; }
                        /* Full-bleed fill without seams using container gradient depending on which button is active */
                        .view-toggle:has(.toggle-btn:first-child.active) { background: linear-gradient(90deg, #f6f8ff 0%, #f6f8ff 50%, #ffffff 50%, #ffffff 100%); }
                        .view-toggle:has(.toggle-btn:last-child.active) { background: linear-gradient(90deg, #ffffff 0%, #ffffff 50%, #f6f8ff 50%, #f6f8ff 100%); }
                        .view-toggle .toggle-btn { display:flex; align-items:center; gap:6px; height:100%; padding:0 12px; font-weight:400; font-size:13px; color:#475569; background:transparent; border:0 !important; cursor:pointer; outline:none !important; box-shadow:none !important; }
                        /* Remove inner border to avoid visible seam; container gradient provides the split */
                        .view-toggle .toggle-btn + .toggle-btn { border-left:0; }
                        /* Prevent seam/gap next to the active segment */
                        .view-toggle .toggle-btn.active + .toggle-btn { border-left-color: transparent; }
                        .view-toggle .toggle-btn:last-child.active { box-shadow: none; }
                        .view-toggle .toggle-btn + .toggle-btn::before { display:none; content:""; }
                        .view-toggle .toggle-btn .icon i { font-size:13px; opacity:0.7; }
                        /* Active relies on container background for fill; keep button background transparent */
                        .view-toggle .toggle-btn.active { color:#2563eb; background:transparent; }
                        .view-toggle .toggle-btn:first-child.active { border-top-left-radius: var(--radius); border-bottom-left-radius: var(--radius); }
                        .view-toggle .toggle-btn:last-child.active { border-top-right-radius: var(--radius); border-bottom-right-radius: var(--radius); }
                        .view-toggle .toggle-btn.active::after { content:none; }
                        .view-toggle .toggle-btn.active + .toggle-btn::before { background:var(--border); }
                        .view-toggle .toggle-btn:not(.active):hover { color:#1f2937; background:#f8fafc; }
                        .view-toggle .toggle-btn:focus, .view-toggle .toggle-btn:focus-visible { outline: none !important; box-shadow: none !important; }
                        .view-toggle .icon { display:inline-flex; width:14px; height:14px; justify-content:center; align-items:center; }
                        .view-toggle .icon i { font-size:13px; line-height:1; }
                    `;
                    document.head.appendChild(style);
                }

                // Ensure Font Awesome is available (load if missing)
                const hasFA = !!document.querySelector('link[href*="fontawesome"], link[href*="font-awesome"], link[href*="cdnjs.cloudflare.com/ajax/libs/font-awesome"]');
                if (!hasFA) {
                    const fa = document.createElement('link');
                    fa.rel = 'stylesheet';
                    fa.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css';
                    fa.crossOrigin = 'anonymous';
                    fa.referrerPolicy = 'no-referrer';
                    document.head.appendChild(fa);
                }

                const wrapper = document.createElement('div');
                wrapper.id = 'view-toggle';
                wrapper.className = 'view-toggle';
                wrapper.innerHTML = `
                    <button type="button" id="btn-view-list" class="toggle-btn active"><span class="icon"><i class="fa-solid fa-list-ul"></i></span><span>List</span></button>
                    <button type="button" id="btn-view-map" class="toggle-btn"><span class="icon"><i class="fa-solid fa-map"></i></span><span>Map</span></button>
                `;
                targetSlot.innerHTML = '';
                targetSlot.appendChild(wrapper);

                const listBtn = document.getElementById('btn-view-list');
                const mapBtn = document.getElementById('btn-view-map');

                function setActive(view) {
                    const mapEl = document.getElementById('map-view');
                    const gridEl = document.getElementById('vendor-grid');
                    const paginationEl = document.getElementById('pagination');
                    const horizEl = document.getElementById('main-horizontal-cards');
                    if (!mapEl) return;
                    if (view === 'map') {
                        document.body.classList.add('map-active');
                        mapEl.style.display = 'block';
                        if (gridEl) gridEl.style.display = 'none';
                        if (horizEl) {
                            horizEl.style.display = 'flex';
                            try { renderMainHorizontalCards(); } catch {}
                            setupMapListInfiniteScroll();
                        }
                        if (paginationEl) paginationEl.style.display = 'none';
                        listBtn.classList.remove('active');
                        mapBtn.classList.add('active');
                        try { localStorage.setItem('vv_view', 'map'); } catch {}
                        initMapIfNeeded().then(updateMapMarkers).catch(() => {});
                    } else {
                        document.body.classList.remove('map-active');
                        mapEl.style.display = 'none';
                        if (gridEl) gridEl.style.display = '';
                        if (horizEl) horizEl.style.display = 'none';
                        if (paginationEl) paginationEl.style.display = '';
                        mapBtn.classList.remove('active');
                        listBtn.classList.add('active');
                        try { localStorage.setItem('vv_view', 'list'); } catch {}
                    }
                }

                listBtn.addEventListener('click', () => setActive('list'));
                mapBtn.addEventListener('click', () => setActive('map'));

                // Initialize based on current visibility
                const mapEl = document.getElementById('map-view');
                let initial = 'list';
                try {
                    const saved = localStorage.getItem('vv_view');
                    if (saved === 'map' || saved === 'list') initial = saved;
                } catch {}
                setActive(initial);
            })();

            // Update pagination (unified Load More control)
            function updatePagination() {
                const wrapper = document.getElementById('load-more-wrapper');
                if (!wrapper) return;
                const isMap = document.body.classList.contains('map-active');
                const loaded = state.filteredVendors.length;
                const total = state.serverTotalCount || loaded;
                const hasMore = loaded < total;
                wrapper.style.display = isMap ? 'none' : (hasMore ? 'flex' : 'none');
                const btn = document.getElementById('load-more-btn');
                if (btn) btn.textContent = hasMore ? 'Load more' : 'No more results';
            }

            // Filter vendors based on current filters
            function filterVendors() {
                state.filteredVendors = state.vendors.filter(vendor => {
                    // Category filter
                    if (state.currentCategory !== 'all' && vendor.category !== state.currentCategory) {
                        return false;
                    }
                    
                    // Location filter - only apply text-based filter if we DON'T have user coordinates
                    // When we have coordinates, backend already filters by distance radius
                    const hasUserCoords = (state.userLocation?.lat && state.userLocation?.lng) || (state.userCoords?.lat && state.userCoords?.lon);
                    if (state.filters.location && !hasUserCoords) {
                        const location = state.filters.location.toLowerCase();
                        const vendorLocation = `${vendor.City || ''} ${vendor.State || ''}`.toLowerCase();
                        if (!vendorLocation.includes(location)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                state.currentPage = 1; // Reset to first page
                if (document.body.classList.contains('map-active')) {
                    // In map view, refresh markers and list based on viewport
                    updateMapMarkers();
                } else {
                    renderVendors();
                }
                updateMetadata({ total: state.filteredVendors.length });
            }

            // Load vendors from API
            async function loadVendors(options = {}) {
                const append = !!options.append;
                try {
                    console.log('Loading vendors from API...');
                    
                    // Show skeleton cards when loading fresh (not appending)
                    if (!append) {
                        showVendorSkeletons(8);
                    }
                    
                    const params = new URLSearchParams(window.location.search);
                    const categoryParam = params.get('category');
                    const categoriesParam = params.get('categories');
                    const hasCategoryQuery = (!!categoryParam && categoryParam !== '') || (!!categoriesParam && categoriesParam !== '');
                    const isAll = categoryParam && decodeURIComponent(categoryParam).toLowerCase() === 'all';
                    // Determine next server page
                    const nextPage = append ? (state.serverPageNumber + 1) : 1;
                    
                    // Get user location for distance-based sorting
                    const userLat = state.userLocation?.lat || state.userCoords?.lat;
                    const userLng = state.userLocation?.lng || state.userCoords?.lon;
                    const hasUserLocation = userLat && userLng;
                    
                    // Determine sort method - default to 'nearest' if user has location
                    const sortBy = sortSelect?.value || (hasUserLocation ? 'nearest' : 'recommended');
                    
                    let url = `${API_BASE_URL}/vendors?pageNumber=${nextPage}&pageSize=${state.serverPageSize}`;
                    if (hasCategoryQuery && !isAll) {
                        // Preserve only category params for backend and allow future filter expansions
                        const qp = new URLSearchParams();
                        if (categoryParam) qp.set('category', categoryParam);
                        if (categoriesParam) qp.set('categories', categoriesParam);
                        qp.set('pageNumber', String(nextPage));
                        qp.set('pageSize', String(state.serverPageSize));
                        
                        // Add location parameters for distance-based sorting
                        if (hasUserLocation) {
                            qp.set('latitude', String(userLat));
                            qp.set('longitude', String(userLng));
                            qp.set('radiusMiles', '50');
                        }
                        
                        // Add sort parameter
                        if (sortBy) {
                            qp.set('sortBy', sortBy);
                        }
                        
                        url = `${API_BASE_URL}/vendors/search-by-categories?${qp.toString()}`;
                    } else {
                        // Add location and sort parameters to default vendor search
                        const qp = new URLSearchParams();
                        qp.set('pageNumber', String(nextPage));
                        qp.set('pageSize', String(state.serverPageSize));
                        
                        if (hasUserLocation) {
                            qp.set('latitude', String(userLat));
                            qp.set('longitude', String(userLng));
                            qp.set('radiusMiles', '50');
                        }
                        
                        if (sortBy) {
                            qp.set('sortBy', sortBy);
                        }
                        
                        url = `${API_BASE_URL}/vendors?${qp.toString()}`;
                    }

                    const response = await fetch(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Response Error:', response.status, errorText);
                        throw new Error(`Failed to fetch vendors: ${response.status} - ${errorText}`);
                    }
                    const data = await response.json();
                    console.log('Raw API response:', data);

                    let vendors = [];
                    let totalCount = 0;
                    if (hasCategoryQuery && Array.isArray(data.sections)) {
                        vendors = data.sections.flatMap(s => s?.vendors || []);
                        // Deduplicate vendors by profile ID or id
                        const seen = new Set();
                        const unique = [];
                        for (const v of vendors) {
                            const k = v.vendorProfileId || v.VendorProfileID || v.id;
                            if (k == null) { unique.push(v); continue; }
                            if (!seen.has(k)) { seen.add(k); unique.push(v); }
                        }
                        vendors = unique;
                        // Sum section totals when available; fallback to vendor length
                        try {
                            totalCount = data.sections.reduce((acc, s) => acc + (s?.totalCount || (s?.vendors?.length || 0)), 0);
                        } catch { totalCount = vendors.length; }
                    } else {
                        vendors = data.vendors || [];
                        totalCount = data.totalCount || vendors.length;
                    }

                    console.log(`API returned ${vendors.length} vendors, totalCount: ${totalCount}`);

                    // Normalize vendors and map their primary category to navbar key
                    const normalizedVendors = vendors.map(v => {
                        const primary = v.type || v.PrimaryCategory || ((v.categories || v.Categories || '').split(',')[0] || '').trim();
                        const categoryKey = mapTypeToCategory(primary);
                        return { 
                            ...v, 
                            category: categoryKey || '',
                            // Preserve distance from backend for sorting
                            distanceMiles: v.distanceMiles || v.DistanceMiles || null
                        };
                    });

                    if (append) {
                        // Merge with existing and dedupe
                        const merged = [...(state.vendors || []), ...normalizedVendors];
                        const byId = new Map();
                        for (const v of merged) {
                            const key = v.vendorProfileId || v.VendorProfileID || v.id;
                            byId.set(String(key || Math.random()), v);
                        }
                        state.vendors = Array.from(byId.values());
                    } else {
                        state.vendors = normalizedVendors;
                    }
                    // Apply current filters
                    try { filterVendors(); } catch { state.filteredVendors = state.vendors.slice(); renderVendors(); }
                    // Update server paging trackers
                    state.serverPageNumber = nextPage;
                    state.serverTotalCount = totalCount;

                    if (vendorGrid) {
                        vendorGrid.innerHTML = '';
                        renderVendors();
                    }
                    
                    // Hide skeleton cards after rendering complete
                    hideVendorSkeletons();
                    
                    updatePagination();
                    updateMetadata({ total: totalCount });
                    tryInitGeolocation();
                    console.log(`Successfully loaded and rendered ${vendors.length} vendors`);
                } catch (error) {
                    console.error('Error loading vendors:', error);
                    
                    // Hide skeleton cards on error
                    hideVendorSkeletons();
                    
                    if (vendorGrid) {
                        vendorGrid.innerHTML = `
                            <div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--accent);">
                                <p>Failed to load vendors: ${error.message}</p>
                                <button class="btn btn-primary" onclick="loadVendors()" style="margin-top:1rem;">Retry</button>
                            </div>
                        `;
                    }
                }
            }

            // Get category icon
            function getCategoryIcon(category) {
                const icons = {
                    "venue": "🏢",
                    "photo": "📷",
                    "music": "🎵",
                    "catering": "🍽️",
                    "entertainment": "🎭",
                    "experiences": "⭐",
                    "decor": "🎀",
                    "beauty": "💄",
                    "cake": "🎂",
                    "transport": "🚐",
                    "planner": "📋",
                    "fashion": "👗",
                    "stationery": "✉️"
                };
                return icons[category?.toLowerCase()] || "💎";
            }

            // Add pagination event listeners
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (state.currentPage > 1) {
                        state.currentPage--;
                        renderVendors();
                        updatePagination();
                        const mapEl = document.getElementById('map-view');
                        if (mapEl && mapEl.style.display === 'block') updateMapMarkers();
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                    if (state.currentPage < totalPages) {
                        state.currentPage++;
                        renderVendors();
                        updatePagination();
                        const mapEl = document.getElementById('map-view');
                        if (mapEl && mapEl.style.display === 'block') updateMapMarkers();
                    }
                });
            }

            // Add event listeners for numbered page buttons
            document.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)').forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    const pageNum = index + 1;
                    const totalPages = Math.ceil(state.filteredVendors.length / state.vendorsPerPage);
                    if (pageNum <= totalPages) {
                        state.currentPage = pageNum;
                        renderVendors();
                        updatePagination();
                        const mapEl = document.getElementById('map-view');
                        if (mapEl && mapEl.style.display === 'block') updateMapMarkers();
                        
                        // Update active page button
                        document.querySelectorAll('.page-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });
            });

            // Initialize pagination on page load
            updatePagination();

            // DEPRECATED: Old gallery population function - replaced by populateVendorGallery()
            // Keeping for backward compatibility but not used in main flow
            function populateVendorProfileGallery(vendorData) {
                console.log('⚠️ DEPRECATED: populateVendorProfileGallery called - use populateVendorGallery instead');
                if (vendorData && vendorData.images) {
                    populateVendorGallery(vendorData.images);
                }
            }

            // Keep for backward compatibility
            window.populateVendorProfileGallery = populateVendorProfileGallery;

            // MANUAL TEST FUNCTION - Call this directly in browser console to test gallery population
            window.testGalleryWithKnownImages = function() {
                console.log('=== MANUAL GALLERY TEST ===');
                
                // Use the images we KNOW exist from Bundle Booths vendor (VendorProfileID 62)
                const testVendorData = {
                    images: [
                        {
                            url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                            isPrimary: false,
                            displayOrder: 0,
                            caption: 'Gallery Image 1'
                        },
                        {
                            url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                            isPrimary: true,
                            displayOrder: 1,
                            caption: 'Gallery Image 2'
                        },
                        {
                            url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png',
                            isPrimary: false,
                            displayOrder: 2,
                            caption: 'Gallery Image 3'
                        }
                    ],
                    profile: {
                        FeaturedImageURL: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png'
                    }
                };
                
                console.log('Testing with known images:', testVendorData);
                populateVendorProfileGallery(testVendorData);
                console.log('=== MANUAL TEST COMPLETE ===');
            };

            // SIMPLE DIRECT GALLERY POPULATION - No API calls, just use known images
            window.populateGalleryNow = function() {
                console.log('=== DIRECT GALLERY POPULATION ===');
                
                const mainImage = document.getElementById('main-vendor-image');
                const thumbnailsContainer = document.getElementById('vendor-thumbnails');
                
                if (!mainImage || !thumbnailsContainer) {
                    console.log('Gallery elements not found - make sure you are on vendor profile page');
                    return;
                }
                
                // Known working Cloudinary URLs from Bundle Booths vendor
                const knownImages = [
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png'
                ];
                
                // Set main image
                mainImage.src = knownImages[0];
                console.log('Set main image to:', knownImages[0]);
                
                // Clear and populate thumbnails
                thumbnailsContainer.innerHTML = '';
                
                knownImages.forEach((imageUrl, index) => {
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'gallery-item';
                    thumbnailDiv.style.cursor = 'pointer';
                    
                    const thumbnailImg = document.createElement('img');
                    thumbnailImg.src = imageUrl;
                    thumbnailImg.alt = `Gallery Image ${index + 1}`;
                    thumbnailImg.onclick = () => {
                        mainImage.src = imageUrl;
                        console.log('Switched main image to:', imageUrl);
                    };
                    
                    thumbnailDiv.appendChild(thumbnailImg);
                    thumbnailsContainer.appendChild(thumbnailDiv);
                });
                
                console.log('Added 3 thumbnail images to gallery');
                console.log('=== DIRECT POPULATION COMPLETE ===');
            };

            // DIAGNOSTIC FUNCTION - Check if gallery elements exist and what page we're on
            window.checkGalleryElements = function() {
                console.log('=== GALLERY DIAGNOSTIC ===');
                
                // Check if vendor profile page is visible
                const vendorProfilePage = document.getElementById('vendor-profile-page');
                console.log('Vendor profile page element:', vendorProfilePage);
                console.log('Vendor profile page display style:', vendorProfilePage ? vendorProfilePage.style.display : 'NOT FOUND');
                
                // Check for gallery elements
                const mainImage = document.getElementById('main-vendor-image');
                const thumbnailsContainer = document.getElementById('vendor-thumbnails');
                const imageGallery = document.getElementById('modal-image-gallery');
                
                console.log('Main image element:', mainImage);
                console.log('Thumbnails container:', thumbnailsContainer);
                console.log('Image gallery container:', imageGallery);
                
                if (mainImage) {
                    console.log('Current main image src:', mainImage.src);
                } else {
                    console.log('❌ Main image element NOT FOUND - you may not be on vendor profile page');
                }
                
                if (thumbnailsContainer) {
                    console.log('Thumbnails container found, current content:', thumbnailsContainer.innerHTML);
                } else {
                    console.log('❌ Thumbnails container NOT FOUND - you may not be on vendor profile page');
                }
                
                // Check what page we're actually on
                const currentUrl = window.location.href;
                const currentHash = window.location.hash;
                console.log('Current URL:', currentUrl);
                console.log('Current hash:', currentHash);
                
                // Check all possible gallery-related elements
                const allGalleryElements = document.querySelectorAll('[id*="gallery"], [id*="image"], [class*="gallery"], [class*="image"]');
                console.log('All gallery-related elements found:', allGalleryElements);
                
                console.log('=== DIAGNOSTIC COMPLETE ===');
                
                // Return status
                return {
                    vendorProfilePageExists: !!vendorProfilePage,
                    vendorProfilePageVisible: vendorProfilePage && vendorProfilePage.style.display !== 'none',
                    mainImageExists: !!mainImage,
                    thumbnailsContainerExists: !!thumbnailsContainer,
                    currentUrl: currentUrl,
                    currentHash: currentHash
                };
            };

            // DIRECT ELEMENT FINDER - Find and populate ANY gallery elements on the page
            window.findAndPopulateGallery = function() {
                console.log('=== DIRECT ELEMENT FINDER ===');
                
                // Find all possible image elements
                const allImages = document.querySelectorAll('img');
                const allDivs = document.querySelectorAll('div');
                
                console.log('Found', allImages.length, 'image elements');
                console.log('Found', allDivs.length, 'div elements');
                
                // Look for any image that might be a main vendor image (placeholder or otherwise)
                let mainImageElement = null;
                let thumbnailContainer = null;
                
                // Find main image by looking for placeholder or vendor-related images (VISIBLE ONES ONLY)
                allImages.forEach((img, index) => {
                    console.log(`Image ${index}:`, img.src, 'ID:', img.id, 'Class:', img.className);
                    
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        console.log('⏭️ Skipping hidden/modal image:', img.id);
                        return;
                    }
                    
                    if (img.src.includes('placehold.co') && 
                        (img.alt.includes('Main Venue Image') || 
                         img.alt.includes('samyy') ||
                         img.alt.includes('vendor'))) {
                        console.log('🎯 VISIBLE main image found:', img);
                        mainImageElement = img;
                    }
                });
                
                // Find container by looking for gallery-related divs
                allDivs.forEach((div, index) => {
                    if (div.id.includes('gallery') || 
                        div.id.includes('thumbnail') ||
                        div.className.includes('gallery') ||
                        div.className.includes('thumbnail')) {
                        console.log('🎯 Potential thumbnail container found:', div);
                        thumbnailContainer = div;
                    }
                });
                
                // If we found elements, populate them
                if (mainImageElement) {
                    console.log('✅ Using main image element:', mainImageElement);
                    
                    // Known working Cloudinary URLs
                    const knownImages = [
                        'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                        'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                        'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png'
                    ];
                    
                    // Set main image
                    mainImageElement.src = knownImages[0];
                    console.log('<i class="fas fa-check" style="color: #28a745;"></i> Set main image to:', knownImages[0]);
                    
                    // If we found a thumbnail container, add thumbnails
                    if (thumbnailContainer) {
                        console.log('✅ Using thumbnail container:', thumbnailContainer);
                        thumbnailContainer.innerHTML = '';
                        
                        knownImages.forEach((imageUrl, index) => {
                            const thumbnailImg = document.createElement('img');
                            thumbnailImg.src = imageUrl;
                            thumbnailImg.alt = `Gallery ${index + 1}`;
                            thumbnailImg.style.width = '100px';
                            thumbnailImg.style.height = '100px';
                            thumbnailImg.style.objectFit = 'cover';
                            thumbnailImg.style.margin = '5px';
                            thumbnailImg.style.cursor = 'pointer';
                            thumbnailImg.onclick = () => {
                                mainImageElement.src = imageUrl;
                                console.log('🔄 Switched to:', imageUrl);
                            };
                            
                            thumbnailContainer.appendChild(thumbnailImg);
                        });
                        
                        console.log('✅ Added 3 thumbnails to container');
                    } else {
                        console.log('⚠️ No thumbnail container found, only main image updated');
                    }
                    
                    console.log('🎉 GALLERY POPULATION COMPLETE!');
                    return true;
                } else {
                    console.log('❌ No suitable main image element found');
                    return false;
                }
            };

            // POPULATE ALL THUMBNAILS - Replace all thumbnail placeholder images
            window.populateAllThumbnails = function() {
                console.log('=== POPULATE ALL THUMBNAILS ===');
                
                // Known working Cloudinary URLs
                const knownImages = [
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp',
                    'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png'
                ];
                
                // Set lightbox images for navigation
                lightboxImages = knownImages;
                
                // Find ALL thumbnail placeholder images
                const allImages = document.querySelectorAll('img');
                let thumbnailCount = 0;
                let mainImageUpdated = false;
                
                allImages.forEach((img, index) => {
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        return;
                    }
                    
                    // Update main venue image
                    if (img.src.includes('placehold.co') && img.alt.includes('Main Venue Image') && !mainImageUpdated) {
                        img.src = knownImages[0];
                        // Make main image clickable to open lightbox
                        img.style.cursor = 'pointer';
                        img.onclick = () => openLightbox(0);
                        console.log('✅ Updated main venue image:', img.alt);
                        mainImageUpdated = true;
                    }
                    
                    // Update thumbnail images
                    else if (img.src.includes('placehold.co') && img.alt.includes('Thumbnail')) {
                        const thumbnailNumber = thumbnailCount % knownImages.length;
                        img.src = knownImages[thumbnailNumber];
                        
                        // FIXED: Make thumbnail clickable to ONLY open lightbox (don't change main image)
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            openLightbox(thumbnailNumber);
                            console.log('🔄 Opened lightbox at image:', thumbnailNumber);
                        };
                        
                        console.log(`✅ Updated ${img.alt} with image ${thumbnailNumber + 1}`);
                        thumbnailCount++;
                    }
                });
                
                console.log(`🎉 Updated ${mainImageUpdated ? 1 : 0} main image and ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnailCount };
            };

            // COMPLETE GALLERY SETUP - Do everything at once
            window.setupCompleteGallery = function() {
                console.log('=== COMPLETE GALLERY SETUP ===');
                
                const result = populateAllThumbnails();
                
                if (result.mainImage && result.thumbnails > 0) {
                    console.log('🎉 COMPLETE GALLERY SETUP SUCCESSFUL!');
                    console.log(`✅ Main image updated: ${result.mainImage}`);
                    console.log(`✅ Thumbnails updated: ${result.thumbnails}`);
                    console.log('🖱️ Click any thumbnail to change the main image');
                    return true;
                } else {
                    console.log('⚠️ Gallery setup incomplete');
                    console.log(`Main image: ${result.mainImage}, Thumbnails: ${result.thumbnails}`);
                    return false;
                }
            };

            // DIAGNOSTIC: Check what API is actually returning
            window.checkAPIResponse = function() {
                console.log('=== API DIAGNOSTIC ===');
                
                const urlParams = new URLSearchParams(window.location.search);
                const vendorId = urlParams.get('vendorId') || urlParams.get('id');
                const userId = urlParams.get('userId');
                
                if (!vendorId && !userId) {
                    console.log('❌ No vendor ID or user ID found in URL');
                    console.log('Current URL:', window.location.href);
                    return;
                }
                
                const apiUrl = userId ? 
                    `${API_BASE_URL}/vendors/profile?userId=${userId}` :
                    `${API_BASE_URL}/vendors/${vendorId}`;
                
                console.log('🔍 Checking API endpoint:', apiUrl);
                
                fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('📡 API Response Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📋 FULL API Response:', data);
                    
                    if (data.success) {
                        console.log('✅ API Success: true');
                        console.log('📦 Data object:', data.data);
                        
                        if (data.data && data.data.images) {
                            console.log('🖼️ Images array:', data.data.images);
                            console.log('📊 Images count:', data.data.images.length);
                            
                            if (data.data.images.length > 0) {
                                console.log('🎯 First image URL:', data.data.images[0].url);
                                console.log('🎯 All image URLs:', data.data.images.map(img => img.url));
                            } else {
                                console.log('❌ Images array is empty');
                            }
                        } else {
                            console.log('❌ No images property found in data');
                        }
                    } else {
                        console.log('❌ API Success: false');
                        console.log('Error:', data.error || data.message);
                    }
                })
                .catch(error => {
                    console.error('❌ API Call Failed:', error);
                });
            };

            // UNIVERSAL GALLERY POPULATION - Use vendor listing data that we KNOW works
            window.populateGalleryFromListingData = function() {
                console.log('=== UNIVERSAL GALLERY POPULATION ===');
                
                // Use the vendor data we KNOW exists from the vendor listing
                // From your console output, we know "Bundle Booths" has 3 images
                const knownVendorWithImages = {
                    name: 'Bundle Booths',
                    images: [
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png' },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp' },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png' }
                    ]
                };
                
                console.log('Using known vendor data:', knownVendorWithImages);
                
                // Use the working population logic
                const allImages = document.querySelectorAll('img');
                let mainImageUpdated = false;
                let thumbnailCount = 0;
                
                const imagesToUse = knownVendorWithImages.images.map(img => img.url);
                console.log('✅ Using images:', imagesToUse);
                
                // Set lightbox images for navigation
                lightboxImages = imagesToUse;
                
                allImages.forEach((img, index) => {
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        return;
                    }
                    
                    // Update main venue image
                    if (img.src.includes('placehold.co') && img.alt.includes('Main Venue Image') && !mainImageUpdated) {
                        img.src = imagesToUse[0];
                        // Make main image clickable to open lightbox
                        img.style.cursor = 'pointer';
                        img.onclick = () => openLightbox(0);
                        console.log('✅ Updated main venue image:', imagesToUse[0]);
                        mainImageUpdated = true;
                    }
                    
                    // Update thumbnail images
                    else if (img.src.includes('placehold.co') && img.alt.includes('Thumbnail')) {
                        const thumbnailNumber = thumbnailCount % imagesToUse.length;
                        img.src = imagesToUse[thumbnailNumber];
                        
                        // FIXED: Make thumbnail clickable to ONLY open lightbox (don't change main image)
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            openLightbox(thumbnailNumber);
                            console.log('🔄 Opened lightbox at image:', thumbnailNumber);
                        };
                        
                        console.log(`✅ Updated ${img.alt}:`, imagesToUse[thumbnailNumber]);
                        thumbnailCount++;
                    }
                });
                
                console.log(`🎉 Universal population complete: ${mainImageUpdated ? 1 : 0} main, ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnailCount };
            };

            // VENDOR PROFILE GALLERY POPULATION - Use vendor images array directly
            window.populateVendorProfileGallery = function(vendorData) {
                console.log('=== VENDOR PROFILE GALLERY POPULATION ===');
                console.log('Vendor data received:', vendorData);
                
                // Extract images from vendor data - now comes directly from sp_SearchVendors
                let imagesToUse = [];
                if (vendorData.images && vendorData.images.length > 0) {
                    imagesToUse = vendorData.images.map(img => img.url);
                } else if (vendorData.profile && vendorData.profile.images && vendorData.profile.images.length > 0) {
                    imagesToUse = vendorData.profile.images.map(img => img.url);
                } else {
                    console.log('❌ No images found in vendor data');
                    return { mainImage: false, thumbnails: 0 };
                }
                
                console.log('✅ Using vendor images from stored procedure:', imagesToUse);
                
                // Use the same population logic as the universal function
                const allImages = document.querySelectorAll('img');
                let mainImageUpdated = false;
                let thumbnailCount = 0;
                
                allImages.forEach((img, index) => {
                    // Skip hidden/modal images
                    if (img.id === 'lightbox-image' || img.closest('[style*="display: none"]')) {
                        return;
                    }
                    
                    // Update main venue image
                    if (img.src.includes('placehold.co') && img.alt.includes('Main Venue Image') && !mainImageUpdated) {
                        img.src = imagesToUse[0];
                        console.log('✅ Updated main venue image:', imagesToUse[0]);
                        mainImageUpdated = true;
                    }
                    
                    // Update thumbnail images
                    else if (img.src.includes('placehold.co') && img.alt.includes('Thumbnail')) {
                        const thumbnailNumber = thumbnailCount % imagesToUse.length;
                        img.src = imagesToUse[thumbnailNumber];
                        
                        // Make thumbnail clickable
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            const mainImg = document.querySelector('img[alt="Main Venue Image"]');
                            if (mainImg) {
                                mainImg.src = imagesToUse[thumbnailNumber];
                                console.log('🔄 Switched main image to:', imagesToUse[thumbnailNumber]);
                            }
                        };
                        
                        console.log(`✅ Updated ${img.alt}:`, imagesToUse[thumbnailNumber]);
                        thumbnailCount++;
                    }
                });
                
                console.log(`🎉 Vendor profile gallery population complete: ${mainImageUpdated ? 1 : 0} main, ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnails };
            };

            // POPULATE GALLERY FROM VENDOR OBJECT - Use images array directly from vendor listing
            window.populateGalleryFromVendorObject = function(vendor) {
                console.log('=== POPULATING GALLERY FROM VENDOR OBJECT ===');
                console.log('Vendor object:', vendor);
                
                // Extract images from vendor object (comes from sp_SearchVendors)
                let imagesToUse = [];
                if (vendor.images && vendor.images.length > 0) {
                    imagesToUse = vendor.images.map(img => img.url);
                } else if (vendor.featuredImageURL) {
                    // Fallback to featured image if available
                    imagesToUse = [vendor.featuredImageURL];
                } else {
                    console.log('❌ No images found in vendor object');
                    return { mainImage: false, thumbnails: 0 };
                }
                
                console.log('✅ Using images from vendor object:', imagesToUse);
                
                // Populate gallery images
                const allImages = document.querySelectorAll('img');
                let mainImageUpdated = false;
                let thumbnailCount = 0;
                
                // Find main image element and thumbnail container
                const mainImageElement = document.querySelector('img[alt="Main Venue Image"]');
                const thumbnailsContainer = document.getElementById('vendor-thumbnails');
                
                if (!mainImageElement || !thumbnailsContainer) {
                    console.warn('Gallery elements not found for population');
                    return { mainImage: false, thumbnails: 0 };
                }
                
                // Set main image src to first image (primary)
                mainImageElement.src = imagesToUse[0];
                console.log('<i class="fas fa-check" style="color: #28a745;"></i> Set main venue image:', imagesToUse[0]);
                mainImageUpdated = true;
                
                // Add click event to main image to open lightbox
                mainImageElement.style.cursor = 'pointer';
                mainImageElement.addEventListener('click', () => openLightbox(0));
                
                // Clear existing thumbnails
                thumbnailsContainer.innerHTML = '';
                
                // FIXED: Add thumbnails for remaining images - ONLY open lightbox, don't change main image
                for (let i = 1; i < imagesToUse.length; i++) {
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'gallery-item';
                    
                    const thumbImg = document.createElement('img');
                    thumbImg.src = imagesToUse[i];
                    thumbImg.alt = `Thumbnail ${i}`;
                    
                    // FIXED: Add click handler to ONLY open lightbox (don't change main image)
                    thumbDiv.style.cursor = 'pointer';
                    thumbDiv.addEventListener('click', () => openLightbox(i));
                    
                    thumbDiv.appendChild(thumbImg);
                    thumbnailsContainer.appendChild(thumbDiv);
                    
                    thumbnailCount++;
                    console.log(`✅ Added thumbnail ${i}:`, imagesToUse[i]);
                }
                
                console.log(`🎉 Gallery population complete: 1 main image, ${thumbnailCount} thumbnails`);
                return { mainImage: mainImageUpdated, thumbnails: thumbnailCount };
            };

            // GALLERY TEST FUNCTIONS - Updated for new sp_SearchVendors approach
            window.testGalleryFunctionality = function() {
                console.log('=== TESTING GALLERY FUNCTIONALITY (NEW APPROACH) ===');
                
                // Test 1: Check if functions exist
                console.log('Test 1a: populateVendorProfileGallery exists?', typeof window.populateVendorProfileGallery === 'function' ? '✅ YES' : '❌ NO');
                console.log('Test 1b: populateGalleryFromVendorObject exists?', typeof window.populateGalleryFromVendorObject === 'function' ? '✅ YES' : '❌ NO');
                
                // Test 2: Create mock vendor object (as it would come from sp_SearchVendors)
                const mockVendorObject = {
                    id: 1,
                    name: 'Test Vendor',
                    images: [
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png', isPrimary: true, displayOrder: 1 },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843727/venuevue/dk9idtjs3stlhksqng9b.webp', isPrimary: false, displayOrder: 2 },
                        { url: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754842768/venuevue/hwq0uqrtimpshiit8vkr.png', isPrimary: false, displayOrder: 3 }
                    ],
                    featuredImageURL: 'https://res.cloudinary.com/dxgy4apj5/image/upload/v1754843715/venuevue/veo9hmlzoa1t37keuqfn.png'
                };
                
                console.log('Test 2: Testing with mock vendor object from sp_SearchVendors...');
                const result = window.populateGalleryFromVendorObject(mockVendorObject);
                console.log('Test 2 Result:', result);
                
                // Test 3: Check if images were actually updated
                const mainImages = document.querySelectorAll('img[alt*="Main Venue Image"]');
                const thumbnails = document.querySelectorAll('img[alt*="Thumbnail"]');
                
                console.log('Test 3: Found main images:', mainImages.length);
                console.log('Test 3: Found thumbnails:', thumbnails.length);
                
                let realImagesCount = 0;
                mainImages.forEach(img => {
                    if (!img.src.includes('placehold.co')) {
                        realImagesCount++;
                        console.log('✅ Main image updated:', img.src);
                    }
                });
                
                thumbnails.forEach(img => {
                    if (!img.src.includes('placehold.co')) {
                        realImagesCount++;
                        console.log('✅ Thumbnail updated:', img.src);
                    }
                });
                
                console.log(`Test 3: ${realImagesCount} images successfully updated with real URLs`);
                
                // Test 4: Test current vendor object
                console.log('Test 4: Current vendor object exists?', window.currentVendor ? '✅ YES' : '❌ NO');
                if (window.currentVendor) {
                    console.log('Test 4: Current vendor has images?', window.currentVendor.images && window.currentVendor.images.length > 0 ? '✅ YES' : '❌ NO');
                    console.log('Test 4: Current vendor image count:', window.currentVendor.images ? window.currentVendor.images.length : 0);
                }
                
                console.log('=== GALLERY TEST COMPLETE (NEW APPROACH) ===');
                return {
                    functionsExist: {
                        populateVendorProfileGallery: typeof window.populateVendorProfileGallery === 'function',
                        populateGalleryFromVendorObject: typeof window.populateGalleryFromVendorObject === 'function'
                    },
                    mockTestResult: result,
                    imagesFound: { main: mainImages.length, thumbnails: thumbnails.length },
                    realImagesCount: realImagesCount,
                    currentVendorExists: !!window.currentVendor,
                    currentVendorHasImages: window.currentVendor && window.currentVendor.images && window.currentVendor.images.length > 0
                };
            };

            // MANUAL GALLERY POPULATION TEST
            window.testGalleryWithRealData = function() {
                console.log('=== TESTING GALLERY WITH REAL API DATA ===');
                
                const API_BASE_URL = 'http://localhost:3000/api';
                const urlParams = new URLSearchParams(window.location.search);
                const vendorId = urlParams.get('vendorId') || urlParams.get('id');
                const userId = urlParams.get('userId');
                
                if (!vendorId && !userId) {
                    console.log('❌ No vendor ID or user ID in URL. Add ?userId=1 or ?vendorId=1 to test');
                    return;
                }
                
                const apiUrl = userId ? 
                    `${API_BASE_URL}/vendors/profile?userId=${userId}` :
                    `${API_BASE_URL}/vendors/${vendorId}`;
                
                console.log('🔍 Testing API call to:', apiUrl);
                
                fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('📡 API Response Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📋 API Response Data:', data);
                    
                    if (data.success && data.data) {
                        console.log('✅ API call successful');
                        console.log('🖼️ Images in response:', data.data.images);
                        
                        if (data.data.images && data.data.images.length > 0) {
                            console.log('🎯 Calling populateVendorProfileGallery...');
                            const result = populateVendorProfileGallery(data.data);
                            console.log('🎉 Gallery population result:', result);
                        } else {
                            console.log('❌ No images found in API response');
                        }
                    } else {
                        console.log('❌ API call failed or returned error');
                    }
                })
                .catch(error => {
                    console.error('❌ API call error:', error);
                    console.log('💡 Make sure your backend server is running on localhost:3000');
                });
            };

            // Initialize booking modal when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Add event listener for Book Now button
                const bookNowBtn = document.getElementById('book-now-btn');
                if (bookNowBtn) {
                    bookNowBtn.addEventListener('click', openBookingModal);
                }
                
                // Add event listener for closing booking modal
                const bookingModal = document.getElementById('booking-modal');
                if (bookingModal) {
                    bookingModal.addEventListener('click', function(e) {});
                }
                
                // Add event listeners for booking step navigation
                setupBookingStepNavigation();
            });
            
            function setupBookingStepNavigation() {
                // Step 1 to Step 2
                const nextToStep2Btn = document.getElementById('next-to-booking-step-2');
                if (nextToStep2Btn) {
                    nextToStep2Btn.addEventListener('click', function() {
                        if (bookingState.selectedServices.length === 0) {
                            showError('Please select at least one service category.');
                            return;
                        }
                        updateBookingStep(2);
                        // Initialize location autocomplete when entering Step 2
                        setTimeout(() => {
                            console.log('Entering Step 2 - initializing location autocomplete');
                            if (window.googleMapsLoaded || (typeof google !== 'undefined' && google.maps && google.maps.places)) {
                                initializeLocationAutocompleteNow();
                            } else {
                                console.log('Waiting for Google Maps to load...');
                                // Wait for Google Maps to load
                                const checkGoogleMaps = setInterval(() => {
                                    if (window.googleMapsLoaded || (typeof google !== 'undefined' && google.maps && google.maps.places)) {
                                        clearInterval(checkGoogleMaps);
                                        initializeLocationAutocompleteNow();
                                    }
                                }, 200);
                                
                                // Stop checking after 10 seconds
                                setTimeout(() => {
                                    clearInterval(checkGoogleMaps);
                                    console.warn('Google Maps loading timeout - autocomplete may not work');
                                }, 10000);
                            }
                        }, 100);
                    });
                }
                
                // Step 2 navigation
                const backToStep1Btn = document.getElementById('back-to-booking-step-1');
                const findVendorsBtn = document.getElementById('find-vendors-btn');
                
                if (backToStep1Btn) {
                    backToStep1Btn.addEventListener('click', () => updateBookingStep(1));
                }
                
                if (findVendorsBtn) {
                    findVendorsBtn.addEventListener('click', handleFindVendors);
                }
                
                // Step 3 navigation
                const backToStep2Btn = document.getElementById('back-to-booking-step-2');
                const sendRequestsBtn = document.getElementById('send-requests-btn');
                
                if (backToStep2Btn) {
                    backToStep2Btn.addEventListener('click', () => updateBookingStep(2));
                }
                
                if (sendRequestsBtn) {
                    sendRequestsBtn.addEventListener('click', handleSendRequests);
                }
                
                // Step 4 navigation
                const backToStep3Btn = document.getElementById('back-to-booking-step-3');
                
                if (backToStep3Btn) {
                    backToStep3Btn.addEventListener('click', () => updateBookingStep(3));
                }
                
                
                
            }

            // Step Navigation Event Handlers
            function setupStepNavigationHandlers() {
                // Step 8 Navigation Handlers
                const nextToStep9Btn = document.getElementById('next-to-step-9');
                if (nextToStep9Btn) {
                    nextToStep9Btn.addEventListener('click', async () => {
                        await handleStep8Transition();
                    });
                }

                // FAQ Form Handlers
                const addFaqBtn = document.getElementById('add-faq-btn');
                if (addFaqBtn) {
                    addFaqBtn.addEventListener('click', showFaqForm);
                }

                const addFaqItemBtn = document.getElementById('add-faq-item-btn');
                if (addFaqItemBtn) {
                    addFaqItemBtn.addEventListener('click', addFaqItem);
                }

                // Other step navigation handlers can be added here
                console.log('✅ Step navigation handlers set up');
            }

            // Handle Step 8 to Step 9 Transition
            async function handleStep8Transition() {
                try {
                    // Force save current step data (FAQ data) - override any legacy logic
                    saveCurrentStepData();
                    
                    // Ensure we're using FAQ data, not policies data
                    const step8Data = vendorSetupState.stepData.step8;
                    
                    if (!vendorSetupState.vendorProfileId) {
                        throw new Error('Vendor profile ID not found');
                    }
                    
                    // Force FAQ data structure - override any legacy policies data
                    const faqData = {
                        vendorProfileId: vendorSetupState.vendorProfileId,
                        faqs: step8Data.faqs || vendorSetupState.faqs || []
                    };
                    
                    console.log('Sending FAQ data to backend:', faqData);
                    
                    // Submit FAQ data to backend
                    const response = await fetch(`${API_BASE_URL}/vendors/setup/step8-policies`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(faqData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save FAQ data');
                    }
                    
                    const result = await response.json();
                    console.log('Step 8 FAQ data saved successfully:', result);
                    
                    // Move to next step
                    vendorSetupState.currentStep = 9;
                    showSetupStep(9);
                    
                } catch (error) {
                    console.error('Error in Step 8 transition:', error);
                    alert('Failed to save FAQ data: ' + error.message);
                }
            }

            // GLOBAL OVERRIDE: Intercept any fetch calls to step8-policies and replace policies data with FAQ data
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                // Check if this is a call to the step8-faq endpoint
                if (url && url.includes('/setup/step8-faq')) {
                    console.log('🚨 INTERCEPTED step8-faq API call');
                    console.log('Original request body:', options?.body);
                    
                    // Parse the request body
                    let requestData;
                    try {
                        requestData = JSON.parse(options?.body || '{}');
                    } catch (e) {
                        requestData = {};
                    }
                    
                    // Check if this contains policies data (legacy)
                    if (requestData.depositRequirements !== undefined || 
                        requestData.cancellationPolicy !== undefined ||
                        requestData.reschedulingPolicy !== undefined ||
                        requestData.paymentMethods !== undefined ||
                        requestData.paymentTerms !== undefined) {
                        
                        console.log('🚨 DETECTED LEGACY POLICIES DATA - REPLACING WITH FAQ DATA');
                        
                        // Get FAQ data from current state
                        const faqData = [];
                        if (vendorSetupState.faqs && vendorSetupState.faqs.length > 0) {
                            faqData.push(...vendorSetupState.faqs);
                        }
                        if (vendorSetupState.stepData.step8 && vendorSetupState.stepData.step8.faqs) {
                            faqData.push(...vendorSetupState.stepData.step8.faqs);
                        }
                        
                        // Replace with FAQ data structure
                        const newRequestData = {
                            vendorProfileId: requestData.vendorProfileId,
                            faqs: faqData
                        };
                        
                        console.log('✅ REPLACED WITH FAQ DATA:', newRequestData);
                        
                        // Update the request options
                        options = {
                            ...options,
                            body: JSON.stringify(newRequestData)
                        };
                    }
                }
                
                // Call the original fetch with potentially modified options
                return originalFetch.call(this, url, options);
            };

            // Initialize event handlers when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupStepNavigationHandlers);
            } else {
                setupStepNavigationHandlers();
            }

        });

        // ===== VENDOR SETUP IMPROVEMENTS JAVASCRIPT =====
        
        // Global variable to store configuration
        let appConfig = null;
        
        // Initialize all vendor setup improvements when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeVendorSetupImprovements();
        });

        async function initializeVendorSetupImprovements() {
            console.log('🚀 Initializing Vendor Setup Improvements...');
            
            try {
                // Set fallback configuration directly
                appConfig = {
                    googleMapsApiKey: 'AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg',
                    apiBaseUrl: 'http://localhost:3000/api'
                };
                console.log('✅ App configuration set:', appConfig);
                
                // Initialize Select2 for category dropdowns
                initializeSelect2();
                
                // Load Google Places API dynamically and then initialize
                await loadGooglePlacesAPI();
                
                // Initialize image upload handlers
                initializeImageUpload();
                
                // Initialize social media handlers
                initializeSocialMediaHandlers();
                
                // Initialize summary page functionality
                initializeSummaryPage();
                
                // Add red asterisks to all required fields
                addRequiredFieldAsterisks();
                
                console.log('✅ Vendor Setup Improvements Initialized');
            } catch (error) {
                console.error('❌ Error initializing vendor setup improvements:', error);
                // Continue with basic functionality even if some features fail
                initializeSelect2();
                initializeImageUpload();
                initializeSocialMediaHandlers();
                initializeSummaryPage();
                addRequiredFieldAsterisks();
            }
        }

        // Removed loadAppConfiguration function - no longer needed

        // Dynamically load Google Places API
        async function loadGooglePlacesAPI() {
            return new Promise((resolve, reject) => {
                if (!appConfig || !appConfig.googleMapsApiKey) {
                    console.warn('⚠️ Google Maps API key not available, skipping Google Places initialization');
                    resolve();
                    return;
                }

                // Check if Google Maps is already loaded
                if (window.google && window.google.maps) {
                    console.log('✅ Google Maps API already loaded');
                    initializeGooglePlaces();
                    resolve();
                    return;
                }

                // Google Maps API already loaded in head - just initialize
                console.log('✅ Google Maps API loaded successfully');
                setTimeout(() => {
                    initializeGooglePlaces();
                    resolve();
                }, 100);
                
                // No need to append script since it's already in head
            });
        }

        // Initialize Select2 for enhanced dropdowns
        function initializeSelect2() {
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('.select2-category').select2({
                    placeholder: 'Select categories...',
                    allowClear: true,
                    width: '100%'
                });
                console.log('✅ Select2 initialized for category dropdowns');
            } else {
                console.warn('⚠️ Select2 not available, using standard dropdowns');
            }
        }

        // Initialize Google Places Autocomplete
        function initializeGooglePlaces() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                console.log('✅ Initializing Google Places autocomplete services...');
                
                // Initialize business address autocomplete using Places API (New)
                const businessAddressField = document.getElementById('business-address');
                if (businessAddressField) {
                    console.log('Setting up business address autocomplete...');
                    const businessAutocompleteService = new google.maps.places.AutocompleteService();
                    const businessPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
                    
                    let currentBusinessRequest;
                    businessAddressField.addEventListener('input', function() {
                        const query = this.value;
                        console.log('Business address input changed:', query);
                        
                        // Clear suggestions if query is too short
                        if (query.length < 3) {
                            clearSuggestions(businessAddressField);
                            return;
                        }
                        
                        if (currentBusinessRequest) {
                            currentBusinessRequest.abort();
                        }
                        
                        console.log('Making business address autocomplete request for:', query);
                        businessAutocompleteService.getPlacePredictions({
                            input: query,
                            componentRestrictions: { country: 'ca' },
                            types: ['address']
                        }, (predictions, status) => {
                            console.log('Business address autocomplete response:', status, predictions);
                            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                                showBusinessAddressSuggestions(predictions, businessAddressField, businessPlacesService);
                            } else {
                                console.error('Business address autocomplete failed:', status);
                            }
                        });
                    });
                    
                    // Clear suggestions when clicking outside
                    document.addEventListener('click', function(e) {
                        const suggestionsContainer = businessAddressField.parentNode.querySelector('.suggestions-container');
                        const isClickInsideInput = businessAddressField.contains(e.target);
                        const isClickInsideSuggestions = suggestionsContainer && suggestionsContainer.contains(e.target);
                        
                        if (!isClickInsideInput && !isClickInsideSuggestions) {
                            clearSuggestions(businessAddressField);
                        }
                    });
                } else {
                    console.warn('Business address field not found');
                }

                // Initialize vendor address autocomplete using Places API (New)
                const vendorAddressField = document.getElementById('vendor-address');
                if (vendorAddressField) {
                    console.log('Setting up vendor address autocomplete...');
                    const vendorAutocompleteService = new google.maps.places.AutocompleteService();
                    const vendorPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
                    
                    let currentVendorRequest;
                    vendorAddressField.addEventListener('input', function() {
                        const query = this.value;
                        console.log('Vendor address input changed:', query);
                        
                        // Clear suggestions if query is too short
                        if (query.length < 3) {
                            clearSuggestions(vendorAddressField);
                            return;
                        }
                        
                        if (currentVendorRequest) {
                            currentVendorRequest.abort();
                        }
                        
                        console.log('Making vendor address autocomplete request for:', query);
                        vendorAutocompleteService.getPlacePredictions({
                            input: query,
                            componentRestrictions: { country: 'ca' },
                            types: ['address']
                        }, (predictions, status) => {
                            console.log('Vendor address autocomplete response:', status, predictions);
                            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                                showVendorAddressSuggestions(predictions, vendorAddressField, vendorPlacesService);
                            } else {
                                console.error('Vendor address autocomplete failed:', status);
                            }
                        });
                    });
                    
                    // Clear suggestions when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!vendorAddressField.contains(e.target)) {
                            clearSuggestions(vendorAddressField);
                        }
                    });
                }

                // Additional cities autocomplete using Places API (New)
                const citiesInput = document.getElementById('additional-cities-input');
                if (citiesInput && google.maps.places) {
                    const citiesAutocompleteService = new google.maps.places.AutocompleteService();
                    const citiesPlacesService = new google.maps.places.PlacesService(document.createElement('div'));
                    
                    let currentCityRequest;
                    citiesInput.addEventListener('input', function() {
                        const query = this.value;
                        if (query.length < 2) return;
                        
                        if (currentCityRequest) {
                            currentCityRequest.abort();
                        }
                        
                        citiesAutocompleteService.getPlacePredictions({
                            input: query,
                            componentRestrictions: { country: 'ca' },
                            types: ['(cities)']
                        }, (predictions, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                                showCitySuggestions(predictions, citiesInput, citiesPlacesService);
                            }
                        });
                    });
                }
                console.log('✅ Google Places Autocomplete initialized');
            } else {
                console.warn('⚠️ Google Places API not available');
            }
        }

        // Helper functions for Places API (New) suggestions
        function showAddressSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['address_components', 'formatted_address', 'geometry']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            fillAddressFields(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showCitySuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    addCityTag(prediction.structured_formatting.main_text);
                    inputElement.value = '';
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showVendorAddressSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['address_components', 'formatted_address', 'geometry']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            fillVendorAddressFields(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showBusinessAddressSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['address_components', 'formatted_address', 'geometry']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            fillCanadianAddressFields(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function showLocationSuggestions(predictions, inputElement, placesService) {
            clearSuggestions(inputElement);
            const suggestionsContainer = createSuggestionsContainer(inputElement);
            
            predictions.forEach(prediction => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = prediction.description;
                suggestionItem.addEventListener('click', () => {
                    inputElement.value = prediction.description;
                    placesService.getDetails({
                        placeId: prediction.place_id,
                        fields: ['place_id', 'geometry', 'name', 'formatted_address']
                    }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            handleLocationSelection(place);
                        }
                    });
                    clearSuggestions(inputElement);
                });
                suggestionsContainer.appendChild(suggestionItem);
            });
        }

        function createSuggestionsContainer(inputElement) {
            let container = inputElement.parentNode.querySelector('.suggestions-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'suggestions-container';
                container.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ccc;
                    border-top: none;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                inputElement.parentNode.style.position = 'relative';
                inputElement.parentNode.appendChild(container);
            }
            return container;
        }

        function clearSuggestions(inputElement) {
            const container = inputElement.parentNode.querySelector('.suggestions-container');
            if (container) {
                container.innerHTML = '';
            }
        }

        function handleLocationSelection(place) {
            if (place.geometry && place.geometry.location) {
                window.selectedEventLocation = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    name: place.name || place.formatted_address,
                    formatted_address: place.formatted_address
                };
                console.log('Event location selected:', window.selectedEventLocation);
            }
        }

        // Fill address fields from Google Places result
        function fillAddressFields(place) {
            const components = place.address_components;
            const cityInput = document.getElementById('business-city');
            const stateInput = document.getElementById('business-state');
            const postalInput = document.getElementById('business-postal');
            const latInput = document.getElementById('business-latitude');
            const lngInput = document.getElementById('business-longitude');

            // Clear existing values
            if (cityInput) cityInput.value = '';
            if (stateInput) stateInput.value = '';
            if (postalInput) postalInput.value = '';

            // Fill fields based on address components
            components.forEach(component => {
                const types = component.types;
                if (types.includes('locality') && cityInput) {
                    cityInput.value = component.long_name;
                } else if (types.includes('administrative_area_level_1') && stateInput) {
                    stateInput.value = component.long_name;
                } else if (types.includes('postal_code') && postalInput) {
                    postalInput.value = component.long_name;
                }
            });

            // Fill latitude and longitude
            if (place.geometry && place.geometry.location) {
                if (latInput) latInput.value = place.geometry.location.lat();
                if (lngInput) lngInput.value = place.geometry.location.lng();
            }

            console.log('✅ Address fields filled from Google Places');
        }

        // Add city tag to additional cities
        function addCityTag(cityName) {
            const selectedCitiesContainer = document.getElementById('selected-cities');
            if (!selectedCitiesContainer || !cityName) return;

            // Check if city already exists
            const existingTags = selectedCitiesContainer.querySelectorAll('.city-tag');
            for (let tag of existingTags) {
                if (tag.textContent.includes(cityName)) {
                    return; // City already added
                }
            }

            // Create city tag
            const cityTag = document.createElement('div');
            cityTag.className = 'city-tag';
            cityTag.style.cssText = `
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                background-color: var(--primary);
                color: white;
                padding: 0.5rem 0.75rem;
                border-radius: 20px;
                font-size: 0.9rem;
                margin: 0.25rem;
            `;
            
            cityTag.innerHTML = `
                ${cityName}
                <button type="button" onclick="removeCityTag(this, '${cityName}')" style="
                    background: none;
                    border: none;
                    color: white;
                    cursor: pointer;
                    font-size: 1rem;
                    padding: 0;
                    margin-left: 0.25rem;
                ">×</button>
            `;

            selectedCitiesContainer.appendChild(cityTag);
            
            // Update vendor setup state
            if (typeof vendorSetupState !== 'undefined') {
                if (!vendorSetupState.selectedCities) {
                    vendorSetupState.selectedCities = [];
                }
                if (!vendorSetupState.selectedCities.includes(cityName)) {
                    vendorSetupState.selectedCities.push(cityName);
                }
            } else {
                // Fallback: create temporary storage for cities
                if (!window.tempSelectedCities) {
                    window.tempSelectedCities = [];
                }
                if (!window.tempSelectedCities.includes(cityName)) {
                    window.tempSelectedCities.push(cityName);
                }
            }
            
            console.log('✅ Added city tag:', cityName);
            if (typeof vendorSetupState !== 'undefined' && vendorSetupState.selectedCities) {
                console.log('Selected cities:', vendorSetupState.selectedCities);
            }
        }
        
        // Remove city tag function
        function removeCityTag(button, cityName) {
            // Remove from DOM
            button.parentElement.remove();
            
            // Remove from vendor setup state
            if (typeof vendorSetupState !== 'undefined' && vendorSetupState.selectedCities) {
                const index = vendorSetupState.selectedCities.indexOf(cityName);
                if (index > -1) {
                    vendorSetupState.selectedCities.splice(index, 1);
                }
                console.log('Selected cities:', vendorSetupState.selectedCities);
            }
            
            console.log('Removed city tag:', cityName);
        }

        // Initialize image upload handlers
        function initializeImageUpload() {
            // Main profile image upload
            const featuredImageInput = document.getElementById('featured-image');
            if (featuredImageInput) {
                featuredImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        displayFeaturedImagePreview(file);
                    }
                });
            }

            // Gallery images upload
            const galleryImagesInput = document.getElementById('gallery-images');
            if (galleryImagesInput) {
                galleryImagesInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        displayGalleryImagePreviews(files);
                        showSelectedImagesList(files);
                    }
                });
            }

            console.log('✅ Image upload handlers initialized');
        }

        // Display featured image preview
        function displayFeaturedImagePreview(file) {
            const previewContainer = document.getElementById('featured-image-preview');
            const previewImage = document.getElementById('featured-image-display');
            
            if (previewContainer && previewImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
                console.log('✅ Featured image preview displayed');
            }
        }

        // Display gallery image previews
        function displayGalleryImagePreviews(files) {
            const previewContainer = document.getElementById('image-preview');
            if (!previewContainer) return;

            previewContainer.innerHTML = ''; // Clear existing previews

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.style.cssText = `
                        position: relative;
                        border-radius: var(--radius);
                        overflow: hidden;
                        border: 1px solid var(--border);
                    `;

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = `
                        width: 100%;
                        height: 100px;
                        object-fit: cover;
                        display: block;
                    `;

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.style.cssText = `
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 25px;
                        height: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    removeBtn.onclick = () => imageDiv.remove();

                    imageDiv.appendChild(img);
                    imageDiv.appendChild(removeBtn);
                    previewContainer.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });

            console.log('✅ Gallery image previews displayed');
        }

        // Show selected images list
        function showSelectedImagesList(files) {
            const listContainer = document.getElementById('selected-images-list');
            const namesContainer = document.getElementById('image-names-list');
            
            if (listContainer && namesContainer) {
                const fileNames = files.map(file => file.name).join(', ');
                namesContainer.textContent = `${files.length} images selected: ${fileNames}`;
                listContainer.style.display = 'block';
                console.log('✅ Selected images list displayed');
            }
        }

        // Initialize social media handlers
        function initializeSocialMediaHandlers() {
            const socialInputs = document.querySelectorAll('[data-prefix]');
            
            socialInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    const prefix = this.getAttribute('data-prefix');
                    const value = this.value.trim();
                    
                    if (value && !value.startsWith('http')) {
                        // Store the full URL in a hidden field or data attribute
                        this.setAttribute('data-full-url', prefix + value);
                        console.log('✅ Social media URL processed:', prefix + value);
                    }
                });
            });

            console.log('✅ Social media handlers initialized');
        }

        // Initialize summary page functionality
        function initializeSummaryPage() {
            // This will be called when user reaches the summary step
            window.generateVendorSetupSummary = function() {
                const summaryContainer = document.getElementById('setup-summary-content');
                if (!summaryContainer) return;

                const summaryHTML = generateComprehensiveSummary();
                summaryContainer.innerHTML = summaryHTML;
                console.log('✅ Vendor setup summary generated');
            };
        }

        // Generate comprehensive summary of all vendor information
        function generateComprehensiveSummary() {
            const summary = [];

            // Business Basics
            summary.push('<div class="summary-section">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">📋 Business Information</h5>');
            
            const businessName = document.getElementById('business-name')?.value || 'Not provided';
            const displayName = document.getElementById('display-name')?.value || 'Not provided';
            const businessEmail = document.getElementById('business-email')?.value || 'Not provided';
            const businessPhone = document.getElementById('business-phone')?.value || 'Not provided';
            const businessDescription = document.getElementById('business-description')?.value || 'Not provided';
            const tagline = document.getElementById('tagline')?.value || 'Not provided';
            const websiteUrl = document.getElementById('website-url')?.value || 'Not provided';
            const yearsInBusiness = document.getElementById('years-in-business')?.value || 'Not provided';
            
            summary.push(`<p><strong>Business Name:</strong> ${businessName}</p>`);
            summary.push(`<p><strong>Display Name:</strong> ${displayName}</p>`);
            summary.push(`<p><strong>Business Email:</strong> ${businessEmail}</p>`);
            summary.push(`<p><strong>Business Phone:</strong> ${businessPhone}</p>`);
            summary.push(`<p><strong>Description:</strong> ${businessDescription}</p>`);
            summary.push(`<p><strong>Tagline:</strong> ${tagline}</p>`);
            summary.push(`<p><strong>Website:</strong> ${websiteUrl}</p>`);
            summary.push(`<p><strong>Years in Business:</strong> ${yearsInBusiness}</p>`);
            summary.push('</div>');

            // Categories
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-tags" style="margin-right: 0.5rem;"></i>Categories</h5>');
            
            const primaryCategory = document.getElementById('primary-category')?.value || 'Not selected';
            const additionalCategories = Array.from(document.getElementById('additional-categories')?.selectedOptions || [])
                .map(option => option.text).join(', ') || 'None selected';
            
            summary.push(`<p><strong>Primary Category:</strong> ${primaryCategory}</p>`);
            summary.push(`<p><strong>Additional Categories:</strong> ${additionalCategories}</p>`);
            summary.push('</div>');

            // Location Information
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Location Information</h5>');
            
            const address = document.getElementById('business-address')?.value?.trim();
            const city = document.getElementById('business-city')?.value?.trim();
            const state = document.getElementById('business-state')?.value?.trim();
            const postal = document.getElementById('business-postal')?.value?.trim();
            const country = document.getElementById('business-country')?.value || 'Canada';
            
            if (address || city || state || postal) {
                summary.push(`<p><strong>Physical Office:</strong> Yes</p>`);
                summary.push(`<p><strong>Address:</strong> ${address || 'Not provided'}</p>`);
                summary.push(`<p><strong>City:</strong> ${city || 'Not provided'}</p>`);
                summary.push(`<p><strong>Province:</strong> ${state || 'Not provided'}</p>`);
                summary.push(`<p><strong>Postal Code:</strong> ${postal || 'Not provided'}</p>`);
                summary.push(`<p><strong>Country:</strong> ${country}</p>`);
            } else {
                summary.push(`<p><strong>Physical Office:</strong> No physical office location provided</p>`);
            }
            
            // Service Areas
            const additionalCities = Array.from(document.querySelectorAll('#selected-cities .city-tag'))
                .map(tag => tag.textContent.replace('×', '').trim()).join(', ') || 'None specified';
            summary.push(`<p><strong>Service Areas:</strong> ${additionalCities}</p>`);
            summary.push('</div>');

            // Services & Packages
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Services & Packages</h5>');
            
            // Get services from the services list
            const servicesList = document.querySelectorAll('#services-list .service-item');
            if (servicesList.length > 0) {
                summary.push('<p><strong>Services Offered:</strong></p>');
                summary.push('<ul style="margin-left: 1rem;">');
                servicesList.forEach(serviceItem => {
                    const serviceName = serviceItem.querySelector('.service-name')?.textContent || 'Unnamed Service';
                    const servicePrice = serviceItem.querySelector('.service-price')?.textContent || 'Price not set';
                    summary.push(`<li>${serviceName} - ${servicePrice}</li>`);
                });
                summary.push('</ul>');
            } else {
                summary.push('<p><strong>Services:</strong> No services added yet</p>');
            }
            summary.push('</div>');

            // Business Hours
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">🕒 Business Hours</h5>');
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            days.forEach((day, index) => {
                const availableCheckbox = document.getElementById(`available-${index}`);
                const startTime = document.getElementById(`start-time-${index}`)?.value;
                const endTime = document.getElementById(`end-time-${index}`)?.value;
                
                if (availableCheckbox?.checked && startTime && endTime) {
                    summary.push(`<p><strong>${day}:</strong> ${formatTime(startTime)} - ${formatTime(endTime)}</p>`);
                } else {
                    summary.push(`<p><strong>${day}:</strong> Closed</p>`);
                }
            });
            
            // Booking preferences
            const acceptingBookings = document.getElementById('accepting-bookings')?.checked;
            const leadTime = document.getElementById('lead-time')?.value || 'Not specified';
            summary.push(`<p><strong>Accepting New Bookings:</strong> ${acceptingBookings ? 'Yes' : 'No'}</p>`);
            summary.push(`<p><strong>Minimum Lead Time:</strong> ${leadTime}</p>`);
            summary.push('</div>');

            // Gallery & Media
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">📸 Gallery & Media</h5>');
            
            const featuredImage = document.getElementById('featured-image')?.files?.length > 0 ? 'Featured image uploaded' : 'No featured image';
            const galleryImages = document.getElementById('gallery-images')?.files?.length || 0;
            
            summary.push(`<p><strong>Featured Image:</strong> ${featuredImage}</p>`);
            summary.push(`<p><strong>Gallery Images:</strong> ${galleryImages} image(s) uploaded</p>`);
            summary.push('</div>');

            // Social Media
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">🌐 Social Media & Links</h5>');
            
            const socialPlatforms = [
                { id: 'social-facebook', name: 'Facebook', prefix: 'https://facebook.com/' },
                { id: 'social-instagram', name: 'Instagram', prefix: 'https://instagram.com/' },
                { id: 'social-twitter', name: 'Twitter', prefix: 'https://twitter.com/' },
                { id: 'social-linkedin', name: 'LinkedIn', prefix: 'https://linkedin.com/company/' },
                { id: 'social-youtube', name: 'YouTube', prefix: 'https://youtube.com/' },
                { id: 'social-tiktok', name: 'TikTok', prefix: 'https://tiktok.com/@' }
            ];
            
            let hasSocialMedia = false;
            socialPlatforms.forEach(platform => {
                const input = document.getElementById(platform.id);
                const value = input?.value?.trim();
                if (value) {
                    const fullUrl = value.startsWith('http') ? value : platform.prefix + value;
                    summary.push(`<p><strong>${platform.name}:</strong> <a href="${fullUrl}" target="_blank">${fullUrl}</a></p>`);
                    hasSocialMedia = true;
                }
            });
            
            const bookingLink = document.getElementById('booking-link')?.value?.trim();
            if (bookingLink) {
                summary.push(`<p><strong>Online Booking Link:</strong> <a href="${bookingLink}" target="_blank">${bookingLink}</a></p>`);
            }
            
            if (!hasSocialMedia && !bookingLink) {
                summary.push('<p>No social media or professional links provided</p>');
            }
            summary.push('</div>');

            // FAQ Section
            summary.push('<div class="summary-section" style="margin-top: 2rem;">');
            summary.push('<h5 style="color: var(--primary); margin-bottom: 1rem;">❓ FAQ Section</h5>');
            
            const faqsList = document.querySelectorAll('#faqs-list .faq-item');
            if (faqsList.length > 0) {
                summary.push('<div style="margin-left: 1rem;">');
                faqsList.forEach((faqItem, index) => {
                    const question = faqItem.querySelector('.faq-question')?.textContent || 'Question not found';
                    const answer = faqItem.querySelector('.faq-answer')?.textContent || 'Answer not found';
                    summary.push(`<p><strong>Q${index + 1}:</strong> ${question}</p>`);
                    summary.push(`<p><strong>A:</strong> ${answer}</p>`);
                    if (index < faqsList.length - 1) summary.push('<hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">');
                });
                summary.push('</div>');
            } else {
                summary.push('<p>No FAQs added yet</p>');
            }
            summary.push('</div>');

            return summary.join('');
        }

        // Format time for display (improved)
        function formatTime(timeString) {
            if (!timeString) return '';
            try {
                const [hours, minutes] = timeString.split(':');
                const hour = parseInt(hours, 10);
                const min = parseInt(minutes, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12;
                const displayMinutes = min.toString().padStart(2, '0');
                return `${displayHour}:${displayMinutes} ${ampm}`;
            } catch (error) {
                console.error('Error formatting time:', error);
                return timeString;
            }
        }

        // Add red asterisks to required fields
        function addRequiredFieldAsterisks() {
            const requiredFields = document.querySelectorAll('input[required], textarea[required], select[required]');
            
            requiredFields.forEach(field => {
                const label = document.querySelector(`label[for="${field.id}"]`);
                if (label && !label.innerHTML.includes('*')) {
                    // Check if asterisk is already added
                    if (!label.innerHTML.includes('<span style="color: red;">*</span>')) {
                        label.innerHTML += ' <span style="color: red;">*</span>';
                    }
                }
            });
            
            console.log('✅ Required field asterisks added');
        }

        // Override the existing step navigation to include summary generation
        const originalShowSetupStep = window.showSetupStep;
        if (originalShowSetupStep) {
            window.showSetupStep = function(stepNumber) {
                originalShowSetupStep(stepNumber);
                
                // If moving to summary step, generate the summary
                if (stepNumber === 9) {
                    setTimeout(() => {
                        if (window.generateVendorSetupSummary) {
                            window.generateVendorSetupSummary();
                        }
                    }, 100);
                }
            };
        }

        // Initialize country selection for Canadian addresses only
        document.addEventListener('DOMContentLoaded', function() {
            const businessCountrySelect = document.getElementById('business-country');
            
            // Ensure country is always set to Canada
            if (businessCountrySelect) {
                businessCountrySelect.value = 'Canada';
                businessCountrySelect.readOnly = true; // Prevent changing
            }
        });
        
        // Fill address fields from Google Places result (Canadian format)
        function fillCanadianAddressFields(place) {
            const addressComponents = place.address_components;
            let streetNumber = '';
            let route = '';
            let city = '';
            let province = '';
            let postalCode = '';
            
            addressComponents.forEach(component => {
                const types = component.types;
                
                if (types.includes('street_number')) {
                    streetNumber = component.long_name;
                } else if (types.includes('route')) {
                    route = component.long_name;
                } else if (types.includes('locality')) {
                    city = component.long_name;
                } else if (types.includes('administrative_area_level_1')) {
                    province = component.short_name; // Use short name for provinces (ON, BC, etc.)
                } else if (types.includes('postal_code')) {
                    postalCode = component.long_name;
                } else if (types.includes('country')) {
                    // Auto-populate country from Google Places (should always be Canada)
                    const countryInput = document.getElementById('business-country');
                    if (countryInput && component.long_name === 'Canada') {
                        countryInput.value = 'Canada';
                    }
                }
            });
            
            // Fill the form fields
            const fullAddress = `${streetNumber} ${route}`.trim();
            if (fullAddress) {
                document.getElementById('business-address').value = fullAddress;
            }
            
            if (city) {
                document.getElementById('business-city').value = city;
            }
            
            if (province) {
                document.getElementById('business-state').value = province;
            }
            
            if (postalCode) {
                document.getElementById('business-postal').value = postalCode;
            }
            
            console.log('✅ Canadian address fields filled:', {
                address: fullAddress,
                city: city,
                province: province,
                postalCode: postalCode
            });
        }

        // Fill vendor address fields from Google Places result (Canadian format)
        function fillVendorAddressFields(place) {
            const addressComponents = place.address_components;
            let streetNumber = '';
            let route = '';
            let city = '';
            let province = '';
            let postalCode = '';
            
            addressComponents.forEach(component => {
                const types = component.types;
                
                if (types.includes('street_number')) {
                    streetNumber = component.long_name;
                } else if (types.includes('route')) {
                    route = component.long_name;
                } else if (types.includes('locality')) {
                    city = component.long_name;
                } else if (types.includes('administrative_area_level_1')) {
                    province = component.short_name; // Use short name for provinces (ON, BC, etc.)
                } else if (types.includes('postal_code')) {
                    postalCode = component.long_name;
                } else if (types.includes('country')) {
                    // Auto-populate country from Google Places (should always be Canada)
                    const countryInput = document.getElementById('vendor-country');
                    if (countryInput && component.long_name === 'Canada') {
                        countryInput.value = 'Canada';
                    }
                }
            });
            
            // Fill the vendor form fields
            const fullAddress = `${streetNumber} ${route}`.trim();
            if (fullAddress) {
                document.getElementById('vendor-address').value = fullAddress;
            }
            
            if (city) {
                document.getElementById('vendor-city').value = city;
            }
            
            if (province) {
                document.getElementById('vendor-state').value = province;
            }
            
            if (postalCode) {
                const postalInput = document.getElementById('vendor-postalCode');
                if (postalInput) {
                    postalInput.value = postalCode;
                }
            }
            
            console.log('✅ Vendor address fields filled:', {
                address: fullAddress,
                city: city,
                province: province,
                postalCode: postalCode
            });
        }

        // SIMPLE SERVICE PREVIEW FUNCTION - GUARANTEED TO WORK
        function addServiceNow() {
            const serviceName = document.getElementById('service-name')?.value?.trim() || '';
            const serviceDescription = document.getElementById('service-description')?.value?.trim() || '';
            const servicePrice = document.getElementById('service-price')?.value || '';
            const serviceDuration = document.getElementById('service-duration')?.value || '60';

            if (!serviceName || !serviceDescription || !servicePrice) {
                alert('Please fill in all required service fields.');
                return;
            }

            // Create service preview HTML directly
            const servicePreview = `
                <div class="service-item" style="
                    background-color: white;
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    padding: 1rem;
                    margin-bottom: 0.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                ">
                    <div style="flex: 1;">
                        <h6 style="margin: 0 0 0.5rem 0; color: var(--primary); font-weight: 600;">${serviceName}</h6>
                        <p style="margin: 0 0 0.5rem 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">${serviceDescription}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-light);">
                            <span><strong>Price:</strong> $${parseFloat(servicePrice).toFixed(2)}</span>
                            <span><strong>Duration:</strong> ${serviceDuration} min</span>
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" style="
                        background: var(--accent);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                        font-size: 0.8rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-left: 0.5rem;
                    " title="Remove service">×</button>
                </div>
            `;

            // Add to services list - create container if it doesn't exist
            let servicesList = document.getElementById('services-list');
            if (!servicesList) {
                // Create the services list container if it doesn't exist
                servicesList = document.createElement('div');
                servicesList.id = 'services-list';
                servicesList.style.cssText = `
                    margin-top: 1rem;
                    padding: 1rem;
                    background-color: #f8fafc;
                    border-radius: var(--radius);
                    border: 1px solid var(--border);
                `;
                
                // Try to find a good place to insert it
                const serviceForm = document.querySelector('[data-service-form]') || 
                                  document.querySelector('.service-form') ||
                                  document.querySelector('#service-name')?.closest('form') ||
                                  document.querySelector('#service-name')?.parentElement?.parentElement;
                
                if (serviceForm) {
                    serviceForm.appendChild(servicesList);
                } else {
                    // Fallback: append to body with a header
                    const header = document.createElement('h4');
                    header.textContent = 'Added Services:';
                    header.style.cssText = 'margin: 1rem 0 0.5rem 0; color: var(--primary);';
                    document.body.appendChild(header);
                    document.body.appendChild(servicesList);
                }
            }
            
            if (servicesList) {
                servicesList.innerHTML += servicePreview;
            }

            // Clear form
            const nameField = document.getElementById('service-name');
            const descField = document.getElementById('service-description');
            const priceField = document.getElementById('service-price');
            const durationField = document.getElementById('service-duration');
            
            if (nameField) nameField.value = '';
            if (descField) descField.value = '';
            if (priceField) priceField.value = '';
            if (durationField) durationField.value = '';

            console.log('✅ Service added successfully!');
        }

        console.log('🎉 All Vendor Setup Improvements JavaScript Loaded Successfully!');

        // Google Maps and Vendor Location Functionality
        let vendorMap = null;
        let eventLocationMarker = null;
        let vendorMarkers = [];
        let geocoder = null;
        let currentVendorSections = [];

        // Global flag to track Google Maps availability
        let googleMapsLoaded = false;
        let locationAutocomplete = null;

        // Initialize Google Maps callback - matching the test file
        window.initMap = function() {
            console.log('🚀 Google Maps API callback triggered');
            
            try {
                if (typeof google === 'undefined' || !google.maps) {
                    console.error('❌ Google object not available in initMap callback');
                    return;
                }
                
                console.log('✅ Google Maps API loaded successfully');
                googleMapsLoaded = true;
                window.googleMapsLoaded = true;
                geocoder = new google.maps.Geocoder();
                
                // Initialize location autocomplete if input exists
                initializeLocationAutocompleteNow();
                
                console.log('✅ Google Maps API fully initialized');
            } catch (error) {
                console.error('❌ Error in initMap callback:', error);
            }
        };
        
        // Consolidated location autocomplete initialization
        function initializeLocationAutocompleteNow() {
            const locationInput = document.getElementById('event-location');
            if (!locationInput) {
                console.log('Event location input not found');
                return;
            }

            if (!window.google || !window.google.maps || !window.google.maps.places) {
                console.log('Google Places API not available yet');
                return;
            }

            // Clear any existing autocomplete
            if (locationAutocomplete) {
                google.maps.event.clearInstanceListeners(locationAutocomplete);
            }

            console.log('Initializing location autocomplete...');
            
            // Initialize native Google Places Autocomplete on the input element
            locationAutocomplete = new google.maps.places.Autocomplete(locationInput, {
                // Restrict to Canada only
                componentRestrictions: { country: ['ca'] },
                types: ['geocode'],
                fields: ['place_id', 'geometry', 'name', 'formatted_address']
            });

            locationAutocomplete.addListener('place_changed', function() {
                const place = locationAutocomplete.getPlace();
                
                if (!place.geometry) {
                    console.log('No geometry found for place');
                    return;
                }
                
                console.log('Place selected:', place.formatted_address);
                
                // Update the input field with the selected address
                locationInput.value = place.formatted_address;
                
                // Store the selected location globally
                window.selectedEventLocation = {
                    address: place.formatted_address,
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    place: place
                };
                
                console.log('✅ Event location stored:', window.selectedEventLocation);
                
                // Update the input field display value if needed
                if (place.formatted_address && locationInput.value !== place.formatted_address) {
                    locationInput.value = place.formatted_address;
                }
            });
            
            console.log('✅ Location autocomplete initialized successfully');
        }

        // Show map fallback when Maps API fails
        function showMapFallback() {
            console.log('🔍 Showing map fallback - checking Google Maps status');
            console.log('Google object available:', typeof google !== 'undefined');
            console.log('Google Maps available:', typeof google !== 'undefined' && google.maps);
            console.log('GoogleMapsLoaded flag:', googleMapsLoaded);
            
            const mapContainer = document.getElementById('vendor-map-container');
            const mapElement = document.getElementById('vendor-map');
            
            if (mapContainer && mapElement) {
                mapContainer.style.display = 'block';
                mapElement.innerHTML = `
                    <div style="
                        height: 400px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
                        border-radius: 12px;
                        border: 2px dashed #3498db;
                        flex-direction: column;
                        gap: 1rem;
                        text-align: center;
                        padding: 2rem;
                    ">
                        <div style="font-size: 3rem; color: #3498db;">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div>
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--text);">Map View Unavailable</h5>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                                Debugging Google Maps API loading...<br>
                                Check browser console for detailed error messages.
                            </p>
                        </div>
                        <div style="background: #fff3cd; padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.8rem; color: #856404;">
                            Google: ${typeof google !== 'undefined' ? '✅' : '❌'} | 
                            Maps: ${typeof google !== 'undefined' && google.maps ? '✅' : '❌'} | 
                            Loaded: ${googleMapsLoaded ? '✅' : '❌'}
                        </div>
                    </div>
                `;
                
                // Hide map controls since map is not functional
                const mapControls = mapContainer.querySelector('.map-controls');
                if (mapControls) {
                    mapControls.style.display = 'none';
                }
            }
        }

        // Initialize vendor map with event location and vendors
        async function initializeVendorMap(vendorSections) {
            console.log('🗺️ Initializing vendor map...');
            console.log('Google available:', typeof google !== 'undefined');
            console.log('Google Maps available:', typeof google !== 'undefined' && google.maps);
            console.log('GoogleMapsLoaded flag:', googleMapsLoaded);
            
            try {
                currentVendorSections = vendorSections;
                const mapContainer = document.getElementById('vendor-map-container');
                const mapElement = document.getElementById('vendor-map');
                
                if (!mapElement) {
                    console.warn('❌ Map element not found');
                    showMapFallback();
                    return;
                }

                // Check if Google Maps is available - but don't fail immediately
                if (typeof google === 'undefined' || !google.maps) {
                    console.log('⚠️ Google Maps not immediately available, checking if initMap was called...');
                    console.log('GoogleMapsLoaded flag:', googleMapsLoaded);
                    
                    // If Google Maps hasn't loaded yet, show the map anyway and let it load
                    if (!googleMapsLoaded) {
                        console.log('📍 Showing map container and waiting for Google Maps to load...');
                        mapContainer.style.display = 'block';
                        mapElement.innerHTML = `
                            <div style="
                                height: 400px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                background: #f8f9fa;
                                border-radius: 12px;
                                flex-direction: column;
                                gap: 1rem;
                            ">
                                <div style="font-size: 2rem;">🗺️</div>
                                <div style="color: #666;">Loading map...</div>
                            </div>
                        `;
                        
                        // Try again in 2 seconds
                        setTimeout(() => {
                            if (typeof google !== 'undefined' && google.maps) {
                                console.log('✅ Google Maps loaded, reinitializing...');
                                initializeVendorMap(vendorSections);
                            } else {
                                console.warn('❌ Google Maps still not available after timeout');
                                showMapFallback();
                            }
                        }, 2000);
                        return;
                    } else {
                        showMapFallback();
                        return;
                    }
                }

                // Show map container
                mapContainer.style.display = 'block';
                console.log('📍 Map container shown, initializing map...');

                // Get event location coordinates - prioritize stored coordinates from autocomplete
                let eventCoords = null;
                
                if (window.selectedEventLocation && window.selectedEventLocation.lat && window.selectedEventLocation.lng) {
                    // Use coordinates from autocomplete selection
                    eventCoords = {
                        lat: window.selectedEventLocation.lat,
                        lng: window.selectedEventLocation.lng
                    };
                    console.log('Using stored event location coordinates:', eventCoords);
                } else if (window.selectedEventLocation?.address && geocoder) {
                    // Fallback to geocoding if no stored coordinates
                    try {
                        console.log('Geocoding event location:', window.selectedEventLocation.address);
                        const geocodeResult = await geocodeAddress(window.selectedEventLocation.address);
                        eventCoords = geocodeResult;
                    } catch (error) {
                        console.warn('Could not geocode event location:', error);
                        // Do not fallback; require a valid selection
                        return;
                    }
                } else {
                    // No fallback: require user-selected location
                    console.warn('Map creation skipped: no event location selected.');
                    return;
                }

                // Initialize map centered on event location
                console.log('🗺️ Creating Google Map with center:', eventCoords);
                vendorMap = new google.maps.Map(mapElement, {
                    center: eventCoords,
                    zoom: 12,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ],
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true
                });
                console.log('✅ Google Map created successfully');

                // Store original vendor data for reset functionality
                window.bookingState.originalVendorSections = [...vendorSections];
                
                // Calculate initial bounds for all vendors (AC1)
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(eventCoords); // Include event location
                
                // Add vendor coordinates to bounds calculation
                const allVendors = vendorSections.flatMap(section => section.vendors);
                allVendors.forEach(vendor => {
                    if (vendor.coordinates) {
                        bounds.extend(new google.maps.LatLng(vendor.coordinates.lat, vendor.coordinates.lng));
                    }
                });
                
                // Store initial bounds for reset functionality and fit map
                window.bookingState.initialMapBounds = bounds;
                try {
                    vendorMap.fitBounds(bounds);
                    const currentZoom = vendorMap.getZoom();
                    if (currentZoom && currentZoom > 13) vendorMap.setZoom(13);
                } catch {}

                // DISABLED: Add vendor markers with distance calculation - CAUSING MARKER BOUNCING
                // await addVendorMarkers(vendorSections, eventCoords);
                
                // ADD VENDOR MARKERS FROM SEARCH-BY-SERVICES API
                console.log('🎯 Adding vendor markers after map initialization');
                if (allVendors.length > 0) {
                    // Create vendor markers directly here since state is not available in this context
                    vendorMarkers = []; // Clear existing markers
                    
                    allVendors.forEach(vendor => {
                        // Get coordinates directly from vendor data
                        const lat = parseFloat(vendor.Latitude);
                        const lng = parseFloat(vendor.Longitude);

                        console.log(`🔍 Processing vendor: ${vendor.BusinessName}, Lat: ${lat}, Lng: ${lng}`);

                        // Skip vendors without valid coordinates
                        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                            console.warn('❌ Skipping vendor with invalid coordinates:', vendor.BusinessName, { lat, lng });
                            return;
                        }

                        console.log(`📍 Creating marker for ${vendor.BusinessName} at ${lat}, ${lng}`);

                        const marker = new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            // Do not set map here; MarkerClusterer will manage it
                            title: vendor.BusinessName,
                            animation: google.maps.Animation.DROP,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#3498db',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });

                        // Store vendor data with marker for selection tracking
                        marker.vendorData = vendor;
                        vendorMarkers.push(marker);

                        // Add click event to show vendor info
                        marker.addListener('click', () => {
                            console.log(`🖱️ Clicked on vendor: ${vendor.BusinessName} (ID: ${vendor.VendorProfileID})`);
                            // You can add vendor selection logic here
                        });
                    });

                    console.log(`✅ Created ${vendorMarkers.length} vendor markers from search-by-services API`);
                    // Cluster vendor markers when zoomed out (match main page pattern)
                    try {
                        try { await loadMarkerClusterer(); } catch {}
                        if (!window.markerClusterer || !markerClusterer?.MarkerClusterer) {
                            console.warn('MarkerClusterer library not available');
                        } else {
                            if (window.bookingState.vendorClusterer) {
                                try { window.bookingState.vendorClusterer.setMap(null); } catch {}
                                window.bookingState.vendorClusterer = null;
                            }
                            window.bookingState.vendorClusterer = new markerClusterer.MarkerClusterer({
                                map: vendorMap,
                                markers: vendorMarkers,
                            });
                        }
                    } catch (e) {
                        console.warn('MarkerClusterer init failed:', e);
                    }
                }

                // AC1: Fit map to show all vendors and event location
                if (allVendors.length > 0) {
                    vendorMap.fitBounds(bounds);
                    // Ensure minimum zoom level
                    google.maps.event.addListenerOnce(vendorMap, 'bounds_changed', () => {
                        if (vendorMap.getZoom() > 15) {
                            vendorMap.setZoom(15);
                        }
                    });
                }

                // Set up map controls
                setupMapControls(eventCoords);

                // DISABLED: AC2 & AC4: Add dynamic map functionality - CAUSING MARKER BOUNCING
                // addBookingMapMovementListeners();

                // DISABLED: AC3: Add loading indicator - NOT NEEDED
                // addBookingMapLoadingIndicator();

                // DISABLED: AC6: Add reset button - NOT NEEDED
                // addBookingResetSearchButton();

            } catch (error) {
                console.error('❌ Error initializing vendor map:', error);
                console.error('Error details:', error.message, error.stack);
                showMapFallback();
            }
        }

        // Geocode address to coordinates
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                if (!geocoder) {
                    reject(new Error('Geocoder not available'));
                    return;
                }

                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else {
                        reject(new Error(`Geocoding failed: ${status}`));
                    }
                });
            });
        }

        // Add vendor markers to map
        async function addVendorMarkers(vendorSections, eventCoords) {
            // Clear existing markers
            vendorMarkers.forEach(marker => marker.setMap(null));
            vendorMarkers = [];

            const allVendors = vendorSections.flatMap(section => 
                section.vendors.map(vendor => ({
                    ...vendor,
                    serviceCategory: section.category,
                    serviceName: section.service.name
                }))
            );

            for (const vendor of allVendors) {
                try {
                    // Generate random coordinates near the event location for demo
                    // In production, you'd use actual vendor addresses
                    const vendorCoords = generateNearbyCoordinates(eventCoords, Math.random() * 10 + 1);
                    
                    // Calculate distance
                    const distance = calculateDistance(eventCoords, vendorCoords);
                    vendor.distance = distance;
                    vendor.coordinates = vendorCoords;

                    // Get category-specific icon
                    const categoryIcon = getCategoryIcon(vendor.serviceCategory || vendor.category);
                    
                    // Create vendor marker with category-specific icon
                    const marker = new google.maps.Marker({
                        position: vendorCoords,
                        map: vendorMap,
                        title: `${vendor.businessName || vendor.BusinessName} - ${distance.toFixed(1)}km away`,
                        icon: {
                            path: categoryIcon.path,
                            scale: categoryIcon.scale,
                            fillColor: categoryIcon.fillColor,
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                    
                    // Store vendor data on marker for later reference
                    marker.vendorData = vendor;

                    // Create info window for hover
                    const hoverInfoWindow = new google.maps.InfoWindow({
                        content: createVendorHoverContent(vendor, distance)
                    });

                    // Create detailed info window for click
                    const clickInfoWindow = new google.maps.InfoWindow({
                        content: createVendorInfoWindowContent(vendor)
                    });

                    // Add marker hover events
                    marker.addListener('mouseover', function() {
                        hoverInfoWindow.open(vendorMap, marker);
                        const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
                        highlightVendorCard(vendorId, true);
                    });
                    
                    marker.addListener('mouseout', function() {
                        hoverInfoWindow.close();
                        const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
                        highlightVendorCard(vendorId, false);
                    });
                    
                    marker.addListener('click', function() {
                        // Close hover info window
                        hoverInfoWindow.close();
                        
                        // Close other click info windows
                        vendorMarkers.forEach(m => {
                            if (m.clickInfoWindow) m.clickInfoWindow.close();
                        });
                        
                        // Open click info window
                        clickInfoWindow.open(vendorMap, marker);
                        
                        // Scroll to and highlight corresponding card
                        scrollToVendorCard(vendor.VendorProfileID || vendor.vendorProfileId || vendor.id);
                    });

                    marker.hoverInfoWindow = hoverInfoWindow;
                    marker.clickInfoWindow = clickInfoWindow;
                    marker.vendorData = vendor;
                    vendorMarkers.push(marker);

                } catch (error) {
                    console.warn(`Could not add marker for vendor ${vendor.businessName}:`, error);
                }
            }

            // Sort vendors by distance for the cards
            allVendors.sort((a, b) => (a.distance || 999) - (b.distance || 999));
        }

        // Function to highlight vendor card on marker hover
        function highlightVendorCard(vendorId, highlight) {
            const vendorCard = document.querySelector(`[data-vendor-id="${vendorId}"]`);
            if (vendorCard) {
                if (highlight) {
                    vendorCard.style.transform = 'scale(1.02)';
                    vendorCard.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                    vendorCard.style.border = '2px solid #10b981';
                    vendorCard.style.transition = 'all 0.2s ease';
                    
                    // Scroll card into view if not visible
                    vendorCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    vendorCard.style.transform = '';
                    vendorCard.style.boxShadow = '';
                    vendorCard.style.border = '';
                }
            }
        }
        
        // Function to highlight map marker on vendor card hover
        function highlightMapMarker(vendorId, highlight) {
            if (!vendorMarkers || vendorMarkers.length === 0) return;
            
            const marker = vendorMarkers.find(m => {
                const markerId = m.vendorData?.VendorProfileID || m.vendorData?.vendorProfileId || m.vendorData?.id;
                return markerId === vendorId || String(markerId) === String(vendorId);
            });
            
            if (marker) {
                const categoryIcon = getCategoryIcon(marker.vendorData?.serviceCategory || marker.vendorData?.category);
                const isSelected = window.bookingState?.selectedVendors?.some(v => v.vendorId === vendorId) || false;
                
                if (highlight) {
                    // Highlight marker with pulsing effect
                    marker.setIcon({
                        path: categoryIcon.path,
                        scale: categoryIcon.scale * 1.3, // Make it bigger
                        fillColor: '#10b981', // Green highlight
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    });
                    
                    // Add animation by changing the marker slightly
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                        if (marker.getAnimation() !== null) {
                            marker.setAnimation(null);
                        }
                    }, 1000);
                } else {
                    // Reset to original state
                    marker.setIcon({
                        path: categoryIcon.path,
                        scale: categoryIcon.scale,
                        fillColor: isSelected ? '#10b981' : categoryIcon.fillColor,
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: isSelected ? 3 : 2
                    });
                    marker.setAnimation(null);
                }
            }
        }
        
        // Function to get category-specific icon
        function getCategoryIcon(category) {
            const categoryIcons = {
                'Photography': {
                    path: 'M12 2C13.1 2 14 2.9 14 4V6H17C18.1 6 19 6.9 19 8V18C19 19.1 18.1 20 17 20H7C5.9 20 5 19.1 5 18V8C5 6.9 5.9 6 7 6H10V4C10 2.9 10.9 2 12 2M12 7C9.24 7 7 9.24 7 12S9.24 17 12 17 17 14.76 17 12 14.76 7 12 7M12 9C13.66 9 15 10.34 15 12S13.66 15 12 15 9 13.66 9 12 10.34 9 12 9Z',
                    fillColor: '#e74c3c',
                    scale: 0.8
                },
                'Catering': {
                    path: 'M12,2A2,2 0 0,1 14,4V8H22V10H14.82L14,22H10L9.18,10H2V8H10V4A2,2 0 0,1 12,2M11,4V8H13V4H11Z',
                    fillColor: '#f39c12',
                    scale: 0.8
                },
                'Music': {
                    path: 'M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z',
                    fillColor: '#9b59b6',
                    scale: 0.8
                },
                'Decoration': {
                    path: 'M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V19A2,2 0 0,0 5,21H11V19H5V3H13V9H21Z',
                    fillColor: '#e91e63',
                    scale: 0.8
                },
                'Venue': {
                    path: 'M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z',
                    fillColor: '#3498db',
                    scale: 0.8
                },
                'default': {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#3498db',
                    scale: 10
                }
            };
            
            return categoryIcons[category] || categoryIcons['default'];
        }
        
        // Generate nearby coordinates for demo purposes
        function generateNearbyCoordinates(center, radiusKm) {
            const earthRadius = 6371; // Earth's radius in km
            const lat1 = center.lat * Math.PI / 180;
            const lng1 = center.lng * Math.PI / 180;
            
            const bearing = Math.random() * 2 * Math.PI;
            const distance = Math.random() * radiusKm;
            
            const lat2 = Math.asin(
                Math.sin(lat1) * Math.cos(distance / earthRadius) +
                Math.cos(lat1) * Math.sin(distance / earthRadius) * Math.cos(bearing)
            );
            
            const lng2 = lng1 + Math.atan2(
                Math.sin(bearing) * Math.sin(distance / earthRadius) * Math.cos(lat1),
                Math.cos(distance / earthRadius) - Math.sin(lat1) * Math.sin(lat2)
            );
            
            return {
                lat: lat2 * 180 / Math.PI,
                lng: lng2 * 180 / Math.PI
            };
        }

        // Calculate distance between two coordinates
        function calculateDistance(coord1, coord2) {
            const R = 6371; // Earth's radius in km
            const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
            const dLng = (coord2.lng - coord1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Create hover tooltip content for vendor markers
        function createVendorHoverContent(vendor, distance) {
            const businessName = vendor.BusinessName || vendor.businessName || 'Unknown Business';
            
            // Get service name from multiple possible sources
            let serviceName = 'Service Available';
            if (vendor.services && vendor.services[0]?.ServiceName) {
                serviceName = vendor.services[0].ServiceName;
            } else if (vendor.MatchingServiceNames && Array.isArray(vendor.MatchingServiceNames)) {
                serviceName = vendor.MatchingServiceNames[0];
            } else if (vendor.MatchingServiceNames && typeof vendor.MatchingServiceNames === 'string') {
                serviceName = vendor.MatchingServiceNames.split(',')[0].trim();
            } else if (vendor.serviceName) {
                serviceName = vendor.serviceName;
            }
            
            const price = vendor.services && vendor.services[0]?.VendorPrice ? `$${vendor.services[0].VendorPrice}` : 'Price on request';
            
            return `
                <div style="padding: 0.5rem; max-width: 200px; font-size: 0.85rem;">
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                        ${businessName}
                    </div>
                    <div style="color: #10b981; font-weight: 500; margin-bottom: 0.25rem;">
                        ${serviceName} • ${price}
                    </div>
                    <div style="color: #6b7280; font-size: 0.8rem;">
                        <i class="fas fa-map-marker-alt"></i> ${distance.toFixed(1)} km from event
                    </div>
                </div>
            `;
        }

        // Create detailed info window content for vendor
        function createVendorInfoWindowContent(vendor) {
            const rating = vendor.averageRating || 4.5;
            const reviewCount = vendor.totalReviews || 0;
            const businessName = vendor.BusinessName || vendor.businessName || 'Unknown Business';
            
            // Get service name from multiple possible sources
            let serviceName = 'Service Available';
            if (vendor.services && vendor.services[0]?.ServiceName) {
                serviceName = vendor.services[0].ServiceName;
            } else if (vendor.MatchingServiceNames && Array.isArray(vendor.MatchingServiceNames)) {
                serviceName = vendor.MatchingServiceNames[0];
            } else if (vendor.MatchingServiceNames && typeof vendor.MatchingServiceNames === 'string') {
                serviceName = vendor.MatchingServiceNames.split(',')[0].trim();
            } else if (vendor.serviceName) {
                serviceName = vendor.serviceName;
            }
            
            const price = vendor.services && vendor.services[0]?.VendorPrice ? `$${vendor.services[0].VendorPrice}` : 'Price on request';
            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
            
            return `
                <div style="padding: 1rem; max-width: 280px;">
                    <h6 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1rem;">
                        <i class="fas fa-store"></i> ${businessName}
                    </h6>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="color: #f59e0b; font-size: 0.85rem;">
                            ${'★'.repeat(Math.floor(rating))}${'☆'.repeat(5-Math.floor(rating))}
                        </div>
                        <span style="font-size: 0.8rem; color: #6b7280;">
                            ${rating.toFixed(1)} (${reviewCount} reviews)
                        </span>
                    </div>
                    <div style="background: #f8faff; border: 1px solid #e1e8f0; border-radius: 6px; padding: 0.5rem; margin: 0.5rem 0;">
                        <div style="color: #10b981; font-weight: 600; font-size: 0.9rem;">${serviceName}</div>
                        <div style="color: #059669; font-weight: 700; font-size: 1rem;">${price}</div>
                    </div>
                    <p style="margin: 0.5rem 0; font-size: 0.8rem; color: #6b7280;">
                        <i class="fas fa-map-marker-alt"></i> ${vendor.distance ? vendor.distance.toFixed(1) + ' km from event location' : 'Distance unknown'}
                    </p>
                    <button onclick="selectVendorFromMap('${vendorId}')" 
                            style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Select Vendor
                    </button>
                </div>
            `;
        }

        // Scroll to and highlight vendor card when marker is clicked
        function scrollToVendorCard(vendorId) {
            const card = document.querySelector(`[data-vendor-id="${vendorId}"]`);
            if (card) {
                // Scroll to the card
                card.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Add highlight animation
                card.style.transform = 'scale(1.02)';
                card.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                card.style.transition = 'all 0.3s ease';
                
                // Remove highlight after animation
                setTimeout(() => {
                    card.style.transform = '';
                    card.style.boxShadow = '';
                }, 2000);
            }
        }

        // Setup map controls
        function setupMapControls(eventCoords) {
            // Focus event location button
            const focusBtn = document.getElementById('focus-event-location');
            if (focusBtn) {
                focusBtn.addEventListener('click', () => {
                    if (vendorMap && eventLocationMarker) {
                        vendorMap.setCenter(eventLocationMarker.getPosition());
                        vendorMap.setZoom(15);
                        
                        // Bounce the marker to highlight it
                        eventLocationMarker.setAnimation(google.maps.Animation.BOUNCE);
                        setTimeout(() => {
                            eventLocationMarker.setAnimation(null);
                        }, 2000);
                    }
                });
            }
            
            // Show all vendors button
            const showAllBtn = document.getElementById('show-all-vendors');
            if (showAllBtn) {
                showAllBtn.addEventListener('click', () => {
                    if (vendorMap && vendorMarkers.length > 0) {
                        const bounds = new google.maps.LatLngBounds();
                        
                        // Include event location in bounds
                        if (eventLocationMarker) {
                            bounds.extend(eventLocationMarker.getPosition());
                        }
                        
                        // Include all vendor markers
                        vendorMarkers.forEach(marker => {
                            bounds.extend(marker.getPosition());
                        });
                        
                        vendorMap.fitBounds(bounds);
                        
                        // Ensure minimum zoom level
                        google.maps.event.addListenerOnce(vendorMap, 'bounds_changed', () => {
                            if (vendorMap.getZoom() > 15) {
                                vendorMap.setZoom(15);
                            }
                        });
                    }
                });
            }
        }

        // Debounce mechanism for renderHorizontalVendorCards
        let renderVendorCardsTimeout = null;
        let isRenderingVendorCards = false;

        // Render horizontal vendor cards with tabbed interface for multiple services
        function renderHorizontalVendorCards(vendorSections, retryCount = 0) {
            const maxRetries = 10; // Limit retries to prevent infinite loops
            
            // Debounce multiple calls
            if (retryCount === 0) {
                if (renderVendorCardsTimeout) {
                    clearTimeout(renderVendorCardsTimeout);
                }
                
                if (isRenderingVendorCards) {
                    console.log('🔄 Already rendering vendor cards, skipping...');
                    return;
                }
                
                renderVendorCardsTimeout = setTimeout(() => {
                    renderHorizontalVendorCards(vendorSections, 0);
                }, 100);
                return;
            }
            
            isRenderingVendorCards = true;
            
            // Enhanced debugging
            console.log('🎯 renderHorizontalVendorCards called with:', {
                sectionsCount: vendorSections?.length || 0,
                sections: vendorSections,
                currentStep: window.bookingState?.currentStep,
                retryCount: retryCount
            });
            
            // Use a more robust approach to find elements
            let container = document.getElementById('vendor-cards-container');
            let cardsContainer = document.getElementById('vendor-horizontal-cards');
            let tabsContainer = document.getElementById('service-tabs-container');
            let tabsElement = document.getElementById('service-tabs');
            
            // If elements not found, wait a bit and try again (with retry limit)
            if (!container || !cardsContainer || !tabsContainer || !tabsElement) {
                if (retryCount < maxRetries) {
                    if (retryCount === 1) console.log('🔄 Elements not ready, waiting for DOM...');
                    setTimeout(() => renderHorizontalVendorCards(vendorSections, retryCount + 1), 300);
                } else {
                    console.error('❌ Max retries reached waiting for DOM elements');
                    isRenderingVendorCards = false;
                }
                return;
            }

            // Show cards container
            container.style.display = 'block';

            // Check if vendorSections is valid and has data
            if (!vendorSections || !Array.isArray(vendorSections) || vendorSections.length === 0) {
                console.warn('⚠️ No vendor sections provided or empty array');
                tabsContainer.style.display = 'none';
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h4 style="color: #666; margin-bottom: 0.5rem;">No vendors found</h4>
                        <p style="color: #999; margin: 0;">Try adjusting your search criteria or explore the map to find vendors in different areas.</p>
                    </div>
                `;
                isRenderingVendorCards = false;
                return;
            }

            // Group vendors by service
            const serviceGroups = {};
            let totalVendorCount = 0;
            
            vendorSections.forEach(section => {
                if (section.vendors && Array.isArray(section.vendors) && section.vendors.length > 0) {
                    const serviceName = section.service?.name || section.category || 'Unknown Service';
                    const serviceId = section.service?.id || section.category || serviceName.toLowerCase().replace(/\s+/g, '-');
                    
                    if (!serviceGroups[serviceId]) {
                        serviceGroups[serviceId] = {
                            id: serviceId,
                            name: serviceName,
                            category: section.category,
                            service: section.service,
                            vendors: []
                        };
                    }
                    
                    section.vendors.forEach(vendor => {
                        serviceGroups[serviceId].vendors.push({
                            ...vendor,
                            serviceCategory: section.category,
                            serviceName: serviceName,
                            serviceBudget: section.service?.budget || 0
                        });
                        totalVendorCount++;
                    });
                }
            });

            const serviceGroupsArray = Object.values(serviceGroups);
            console.log(`📋 Grouped ${totalVendorCount} vendors into ${serviceGroupsArray.length} service groups`);

            if (serviceGroupsArray.length === 0) {
                console.warn('⚠️ No vendor groups found after processing sections');
                tabsContainer.style.display = 'none';
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8faff; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h4 style="color: #666; margin-bottom: 0.5rem;">No vendors available</h4>
                        <p style="color: #999; margin: 0;">No vendors match your selected services. Try selecting different services or explore the map.</p>
                    </div>
                `;
                isRenderingVendorCards = false;
                return;
            }

            // Show/hide tabs based on number of services
            if (serviceGroupsArray.length > 1) {
                // Multiple services - show tabs
                tabsContainer.style.display = 'block';
                
                // Create tabs
                let tabsHtml = '';
                
                // Add regular service tabs
                tabsHtml += serviceGroupsArray.map((group, index) => `
                    <div class="service-tab ${index === 0 ? 'active' : ''}" 
                         data-service-id="${group.id}" 
                         onclick="switchServiceTab('${group.id}')">
                        ${group.name}
                        <span class="vendor-count">${group.vendors.length}</span>
                    </div>
                `).join('');
                
                tabsElement.innerHTML = tabsHtml;
                
                // Store service groups globally for tab switching
                window.currentServiceGroups = serviceGroups;
                
                // Update navigation buttons after tabs are rendered
                setTimeout(updateTabNavButtons, 100);
                
                // Add scroll event listener to update navigation buttons
                tabsElement.addEventListener('scroll', updateTabNavButtons);
                
                // Show first service's vendors by default
                const firstService = serviceGroupsArray[0];
                // Ensure the active service is tracked globally for selection
                window.currentActiveServiceId = firstService.id;
                renderVendorsForService(firstService);
                setTimeout(() => updateAllVendorCheckboxesForService(firstService.id), 0);
                
            } else {
                // Single service - hide tabs and show all vendors
                tabsContainer.style.display = 'none';
                const singleService = serviceGroupsArray[0];
                window.currentActiveServiceId = singleService.id;
                renderVendorsForService(singleService);
                // Sync checkboxes for the only service
                setTimeout(() => updateAllVendorCheckboxesForService(singleService.id), 0);
            }
            
            // Reset rendering flag
            isRenderingVendorCards = false;
        }

        // Function to render vendors for a specific service
        function renderVendorsForService(serviceGroup) {
            const cardsContainer = document.getElementById('vendor-horizontal-cards');
            if (!cardsContainer || !serviceGroup || !serviceGroup.vendors) return;

            // Sort vendors by distance
            const getDist = (v) => {
                if (typeof v.distance === 'number' && isFinite(v.distance)) return v.distance;
                const dfe = parseFloat(v.distanceFromEvent);
                return isNaN(dfe) ? 999 : dfe;
            };
            serviceGroup.vendors.sort((a, b) => (getDist(a) - getDist(b)));

            try {
                const cardsHtml = serviceGroup.vendors.map(vendor => {
                    try {
                        return createHorizontalVendorCard(vendor);
                    } catch (cardError) {
                        console.error('Error creating card for vendor:', vendor, cardError);
                        return '';
                    }
                }).filter(html => html.length > 0).join('');
                
                if (cardsHtml.length === 0) {
                    cardsContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; background: #fff3cd; border-radius: 12px; border: 2px dashed #ffc107;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #856404; margin-bottom: 1rem;"></i>
                            <h4 style="color: #856404; margin-bottom: 0.5rem;">Error displaying vendors</h4>
                            <p style="color: #856404; margin: 0;">There was an issue displaying the vendor cards for ${serviceGroup.name}.</p>
                        </div>
                    `;
                } else {
                    cardsContainer.innerHTML = cardsHtml;
                    console.log(`✅ Rendered ${serviceGroup.vendors.length} vendors for service: ${serviceGroup.name}`);
                    
                    // Initialize carousels for vendor cards
                    setTimeout(() => {
                        serviceGroup.vendors.forEach(vendor => {
                            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id || 'unknown-' + Math.random();
                            initializeVendorCarousel(vendorId);
                        });
                    }, 100);
                }

                // Setup sorting for current service vendors
                setupVendorSorting(serviceGroup.vendors);
                
            } catch (renderError) {
                console.error('❌ Error rendering vendor cards for service:', serviceGroup.name, renderError);
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8d7da; border-radius: 12px; border: 2px dashed #dc3545;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #721c24; margin-bottom: 1rem;"></i>
                        <h4 style="color: #721c24; margin-bottom: 0.5rem;">Rendering Error</h4>
                        <p style="color: #721c24; margin: 0;">Failed to render vendor cards for ${serviceGroup.name}.</p>
                    </div>
                `;
            }
        }

        // Function to switch between service tabs
        function switchServiceTab(serviceId) {
            console.log(`🎯 Switching to service tab: ${serviceId}`);
            
            // Set global variable to track current active service
            window.currentActiveServiceId = serviceId;
            
            // Remove active class from all tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to clicked tab
            const clickedTab = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log(`✅ Applied active class to tab: ${serviceId}`);
            }
            
            // Handle different tab types
            const serviceGroups = window.currentServiceGroups;
            if (!serviceGroups || !serviceGroups[serviceId]) {
                console.warn(`⚠️ Service group not found: ${serviceId}`);
                return;
            }

            // Render vendors for selected service
            renderVendorsForService(serviceGroups[serviceId]);
            console.log(`🔄 Switched to service tab: ${serviceGroups[serviceId].name}`);
            
            // Update all vendor checkboxes to reflect current service selection state
            setTimeout(() => {
                updateAllVendorCheckboxesForService(serviceId);
            }, 100);
        }
        
        // Helper function to update all vendor checkboxes for a specific service
        function updateAllVendorCheckboxesForService(serviceId) {
            console.log('🔄 Updating all checkboxes for service:', serviceId);
            
            document.querySelectorAll('.vendor-checkbox').forEach(checkbox => {
                const vendorCard = checkbox.closest('[data-vendor-id]');
                if (!vendorCard) return;
                
                const vendorId = vendorCard.getAttribute('data-vendor-id');
                
                // For specific service tabs, check if vendor is selected for that service
                const serviceVendors = window.bookingState.selectedVendorsByService?.[serviceId] || [];
                const shouldBeChecked = serviceVendors.some(v => {
                    const vId = v.vendorId || v.VendorProfileID || v.vendorProfileId || v.id;
                    return String(vId) === String(vendorId);
                });
                
                if (shouldBeChecked) {
                    checkbox.classList.add('checked');
                    checkbox.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                }
            });
        }
        
        // Legacy function for compatibility
        function updateAllVendorCheckboxes() {
            const activeTab = document.querySelector('.service-tab.active');
            const currentServiceId = activeTab ? activeTab.getAttribute('data-service-id') : null;
            if (currentServiceId) {
                updateAllVendorCheckboxesForService(currentServiceId);
            }
        }

        // Function to generate star rating HTML
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let starsHtml = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<i class="fas fa-star" style="color: #fbbf24;"></i>';
            }
            
            // Half star
            if (hasHalfStar) {
                starsHtml += '<i class="fas fa-star-half-alt" style="color: #fbbf24;"></i>';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += '<i class="far fa-star" style="color: #d1d5db;"></i>';
            }
            
            return starsHtml;
        }

        // Legacy function - no longer used
        function renderRecommendedTab() {
            const serviceGroups = window.currentServiceGroups;
            if (!serviceGroups) return;

            const serviceGroupsArray = Object.values(serviceGroups);
            const multiServiceVendors = findMultiServiceVendors(serviceGroupsArray);
            
            const cardsContainer = document.getElementById('vendor-horizontal-cards');
            if (!cardsContainer) return;

            if (multiServiceVendors.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <i class="fas fa-star" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                        <h3 style="margin: 0 0 0.5rem 0; color: #374151;">No Multi-Service Vendors Found</h3>
                        <p style="margin: 0;">None of the available vendors offer multiple services from your selection.</p>
                    </div>
                `;
                return;
            }

            const vendorCardsHtml = multiServiceVendors.map(vendor => {
                const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.vendorId || vendor.id;
                const businessName = vendor.BusinessName || vendor.businessName || vendor.name || 'Unknown Business';
                const location = vendor.Location || vendor.location || 'Location not specified';
                const rating = vendor.AverageRating || vendor.averageRating || vendor.rating || 0;
                const reviewCount = vendor.ReviewCount || vendor.reviewCount || vendor.reviews || 0;
                const featuredImage = vendor.ProfileImageURL || vendor.profileImageURL || vendor.image || vendor.FeaturedImageURL;
                const vendorDescription = vendor.Description || vendor.description || vendor.BusinessDescription || '';
                
                // Create services list with scroll if needed
                const servicesHtml = vendor.offeredServices.map(service => 
                    `<div style="padding: 0.3rem 0.5rem; background: #f8f9fa; border-radius: 6px; margin: 0.2rem 0; font-size: 0.75rem; color: #6b7280; font-weight: 500;">${service}</div>`
                ).join('');

                return `
                    <div class="vendor-card" data-vendor-id="${vendorId}">
                        <div class="vendor-image">
                            ${featuredImage ? 
                                `<img src="${featuredImage}" alt="${businessName}" style="width:100%;height:100%;object-fit:cover;">` : 
                                `<div style="width:100%;height:100%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#666;">${businessName.charAt(0).toUpperCase()}</div>`
                            }
                            <div class="vendor-badges" style="position: absolute; bottom: 12px; left: 12px; display: flex; gap: 6px;">
                                ${(vendor.IsPremium) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #5e72e4; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Premium</span>' : ''}
                                ${(vendor.IsEcoFriendly) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #38a169; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Eco-Friendly</span>' : ''}
                                ${(vendor.IsAwardWinning) ? '<span class="badge" style="background: rgba(255, 255, 255, 0.95); color: #d69e2e; padding: 0.4rem 0.8rem; border-radius: 25px; font-size: 0.75rem; font-weight: 700; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">Award Winning</span>' : ''}
                            </div>
                        </div>
                        <div class="vendor-details">
                            <h3 class="vendor-name">${businessName}</h3>
                            <div class="vendor-location" style="margin: 0.5rem 0; font-size: 0.9rem; color: #666;">
                                <span style="color: #888; margin-right: 0.5rem;">Location:</span>${location}
                            </div>
                            <div class="vendor-business-type" style="margin: 0.5rem 0; font-size: 0.85rem; color: #666; font-style: italic;">
                                ${vendor.BusinessType || 'Service Provider'}
                            </div>
                            <div class="vendor-rating" style="display: flex; align-items: center; gap: 8px; margin: 0.5rem 0;">
                                <div class="stars">
                                    ${generateStarRating(rating)}
                                </div>
                                <span style="font-size: 0.85rem; color: #666;">${rating.toFixed(1)} (${reviewCount} reviews)</span>
                            </div>
                            <div class="vendor-services-section" style="margin: 0.6rem 0;">
                                <div style="font-weight: 600; font-size: 0.85rem; color: #4b5563; margin-bottom: 0.4rem;">Services Offered:</div>
                                <div class="services-list" style="max-height: 120px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                                    ${servicesHtml}
                                </div>
                            </div>
                            <div class="vendor-description" style="margin: 0.6rem 0; font-size: 0.9rem; color: #4b5563; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                ${vendorDescription || 'Professional service provider offering quality services for your event.'}
                            </div>
                            <div class="vendor-footer">
                                <button class="btn btn-outline view-profile-btn" onclick="event.preventDefault(); event.stopPropagation(); const baseUrl = window.location.origin; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');" style="border-radius: 12px; font-weight: 600;">View Profile</button>
                                <button class="btn btn-primary btn-select-vendor" onclick="selectVendorForAllServices('${vendorId}')" style="border-radius: 12px; font-weight: 600;">
                                    Select for All Services
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            cardsContainer.innerHTML = `<div class="vendor-cards-grid">${vendorCardsHtml}</div>`;
        }

        // Function to select a vendor for all applicable services
        function selectVendorForAllServices(vendorId) {
            const serviceGroups = window.currentServiceGroups;
            if (!serviceGroups) return;

            let selectedCount = 0;
            
            // Find the vendor in each service group and select them
            Object.values(serviceGroups).forEach(serviceGroup => {
                const vendor = serviceGroup.vendors.find(v => {
                    const vId = v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id;
                    return vId == vendorId;
                });
                
                if (vendor) {
                    selectVendor(vendor, serviceGroup.id);
                    selectedCount++;
                }
            });

            console.log(`✅ Selected vendor ${vendorId} for ${selectedCount} services`);
            
            // Show success message
            showNotification(`Vendor selected for ${selectedCount} services!`, 'success');
        }

        // Function to scroll service tabs
        function scrollTabs(direction) {
            const tabsElement = document.getElementById('service-tabs');
            if (!tabsElement) return;
            
            const scrollAmount = 200;
            if (direction === 'left') {
                tabsElement.scrollLeft -= scrollAmount;
            } else {
                tabsElement.scrollLeft += scrollAmount;
            }
            
            // Update navigation button visibility
            setTimeout(updateTabNavButtons, 100);
        }
        
        // Function to update tab navigation button visibility
        function updateTabNavButtons() {
            const tabsElement = document.getElementById('service-tabs');
            const leftBtn = document.getElementById('tabs-scroll-left');
            const rightBtn = document.getElementById('tabs-scroll-right');
            
            if (!tabsElement || !leftBtn || !rightBtn) return;
            
            const canScrollLeft = tabsElement.scrollLeft > 0;
            const canScrollRight = tabsElement.scrollLeft < (tabsElement.scrollWidth - tabsElement.clientWidth);
            
            leftBtn.style.display = canScrollLeft ? 'flex' : 'none';
            rightBtn.style.display = canScrollRight ? 'flex' : 'none';
        }
        
        // Initialize tab navigation on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add resize observer for tab navigation
            if (window.ResizeObserver) {
                const tabsElement = document.getElementById('service-tabs');
                if (tabsElement) {
                    const resizeObserver = new ResizeObserver(updateTabNavButtons);
                    resizeObserver.observe(tabsElement);
                }
            }
            
            // Add window resize listener as fallback
            window.addEventListener('resize', updateTabNavButtons);
        });

        // Function to find vendors that offer multiple services
        function findMultiServiceVendors(serviceGroups) {
            const vendorServiceMap = new Map();
            
            console.log('🔍 Finding multi-service vendors from groups:', serviceGroups.map(g => g.name));
            
            // Build map of vendors and their services
            serviceGroups.forEach(group => {
                if (!group.vendors || group.vendors.length === 0) {
                    console.log(`⚠️ No vendors found in group: ${group.name}`);
                    return;
                }
                
                group.vendors.forEach(vendor => {
                    const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.vendorId || vendor.id;
                    const businessName = vendor.BusinessName || vendor.businessName || vendor.name || 'Unknown';
                    
                    if (!vendorServiceMap.has(vendorId)) {
                        vendorServiceMap.set(vendorId, {
                            vendor: vendor,
                            services: [],
                            businessName: businessName
                        });
                    }
                    vendorServiceMap.get(vendorId).services.push(group.name);
                });
            });
            
            console.log('📊 Vendor service mapping:', Array.from(vendorServiceMap.entries()).map(([id, data]) => ({
                id,
                name: data.businessName,
                serviceCount: data.services.length,
                services: data.services
            })));
            
            // Filter vendors that offer more than one service
            const multiServiceVendors = [];
            vendorServiceMap.forEach((data, vendorId) => {
                if (data.services.length > 1) {
                    multiServiceVendors.push({
                        ...data.vendor,
                        offeredServices: data.services
                    });
                }
            });
            
            console.log('✨ Multi-service vendors found:', multiServiceVendors.length, multiServiceVendors.map(v => ({
                name: v.BusinessName || v.businessName || v.name,
                services: v.offeredServices
            })));
            
            // If no multi-service vendors found, return top-rated vendors from all services
            if (multiServiceVendors.length === 0) {
                console.log('🔄 No multi-service vendors found, showing top-rated vendors instead');
                const allVendors = [];
                serviceGroups.forEach(group => {
                    if (group.vendors) {
                        group.vendors.forEach(vendor => {
                            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.vendorId || vendor.id;
                            if (!allVendors.find(v => (v.VendorProfileID || v.vendorProfileId || v.vendorId || v.id) === vendorId)) {
                                allVendors.push({
                                    ...vendor,
                                    offeredServices: [group.name]
                                });
                            }
                        });
                    }
                });
                
                // Sort by rating and return top 3
                return allVendors
                    .sort((a, b) => (b.AverageRating || b.averageRating || 0) - (a.AverageRating || a.averageRating || 0))
                    .slice(0, 3);
            }
            
            return multiServiceVendors;
        }

        // Helper: format unified pricing label for a service
        function formatUnifiedServicePrice(service) {
            if (!service) return '';
            const pm = service.pricingModel || service.PricingModel;
            const fpt = service.fixedPricingType || service.FixedPricingType;
            const baseRate = service.baseRate ?? service.BaseRate;
            const baseDur = service.baseDurationMinutes ?? service.BaseDurationMinutes;
            const ot = service.overtimeRatePerHour ?? service.OvertimeRatePerHour;
            const minFee = service.minimumBookingFee ?? service.MinimumBookingFee;
            const fixedPrice = service.fixedPrice ?? service.FixedPrice;
            const ppp = service.pricePerPerson ?? service.PricePerPerson;
            const minA = service.minimumAttendees ?? service.MinimumAttendees;
            const maxA = service.maximumAttendees ?? service.MaximumAttendees;

            const fmtMoney = (v) => (v == null || isNaN(v)) ? '' : `$${Number(v).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            const minsToH = (m) => (m && !isNaN(m)) ? `${m} min` : '';

            if (pm === 'time_based') {
                let parts = [];
                if (baseRate != null) parts.push(`${fmtMoney(baseRate)}`);
                if (ot != null) parts.push(`Additional hour ${fmtMoney(ot)}/hr`);
                if (minFee != null && Number(minFee) > 0) parts.push(`Min ${fmtMoney(minFee)}`);
                return parts.join(' · ');
            }

            if (pm === 'fixed_based') {
                if (fpt === 'fixed_price') {
                    return fixedPrice != null ? `${fmtMoney(fixedPrice)} Fixed` : '';
                }
                if (fpt === 'per_attendee') {
                    let label = ppp != null ? `${fmtMoney(ppp)}/person` : '';
                    const range = [minA, maxA].filter(v => v != null).map(v => Number(v)).join('-');
                    if (range) label += ` • ${range} ppl`;
                    return label;
                }
            }
            // Fallback to legacy VendorPrice/Price
            const legacy = service.VendorPrice ?? service.Price;
            return legacy != null ? fmtMoney(legacy) : '';
        }

        // Create horizontal vendor card HTML
        function createHorizontalVendorCard(vendor) {
            console.log('Creating vendor card for:', vendor);
            
            // Validate vendor object
            if (!vendor || typeof vendor !== 'object') {
                console.error('Invalid vendor object:', vendor);
                return '';
            }
            
            // Use the correct property names from API response
            const businessName = vendor.BusinessName || vendor.businessName || vendor.name || 'Unknown Business';
            const location = vendor.Location || vendor.location || vendor.address || 'Location not specified';
            const description = (
                vendor.BusinessDescription ||
                vendor.businessDescription ||
                vendor.description ||
                vendor.VendorDescription ||
                vendor.vendor?.BusinessDescription ||
                vendor.vendor?.Description ||
                vendor.Summary || vendor.summary ||
                vendor.Bio || vendor.bio ||
                ''
            );
            const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id || 'unknown-' + Math.random();
            
            // Get vendor images - support multiple images for carousel (robust like Step 4)
            const vendorImages = [];
            const urlFrom = (obj) => {
                if (!obj) return null;
                if (typeof obj === 'string') return obj;
                const cand = obj.ImageURL || obj.ImageUrl || obj.URL || obj.Url || obj.url || obj.src || obj.image || obj.Path || obj.ImagePath || obj.path;
                return typeof cand === 'string' ? cand : null;
            };
            if (vendor.FeaturedImageURL || vendor.profileImageUrl || vendor.featuredImageUrl) {
                vendorImages.push(vendor.FeaturedImageURL || vendor.profileImageUrl || vendor.featuredImageUrl);
            }
            if (Array.isArray(vendor.images)) vendorImages.push(...vendor.images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
            if (Array.isArray(vendor.Images)) vendorImages.push(...vendor.Images.map(i => urlFrom(i) || (typeof i === 'string' ? i : null)).filter(Boolean));
            if (Array.isArray(vendor.VendorImages)) vendorImages.push(...vendor.VendorImages.map(img => urlFrom(img)).filter(Boolean));
            if (Array.isArray(vendor.GalleryImages)) vendorImages.push(...vendor.GalleryImages.map(img => urlFrom(img)).filter(Boolean));
            if (Array.isArray(vendor.Photos)) vendorImages.push(...vendor.Photos.map(img => urlFrom(img)).filter(Boolean));
            if (Array.isArray(vendor.photoUrls)) vendorImages.push(...vendor.photoUrls);
            if (typeof vendor.ImageURLs === 'string') vendorImages.push(...vendor.ImageURLs.split(',').map(s => s.trim()));
            if (typeof vendor.imageUrls === 'string') vendorImages.push(...vendor.imageUrls.split(',').map(s => s.trim()));
            ['image1','image2','image3','image4','image5','Image1','Image2','Image3','Image4','Image5'].forEach(k => {
                if (vendor[k]) vendorImages.push(vendor[k]);
            });
            
            // Remove duplicates and filter out empty values
            const uniqueImages = [...new Set(vendorImages.filter(img => img && typeof img === 'string' && img.trim()))];
            
            // Get service details from the services array
            let serviceTags = [];
            
            if (vendor.services && vendor.services.length > 0) {
                vendor.services.forEach(service => {
                    serviceTags.push({
                        name: service.ServiceName,
                        price: service.VendorPrice || 0
                    });
                });
            }
            
            // Get service names for tags - ensure it's always an array
            let serviceNames = [];
            
            // Debug: Log vendor data to see structure
            console.log('🔍 Vendor data structure:', {
                vendor: vendor,
                MatchingServiceNames: vendor.MatchingServiceNames,
                services: vendor.services,
                serviceName: vendor.serviceName,
                serviceCategory: vendor.serviceCategory
            });
            
            if (vendor.MatchingServiceNames && Array.isArray(vendor.MatchingServiceNames) && vendor.MatchingServiceNames.length > 0) {
                serviceNames = vendor.MatchingServiceNames;
            } else if (vendor.MatchingServiceNames && typeof vendor.MatchingServiceNames === 'string' && vendor.MatchingServiceNames.trim()) {
                serviceNames = vendor.MatchingServiceNames.split(',').map(s => s.trim());
            } else if (vendor.serviceName) {
                serviceNames = [vendor.serviceName];
            } else if (vendor.services && Array.isArray(vendor.services) && vendor.services.length > 0) {
                serviceNames = vendor.services.map(s => s.ServiceName).filter(name => name);
            } else if (vendor.serviceCategory) {
                serviceNames = [vendor.serviceCategory];
            } else {
                serviceNames = ['Service'];
            }
            
            console.log('🎯 Extracted service names:', serviceNames);
            
            const rating = vendor.averageRating || 4.5;
            const reviewCount = vendor.totalReviews || 0;

            // Ensure distance is calculated if missing but coords exist
            try {
                const evt = window.bookingState?.eventDetails?.locationCoords;
                // Coerce vendor lat/lng to numbers if strings
                const rawLat = vendor?.coordinates?.lat ?? vendor?.Latitude ?? vendor?.latitude;
                const rawLng = vendor?.coordinates?.lng ?? vendor?.Longitude ?? vendor?.longitude;
                const vLat = (typeof rawLat === 'string') ? parseFloat(rawLat) : rawLat;
                const vLng = (typeof rawLng === 'string') ? parseFloat(rawLng) : rawLng;
                const distIsNumber = typeof vendor.distance === 'number' && isFinite(vendor.distance);
                if (!distIsNumber && evt && typeof evt.lat === 'number' && typeof evt.lng === 'number' && typeof vLat === 'number' && typeof vLng === 'number' && isFinite(vLat) && isFinite(vLng)) {
                    if (typeof haversineKm === 'function') {
                        vendor.distance = haversineKm(evt.lat, evt.lng, vLat, vLng);
                        console.log('🧭 Card fallback distance set:', { name: vendor.BusinessName || vendor.name, distance: vendor.distance, vLat, vLng, evt });
                    }
                }
            } catch (e) {
                console.warn('Distance fallback computation skipped in card:', e);
            }

            // Prefer client-computed distance; fallback to backend-provided distanceFromEvent
            let distVal = (typeof vendor.distance === 'number' && isFinite(vendor.distance)) 
                ? vendor.distance 
                : (vendor.distanceFromEvent != null && !isNaN(parseFloat(vendor.distanceFromEvent)) 
                    ? parseFloat(vendor.distanceFromEvent) 
                    : null);
            const hasDistance = typeof distVal === 'number' && isFinite(distVal);
            // Display in kilometers as e.g. "5km away"
            const distanceLabel = hasDistance ? `${Math.round(distVal)}km away` : null;
            const isSelected = (typeof bookingState !== 'undefined' && bookingState.selectedVendors) ? 
                window.bookingState.selectedVendors.some(v => v.vendorProfileId === vendorId) : false;
            
            // Starting price from backend; coerce strings like "$1,234.00" to number
            let startingPriceRaw = vendor.startingPrice ?? vendor.MinPriceNumeric ?? null;
            if ((startingPriceRaw === null || typeof startingPriceRaw !== 'number') && typeof vendor.startingPrice === 'string') {
                const parsed = parseFloat(vendor.startingPrice.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) startingPriceRaw = parsed;
            }
            if ((startingPriceRaw === null || typeof startingPriceRaw !== 'number') && typeof vendor.MinPrice === 'string') {
                const parsed = parseFloat(vendor.MinPrice.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) startingPriceRaw = parsed;
            }
            if ((startingPriceRaw === null || typeof startingPriceRaw !== 'number') && typeof vendor.price === 'string') {
                const parsed = parseFloat(vendor.price.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) startingPriceRaw = parsed;
            }
            const startingServiceName = vendor.startingServiceName || vendor.StartingServiceName || vendor.MinServiceName || '';
            const startingPriceDisplay = (typeof startingPriceRaw === 'number' && !isNaN(startingPriceRaw))
                ? `$${Math.round(startingPriceRaw).toLocaleString()}`
                : '';

            // Create image carousel HTML
            const imageCarouselHtml = uniqueImages.length > 0 ? `
                <div class="vendor-card-image-container">
                    <div class="vendor-image-carousel" id="carousel-${vendorId}">
                        ${uniqueImages.map(img => `
                            <img src="${img}" alt="${businessName}" class="vendor-card-image" 
                                 onerror="this.style.display='none';">
                        `).join('')}
                    </div>
                    ${uniqueImages.length > 1 ? `
                        <button class="carousel-nav prev" onclick="event.stopPropagation(); navigateCarousel('${vendorId}', -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="carousel-nav next" onclick="event.stopPropagation(); navigateCarousel('${vendorId}', 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="carousel-dots">
                            ${uniqueImages.map((_, index) => `
                                <div class="carousel-dot ${index === 0 ? 'active' : ''}" 
                                     onclick="event.stopPropagation(); goToCarouselSlide('${vendorId}', ${index})"></div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            ` : `
                <div class="vendor-card-image-container">
                    <div class="vendor-no-image">
                        <i class="fas fa-user-tie" style="font-size: 2rem; color: var(--primary);"></i>
                    </div>
                </div>
            `;

            // Build services as consistent tiles (detailed and fallback)
            let serviceDetails = '';
            const svcArrayRaw = Array.isArray(vendor.services) ? vendor.services
                : (Array.isArray(vendor.Services) ? vendor.Services
                : (Array.isArray(vendor.VendorServices) ? vendor.VendorServices : []));
            // Deduplicate by name to avoid duplicates in review and elsewhere
            const nameKey = (n) => (n || '').toString().trim().toLowerCase();
            const seenNames = new Set();
            const svcArray = svcArrayRaw.filter(svc => {
                const n = nameKey(svc?.ServiceName || svc?.name);
                if (!n) return true;
                if (seenNames.has(n)) return false;
                seenNames.add(n);
                return true;
            });

            if (svcArray.length > 0) {
                const tiles = svcArray.map(svc => {
                    const name = svc.ServiceName || svc.name || 'Service';
                    const fullLabel = formatUnifiedServicePrice(svc);
                    // Split into a primary price (for right side) and meta (below)
                    let primaryPrice = '';
                    let metaExtra = '';
                    if (fullLabel) {
                        const parts = fullLabel.split('·').map(s => s.trim());
                        primaryPrice = parts.shift() || '';
                        metaExtra = parts.join(' · ');
                    }
                    const dur = svc.baseDurationMinutes ?? svc.BaseDurationMinutes ?? svc.VendorDurationMinutes ?? svc.DurationMinutes;
                    const minA = svc.minimumAttendees ?? svc.MinimumAttendees;
                    const maxA = svc.maximumAttendees ?? svc.MaximumAttendees;
                    const attendance = (minA != null || maxA != null) ? `${minA ?? ''}${(minA!=null&&maxA!=null)?'-':''}${maxA ?? ''} ppl` : '';
                    const meta = [dur ? `${dur} min` : '', metaExtra, attendance].filter(Boolean).join(' · ');
                    return `
                        <div class="service-pill">
                            <div class="service-pill-header">
                                <span class="service-pill-name">${name}</span>
                                ${primaryPrice ? `<span class="service-pill-price">${primaryPrice}</span>` : ''}
                            </div>
                            ${meta ? `<div class=\"service-pill-meta\">${meta}</div>` : ''}
                        </div>`;
                }).join('');
                // Add scroll if more than 2 services
                const needsScroll = svcArray.length > 2;
                const scrollStyles = needsScroll ? 'max-height: 150px; overflow-y: auto; padding-right: 6px;' : '';
                serviceDetails = `
                    <div style="padding-right: 2px; ${scrollStyles}">
                        <div style="display:grid; grid-template-columns: 1fr; gap:8px;">${tiles}</div>
                    </div>`;
            } else {
                // Fallback to names if no detailed services present
                const displayServiceName = Array.isArray(serviceNames) && serviceNames.length > 0 ? serviceNames[0] : '';
                const secondaryServices = Array.isArray(serviceNames) && serviceNames.length > 1 ? serviceNames.slice(1, 3).join(' • ') : '';
                const names = [displayServiceName].concat(secondaryServices ? secondaryServices.split(' • ') : []).filter(Boolean);
                if (names.length > 0) {
                    const tiles = names.map(n => `
                        <div class="service-pill">
                            <div class="service-pill-header">
                                <span class="service-pill-name">${n}</span>
                            </div>
                        </div>`).join('');
                    const needsScroll = names.length > 2;
                    const scrollStyles = needsScroll ? 'max-height: 150px; overflow-y: auto; padding-right: 6px;' : '';
                    serviceDetails = `
                        <div style="padding-right: 2px; ${scrollStyles}">
                            <div style="display:grid; grid-template-columns: 1fr; gap:8px;">${tiles}</div>
                        </div>`;
                }
            }
            

            const isReviewContext = vendor.__context === 'review';
            const cardOnClick = isReviewContext ? '' : `onclick="console.log('Card clicked!'); console.log('About to call toggleVendorSelection with:', '${vendorId}'); toggleVendorSelectionForCurrentService('${vendorId}'); console.log('toggleVendorSelection call completed');"`;
            return `
                <div class="vendor-horizontal-card ${isSelected ? 'selected' : ''}" 
                     data-vendor-id="${vendorId}" 
                     onmouseover="highlightMapMarker('${vendorId}', true)" 
                     onmouseout="highlightMapMarker('${vendorId}', false)" 
                     ${cardOnClick}>
                    ${imageCarouselHtml}
                    
                    <div class="vendor-card-content">
                        <div style="margin-bottom: 0.5rem;">
                            <!-- Row 1: Name (left) + Distance pill (right) -->
                            <div style="display:grid; grid-template-columns: 1fr auto; align-items:start; column-gap:8px;">
                                <h4 style="font-size: 1rem; margin: 0; font-weight: 600; color: #4b5563;">${businessName}</h4>
                                ${distanceLabel ? `<span style="font-size: 0.8rem; color: #6b7280; background:#eef2ff; border:1px solid #c7d2fe; padding:2px 8px; border-radius:9999px; white-space:nowrap; display:inline-flex; align-items:center; gap:6px;"><i class="fas fa-location-arrow" style="font-size:0.8rem; color:#4f46e5;"></i>${distanceLabel}</span>` : ''}
                            </div>
                            <!-- Row 2: Stars/Rating/Location (left) + 'No reviews yet' (right when applicable) -->
                            <div style="display:grid; grid-template-columns: 1fr auto; align-items:center; margin-top: 0.25rem; column-gap:8px;">
                                <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                                    <div style="color: #f59e0b; font-size: 0.85rem; line-height:1;">${(reviewCount && reviewCount > 0) ? '★'.repeat(Math.floor(rating)) + '☆'.repeat(5 - Math.floor(rating)) : '☆☆☆☆☆'}</div>
                                    <span style="font-size: 0.8rem; color: #9ca3af; white-space:nowrap;">${(reviewCount && reviewCount > 0) ? `${rating.toFixed(1)} (${reviewCount})` : ''}</span>
                                    ${location ? `<span style="font-size: 0.8rem; color: #9ca3af; white-space:nowrap;">• ${location}</span>` : ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #6b7280; white-space:nowrap; text-align:right;"></div>
                            </div>
                        </div>
                        
                        ${description ? `<div style="font-size: 0.9rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.5rem; display: -webkit-box; line-clamp: 2; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${description}</div>` : ''}
                        ${startingPriceDisplay ? `
                        <div style="font-size: 0.9rem; color: #059669; font-weight: 700; margin-bottom: 0.5rem;">
                            Starting from ${startingPriceDisplay}${startingServiceName ? ` • <span style="font-weight:600; color:#059669;">${startingServiceName}</span>` : ''}
                        </div>` : ''}
                        
                        <div style="margin-bottom: 0.5rem;">
                            ${serviceDetails}
                        </div>
                        
                    </div>
                    
                    ${isReviewContext ? '' : `
                    <!-- New Actions Column -->
                    <div class="vendor-actions-column">
                        <div class="vendor-checkbox-container">
                            <div class="vendor-checkbox ${isSelected ? 'checked' : ''}" 
                                 onclick="event.stopPropagation(); toggleVendorSelectionForCurrentService('${vendorId}');"
                                 title="${isSelected ? 'Deselect vendor' : 'Select vendor'}">
                                ${isSelected ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                        </div>
                        <div class="vendor-eye-icon" 
                             onclick="event.stopPropagation(); const baseUrl = window.location.origin; const profileUrl = baseUrl + '/listings/' + '${vendorId}'; window.open(profileUrl, '_blank');"
                             title="View vendor profile">
                            <i class="fas fa-eye"></i>
                        </div>
                    </div>`}
                </div>
            `;
        }

        // Setup vendor sorting functionality
        function setupVendorSorting(vendors) {
            const sortSelect = document.getElementById('vendor-sort');
            if (!sortSelect) return;

            sortSelect.addEventListener('change', (e) => {
                const sortBy = e.target.value;
                let sortedVendors = [...vendors];

                switch (sortBy) {
                    case 'distance':
                        // Treat 0 as valid distance. Use backend distanceFromEvent as fallback.
                        const aDist = (v) => {
                            if (typeof v.distance === 'number' && isFinite(v.distance)) return v.distance;
                            const dfe = parseFloat(v.distanceFromEvent);
                            return isNaN(dfe) ? 999 : dfe;
                        };
                        sortedVendors.sort((a, b) => (aDist(a) - aDist(b)));
                        break;
                    case 'price':
                        sortedVendors.sort((a, b) => {
                            const priceA = getPriceValue(a.priceRange || '$$$');
                            const priceB = getPriceValue(b.priceRange || '$$$');
                            return priceA - priceB;
                        });
                        break;
                    case 'rating':
                        sortedVendors.sort((a, b) => (b.averageRating || 4.5) - (a.averageRating || 4.5));
                        break;
                }

                // Re-render cards
                const cardsContainer = document.getElementById('vendor-horizontal-cards');
                cardsContainer.innerHTML = sortedVendors.map(vendor => createHorizontalVendorCard(vendor)).join('');
                
                // Reinitialize carousel functionality for new cards
                setTimeout(() => {
                    sortedVendors.forEach(vendor => {
                        const vendorId = vendor.VendorProfileID || vendor.vendorProfileId || vendor.id;
                        if (vendorId) initializeVendorCarousel(vendorId);
                    });
                }, 100);
            });
        }

        // Image carousel functionality
        const carouselStates = {};

        function initializeVendorCarousel(vendorId) {
            const carousel = document.getElementById(`carousel-${vendorId}`);
            if (!carousel) return;

            const images = carousel.querySelectorAll('.vendor-card-image');
            if (images.length <= 1) return; // No need for carousel with single image

            // Initialize state
            carouselStates[vendorId] = {
                currentIndex: 0,
                totalImages: images.length
            };

            console.log(`🎠 Initialized carousel for vendor ${vendorId} with ${images.length} images`);
        }

        function navigateCarousel(vendorId, direction) {
            const state = carouselStates[vendorId];
            if (!state) return;

            const carousel = document.getElementById(`carousel-${vendorId}`);
            if (!carousel) return;

            // Update current index
            state.currentIndex += direction;
            
            // Handle wrapping
            if (state.currentIndex >= state.totalImages) {
                state.currentIndex = 0;
            } else if (state.currentIndex < 0) {
                state.currentIndex = state.totalImages - 1;
            }

            // Apply transform using actual image width (fallback to 260)
            const img = carousel.querySelector('.vendor-card-image');
            const imgWidth = (img && img.clientWidth) ? img.clientWidth : 260;
            const translateX = -state.currentIndex * imgWidth;
            carousel.style.transform = `translateX(${translateX}px)`;

            // Update dots
            updateCarouselDots(vendorId);
        }

        function goToCarouselSlide(vendorId, index) {
            const state = carouselStates[vendorId];
            if (!state || index < 0 || index >= state.totalImages) return;

            const carousel = document.getElementById(`carousel-${vendorId}`);
            if (!carousel) return;

            // Update current index
            state.currentIndex = index;

            // Apply transform using actual image width (fallback to 260)
            const img = carousel.querySelector('.vendor-card-image');
            const imgWidth = (img && img.clientWidth) ? img.clientWidth : 260;
            const translateX = -state.currentIndex * imgWidth;
            carousel.style.transform = `translateX(${translateX}px)`;

            // Update dots
            updateCarouselDots(vendorId);
        }

        function updateCarouselDots(vendorId) {
            const state = carouselStates[vendorId];
            if (!state) return;

            const card = document.querySelector(`[data-vendor-id="${vendorId}"]`);
            if (!card) return;

            const dots = card.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                if (index === state.currentIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Initialize carousels when cards are rendered
        document.addEventListener('DOMContentLoaded', () => {
            // Use MutationObserver to detect when vendor cards are added
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Check if vendor cards were added
                        const hasVendorCards = Array.from(mutation.addedNodes).some(node => 
                            node.nodeType === Node.ELEMENT_NODE && 
                            (node.classList?.contains('vendor-horizontal-card') || 
                             node.querySelector?.('.vendor-horizontal-card'))
                        );
                        
                        if (hasVendorCards) {
                            setTimeout(() => {
                                // Initialize carousels for all vendor cards
                                const vendorCards = document.querySelectorAll('.vendor-horizontal-card');
                                vendorCards.forEach(card => {
                                    const vendorId = card.getAttribute('data-vendor-id');
                                    if (vendorId) {
                                        initializeVendorCarousel(vendorId);
                                    }
                                });
                            }, 100);
                        }
                    }
                });
            });

            const cardsContainer = document.getElementById('vendor-horizontal-cards');
            if (cardsContainer) {
                observer.observe(cardsContainer, { 
                    childList: true, 
                    subtree: true 
                });
            }
        });

        // Helper function to get numeric price value
        function getPriceValue(priceRange) {
            const priceMap = { '$': 1, '$$': 2, '$$$': 3, '$$$$': 4 };
            return priceMap[priceRange] || 3;
        }

        // Toggle vendor selection for specific service
        function toggleVendorSelection(vendorProfileId, serviceId = null) {
            console.log('🔘 ===== CORRECT toggleVendorSelection called =====');
            console.log('🔘 toggleVendorSelection called with:', vendorProfileId, 'for service:', serviceId);
            
            // Get current active service if not provided
            if (!serviceId && window.currentServiceGroups) {
                const activeTab = document.querySelector('.service-tab.active');
                serviceId = activeTab ? activeTab.getAttribute('data-service-id') : null;
            }
            
            // Use existing bookingState or initialize selectedVendorsByService object
            if (!window.bookingState) {
                window.bookingState = {};
            }
            if (!window.bookingState.selectedVendorsByService) {
                window.bookingState.selectedVendorsByService = {};
            }
            if (!window.bookingState.selectedVendors) {
                window.bookingState.selectedVendors = [];
            }
            
            const selectedVendorsByService = window.bookingState.selectedVendorsByService;
            
            // Initialize service array if it doesn't exist
            if (!selectedVendorsByService[serviceId]) {
                selectedVendorsByService[serviceId] = [];
            }
            
            const serviceSelections = selectedVendorsByService[serviceId];
            const existingIndex = serviceSelections.findIndex(v => v.vendorId === vendorProfileId);
            
            console.log('🔘 Current selections for service:', serviceId, serviceSelections);
            console.log('🔘 Looking for vendor:', vendorProfileId, 'existing index:', existingIndex);
            
            if (existingIndex > -1) {
                // Remove vendor from this service selection
                serviceSelections.splice(existingIndex, 1);
                console.log(`🔘 ✅ Vendor ${vendorProfileId} REMOVED from ${serviceId} selection`);
                console.log('🔘 Updated selections:', serviceSelections);
            } else {
                // Add vendor to this service selection
                const vendor = (window.bookingState?.availableVendors || []).find(v => {
                    const vId = v.VendorProfileID || v.vendorProfileId || v.id;
                    return String(vId) === String(vendorProfileId);
                }) || {};

                // Get service details from current service groups
                let serviceDetails = null;
                if (window.currentServiceGroups && window.currentServiceGroups[serviceId]) {
                    serviceDetails = window.currentServiceGroups[serviceId].service;
                }

                // Find the specific service from vendor's services
                let selService = null;
                if (Array.isArray(vendor.services) && vendor.services.length > 0) {
                    selService = vendor.services.find(s => 
                        (s.ServiceName || s.name) === (serviceDetails?.name || serviceId)
                    ) || vendor.services[0];
                } else if (vendor.serviceName) {
                    selService = {
                        ServiceName: vendor.serviceName,
                        VendorPrice: vendor.servicePrice || vendor.totalEstimatedCost || 0
                    };
                }

                const serviceName = serviceDetails?.name || selService?.ServiceName || selService?.name || serviceId;
                const servicePrice = selService?.VendorPrice ?? selService?.Price ?? vendor.totalEstimatedCost ?? 0;

                serviceSelections.push({
                    vendorId: vendorProfileId,
                    id: vendorProfileId,
                    serviceId: serviceId,
                    serviceName: serviceName,
                    servicePrice: servicePrice,
                    selectedService: selService || undefined,
                    vendorData: vendor
                });
                console.log(`🔘 ✅ Vendor ${vendorProfileId} ADDED to ${serviceId} selection`);
                console.log('🔘 Updated selections:', serviceSelections);
            }
            
            // Update the legacy selectedVendors array for compatibility
            updateLegacySelectedVendors();
            
            console.log('🔘 Current selections by service:', selectedVendorsByService);

            // Update UI and markers
            updateVendorSelectionUI();
            updateMarkerColors();
            
            // Update send requests button and count display
            updateSendRequestsButton();
        }

        // Update legacy selectedVendors array from service-specific selections
        function updateLegacySelectedVendors() {
            if (!window.bookingState.selectedVendorsByService) return;
            
            const legacyArray = [];
            const vendorServiceMap = {}; // Track which services each vendor is selected for
            
            Object.entries(window.bookingState.selectedVendorsByService).forEach(([serviceId, vendors]) => {
                vendors.forEach(vendorSelection => {
                    const vendorId = vendorSelection.vendorId;
                    
                    if (!vendorServiceMap[vendorId]) {
                        vendorServiceMap[vendorId] = {
                            vendorData: vendorSelection.vendorData,
                            services: []
                        };
                    }
                    
                    vendorServiceMap[vendorId].services.push({
                        serviceId: serviceId,
                        serviceName: vendorSelection.serviceName,
                        servicePrice: vendorSelection.servicePrice,
                        selectedService: vendorSelection.selectedService
                    });
                });
            });
            
            // Convert to legacy format
            Object.entries(vendorServiceMap).forEach(([vendorId, data]) => {
                legacyArray.push({
                    vendorId: vendorId,
                    id: vendorId,
                    serviceName: data.services.map(s => s.serviceName).join(', '),
                    servicePrice: data.services.reduce((sum, s) => sum + (s.servicePrice || 0), 0),
                    selectedServices: data.services, // New field for multiple services
                    vendorData: data.vendorData
                });
            });
            
            window.bookingState.selectedVendors = legacyArray;
        }
        
        // Function to update marker colors based on selection state
        function updateMarkerColors() {
            if (!vendorMarkers || vendorMarkers.length === 0) return;
            
            const selectedVendorIds = window.bookingState?.selectedVendors?.map(v => v.vendorId) || [];
            
            vendorMarkers.forEach(marker => {
                const vendorId = marker.vendorData?.VendorProfileID || marker.vendorData?.vendorProfileId || marker.vendorData?.id;
                const isSelected = selectedVendorIds.includes(vendorId);
                
                // Get the original category icon
                const categoryIcon = getCategoryIcon(marker.vendorData?.serviceCategory || marker.vendorData?.category);
                
                // Update marker icon based on selection state
                marker.setIcon({
                    path: categoryIcon.path,
                    scale: categoryIcon.scale,
                    fillColor: isSelected ? '#10b981' : categoryIcon.fillColor, // Green if selected, original color if not
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: isSelected ? 3 : 2 // Thicker stroke if selected
                });
            });
        }

        // Select vendor from map info window
        window.selectVendorFromMap = function(vendorProfileId) {
            toggleVendorSelection(vendorProfileId);
        };

        // Update vendor selection UI
        function updateVendorSelectionUI(vendorProfileId) {
            console.log('🎨 Updating vendor selection UI for:', vendorProfileId);
            
            // Get current active service - use the same logic as toggleVendorSelectionForCurrentService
            let currentServiceId = window.currentActiveServiceId;
            if (!currentServiceId) {
                const activeTab = document.querySelector('.service-tab.active');
                currentServiceId = activeTab ? activeTab.getAttribute('data-service-id') : null;
            }
            
            console.log('🎨 Current active service:', currentServiceId);
            console.log('🎨 Current booking state:', window.bookingState?.selectedVendorsByService);
            
            // Update all vendor cards to reflect current selection state for current service
            const allCards = document.querySelectorAll('.vendor-horizontal-card');
            allCards.forEach(card => {
                const cardVendorId = card.getAttribute('data-vendor-id');
                
                // Check if this vendor is selected for the current service
                let isSelectedForCurrentService = false;
                if (currentServiceId && window.bookingState?.selectedVendorsByService?.[currentServiceId]) {
                    isSelectedForCurrentService = window.bookingState.selectedVendorsByService[currentServiceId].some(v => {
                        const vId = v.vendorId || v.VendorProfileID || v.vendorProfileId || v.id;
                        return String(vId) === String(cardVendorId);
                    });
                }
                
                console.log(`🎨 Card ${cardVendorId}: selected for current service = ${isSelectedForCurrentService}`);
                
                // Update card visual state - show as selected if selected for current service
                if (isSelectedForCurrentService) {
                    card.classList.add('selected');
                } else {
                    // Not selected for current service
                    card.classList.remove('selected');
                }
                
                // Update checkbox state based on current service selection
                const checkbox = card.querySelector('.vendor-checkbox');
                if (checkbox) {
                    if (isSelectedForCurrentService) {
                        checkbox.classList.add('checked');
                        checkbox.innerHTML = '<i class="fas fa-check"></i>';
                        checkbox.title = 'Deselect vendor from this service';
                    } else {
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                        checkbox.title = 'Select vendor for this service';
                    }
                    console.log(`🎨 Updated checkbox for ${cardVendorId}: checked=${isSelectedForCurrentService}`);
                }
            });
            
            // Also update any other vendor cards that might exist
            document.querySelectorAll('[data-vendor-id]').forEach(element => {
                const elementVendorId = element.getAttribute('data-vendor-id');
                const checkbox = element.querySelector('.vendor-checkbox');
                
                if (checkbox && elementVendorId) {
                    let isSelected = false;
                    if (currentServiceId && window.bookingState?.selectedVendorsByService?.[currentServiceId]) {
                        isSelected = window.bookingState.selectedVendorsByService[currentServiceId].some(v => {
                            const vId = v.vendorId || v.VendorProfileID || v.vendorProfileId || v.id;
                            return String(vId) === String(elementVendorId);
                        });
                    }
                    
                    if (isSelected) {
                        checkbox.classList.add('checked');
                        checkbox.innerHTML = '<i class="fas fa-check"></i>';
                    } else {
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                    }
                }
            });
        }

        // Update map markers based on selection
        function updateMapMarkers() {
            vendorMarkers.forEach(marker => {
                const isSelected = bookingState.selectedVendors?.some(v => 
                    v.vendorProfileId === marker.vendorData.vendorProfileId
                );
                
                // Update marker appearance based on selection
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: isSelected ? 12 : 10,
                    fillColor: isSelected ? '#27ae60' : '#3498db',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: isSelected ? 3 : 2
                });
            });
        }

        // AC2 & AC4: Add debounced map movement listeners for booking process
        function addBookingMapMovementListeners() {
            if (!vendorMap) return;

            // AC4: Debounced function for map movement (300ms)
            const debouncedBookingMapMove = debounce(() => {
                if (window.bookingState.isLoadingVendors) return;
                
                const currentBounds = vendorMap.getBounds();
                if (!currentBounds) return;

                // Check if bounds have significantly changed
                if (window.bookingState.lastMapBounds && boundsEqual(currentBounds, window.bookingState.lastMapBounds)) {
                    return;
                }

                window.bookingState.lastMapBounds = currentBounds;
                loadVendorsInBookingMapBounds(currentBounds);
            }, 300);

            // Add listeners for map movement
            vendorMap.addListener('bounds_changed', debouncedBookingMapMove);
            vendorMap.addListener('zoom_changed', debouncedBookingMapMove);
        }

        // AC3: Add loading indicator to booking map
        function addBookingMapLoadingIndicator() {
            const mapContainer = document.getElementById('vendor-map');
            if (!mapContainer) return;

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'booking-map-loading-indicator';
            loadingDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: none;
                z-index: 1000;
                align-items: center;
                gap: 12px;
            `;
            loadingDiv.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: #333; font-weight: 500;">Loading vendors...</span>
            `;

            mapContainer.style.position = 'relative';
            mapContainer.appendChild(loadingDiv);
        }

        // AC6: Add reset search button for booking map
        function addBookingResetSearchButton() {
            const mapContainer = document.getElementById('vendor-map');
            if (!mapContainer) return;

            const resetButton = document.createElement('button');
            resetButton.id = 'booking-reset-search-btn';
            resetButton.innerHTML = `
                <i class="fas fa-undo"></i>
                <span>Reset View</span>
            `;
            resetButton.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 8px 12px;
                cursor: pointer;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 14px;
                color: #333;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                transition: all 0.2s ease;
            `;

            resetButton.addEventListener('mouseenter', () => {
                resetButton.style.backgroundColor = '#f8f9fa';
                resetButton.style.transform = 'translateY(-1px)';
            });

            resetButton.addEventListener('mouseleave', () => {
                resetButton.style.backgroundColor = 'white';
                resetButton.style.transform = 'translateY(0)';
            });

            resetButton.addEventListener('click', resetBookingToOriginalSearch);
            mapContainer.appendChild(resetButton);
        }

        // AC2: Load vendors within booking map bounds - Enhanced for dynamic discovery
        async function loadVendorsInBookingMapBounds(bounds) {
            if (window.bookingState.isLoadingVendors) return;

            window.bookingState.isLoadingVendors = true;
            showBookingMapLoadingIndicator();
            showBookingSidebarSkeletonLoader();

            try {
                // Get bounds coordinates
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();

                // First, filter vendors within bounds from existing data
                const vendorsInBounds = [];
                
                if (bookingState.originalVendorSections) {
                    window.bookingState.originalVendorSections.forEach(section => {
                        const filteredVendors = section.vendors.filter(vendor => {
                            if (!vendor.coordinates) return false;
                            const lat = vendor.coordinates.lat;
                            const lng = vendor.coordinates.lng;
                            return lat >= sw.lat() && lat <= ne.lat() && 
                                   lng >= sw.lng() && lng <= ne.lng();
                        });
                        
                        if (filteredVendors.length > 0) {
                            vendorsInBounds.push({
                                ...section,
                                vendors: filteredVendors
                            });
                        }
                    });
                }

                // If no vendors in current bounds, search for new vendors in this area
                if (vendorsInBounds.length === 0) {
                    console.log('🔍 No existing vendors in bounds, searching for new vendors...');
                    
                    // Calculate center point for search
                    const centerLat = (ne.lat() + sw.lat()) / 2;
                    const centerLng = (ne.lng() + sw.lng()) / 2;
                    
                    // Search for vendors in this geographic area
                    const newVendorSections = await searchVendorsInArea(centerLat, centerLng, bounds);
                    
                    if (newVendorSections.length > 0) {
                        // Add newly found vendors to our original sections
                        newVendorSections.forEach(newSection => {
                            const existingSection = window.bookingState.originalVendorSections.find(
                                section => section.category === newSection.category && 
                                          section.service.name === newSection.service.name
                            );
                            
                            if (existingSection) {
                                // Merge vendors, avoiding duplicates
                                newSection.vendors.forEach(newVendor => {
                                    if (!existingSection.vendors.find(v => v.id === newVendor.id)) {
                                        existingSection.vendors.push(newVendor);
                                    }
                                });
                            } else {
                                // Add new section
                                window.bookingState.originalVendorSections.push(newSection);
                            }
                        });
                        
                        // Update vendors in bounds with newly discovered ones
                        vendorsInBounds.push(...newVendorSections);
                        console.log(`✅ Found ${newVendorSections.reduce((sum, s) => sum + s.vendors.length, 0)} new vendors in area`);
                    }
                }

                console.log(`Found ${vendorsInBounds.reduce((sum, section) => sum + section.vendors.length, 0)} vendors in current map area`);

                // Update sidebar list with contextual results
                currentVendorSections = vendorsInBounds;
                renderHorizontalVendorCards(vendorsInBounds);

                // Update vendor markers on map
                vendorMarkers.forEach(marker => marker.setMap(null));
                vendorMarkers = [];
                await addVendorMarkers(vendorsInBounds, {
                    lat: window.selectedEventLocation?.lat || 43.6532,
                    lng: window.selectedEventLocation?.lng || -79.3832
                });

                // Update results count display
                const totalVendors = vendorsInBounds.reduce((sum, section) => sum + section.vendors.length, 0);
                console.log(`Updated sidebar with ${totalVendors} vendors in current map area`);

            } catch (error) {
                console.error('Error loading vendors in booking map bounds:', error);
            } finally {
                window.bookingState.isLoadingVendors = false;
                hideBookingMapLoadingIndicator();
                hideBookingSidebarSkeletonLoader();
            }
        }

        // Function to search for vendors in a specific geographic area
        async function searchVendorsInArea(centerLat, centerLng, bounds) {
            try {
                console.log(`🔍 Searching for vendors in area: ${centerLat}, ${centerLng}`);
                
                // Get the selected services from booking state
                const selectedServices = window.bookingState?.selectedPredefinedServices || [];
                if (selectedServices.length === 0) {
                    console.log('No services selected for vendor search');
                    return [];
                }

                // Prepare the search request (include per-service times for business-hours filtering)
                const eventDateVal = (window.bookingState?.eventDetails?.date
                    || window.bookingState?.eventDetails?.EventDate
                    || document.getElementById('event-date')?.value
                    || null);

                const searchRequest = {
                    selectedServices: selectedServices.map(service => ({
                        category: service.category,
                        name: service.name,
                        budget: service.budget,
                        serviceId: service.serviceId || service.id, // Include serviceId for backend processing
                        // Ensure backend receives time windows per service
                        startTime: service.startTime || service.serviceStartTime || null,
                        endTime: service.endTime || service.serviceEndTime || null,
                        duration: service.duration || null
                    })),
                    location: {
                        lat: centerLat,
                        lng: centerLng,
                        radius: 25 // 25km radius from center point
                    },
                    // Ensure EventDate is present for SP filtering; include both keys for compatibility
                    eventDetails: {
                        ...(window.bookingState?.eventDetails || {}),
                        date: eventDateVal,
                        EventDate: eventDateVal
                    }
                };

                console.log('🌐 Sending vendor search request:', searchRequest);

                // Make API call to search for vendors
                const response = await fetch(`${API_BASE_URL}/vendors/search-by-services`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...searchRequest,
                        // Unified pricing filters
                        budgetType: 'total',
                        pricingModel: null,
                        fixedPricingType: null
                    })
                });

                if (!response.ok) {
                    throw new Error(`Vendor search failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('📦 Vendor search response:', data);

                const vendorSections = [];

                // Process each service category
                for (const [category, services] of Object.entries(data)) {
                    if (category === 'message') continue; // Skip message field
                    
                    for (const [serviceName, vendors] of Object.entries(services)) {
                        if (!Array.isArray(vendors) || vendors.length === 0) continue;

                        // Find the corresponding service from our selected services
                        const service = selectedServices.find(s => 
                            s.category === category && s.name === serviceName
                        );
                        
                        if (!service) continue;

                        // Process vendors and add coordinates
                        const vendorsWithCoords = vendors.map(vendor => {
                            // Extract coordinates with fallback
                            let coordinates = null;
                            if (vendor.latitude && vendor.longitude) {
                                coordinates = {
                                    lat: parseFloat(vendor.latitude),
                                    lng: parseFloat(vendor.longitude)
                                };
                            } else if (vendor.lat && vendor.lng) {
                                coordinates = {
                                    lat: parseFloat(vendor.lat),
                                    lng: parseFloat(vendor.lng)
                                };
                            } else {
                                // Use search center as fallback
                                coordinates = {
                                    lat: centerLat,
                                    lng: centerLng
                                };
                            }

                            return {
                                ...vendor,
                                coordinates: coordinates
                            };
                        }).filter(vendor => {
                            // Only include vendors within the map bounds
                            if (!vendor.coordinates) return false;
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            const lat = vendor.coordinates.lat;
                            const lng = vendor.coordinates.lng;
                            return lat >= sw.lat() && lat <= ne.lat() && 
                                   lng >= sw.lng() && lng <= ne.lng();
                        });

                        if (vendorsWithCoords.length > 0) {
                            vendorSections.push({
                                category: category,
                                service: service,
                                vendors: vendorsWithCoords
                            });
                            console.log(`✅ Found ${vendorsWithCoords.length} vendors for ${category} - ${serviceName} in area`);
                        }
                    }
                }

                return vendorSections;

            } catch (error) {
                console.error('❌ Error searching vendors in area:', error);
                return [];
            }
        }

        // AC6: Reset booking map to original search results
        function resetBookingToOriginalSearch() {
            if (!bookingState.initialMapBounds || !bookingState.originalVendorSections) return;

            // Restore original vendor sections
            currentVendorSections = [...bookingState.originalVendorSections];
            
            // Reset map bounds
            vendorMap.fitBounds(bookingState.initialMapBounds);
            
            // Update UI
            renderHorizontalVendorCards(currentVendorSections);
            
            // Clear and re-add all vendor markers
            vendorMarkers.forEach(marker => marker.setMap(null));
            vendorMarkers = [];
            addVendorMarkers(currentVendorSections, {
                lat: window.selectedEventLocation?.lat || 43.6532,
                lng: window.selectedEventLocation?.lng || -79.3832
            });
        }

        // Utility functions for booking map
        function showBookingMapLoadingIndicator() {
            const indicator = document.getElementById('booking-map-loading-indicator');
            if (indicator) {
                indicator.style.display = 'flex';
            }
        }

        function hideBookingMapLoadingIndicator() {
            const indicator = document.getElementById('booking-map-loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function showBookingSidebarSkeletonLoader() {
            const vendorCardsContainer = document.getElementById('vendor-cards-container');
            if (!vendorCardsContainer) return;

            // Store original content
            if (!vendorCardsContainer.dataset.originalContent) {
                vendorCardsContainer.dataset.originalContent = vendorCardsContainer.innerHTML;
            }

            // Create skeleton cards
            const skeletonHTML = Array(4).fill(0).map(() => `
                <div class="vendor-horizontal-card" style="
                    background: #f8f9fa;
                    border-radius: 12px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                    animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
                    display: flex;
                    gap: 1rem;
                ">
                    <div style="
                        width: 120px;
                        height: 80px;
                        background: #dee2e6;
                        border-radius: 8px;
                        flex-shrink: 0;
                    "></div>
                    <div style="flex: 1;">
                        <div style="
                            width: 60%;
                            height: 20px;
                            background: #dee2e6;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                        "></div>
                        <div style="
                            width: 40%;
                            height: 16px;
                            background: #dee2e6;
                            border-radius: 4px;
                            margin-bottom: 0.5rem;
                        "></div>
                        <div style="
                            width: 30%;
                            height: 16px;
                            background: #dee2e6;
                            border-radius: 4px;
                        "></div>
                    </div>
                </div>
            `).join('');

            vendorCardsContainer.innerHTML = skeletonHTML;
        }

        function hideBookingSidebarSkeletonLoader() {
            const vendorCardsContainer = document.getElementById('vendor-cards-container');
            if (!vendorCardsContainer || !vendorCardsContainer.dataset.originalContent) return;

            // Don't restore original content, let the normal render function handle it
            // The renderHorizontalVendorCards() function will be called after this
        }

        // TEST FUNCTION: Force display sample vendor cards for debugging
        function testVendorCardsDisplay() {
            console.log('🧪 Testing vendor cards display with sample data...');
            
            const sampleVendorSections = [{
                category: "Photography",
                service: { name: "Wedding Photography", budget: 2000 },
                vendors: [{
                    VendorProfileID: "test-1",
                    BusinessName: "Test Photography Studio",
                    BusinessDescription: "Professional wedding photography services",
                    Location: "Toronto, ON",
                    Latitude: 43.6532,
                    Longitude: -79.3832,
                    averageRating: 4.8,
                    totalReviews: 25,
                    services: [{
                        ServiceName: "Wedding Photography",
                        VendorPrice: 1800,
                        VendorDurationMinutes: 480
                    }]
                }]
            }];
            
            console.log('🧪 Sample data created:', sampleVendorSections);
            
            // Force render with sample data
            renderHorizontalVendorCards(sampleVendorSections);
        }
        
        // Add test function to window for console access
        window.testVendorCardsDisplay = testVendorCardsDisplay;
        
        // Force show vendor cards container for debugging
        function forceShowVendorCards() {
            console.log('🔧 Force showing vendor cards container...');
            const container = document.getElementById('vendor-cards-container');
            const cardsContainer = document.getElementById('vendor-horizontal-cards');
            
            if (container) {
                container.style.display = 'block';
                console.log('✅ Container display set to block');
            } else {
                console.error('❌ vendor-cards-container not found');
            }
            
            if (cardsContainer) {
                cardsContainer.innerHTML = `
                    <div style="padding: 1rem; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #1976d2; margin: 0 0 0.5rem 0;">🔧 Debug Message</h4>
                        <p style="color: #1976d2; margin: 0;">Vendor cards container is now visible. If you can see this message, the DOM elements are working correctly.</p>
                    </div>
                `;
                console.log('✅ Debug message added to cards container');
            } else {
                console.error('❌ vendor-horizontal-cards not found');
            }
        }
        
        window.forceShowVendorCards = forceShowVendorCards;

        // Highlight vendor card when marker is clicked
        function highlightVendorCard(vendorProfileId) {
            // Remove previous highlights
            document.querySelectorAll('.vendor-horizontal-card').forEach(card => {
                card.style.boxShadow = '';
            });

            // Highlight the corresponding card
            const card = document.querySelector(`[data-vendor-id="${vendorProfileId}"]`);
            if (card) {
                card.style.boxShadow = '0 0 0 3px var(--primary)';
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    card.style.boxShadow = '';
                }, 3000);
            }
        }

        // Update send requests button
        function updateSendRequestsButton() {
            const button = document.getElementById('send-requests-btn');
            if (button) {
                const hasSelections = bookingState.selectedVendors && bookingState.selectedVendors.length > 0;
                button.disabled = !hasSelections;
                
                // Update the selected vendor count display
                const countDisplay = document.getElementById('selected-vendor-count');
                if (countDisplay) {
                    const count = bookingState.selectedVendors ? bookingState.selectedVendors.length : 0;
                    countDisplay.textContent = count === 1 ? '1 vendor selected' : `${count} vendors selected`;
                    countDisplay.style.color = '#6b7280';
                    countDisplay.style.fontWeight = 'normal';
                }
                
                // Update button styling based on selection state
                if (hasSelections) {
                    button.style.backgroundColor = '#5e72e4';
                    button.style.borderColor = '#5e72e4';
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                } else {
                    button.style.backgroundColor = '#a5b4fc';
                    button.style.borderColor = '#a5b4fc';
                    button.style.opacity = '0.7';
                    button.style.cursor = 'not-allowed';
                }
            }
        }

        // --- Simple Image Carousel Controller ---
        const currentCarouselIndex = {};

        function updateCarousel(vendorId) {
            const track = document.getElementById(`carousel-${vendorId}`);
            if (!track) return;
            const slides = track.querySelectorAll('.vendor-card-image');
            const max = Math.max(0, slides.length - 1);
            let idx = currentCarouselIndex[vendorId] ?? 0;
            if (idx < 0) idx = 0;
            if (idx > max) idx = max;
            currentCarouselIndex[vendorId] = idx;
            track.style.transform = `translateX(-${idx * 100}%)`;
            const dots = track.parentElement?.querySelectorAll?.('.carousel-dot') || [];
            dots.forEach((dot, i) => dot.classList.toggle('active', i === idx));
        }

        function navigateCarousel(vendorId, direction) {
            currentCarouselIndex[vendorId] = (currentCarouselIndex[vendorId] ?? 0) + direction;
            updateCarousel(vendorId);
        }

        function goToCarouselSlide(vendorId, index) {
            currentCarouselIndex[vendorId] = index;
            updateCarousel(vendorId);
        }

        // Initialize any rendered carousels after cards are injected
        setTimeout(() => {
            document.querySelectorAll('[id^="carousel-"]').forEach(el => {
                const id = el.id.replace('carousel-', '');
                currentCarouselIndex[id] = 0;
                updateCarousel(id);
            });
        }, 0);

        // Create wrapper function for checkbox/card clicks that determines current service
        function toggleVendorSelectionForCurrentService(vendorId) {
            console.log('🔘 ===== CHECKBOX CLICKED =====');
            console.log('🔘 toggleVendorSelectionForCurrentService called with vendorId:', vendorId);
            
            // Method 1: Check global tracking variable first
            let currentServiceId = window.currentActiveServiceId;
            console.log('🔘 Method 1 - Global variable:', currentServiceId);
            
            // Method 2: Try to find active service tab
            if (!currentServiceId) {
                const activeTab = document.querySelector('.service-tab.active');
                if (activeTab) {
                    currentServiceId = activeTab.getAttribute('data-service-id');
                    console.log('🔘 Method 2 - Active tab:', currentServiceId);
                }
            }
            
            // Method 2.5: If there is only a single service in currentServiceGroups, use it
            if (!currentServiceId && window.currentServiceGroups && typeof window.currentServiceGroups === 'object') {
                const keys = Object.keys(window.currentServiceGroups);
                if (keys.length === 1) {
                    currentServiceId = keys[0];
                    console.log('🔘 Method 2.5 - Single service inferred from currentServiceGroups:', currentServiceId);
                }
            }

            // Method 3: Check all tabs and find the one with active class (with retry)
            if (!currentServiceId) {
                setTimeout(() => {
                    const retryActiveTab = document.querySelector('.service-tab.active');
                    if (retryActiveTab) {
                        currentServiceId = retryActiveTab.getAttribute('data-service-id');
                        console.log('🔘 Method 3 - Retry active tab:', currentServiceId);
                        
                        if (currentServiceId) {
                            toggleVendorSelection(vendorId, currentServiceId);
                            updateVendorSelectionUI(vendorId);
                        }
                    } else if (window.currentServiceGroups && Object.keys(window.currentServiceGroups || {}).length === 1) {
                        // Retry fallback for single-service scenario with hidden tabs
                        const onlyId = Object.keys(window.currentServiceGroups)[0];
                        console.log('🔘 Method 3 - Retry single service fallback:', onlyId);
                        toggleVendorSelection(vendorId, onlyId);
                        updateVendorSelectionUI(vendorId);
                    } else {
                        console.warn('⚠️ Still no active service tab found after retry');
                    }
                }, 50);
                return;
            }
            
            console.log('🔘 Current active service:', currentServiceId);
            
            if (!currentServiceId) {
                console.warn('⚠️ No active service tab found');
                return;
            }
            
            // Call the main toggle function with the current service
            console.log('🔘 About to call toggleVendorSelection...');
            toggleVendorSelection(vendorId, currentServiceId);
            console.log('🔘 toggleVendorSelection completed, now updating UI...');
            
            // Force immediate UI update - this handles both card and checkbox updates
            updateVendorSelectionUI(vendorId);
            console.log('🔘 updateVendorSelectionUI completed');
        }
        
        // Helper function to update checkbox visual state
        function updateVendorCheckboxState(vendorId, serviceId) {
            console.log('🔄 Updating checkbox state for vendor:', vendorId, 'service:', serviceId);
            
            const vendorCheckboxes = document.querySelectorAll(`[data-vendor-id="${vendorId}"] .vendor-checkbox`);
            console.log('🔄 Found checkboxes:', vendorCheckboxes.length);
            
            vendorCheckboxes.forEach((checkbox, index) => {
                // For specific service tabs, check if vendor is selected for that service
                const serviceVendors = window.bookingState.selectedVendorsByService?.[serviceId] || [];
                const shouldBeChecked = serviceVendors.some(v => {
                    const vId = v.vendorId || v.VendorProfileID || v.vendorProfileId || v.id;
                    return String(vId) === String(vendorId);
                });
                
                console.log(`🔄 Checkbox ${index}: shouldBeChecked = ${shouldBeChecked}`);
                
                // Force immediate visual update - use consistent checkmark approach
                if (shouldBeChecked) {
                    checkbox.classList.add('checked');
                    checkbox.innerHTML = '<i class="fas fa-check"></i>';
                    checkbox.title = 'Deselect vendor from this service';
                    // Remove any conflicting inline styles
                    checkbox.style.backgroundColor = '';
                    checkbox.style.color = '';
                } else {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                    checkbox.title = 'Select vendor for this service';
                    // Remove any conflicting inline styles
                    checkbox.style.backgroundColor = '';
                    checkbox.style.color = '';
                }
                
                // Also update the parent card if it exists
                const parentCard = checkbox.closest('.vendor-horizontal-card');
                if (parentCard) {
                    if (shouldBeChecked) {
                        parentCard.classList.add('selected');
                    } else {
                        parentCard.classList.remove('selected');
                    }
                }
            });
            
            // Force a repaint
            document.body.offsetHeight;
        }

        // Make the new toggleVendorSelection function globally available
        window.toggleVendorSelection = toggleVendorSelection;
        window.toggleVendorSelectionForCurrentService = toggleVendorSelectionForCurrentService;
        
        // Test if function is accessible
        console.log('🔧 toggleVendorSelection function:', typeof window.toggleVendorSelection);
        console.log('🔧 Function reference:', window.toggleVendorSelection);
        console.log('🔧 Testing function call...');
        
        // Test the function directly
        try {
            console.log('🔧 Testing direct call...');
            // Don't actually call it, just test if it exists
            if (typeof window.toggleVendorSelection === 'function') {
                console.log('🔧 Function exists and is callable');
            } else {
                console.log('🔧 Function does not exist or is not callable');
            }
        } catch (e) {
            console.log('🔧 Error testing function:', e);
        }
        
        // Add click event listeners to all vendor cards after they're created
        setTimeout(() => {
            const vendorCards = document.querySelectorAll('.vendor-horizontal-card');
            console.log('🔧 Found vendor cards:', vendorCards.length);
            
            vendorCards.forEach((card, index) => {
                console.log(`🔧 Card ${index}:`, card.dataset.vendorId);
                card.addEventListener('click', function() {
                    console.log('🔧 Card clicked via event listener!', this.dataset.vendorId);
                    window.toggleVendorSelection(this.dataset.vendorId);
                });
            });
        }, 1000);
        
        console.log('🎉 All Vendor Setup Improvements JavaScript Loaded Successfully!');
        
        // Test multi-service vendor selection system
        console.log('🧪 Testing multi-service vendor selection system...');
        
        // Test data structure initialization
        if (typeof window.selectAllServicesForVendor === 'function') {
            console.log('✅ selectAllServicesForVendor function available');
        } else {
            console.log('❌ selectAllServicesForVendor function missing');
        }
        
        // renderRecommendedVendors function has been removed
        
        // Test service-specific data structure
        if (!window.bookingState) window.bookingState = {};
        if (!window.bookingState.selectedVendorsByService) {
            window.bookingState.selectedVendorsByService = {};
            console.log('✅ Initialized selectedVendorsByService structure');
        }
        
        console.log('🎯 Multi-service vendor selection system ready!');

        // Messaging Widget Implementation
        class MessagingWidget {
            constructor() {
                this.isOpen = false;
                this.currentView = 'conversations'; // 'conversations' or 'chat'
                this.currentConversationId = null;
                this.currentChatUser = null;
                this.conversations = [];
                this.messages = [];
                this.unreadCount = 0;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadConversations();
                this.setupSocketListeners();
                
                // Sync with existing badge updates
                this.syncWithDashboardBadge();
            }

            bindEvents() {
                console.log('🔧 Setting up MessagingWidget event listeners...');
                const chatButton = document.getElementById('chat-button');
                const widgetClose = document.getElementById('widget-close');
                const backButton = document.getElementById('back-to-conversations');
                const sendButton = document.getElementById('widget-send-button');
                const chatInput = document.getElementById('widget-chat-input');
                const conversationSearch = document.getElementById('conversation-search');

                console.log('🔍 Elements found:');
                console.log('  - Chat button:', chatButton);
                console.log('  - Widget close:', widgetClose);
                console.log('  - Back button:', backButton);
                console.log('  - Send button:', sendButton);
                console.log('  - Chat input:', chatInput);
                console.log('  - Conversation search:', conversationSearch);

                chatButton?.addEventListener('click', () => this.toggleWidget());
                widgetClose?.addEventListener('click', () => this.closeWidget());
                backButton?.addEventListener('click', () => this.showConversationsView());
                
                if (sendButton) {
                    console.log('✅ Adding click listener to widget send button');
                    sendButton.addEventListener('click', (e) => {
                        console.log('🚀 Widget send button clicked!');
                        console.log('🔍 Event target:', e.target);
                        console.log('🔍 Widget state before send:', {
                            currentView: this.currentView,
                            currentConversationId: this.currentConversationId,
                            isOpen: this.isOpen,
                            messagesLength: this.messages?.length || 0
                        });
                        e.preventDefault();
                        this.sendMessage();
                    });
                } else {
                    console.log('❌ Widget send button not found!');
                    console.log('🔍 All buttons in widget:', document.querySelectorAll('#messaging-widget button'));
                }
                
                chatInput?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                conversationSearch?.addEventListener('input', (e) => {
                    this.filterConversations(e.target.value);
                });

                // Close widget when clicking outside
                document.addEventListener('click', (e) => {
                    const widget = document.getElementById('messaging-widget');
                    if (this.isOpen && widget && !widget.contains(e.target)) {
                        this.closeWidget();
                    }
                });
            }

            toggleWidget() {
                if (this.isOpen) {
                    this.closeWidget();
                } else {
                    this.openWidget();
                }
            }

            openWidget() {
                console.log('🚀 Opening messaging widget...');
                const container = document.getElementById('widget-container');
                console.log('🔍 Widget container found:', container);
                if (container) {
                    // Use flex so header/messages/input layout correctly
                    container.style.display = 'flex';
                    this.isOpen = true;
                    console.log('✅ Widget opened, loading conversations...');
                    this.loadConversations();
                } else {
                    console.log('❌ Widget container not found!');
                }
            }

            closeWidget() {
                const container = document.getElementById('widget-container');
                if (container) {
                    container.style.display = 'none';
                    this.isOpen = false;
                }
            }

            showConversationsView() {
                document.getElementById('conversations-view').style.display = 'flex';
                document.getElementById('chat-view').style.display = 'none';
                this.currentView = 'conversations';
                this.currentConversationId = null;
                this.currentChatUser = null;
            }

            showChatView(conversationId, user) {
                document.getElementById('conversations-view').style.display = 'none';
                // Use grid to fix header and input, only messages scroll
                document.getElementById('chat-view').style.display = 'grid';
                this.currentView = 'chat';
                this.currentConversationId = conversationId;
                this.currentChatUser = user;
                
                // Update chat header
                const avatar = document.getElementById('chat-user-avatar');
                const name = document.getElementById('chat-user-name');
                
                if (avatar && name) {
                    avatar.src = user.avatar || '';
                    avatar.alt = user.name || 'User';
                    name.textContent = user.name || 'Unknown User';
                    
                    // If no avatar, show initials
                    if (!user.avatar) {
                        avatar.style.display = 'none';
                        avatar.parentElement.innerHTML = `
                            <div class="conversation-avatar">
                                ${this.getInitials(user.name)}
                            </div>
                            <span class="chat-user-name">${user.name || 'Unknown User'}</span>
                        `;
                    }
                }
                
                this.loadMessages(conversationId);
            }

            async loadConversations() {
                console.log('🚀 Loading conversations...');
                const conversationsList = document.getElementById('conversations-list');
                console.log('🔍 Conversations list element:', conversationsList);
                if (!conversationsList) {
                    console.log('❌ Conversations list element not found!');
                    return;
                }

                conversationsList.innerHTML = '<div class="loading-state">Loading conversations...</div>';

                try {
                    // Try multiple ways to get current user
                    let currentUser = window.currentUser;
                    let userId = currentUser?.id;
                    console.log('🔍 Current user from window:', currentUser);
                    console.log('🔍 User ID:', userId);
                    
                    // If no currentUser, try to get from token
                    if (!userId) {
                        const token = localStorage.getItem('token');
                        if (token && token.split('.').length === 3) {
                            try {
                                const payload = JSON.parse(atob(token.split('.')[1]));
                                userId = payload.userId || payload.id;
                                console.log('Got userId from token:', userId);
                            } catch (e) {
                                console.error('Error parsing token:', e);
                            }
                        }
                    }
                    
                    // If still no userId, try to get from localStorage
                    if (!userId) {
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            try {
                                const parsedUser = JSON.parse(storedUser);
                                userId = parsedUser.id;
                                currentUser = parsedUser;
                                console.log('Got userId from localStorage:', userId);
                            } catch (e) {
                                console.error('Error parsing stored user:', e);
                            }
                        }
                    }
                    
                    if (!userId) {
                        conversationsList.innerHTML = '<div class="empty-state">Please log in to view messages</div>';
                        return;
                    }

                    console.log('🌐 Fetching conversations from:', `${API_BASE_URL}/messages/conversations/user/${userId}`);
                    const response = await fetch(`${API_BASE_URL}/messages/conversations/user/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('📡 API Response status:', response.status);
                    console.log('📡 API Response ok:', response.ok);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ API Error:', errorText);
                        throw new Error(`Failed to load conversations: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('📋 API Response data:', data);
                    this.conversations = data.conversations || [];
                    console.log('📋 Loaded conversations:', this.conversations.length);
                    
                    if (this.conversations.length === 0) {
                        console.log('📭 No conversations found');
                        conversationsList.innerHTML = '<div class="empty-state">No conversations yet</div>';
                        return;
                    }
                    

                    this.renderConversations();
                    this.updateBadge();

                } catch (error) {
                    console.error('Error loading conversations:', error);
                    conversationsList.innerHTML = '<div class="empty-state">Failed to load conversations</div>';
                }
            }

            renderConversations(filteredConversations = null) {
                const conversationsList = document.getElementById('conversations-list');
                if (!conversationsList) return;

                const conversations = filteredConversations || this.conversations;
                
                if (conversations.length === 0) {
                    conversationsList.innerHTML = '<div class="empty-state">No conversations found</div>';
                    return;
                }

                conversationsList.innerHTML = conversations.map((conversation, index) => {
                    // Use the actual API response structure
                    const userName = conversation.OtherPartyName || 'Unknown User';
                    const lastMessageContent = conversation.lastMessageContent || 'No messages yet';
                    const lastMessageTime = conversation.lastMessageCreatedAt;
                    const unreadCount = conversation.unreadCount || 0;
                    
                    // Create user object for data attribute
                    const userObj = {
                        name: userName,
                        id: conversation.id // Use conversation ID as user identifier for now
                    };
                    
                    return `
                        <div class="conversation-item" data-conversation-id="${conversation.id}" data-user='${JSON.stringify(userObj)}'>
                            <div class="conversation-avatar">
                                ${this.getInitials(userName)}
                            </div>
                            <div class="conversation-info">
                                <div class="conversation-name">${this.escapeHtml(userName)}</div>
                                <div class="conversation-preview">${this.escapeHtml(lastMessageContent)}</div>
                            </div>
                            <div class="conversation-meta">
                                <div class="conversation-time">${this.formatTime(lastMessageTime)}</div>
                                ${unreadCount > 0 ? `<div class="conversation-unread">${unreadCount}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Add click listeners to conversation items
                conversationsList.querySelectorAll('.conversation-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const conversationId = item.dataset.conversationId;
                        const userData = JSON.parse(item.dataset.user);
                        this.showChatView(conversationId, userData);
                    });
                });
            }

            async loadMessages(conversationId) {
                const messagesContainer = document.getElementById('chat-messages-container');
                if (!messagesContainer) return;

                messagesContainer.innerHTML = '<div class="loading-state">Loading messages...</div>';

                try {
                    // Try multiple ways to get current user
                    let currentUser = window.currentUser;
                    let userId = currentUser?.id;
                    
                    // If no currentUser, try to get from token
                    if (!userId) {
                        const token = localStorage.getItem('token');
                        if (token && token.split('.').length === 3) {
                            try {
                                const payload = JSON.parse(atob(token.split('.')[1]));
                                userId = payload.userId || payload.id;
                            } catch (e) {
                                console.error('Error parsing token:', e);
                            }
                        }
                    }
                    
                    // If still no userId, try to get from localStorage
                    if (!userId) {
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            try {
                                const parsedUser = JSON.parse(storedUser);
                                userId = parsedUser.id;
                                currentUser = parsedUser;
                            } catch (e) {
                                console.error('Error parsing stored user:', e);
                            }
                        }
                    }
                    
                    if (!userId) return;

                    const response = await fetch(`${API_BASE_URL}/messages/conversation/${conversationId}?userId=${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }

                    const data = await response.json();
                    this.messages = data.messages || [];
                    
                    this.renderMessages();
                    this.scrollToBottom();

                } catch (error) {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="empty-state">Failed to load messages</div>';
                }
            }

            renderMessages() {
                const messagesContainer = document.getElementById('chat-messages-container');
                if (!messagesContainer) return;

                // Try multiple ways to get current user
                let currentUser = window.currentUser;
                let userId = currentUser?.id;
                
                // If no currentUser, try to get from token
                if (!userId) {
                    const token = localStorage.getItem('token');
                    if (token && token.split('.').length === 3) {
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            userId = payload.userId || payload.id;
                        } catch (e) {
                            console.error('Error parsing token:', e);
                        }
                    }
                }
                
                // If still no userId, try to get from localStorage
                if (!userId) {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        try {
                            const parsedUser = JSON.parse(storedUser);
                            userId = parsedUser.id;
                            currentUser = parsedUser;
                        } catch (e) {
                            console.error('Error parsing stored user:', e);
                        }
                    }
                }
                
                if (!userId) return;

                if (this.messages.length === 0) {
                    messagesContainer.innerHTML = '<div class="empty-state">No messages yet</div>';
                    return;
                }

                messagesContainer.innerHTML = this.messages.map(message => {
                    // Use the actual API response structure
                    const senderId = message.SenderID;
                    const content = message.Content;
                    const createdAt = message.CreatedAt;
                    const senderName = message.SenderName;
                    
                    const isSent = senderId === parseInt(userId);
                    const messageClass = isSent ? 'sent' : 'received';
                    
                    return `
                        <div class="widget-message ${messageClass}">
                            ${!isSent ? `<div class="widget-message-sender">${this.escapeHtml(senderName)}</div>` : ''}
                            <div class="widget-message-content">${this.escapeHtml(content)}</div>
                            <div class="widget-message-time">${this.formatTime(createdAt)}</div>
                        </div>
                    `;
                }).join('');
            }

            async sendMessage() {
                console.log('🚀 MessagingWidget.sendMessage() called!');
                console.log('🔍 Current widget state:', {
                    currentView: this.currentView,
                    currentConversationId: this.currentConversationId,
                    isOpen: this.isOpen
                });
                
                const input = document.getElementById('widget-chat-input');
                const sendButton = document.getElementById('widget-send-button');
                
                console.log('🔍 Widget input found:', input);
                console.log('🔍 Widget send button found:', sendButton);
                
                if (!input || !sendButton) {
                    console.log('❌ Missing input or send button elements');
                    console.log('🔍 Available elements:', {
                        'widget-chat-input': document.getElementById('widget-chat-input'),
                        'widget-send-button': document.getElementById('widget-send-button'),
                        'messaging-widget': document.getElementById('messaging-widget')
                    });
                    return;
                }
                
                const content = input.value.trim();
                console.log('🚀 Attempting to send message:', content);
                console.log('📋 Current conversation ID:', this.currentConversationId);
                
                if (!content) {
                    console.log('❌ Send blocked - no content');
                    return;
                }
                
                if (!this.currentConversationId) {
                    console.log('❌ Send blocked - no conversation ID');
                    console.log('🔍 Widget state:', {
                        currentView: this.currentView,
                        conversations: this.conversations?.length || 0
                    });
                    return;
                }

                // Try multiple ways to get current user
                let currentUser = window.currentUser;
                let userId = currentUser?.id;
                
                // If no currentUser, try to get from token
                if (!userId) {
                    const token = localStorage.getItem('token');
                    if (token && token.split('.').length === 3) {
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            userId = payload.userId || payload.id;
                        } catch (e) {
                            console.error('Error parsing token:', e);
                        }
                    }
                }
                
                // If still no userId, try to get from localStorage
                if (!userId) {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        try {
                            const parsedUser = JSON.parse(storedUser);
                            userId = parsedUser.id;
                            currentUser = parsedUser;
                        } catch (e) {
                            console.error('Error parsing stored user:', e);
                        }
                    }
                }
                
                if (!userId) {
                    console.log('❌ Send blocked - no user ID found');
                    return;
                }
                
                console.log('✅ User ID found:', userId);

                // Disable input and button
                input.disabled = true;
                sendButton.disabled = true;

                try {
                    // Optimistic update - use API structure format
                    const tempMessage = {
                        MessageID: 'temp-' + Date.now(),
                        Content: content,
                        SenderID: parseInt(userId),
                        SenderName: currentUser?.name || 'You',
                        CreatedAt: new Date().toISOString()
                    };
                    
                    this.messages.push(tempMessage);
                    this.renderMessages();
                    input.value = '';

                    // Always send message via HTTP first (same API as dashboard).
                    console.log('🌐 Sending message via HTTP POST first...');
                    console.log('🔍 API_BASE_URL value:', API_BASE_URL);
                    console.log('🌐 Using API URL:', `${API_BASE_URL}/messages`);

                    let httpSucceeded = false;
                    try {
                        const response = await fetch(`${API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                conversationId: parseInt(this.currentConversationId, 10),
                                senderId: parseInt(userId, 10),
                                content: content
                            })
                        });

                        console.log('📡 HTTP Response received:', response);
                        console.log('📡 Response status:', response.status);
                        console.log('📡 Response ok:', response.ok);

                        if (!response.ok) {
                            let errorData = null;
                            try { errorData = await response.json(); } catch (_) { /* ignore */ }
                            console.log('❌ HTTP Error response:', errorData);
                            throw new Error(errorData?.message || `Failed to send message via HTTP. Status ${response.status}`);
                        }

                        const result = await response.json();
                        console.log('HTTP POST message response:', result);

                        // Remove temp message
                        this.messages = this.messages.filter(m => m.MessageID !== tempMessage.MessageID);

                        // If socket is not connected, add the API message immediately.
                        // If socket is connected, rely on the server broadcast to avoid duplicates.
                        const socketConnected = !!(window.state?.socket && window.state.socket.connected);
                        if (!socketConnected && result.success && result.message) {
                            const realMessage = {
                                MessageID: result.message.MessageID,
                                Content: result.message.Content,
                                SenderID: result.message.SenderID,
                                SenderName: result.message.SenderName || currentUser?.name || 'You',
                                CreatedAt: result.message.CreatedAt || new Date().toISOString()
                            };
                            this.messages.push(realMessage);
                            this.renderMessages();
                            this.scrollToBottom();
                        }
                        httpSucceeded = true;
                    } catch (httpErr) {
                        console.error('HTTP send failed, will try Socket.IO if available:', httpErr);
                    }

                    // If HTTP failed, try Socket.IO as a fallback
                    if (!httpSucceeded && window.state?.socket && window.state.socket.connected) {
                        console.log('🧪 Falling back to Socket.IO...');
                        window.state.socket.emit('send-message', {
                            conversationId: parseInt(this.currentConversationId, 10),
                            content: content
                        });
                        console.log('✅ Socket.IO message emitted as fallback');
                        // Remove temp message - real message will come via socket listener
                        this.messages = this.messages.filter(m => m.MessageID !== tempMessage.MessageID);
                        this.renderMessages();
                    }

                } catch (error) {
                    console.error('Error sending message:', error);
                    
                    // Remove temp message on error
                    this.messages = this.messages.filter(m => !m.MessageID || !m.MessageID.startsWith('temp-'));
                    this.renderMessages();
                    
                    // Show error
                    this.showError('Failed to send message');
                } finally {
                    input.disabled = false;
                    sendButton.disabled = false;
                    input.focus();
                }
            }

            setupSocketListeners() {
                if (!window.state?.socket) return;

                window.state.socket.on('new-message', (message) => {
                    console.log('🔔 Widget received new message:', message);
                    
                    // Update conversations list
                    this.loadConversations();
                    
                    // If we're in the chat view for this conversation, add the message
                    if (this.currentView === 'chat' && String(message.conversationId) === String(this.currentConversationId)) {
                        // Remove any temp messages
                        this.messages = this.messages.filter(m => !m.MessageID || !m.MessageID.startsWith('temp-'));
                        
                        // Convert socket message format to widget format
                        const widgetMessage = {
                            MessageID: message.messageId || Date.now(),
                            Content: message.content,
                            SenderID: message.senderId,
                            SenderName: message.senderName || 'User',
                            CreatedAt: message.createdAt || new Date().toISOString()
                        };
                        
                        // Add the new message
                        this.messages.push(widgetMessage);
                        this.renderMessages();
                        this.scrollToBottom();
                    }
                    
                    // Update badge
                    this.updateBadge();
                });
            }

            syncWithDashboardBadge() {
                // Watch for changes to the dashboard messages badge
                const dashboardBadge = document.getElementById('messages-badge');
                if (dashboardBadge) {
                    const observer = new MutationObserver(() => {
                        const count = parseInt(dashboardBadge.textContent) || 0;
                        this.updateWidgetBadge(count);
                    });
                    
                    observer.observe(dashboardBadge, {
                        childList: true,
                        characterData: true,
                        subtree: true
                    });
                }
                
                // Initial sync
                if (typeof fetchAndUpdateMessagesBadge === 'function') {
                    fetchAndUpdateMessagesBadge();
                }
            }

            updateBadge() {
                const totalUnread = this.conversations.reduce((sum, conv) => sum + (conv.unreadCount || 0), 0);
                this.updateWidgetBadge(totalUnread);
                
                // Also update dashboard badge
                const dashboardBadge = document.getElementById('messages-badge');
                if (dashboardBadge) {
                    dashboardBadge.textContent = totalUnread;
                    dashboardBadge.style.display = totalUnread > 0 ? 'block' : 'none';
                }
            }

            updateWidgetBadge(count) {
                const badge = document.getElementById('widget-message-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'flex' : 'none';
                }
            }

            filterConversations(query) {
                if (!query.trim()) {
                    this.renderConversations();
                    return;
                }

                const filtered = this.conversations.filter(conversation => {
                    const otherUser = conversation.otherUser || {};
                    const name = (otherUser.name || '').toLowerCase();
                    const lastMessage = (conversation.lastMessage?.content || '').toLowerCase();
                    const searchQuery = query.toLowerCase();
                    
                    return name.includes(searchQuery) || lastMessage.includes(searchQuery);
                });

                this.renderConversations(filtered);
            }

            scrollToBottom() {
                const container = document.getElementById('chat-messages-container');
                if (container) {
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            }

            getInitials(name) {
                if (!name) return '?';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }

            formatTime(timestamp) {
                if (!timestamp) return '';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'now';
                if (diffMins < 60) return `${diffMins}m`;
                if (diffHours < 24) return `${diffHours}h`;
                if (diffDays < 7) return `${diffDays}d`;
                
                return date.toLocaleDateString();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                // You can implement a toast notification here
                console.error(message);
            }
        }

        // Debug function to test API connection
        window.testAPI = async function() {
            console.log('🧪 Testing API connection...');
            console.log('🔍 API_BASE_URL:', API_BASE_URL);
            
            try {
                const response = await fetch(`${API_BASE_URL}/ping`);
                console.log('📡 Ping response status:', response.status);
                const data = await response.json();
                console.log('📡 Ping response data:', data);
            } catch (error) {
                console.error('❌ API connection failed:', error);
            }
        };

        // Debug function to test messaging widget
        window.testMessagingWidget = function() {
            console.log('🧪 Testing messaging widget...');
            console.log('🔍 Current user:', window.currentUser);
            console.log('🔍 Token:', localStorage.getItem('token'));
            console.log('🔍 API_BASE_URL:', API_BASE_URL);
            console.log('🔍 Messaging widget instance:', window.messagingWidget);
            
            if (window.messagingWidget) {
                console.log('✅ Widget exists, attempting to open...');
                window.messagingWidget.openWidget();
            } else {
                console.log('❌ No messaging widget instance found');
            }
        };

        // Debug function to test conversations API directly
        window.testConversationsAPI = async function(userId = 1) {
            console.log('🧪 Testing conversations API...');
            console.log('🔍 Testing with userId:', userId);
            
            try {
                const response = await fetch(`${API_BASE_URL}/messages/conversations/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('📡 Conversations API response status:', response.status);
                console.log('📡 Conversations API response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📋 Conversations API response data:', data);
                } else {
                    const errorText = await response.text();
                    console.error('❌ Conversations API error:', errorText);
                }
            } catch (error) {
                console.error('❌ Conversations API failed:', error);
            }
        };

        // Initialize messaging widget when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for other initializations
            setTimeout(() => {
                console.log('🔍 Checking for messaging-widget element...');
                const messagingWidgetElement = document.getElementById('messaging-widget');
                console.log('🔍 messaging-widget element found:', messagingWidgetElement);
                console.log('🔍 Current user:', window.currentUser);
                console.log('🔍 API_BASE_URL:', API_BASE_URL);
                console.log('🔍 Socket state:', window.state?.socket);
                
                if (messagingWidgetElement) {
                    console.log('✅ Creating new MessagingWidget instance...');
                    try {
                        window.messagingWidget = new MessagingWidget();
                        console.log('✅ MessagingWidget created:', window.messagingWidget);
                        console.log('✅ MessagingWidget methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.messagingWidget)));
                        
                        // Add test message to console
                        console.log('🧪 Available test functions:');
                        console.log('  - testAPI() - Test API connection');
                        console.log('  - testConversationsAPI(userId) - Test conversations endpoint');
                        console.log('  - testMessagingWidget() - Test messaging widget');
                    } catch (error) {
                        console.error('❌ Error creating MessagingWidget:', error);
                    }
                } else {
                    console.log('❌ messaging-widget element not found!');
                    console.log('🔍 Available elements with "messaging" in ID:');
                    const allElements = document.querySelectorAll('[id*="messaging"]');
                    allElements.forEach(el => console.log('  -', el.id, el));
                }
            }, 1000);
        });

        // Settings Modal Handler
        document.addEventListener('DOMContentLoaded', function() {
            const modalOverlay = document.getElementById('settings-modal-overlay');
            const modalTitle = document.getElementById('settings-modal-title');
            const modalContent = document.getElementById('settings-modal-content');
            const closeBtn = document.querySelector('.settings-modal-close');

            // Close modal handlers
            if (closeBtn) {
                closeBtn.addEventListener('click', closeSettingsModal);
            }
            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        closeSettingsModal();
                    }
                });
            }

            function closeSettingsModal() {
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                }
            }

            // Handle settings card clicks
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.settings-card');
                if (!card) return;

                const modalType = card.dataset.settingsModal;
                if (!modalType) return;

                openSettingsModal(modalType);
            });

            function openSettingsModal(type) {
                if (!modalOverlay || !modalTitle || !modalContent) return;

                // Set title and content based on type
                const modalData = getModalContent(type);
                modalTitle.textContent = modalData.title;
                modalContent.innerHTML = modalData.content;

                // Show modal
                modalOverlay.classList.add('active');

                // Setup form handlers
                setupModalFormHandlers(type);
            }

            function getModalContent(type) {
                const isVendor = type.startsWith('vendor-');
                
                switch(type) {
                    case 'personal-details':
                    case 'vendor-personal-details':
                        return {
                            title: 'Personal details',
                            content: `
                                <form id="personal-details-form">
                                    <div class="form-group">
                                        <label for="modal-name">Full Name</label>
                                        <input type="text" id="modal-name" value="${currentUser?.name || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="modal-email">Email</label>
                                        <input type="email" id="modal-email" value="${currentUser?.email || ''}" disabled>
                                        <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Email cannot be changed</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="modal-phone">Phone Number</label>
                                        <input type="tel" id="modal-phone" value="${currentUser?.phone || ''}">
                                    </div>
                                    <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--primary);">Password</h3>
                                    <div class="form-group">
                                        <label for="modal-current-password">Current Password</label>
                                        <input type="password" id="modal-current-password">
                                    </div>
                                    <div class="form-group">
                                        <label for="modal-new-password">New Password</label>
                                        <input type="password" id="modal-new-password">
                                    </div>
                                    <div class="form-group">
                                        <label for="modal-confirm-password">Confirm New Password</label>
                                        <input type="password" id="modal-confirm-password">
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                                        <button type="button" class="btn btn-outline" onclick="document.querySelector('.settings-modal-close').click()">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </form>
                            `
                        };
                    
                    case 'communication-preferences':
                    case 'vendor-communication-preferences':
                        return {
                            title: 'Communication preferences',
                            content: `
                                <form id="communication-preferences-form">
                                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Choose which emails, SMS, and push notifications you'd like to receive.</p>
                                    
                                    <h3 style="margin-bottom: 1rem; color: var(--primary);">Email Notifications</h3>
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" checked>
                                            <span>Booking confirmations and updates</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" checked>
                                            <span>New messages from ${isVendor ? 'clients' : 'vendors'}</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" checked>
                                            <span>Payment receipts and invoices</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox">
                                            <span>Marketing and promotional emails</span>
                                        </label>
                                    </div>

                                    <h3 style="margin-bottom: 1rem; color: var(--primary);">SMS Notifications</h3>
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" checked>
                                            <span>Booking reminders (24 hours before)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox">
                                            <span>New message alerts</span>
                                        </label>
                                    </div>

                                    <h3 style="margin-bottom: 1rem; color: var(--primary);">Push Notifications</h3>
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" checked>
                                            <span>Real-time booking updates</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" checked>
                                            <span>New messages</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox">
                                            <span>Payment notifications</span>
                                        </label>
                                    </div>

                                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                                        <button type="button" class="btn btn-outline" onclick="document.querySelector('.settings-modal-close').click()">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                                    </div>
                                </form>
                            `
                        };
                    
                    case 'security':
                    case 'vendor-security':
                        return {
                            title: 'Security',
                            content: `
                                <div>
                                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">Manage your account security settings and connected applications.</p>
                                    
                                    <h3 style="margin-bottom: 1rem; color: var(--primary);">Two-Factor Authentication</h3>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 2rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <p style="font-weight: 500; margin-bottom: 0.25rem;">Two-factor authentication is disabled</p>
                                                <p style="color: var(--text-light); font-size: 0.875rem;">Add an extra layer of security to your account</p>
                                            </div>
                                            <button class="btn btn-primary">Enable</button>
                                        </div>
                                    </div>

                                    <h3 style="margin-bottom: 1rem; color: var(--primary);">Active Sessions</h3>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 2rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                            <div>
                                                <p style="font-weight: 500; margin-bottom: 0.25rem;"><i class="fas fa-desktop" style="margin-right: 0.5rem;"></i>Current session</p>
                                                <p style="color: var(--text-light); font-size: 0.875rem;">Active now</p>
                                            </div>
                                        </div>
                                    </div>

                                    <h3 style="margin-bottom: 1rem; color: var(--primary);">Connected Apps</h3>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: var(--radius); border: 1px solid var(--border);">
                                        <p style="color: var(--text-light);">No connected applications</p>
                                    </div>

                                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                                        <button type="button" class="btn btn-outline" onclick="document.querySelector('.settings-modal-close').click()">Close</button>
                                    </div>
                                </div>
                            `
                        };
                    
                    default:
                        return {
                            title: 'Settings',
                            content: '<p>Settings content not found.</p>'
                        };
                }
            }

            function setupModalFormHandlers(type) {
                // Personal details form
                const personalForm = document.getElementById('personal-details-form');
                if (personalForm) {
                    personalForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('modal-name').value;
                        const phone = document.getElementById('modal-phone').value;
                        const currentPassword = document.getElementById('modal-current-password').value;
                        const newPassword = document.getElementById('modal-new-password').value;
                        const confirmPassword = document.getElementById('modal-confirm-password').value;

                        try {
                            // Update profile info
                            const updateData = { name, phone };
                            const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                },
                                body: JSON.stringify(updateData)
                            });

                            if (!response.ok) throw new Error('Failed to update profile');

                            // Update password if provided
                            if (newPassword) {
                                if (newPassword !== confirmPassword) {
                                    alert('New passwords do not match');
                                    return;
                                }
                                if (!currentPassword) {
                                    alert('Current password is required to set a new password');
                                    return;
                                }

                                const passResponse = await fetch(`${API_BASE_URL}/users/${currentUser.id}/password`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                                    },
                                    body: JSON.stringify({ currentPassword, newPassword })
                                });

                                if (!passResponse.ok) {
                                    const error = await passResponse.json();
                                    throw new Error(error.message || 'Failed to update password');
                                }
                            }

                            alert('Profile updated successfully');
                            currentUser.name = name;
                            currentUser.phone = phone;
                            closeSettingsModal();
                        } catch (error) {
                            console.error('Error updating profile:', error);
                            alert(error.message || 'Failed to update profile');
                        }
                    });
                }

                // Communication preferences form
                const commForm = document.getElementById('communication-preferences-form');
                if (commForm) {
                    commForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        // TODO: Save notification preferences to backend
                        alert('Notification preferences saved successfully');
                        closeSettingsModal();
                    });
                }
            }
        });
    </script>

    <!-- Messaging Widget -->
    <div id="messaging-widget" class="messaging-widget">
        <!-- Chat Button -->
        <div id="chat-button" class="chat-button">
            <i class="fas fa-comments"></i>
            <span id="widget-message-badge" class="widget-message-badge">0</span>
        </div>

        <!-- Widget Container -->
        <div id="widget-container" class="widget-container" style="display: none;">
            <!-- Widget Header -->
            <div class="widget-header">
                <h3>Messages</h3>
                <button id="widget-close" class="widget-close">&times;</button>
            </div>

            <!-- Conversations List -->
            <div id="conversations-view" class="widget-view">
                <div class="conversations-header">
                    <input type="text" id="conversation-search" placeholder="Search conversations..." class="conversation-search">
                </div>
                <div id="conversations-list" class="conversations-list">
                    <div class="loading-state">Loading conversations...</div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chat-view" class="widget-view" style="display: none;">
                <div class="chat-header">
                    <button id="back-to-conversations" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-user-info">
                        <img id="chat-user-avatar" src="" alt="" class="chat-user-avatar">
                        <span id="chat-user-name" class="chat-user-name"></span>
                    </div>
                </div>
                <div id="chat-messages-container" class="chat-messages-container">
                    <div class="loading-state">Loading messages...</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="widget-chat-input" placeholder="Type a message..." class="widget-chat-input">
                    <button id="widget-send-button" class="widget-send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Styles -->
    <style id="vv-footer-css">
        .vv-footer { background-color: var(--surface-bg); border-top: 1px solid var(--border); }
        .vv-footer .vv-wrap { max-width: 1200px; margin: 0 auto; padding: 32px 16px; display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; gap: 24px; align-items: start; }
        .vv-footer .vv-brand { display: flex; flex-direction: column; gap: 12px; color: var(--text); }
        .vv-footer .vv-logo { display: flex; align-items: center; gap: 8px; font-weight: 700; color: var(--text); }
        .vv-footer .vv-tagline { color: var(--text-light); font-size: 0.95rem; }
        .vv-footer .vv-badges { display: flex; gap: 8px; flex-wrap: wrap; }
        .vv-footer .vv-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; color: var(--text); text-decoration: none; font-weight: 600; background: #fff; }
        .vv-footer .vv-col h4 { margin: 0 0 10px 0; font-size: 1rem; color: var(--text); }
        .vv-footer .vv-links { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
        .vv-footer .vv-links a { color: var(--text); text-decoration: none; opacity: 0.85; }
        .vv-footer .vv-links a:hover { color: var(--primary); opacity: 1; }
        .vv-footer .vv-social { display: flex; gap: 12px; }
        .vv-footer .vv-social a { width: 36px; height: 36px; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text); text-decoration: none; }
        .vv-footer .vv-social a:hover { color: var(--primary); border-color: var(--primary); }
        .vv-footer .vv-cta { margin-top: 12px; }
        .vv-footer .vv-cta a { display: inline-block; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px; text-decoration: none; color: var(--text); font-weight: 600; background: transparent; }
        .vv-footer .vv-cta a:hover { border-color: var(--primary); color: var(--primary); }
        @media (max-width: 992px) { .vv-footer .vv-wrap { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 600px) { .vv-footer .vv-wrap { grid-template-columns: 1fr; } .vv-footer .vv-social a { width: 32px; height: 32px; } }
    </style>

    <!-- Multi-column Footer -->
    <footer class="vv-footer" aria-label="Site footer">
        <div class="vv-wrap">
            <div class="vv-brand">
                <div class="vv-logo">
                    <img src="planhive_logo.svg" alt="PlanHive" style="height: 45px; width: auto;">
                </div>
                <div class="vv-tagline">Get the app and plan on the go</div>
                <div class="vv-badges">
                    <a class="vv-badge" href="#" onclick="event.preventDefault();" aria-label="Get it on Google Play">
                        <i class="fab fa-google-play"></i>
                        <span>Google Play</span>
                    </a>
                    <a class="vv-badge" href="#" onclick="event.preventDefault();" aria-label="Download on the App Store">
                        <i class="fab fa-apple"></i>
                        <span>App Store</span>
                    </a>
                </div>
                <div style="color: var(--text-light); font-size: 0.9rem;">© 2025 PlanHive. All rights reserved.</div>
            </div>

            <div class="vv-col">
                <h4>Company</h4>
                <ul class="vv-links">
                    <li><a href="#" onclick="event.preventDefault();">Home</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Articles</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Submit to Blog</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Are You a Vendor?</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Meet the Team</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Privacy Policy</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Terms of Use</a></li>
                </ul>
            </div>

            <div class="vv-col">
                <h4>Vendors</h4>
                <ul class="vv-links">
                    <li><a href="#" onclick="event.preventDefault();">Venues</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Caterers</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Event Planners</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Photographers</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Videographers</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Live Music &amp; DJs</a></li>
                    <li><a href="#" onclick="event.preventDefault();">Décor &amp; Rentals</a></li>
                </ul>
            </div>

            <div class="vv-col">
                <h4>Connect With Us</h4>
                <div class="vv-social">
                    <a href="#" onclick="event.preventDefault();" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" onclick="event.preventDefault();" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" onclick="event.preventDefault();" aria-label="Pinterest"><i class="fab fa-pinterest-p"></i></a>
                    <a href="#" onclick="event.preventDefault();" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" onclick="event.preventDefault();" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
                </div>
                <div class="vv-cta">
                    <a href="#" onclick="event.preventDefault();">Advertise with Us!</a>
                </div>
            </div>
        </div>
    </footer>

</html>
