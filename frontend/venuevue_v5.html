<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <title>VenueVue | Event Vendor Marketplace</title>
    <!-- Add Stripe.js for payment processing -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Add FullCalendar for booking dates -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <!-- Add Socket.IO for chat functionality -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Add Chart.js for analytics graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #5e72e4;
            --secondary: #f7fafc;
            --accent: #ff6b6b;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: var(--text);
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background-color: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 2rem;
        }
        
        .search-bar {
            position: relative;
        }
        
        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        .user-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        
        .nav-icon {
            position: relative;
            color: var(--text);
            cursor: pointer;
        }
        
        .nav-icon .badge {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Categories Navigation */
        .categories-nav {
            grid-column: 1 / -1;
            background-color: white;
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem; /* Adjusted padding for buttons */
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically center buttons and list */
        }

        .categories-list-wrapper {
            flex-grow: 1; /* Allow the wrapper to take available space */
            overflow-x: auto; /* Keep horizontal scrolling */
            white-space: nowrap;
            padding: 0.5rem 0; /* Add vertical padding to ensure content isn't cut off */

            /* Hide scrollbar for Webkit browsers */
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }

        .categories-list-wrapper::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari, Opera */
        }

        /* Hide scrollbar for Firefox */
        .categories-list-wrapper {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        .categories-list {
            display: inline-flex;
            gap: 1rem;
        }
        
        .category-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; /* Added for icon alignment */
            align-items: center; /* Added for icon alignment */
            gap: 0.5rem; /* Added for spacing between icon and text */
        }
        
        .category-item:hover {
            background-color: var(--secondary);
        }
        
        .category-item.active {
            background-color: var(--primary);
            color: white;
        }

        /* New styles for scroll buttons */
        .nav-scroll-btn {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; /* Prevent buttons from shrinking */
            margin: 0 0.5rem; /* Space between buttons and list */
            box-shadow: var(--shadow); /* Added shadow for better appearance */
        }

        .nav-scroll-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Sidebar */
        .sidebar {
            background-color: white;
            padding: 1.5rem;
            border-right: 1px solid var(--border);
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            overflow-y: auto;
        }
        
        .filter-section {
            margin-bottom: 2rem;
        }
        
        .filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
        }
        
        .filter-reset {
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
        }
        
        .filter-option input {
            margin-right: 0.75rem;
            accent-color: var(--primary);
        }
        
        .filter-option label {
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .range-slider {
            width: 100%;
            height: 4px;
            margin: 1rem 0;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 2px;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--primary);
            cursor: pointer;
        }
        
        .price-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        /* New Advanced Filters Section */
        .advanced-filters {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }
        
        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .advanced-content {
            display: none;
        }
        
        .advanced-content.show {
            display: block;
        }
        
        .date-picker {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .date-picker input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .region-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        
        .trending-section {
            margin-top: 2rem;
        }
        
        .trending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .trending-tag {
            padding: 0.5rem 0.75rem;
            background-color: var(--secondary);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trending-tag:hover {
            background-color: #e6e9ff;
            color: var(--primary);
        }
        
        .trending-tag.active {
            background-color: var(--primary);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .results-count {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .view-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .sort-select {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: white;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .view-toggle {
            display: flex;
            background-color: var(--secondary);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .view-btn.active {
            background-color: white;
            color: var(--primary);
            font-weight: 500;
            box-shadow: var(--shadow);
        }
        
        .map-view-container {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .map-container {
            height: 400px;
            background-color: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
        }
        
        .map-btn {
            width: 32px;
            height: 32px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            border: 1px solid var(--border);
        }
        
        .map-venue-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .vendor-card {
            background-color: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .vendor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .vendor-image {
            height: 180px;
            background-color: #f1f5f9;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }
        
        .vendor-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .vendor-favorite {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-light);
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }
        
        .vendor-favorite.active {
            color: var(--accent);
        }
        
        .vendor-details {
            padding: 1.25rem;
        }
        
        .vendor-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .vendor-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        
        .vendor-features {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .feature {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: var(--text);
        }
        
        .feature-icon {
            color: var(--primary);
        }
        
        .price-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
        }
        
        .price-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-light);
        }
        
        .price-dot.filled {
            background-color: var(--primary);
        }
        
        .vendor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .vendor-price {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .vendor-price span {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text-light);
        }
        
        .vendor-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background-color: rgba(94, 114, 228, 0.1);
        }
        
        .btn-primary {
            background-color: var(--primary);
            border: 1px solid var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4a5acf;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 3rem;
            gap: 0.5rem;
        }
        
        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .page-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .page-btn.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Booking Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }
        
        .close-modal {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: var(--primary);
        }

        /* Vendor Details in Modal */
        .vendor-detail-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .vendor-detail-image {
            width: 200px;
            height: 150px;
            background-color: #f1f5f9;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .vendor-detail-info {
            flex: 1;
        }
        
        .vendor-detail-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .vendor-detail-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        
        .vendor-detail-features {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .vendor-detail-price {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .vendor-detail-description {
            margin-bottom: 2rem;
            line-height: 1.6;
            color: var(--text);
        }
        
        /* Services Section */
        .services-section {
            margin-top: 2rem;
        }
        
        .services-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .service-category {
            margin-bottom: 2rem;
        }
        
        .category-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .service-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .service-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .service-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .service-description {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .service-price {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .service-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }

        /* New Booking Calendar Section */
        .booking-calendar-section {
            margin: 2rem 0;
        }
        
        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        #booking-calendar {
            background-color: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .time-slot {
            padding: 0.75rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-slot:hover {
            background-color: #e6e9ff;
            color: var(--primary);
        }
        
        .time-slot.selected {
            background-color: var(--primary);
            color: white;
        }
        
        .time-slot.unavailable {
            background-color: #f1f5f9;
            color: var(--text-light);
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        /* New Reviews Section */
        .reviews-section {
            margin: 2rem 0;
        }
        
        .reviews-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .review-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .reviewer {
            font-weight: 600;
        }
        
        .review-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .review-rating {
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }
        
        .review-text {
            line-height: 1.6;
        }
        
        .add-review-btn {
            margin-top: 1rem;
        }
        
        /* New Review Form */
        .review-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }
        
        .rating-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .rating-star {
            font-size: 1.5rem;
            color: #e2e8f0;
            cursor: pointer;
        }
        
        .rating-star.selected {
            color: #fbbf24;
        }
        
        .review-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            min-height: 100px;
        }
        
        /* New Chat Section */
        .chat-section {
            margin: 2rem 0;
        }
        
        .chat-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .chat-container {
            background-color: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 1rem;
            max-width: 80%;
        }
        
        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-light);
        }
        
        .message.received {
            margin-right: auto;
        }
        
        .message-content {
            padding: 0.75rem;
            border-radius: var(--radius);
            display: inline-block;
        }
        
        .sent .message-content {
            background-color: var(--primary);
            color: white;
        }
        
        .received .message-content {
            background-color: var(--secondary);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-right: 0.5rem;
        }
        
        /* New Payment Section */
        .payment-section {
            margin: 2rem 0;
        }
        
        .payment-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .payment-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .card-element {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        
        /* Booking confirmation */
        .booking-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
        }

        /* Location permission modal */
        .location-permission {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
            text-align: center;
        }

        .location-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(94, 114, 228, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }

        /* Profile Modal Styles */
        .profile-modal .modal-content {
            max-width: 400px;
        }

        .profile-modal .modal-body {
            padding: 20px;
        }

        .profile-modal input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background-color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2rem;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        .dashboard-sidebar {
            background-color: white;
            border-right: 1px solid var(--border);
            padding: 1.5rem;
        }
        
        .dashboard-menu {
            list-style: none;
            margin-top: 2rem;
        }
        
        .dashboard-menu li {
            margin-bottom: 0.5rem;
        }
        
        .dashboard-menu a {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .dashboard-menu a:hover {
            background-color: var(--secondary);
        }
        
        .dashboard-menu a.active {
            background-color: var(--primary);
            color: white;
        }
        
        .dashboard-content {
            padding: 2rem;
            background-color: var(--secondary);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .dashboard-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .booking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .booking-item:last-child {
            border-bottom: none;
        }
        
        .booking-info {
            flex: 1;
        }
        
        .booking-vendor {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .booking-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .booking-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-confirmed {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* Vendor Dashboard Styles */
        .vendor-dashboard-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* Vendor Registration Form */
        .vendor-registration-form {
            background-color: white;
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-col {
            flex: 1;
        }
        
        /* Price indicator styles */
        .price-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
        }
        
        /* Analytics Chart Styles */
        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background-color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                height: 90vh;
            }
            
            .modal-body {
                max-height: calc(90vh - 60px);
            }
            
            .vendor-detail-header {
                flex-direction: column;
            }
            
            .vendor-detail-image {
                width: 100%;
                height: 200px;
            }
            
            .view-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .categories-nav {
                padding: 0.5rem 1rem;
            }
            
            .category-item {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Main App View -->
    <div class="app-container" id="app-container">
        <header class="header">
            <div class="logo">
                <span>üéâ</span>
                VenueVue
            </div>
            
            <div class="search-container">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Search for event vendors..." id="search-input">
                </div>
            </div>
            
            <div class="user-nav">
                <div class="nav-icon" id="wishlist-btn">
                    ‚ù§
                    <span class="badge" id="favorites-badge">0</span>
                </div>
                <div class="nav-icon" id="notifications-btn">
                    üîî
                    <span class="badge" id="notifications-badge">0</span>
                </div>
                <div class="nav-icon" id="profile-btn">üë§</div>
            </div>
        </header>
        
        <!-- Categories Navigation -->
        <nav class="categories-nav">
            <button class="nav-scroll-btn left" id="scroll-left">‚óÄ</button>
            <div class="categories-list-wrapper">
                <div class="categories-list" id="categories-list">
                    <!-- Categories will be loaded dynamically -->
                </div>
            </div>
            <button class="nav-scroll-btn right" id="scroll-right">‚ñ∂</button>
        </nav>
        
        <aside class="sidebar">
            <div class="filter-section">
                <h3 class="filter-title">
                    Location
                    <span class="filter-reset" id="location-reset">Reset</span>
                </h3>
                <input type="text" placeholder="City or ZIP code" class="search-input" id="location-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="current-location">
                        <label for="current-location">Use my location</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="within50">
                        <label for="within50">Within 50 miles</label>
                    </div>
                </div>
            </div>
            
            <div class="filter-section">
                <h3 class="filter-title">
                    Price Range
                    <span class="filter-reset" id="price-reset">Reset</span>
                </h3>
                <input type="range" class="range-slider" min="0" max="100" value="40" id="price-slider">
                <div class="price-labels">
                    <span>$</span>
                    <span>$$</span>
                    <span>$$$</span>
                </div>
            </div>
            
            <div class="filter-section">
                <h3 class="filter-title">
                    Vendor Type
                    <span class="filter-reset" id="type-reset">Reset</span>
                </h3>
                <div class="filter-group">
                    <div class="filter-option">
                        <input type="checkbox" id="independent" checked>
                        <label for="independent">Independent</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="company" checked>
                        <label for="company">Company</label>
                    </div>
                </div>
            </div>
            
            <!-- New Advanced Filters Section -->
            <div class="advanced-filters">
                <div class="advanced-toggle" id="advanced-toggle">
                    <h3 class="filter-title">Advanced Filters</h3>
                    <span>+</span>
                </div>
                <div class="advanced-content" id="advanced-content">
                    <div class="filter-section">
                        <h3 class="filter-title">Availability</h3>
                        <div class="date-picker">
                            <input type="date" id="start-date" placeholder="Start date">
                            <input type="date" id="end-date" placeholder="End date">
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h3 class="filter-title">Region</h3>
                        <select class="region-select" id="region-select">
                            <option value="">All Regions</option>
                            <option value="north">Northern Region</option>
                            <option value="south">Southern Region</option>
                            <option value="east">Eastern Region</option>
                            <option value="west">Western Region</option>
                            <option value="central">Central Region</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="trending-section">
                <h3 class="filter-title">Popular Filters</h3>
                <div class="trending-tags">
                    <div class="trending-tag" data-filter="premium">Premium</div>
                    <div class="trending-tag" data-filter="eco-friendly">Eco-Friendly</div>
                    <div class="trending-tag" data-filter="award-winning">Award Winning</div>
                    <div class="trending-tag" data-filter="last-minute">Last Minute</div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="results-title">Loading vendors...</h1>
                    <p class="results-count">Please wait</p>
                </div>
                
                <div class="view-controls">
                    <select class="sort-select" id="sort-select">
                        <option value="recommended">Sort: Recommended</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                        <option value="nearest">Nearest to Me</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                </div>
            </div>
            
            <div class="map-view-container" id="map-view-container">
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-btn" id="zoom-in">+</button>
                        <button class="map-btn" id="zoom-out">-</button>
                        <button class="map-btn" id="locate-me">üìç</button>
                    </div>
                </div>
                <div class="map-venue-list" id="map-venue-list"></div>
            </div>
            
            <div class="vendor-grid" id="vendor-grid">
                <!-- Vendors will be loaded dynamically here -->
                <div style="grid-column:1/-1;text-align:center;padding:2rem;">Loading vendors...</div>
            </div>
            
            <div class="pagination" id="pagination">
                <div class="page-btn" id="prev-page">¬´</div>
                <div class="page-btn active">1</div>
                <div class="page-btn">2</div>
                <div class="page-btn">3</div>
                <div class="page-btn" id="next-page">¬ª</div>
            </div>
        </main>
    </div>

    <!-- Dashboard View (Hidden by default) -->
    <div class="dashboard-container" id="dashboard-container" style="display: none;">
        <aside class="dashboard-sidebar">
            <div class="logo" style="padding: 1rem 0; border-bottom: 1px solid var(--border);">
                <span>üéâ</span>
                VenueVue
            </div>
            
            <ul class="dashboard-menu">
                <li><a href="#" class="active" data-section="dashboard">Dashboard</a></li>
                <li><a href="#" data-section="bookings">My Bookings</a></li>
                <li><a href="#" data-section="favorites">Favorites</a></li>
                <li><a href="#" data-section="messages">Messages</a></li>
                <li><a href="#" data-section="reviews">My Reviews</a></li>
                <li><a href="#" data-section="settings">Settings</a></li>
                <li><a href="#" id="switch-to-vendor">Switch to Vendor Mode</a></li>
                <li><a href="#" id="logout-dashboard">Log Out</a></li>
            </ul>
        </aside>
        
        <main class="dashboard-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title" id="dashboard-title">Dashboard</h1>
                <div class="user-nav">
                    <div class="nav-icon" id="dashboard-notifications-btn">
                        üîî
                        <span class="badge" id="dashboard-notifications-badge">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Content -->
            <div id="dashboard-section">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Upcoming Bookings</h2>
                    <div id="upcoming-bookings">
                        <!-- Bookings will be loaded here -->
                        <p>Loading upcoming bookings...</p>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Recent Favorites</h2>
                    <div class="vendor-grid" id="dashboard-favorites">
                        <!-- Favorites will be loaded here -->
                        <p>Loading recent favorites...</p>
                    </div>
                </div>
            </div>
            
            <!-- Bookings Section (Hidden by default) -->
            <div id="bookings-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">All Bookings</h2>
                    <div id="all-bookings">
                        <!-- Bookings will be loaded here -->
                        <p>Loading all bookings...</p>
                    </div>
                </div>
            </div>
            
            <!-- Favorites Section (Hidden by default) -->
            <div id="favorites-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Saved Favorites</h2>
                    <div class="vendor-grid" id="saved-favorites">
                        <!-- Favorites will be loaded here -->
                        <p>Loading saved favorites...</p>
                    </div>
                </div>
            </div>
            
            <!-- Messages Section (Hidden by default) -->
            <div id="messages-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Messages</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="dashboard-chat-messages">
                            <!-- Messages will be loaded here -->
                            <p>Loading messages...</p>
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." id="dashboard-chat-input">
                            <button class="btn btn-primary" id="dashboard-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reviews Section (Hidden by default) -->
            <div id="reviews-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">My Reviews</h2>
                    <div id="user-reviews">
                        <!-- Reviews will be loaded here -->
                        <p>Loading your reviews...</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section (Hidden by default) -->
            <div id="settings-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Account Settings</h2>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name">
                        </div>
                        <div class="form-group">
                            <label for="profile-email">Email</label>
                            <input type="email" id="profile-email" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone">
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Change Password</h2>
                    <form id="password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password">
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password</label>
                            <input type="password" id="confirm-password">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Vendor Dashboard View (Hidden by default) -->
    <div class="dashboard-container" id="vendor-dashboard-container" style="display: none;">
        <aside class="dashboard-sidebar">
            <div class="logo" style="padding: 1rem 0; border-bottom: 1px solid var(--border);">
                <span>üéâ</span>
                VenueVue
            </div>
            
            <ul class="dashboard-menu">
                <li><a href="#" class="active" data-section="vendor-dashboard">Dashboard</a></li>
                <li><a href="#" data-section="vendor-bookings">Bookings</a></li>
                <li><a href="#" data-section="vendor-services">Services</a></li>
                <li><a href="#" data-section="vendor-messages">Messages</a></li>
                <li><a href="#" data-section="vendor-reviews">Reviews</a></li>
                <li><a href="#" data-section="vendor-analytics">Analytics</a></li>
                <li><a href="#" data-section="vendor-settings">Settings</a></li>
                <li><a href="#" id="switch-to-client">Switch to Client Mode</a></li>
                <li><a href="#" id="vendor-logout">Log Out</a></li>
            </ul>
        </aside>
        
        <main class="dashboard-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title" id="vendor-dashboard-title">Vendor Dashboard</h1>
                <div class="user-nav">
                    <div class="nav-icon" id="vendor-notifications-btn">
                        üîî
                        <span class="badge" id="vendor-notifications-badge">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Dashboard Content -->
            <div id="vendor-dashboard-section">
                <div class="vendor-stats" id="vendor-stats">
                    <!-- Stats will be loaded here -->
                    <p>Loading vendor stats...</p>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Recent Bookings</h2>
                    <div id="vendor-recent-bookings">
                        <!-- Bookings will be loaded here -->
                        <p>Loading recent bookings...</p>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Recent Messages</h2>
                    <div class="chat-container" style="height: 400px;">
                        <div class="chat-messages" id="vendor-chat-messages">
                            <!-- Messages will be loaded here -->
                            <p>Loading recent messages...</p>
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." id="vendor-chat-input">
                            <button class="btn btn-primary" id="vendor-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Bookings Section (Hidden by default) -->
            <div id="vendor-bookings-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">All Bookings</h2>
                    <div id="vendor-all-bookings">
                        <!-- Bookings will be loaded here -->
                        <p>Loading all bookings...</p>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Services Section (Hidden by default) -->
            <div id="vendor-services-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Manage Services</h2>
                    <div class="services-section" id="vendor-services">
                        <!-- Services will be loaded here -->
                        <p>Loading services...</p>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Messages Section (Hidden by default) -->
            <div id="vendor-messages-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Messages</h2>
                    <div class="chat-container" style="height: 500px;">
                        <div class="chat-messages" id="vendor-all-chat-messages">
                            <!-- Messages will be loaded here -->
                            <p>Loading all messages...</p>
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." id="vendor-all-chat-input">
                            <button class="btn btn-primary" id="vendor-all-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Reviews Section (Hidden by default) -->
            <div id="vendor-reviews-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Customer Reviews</h2>
                    <div id="vendor-reviews">
                        <!-- Reviews will be loaded here -->
                        <p>Loading customer reviews...</p>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Analytics Section (Hidden by default) -->
            <div id="vendor-analytics-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Performance Analytics</h2>
                    <div id="analytics-charts" class="analytics-charts">
                        <!-- Analytics will be loaded here -->
                        <p>Loading analytics data...</p>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Settings Section (Hidden by default) -->
            <div id="vendor-settings-section" style="display: none;">
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Business Profile</h2>
                    <form id="vendor-profile-form">
                        <div class="form-group">
                            <label for="vendor-name">Business Name</label>
                            <input type="text" id="vendor-name">
                        </div>
                        <div class="form-group">
                            <label for="vendor-category">Category</label>
                            <select id="vendor-category">
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vendor-description">Description</label>
                            <textarea id="vendor-description" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="vendor-address">Address</label>
                            <input type="text" id="vendor-address">
                        </div>
                        <div class="form-group">
                            <label for="vendor-city">City</label>
                            <input type="text" id="vendor-city">
                        </div>
                        <div class="form-group">
                            <label for="vendor-state">State</label>
                            <input type="text" id="vendor-state">
                        </div>
                        <div class="form-group">
                            <label for="vendor-country">Country</label>
                            <input type="text" id="vendor-country">
                        </div>
                        <div class="form-group">
                            <label for="vendor-postalCode">Postal Code</label>
                            <input type="text" id="vendor-postalCode">
                        </div>
                        <div class="form-group">
                            <label for="vendor-phone">Phone Number</label>
                            <input type="tel" id="vendor-phone">
                        </div>
                        <div class="form-group">
                            <label for="vendor-email">Business Email</label>
                            <input type="email" id="vendor-email">
                        </div>
                        <div class="form-group">
                            <label for="vendor-website">Website (optional)</label>
                            <input type="url" id="vendor-website">
                        </div>
                        <div class="form-group">
                            <label for="vendor-years-in-business">Years in Business</label>
                            <input type="number" id="vendor-years-in-business" min="0">
                        </div>
                        <div class="form-group">
                            <label for="vendor-is-premium">Premium Vendor</label>
                            <input type="checkbox" id="vendor-is-premium">
                        </div>
                        <div class="form-group">
                            <label for="vendor-is-eco-friendly">Eco-Friendly</labeL>
                            <input type="checkbox" id="vendor-is-eco-friendly">
                        </div>
                        <div class="form-group">
                            <label for="vendor-is-award-winning">Award Winning</label>
                            <input type="checkbox" id="vendor-is-award-winning">
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Business Photos</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;" id="vendor-photos">
                        <!-- Photos will be loaded here -->
                        <p>No photos uploaded.</p>
                    </div>
                    <button class="btn btn-outline" id="upload-photos-btn">Upload Photos</button>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="dashboard-card-title">Availability Settings</h2>
                    <div id="vendor-availability-calendar" style="margin-bottom: 1.5rem;"></div>
                    <button class="btn btn-outline" id="set-business-hours-btn">Set Business Hours</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Vendor Registration Modal -->
    <div id="vendor-registration-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Register as a Vendor</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form class="vendor-registration-form" id="vendor-registration-form">
                    <div class="form-section">
                        <h4 class="form-section-title">Business Information</h4>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-business-name">Business Name</label>
                                    <input type="text" id="reg-business-name" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-business-type">Business Type</label>
                                    <select id="reg-business-type" required>
                                        <option value="">Select type</option>
                                        <option value="individual">Individual/Sole Proprietor</option>
                                        <option value="llc">LLC</option>
                                        <option value="corporation">Corporation</option>
                                        <option value="partnership">Partnership</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-category">Primary Category</label>
                                    <select id="reg-category">
                                        <option value="">Select category</option>
                                        <!-- Categories will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-years-in-business">Years in Business</label>
                                    <input type="number" id="reg-years-in-business" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-business-description">Business Description</label>
                            <textarea id="reg-business-description" rows="4" required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Contact Information</h4>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-business-email">Business Email</label>
                                    <input type="email" id="reg-business-email" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-business-phone">Business Phone</label>
                                    <input type="tel" id="reg-business-phone" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-business-address">Business Address</label>
                                    <input type="text" id="reg-business-address" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="reg-business-website">Website (optional)</label>
                                    <input type="url" id="reg-business-website">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Service Information</h4>
                        <div id="service-fields-container">
                            <div class="service-field-group">
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label>Service Name</label>
                                            <input type="text" name="service-name[]" required>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label>Price</label>
                                            <input type="number" name="service-price[]" min="0" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="service-description[]" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline" id="add-service-field">Add Another Service</button>
                    </div>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Business Documents</h4>
                        <div class="form-group">
                            <label>Business License (Upload)</label>
                            <input type="file" id="business-license" accept=".pdf,.jpg,.png" >
                        </div>
                        <div class="form-group">
                            <label>Tax ID Verification (Upload)</label>
                            <input type="file" id="tax-id" accept=".pdf,.jpg,.png" >
                        </div>
                        <div class="form-group">
                            <label>Portfolio or Sample Work (Optional)</label>
                            <input type="file" id="portfolio" accept=".pdf,.jpg,.png,.mp4">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vendor Modal (working version) -->
    <div id="vendor-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-vendor-name">Vendor Name</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Header Info -->
                <div class="vendor-detail-header">
                    <div class="vendor-detail-image">
                        <!-- Image or placeholder will be rendered here -->
                    </div>
                    <div class="vendor-detail-info">
                        <h2 id="modal-vendor-name-full" class="vendor-detail-name">Vendor Name</h2>
                        <div class="vendor-detail-location">üìç <span id="modal-vendor-location">Location</span></div>
                        <div class="vendor-detail-ratings">
                            <div class="review-rating" id="modal-vendor-rating">
                                ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê <span>(0.0) | 0 Reviews</span>
                            </div>
                        </div>
                        <div class="vendor-detail-features">
                            <div class="feature">
                                <span class="feature-icon" id="modal-vendor-category-icon"></span>
                                <span id="modal-vendor-category-name"></span>
                            </div>
                            <div class="feature">
                                <span class="feature-icon">üéâ</span>
                                <span id="modal-vendor-services-offered">Services</span>
                            </div>
                        </div>
                        <p class="vendor-detail-price" id="modal-vendor-price"></p>
                    </div>
                </div>

                <!-- About Us -->
                <h3 class="services-title">About Us</h3>
                <p id="modal-vendor-description" class="vendor-detail-description">
                    Vendor description will appear here...
                </p>

                <!-- Services -->
                <div id="services-section" class="services-section">
                    <h3 class="services-title">Available Services</h3>
                    <!-- Services will be rendered here -->
                </div>

                <!-- Booking Form -->
                <div class="booking-flow">
                    <h3 class="services-title">Book This Vendor</h3>
                    <div class="form-group">
                        <label for="booking-date-picker" class="form-label">Select a Date and Time</label>
                        <input type="text" id="booking-date-picker" class="form-control" placeholder="Choose a date and time">
                    </div>
                    <button class="btn btn-primary" id="open-booking-modal-btn">
                        Book Now
                    </button>
                    <button class="btn btn-outline" id="open-chat-btn">
                        Message Vendor
                    </button>
                </div>

                <!-- Booking Calendar Section (Moved inside modal-body) -->
                <div class="booking-calendar-section">
                    <h3 class="calendar-title">Select Date & Time</h3>
                    <div id="booking-calendar"></div>
                    <div class="time-slots" id="time-slots"></div>
                </div>
                
                <!-- Reviews Section -->
                <div class="reviews-section">
                    <h3 class="reviews-title">Customer Reviews</h3>
                    <div id="modal-reviews-list">
                        <!-- Reviews will be rendered here -->
                    </div>
                    
                    ${currentUser ? `
                        <button class="btn btn-outline add-review-btn" id="show-review-form">Add Review</button>
                        <div class="review-form" id="review-form" style="display: none;">
                            <div class="rating-input">
                                <span class="rating-star" data-rating="1">‚òÜ</span>
                                <span class="rating-star" data-rating="2">‚òÜ</span>
                                <span class="rating-star" data-rating="3">‚òÜ</span>
                                <span class="rating-star" data-rating="4">‚òÜ</span>
                                <span class="rating-star" data-rating="5">‚òÜ</span>
                            </div>
                            <textarea class="review-textarea" id="review-text" placeholder="Share your experience..."></textarea>
                            <button class="btn btn-primary" id="submit-review">Submit Review</button>
                        </div>
                    ` : '<p><a href="#" id="login-to-review" style="color: var(--primary);">Log in</a> to leave a review</p>'}
                </div>
                
                <!-- Chat Section -->
                <div class="chat-section">
                    <h3 class="chat-title">Message Vendor</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will load here -->
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." id="chat-input">
                            <button class="btn btn-primary" id="send-btn">Send</button>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Section -->
                <div class="payment-section" id="payment-section" style="display: none;">
                    <h3 class="payment-title">Payment Information</h3>
                    <div class="payment-form">
                        <div class="form-group">
                            <label>Cardholder Name</label>
                            <input type="text" id="cardholder-name">
                        </div>
                        <div class="card-element" id="card-element"></div>
                        <button class="btn btn-primary" id="pay-now-btn">Pay Now</button>
                    </div>
                </div>
                
                <div class="vendor-actions" style="margin-top: 2rem; justify-content: center;">
                    <button class="btn btn-primary" id="book-now-btn">Book Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Confirmation -->
    <div id="confirmation-modal" class="booking-confirmation" style="display: none;">
        <div class="confirmation-content">
            <h3>üéâ Booking Confirmed!</h3>
            <p><strong>Vendor:</strong> <span id="conf-venue-name"></span></p>
            <p><strong>Services:</strong> <span id="conf-services"></span></p>
            <p><strong>Date:</strong> <span id="conf-date"></span></p>
            <p><strong>Time:</strong> <span id="conf-time"></span></p>
            <p><strong>Confirmation #:</strong> <span id="conf-id"></span></p>
            <p>A confirmation email has been sent to your registered email address.</p>
            <button class="btn btn-primary" id="conf-done-btn">Done</button>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="location-permission" class="location-permission" style="display: none;">
        <div class="location-content">
            <h3>Find Vendors Near You</h3>
            <p>VenueVue would like to access your location to show vendors near you.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button class="btn btn-outline" id="deny-location">Not Now</button>
                <button class="btn btn-primary" id="allow-location">
                    Allow
                    <span id="location-loading" class="location-loading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="profile-modal-title">Welcome to VenueVue</h3>
                <span class="close-modal" id="close-profile-modal">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Login Form (shown by default) -->
                <div id="login-form">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="login-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" id="login-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <button class="btn btn-primary" id="login-btn" style="width: 100%; margin-bottom: 1rem;">Log In</button>
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <a href="#" id="show-signup" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">Don't have an account? Sign up</a>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                        <div style="flex: 1; height: 1px; background-color: var(--border);"></div>
                        <div style="padding: 0 1rem; color: var(--text-light); font-size: 0.9rem;">OR</div>
                        <div style="flex: 1; height: 1px; background-color: var(--border);"></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-outline" id="google-login" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" width="20" height="20">
                            <span>Continue with Google</span>
                        </button>
                        <button class="btn btn-outline" id="facebook-login" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" width="20" height="20">
                            <span>Continue with Facebook</span>
                        </button>
                    </div>
                </div>

                <!-- Signup Form (hidden by default) -->
                <div id="signup-form" style="display: none;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name</label>
                        <input type="text" id="signup-name" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="signup-email" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" id="signup-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Account Type</label>
                        <select id="account-type" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius);">
                            <option value="client">Client (I want to book vendors)</option>
                            <option value="vendor">Vendor (I provide services)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="signup-btn" style="width: 100%; margin-bottom: 1rem;">Create Account</button>
                    <div style="text-align: center;">
                        <a href="#" id="show-login" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">Already have an account? Log in</a>
                    </div>
                </div>

                <!-- Logged In View (hidden by default) -->
                <div id="logged-in-view" style="display: none; text-align: center;">
                    <div class="profile-avatar" id="profile-avatar">
                        U
                    </div>
                    <h3 style="margin-bottom: 0.5rem;" id="profile-name">User Name</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;" id="profile-email">user@example.com</p>
                    <button class="btn btn-primary" id="view-dashboard-btn" style="width: 100%; margin-bottom: 1rem;">View Dashboard</button>
                    <button class="btn btn-outline" id="logout-btn" style="width: 100%;">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&libraries=places&v=weekly" defer></script>

    <!-- Facebook SDK -->
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId: 'YOUR_FACEBOOK_APP_ID',  // Replace with your actual Facebook App ID
          cookie: true,
          xfbml: true,
          version: 'v18.0'
        });
      };
    </script>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>

    <!-- Main Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API base URL
            const API_BASE_URL = 'https://bdb-3-0-venuevue-api.onrender.com/api';
            
            // Initialize variables
            const modal = document.getElementById('vendor-modal');
            const modalBody = document.querySelector('#vendor-modal .modal-body');
            const confirmationModal = document.getElementById('confirmation-modal');
            const locationPermissionModal = document.getElementById('location-permission');
            const vendorGrid = document.getElementById('vendor-grid');
            const mapVenueList = document.getElementById('map-venue-list');
            const resultsTitle = document.querySelector('.results-title');
            const resultsCount = document.querySelector('.results-count');
            const mapViewContainer = document.getElementById('map-view-container');
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const wishlistBtn = document.getElementById('wishlist-btn');
            const notificationsBtn = document.getElementById('notifications-btn');
            const profileBtn = document.getElementById('profile-btn');
            const filterResetBtns = document.querySelectorAll('.filter-reset');
            const trendingTags = document.querySelectorAll('.trending-tag');
            const pagination = document.getElementById('pagination');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const locateMeBtn = document.getElementById('locate-me');
            const allowLocationBtn = document.getElementById('allow-location');
            const denyLocationBtn = document.getElementById('deny-location');
            const currentLocationCheckbox = document.getElementById('current-location');
            const locationLoading = document.getElementById('location-loading');
            const locationInput = document.getElementById('location-input');
            const categoryItems = document.querySelectorAll('.category-item');
            const advancedToggle = document.getElementById('advanced-toggle');
            const advancedContent = document.getElementById('advanced-content');
            const categoriesListInner = document.getElementById('categories-list'); // Renamed for clarity
            const categoriesListWrapper = document.querySelector('.categories-list-wrapper'); // The scrollable container
            const scrollLeftBtn = document.getElementById('scroll-left'); // New button
            const scrollRightBtn = document.getElementById('scroll-right'); // New button
            
            // Profile modal elements
            const profileModal = document.getElementById('profile-modal');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const loggedInView = document.getElementById('logged-in-view');
            const showSignup = document.getElementById('show-signup');
            const showLogin = document.getElementById('show-login');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const googleLoginBtn = document.getElementById('google-login');
            const facebookLoginBtn = document.getElementById('facebook-login');
            const viewDashboardBtn = document.getElementById('view-dashboard-btn');
            const accountTypeSelect = document.getElementById('account-type');
            
            // Dashboard elements
            const appContainer = document.getElementById('app-container');
            const clientDashboardContainer = document.getElementById('dashboard-container'); // Renamed for clarity
            const vendorDashboardContainer = document.getElementById('vendor-dashboard-container');
            const clientDashboardMenuItems = clientDashboardContainer.querySelectorAll('.dashboard-menu a'); // Specific to client dashboard
            const vendorDashboardMenuItems = vendorDashboardContainer.querySelectorAll('.dashboard-menu a'); // Specific to vendor dashboard
            const switchToVendorBtn = document.getElementById('switch-to-vendor');
            const switchToClientBtn = document.getElementById('switch-to-client');
            const logoutDashboardBtn = document.getElementById('logout-dashboard');
            const vendorLogoutBtn = document.getElementById('vendor-logout');
            
            // Vendor registration elements
            const vendorRegistrationModal = document.getElementById('vendor-registration-modal');
            const vendorRegistrationForm = document.getElementById('vendor-registration-form');
            const addServiceFieldBtn = document.getElementById('add-service-field');
            const serviceFieldsContainer = document.getElementById('service-fields-container');
            
            // Chat state manager
            const chatState = {
                messages: [],
                currentConversation: null,
                
                init: function() {
                    this.messages = [];
                    this.currentConversation = null;
                    console.log('Chat state initialized.');
                },
                
                addMessage: function(message) {
                    if (!this.messages) this.messages = [];
                    const formattedMsg = this.formatMessage(message);
                    this.messages.push(formattedMsg);
                    console.log('Message added to chat state:', formattedMsg);
                    return formattedMsg;
                },
                
                setMessages: function(messages) {
                    this.messages = Array.isArray(messages) ? messages.map(msg => this.formatMessage(msg)) : [];
                    console.log('Chat messages set:', this.messages);
                },
                
                getMessages: function() {
                    return this.messages || [];
                },
                
                formatMessage: function(message) {
                    console.log('Formatting message:', message);
                    const content = message.Content || message.content || message.text || message.messageContent;
                    if (content === undefined) {
                        console.warn('Message content is undefined after formatting attempts for message:', message);
                    }
                    return {
                        id: message.MessageID || message.id || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        conversationId: message.ConversationID || message.conversationId || this.currentConversation,
                        senderId: message.SenderID || message.senderId,
                        senderName: message.SenderName || message.senderName || (message.SenderID === currentUser?.id ? currentUser.name : 'Vendor'),
                        content: content,
                        timestamp: message.CreatedAt || message.timestamp || new Date().toISOString(),
                        isCurrentUser: message.SenderID === currentUser?.id || message.isCurrentUser,
                        isRead: message.IsRead || message.isRead || false
                    };
                }
            };
            

            // App state
            let state = {
                vendors: [],
                filteredVendors: [],
                favorites: [],
                currentPage: 1,
                itemsPerPage: 6,
                map: null,
                markers: [],
                currentView: 'list',
                userLocation: null,
                currentCategory: 'all',
                filters: {
                    location: '',
                    types: ['independent', 'company'],
                    price: 40,
                    popular: [],
                    startDate: null,
                    endDate: null,
                    region: ''
                },
                currentVendor: null,
                selectedServices: [],
                selectedDate: null,
                selectedTime: null,
                stripe: null,
                elements: null,
                paymentIntent: null,
                socket: null,
                chat: chatState // Use the chatState object
            };
            
            // User state
            let currentUser = null;

            // State variables for dashboard mode and active section, persisted in localStorage
            let isVendorMode = localStorage.getItem('isVendorMode') === 'true';
            let activeDashboardSection = localStorage.getItem('activeDashboardSection') || 'dashboard'; // Default client dashboard
            
            // Initialize the app
            init();
            
            async function init() {
                // Load categories first
                await loadCategories();
                
                // Check for existing user session
                await checkAuthStatus();
                
                // Show loading state
                vendorGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;">Loading vendors...</div>';
                
                try {
                    // Load vendors data from API
                    await loadVendors();
                    
                    // Initialize Stripe
                    initializeStripe();
                    
                    // Connect to Socket.IO
                    connectToChat();
                    
                    // Request location after everything is loaded
                    requestLocationWithFeedback();
                    
                    // Setup event listeners
                    setupEventListeners();

                    // Always show the main app container on initial load
                    appContainer.style.display = 'grid';
                    clientDashboardContainer.style.display = 'none';
                    vendorDashboardContainer.style.display = 'none';
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    showError("Failed to load vendors. Please try again later.");
                }
            }
            
            // Load categories from API
            async function loadCategories() {
                try {
                    // In a real app, you would fetch categories from your API
                    // For now, we'll use a predefined list that matches the backend
                    state.categories = [
                        { id: 'all', name: 'All Categories' },
                        { id: 'venue', name: 'Venues' },
                        { id: 'photo', name: 'Photo/Video' },
                        { id: 'music', name: 'Music/DJ' },
                        { id: 'catering', name: 'Catering' },
                        { id: 'entertainment', name: 'Entertainment' },
                        { id: 'experiences', name: 'Experiences' },
                        { id: 'decor', name: 'Decorations' },
                        { id: 'beauty', name: 'Beauty' },
                        { id: 'cake', name: 'Cake' },
                        { id: 'transport', name: 'Transportation' },
                        { id: 'planner', name: 'Planners' },
                        { id: 'fashion', name: 'Fashion' },
                        { id: 'stationery', name: 'Stationery' }
                    ];
                    
                    // Render categories
                    renderCategories();
                    
                } catch (error) {
                    console.error('Error loading categories:', error);
                }
            }
            
            // Render categories in the navigation
            function renderCategories() {
                categoriesListInner.innerHTML = '';
                
                state.categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    if (category.id === 'all') categoryItem.classList.add('active');
                    categoryItem.dataset.category = category.id;
                    // Add icon to the category item
                    categoryItem.innerHTML = `${getCategoryIcon(category.id)} ${category.name}`;
                    
                    categoryItem.addEventListener('click', () => {
                        // Update active category
                        document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
                        categoryItem.classList.add('active');
                        
                        // Set current category
                        state.currentCategory = category.id;
                        
                        // Filter vendors
                        filterVendors();
                    });
                    
                    categoriesListInner.appendChild(categoryItem);
                });
            }
            
            // In the loadVendors() function, update the data processing:
            async function loadVendors() {
                try {
                    const response = await fetch(`${API_BASE_URL}/vendors`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    if (data && data.vendors && data.vendors.length > 0) {
                        // Process vendor data from API
                        state.vendors = data.vendors.map(vendor => {
                            // Parse services if they come as JSON string (if needed)
                            let services = vendor.services || [];
                            
                            // Map type to category
                            const category = mapTypeToCategory(vendor.type);
                            
                            return {
                                ...vendor,
                                services: services,
                                category: category,
                                coordinates: {
                                    lat: vendor.latitude || getRandomLat(),
                                    lng: vendor.longitude || getRandomLng()
                                },
                                priceLevel: vendor.priceLevel || getRandomPriceLevel(),
                                isPremium: vendor.isPremium || false,
                                isEcoFriendly: vendor.isEcoFriendly || false,
                                isAwardWinning: vendor.isAwardWinning || false,
                                reviews: vendor.reviews || [],
                                rating: parseFloat(vendor.rating) ? `${parseFloat(vendor.rating).toFixed(1)}` : '4.5',
                                reviewCount: vendor.reviewCount || 0
                            };
                        });
                        
                        state.filteredVendors = [...state.vendors];
                        
                        // Update UI
                        updateMetadata({ total: data.totalCount || state.filteredVendors.length });
                        renderVendors();
                        
                    } else {
                        showError("No vendor data found");
                    }
                } catch (error) {
                    console.error('Error loading vendors:', error);
                    throw error;
                }
            }
            
            // Helper function to generate sample reviews
            function generateSampleReviews() {
                const reviews = [];
                const reviewTexts = [
                    "Great service! Would definitely book again.",
                    "Very professional and easy to work with.",
                    "The venue was perfect for our event.",
                    "Everything went smoothly, highly recommend!",
                    "Good quality but communication could be better.",
                    "Delivered exactly what was promised."
                ];
                
                const names = ["John D.", "Sarah M.", "Michael T.", "Emily R.", "David K.", "Jessica L."];
                
                for (let i = 0; i < 5; i++) {
                    reviews.push({
                        id: `review-${i}`,
                        user: names[i],
                        rating: Math.floor(Math.random() * 2) + 4, // 4 or 5
                        comment: reviewTexts[i],
                        date: new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000).toISOString()
                    });
                }
                
                return reviews;
            }
            
            // Helper function to map vendor types to categories
            function mapTypeToCategory(type) {
                const typeMap = {
                    "Photography": "photo",
                    "Photo": "photo",
                    "Videography": "photo",
                    "Entertainment": "entertainment",
                    "Music": "music",
                    "DJ": "music",
                    "Decor": "decor",
                    "Florist": "decor",
                    "Catering": "catering",
                    "Food": "catering",
                    "Venue": "venue",
                    "Hotel": "venue",
                    "Transportation": "transport",
                };
                return typeMap[type] || type.toLowerCase();
            }

            // Check for existing user session
            async function checkAuthStatus() {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/users/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        simulateLogin({
                            id: userData.userId, // Ensure userId is captured
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });
                        
                        // Load user favorites
                        await loadUserFavorites();
                        
                        // Load notifications
                        await loadNotifications();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    localStorage.removeItem('token');
                }
            }
            
            // Load user favorites
            async function loadUserFavorites() {
                if (!currentUser) return;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const favorites = await response.json();
                        state.favorites = favorites.map(fav => fav.vendorProfileID); // Corrected to vendorProfileID
                        
                        // Update favorites badge
                        document.querySelectorAll('.badge').forEach(badge => {
                            if (badge.id === 'favorites-badge' || !badge.id) {
                                badge.textContent = state.favorites.length;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading favorites:', error);
                }
            }
            
            // Load notifications
            async function loadNotifications() {
                if (!currentUser) return;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/notifications/user/${currentUser.id}?unreadOnly=true`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const notifications = await response.json();
                        const unreadCount = notifications.length;
                        
                        // Update notifications badge
                        document.querySelectorAll('.badge').forEach(badge => {
                            if (badge.id === 'notifications-badge' || badge.id === 'dashboard-notifications-badge' || badge.id === 'vendor-notifications-badge' || !badge.id) {
                                badge.textContent = unreadCount;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }
            
            // Initialize Stripe
            function initializeStripe() {
                state.stripe = Stripe('pk_test_YOUR_STRIPE_PUBLIC_KEY'); // Replace with your Stripe public key
                state.elements = state.stripe.elements();
            }
            
            // Connect to Socket.IO for chat
            function connectToChat() {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No token available for chat connection. Chat features may be limited.');
                    return;
                }

                if (state.socket && state.socket.connected) {
                    console.log('Socket already connected.');
                    return;
                }

                console.log('Attempting to connect to chat server...');
                state.socket = io(API_BASE_URL, {
                    auth: { token },
                    transports: ['websocket'],
                    reconnectionAttempts: 5
                });
                
                state.socket.on('connect', () => {
                    console.log('Connected to chat server.');
                    if (currentUser) {
                        state.socket.emit('authenticate', { userId: currentUser.id });
                    }
                });
                
                state.socket.on('new-message', (message) => {
                    console.log('Received new message via Socket.IO:', message);
                    
                    if (!message || !message.ConversationID) {
                        console.error('Invalid message format received:', message);
                        return;
                    }
                    
                    // Only process if it's for the current conversation
                    if (message.ConversationID === state.chat.currentConversation) {
                        const formattedMessage = state.chat.formatMessage(message);
                        state.chat.addMessage(formattedMessage);
                        renderChatMessages();
                    } else {
                        console.log(`Received message for conversation ${message.ConversationID}, but current is ${state.chat.currentConversation}. Not rendering.`);
                    }
                });
                
                state.socket.on('error', (error) => {
                    console.error('Socket error:', error);
                    showChatError('Connection error. Please refresh the page.');
                });
                
                state.socket.on('disconnect', () => {
                    console.log('Disconnected from chat server.');
                    showChatError('Disconnected. Trying to reconnect...');
                });
            }

            async function loadInitialMessages() {
                if (!currentUser || !state.chat.currentConversation) {
                    console.warn('Cannot load messages: Missing user or conversation ID.', {
                        user: currentUser,
                        conversation: state.chat.currentConversation
                    });
                    return;
                }
                
                try {
                    console.log(`Loading messages for conversation: ${state.chat.currentConversation} and user: ${currentUser.id}`);
                    const response = await fetch(`${API_BASE_URL}/messages/conversation/${state.chat.currentConversation}?userId=${currentUser.id}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to load messages: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    
                    // The API returns messages directly, not wrapped in a 'success' or 'messages' property
                    if (!Array.isArray(data)) { // Changed from data.success || !Array.isArray(data.messages)
                        throw new Error('Invalid message data format from API');
                    }
                    
                    state.chat.setMessages(data); // Set data directly
                    renderChatMessages();
                } catch (error) {
                    console.error('Error loading messages:', error);
                    state.chat.setMessages([]); // Clear messages on error
                    renderChatMessages();
                    showChatError('Failed to load messages. Please try again.');
                }
            }

            // Function to attach chat event listeners to a specific chat UI
            function setupChatEventListeners(chatInputId, sendButtonId) {
                const chatInput = document.getElementById(chatInputId);
                const sendButton = document.getElementById(sendButtonId);

                if (chatInput && sendButton) {
                    // Remove existing listeners to prevent duplicates
                    sendButton.removeEventListener('click', sendChatMessage);
                    chatInput.removeEventListener('keypress', handleChatInputKeypress);

                    // Add new listeners
                    sendButton.addEventListener('click', sendChatMessage);
                    chatInput.addEventListener('keypress', handleChatInputKeypress);
                    console.log(`Chat event listeners attached for input: ${chatInputId}, button: ${sendButtonId}`);
                } else {
                    console.warn(`Could not find chat elements: Input ID ${chatInputId}, Button ID ${sendButtonId}`);
                }
            }

            function handleChatInputKeypress(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            }

            async function sendChatMessage() {
                const input = document.getElementById('chat-input') || 
                            document.getElementById('dashboard-chat-input') || 
                            document.getElementById('vendor-chat-input') ||
                            document.getElementById('vendor-all-chat-input'); // Added for vendor-all-chat-input
                const message = input?.value.trim();
                
                console.log('Attempting to send message:', message, 'Current User:', currentUser, 'Current Conversation:', state.chat.currentConversation);

                if (!message) {
                    console.warn('Message is empty.');
                    return;
                }
                
                if (!currentUser) {
                    alert('Please login to send messages.');
                    profileModal.style.display = 'flex';
                    showLoginView();
                    return;
                }

                if (!state.chat.currentConversation) {
                    alert('No conversation selected or initialized.');
                    console.error('Cannot send message: No current conversation.');
                    return;
                }

                try {
                    // Create temporary message for optimistic UI
                    const tempMessage = {
                        id: `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        conversationId: state.chat.currentConversation,
                        senderId: currentUser.id,
                        senderName: currentUser.name,
                        content: message,
                        timestamp: new Date().toISOString(),
                        isCurrentUser: true,
                        isPending: true
                    };

                    // Add to UI immediately
                    state.chat.addMessage(tempMessage);
                    input.value = '';
                    renderChatMessages();

                    // Send to server via Socket.IO if available
                    if (state.socket && state.socket.connected) {
                        console.log('Sending message via Socket.IO...');
                        state.socket.emit('send-message', {
                            conversationId: state.chat.currentConversation,
                            senderId: currentUser.id, // Include senderId for socket
                            content: message
                        });
                    } else {
                        console.log('Socket not connected, falling back to HTTP POST...');
                        // Fallback to HTTP POST
                        const response = await fetch(`${API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                conversationId: state.chat.currentConversation,
                                senderId: currentUser.id,
                                content: message
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to send message via HTTP.');
                        }

                        const result = await response.json();
                        console.log('HTTP POST message response:', result); // Add this for debugging
                        
                        // The API returns the message object directly on success
                        const savedMessage = state.chat.formatMessage(result); // Use result directly
                        
                        // Replace temp message with saved message
                        state.chat.setMessages(
                            state.chat.getMessages()
                                .filter(m => m.id !== tempMessage.id)
                                .concat([savedMessage])
                        );
                    }
                    
                    renderChatMessages(); // Re-render to ensure order and remove pending status if applicable

                } catch (err) {
                    console.error('Message send failed:', err);
                    // Remove temp message and show error
                    state.chat.setMessages(
                        state.chat.getMessages().filter(m => m.id !== tempMessage.id)
                    );
                    renderChatMessages();
                    showChatError('Failed to send message: ' + err.message);
                }
            }

            function renderChatMessages() {
                const chatContainer = document.getElementById('chat-messages') || 
                                    document.getElementById('dashboard-chat-messages') || 
                                    document.getElementById('vendor-chat-messages') ||
                                    document.getElementById('vendor-all-chat-messages'); // Added for vendor-all-chat-messages
                
                if (!chatContainer) {
                    console.warn('Chat container not found for rendering messages.');
                    return;
                }
                
                // Clear existing messages
                chatContainer.innerHTML = '';
                
                // Sort messages by timestamp (oldest first)
                const sortedMessages = [...state.chat.getMessages()].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp));
                
                // Render each message
                sortedMessages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === currentUser?.id ? 'sent' : 'received'}`; // Use senderId for isCurrentUser
                    
                    const messageDate = new Date(message.timestamp);
                    const timeString = messageDate.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    // Add sender name if not current user
                    const senderInfo = (message.senderId !== currentUser?.id && message.senderName) ? 
                        `<div class="message-sender">${message.senderName}</div>` : '';
                    
                    messageDiv.innerHTML = `
                        ${senderInfo}
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${timeString}</div>
                    `;
                    
                    chatContainer.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Add this function to load conversations for the dashboard
            async function loadConversations(containerId, chatInputId, sendButtonId) {
                if (!currentUser) {
                    console.warn('Cannot load conversations: User not logged in.');
                    return;
                }
                
                try {
                    console.log(`Loading conversations for user: ${currentUser.id}`);
                    const url = currentUser.isVendor ? `${API_BASE_URL}/messages/conversations/vendor/${currentUser.id}` : `${API_BASE_URL}/messages/conversations/user/${currentUser.id}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to load conversations: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                    
                    const conversations = await response.json();
                    
                    // Validate conversations is an array
                    if (!Array.isArray(conversations)) {
                        throw new Error('Invalid conversations data format from API');
                    }
                    
                    renderConversationsList(conversations, containerId, chatInputId, sendButtonId);
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `<p style="color:var(--accent);">Failed to load conversations. ${error.message}</p>`;
                    }
                }
            }

            function renderConversationsList(conversations, containerId, chatInputId, sendButtonId) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn('Conversations container not found:', containerId);
                    return;
                }
                
                // Clear existing content and rebuild the chat area within the section
                container.innerHTML = `
                    <div class="dashboard-card">
                        <h2 class="dashboard-card-title">Messages</h2>
                        <div class="conversations-list" style="max-height: 200px; overflow-y: auto; border-bottom: 1px solid var(--border); margin-bottom: 1rem; padding-bottom: 1rem;">
                            ${conversations.length === 0 ? '<p>No active conversations.</p>' :
                                conversations.map(conv => {
                                    const partnerName = conv.VendorName || conv.UserName || 'Unknown Partner';
                                    const lastMessagePreview = conv.LastMessagePreview ? conv.LastMessagePreview.substring(0, 50) + (conv.LastMessagePreview.length > 50 ? '...' : '') : 'No messages yet.';
                                    const lastMessageTime = conv.LastMessageAt ? new Date(conv.LastMessageAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                                    return `
                                        <div class="conversation-item" data-id="${conv.ConversationID}" 
                                             style="padding: 0.75rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 600;">${partnerName}</div>
                                                <div style="font-size: 0.9rem; color: var(--text-light);">${lastMessagePreview}</div>
                                            </div>
                                            <div style="font-size: 0.8rem; color: var(--text-light);">${lastMessageTime}</div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                        <div class="chat-container" style="height: 300px;">
                            <div class="chat-messages" id="${chatInputId.replace('-input', '-messages')}"></div>
                            <div class="chat-input">
                                <input type="text" placeholder="Type your message..." id="${chatInputId}">
                                <button class="btn btn-primary" id="${sendButtonId}">Send</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners to conversations
                document.querySelectorAll('.conversation-item').forEach(convItem => {
                    convItem.addEventListener('click', () => {
                        const conversationId = parseInt(convItem.dataset.id);
                        state.chat.currentConversation = conversationId;
                        console.log('Selected conversation:', conversationId);
                        loadInitialMessages();
                    });
                });

                // Attach chat event listeners for the newly rendered chat input/button
                setupChatEventListeners(chatInputId, sendButtonId);

                // If there are conversations, select the first one by default
                if (conversations.length > 0 && !state.chat.currentConversation) {
                    state.chat.currentConversation = conversations[0].ConversationID;
                    console.log('Defaulting to first conversation:', state.chat.currentConversation);
                    loadInitialMessages();
                } else if (state.chat.currentConversation) {
                    // If a conversation is already selected (e.g., from modal), load its messages
                    loadInitialMessages();
                }
            }
            
            function disableChatInput() {
                const chatInput = document.getElementById('chat-input');
                const sendBtn = document.getElementById('send-btn');
                if (chatInput) chatInput.disabled = true;
                if (sendBtn) sendBtn.disabled = true;
                console.log('Chat input and send button disabled.');
            }

            function showChatError(message) {
                const chatMessagesContainer = document.getElementById('chat-messages') || 
                                              document.getElementById('dashboard-chat-messages') || 
                                              document.getElementById('vendor-chat-messages') ||
                                              document.getElementById('vendor-all-chat-messages');
                if (chatMessagesContainer) {
                    const errorElement = document.createElement('p');
                    errorElement.style.color = 'var(--accent)';
                    errorElement.style.fontSize = '0.8rem';
                    errorElement.textContent = message;
                    chatMessagesContainer.appendChild(errorElement);
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                console.error('Chat error displayed:', message);
            }
            
            // New improved location request function
            function requestLocationWithFeedback() {
                console.log("Attempting to get location...");
                if (!navigator.geolocation) {
                    console.log("Geolocation not supported by this browser");
                    return;
                }

                // Visual feedback
                locationInput.placeholder = "Detecting your location...";
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Location obtained:", position);
                        handleLocationSuccess(position);
                    },
                    (error) => {
                        console.log("Location error:", error);
                        locationInput.placeholder = "City or ZIP code";
                        
                        if (error.code === error.PERMISSION_DENIED) {
                            // Only show modal if this is a fresh page load
                            if (!sessionStorage.getItem('locationRequested')) {
                                locationPermissionModal.style.display = 'flex';
                                sessionStorage.setItem('locationRequested', 'true');
                            }
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
            
            // Modified location success handler
            function handleLocationSuccess(position) {
                state.userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Update UI
                currentLocationCheckbox.checked = true;
                document.getElementById('within50').checked = true;
                locationInput.value = "Near You";
                locationInput.placeholder = "Near You";
                
                filterVendors();
                
                if (state.map) {
                    centerMapOnUser();
                }
            }
            
            // Google Maps initialization
            function initMap() {
                if (state.filteredVendors.length === 0) return;
                
                // Default to first vendor's location or user location if available
                const center = state.userLocation || 
                               { lat: state.filteredVendors[0].coordinates.lat, 
                                 lng: state.filteredVendors[0].coordinates.lng };
                
                // Create map
                state.map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: center,
                    styles: [
                        {
                            "featureType": "poi",
                            "stylers": [
                                { "visibility": "off" }
                            ]
                        }
                    ]
                });
                
                // Add markers
                updateMapMarkers();
                
                // Center map on user location if available
                if (state.userLocation) {
                    centerMapOnUser();
                }
            }
            
            // Helper function to generate random coordinates (for demo)
            function getRandomLat() { return 34.0522 + (Math.random() * 0.2 - 0.1); }
            function getRandomLng() { return -118.2437 + (Math.random() * 0.2 - 0.1); }
            
            // Helper function to generate random price level (for demo)
            function getRandomPriceLevel() {
                const levels = ['$', '$$', '$$$'];
                return levels[Math.floor(Math.random() * levels.length)];
            }
            
            // Setup all event listeners
            function setupEventListeners() {
                // Search
                searchInput.addEventListener('input', filterVendors);
                
                // Sorting
                sortSelect.addEventListener('change', sortVendors);
                
                // Filter resets
                filterResetBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const filterType = btn.id.replace('-reset', '');
                        resetFilter(filterType);
                    });
                });
                
                // Filter inputs
                document.querySelectorAll('.filter-section input').forEach(input => {
                    input.addEventListener('change', filterVendors);
                });
                
                // Current location checkbox
                currentLocationCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        requestLocationWithFeedback();
                    } else {
                        state.userLocation = null;
                        locationInput.value = '';
                        locationInput.placeholder = 'City or ZIP code';
                        filterVendors();
                    }
                });
                
                // Popular filters
                trendingTags.forEach(tag => {
                    tag.addEventListener('click', () => {
                        tag.classList.toggle('active');
                        const filter = tag.dataset.filter;
                        
                        if (tag.classList.contains('active')) {
                            if (!state.filters.popular.includes(filter)) {
                                state.filters.popular.push(filter);
                            }
                        } else {
                            state.filters.popular = state.filters.popular.filter(f => f !== filter);
                        }
                        
                        filterVendors();
                    });
                });
                
                // Advanced filters toggle
                advancedToggle.addEventListener('click', () => {
                    advancedContent.classList.toggle('show');
                    advancedToggle.querySelector('span').textContent = 
                        advancedContent.classList.contains('show') ? '‚àí' : '+';
                });
                
                // Date filters
                document.getElementById('start-date').addEventListener('change', function() {
                    state.filters.startDate = this.value;
                    filterVendors();
                });
                
                document.getElementById('end-date').addEventListener('change', function() {
                    state.filters.endDate = this.value;
                    filterVendors();
                });
                
                // Region filter
                document.getElementById('region-select').addEventListener('change', function() {
                    state.filters.region = this.value;
                    filterVendors();
                });
                
                // Pagination
                prevPageBtn.addEventListener('click', () => {
                    if (state.currentPage > 1) {
                        state.currentPage--;
                        renderVendors();
                    }
                });
                
                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredVendors.length / state.itemsPerPage);
                    if (state.currentPage < totalPages) {
                        state.currentPage++;
                        renderVendors();
                    }
                });
                
                // User nav buttons
                wishlistBtn.addEventListener('click', () => {
                    if (currentUser) {
                        displayUserDashboard('client', 'favorites'); // Use new function
                    } else {
                        profileModal.style.display = 'flex';
                    }
                });
                
                notificationsBtn.addEventListener('click', () => {
                    if (currentUser) {
                        displayUserDashboard('client', 'dashboard'); // Notifications are part of dashboard summary
                    } else {
                        profileModal.style.display = 'flex';
                    }
                });
                
                // Profile button click handler
                profileBtn.addEventListener('click', () => {
                    if (currentUser) {
                        showLoggedInView();
                    } else {
                        showLoginView();
                    }
                    profileModal.style.display = 'flex';
                });
                
                // Generic close modal buttons (for all modals)
                document.querySelectorAll('.close-modal').forEach(closeBtn => {
                    closeBtn.addEventListener('click', function() {
                        this.closest('.modal').style.display = 'none';
                        document.body.style.overflow = 'auto'; // Re-enable scrolling
                        // If it's the vendor-modal, also reset its state
                        if (this.closest('.modal').id === 'vendor-modal') {
                            resetBookingModalState();
                        }
                    });
                });

                // Generic close modals when clicking outside the content (for all modals)
                document.querySelectorAll('.modal').forEach(m => {
                    // Remove existing listener to prevent duplicates if setupEventListeners is called multiple times
                    const oldListener = m.__overlayClickListener;
                    if (oldListener) {
                        m.removeEventListener('click', oldListener);
                    }

                    const newListener = (e) => {
                        if (e.target === m) {
                            m.style.display = 'none';
                            document.body.style.overflow = 'auto';
                            // If it's the vendor-modal, also reset its state
                            if (m.id === 'vendor-modal') {
                                resetBookingModalState();
                            }
                        }
                    };
                    m.addEventListener('click', newListener);
                    m.__overlayClickListener = newListener; // Store listener for removal
                });
                
                // Toggle between login and signup forms
                showSignup.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSignupView();
                });
                
                showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showLoginView();
                });
                
                // Login with email/password
                loginBtn.addEventListener('click', async () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email, password }),
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Login failed');
                        }
                        
                        const userData = await response.json();
                        
                        // Store the token in localStorage
                        localStorage.setItem('token', userData.token);
                        
                        // Update UI with user data
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name || userData.email.split('@')[0],
                            email: userData.email,
                            avatar: userData.name ? userData.name[0].toUpperCase() : userData.email[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });
                        
                        // Connect to chat after login
                        connectToChat();
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Login failed. ' + error.message);
                    }
                });
                
                // Sign up with email/password
                signupBtn.addEventListener('click', async () => {
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const accountType = document.getElementById('account-type').value;
                    
                    if (!name || !email || !password) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    if (password.length < 8) {
                        alert('Password should be at least 8 characters');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/users/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                name, 
                                email, 
                                password,
                                isVendor: accountType === 'vendor'
                            }),
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Signup failed');
                        }
                        
                        const userData = await response.json();
                        
                        // Store the token
                        localStorage.setItem('token', userData.token);
                        
                        // Update UI with user data
                        simulateLogin({
                            id: userData.userId,
                            name: userData.name,
                            email: userData.email,
                            avatar: userData.name[0].toUpperCase(),
                            isVendor: userData.isVendor || false
                        });
                        
                        // Connect to chat after signup
                        connectToChat();
                        
                        // If signing up as vendor, show registration form
                        if (accountType === 'vendor') {
                            profileModal.style.display = 'none';
                            vendorRegistrationModal.style.display = 'flex';
                        }
                    } catch (error) {
                        console.error('Signup error:', error);
                        alert('Signup failed. ' + error.message);
                    }
                });
                
                // Google Login Handler
                googleLoginBtn.addEventListener('click', () => {
                    google.accounts.id.initialize({
                        client_id: '900405597637-50g402qo0kbh2msi9bqii8e9od6oq0fk.apps.googleusercontent.com',
                        callback: handleGoogleSignIn
                    });
                    google.accounts.id.prompt();
                });

                // Facebook Login Handler
                facebookLoginBtn.addEventListener('click', () => {
                    FB.login(function(response) {
                        if (response.authResponse) {
                            fetch(`${API_BASE_URL}/users/facebook-auth`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ token: response.authResponse.accessToken }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.token) {
                                    localStorage.setItem('token', data.token);
                                    simulateLogin({
                                        id: data.userId,
                                        name: data.name,
                                        email: data.email,
                                        avatar: data.name ? data.name[0].toUpperCase() : data.email[0].toUpperCase(),
                                        isVendor: data.isVendor || false
                                    });
                                    connectToChat();
                                }
                            })
                            .catch(error => {
                                console.error('Facebook login error:', error);
                                alert('Facebook login failed. Please try again.');
                            });
                        }
                    }, {scope: 'public_profile,email'});
                });
                
                // Logout handler
                logoutBtn.addEventListener('click', () => {
                    // Clear the token from storage
                    localStorage.removeItem('token');
                    localStorage.removeItem('isVendorMode'); // Clear vendor mode on logout
                    localStorage.removeItem('activeDashboardSection'); // Clear active section on logout
                    
                    // Disconnect from chat
                    if (state.socket) {
                        state.socket.disconnect();
                    }
                    
                    currentUser = null;
                    showLoginView();
                    alert('You have been logged out');
                    
                    // Reset profile button
                    profileBtn.textContent = 'üë§';
                    profileBtn.style.backgroundColor = '';
                    profileBtn.style.color = '';
                    profileBtn.style.borderRadius = '';
                    profileBtn.style.width = '';
                    profileBtn.style.height = '';
                    profileBtn.style.display = '';
                    profileBtn.style.alignItems = '';
                    profileBtn.style.justifyContent = '';
                    
                    // Hide dashboard if shown, show main app
                    appContainer.style.display = 'grid';
                    clientDashboardContainer.style.display = 'none';
                    vendorDashboardContainer.style.display = 'none';
                });
                
                // View dashboard button
                viewDashboardBtn.addEventListener('click', () => {
                    profileModal.style.display = 'none';
                    // Use the new unified function
                    displayUserDashboard(currentUser.isVendor ? 'vendor' : 'client', activeDashboardSection);
                });
                
                // Dashboard menu items (both client and vendor)
                clientDashboardMenuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        displayUserDashboard('client', section); // Always 'client' for this menu
                    });
                });

                vendorDashboardMenuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        displayUserDashboard('vendor', section); // Always 'vendor' for this menu
                    });
                });
                
                // Switch to vendor mode
                switchToVendorBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (currentUser.isVendor) {
                        displayUserDashboard('vendor', 'vendor-dashboard'); // Use new function
                    } else {
                        // Check if user has a vendor profile
                        try {
                            const response = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });
                            const data = await response.json();
                            if (data.isVendor && data.isProfileComplete) {
                                // User is a vendor and profile is complete
                                currentUser.isVendor = true; // Update current user state
                                displayUserDashboard('vendor', 'vendor-dashboard');
                            } else {
                                // User is not a vendor or profile is incomplete, show registration modal
                                vendorRegistrationModal.style.display = 'flex';
                            }
                        } catch (error) {
                            console.error('Error checking vendor status:', error);
                            alert('Failed to check vendor status. Please try again.');
                        }
                    }
                });
                
                // Switch to client mode
                switchToClientBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    displayUserDashboard('client', 'dashboard'); // Use new function
                });
                
                // Logout from dashboard
                logoutDashboardBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutBtn.click();
                });
                
                // Logout from vendor dashboard
                vendorLogoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutBtn.click();
                });
                
                // Add service field in vendor registration
                addServiceFieldBtn.addEventListener('click', () => {
                    const serviceFieldGroup = document.createElement('div');
                    serviceFieldGroup.className = 'service-field-group';
                    serviceFieldGroup.style.marginBottom = '1rem';
                    serviceFieldGroup.style.paddingBottom = '1rem';
                    serviceFieldGroup.style.borderBottom = '1px dashed var(--border)';
                    
                    serviceFieldGroup.innerHTML = `
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Service Name</label>
                                    <input type="text" name="service-name[]" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label>Price</label>
                                    <input type="number" name="service-price[]" min="0" step="0.01" required>
                                    </div>
                                    </div>
                                    </div>
                                    <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="service-description[]" rows="2" required></textarea>
                                    </div>
                                    <button type="button" class="btn btn-outline btn-sm remove-service-btn">Remove Service</button>
                                    `;
                                    
                                    serviceFieldsContainer.appendChild(serviceFieldGroup);
                                    
                                    // Add event listener to remove button
                                    serviceFieldGroup.querySelector('.remove-service-btn').addEventListener('click', () => {
                                        serviceFieldGroup.remove();
                                    });
                                });
                                
                                // Vendor registration form submission
                                vendorRegistrationForm.addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    
                                    try {
                                        // Collect form data
                                        const formData = new FormData();
                                        formData.append('businessName', document.getElementById('reg-business-name').value);
                                        formData.append('businessType', document.getElementById('reg-business-type').value);
                                        formData.append('category', document.getElementById('reg-category').value);
                                        formData.append('yearsInBusiness', document.getElementById('reg-years-in-business').value);
                                        formData.append('description', document.getElementById('reg-business-description').value);
                                        formData.append('email', document.getElementById('reg-business-email').value);
                                        formData.append('phone', document.getElementById('reg-business-phone').value);
                                        formData.append('address', document.getElementById('reg-business-address').value);
                                        formData.append('website', document.getElementById('reg-business-website').value);
                                        
                                        // Collect services
                                        const services = [];
                                        document.querySelectorAll('.service-field-group').forEach(group => {
                                            services.push({
                                                name: group.querySelector('input[name="service-name[]"]').value,
                                                price: parseFloat(group.querySelector('input[name="service-price[]"]').value),
                                                description: group.querySelector('textarea[name="service-description[]"]').value
                                            });
                                        });
                                        formData.append('services', JSON.stringify(services));
                                        
                                        // Add files
                                        const businessLicense = document.getElementById('business-license').files[0];
                                        const taxId = document.getElementById('tax-id').files[0];
                                        const portfolio = document.getElementById('portfolio').files[0];
                                        
                                        if (businessLicense) formData.append('businessLicense', businessLicense);
                                        if (taxId) formData.append('taxId', taxId);
                                        if (portfolio) formData.append('portfolio', portfolio);
                                        
                                        const response = await fetch(`${API_BASE_URL}/vendors/register`, {
                                            method: 'POST',
                                            headers: {
                                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                                            },
                                            body: formData
                                        });
                                        
                                        if (!response.ok) {
                                            const errorData = await response.json();
                                            throw new Error(errorData.message || 'Registration failed');
                                        }
                                        
                                        const result = await response.json();
                                        
                                        alert('Vendor registration submitted successfully!');
                                        vendorRegistrationModal.style.display = 'none';
                                        
                                        // Update user to vendor status
                                        currentUser.isVendor = true;
                                        displayUserDashboard('vendor', 'vendor-dashboard'); // Use new function
                                        
                                    } catch (error) {
                                        console.error('Registration error:', error);
                                        alert('Registration failed. ' + error.message);
                                    }
                                });
                                
                                // Map controls
                                document.getElementById('zoom-in')?.addEventListener('click', () => {
                                    if (state.map) {
                                        state.map.setZoom(state.map.getZoom() + 1);
                                    }
                                });
                                
                                document.getElementById('zoom-out')?.addEventListener('click', () => {
                                    if (state.map) {
                                        state.map.setZoom(state.map.getZoom() - 1);
                                    }
                                });
                                
                                locateMeBtn?.addEventListener('click', () => {
                                    if (state.userLocation) {
                                        centerMapOnUser();
                                    } else {
                                        requestLocationWithFeedback();
                                    }
                                });
                                
                                // Location permission
                                allowLocationBtn.addEventListener('click', () => {
                                    locationLoading.style.display = 'inline-block';
                                    allowLocationBtn.disabled = true;
                                    
                                    navigator.geolocation.getCurrentPosition(
                                        (position) => {
                                            locationPermissionModal.style.display = 'none';
                                            handleLocationSuccess(position);
                                            locationLoading.style.display = 'none';
                                            allowLocationBtn.disabled = false;
                                        },
                                        (error) => {
                                            console.log("Location error:", error);
                                            locationPermissionModal.style.display = 'none';
                                            locationLoading.style.display = 'none';
                                            allowLocationBtn.disabled = false;
                                            currentLocationCheckbox.checked = false;
                                            alert("Could not get your location. Please try again or enter a location manually.");
                                        },
                                        {
                                            enableHighAccuracy: true,
                                            timeout: 10000
                                        }
                                    );
                                });
                                
                                denyLocationBtn.addEventListener('click', () => {
                                    locationPermissionModal.style.display = 'none';
                                    currentLocationCheckbox.checked = false;
                                });
                                
                                // Confirmation modal
                                document.getElementById('conf-done-btn').addEventListener('click', () => {
                                    confirmationModal.style.display = 'none';
                                });
                                
                                // Category scroll buttons
                                if (scrollLeftBtn && scrollRightBtn && categoriesListWrapper) {
                                    scrollLeftBtn.addEventListener('click', () => {
                                        categoriesListWrapper.scrollBy({
                                            left: -200, // Scroll left by 200px
                                            behavior: 'smooth'
                                        });
                                    });

                                    scrollRightBtn.addEventListener('click', () => {
                                        categoriesListWrapper.scrollBy({
                                            left: 200, // Scroll right by 200px
                                            behavior: 'smooth'
                                        });
                                    });
                                }
                            }
                            
                            // Filter vendors based on current filters
                            function filterVendors() {
                                // Get search term
                                const searchTerm = searchInput.value.toLowerCase();
                                
                                // Get filter values
                                const selectedTypes = [];
                                document.querySelectorAll('.filter-section input[type="checkbox"]:checked').forEach(checkbox => {
                                    if (checkbox.id !== 'current-location' && checkbox.id !== 'within50') {
                                        selectedTypes.push(checkbox.id);
                                    }
                                });
                                
                                const priceRange = document.getElementById('price-slider').value;
                                const useCurrentLocation = document.getElementById('current-location').checked;
                                const within50Miles = document.getElementById('within50').checked;
                                const startDate = document.getElementById('start-date').value;
                                const endDate = document.getElementById('end-date').value;
                                const region = document.getElementById('region-select').value;
                                
                                // First apply all filters EXCEPT location
                                let filtered = state.vendors.filter(vendor => {
                                    // Category filter
                                    if (state.currentCategory !== 'all' && vendor.category !== state.currentCategory) {
                                        return false;
                                    }
                                    
                                    // Search term (vendor name, location, or services)
                                    if (searchTerm) {
                                        const nameMatch = vendor.name.toLowerCase().includes(searchTerm);
                                        const locationMatch = vendor.location.toLowerCase().includes(searchTerm);
                                        let serviceMatch = false;
                                        
                                        if (vendor.services) {
                                            serviceMatch = vendor.services.some(category => 
                                                category.services.some(service => 
                                                    service.name.toLowerCase().includes(searchTerm) || 
                                                    service.description.toLowerCase().includes(searchTerm))
                                            );
                                        }
                                        
                                        if (!nameMatch && !locationMatch && !serviceMatch) {
                                            return false;
                                        }
                                    }
                                    
                                 
                                    // Vendor type
                                    const vendorType = vendor.type?.toLowerCase() || 'independent';
                                    if (selectedTypes.length > 0 && !selectedTypes.includes(vendorType)) {
                                        return false;
                                    }
                                    
                                    // Price range
                                    if (priceRange < 33 && vendor.priceLevel === '$$$') return false;
                                    if (priceRange > 66 && vendor.priceLevel === '$') return false;
                                    
                                    // Popular filters
                                    if (state.filters.popular.length > 0) {
                                        if (state.filters.popular.includes('premium') && !vendor.isPremium) return false;
                                        if (state.filters.popular.includes('eco-friendly') && !vendor.isEcoFriendly) return false;
                                        if (state.filters.popular.includes('award-winning') && !vendor.isAwardWinning) return false;
                                    }
                                    
                                    // Date availability filter
                                    if (startDate) {
                                        // In a real app, you would check vendor availability against the date
                                        // For demo, we'll just filter randomly
                                        if (Math.random() < 0.7) return false; // 30% chance of being available
                                    }
                                    
                                    // Region filter
                                    if (region && vendor.region !== region) {
                                        return false;
                                    }
                                    
                                    return true;
                                });
                                
                                // Handle location filter
                                let locationMessage = '';
                                if (useCurrentLocation && state.userLocation && within50Miles) {
                                    // For demo purposes, we'll simulate nearby vendors by filtering the first few
                                    const nearbyVendors = filtered.slice(0, 3); // Show first 3 as "nearby"
                                    
                                    if (nearbyVendors.length > 0) {
                                        filtered = nearbyVendors;
                                        locationMessage = `${filtered.length} vendors available near you`;
                                    } else {
                                        // If no nearby vendors, show ALL vendors that match other filters
                                        locationMessage = "No vendors near you. Showing all available vendors.";
                                    }
                                } else {
                                    locationMessage = `${filtered.length} vendors available`;
                                }
                                
                                state.filteredVendors = filtered;
                                resultsCount.textContent = locationMessage;
                                
                                // Apply sorting
                                sortVendors(false);
                                
                                // Reset to first page
                                state.currentPage = 1;
                                
                                // Update UI
                                updateMetadata({ total: state.filteredVendors.length });
                                renderVendors();
                                
                                // Update map if in map view
                                if (state.map) {
                                    updateMapMarkers();
                                }
                            }
                            
                            // Sort vendors
                            function sortVendors(shouldRender = true) {
                                const sortValue = sortSelect.value;
                                
                                switch(sortValue) {
                                    case 'price-low':
                                        state.filteredVendors.sort((a, b) => {
                                            const priceA = a.priceLevel === '$' ? 1 : a.priceLevel === '$$' ? 2 : 3;
                                            const priceB = b.priceLevel === '$' ? 1 : b.priceLevel === '$$' ? 2 : 3;
                                            return priceA - priceB;
                                        });
                                        break;
                                    case 'price-high':
                                        state.filteredVendors.sort((a, b) => {
                                            const priceA = a.priceLevel === '$' ? 1 : a.priceLevel === '$$' ? 2 : 3;
                                            const priceB = b.priceLevel === '$' ? 1 : b.priceLevel === '$$' ? 2 : 3;
                                            return priceB - priceA;
                                        });
                                        break;
                                    case 'popular':
                                        state.filteredVendors.sort((a, b) => {
                                            const ratingA = parseFloat(a.rating?.split(' ')[0] || 0);
                                            const ratingB = parseFloat(b.rating?.split(' ')[0] || 0);
                                            return ratingB - ratingA;
                                        });
                                        break;
                                    case 'nearest':
                                        if (state.userLocation) {
                                            // In a real app, we would calculate distance properly
                                            // For demo, we'll just shuffle the array
                                            state.filteredVendors.sort(() => Math.random() - 0.5);
                                        }
                                        break;
                                    case 'rating':
                                        state.filteredVendors.sort((a, b) => {
                                            const ratingA = a.rating || 0;
                                            const ratingB = b.rating || 0;
                                            return ratingB - ratingA;
                                        });
                                        break;
                                    default: // recommended
                                        // Default sorting (could be by relevance, etc.)
                                        break;
                                }
                                
                                if (shouldRender) {
                                    renderVendors();
                                    if (state.map) {
                                        updateMapMarkers();
                                    }
                                }
                            }
                                     
                            // Reset specific filter
                            function resetFilter(filterType) {
                                switch(filterType) {
                                    case 'location':
                                        document.getElementById('location-input').value = '';
                                        document.getElementById('current-location').checked = false;
                                        document.getElementById('within50').checked = false;
                                        state.userLocation = null;
                                        break;
                                    case 'type':
                                        document.querySelectorAll('.filter-section input[type="checkbox"]').forEach(checkbox => {
                                            checkbox.checked = ['independent', 'company'].includes(checkbox.id);
                                        });
                                        break;
                                    case 'price':
                                        document.getElementById('price-slider').value = 40;
                                        break;
                                    case 'advanced':
                                        document.getElementById('start-date').value = '';
                                        document.getElementById('end-date').value = '';
                                        document.getElementById('region-select').value = '';
                                        state.filters.startDate = null;
                                        state.filters.endDate = null;
                                        state.filters.region = '';
                                        break;
                                }
                                
                                filterVendors();
                            }
                            
                            // Render vendor cards
                            function renderVendors() {
                                if (!state.filteredVendors || state.filteredVendors.length === 0) {
                                    vendorGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;">No vendors match your filters</div>';
                                    updatePagination();
                                    return;
                                }
                                
                                // Pagination
                                const startIndex = (state.currentPage - 1) * state.itemsPerPage;
                                const endIndex = startIndex + state.itemsPerPage;
                                const paginatedVendors = state.filteredVendors.slice(startIndex, endIndex);
                                
                                vendorGrid.innerHTML = '';
                                
                                
                                paginatedVendors.forEach(vendor => {
                                    const isFavorite = state.favorites.includes(vendor.id);
                                    
                                    const vendorCard = document.createElement('div');
                                    vendorCard.className = 'vendor-card';
                                    vendorCard.innerHTML = `
                                        <div class="vendor-image">
                                            ${vendor.image ? `<img src="${vendor.image}" alt="${vendor.name}" style="width:100%;height:100%;object-fit:cover;">` : getCategoryIcon(vendor.category)}
                                            ${vendor.isPremium ? '<div class="vendor-badge">Premium</div>' : ''}
                                            <div class="vendor-favorite ${isFavorite ? 'active' : ''}" data-id="${vendor.id}">‚ù§</div>
                                        </div>
                                        <div class="vendor-details">
                                            <h3 class="vendor-name">${vendor.name}</h3>
                                            <div class="vendor-location">
                                                üìç ${vendor.location}
                                            </div>
                                            <div class="vendor-features">
                                                <div class="feature">
                                                    <span class="feature-icon">${getCategoryIcon(vendor.category)}</span>
                                                    <span>${getCategoryName(vendor.category)}</span>
                                                </div>
                                                <div class="feature">
                                                    <span class="feature-icon">‚≠ê</span>
                                                    <span>${vendor.rating} (${vendor.reviewCount})</span>
                                                </div>
                                                <div class="feature">
                                                    <div class="price-indicator">
                                                        ${renderPriceIndicator(vendor.priceLevel)}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="vendor-footer">
                                                <button class="btn btn-outline save-btn" data-id="${vendor.id}">Save</button>
                                                <button class="btn btn-primary view-btn" data-id="${vendor.id}">View</button>
                                            </div>
                                        </div>
                                    `;
                                    vendorGrid.appendChild(vendorCard);
                                            
                                    // Add event listeners to buttons
                                    vendorCard.querySelector('.view-btn').addEventListener('click', () => {
                                        openBookingModal(vendor);
                                    });
                                    
                                    vendorCard.querySelector('.save-btn').addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        toggleFavorite(vendor.id);
                                    });
                                    
                                    vendorCard.querySelector('.vendor-favorite').addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        toggleFavorite(vendor.id);
                                    });
                                });
                                
                                updatePagination();
                            }
                            
                            // Helper function to get category icon
                            function getCategoryIcon(category) {
                                const icons = {
                                    "all": "‚ú®",
                                    "venue": "üè®",
                                    "photo": "üì∑",
                                    "music": "üéµ",
                                    "catering": "üçΩÔ∏è",
                                    "entertainment": "üé≠",
                                    "experiences": "üåü",
                                    "decor": "üéÄ",
                                    "beauty": "üíÑ",
                                    "cake": "üéÇ",
                                    "transport": "üöó",
                                    "planner": "üìã",
                                    "fashion": "üëó",
                                    "stationery": "‚úâÔ∏è"
                                };
                                return icons[category] || "üéâ";
                            }
                            
                            // Helper function to get category name
                            function getCategoryName(category) {
                                const names = {
                                    "all": "All Categories",
                                    "venue": "Venue",
                                    "photo": "Photo/Video",
                                    "music": "Music/DJ",
                                    "catering": "Catering",
                                    "entertainment": "Entertainment",
                                    "experiences": "Experiences",
                                    "decor": "Decorations",
                                    "beauty": "Beauty",
                                    "cake": "Cake",
                                    "transport": "Transportation",
                                    "planner": "Planner",
                                    "fashion": "Fashion",
                                    "stationery": "Stationery"
                                };
                                return names[category] || "Vendor";
                            }
                            
                            // Render price indicator
                            function renderPriceIndicator(priceLevel) {
                                const levels = priceLevel || '$';
                                let html = '';
                                
                                for (let i = 0; i < 3; i++) {
                                    const isFilled = i < levels.length;
                                    html += `<span class="price-dot ${isFilled ? 'filled' : ''}"></span>`;
                                }
                                
                                return html;
                            }
                            
                            // Update pagination controls
                            function updatePagination() {
                                const totalPages = Math.ceil(state.filteredVendors.length / state.itemsPerPage);
                                
                                if (totalPages <= 1) {
                                    pagination.style.display = 'none';
                                    return;
                                }
                                
                                pagination.style.display = 'flex';
                                
                                // Clear existing page buttons (except prev/next)
                                const pageBtns = pagination.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)');
                                pageBtns.forEach(btn => btn.remove());
                                
                                // Add page buttons
                                for (let i = 1; i <= totalPages; i++) {
                                    const pageBtn = document.createElement('div');
                                    pageBtn.className = `page-btn ${i === state.currentPage ? 'active' : ''}`;
                                    pageBtn.textContent = i;
                                    pageBtn.addEventListener('click', () => {
                                        state.currentPage = i;
                                        renderVendors();
                                    });
                                    
                                    pagination.insertBefore(pageBtn, nextPageBtn);
                                }
                                
                                // Update prev/next button states
                                prevPageBtn.classList.toggle('disabled', state.currentPage === 1);
                                nextPageBtn.classList.toggle('disabled', state.currentPage === totalPages);
                            }
                            
                            // Update metadata in header
                            function updateMetadata(metadata) {
                                const usingLocation = state.userLocation && document.getElementById('current-location').checked;
                                const locationText = usingLocation ? "Near You" : (metadata?.location || 'Los Angeles');
                                const categoryText = state.currentCategory === 'all' ? '' : getCategoryName(state.currentCategory) + ' ';
                                
                                resultsTitle.textContent = `${categoryText}Vendors in ${locationText}`;
                                resultsCount.textContent = `${state.filteredVendors.length} vendors available${usingLocation ? ' near you' : ''}`;
                            }
                            
                            // Show error message
                            function showError(message) {
                                vendorGrid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--accent)">${message}</div>`;
                                resultsTitle.textContent = "Error";
                                resultsCount.textContent = message;
                            }
                            
                            // Open modal with vendor details and services
                            async function openBookingModal(vendor) {
                                state.currentVendor = vendor;
                                state.selectedServices = [];
                                state.selectedDate = null;
                                state.selectedTime = null;

                                // Initialize chat state for this specific vendor
                                state.chat.init();

                                // Fetch full vendor details from API
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendors/${vendor.id}?userId=${currentUser ? currentUser.id : ''}`);
                                    if (!response.ok) {
                                        throw new Error(`Failed to fetch vendor details: ${response.statusText}`);
                                    }
                                    const data = await response.json();
                                    const fullVendorDetails = data.data; // The API returns data under 'data' property
                                    
                                    // Update modal content with fetched details
                                    document.getElementById('modal-vendor-name').textContent = fullVendorDetails.profile.BusinessName;
                                    document.getElementById('modal-vendor-name-full').textContent = fullVendorDetails.profile.BusinessName;
                                    document.getElementById('modal-vendor-location').textContent = `${fullVendorDetails.profile.City}, ${fullVendorDetails.profile.State}`;
                                    document.getElementById('modal-vendor-category-icon').innerHTML = getCategoryIcon(fullVendorDetails.categories[0]?.Category || 'all');
                                    document.getElementById('modal-vendor-category-name').textContent = getCategoryName(fullVendorDetails.categories[0]?.Category || 'all');
                                    document.getElementById('modal-vendor-price').textContent = fullVendorDetails.profile.PriceLevel || '$500';
                                    document.getElementById('modal-vendor-description').textContent = fullVendorDetails.profile.BusinessDescription || "A professional vendor for your special event. Contact us for more details about our services.";
                                    
                                    // Render image or placeholder
                                    const vendorImageContainer = modalBody.querySelector('.vendor-detail-image');
                                    if (fullVendorDetails.profile.FeaturedImageURL) {
                                        vendorImageContainer.innerHTML = `<img src="${fullVendorDetails.profile.FeaturedImageURL}" alt="${fullVendorDetails.profile.BusinessName}" style="width:100%;height:100%;object-fit:cover;border-radius:var(--radius);">`;
                                    } else {
                                        vendorImageContainer.innerHTML = getCategoryIcon(fullVendorDetails.categories[0]?.Category || 'all');
                                    }

                                    // Render services
                                    const servicesSection = modalBody.querySelector('#services-section');
                                    if (fullVendorDetails.services && fullVendorDetails.services.length > 0) {
                                        servicesSection.innerHTML = `
                                            <h3 class="services-title">Available Services</h3>
                                            ${renderServices(fullVendorDetails.services)}
                                        `;
                                    } else {
                                        servicesSection.innerHTML = `<h3 class="services-title">Available Services</h3><p>No services available for this vendor.</p>`;
                                    }

                                    // Render reviews
                                    const reviewsListContainer = modalBody.querySelector('#modal-reviews-list');
                                    if (fullVendorDetails.reviews && fullVendorDetails.reviews.length > 0) {
                                        reviewsListContainer.innerHTML = renderReviews(fullVendorDetails.reviews);
                                        // Update rating display
                                        const avgRating = fullVendorDetails.profile.AverageRating || 0;
                                        const reviewCount = fullVendorDetails.profile.ReviewCount || 0;
                                        document.getElementById('modal-vendor-rating').innerHTML = `
                                            ${'‚òÖ'.repeat(Math.round(avgRating))}${'‚òÜ'.repeat(5 - Math.round(avgRating))} <span>(${avgRating.toFixed(1)}) | ${reviewCount} Reviews</span>
                                        `;
                                    } else {
                                        reviewsListContainer.innerHTML = '<p>No reviews yet.</p>';
                                        document.getElementById('modal-vendor-rating').innerHTML = `
                                            ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê <span>(0.0) | 0 Reviews</span>
                                        `;
                                    }

                                    // Update services offered count (assuming 'services' is an array of service categories, each with a 'services' array)
                                    let totalServicesOffered = 0;
                                    if (fullVendorDetails.services) {
                                        fullVendorDetails.services.forEach(category => {
                                            if (category.services) {
                                                totalServicesOffered += category.services.length;
                                            }
                                        });
                                    }
                                    document.getElementById('modal-vendor-services-offered').textContent = `${totalServicesOffered} Services`;

                                    // Initialize booking calendar
                                    initBookingCalendar(fullVendorDetails.profile.VendorProfileID);

                                    // Set up chat if user is logged in
                                    if (currentUser) {
                                        initializeChat(fullVendorDetails.profile.VendorProfileID)
                                            .catch(error => {
                                                console.error('Chat initialization failed:', error);
                                                disableChatInput();
                                                showChatError('Failed to initialize chat. Please try again.');
                                            });
                                    } else {
                                        disableChatInput();
                                        showChatError('Please log in to chat with the vendor.');
                                    }

                                    // Attach chat event listeners for the modal's chat section
                                    setupChatEventListeners('chat-input', 'send-btn');

                                    // Add event listeners to service buttons
                                    document.querySelectorAll('.add-service-btn').forEach(btn => {
                                        btn.addEventListener('click', function() {
                                            const serviceId = parseInt(this.dataset.serviceId); // Use serviceId
                                            const serviceName = this.dataset.serviceName;
                                            const servicePrice = parseFloat(this.dataset.price);
                                            
                                            const serviceIndex = state.selectedServices.findIndex(s => s.serviceId === serviceId);
                                            
                                            if (serviceIndex === -1) {
                                                state.selectedServices.push({ serviceId, name: serviceName, price: servicePrice, quantity: 1 });
                                                this.classList.add('active');
                                                this.textContent = 'Added';
                                            } else {
                                                state.selectedServices.splice(serviceIndex, 1);
                                                this.classList.remove('active');
                                                this.textContent = 'Add';
                                            }
                                        });
                                    });
                                    
                                    // Show review form
                                    document.getElementById('show-review-form')?.addEventListener('click', () => {
                                        document.getElementById('review-form').style.display = 'block';
                                    });
                                    
                                    // Rating stars
                                    document.querySelectorAll('.rating-star').forEach(star => {
                                        star.addEventListener('click', function() {
                                            const rating = parseInt(this.dataset.rating);
                                            const stars = document.querySelectorAll('.rating-star');
                                            
                                            stars.forEach((s, index) => {
                                                if (index < rating) {
                                                    s.textContent = '‚òÖ';
                                                    s.classList.add('selected');
                                                } else {
                                                    s.textContent = '‚òÜ';
                                                    s.classList.remove('selected');
                                                }
                                            });
                                        });
                                    });
                                    
                                    // Submit review
                                    document.getElementById('submit-review')?.addEventListener('click', async () => {
                                        const rating = document.querySelectorAll('.rating-star.selected').length;
                                        const reviewText = document.getElementById('review-text').value;
                                        
                                        if (!rating) {
                                            alert('Please select a rating');
                                            return;
                                        }
                                        
                                        if (!reviewText) {
                                            alert('Please write your review');
                                            return;
                                        }
                                        
                                        try {
                                            const response = await fetch(`${API_BASE_URL}/reviews`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                                },
                                                body: JSON.stringify({
                                                    userId: currentUser.id,
                                                    vendorProfileId: vendor.id,
                                                    bookingId: null, // Assuming review is not tied to a specific booking initially
                                                    rating: rating,
                                                    title: 'Review from VenueVue',
                                                    comment: reviewText
                                                })
                                            });
                                            
                                            if (!response.ok) {
                                                const errorData = await response.json();
                                                throw new Error(errorData.message || 'Failed to submit review');
                                            }
                                            
                                            alert('Thank you for your review!');
                                            document.getElementById('review-form').style.display = 'none';
                                            
                                            // Refresh reviews by re-opening the modal or fetching new data
                                            openBookingModal(vendor); // Re-fetch and re-render the modal content
                                            
                                        } catch (error) {
                                            console.error('Review submission error:', error);
                                            alert('Failed to submit review. ' + error.message);
                                        }
                                    });
                                    
                                    // Login to review
                                    document.getElementById('login-to-review')?.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        // Hide the vendor modal directly, then show profile modal
                                        document.getElementById('vendor-modal').style.display = 'none';
                                        document.body.style.overflow = 'auto'; // Ensure scrolling is re-enabled
                                        profileModal.style.display = 'flex';
                                        showLoginView();
                                    });
                                    
                                    // Book now button
                                    document.getElementById('book-now-btn').addEventListener('click', function() {
                                        if (!currentUser) {
                                            // Hide the vendor modal directly, then show profile modal
                                            document.getElementById('vendor-modal').style.display = 'none';
                                            document.body.style.overflow = 'auto'; // Ensure scrolling is re-enabled
                                            profileModal.style.display = 'flex';
                                            showLoginView();
                                            return;
                                        }
                                        
                                        if (state.selectedServices.length === 0) {
                                            alert('Please select at least one service');
                                            return;
                                        }
                                        
                                        if (!state.selectedDate || !state.selectedTime) {
                                            alert('Please select a date and time');
                                            return;
                                        }
                                        
                                        // Show payment section
                                        document.getElementById('payment-section').style.display = 'block';
                                        this.style.display = 'none';
                                        
                                        // Initialize Stripe Elements
                                        const card = state.elements.create('card');
                                        card.mount('#card-element');
                                        
                                        // Handle payment
                                        document.getElementById('pay-now-btn').addEventListener('click', async () => {
                                            const cardholderName = document.getElementById('cardholder-name').value;
                                            
                                            if (!cardholderName) {
                                                alert('Please enter cardholder name');
                                                return;
                                            }
                                            
                                            try {
                                                // Create payment intent
                                                const totalAmount = state.selectedServices.reduce((sum, service) => sum + service.price, 0);
                                                const paymentIntentResponse = await fetch(`${API_BASE_URL}/bookings/create-payment-intent`, { // Corrected endpoint
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                                                    },
                                                    body: JSON.stringify({
                                                        bookingId: null, // No booking yet, intent is for new booking
                                                        amount: totalAmount, // Amount in dollars
                                                        currency: 'usd',
                                                        paymentMethodId: null, // Stripe will handle this from card element
                                                        customerId: null // Stripe will handle this
                                                    })
                                                });
                                                
                                                if (!paymentIntentResponse.ok) {
                                                    const errorData = await paymentIntentResponse.json();
                                                    throw new Error(errorData.message || 'Failed to create payment intent');
                                                }
                                                
                                                const { paymentIntentID, clientSecret } = await paymentIntentResponse.json(); // Corrected property names
                                                
                                                // Confirm payment
                                                const { error, paymentIntent: confirmedPaymentIntent } = await state.stripe.confirmCardPayment(clientSecret, {
                                                    payment_method: {
                                                        card: card,
                                                        billing_details: {
                                                            name: cardholderName
                                                        }
                                                    }
                                                });
                                                
                                                if (error) {
                                                    throw error;
                                                }
                                                
                                                // Payment successful - create booking
                                                await bookVendor(vendor, confirmedPaymentIntent.id); // Pass paymentIntent ID
                                                
                                            } catch (error) {
                                                console.error('Payment error:', error);
                                                alert('Payment failed. ' + error.message);
                                            }
                                        });
                                    });
                                } catch (error) {
                                    console.error('Error opening booking modal:', error);
                                    alert('Failed to load vendor details. Please try again.');
                                }
                                
                                modal.style.display = 'flex';
                                document.body.style.overflow = 'hidden';
                            }

                            async function initializeChat(vendorProfileId) {
                                if (!currentUser) {
                                    disableChatInput();
                                    console.warn('initializeChat: No current user. Disabling chat input.');
                                    return;
                                }

                                console.log(`Initializing chat for vendor: ${vendorProfileId} and user: ${currentUser.id}`);
                                state.chat.init(); // Reset chat state

                                try {
                                    // Check for existing conversation
                                    const checkResponse = await fetch(`${API_BASE_URL}/messages/conversation/check`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                                        },
                                        body: JSON.stringify({
                                            userId: currentUser.id,
                                            vendorProfileId: vendorProfileId
                                        })
                                    });

                                    if (!checkResponse.ok) {
                                        const errorText = await checkResponse.text();
                                        throw new Error(`Failed to check conversation: ${checkResponse.status} ${checkResponse.statusText} - ${errorText}`);
                                    }

                                    const checkData = await checkResponse.json();
                                    
                                    if (checkData.conversationId) {
                                        state.chat.currentConversation = checkData.conversationId;
                                        console.log('Existing conversation found:', state.chat.currentConversation);
                                    } else {
                                        // Create new conversation if none exists
                                        console.log('No existing conversation found. Creating new one...');
                                        const createResponse = await fetch(`${API_BASE_URL}/messages/conversation`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                                            },
                                            body: JSON.stringify({
                                                userId: currentUser.id,
                                                vendorProfileId: vendorProfileId
                                            })
                                        });

                                        if (!createResponse.ok) {
                                            const errorText = await createResponse.text();
                                            throw new Error(`Failed to create conversation: ${createResponse.status} ${createResponse.statusText} - ${errorText}`);
                                        }

                                        const createData = await createResponse.json();
                                        state.chat.currentConversation = createData.conversationId || createData.ConversationID;
                                        console.log('New conversation created:', state.chat.currentConversation);
                                    }

                                    if (state.chat.currentConversation) {
                                        await loadInitialMessages();
                                    } else {
                                        console.error('Conversation ID is null after check/create. Cannot load messages.');
                                        showChatError('Failed to establish chat. No conversation ID.');
                                        disableChatInput();
                                    }

                                } catch (error) {
                                    console.error('Chat initialization failed:', error);
                                    disableChatInput();
                                    showChatError('Failed to initialize chat. Please try again: ' + error.message);
                                }
                            }

                            // Initialize booking calendar
                            function initBookingCalendar(vendorProfileId) {
                                const calendarEl = document.getElementById('booking-calendar');
                                const calendar = new FullCalendar.Calendar(calendarEl, {
                                    initialView: 'dayGridMonth',
                                    selectable: true,
                                    select: async function(info) {
                                        state.selectedDate = info.startStr;
                                        state.selectedTime = null;
                                        
                                        // Fetch available time slots for the selected date and vendor
                                        await fetchAvailableTimeSlots(vendorProfileId, state.selectedDate);
                                    }
                                });
                                calendar.render();
                                calendarEl._fullCalendar = calendar; // Store calendar instance
                            }

                            // Fetch available time slots from API
                            async function fetchAvailableTimeSlots(vendorProfileId, date) {
                                const timeSlotsContainer = document.getElementById('time-slots');
                                timeSlotsContainer.innerHTML = '<p>Loading time slots...</p>';
                                
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendors/${vendorProfileId}/availability?date=${date}`);
                                    if (!response.ok) {
                                        throw new Error(`Failed to fetch availability: ${response.statusText}`);
                                    }
                                    const data = await response.json();
                                    
                                    // Assuming data.availableSlots contains an array of { StartTime, EndTime }
                                    if (data.availableSlots && data.availableSlots.length > 0) {
                                        timeSlotsContainer.innerHTML = ''; // Clear loading message
                                        data.availableSlots.forEach(slot => {
                                            const slotEl = document.createElement('div');
                                            slotEl.className = 'time-slot';
                                            slotEl.textContent = `${slot.StartTime.substring(0, 5)} - ${slot.EndTime.substring(0, 5)}`; // Format time
                                            
                                            // You might need more complex logic here to determine if a slot is truly available
                                            // based on MaxCapacity and BookedCount from sp_GetVendorDetails
                                            if (slot.BookedCount >= slot.MaxCapacity) {
                                                slotEl.classList.add('unavailable');
                                            } else {
                                                slotEl.addEventListener('click', function() {
                                                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                                                    this.classList.add('selected');
                                                    state.selectedTime = slot.StartTime; // Store the exact start time
                                                });
                                            }
                                            
                                            timeSlotsContainer.appendChild(slotEl);
                                        });
                                    } else {
                                        timeSlotsContainer.innerHTML = '<p>No available slots for this date.</p>';
                                    }
                                } catch (error) {
                                    console.error('Error fetching time slots:', error);
                                    timeSlotsContainer.innerHTML = `<p style="color:var(--accent);">Failed to load time slots: ${error.message}</p>`;
                                }
                            }
                            
                            // Calculate total amount for selected services
                            function calculateTotalAmount() {
                                return state.selectedServices.reduce((total, service) => total + service.price, 0);
                            }
                            
                            // Book vendor function
                            async function bookVendor(vendor, paymentIntentId) {
                                const token = localStorage.getItem('token');
                                if (!token) {
                                    alert('Please login to book a vendor');
                                    profileModal.style.display = 'flex';
                                    showLoginView();
                                    return;
                                }

                                try {
                                    const response = await fetch(`${API_BASE_URL}/bookings`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            userId: currentUser.id,
                                            vendorProfileId: vendor.id,
                                            eventDate: `${state.selectedDate}T${state.selectedTime}:00`, // Combine date and time
                                            endDate: `${state.selectedDate}T${state.selectedTime}:00`, // For simplicity, assume end date is same as start
                                            attendeeCount: 1, // Default to 1
                                            specialRequests: 'None', // Default
                                            services: state.selectedServices.map(s => ({
                                                serviceId: s.serviceId,
                                                quantity: s.quantity,
                                                price: s.price
                                            })),
                                            paymentIntentId: paymentIntentId // Pass the confirmed payment intent ID
                                        })
                                    });

                                    if (!response.ok) {
                                        const errorData = await response.json();
                                        throw new Error(errorData.message || 'Booking failed');
                                    }

                                    const bookingData = await response.json();
                                    
                                    // Update confirmation modal
                                    document.getElementById('conf-venue-name').textContent = vendor.name;
                                    document.getElementById('conf-services').textContent = state.selectedServices.map(s => s.name).join(', ');
                                    document.getElementById('conf-date').textContent = new Date(state.selectedDate).toLocaleDateString('en-US', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    });
                                    document.getElementById('conf-time').textContent = state.selectedTime;
                                    document.getElementById('conf-id').textContent = bookingData.bookingId; // Use bookingId from API response
                                    
                                    // Show confirmation
                                    closeBookingModal(); // This will hide the vendor modal and reset its state
                                    confirmationModal.style.display = 'flex';
                                    
                                } catch (error) {
                                    console.error('Booking error:', error);
                                    alert('Booking failed. ' + error.message);
                                }
                            }
                            
                            // Render services for a vendor
                            function renderServices(serviceCategories) {
                                return serviceCategories.map(category => `
                                    <div class="service-category">
                                        <h4 class="category-title">${category.CategoryName || category.Name}</h4>
                                        <div class="service-grid">
                                            ${(category.services || []).map(service => `
                                                <div class="service-card">
                                                    <div class="service-name">${service.name}</div>
                                                    <div class="service-description">${service.description}</div>
                                                    <div class="service-price">$${service.Price || service.price || 'N/A'}</div>
                                                    <div class="service-actions">
                                                        <button class="btn btn-outline btn-sm add-service-btn" 
                                                                data-service-id="${service.ServiceID}"
                                                                data-service-name="${service.name}"
                                                                data-price="${service.Price || service.price}">
                                                            Add
                                                        </button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('');
                            }
                            
                            // Render reviews for a vendor
                            function renderReviews(reviews) {
                                if (reviews.length === 0) {
                                    return '<p>No reviews yet.</p>';
                                }
                                return reviews.map(review => `
                                    <div class="review-card">
                                        <div class="review-header">
                                            <div class="reviewer">${review.ReviewerName || review.UserName || 'Anonymous'}</div>
                                            <div class="review-date">${new Date(review.CreatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                        </div>
                                        <div class="review-rating">${'‚òÖ'.repeat(review.Rating)}${'‚òÜ'.repeat(5 - review.Rating)}</div>
                                        ${review.Title ? `<div class="review-title">${review.Title}</div>` : ''}
                                        <div class="review-text">${review.Comment}</div>
                                    </div>
                                `).join('');
                            }
                            
                            // Close modal (specifically for vendor-modal and its state)
                            function closeBookingModal() {
                                document.getElementById('vendor-modal').style.display = 'none';
                                document.body.style.overflow = 'auto';
                                resetBookingModalState(); // Call the state reset function
                            }

                            // New function to reset the state related to the booking modal
                            function resetBookingModalState() {
                                state.currentVendor = null;
                                state.selectedServices = [];
                                state.selectedDate = null;
                                state.selectedTime = null;
                                // Potentially clear calendar selection or time slots if FullCalendar allows
                                const calendarEl = document.getElementById('booking-calendar');
                                if (calendarEl && calendarEl._fullCalendar) {
                                    calendarEl._fullCalendar.unselect(); // Deselect any selected dates
                                    document.getElementById('time-slots').innerHTML = ''; // Clear time slots
                                }
                                document.getElementById('payment-section').style.display = 'none'; // Hide payment section
                                document.getElementById('book-now-btn').style.display = 'block'; // Show book now button
                            }
                            
                            // Show login view in profile modal
                            function showLoginView() {
                                loginForm.style.display = 'block';
                                signupForm.style.display = 'none';
                                loggedInView.style.display = 'none';
                                document.getElementById('profile-modal-title').textContent = 'Welcome to VenueVue';
                                // Clear form fields
                                document.getElementById('login-email').value = '';
                                document.getElementById('login-password').value = '';
                            }
                            
                            // Show signup view in profile modal
                            function showSignupView() {
                                loginForm.style.display = 'none';
                                signupForm.style.display = 'block';
                                loggedInView.style.display = 'none';
                                document.getElementById('profile-modal-title').textContent = 'Create an Account';
                                // Clear form fields
                                document.getElementById('signup-name').value = '';
                                document.getElementById('signup-email').value = '';
                                document.getElementById('signup-password').value = '';
                            }
                            
                            // Show logged in view in profile modal
                            function showLoggedInView() {
                                loginForm.style.display = 'none';
                                signupForm.style.display = 'none';
                                loggedInView.style.display = 'block';
                                document.getElementById('profile-modal-title').textContent = 'My Account';
                                
                                // Update user info
                                document.getElementById('profile-name').textContent = currentUser.name;
                                document.getElementById('profile-email').textContent = currentUser.email;
                                document.getElementById('profile-avatar').textContent = currentUser.avatar;
                            }
                            
                            // Unified function to display either client or vendor dashboard
                            async function displayUserDashboard(mode, section) {
                                // Update global state and localStorage
                                isVendorMode = (mode === 'vendor');
                                activeDashboardSection = section;
                                localStorage.setItem('isVendorMode', isVendorMode);
                                localStorage.setItem('activeDashboardSection', activeDashboardSection);

                                // Hide main app view
                                appContainer.style.display = 'none';

                                // Determine which dashboard to show
                                if (isVendorMode) {
                                    clientDashboardContainer.style.display = 'none';
                                    vendorDashboardContainer.style.display = 'grid';
                                } else {
                                    vendorDashboardContainer.style.display = 'none';
                                    clientDashboardContainer.style.display = 'grid';
                                }

                                // Get the correct menu and content sections based on the mode
                                const currentDashboardMenu = isVendorMode ? vendorDashboardContainer.querySelector('.dashboard-menu') : clientDashboardContainer.querySelector('.dashboard-menu');
                                // Select all direct children divs of main within the active dashboard container that start with 'dashboard-' or 'vendor-'
                                const currentDashboardContentSections = document.querySelectorAll(
                                    isVendorMode ? '#vendor-dashboard-container > main > div[id^="vendor-"]' : '#dashboard-container > main > div[id]'
                                ); 

                                // Hide all sections in the active dashboard first
                                currentDashboardContentSections.forEach(sec => {
                                    sec.style.display = 'none';
                                });

                                // Show the selected section
                                const targetSectionElement = document.getElementById(section + '-section');
                                if (targetSectionElement) {
                                    targetSectionElement.style.display = 'block';
                                    // Update dashboard title
                                    const dashboardTitleElement = document.getElementById(isVendorMode ? 'vendor-dashboard-title' : 'dashboard-title');
                                    if (dashboardTitleElement) {
                                        dashboardTitleElement.textContent = section.charAt(0).toUpperCase() + section.slice(1).replace('vendor-', '').replace('-', ' ');
                                    }
                                } else {
                                    console.warn(`Attempted to show non-existent section: ${section}-section`);
                                }

                                // Update active class on menu items
                                currentDashboardMenu.querySelectorAll('a').forEach(link => {
                                    if (link.dataset.section === section) {
                                        link.classList.add('active');
                                    } else {
                                        link.classList.remove('active');
                                    }
                                });

                                // Load specific data for sections
                                if (currentUser) {
                                    if (mode === 'client') {
                                        await loadClientDashboardData(section);
                                    } else { // mode === 'vendor'
                                        await loadVendorDashboardData(section);
                                    }
                                } else {
                                    // Handle not logged in scenario for dashboard views
                                    alert('Please log in to view the dashboard.');
                                    showLoginView();
                                    profileModal.style.display = 'flex';
                                    appContainer.style.display = 'grid'; // Show main app if not logged in
                                    clientDashboardContainer.style.display = 'none';
                                    vendorDashboardContainer.style.display = 'none';
                                }
                            }

                            // Client Dashboard Data Loading
                            async function loadClientDashboardData(section) {
                                if (!currentUser || !currentUser.id) return;

                                try {
                                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/dashboard`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch client dashboard data');
                                    const dashboardData = await response.json();
                                    
                                    // Update notifications badge
                                    document.getElementById('dashboard-notifications-badge').textContent = dashboardData.unreadNotifications || 0;

                                    if (section === 'dashboard') {
                                        renderUpcomingBookings(dashboardData.upcomingBookings);
                                        renderRecentFavorites(dashboardData.recentFavorites);
                                    } else if (section === 'bookings') {
                                        await loadAllUserBookings();
                                    } else if (section === 'favorites') {
                                        await loadUserFavoritesDashboard();
                                    } else if (section === 'messages') {
                                        await loadConversations('messages-section', 'dashboard-chat-input', 'dashboard-send-btn');
                                    } else if (section === 'reviews') {
                                        await loadUserReviews();
                                    } else if (section === 'settings') {
                                        await loadUserProfileDetails();
                                    }
                                } catch (error) {
                                    console.error('Error loading client dashboard:', error);
                                    alert('Failed to load dashboard data: ' + error.message);
                                }
                            }

                            function renderUpcomingBookings(bookings) {
                                const container = document.getElementById('upcoming-bookings');
                                container.innerHTML = '';
                                if (bookings && bookings.length > 0) {
                                    bookings.forEach(booking => {
                                        const bookingItem = document.createElement('div');
                                        bookingItem.className = 'booking-item';
                                        bookingItem.innerHTML = `
                                            <div class="booking-info">
                                                <div class="booking-vendor">${booking.VendorName}</div>
                                                <div class="booking-date">${new Date(booking.EventDate).toLocaleDateString()} - ${booking.ServiceName}</div>
                                            </div>
                                            <span class="booking-status status-${booking.Status}">${booking.Status}</span>
                                        `;
                                        container.appendChild(bookingItem);
                                    });
                                } else {
                                    container.innerHTML = '<p>No upcoming bookings.</p>';
                                }
                            }

                            function renderRecentFavorites(favorites) {
                                const container = document.getElementById('dashboard-favorites');
                                container.innerHTML = '';
                                if (favorites && favorites.length > 0) {
                                    favorites.forEach(vendor => {
                                        const vendorCard = document.createElement('div');
                                        vendorCard.className = 'vendor-card';
                                        vendorCard.innerHTML = `
                                            <div class="vendor-image">
                                                ${vendor.PortfolioImage ? `<img src="${vendor.PortfolioImage}" alt="${vendor.VendorName}" style="width:100%;height:100%;object-fit:cover;">` : getCategoryIcon(vendor.Categories?.split(',')[0] || 'all')}
                                                <div class="vendor-favorite active" data-id="${vendor.VendorProfileID}">‚ù§</div>
                                            </div>
                                            <div class="vendor-details">
                                                <h3 class="vendor-name">${vendor.VendorName}</h3>
                                                <div class="vendor-location">
                                                    üìç ${vendor.City}, ${vendor.State}
                                                </div>
                                                <div class="vendor-footer">
                                                    <button class="btn btn-primary" style="width: 100%;" data-id="${vendor.VendorProfileID}">View</button>
                                                </div>
                                            </div>
                                        `;
                                        container.appendChild(vendorCard);
                                        vendorCard.querySelector('button').addEventListener('click', () => {
                                            // Find the full vendor object from state.vendors to pass to openBookingModal
                                            const fullVendor = state.vendors.find(v => v.id === vendor.VendorProfileID);
                                            if (fullVendor) openBookingModal(fullVendor);
                                        });
                                        vendorCard.querySelector('.vendor-favorite').addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            toggleFavorite(vendor.VendorProfileID);
                                        });
                                    });
                                } else {
                                    container.innerHTML = '<p>No recent favorites.</p>';
                                }
                            }

                            async function loadAllUserBookings() {
                                const container = document.getElementById('all-bookings');
                                container.innerHTML = '<p>Loading all bookings...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/bookings/all`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch all bookings');
                                    const bookings = await response.json();
                                    renderBookingsList(bookings, container);
                                } catch (error) {
                                    console.error('Error loading all user bookings:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load all bookings: ${error.message}</p>`;
                                }
                            }

                            async function loadUserFavoritesDashboard() {
                                const container = document.getElementById('saved-favorites');
                                container.innerHTML = '<p>Loading saved favorites...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/favorites/user/${currentUser.id}`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch user favorites');
                                    const favorites = await response.json();
                                    renderFavoritesList(favorites, container);
                                } catch (error) {
                                    console.error('Error loading user favorites:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load favorites: ${error.message}</p>`;
                                }
                            }

                            function renderFavoritesList(favorites, container) {
                                container.innerHTML = '';
                                if (favorites && favorites.length > 0) {
                                    favorites.forEach(vendor => {
                                        const vendorCard = document.createElement('div');
                                        vendorCard.className = 'vendor-card';
                                        vendorCard.innerHTML = `
                                            <div class="vendor-image">
                                                ${vendor.PortfolioImage ? `<img src="${vendor.PortfolioImage}" alt="${vendor.VendorName}" style="width:100%;height:100%;object-fit:cover;">` : getCategoryIcon(vendor.Categories?.split(',')[0] || 'all')}
                                                <div class="vendor-favorite active" data-id="${vendor.VendorProfileID}">‚ù§</div>
                                            </div>
                                            <div class="vendor-details">
                                                <h3 class="vendor-name">${vendor.VendorName}</h3>
                                                <div class="vendor-location">
                                                    üìç ${vendor.City}, ${vendor.State}
                                                </div>
                                                <div class="vendor-footer">
                                                    <button class="btn btn-primary" style="width: 100%;" data-id="${vendor.VendorProfileID}">View</button>
                                                </div>
                                            </div>
                                        `;
                                        container.appendChild(vendorCard);
                                        vendorCard.querySelector('button').addEventListener('click', () => {
                                            const fullVendor = state.vendors.find(v => v.id === vendor.VendorProfileID);
                                            if (fullVendor) openBookingModal(fullVendor);
                                        });
                                        vendorCard.querySelector('.vendor-favorite').addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            toggleFavorite(vendor.VendorProfileID);
                                        });
                                    });
                                } else {
                                    container.innerHTML = '<p>No saved favorites.</p>';
                                }
                            }

                            async function loadUserReviews() {
                                const container = document.getElementById('user-reviews');
                                container.innerHTML = '<p>Loading your reviews...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/reviews`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch user reviews');
                                    const reviews = await response.json();
                                    renderReviewsList(reviews, container);
                                } catch (error) {
                                    console.error('Error loading user reviews:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load reviews: ${error.message}</p>`;
                                }
                            }

                            function renderReviewsList(reviews, container) {
                                container.innerHTML = '';
                                if (reviews && reviews.length > 0) {
                                    reviews.forEach(review => {
                                        const reviewCard = document.createElement('div');
                                        reviewCard.className = 'review-card';
                                        reviewCard.innerHTML = `
                                            <div class="review-header">
                                                <div class="reviewer">${review.VendorName}</div>
                                                <div class="review-date">${new Date(review.CreatedAt).toLocaleDateString()}</div>
                                            </div>
                                            <div class="review-rating">${'‚òÖ'.repeat(review.Rating)}${'‚òÜ'.repeat(5 - review.Rating)}</div>
                                            ${review.Title ? `<div class="review-title">${review.Title}</div>` : ''}
                                            <div class="review-text">${review.Comment}</div>
                                        `;
                                        container.appendChild(reviewCard);
                                    });
                                } else {
                                    container.innerHTML = '<p>No reviews submitted yet.</p>';
                                }
                            }

                            async function loadUserProfileDetails() {
                                const nameInput = document.getElementById('profile-name');
                                const emailInput = document.getElementById('profile-email');
                                const phoneInput = document.getElementById('profile-phone');
                                const profileForm = document.getElementById('profile-form');
                                const passwordForm = document.getElementById('password-form');

                                nameInput.value = 'Loading...';
                                emailInput.value = 'Loading...';
                                phoneInput.value = 'Loading...';

                                try {
                                    const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/profile-details`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch user profile details');
                                    const profile = await response.json();
                                    
                                    nameInput.value = profile.Name || '';
                                    emailInput.value = profile.Email || '';
                                    phoneInput.value = profile.Phone || '';
                                } catch (error) {
                                    console.error('Error loading user profile details:', error);
                                    nameInput.value = 'Error';
                                    emailInput.value = 'Error';
                                    phoneInput.value = 'Error';
                                    alert('Failed to load profile details: ' + error.message);
                                }

                                profileForm.onsubmit = async (e) => {
                                    e.preventDefault();
                                    try {
                                        const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/profile-update`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                                            },
                                            body: JSON.stringify({
                                                name: nameInput.value,
                                                phone: phoneInput.value,
                                                bio: currentUser.bio, // Assuming bio is part of currentUser
                                                avatar: currentUser.avatar
                                            })
                                        });
                                        if (!response.ok) throw new Error('Failed to update profile');
                                        alert('Profile updated successfully!');
                                        // Re-fetch user data to update currentUser object
                                        await checkAuthStatus();
                                    } catch (error) {
                                        console.error('Error updating profile:', error);
                                        alert('Failed to update profile: ' + error.message);
                                    }
                                };

                                passwordForm.onsubmit = async (e) => {
                                    e.preventDefault();
                                    const currentPassword = document.getElementById('current-password').value;
                                    const newPassword = document.getElementById('new-password').value;
                                    const confirmPassword = document.getElementById('confirm-password').value;

                                    if (newPassword !== confirmPassword) {
                                        alert('New password and confirm password do not match.');
                                        return;
                                    }
                                    if (newPassword.length < 8) {
                                        alert('New password must be at least 8 characters long.');
                                        return;
                                    }

                                    try {
                                        // You might need an API endpoint to verify current password before updating
                                        // For simplicity, this example directly updates. In production, add current password verification.
                                        const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}/password-update`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                                            },
                                            body: JSON.stringify({ newPassword })
                                        });
                                        if (!response.ok) throw new Error('Failed to update password');
                                        alert('Password updated successfully!');
                                        document.getElementById('current-password').value = '';
                                        document.getElementById('new-password').value = '';
                                        document.getElementById('confirm-password').value = '';
                                    } catch (error) {
                                        console.error('Error updating password:', error);
                                        alert('Failed to update password: ' + error.message);
                                    }
                                };
                            }

                            // Vendor Dashboard Data Loading
                            async function loadVendorDashboardData(section) {
                                if (!currentUser || !currentUser.id) return;

                                // First, get the VendorProfileID for the current user
                                let vendorProfileId = null;
                                try {
                                    const statusResponse = await fetch(`${API_BASE_URL}/vendors/status?userId=${currentUser.id}`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!statusResponse.ok) throw new Error('Failed to fetch vendor status');
                                    const statusData = await statusResponse.json();
                                    if (statusData.isVendor && statusData.vendorProfileId) {
                                        vendorProfileId = statusData.vendorProfileId;
                                    } else {
                                        document.getElementById('vendor-dashboard-section').innerHTML = '<p>You are not registered as a vendor or your profile is incomplete. Please register or complete your profile to access the vendor dashboard.</p>';
                                        return;
                                    }
                                } catch (error) {
                                    console.error('Error getting vendor profile ID:', error);
                                    document.getElementById('vendor-dashboard-section').innerHTML = `<p style="color:var(--accent);">Error: ${error.message}. Could not load vendor dashboard.</p>`;
                                    return;
                                }

                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.id}/dashboard`, { // Uses UserID
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch vendor dashboard data');
                                    const dashboardData = await response.json();
                                    
                                    // Update notifications badge
                                    document.getElementById('vendor-notifications-badge').textContent = dashboardData.unreadNotifications || 0;

                                    if (section === 'vendor-dashboard') {
                                        renderVendorStats(dashboardData.stats);
                                        renderVendorRecentBookings(dashboardData.recentBookings);
                                        // Load recent messages for the vendor dashboard overview
                                        loadConversations('vendor-dashboard-section', 'vendor-chat-input', 'vendor-send-btn');
                                    } else if (section === 'vendor-bookings') {
                                        await loadAllVendorBookings(vendorProfileId);
                                    } else if (section === 'vendor-services') {
                                        await loadVendorServices(vendorProfileId);
                                    } else if (section === 'vendor-messages') {
                                        await loadConversations('vendor-messages-section', 'vendor-all-chat-input', 'vendor-all-send-btn');
                                    } else if (section === 'vendor-reviews') {
                                        await loadAllVendorReviews(vendorProfileId);
                                    } else if (section === 'vendor-analytics') {
                                        await loadVendorAnalytics(vendorProfileId);
                                    } else if (section === 'vendor-settings') {
                                        await loadVendorProfileDetails(vendorProfileId);
                                    }
                                } catch (error) {
                                    console.error('Error loading vendor dashboard:', error);
                                    alert('Failed to load vendor dashboard data: ' + error.message);
                                }
                            }

                            function renderVendorStats(stats) {
                                const container = document.getElementById('vendor-stats');
                                container.innerHTML = `
                                    <div class="stat-card">
                                        <div class="stat-value">${stats.TotalBookings || 0}</div>
                                        <div class="stat-label">Total Bookings</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${stats.TotalReviews || 0}</div>
                                        <div class="stat-label">Total Reviews</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${(stats.AvgRating || 0).toFixed(1)}</div>
                                        <div class="stat-label">Average Rating</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${stats.TotalFavorites || 0}</div>
                                        <div class="stat-label">Total Favorites</div>
                                    </div>
                                `;
                            }

                            function renderVendorRecentBookings(bookings) {
                                const container = document.getElementById('vendor-recent-bookings');
                                container.innerHTML = '';
                                if (bookings && bookings.length > 0) {
                                    bookings.forEach(booking => {
                                        const bookingItem = document.createElement('div');
                                        bookingItem.className = 'booking-item';
                                        bookingItem.innerHTML = `
                                            <div class="booking-info">
                                                <div class="booking-vendor">${booking.ClientName}</div>
                                                <div class="booking-date">${new Date(booking.EventDate).toLocaleDateString()} - ${booking.ServiceName}</div>
                                            </div>
                                            <span class="booking-status status-${booking.Status}">${booking.Status}</span>
                                        `;
                                        container.appendChild(bookingItem);
                                    });
                                } else {
                                    container.innerHTML = '<p>No recent bookings.</p>';
                                }
                            }

                            function renderBookingsList(bookings, container) {
                                container.innerHTML = '';
                                if (bookings && bookings.length > 0) {
                                    bookings.forEach(booking => {
                                        const bookingItem = document.createElement('div');
                                        bookingItem.className = 'booking-item';
                                        const vendorOrClientName = isVendorMode ? booking.ClientName : booking.VendorName;
                                        bookingItem.innerHTML = `
                                            <div class="booking-info">
                                                <div class="booking-vendor">${vendorOrClientName}</div>
                                                <div class="booking-date">${new Date(booking.EventDate).toLocaleDateString()} - ${booking.ServiceName}</div>
                                                <div>Total: $${booking.TotalAmount ? booking.TotalAmount.toFixed(2) : '0.00'}</div>
                                            </div>
                                            <span class="booking-status status-${booking.Status}">${booking.Status}</span>
                                        `;
                                        container.appendChild(bookingItem);
                                    });
                                } else {
                                    container.innerHTML = '<p>No bookings found.</p>';
                                }
                            }

                            async function loadAllVendorBookings(vendorProfileId) {
                                const container = document.getElementById('vendor-all-bookings');
                                container.innerHTML = '<p>Loading all bookings...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/bookings/all`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch all vendor bookings');
                                    const bookings = await response.json();
                                    renderBookingsList(bookings, container);
                                } catch (error) {
                                    console.error('Error loading all vendor bookings:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load all bookings: ${error.message}</p>`;
                                }
                            }

                            async function loadVendorServices(vendorProfileId) {
                                const container = document.getElementById('vendor-services');
                                container.innerHTML = '<p>Loading services...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/services`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch vendor services');
                                    const services = await response.json();
                                    renderManageServices(services, container);
                                } catch (error) {
                                    console.error('Error loading vendor services:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load services: ${error.message}</p>`;
                                }
                            }

                            function renderManageServices(services, container) {
                                container.innerHTML = '';
                                if (services && services.length > 0) {
                                    // Group services by category for rendering
                                    const servicesByCategory = services.reduce((acc, service) => {
                                        const categoryName = service.CategoryName || 'Uncategorized';
                                        if (!acc[categoryName]) {
                                            acc[categoryName] = [];
                                        }
                                        acc[categoryName].push(service);
                                        return acc;
                                    }, {});

                                    for (const categoryName in servicesByCategory) {
                                        const categoryDiv = document.createElement('div');
                                        categoryDiv.className = 'service-category';
                                        categoryDiv.innerHTML = `
                                            <h4 class="category-title">${categoryName}</h4>
                                            <div class="service-grid">
                                                ${servicesByCategory[categoryName].map(service => `
                                                    <div class="service-card">
                                                        <div class="service-name">${service.ServiceName}</div>
                                                        <div class="service-description">${service.ServiceDescription || 'No description.'}</div>
                                                        <div class="service-price">$${service.Price.toFixed(2)}</div>
                                                        <div class="service-actions">
                                                            <button class="btn btn-outline btn-sm edit-service-btn" data-service-id="${service.ServiceID}">Edit</button>
                                                            <button class="btn btn-primary btn-sm delete-service-btn" data-service-id="${service.ServiceID}">Delete</button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                        container.appendChild(categoryDiv);
                                    }
                                } else {
                                    container.innerHTML = '<p>No services added yet. Add your first service!</p>';
                                }
                                // Add a button to add new services
                                const addServiceBtn = document.createElement('button');
                                addServiceBtn.className = 'btn btn-primary';
                                addServiceBtn.textContent = 'Add New Service';
                                addServiceBtn.addEventListener('click', () => {
                                    // Implement logic to open a form for adding/editing a service
                                    // For now, a simple alert
                                    alert('Add New Service form would open here!');
                                });
                                container.appendChild(addServiceBtn);
                            }

                            async function loadAllVendorReviews(vendorProfileId) {
                                const container = document.getElementById('vendor-reviews');
                                container.innerHTML = '<p>Loading customer reviews...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/reviews/all`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch all vendor reviews');
                                    const reviews = await response.json();
                                    renderReviewsList(reviews, container); // Reuse renderReviewsList
                                } catch (error) {
                                    console.error('Error loading all vendor reviews:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load reviews: ${error.message}</p>`;
                                }
                            }

                            // Chart instances to prevent re-initialization
                            let bookingStatsChart = null;
                            let revenueByServiceChart = null;
                            let revenueByMonthChart = null;
                            let reviewStatsChart = null;

                            async function loadVendorAnalytics(vendorProfileId) {
                                const container = document.getElementById('analytics-charts');
                                container.innerHTML = '<p>Loading analytics data...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/analytics`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch vendor analytics');
                                    const analyticsData = await response.json();
                                    
                                    container.innerHTML = ''; // Clear loading message

                                    // Render Booking Stats Chart (Pie Chart)
                                    const bookingStatsCanvas = document.createElement('canvas');
                                    bookingStatsCanvas.id = 'bookingStatsChart';
                                    const bookingStatsChartContainer = document.createElement('div');
                                    bookingStatsChartContainer.className = 'chart-container';
                                    bookingStatsChartContainer.innerHTML = '<h3>Booking Status Overview</h3>';
                                    bookingStatsChartContainer.appendChild(bookingStatsCanvas);
                                    container.appendChild(bookingStatsChartContainer);

                                    if (bookingStatsChart) bookingStatsChart.destroy();
                                    bookingStatsChart = new Chart(bookingStatsCanvas, {
                                        type: 'pie',
                                        data: {
                                            labels: ['Completed', 'Confirmed', 'Pending', 'Cancelled'],
                                            datasets: [{
                                                data: [
                                                    analyticsData.bookingStats.CompletedBookings,
                                                    analyticsData.bookingStats.ConfirmedBookings,
                                                    analyticsData.bookingStats.PendingBookings,
                                                    analyticsData.bookingStats.CancelledBookings
                                                ],
                                                backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336']
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: 'Booking Status Distribution'
                                                }
                                            }
                                        }
                                    });

                                    // Render Revenue by Service Chart (Bar Chart)
                                    const revenueByServiceCanvas = document.createElement('canvas');
                                    revenueByServiceCanvas.id = 'revenueByServiceChart';
                                    const revenueByServiceChartContainer = document.createElement('div');
                                    revenueByServiceChartContainer.className = 'chart-container';
                                    revenueByServiceChartContainer.innerHTML = '<h3>Revenue by Service</h3>';
                                    revenueByServiceChartContainer.appendChild(revenueByServiceCanvas);
                                    container.appendChild(revenueByServiceChartContainer);

                                    if (revenueByServiceChart) revenueByServiceChart.destroy();
                                    revenueByServiceChart = new Chart(revenueByServiceCanvas, {
                                        type: 'bar',
                                        data: {
                                            labels: analyticsData.revenueByService.map(s => s.ServiceName),
                                            datasets: [{
                                                label: 'Total Revenue ($)',
                                                data: analyticsData.revenueByService.map(s => s.TotalRevenue),
                                                backgroundColor: 'rgba(94, 114, 228, 0.6)'
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: 'Revenue Generated by Each Service'
                                                }
                                            },
                                            scales: {
                                                y: {
                                                    beginAtZero: true
                                                }
                                            }
                                        }
                                    });

                                    // Render Revenue by Month Chart (Line Chart)
                                    const revenueByMonthCanvas = document.createElement('canvas');
                                    revenueByMonthCanvas.id = 'revenueByMonthChart';
                                    const revenueByMonthChartContainer = document.createElement('div');
                                    revenueByMonthChartContainer.className = 'chart-container';
                                    revenueByMonthChartContainer.innerHTML = '<h3>Monthly Revenue Trends</h3>';
                                    revenueByMonthChartContainer.appendChild(revenueByMonthCanvas);
                                    container.appendChild(revenueByMonthChartContainer);

                                    const monthlyLabels = analyticsData.revenueByMonth.map(m => `${m.Year}-${String(m.Month).padStart(2, '0')}`);
                                    const monthlyRevenue = analyticsData.revenueByMonth.map(m => m.TotalRevenue);

                                    if (revenueByMonthChart) revenueByMonthChart.destroy();
                                    revenueByMonthChart = new Chart(revenueByMonthCanvas, {
                                        type: 'line',
                                        data: {
                                            labels: monthlyLabels,
                                            datasets: [{
                                                label: 'Total Revenue ($)',
                                                data: monthlyRevenue,
                                                borderColor: 'var(--primary)',
                                                tension: 0.1,
                                                fill: false
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: 'Revenue Over Time'
                                                }
                                            },
                                            scales: {
                                                y: {
                                                    beginAtZero: true
                                                }
                                            }
                                        }
                                    });

                                    // Render Review Stats Chart (Doughnut Chart)
                                    const reviewStatsCanvas = document.createElement('canvas');
                                    reviewStatsCanvas.id = 'reviewStatsChart';
                                    const reviewStatsChartContainer = document.createElement('div');
                                    reviewStatsChartContainer.className = 'chart-container';
                                    reviewStatsChartContainer.innerHTML = '<h3>Review Rating Distribution</h3>';
                                    reviewStatsChartContainer.appendChild(reviewStatsCanvas);
                                    container.appendChild(reviewStatsChartContainer);

                                    if (reviewStatsChart) reviewStatsChart.destroy();
                                    reviewStatsChart = new Chart(reviewStatsCanvas, {
                                        type: 'doughnut',
                                        data: {
                                            labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                                            datasets: [{
                                                data: [
                                                    analyticsData.reviewStats.FiveStarReviews,
                                                    analyticsData.reviewStats.FourStarReviews,
                                                    analyticsData.reviewStats.ThreeStarReviews,
                                                    analyticsData.reviewStats.TwoStarReviews,
                                                    analyticsData.reviewStats.OneStarReviews
                                                ],
                                                backgroundColor: ['#4CAF50', '#8BC34A', '#FFEB3B', '#FF9800', '#F44336']
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: 'Customer Review Ratings'
                                                }
                                            }
                                        }
                                    });

                                } catch (error) {
                                    console.error('Error loading vendor analytics:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load analytics: ${error.message}</p>`;
                                }
                            }

                            async function loadVendorProfileDetails(vendorProfileId) {
                                const form = document.getElementById('vendor-profile-form');
                                const inputs = {
                                    businessName: document.getElementById('vendor-name'),
                                    category: document.getElementById('vendor-category'),
                                    description: document.getElementById('vendor-description'),
                                    address: document.getElementById('vendor-address'),
                                    city: document.getElementById('vendor-city'),
                                    state: document.getElementById('vendor-state'),
                                    country: document.getElementById('vendor-country'),
                                    postalCode: document.getElementById('vendor-postalCode'),
                                    phone: document.getElementById('vendor-phone'),
                                    email: document.getElementById('vendor-email'),
                                    website: document.getElementById('vendor-website'),
                                    yearsInBusiness: document.getElementById('vendor-years-in-business'),
                                    isPremium: document.getElementById('vendor-is-premium'),
                                    isEcoFriendly: document.getElementById('vendor-is-eco-friendly'),
                                    isAwardWinning: document.getElementById('vendor-is-award-winning')
                                };

                                // Populate category dropdown
                                inputs.category.innerHTML = '<option value="">Select category</option>' + 
                                    state.categories.filter(c => c.id !== 'all').map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                                for (const key in inputs) {
                                    if (inputs[key] instanceof HTMLInputElement || inputs[key] instanceof HTMLTextAreaElement || inputs[key] instanceof HTMLSelectElement) {
                                        inputs[key].value = 'Loading...';
                                        if (inputs[key].type === 'checkbox') inputs[key].checked = false;
                                    }
                                }

                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/profile-details`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch vendor profile details');
                                    const profile = await response.json();
                                    
                                    inputs.businessName.value = profile.BusinessName || '';
                                    inputs.description.value = profile.BusinessDescription || '';
                                    inputs.address.value = profile.Address || '';
                                    inputs.city.value = profile.City || '';
                                    inputs.state.value = profile.State || '';
                                    inputs.country.value = profile.Country || '';
                                    inputs.postalCode.value = profile.PostalCode || '';
                                    inputs.phone.value = profile.BusinessPhone || '';
                                    inputs.email.value = profile.BusinessEmail || '';
                                    inputs.website.value = profile.Website || '';
                                    inputs.yearsInBusiness.value = profile.YearsInBusiness || 0;
                                    inputs.isPremium.checked = profile.IsPremium;
                                    inputs.isEcoFriendly.checked = profile.IsEcoFriendly;
                                    inputs.isAwardWinning.checked = profile.IsAwardWinning;

                                    // Set selected category
                                    if (profile.Categories) {
                                        const primaryCategory = profile.Categories.split(',')[0].trim().toLowerCase();
                                        const option = Array.from(inputs.category.options).find(opt => opt.value === primaryCategory);
                                        if (option) {
                                            option.selected = true;
                                        }
                                    }
                                    
                                    await loadVendorImages(vendorProfileId);
                                    await loadVendorAvailability(vendorProfileId);

                                } catch (error) {
                                    console.error('Error loading vendor profile details:', error);
                                    for (const key in inputs) {
                                        if (inputs[key] instanceof HTMLInputElement || inputs[key] instanceof HTMLTextAreaElement || inputs[key] instanceof HTMLSelectElement) {
                                            inputs[key].value = 'Error';
                                        }
                                    }
                                    alert('Failed to load vendor profile details: ' + error.message);
                                }

                                form.onsubmit = async (e) => {
                                    e.preventDefault();
                                    try {
                                        const updateData = {
                                            businessName: inputs.businessName.value,
                                            description: inputs.description.value,
                                            phone: inputs.phone.value,
                                            email: inputs.email.value,
                                            website: inputs.website.value,
                                            yearsInBusiness: parseInt(inputs.yearsInBusiness.value),
                                            address: inputs.address.value,
                                            city: inputs.city.value,
                                            state: inputs.state.value,
                                            country: inputs.country.value,
                                            postalCode: inputs.postalCode.value,
                                            isPremium: inputs.isPremium.checked,
                                            isEcoFriendly: inputs.isEcoFriendly.checked,
                                            isAwardWinning: inputs.isAwardWinning.checked,
                                            // category is handled separately in the API, not directly in this PUT for vendor profile
                                        };

                                        const response = await fetch(`${API_BASE_URL}/vendors/${vendorProfileId}`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                                            },
                                            body: JSON.stringify(updateData)
                                        });
                                        if (!response.ok) {
                                            const errorData = await response.json();
                                            throw new Error(errorData.message || 'Failed to update vendor profile');
                                        }
                                        alert('Vendor profile updated successfully!');
                                    } catch (error) {
                                        console.error('Error updating vendor profile:', error);
                                        alert('Failed to update vendor profile: ' + error.message);
                                    }
                                };
                            }

                            async function loadVendorImages(vendorProfileId) {
                                const container = document.getElementById('vendor-photos');
                                container.innerHTML = '<p>Loading photos...</p>';
                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/images`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch vendor images');
                                    const images = await response.json();
                                    renderVendorImages(images, container);
                                } catch (error) {
                                    console.error('Error loading vendor images:', error);
                                    container.innerHTML = `<p style="color:var(--accent);">Failed to load photos: ${error.message}</p>`;
                                }
                            }

                            function renderVendorImages(images, container) {
                                container.innerHTML = '';
                                if (images && images.length > 0) {
                                    images.forEach(img => {
                                        const imgDiv = document.createElement('div');
                                        imgDiv.style.width = '100%';
                                        imgDiv.style.height = '100px';
                                        imgDiv.style.borderRadius = 'var(--radius)';
                                        imgDiv.style.overflow = 'hidden';
                                        imgDiv.style.position = 'relative';
                                        imgDiv.innerHTML = `
                                            <img src="${img.ImageURL}" alt="${img.Caption || 'Vendor Image'}" style="width:100%;height:100%;object-fit:cover;">
                                            ${img.IsPrimary ? '<span style="position:absolute;top:5px;left:5px;background-color:var(--primary);color:white;padding:3px 8px;border-radius:10px;font-size:0.7rem;">Primary</span>' : ''}
                                            <button class="btn btn-sm" style="position:absolute;bottom:5px;right:5px;background-color:rgba(255,255,255,0.8);border:none;color:var(--accent);" data-image-id="${img.ImageID}">Delete</button>
                                        `;
                                        container.appendChild(imgDiv);
                                        imgDiv.querySelector('button').addEventListener('click', async () => {
                                            if (confirm('Are you sure you want to delete this image?')) {
                                                try {
                                                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.vendorProfileId}/images/${img.ImageID}`, {
                                                        method: 'DELETE',
                                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                                    });
                                                    if (!response.ok) throw new Error('Failed to delete image');
                                                    alert('Image deleted successfully!');
                                                    loadVendorImages(currentUser.vendorProfileId); // Refresh images
                                                } catch (error) {
                                                    console.error('Error deleting image:', error);
                                                    alert('Failed to delete image: ' + error.message);
                                                }
                                            }
                                        });
                                    });
                                } else {
                                    container.innerHTML = '<p>No photos uploaded.</p>';
                                }

                                // Handle upload photos button
                                document.getElementById('upload-photos-btn').onclick = () => {
                                    const input = document.createElement('input');
                                    input.type = 'file';
                                    input.accept = 'image/*';
                                    input.multiple = true;
                                    input.onchange = async (e) => {
                                        const files = e.target.files;
                                        if (files.length === 0) return;

                                        // For simplicity, this demo won't actually upload files to a server.
                                        // In a real app, you'd use FormData and send to your backend's file upload endpoint.
                                        alert('Simulating upload of ' + files.length + ' images. In a real app, these would be uploaded and saved.');
                                        // Simulate adding them to the display
                                        for (let i = 0; i < files.length; i++) {
                                            const file = files[i];
                                            const reader = new FileReader();
                                            reader.onload = (e) => {
                                                const newImgDiv = document.createElement('div');
                                                newImgDiv.style.width = '100%';
                                                newImgDiv.style.height = '100px';
                                                newImgDiv.style.borderRadius = 'var(--radius)';
                                                newImgDiv.style.overflow = 'hidden';
                                                newImgDiv.style.position = 'relative';
                                                newImgDiv.innerHTML = `
                                                    <img src="${e.target.result}" alt="New Image" style="width:100%;height:100%;object-fit:cover;">
                                                    <button class="btn btn-sm" style="position:absolute;bottom:5px;right:5px;background-color:rgba(255,255,255,0.8);border:none;color:var(--accent);">Remove</button>
                                                `;
                                                container.appendChild(newImgDiv);
                                                newImgDiv.querySelector('button').addEventListener('click', () => newImgDiv.remove());
                                            };
                                            reader.readAsDataURL(file);
                                        }
                                    };
                                    input.click();
                                };
                            }

                            async function loadVendorAvailability(vendorProfileId) {
                                const calendarEl = document.getElementById('vendor-availability-calendar');
                                if (!calendarEl) return;

                                // Destroy existing calendar instance if it exists
                                if (calendarEl._fullCalendar) {
                                    calendarEl._fullCalendar.destroy();
                                    calendarEl._fullCalendar = null;
                                }

                                try {
                                    const response = await fetch(`${API_BASE_URL}/vendor/${vendorProfileId}/availability`, {
                                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                                    });
                                    if (!response.ok) throw new Error('Failed to fetch vendor availability');
                                    const data = await response.json();
                                    const businessHours = data.businessHours || [];
                                    const exceptions = data.availabilityExceptions || [];

                                    const events = [];

                                    // Add business hours as recurring events
                                    businessHours.forEach(bh => {
                                        if (bh.IsAvailable) {
                                            events.push({
                                                daysOfWeek: [bh.DayOfWeek], // FullCalendar uses 0 for Sunday, 6 for Saturday
                                                startTime: bh.OpenTime,
                                                endTime: bh.CloseTime,
                                                display: 'background',
                                                color: '#d1fae5' // Light green for available
                                            });
                                        } else {
                                            events.push({
                                                daysOfWeek: [bh.DayOfWeek],
                                                display: 'background',
                                                color: '#fee2e2' // Light red for unavailable
                                            });
                                        }
                                    });

                                    // Add exceptions
                                    exceptions.forEach(ex => {
                                        events.push({
                                            start: ex.StartDate + (ex.StartTime ? 'T' + ex.StartTime : ''),
                                            end: ex.EndDate + (ex.EndTime ? 'T' + ex.EndTime : ''),
                                            title: ex.Reason || (ex.IsAvailable ? 'Available' : 'Unavailable'),
                                            color: ex.IsAvailable ? '#2196F3' : '#F44336', // Blue for available exception, Red for unavailable exception
                                            allDay: !ex.StartTime && !ex.EndTime,
                                            extendedProps: {
                                                exceptionId: ex.ExceptionID,
                                                isAvailable: ex.IsAvailable,
                                                reason: ex.Reason
                                            }
                                        });
                                    });

                                    const calendar = new FullCalendar.Calendar(calendarEl, {
                                        initialView: 'dayGridMonth',
                                        events: events,
                                        selectable: true,
                                        editable: true, // Allow dragging/resizing events
                                        eventClick: function(info) {
                                            // Handle clicking on an exception event
                                            const ex = info.event.extendedProps;
                                            alert(`Exception: ${ex.reason || 'N/A'}\nAvailable: ${ex.isAvailable ? 'Yes' : 'No'}\nID: ${ex.exceptionId}`);
                                            // You could open a modal to edit/delete the exception here
                                        },
                                        select: function(info) {
                                            // Handle selecting a date range to add an exception
                                            const reason = prompt('Reason for availability exception (e.g., "Holiday", "Closed for Maintenance")');
                                            if (reason) {
                                                const isAvailable = confirm('Is the vendor available during this exception? (OK for Yes, Cancel for No)');
                                                // Call API to upsert exception
                                                upsertVendorAvailabilityException(
                                                    null, // new exception
                                                    info.startStr.split('T')[0], // date only
                                                    info.endStr.split('T')[0], // date only
                                                    null, // no specific start time
                                                    null, // no specific end time
                                                    isAvailable,
                                                    reason
                                                );
                                            }
                                        }
                                    });
                                    calendar.render();
                                    calendarEl._fullCalendar = calendar; // Store calendar instance

                                } catch (error) {
                                    console.error('Error loading vendor availability:', error);
                                    calendarEl.innerHTML = `<p style="color:var(--accent);">Failed to load availability: ${error.message}</p>`;
                                }

                                // Set Business Hours button handler
                                document.getElementById('set-business-hours-btn').onclick = () => {
                                    alert('Business Hours settings would open here. You can configure daily open/close times.');
                                    // In a real app, you'd open a modal/form to manage VendorBusinessHours
                                };
                            }

                            async function upsertVendorAvailabilityException(exceptionId, startDate, endDate, startTime, endTime, isAvailable, reason) {
                                try {
                                    const payload = {
                                        exceptionId: exceptionId,
                                        startDate: startDate,
                                        endDate: endDate,
                                        startTime: startTime,
                                        endTime: endTime,
                                        isAvailable: isAvailable,
                                        reason: reason
                                    };
                                    const response = await fetch(`${API_BASE_URL}/vendor/${currentUser.vendorProfileId}/availability-exceptions/upsert`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                                        },
                                        body: JSON.stringify(payload)
                                    });
                                    if (!response.ok) {
                                        const errorData = await response.json();
                                        throw new Error(errorData.message || 'Failed to upsert availability exception');
                                    }
                                    alert('Availability exception saved successfully!');
                                    loadVendorAvailability(currentUser.vendorProfileId); // Refresh calendar
                                } catch (error) {
                                    console.error('Error upserting availability exception:', error);
                                    alert('Failed to save availability exception: ' + error.message);
                                }
                            }

                            // Simulate user login (for demo purposes)
                            function simulateLogin(user) {
                                currentUser = {
                                    ...user,
                                    isVendor: user.isVendor || false
                                };
                                
                                showLoggedInView();
                                profileModal.style.display = 'none';
                                alert(`Welcome, ${user.name}! You are now logged in.`);
                                
                                // Update profile button to show user is logged in
                                profileBtn.textContent = user.avatar; // Show first initial
                                profileBtn.style.backgroundColor = 'var(--primary)';
                                profileBtn.style.color = 'white';
                                profileBtn.style.borderRadius = '50%';
                                profileBtn.style.width = '36px';
                                profileBtn.style.height = '36px';
                                profileBtn.style.display = 'flex';
                                profileBtn.style.alignItems = 'center';
                                profileBtn.style.justifyContent = 'center';
                                
                                // Update favorites badge
                                document.querySelector('.badge').textContent = state.favorites.length;
                            }
                            
                            // Toggle vendor favorite status
                            async function toggleFavorite(vendorId) {
                                if (!currentUser) {
                                    profileModal.style.display = 'flex';
                                    showLoginView();
                                    return;
                                }
                                
                                try {
                                    const response = await fetch(`${API_BASE_URL}/favorites/toggle`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                                        },
                                        body: JSON.stringify({
                                            userId: currentUser.id,
                                            vendorProfileId: vendorId
                                        })
                                    });

                                    if (!response.ok) {
                                        const errorData = await response.json();
                                        throw new Error(errorData.message || 'Failed to toggle favorite');
                                    }

                                    const result = await response.json();
                                    
                                    const index = state.favorites.indexOf(vendorId);
                                    if (result.isFavorite && index === -1) {
                                        state.favorites.push(vendorId);
                                    } else if (!result.isFavorite && index !== -1) {
                                        state.favorites.splice(index, 1);
                                    }
                                    
                                    // Update UI
                                    document.querySelectorAll(`.vendor-favorite[data-id="${vendorId}"]`).forEach(icon => {
                                        icon.classList.toggle('active', result.isFavorite);
                                    });
                                    
                                    // Update badge
                                    document.querySelector('.badge').textContent = state.favorites.length;
                                    
                                } catch (error) {
                                    console.error('Error toggling favorite:', error);
                                    alert('Failed to toggle favorite: ' + error.message);
                                }
                            }
                            
                            // Center map on user location
                            function centerMapOnUser() {
                                if (state.map && state.userLocation) {
                                    state.map.setCenter(new google.maps.LatLng(state.userLocation.lat, state.userLocation.lng));
                                    state.map.setZoom(12);
                                }
                            }
                            
                            // Update map markers
                            function updateMapMarkers() {
                                // Clear existing markers
                                state.markers.forEach(marker => marker.setMap(null));
                                state.markers = [];
                                
                                // Add new markers
                                state.filteredVendors.forEach(vendor => {
                                    const marker = new google.maps.Marker({
                                        position: { lat: vendor.coordinates.lat, lng: vendor.coordinates.lng },
                                        map: state.map,
                                        title: vendor.name
                                    });
                                    
                                    state.markers.push(marker);
                                    
                                    // Add click event to show vendor info
                                    marker.addListener('click', () => {
                                        openBookingModal(vendor);
                                    });
                                });
                            }
                        });
                    </script>
                </body>
                </html>
